<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V7.2 - Global Control</title>
    <link href="[https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap)" rel="stylesheet">
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { all: initial; display: block; max-width: 1200px; margin: 20px auto; padding: 10px; font-family: 'Inter', sans-serif; color: #fff; }
        
        /* Onglets */
        .tabs-flex-container { display: flex; flex-wrap: wrap; }
        .tab-btn { 
            font-family: 'Orbitron', sans-serif; padding: 12px 15px; background: var(--color-bg-light); border: 1px solid var(--color-border-medium); border-bottom: none; color: var(--color-text-dimmed); 
            cursor: move; /* üí° NOUVEAU: Curseur de d√©placement */
            border-radius: 8px 8px 0 0; transition: all 0.2s; flex: 1; text-align: center; font-size: 12px; white-space: nowrap;
            /* Propri√©t√©s pour le Drag-and-Drop */
            min-width: 100px;
            user-select: none;
        }
        .tab-btn.active { 
            background: var(--color-bg-medium); color: #fff; border-top: 3px solid var(--color-primary-pink); font-weight: bold; 
            box-shadow: 0 -3px 15px rgba(255, 0, 153, 0.5); 
            text-shadow: 0 0 5px rgba(255, 0, 153, 0.8);
            animation: pulseGlow 2s infinite alternate;
        }
        .tab-btn:hover:not(.active) {
            background: #151515;
            color: #ccc;
        }

        @keyframes pulseGlow {
            from { box-shadow: 0 -3px 10px rgba(255, 0, 153, 0.4); }
            to { box-shadow: 0 -3px 20px rgba(255, 0, 153, 0.7); }
        }
        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid var(--color-border-dark); border-top: none; border-radius: 0 0 10px 10px; padding: 20px; }
        .tab-content.active { display: block; }
        
        /* --- Styles IA (Inchageng√©s) --- */
        .ai-result-box { background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 15px; margin-top: 15px; color: #ffffff; }
        .ai-result-box ul { margin-left: 0; padding-left: 0; list-style-type: none; margin-bottom: 15px; font-size: 13px; line-height: 1.5; }
        .ai-result-box li { margin-bottom: 8px; padding-left: 1.5em; position: relative; }
        #niche-result-container li:before { content: "‚úÖ"; color: var(--color-ai-niche); }
        #repurpose-result-container li:before { content: "‚úÇÔ∏è"; color: var(--color-ai-repurpose); }
        #trend-results li:before { content: "üíé"; color: var(--color-ai-growth); }

        /* --- VOD Visual --- */
        #repurpose-visual-area {
            background: var(--color-bg-light);
            border: 1px solid var(--color-ai-repurpose);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .vod-thumbnail {
            width: 150px;
            height: auto;
            border-radius: 4px;
            border: 2px solid var(--color-ai-repurpose);
        }
        
        /* üí° NOUVEAU: Animation de Chargement Ludique (Section I) */
        .ia-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            padding: 15px;
        }
        .ia-loader span {
            display: inline-block;
            animation: bounce 1.2s infinite alternate;
        }
        .ia-loader span:nth-child(2) { animation-delay: 0.2s; }
        .ia-loader span:nth-child(3) { animation-delay: 0.4s; }
        .ia-loader span:nth-child(4) { animation-delay: 0.6s; }
        .ia-loader span:nth-child(5) { animation-delay: 0.8s; }

        @keyframes bounce {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl"><span class="h1-blue-accent">STREAMER</span> HUB V7.2</h1>
    <div class="subtitle-center">Lecteur ‚Ä¢ Scan & IA ‚Ä¢ Niche ‚Ä¢ Repurposing ‚Ä¢ Croissance</div>

    <div class="player-wrapper">
        <h2>
            <span style="margin-right:6px;" id="player-icon">üé¨</span> LECTEUR & CHAT
            <span id="player-channel-status" class="text-xs font-bold" style="color:var(--color-secondary-blue); margin-left:auto;"></span>
        </h2> 
        <form id="form-channel-player" class="flex gap-8 mb-4">
            <input id="input-channel" type="text" placeholder="Nom de la cha√Æne Twitch (ex: gotaga)" title="Nom de la cha√Æne Twitch √† regarder" class="action-input">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[100px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>
    </div>

    <div id="tabs-container">
        <div id="tabs-flex-container" class="tabs-flex-container">
            <button class="tab-btn" data-tab-id="tab-followed" onclick="openTab('tab-followed')" draggable="true">üîë MON FIL SUIVI</button> 
            <button class="tab-btn" data-tab-id="tab-cible" onclick="openTab('tab-cible')" draggable="true">üéØ SCAN & RESULTATS</button>
            <button class="tab-btn" data-tab-id="tab-niche" onclick="openTab('tab-niche')" draggable="true">üìà OPTIMISATION NICHE</button>
            <button class="tab-btn" data-tab-id="tab-repurpose" onclick="openTab('tab-repurpose')" draggable="true">üöÄ REPURPOSING</button>
            <button class="tab-btn" data-tab-id="tab-growth" onclick="openTab('tab-growth')" draggable="true">üí∞ CROISSANCE</button>
            <button class="tab-btn" data-tab-id="tab-boost" onclick="openTab('tab-boost')" draggable="true">‚ö° BOOST</button>
        </div>

        <div id="tab-followed" class="tab-content">
            <h3 class="tab-heading text-pink"><span class="icon">üîë</span> Connexion & Mon Fil Suivi</h3>
            </div>

        <div id="tab-cible" class="tab-content">
            <h3 class="tab-heading text-blue"><span class="icon">üî≠</span> Configuration & Scan</h3>
            <form id="form-target" class="flex gap-2 mb-2">
                <input id="input-target" type="text" placeholder="Jeu ou Pseudo" class="action-input">
                <button type="submit" id="btn-target" class="btn-secondary min-w-[80px]">üéØ CIBLER</button>
            </form>
            <div id="scan-result" class="ai-result-box"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Entrez un jeu ou un pseudo et cliquez sur CIBLER.</p></div>
        </div>

        <div id="tab-niche" class="tab-content">
            <h3 class="tab-heading text-green"><span class="icon">üìà</span> Analyse de Niche</h3>
            <form id="form-niche-analysis" class="flex gap-2 mb-2">
                <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser (ex: Starfield)" class="action-input">
                <button type="submit" id="btn-niche-analyse" class="btn-primary min-w-[120px]" style="background:var(--color-ai-niche);">‚ú® ANALYSER</button>
            </form>
            <div id="niche-result-container" class="ai-result-box"><div id="niche-results" class="ai-content"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les r√©sultats de l'analyse de niche IA appara√Ætront ici.</p></div></div>
        </div>
        
        <div id="tab-repurpose" class="tab-content">
            <h3 class="tab-heading text-purple"><span class="icon">‚úÇÔ∏è</span> Repurposing IA</h3>
            
            <div id="repurpose-visual-area" style="display:none;">
                <img id="vod-img" src="" alt="Miniature VOD" class="vod-thumbnail">
                <div>
                    <h4 class="font-bold text-base" id="vod-title" style="color:var(--color-ai-repurpose);"></h4>
                    <p class="text-xs" id="vod-link-p"></p>
                </div>
            </div>

            <form id="form-repurpose" class="flex gap-2 mb-2 flex-col">
                <input id="input-repurpose-channel" type="text" placeholder="Pseudo du Streamer pour l'analyse de VOD" class="action-input">
                <button type="submit" id="btn-repurpose-analyse" class="btn-primary p-3" style="background:var(--color-ai-repurpose);">üöÄ ANALYSER VOD</button>
            </form>
            <div id="repurpose-result-container" class="ai-result-box"><div id="repurpose-results" class="ai-content"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les suggestions de contenu court appara√Ætront ici.</p></div></div>
        </div>

        <div id="tab-growth" class="tab-content">
            <h3 class="tab-heading text-yellow"><span class="icon">üí∞</span> Tableau de Bord Croissance</h3>
            <div class="login-box">
                <button id="btn-trend-detector" class="btn-primary w-full p-3" style="background:var(--color-ai-growth); color: var(--color-bg-light);">üîÆ D√âTECTER LA PROCHAINE NICHE</button>
                <div id="trend-results" class="ai-result-box" style="border-color: var(--color-ai-growth); margin-top: 15px;"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Cliquez sur le bouton pour lancer l'analyse des tendances V/S.</p></div>
            </div>
        </div>

        <div id="tab-boost" class="tab-content">
            <h3 class="tab-heading text-pink"><span class="icon">‚¨ÜÔ∏è</span> STREAM BOOST</h3>
            <div class="login-box">
                <form id="form-boost" class="flex gap-2">
                    <input id="input-boost" type="text" placeholder="Cha√Æne √† promouvoir" class="action-input">
                    <button type="submit" id="btn-boost" class="btn-primary min-w-[100px]">üì§ BOOST</button>
                </form>
                <div id="boost-results" class="ai-result-box" style="border-color: var(--color-primary-pink); margin-top: 15px;"><p style="text-align:center; color: var(--color-text-dimmed);">Entrez le nom de la cha√Æne et cliquez sur BOOST. (Cooldown de 3 heures)</p></div>
            </div>
        </div>
    </div>
</div>

<button id="assistant-toggle" class="assistant-btn">ü§ñ</button>
<div id="assistant-panel" class="assistant-panel">
    <div class="assistant-header">
        <span>ASSISTANT IA</span>
        <span style="cursor:pointer;" onclick="toggleAssistant()">‚úñ</span>
    </div>
    <div id="assistant-messages" class="assistant-messages">
        <div class="msg bot">Salut ! Je suis ton assistant de poche. Pose-moi une question sur ton stream, un titre ou une id√©e de clip !</div>
    </div>
    <form id="assistant-form" class="assistant-input-area">
        <input id="assistant-input" type="text" placeholder="Ta question..." class="action-input" autocomplete="off">
        <button type="submit" class="btn-secondary">></button>
    </form>
</div>

<script src="[https://embed.twitch.tv/embed/v1.js](https://embed.twitch.tv/embed/v1.js)"></script>
<script>
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 
    let embed = null;
    const twitchEmbedContainer = document.getElementById('twitch-embed');
    const inputChannel = document.getElementById('input-channel');

    function openTab(tabId) {
        localStorage.setItem('activeTab', tabId);
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('active');
            // R√©initialise la couleur des onglets (optionnel)
            el.style.borderTop = '';
        });
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            const targetBtn = document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
            if (targetBtn) targetBtn.classList.add('active');
        }
    }

    function analyzeGameNiche(gameName) {
        document.getElementById('input-niche-game').value = gameName;
        openTab('tab-niche');
        document.getElementById('btn-niche-analyse').click();
    }


    // üí° MODIFICATION: Ajout de la gestion isVod et time
    function launchPlayer(channelName, isVod = false, time = null) {
        if (!channelName) return;
        
        // Seule une recherche manuelle met √† jour l'√©tat local, pas le boost global
        if (!isVod && channelName !== DEFAULT_CHANNEL) {
            localStorage.setItem('activeChannel', channelName);
        }

        inputChannel.value = channelName;
        twitchEmbedContainer.innerHTML = '';
        
        const embedOptions = { 
            width: "100%", 
            height: 550, 
            channel: channelName, 
            layout: "video-and-chat", 
            autoplay: true, 
            parent: [window.location.hostname] 
        };

        if (time) {
            // Convertit 01:25:30 -> 01h25m30s
            embedOptions.time = time.replace(/(\d{2}):(\d{2}):(\d{2})/, '$1h$2m$3s');
        }

        embed = new Twitch.Embed("twitch-embed", embedOptions);
        document.getElementById('player-channel-status').textContent = `Cha√Æne: ${channelName.toUpperCase()}` + (time ? ` (Clip: ${time})` : '');
    }
    
    // üí° NOUVEAU: R√©cup√®re l'√©tat global du boost
    async function fetchGlobalState() {
        try {
            const res = await fetch(`${API_BASE}/get_global_state`);
            const data = await res.json();
            if (data.channel && data.channel !== DEFAULT_CHANNEL) {
                return data.channel;
            }
        } catch(e) {
            console.error("Erreur lors de la r√©cup√©ration de l'√©tat global:", e);
        }
        return null;
    }

    // üí° MODIFICATION: Initialisation pour donner la priorit√© au boost global
    async function initializePlayer() {
        // 1. Priorit√© au Boost Global
        const globalBoostChannel = await fetchGlobalState();
        
        // 2. Si pas de boost, prendre l'√©tat local ou le d√©faut
        const storedChannel = localStorage.getItem('activeChannel');
        
        const finalChannel = globalBoostChannel || storedChannel || DEFAULT_CHANNEL;
        
        // Mettre √† jour le statut du lecteur avec l'info boost si applicable
        if (globalBoostChannel) {
             document.getElementById('player-channel-status').innerHTML = `üî¥ **CHA√éNE BOOST√âE** : ${finalChannel.toUpperCase()}`;
        }

        launchPlayer(finalChannel);
    }
    
    document.getElementById('form-channel-player').addEventListener('submit', (e) => {
        e.preventDefault();
        const channel = inputChannel.value.trim().toLowerCase();
        // Une recherche manuelle met √† jour l'√©tat local (launchPlayer s'en occupe)
        if(channel) launchPlayer(channel);
    });

    // ... (checkAuth, loadFollowedStreams - inchang√©s) ...
    // Le code de checkAuth, loadFollowedStreams, etc., doit √™tre r√©int√©gr√© ici

    // --- Fonctions d'aide pour le Loader IA ---
    function getLoaderHtml(colorVar) {
        return `<div class="ia-loader" style="color:${colorVar};">
                    <span>A</span><span>N</span><span>A</span><span>L</span><span>Y</span><span>S</span><span>E</span><span>...</span>
                </div>`;
    }

    // --- HANDLERS IA MODIFI√âS POUR UTILISER LE NOUVEAU LOADER ---

    document.getElementById('form-niche-analysis').addEventListener('submit', async (e) => {
        e.preventDefault();
        const game = document.getElementById('input-niche-game').value.trim();
        if (!game) return;
        const resultBox = document.getElementById('niche-results');
        resultBox.innerHTML = getLoaderHtml('var(--color-ai-niche)'); // Nouveau Loader
        
        try {
            const res = await fetch(`${API_BASE}/critique_ia`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ query: game, type: 'niche' }) 
            });
            // ... (Traitement de la r√©ponse inchang√©) ...
            const data = await res.json();
            resultBox.innerHTML = data.html_critique || data.error || `<p style="color:red">Erreur IA: ${data.error}</p>`;
        } catch(e) { 
            resultBox.innerHTML = `<p style="color:red">Erreur: ${e.message}</p>`; 
        }
    });

    document.getElementById('form-repurpose').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-repurpose-channel').value.trim();
        if (!channel) return;
        
        loadVodDetails(channel); 
        
        const resultBox = document.getElementById('repurpose-results');
        resultBox.innerHTML = getLoaderHtml('var(--color-ai-repurpose)'); // Nouveau Loader
        
        // ... (Reste de la logique et du traitement de l'API inchang√©s) ...
        try {
            const res = await fetch(`${API_BASE}/critique_ia`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ query: channel, type: 'repurpose' }) 
            });
            const data = await res.json();
            
            let htmlContent = data.html_critique || data.error || `<p style="color:red">Erreur IA: ${data.error}</p>`;
            
            // Rendre les Timestamps Interactifs
            htmlContent = htmlContent.replace(/\[(\d{2}:\d{2}:\d{2})\]/g, (match, time) => {
                return `<button onclick="launchPlayer('${channel}', true, '${time}')" 
                            style="color:var(--color-secondary-blue); text-decoration:underline; font-weight:bold;">
                            ${time} 
                        </button>`;
            });
            
            resultBox.innerHTML = htmlContent;

        } catch(e) { 
            resultBox.innerHTML = `<p style="color:red">Erreur: ${e.message}</p>`; 
        }
    });

    document.getElementById('btn-trend-detector').addEventListener('click', async () => {
        const resultBox = document.getElementById('trend-results');
        resultBox.innerHTML = getLoaderHtml('var(--color-ai-growth)'); // Nouveau Loader
        
        try {
            const res = await fetch(`${API_BASE}/critique_ia`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ type: 'trend' }) 
            });
            const data = await res.json();
            resultBox.innerHTML = data.html_critique || data.error || `<p style="color:red">Erreur IA: ${data.error}</p>`;
        } catch(e) { 
            resultBox.innerHTML = `<p style="color:red">Erreur: ${e.message}</p>`; 
        }
    });

    // üí° MODIFICATION: Mise √† jour du boost pour d√©clencher le rafra√Æchissement global
    document.getElementById('form-boost').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim();
        if (!channel) return;
        const resultBox = document.getElementById('boost-results');
        resultBox.innerHTML = `<p style="color:var(--color-primary-pink);">üì§ Envoi du Boost en cours...</p>`;
        const btn = document.getElementById('btn-boost');
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                // Succ√®s du Boost: Rafra√Æchir l'interface pour tous
                resultBox.innerHTML = data.html_response;
                launchPlayer(channel); // Lance la cha√Æne boost√©e imm√©diatement
                document.getElementById('player-channel-status').innerHTML = `üî¥ **CHA√éNE BOOST√âE** : ${channel.toUpperCase()}`;
            } else {
                // Cooldown actif ou autre erreur
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });


    // üí° NOUVEAU: Logique de Drag-and-Drop pour les Onglets (Personnalisation)

    const tabsContainer = document.getElementById('tabs-flex-container');
    let draggedItem = null;

    function saveTabOrder() {
        const order = Array.from(tabsContainer.children).map(btn => btn.getAttribute('data-tab-id'));
        localStorage.setItem('tabOrder', JSON.stringify(order));
    }

    function applyTabOrder() {
        const savedOrder = JSON.parse(localStorage.getItem('tabOrder'));
        if (savedOrder && savedOrder.length === tabsContainer.children.length) {
            const fragments = document.createDocumentFragment();
            savedOrder.forEach(tabId => {
                const btn = document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
                if (btn) {
                    fragments.appendChild(btn);
                }
            });
            tabsContainer.appendChild(fragments);
        }
    }

    tabsContainer.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        // Laisser l'√©l√©ment tra√Æn√© l√©g√®rement transparent
        setTimeout(() => draggedItem.style.opacity = '0.5', 0);
        e.dataTransfer.effectAllowed = 'move';
    });

    tabsContainer.addEventListener('dragend', (e) => {
        draggedItem.style.opacity = '1';
        draggedItem = null;
        saveTabOrder();
    });

    tabsContainer.addEventListener('dragover', (e) => {
        e.preventDefault(); // N√©cessaire pour permettre le drop
        if (e.target.classList.contains('tab-btn') && e.target !== draggedItem) {
            const rect = e.target.getBoundingClientRect();
            const center = (rect.left + rect.right) / 2;
            
            // Ins√©rer avant ou apr√®s l'√©l√©ment survol√©
            if (e.clientX < center) {
                tabsContainer.insertBefore(draggedItem, e.target);
            } else {
                tabsContainer.insertBefore(draggedItem, e.target.nextSibling);
            }
        }
    });

    // --- Initialisation au chargement de la page ---\
    document.addEventListener('DOMContentLoaded', function() {
        applyTabOrder(); // 1. Applique l'ordre des onglets
        initializePlayer(); // 2. Initialise le lecteur (priorit√© au boost)
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab); // 3. Ouvre l'onglet sauvegard√©
        // checkAuth(); // 4. V√©rifie l'auth
    });

    // NOTE: Le code des fonctions manquantes (checkAuth, loadFollowedStreams, loadVodDetails, etc.)
    // doit √™tre r√©int√©gr√© √† la suite, en utilisant le nouveau code JS ci-dessus.
</script>
</body>
</html>
