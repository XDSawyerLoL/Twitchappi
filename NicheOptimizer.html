<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Streamer Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:#0b0b10;color:#eaeaf2;overflow:hidden}

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#141421;
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:10px;
      min-height:0;
    }

    .card{
      background:#141421;
      border-radius:12px;
      padding:10px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .playerWrap{
      flex:1;
      min-height:0;
      border-radius:12px;
      overflow:hidden;
      background:#0f0f18;
    }

    iframe{width:100%;height:100%;border:0}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{
      border-radius:10px;border:1px solid #2a2a3b;
      background:#0f0f18;color:#eaeaf2;
      padding:10px 12px;font-size:14px;
    }
    button{cursor:pointer}
    button:hover{background:#171726}

    .charts{
      flex:1;
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:10px;
      min-height:0;
    }
    .chartBox{background:#0f0f18;border:1px solid #2a2a3b;border-radius:12px;padding:10px;min-height:0}
    .chartBox canvas{width:100% !important;height:100% !important}

    .chat{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chatLog{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:10px;
      border-radius:12px;
      background:#0f0f18;
      border:1px solid #2a2a3b;
    }
    .msg{padding:6px 8px;border-bottom:1px solid #1f1f2e}
    .msg b{color:#8fd3ff}
    .muted{opacity:.75;font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div style="font-weight:700">Streamer Hub</div>
        <div class="muted">Intraday temps réel (live=1) + snapshots Firestore</div>
      </div>

      <div class="row">
        <input id="channelInput" placeholder="login twitch (ex: gotaga)" />
        <button id="loadBtn">Charger</button>
        <button id="nextBtn">Next auto</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: player -->
      <div class="card">
        <div class="row">
          <div id="playerTitle" style="font-weight:700">Player</div>
          <div id="playerStatus" class="muted"></div>
        </div>
        <div class="playerWrap">
          <iframe id="twitchPlayer" allowfullscreen></iframe>
        </div>
      </div>

      <!-- RIGHT: charts + chat -->
      <div class="card">
        <div class="charts">
          <div class="chartBox">
            <div class="row" style="justify-content:space-between">
              <b>Global viewers (24h)</b>
              <span class="muted" id="globalKpi"></span>
            </div>
            <canvas id="globalChart"></canvas>
          </div>

          <div class="chartBox">
            <div class="row" style="justify-content:space-between">
              <b>Channel viewers (24h)</b>
              <span class="muted" id="channelKpi"></span>
            </div>
            <canvas id="channelChart"></canvas>
          </div>
        </div>

        <div class="chat">
          <b>Chat (Socket.IO)</b>
          <div class="chatLog" id="chatLog"></div>
          <div class="row">
            <input id="chatUser" placeholder="Pseudo" style="flex:1" />
            <input id="chatText" placeholder="Message" style="flex:3" />
            <button id="chatSend">Envoyer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ==========
  // Twitch embed
  // ==========
  function setPlayer(channel){
    const parent = encodeURIComponent(location.hostname);
    const url = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=true`;
    document.getElementById('twitchPlayer').src = url;
    document.getElementById('playerTitle').textContent = `Player: ${channel}`;
  }

  // ==========
  // Charts (Chart.js)
  // ==========
  const globalCtx = document.getElementById('globalChart');
  const channelCtx = document.getElementById('channelChart');

  const globalChart = new Chart(globalCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Viewers', data: [], tension: 0.25 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: true }
      }
    }
  });

  const channelChart = new Chart(channelCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Viewers', data: [], tension: 0.25 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: true }
      }
    }
  });

  function setChart(chart, labels, values){
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update('none');
  }

  // ==========
  // Fetch helpers
  // ==========
  async function postJSON(url, body){
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    return r.json();
  }

  async function getJSON(url){
    const r = await fetch(url);
    return r.json();
  }

  // ==========
  // Data refresh
  // ==========
  let currentChannel = 'twitch';
  let refreshTimer = null;

  async function refreshGlobal(){
    const d = await getJSON('/api/stats/global_intraday?hours=24&live=1');
    if (!d.success) return;
    setChart(globalChart, d.series.labels, d.series.values);
    document.getElementById('globalKpi').textContent =
      `now: ${d.current_total_viewers} viewers • live: ${d.current_channels_live}`;
  }

  async function refreshChannel(login){
    const d = await getJSON(`/api/analytics/channel_intraday_by_login/${encodeURIComponent(login)}?hours=24&live=1`);
    if (!d.success) {
      document.getElementById('channelKpi').textContent = d.message || 'no data';
      setChart(channelChart, [], []);
      return;
    }
    setChart(channelChart, d.series.labels, d.series.values);

    const k = d.kpis || {};
    document.getElementById('channelKpi').textContent =
      `avg ${k.avg_viewers} • peak ${k.peak_viewers} • growth ${k.growth_percent}% • score ${k.growth_score}`;
  }

  async function loadChannel(login){
    currentChannel = login;

    // player + status live/offline
    const info = await postJSON('/stream_info', { channel: login });
    if (info.success) {
      document.getElementById('playerStatus').textContent = info.stream
        ? `LIVE • ${info.stream.viewer_count} viewers • ${info.stream.game_name || ''}`
        : `OFFLINE`;
    } else {
      document.getElementById('playerStatus').textContent = `Erreur stream_info`;
    }

    setPlayer(login);
    await refreshGlobal();
    await refreshChannel(login);

    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(async () => {
      await refreshGlobal();
      await refreshChannel(currentChannel);
    }, 30000); // 30s
  }

  // ==========
  // Buttons
  // ==========
  document.getElementById('loadBtn').addEventListener('click', async () => {
    const login = (document.getElementById('channelInput').value || '').trim().toLowerCase();
    if (!login) return;
    loadChannel(login);
  });

  document.getElementById('nextBtn').addEventListener('click', async () => {
    const d = await getJSON('/get_default_stream');
    if (d.success && d.channel) {
      document.getElementById('channelInput').value = d.channel;
      loadChannel(d.channel);
    }
  });

  // ==========
  // Socket Chat (single connection)
  // ==========
  const socket = io({
    transports: ['websocket'],
    upgrade: false,
    reconnectionAttempts: 5
  });

  const chatLog = document.getElementById('chatLog');
  function addMsg(user, text){
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<b>${user}</b> : ${text}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  socket.on('connect', () => addMsg('SYSTEM', '✅ connecté'));
  socket.on('disconnect', () => addMsg('SYSTEM', '❌ déconnecté'));
  socket.on('chat message', (m) => addMsg(m.user, m.text));

  document.getElementById('chatSend').addEventListener('click', () => {
    const user = (document.getElementById('chatUser').value || 'Anon').trim();
    const text = (document.getElementById('chatText').value || '').trim();
    if (!text) return;
    socket.emit('chat message', { user, text });
    document.getElementById('chatText').value = '';
  });

  // Auto start with default
  (async () => {
    const d = await getJSON('/get_default_stream');
    const ch = (d && d.channel) ? d.channel : 'twitch';
    document.getElementById('channelInput').value = ch;
    loadChannel(ch);
  })();
</script>
</body>
</html>
