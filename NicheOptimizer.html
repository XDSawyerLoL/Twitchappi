<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streamer Hub ‚Äì Pro Analytics</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    html, body { height: 100%; }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow:hidden; /* ‚úÖ pas de scroll global */
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }
    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }
    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; min-height:0; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    /* PLAYER sizing */
    .player-shell{ min-height:52vh; }
    #video-container{ min-height:42vh; }

    /* ===== Sous le live tabs ===== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* Tooltip */
    .tip { position: relative; display:inline-flex; align-items:center; }
    .tip .bubble{
      display:none;
      position:absolute;
      z-index:50;
      bottom:140%;
      left:50%;
      transform:translateX(-50%);
      width:280px;
      background:#0a0a0a;
      border:1px solid #333;
      border-radius:10px;
      padding:10px;
      font-size:11px;
      line-height:1.35;
      color:#ddd;
      box-shadow:0 0 15px rgba(0,242,234,.15);
    }
    .tip:hover .bubble{ display:block; }
    .qmark{
      width:16px; height:16px;
      display:inline-flex; justify-content:center; align-items:center;
      border:1px solid #333; border-radius:999px;
      color:#00f2ea; font-size:10px;
      margin-left:6px;
      background:#111;
      cursor:help;
    }

    /* Modal jeux */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.show{ display:flex; }
    .modal-panel{
      width:min(1100px,92vw);
      max-height:82vh;
      overflow:auto;
      background:#0b0b0d;
      border:1px solid #222;
      border-radius:16px;
      padding:18px;
    }
    .game-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:14px;
    }
    .game-card{
      background:#111;
      border:1px solid #222;
      border-radius:12px;
      overflow:hidden;
      cursor:pointer;
      transition:.2s;
    }
    .game-card:hover{
      border-color:#00f2ea;
      transform:translateY(-3px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .game-card img{ width:100%; height:190px; object-fit:cover; }
    .game-card .name{ padding:8px; font-size:12px; color:#eee; font-weight:bold; }

  </style>
</head>

<body class="h-screen flex flex-col p-4">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-3 pb-2 border-b border-[#222] flex-shrink-0">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-orbitron italic tracking-widest">
        <span class="text-[#00f2ea]">STREAMER</span> HUB
        <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">PRO</span>
      </h1>
      <div id="socket-status" class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">
        HUB DISCONNECTED
      </div>
    </div>

    <div>
      <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
        <i class="fab fa-twitch"></i> CONNEXION
      </button>

      <div id="user-area" class="hidden flex items-center gap-3">
        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-[#00f2ea]">
        <span id="user-name" class="font-bold text-white text-sm"></span>
        <button onclick="logout()" class="text-gray-500 hover:text-white">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- CAROUSEL (followed) -->
  <div class="mb-3 relative group flex-shrink-0">
    <div id="carousel" class="carousel-track">
      <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
        <i class="fas fa-satellite-dish mb-2"></i><br>
        Connectez-vous pour voir vos cha√Ænes suivies.
      </div>
    </div>
    <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
  </div>

  <!-- MAIN GRID -->
  <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0">

    <!-- VIDEO + PRO UNDER -->
    <div class="lg:col-span-8 flex flex-col gap-3 min-h-0">

      <!-- PLAYER -->
      <div class="glass-panel relative overflow-hidden flex flex-col rounded-lg shadow-2xl player-shell min-h-0">

        <!-- Player Top Controls -->
        <div class="bg-[#080808] p-3 flex flex-wrap gap-2 items-center border-b border-[#222]">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>

            <span id="current-channel-display" class="font-orbitron text-[#00f2ea] text-sm tracking-wider truncate">OFFLINE</span>

            <span id="player-mode-badge" class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400 flex-shrink-0">AUTO</span>
            <span id="viewer-count" class="text-[10px] text-[#ff0099] font-bold flex-shrink-0">0 viewers</span>
          </div>

          <!-- ‚úÖ NEW: game category + lucky -->
          <div class="flex gap-2 items-center">
            <button onclick="openGameModal()" class="bg-[#1a1a1a] hover:bg-[#333] text-white px-3 py-2 rounded text-xs font-orbitron border border-[#222] flex items-center gap-2">
              <i class="fas fa-th-large text-[#00f2ea]"></i> JEUX
            </button>

            <input id="lucky-game" class="cyber-input !py-2 !text-xs !w-44" placeholder="Jeu (optionnel)" />

            <button onclick="luckyPick()" class="bg-[#00f2ea] hover:bg-white text-black px-3 py-2 rounded font-bold transition text-xs font-orbitron flex items-center gap-2">
              üçÄ J'AI DE LA CHANCE
            </button>

            <div class="tip">
              <span class="qmark">?</span>
              <div class="bubble">
                <strong>üçÄ J‚Äôai de la chance</strong><br>
                <p><strong>C‚Äôest quoi :</strong> on te propose un petit streamer (0‚Äì100 viewers).</p>
                <p><strong>Comment :</strong> si tu mets un jeu ‚Üí on cherche un live FR dans ce jeu (max 100 viewers). Sinon ‚Üí suggestion auto.</p>
                <p><strong>Pourquoi utile :</strong> d√©couvrir des p√©pites, raids plus faciles, meilleure visibilit√© pour les petits cr√©ateurs.</p>
              </div>
            </div>
          </div>

          <div class="flex gap-2 flex-shrink-0">
            <button onclick="cycle('prev')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="cycle('next')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div id="video-container" class="flex-grow bg-black relative w-full h-full overflow-hidden"></div>
      </div>

      <!-- UNDER LIVE (PRO) -->
      <div class="glass-panel rounded-lg overflow-hidden min-h-0 flex flex-col">
        <div class="u-nav" id="under-tabs-nav">
          <button class="u-tab-btn active" data-ut="overview"><i class="fas fa-bolt mr-1"></i> R√âSUM√â</button>
          <button class="u-tab-btn" data-ut="analytics"><i class="fas fa-chart-line mr-1"></i> STATS PRO</button>
          <button class="u-tab-btn" data-ut="niche"><i class="fas fa-compass mr-1"></i> NICHE</button>
        </div>

        <!-- OVERVIEW -->
        <div id="under-overview" class="u-tab-panel active p-4 bg-[#0b0b0d] overflow-auto min-h-0">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Score Dynamique
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Score Dynamique</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> un score 0‚Äì100 bas√© sur croissance + stabilit√© + r√©gularit√©.</p>
                    <p><strong>Comment :</strong> calcule depuis tes donn√©es Firestore.</p>
                    <p><strong>Pourquoi utile :</strong> savoir si tu dois stabiliser (horaires) ou acc√©l√©rer (formats/clips).</p>
                  </span>
                </span>
              </div>
              <div id="kpi-growth-score" class="text-2xl font-orbitron text-[#00f2ea]">--</div>
              <div id="kpi-growth-label" class="text-[10px] text-gray-400 mt-1">--</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Moy. viewers (30j)
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Moyenne viewers 30 jours</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> moyenne de viewers sur les derniers jours enregistr√©s.</p>
                    <p><strong>Comment :</strong> bas√© sur tes snapshots Firestore (pas une estimation Twitch).</p>
                    <p><strong>Pourquoi utile :</strong> mesurer ta progression r√©elle au lieu de te fier √† un seul bon live.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-avg" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">donn√©es Firestore</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Pic viewers
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Pic viewers</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> ton maximum observ√© sur la p√©riode.</p>
                    <p><strong>Pourquoi utile :</strong> utile pour rep√©rer quel format/heure a ‚Äúcass√©‚Äù ton plafond.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-peak" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">sur p√©riode</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Croissance
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Croissance</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> √©volution (d√©but ‚Üí fin) sur la p√©riode.</p>
                    <p><strong>Pourquoi utile :</strong> si c‚Äôest plat, tu dois tester horaires/niches/clips.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-growth" class="text-2xl font-orbitron text-[#ff0099]">--</div>
              <div class="text-[10px] text-gray-500 mt-1">d√©but ‚Üí fin</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-bell mr-1"></i> Alertes utiles (automatiques)
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Alertes utiles</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> des messages actionnables bas√©s sur tes donn√©es.</p>
                    <p><strong>Pourquoi utile :</strong> te dire quoi tester sans √™tre perdu dans 100 chiffres.</p>
                  </span>
                </span>
              </h4>
              <div id="alerts-box" class="text-xs text-gray-400">‚Äî</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-wave-square mr-1"></i> Courbe (Aujourd‚Äôhui ‚Äì intraday)
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Courbe intraday</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> ton √©volution de viewers ‚Äúdans la journ√©e‚Äù.</p>
                    <p><strong>Comment :</strong> snapshots Firestore toutes les X minutes.</p>
                    <p><strong>Pourquoi utile :</strong> voir si une heure pr√©cise est vraiment meilleure.</p>
                  </span>
                </span>
              </h4>
              <div class="h-44"><canvas id="chartChannelDaily"></canvas></div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222] lg:col-span-2">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-magic mr-1"></i> IA ‚Äì plan d‚Äôaction clair
              </h4>
              <button id="btn-ai-reco" onclick="loadAIReco()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
                ‚ö° G√©n√©rer des recommandations
              </button>
              <div id="ai-reco-box" class="mt-3 text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto bg-[#0a0a0a] border border-[#222] rounded p-2 hidden"></div>
            </div>
          </div>
        </div>

        <!-- ANALYTICS -->
        <div id="under-analytics" class="u-tab-panel p-4 bg-[#0b0b0d] overflow-auto min-h-0">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Volatilit√©
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Volatilit√©</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> √† quel point tes viewers montent/descendent.</p>
                    <p><strong>Pourquoi utile :</strong> plus stable = meilleur pour la r√©tention & l‚Äôalgo.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-volatility" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">plus bas = plus stable</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                Heures / semaine (estim.)
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>Heures/semaine</strong><br>
                    <p><strong>Comment :</strong> d√©duit des snapshots.</p>
                    <p><strong>Pourquoi utile :</strong> la r√©gularit√© est l‚Äôun des facteurs n¬∞1 de progression.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-hours" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">bas√© sur snapshots</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase flex items-center">
                √âchantillons
                <span class="tip"><span class="qmark">?</span>
                  <span class="bubble">
                    <strong>√âchantillons</strong><br>
                    <p><strong>C‚Äôest quoi :</strong> le nombre de jours couverts par tes donn√©es.</p>
                    <p><strong>Pourquoi utile :</strong> plus y‚Äôen a ‚Üí plus c‚Äôest fiable.</p>
                  </span>
                </span>
              </div>
              <div id="kpi-samples" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">jours couverts</div>
            </div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
              <i class="fas fa-flask mr-1"></i> Simulation (objectif r√©alisable)
              <span class="tip"><span class="qmark">?</span>
                <span class="bubble">
                  <strong>Simulation</strong><br>
                  <p><strong>C‚Äôest quoi :</strong> estimation (pas une promesse) si tu stream plus r√©guli√®rement.</p>
                  <p><strong>Pourquoi utile :</strong> se fixer un rythme r√©aliste.</p>
                </span>
              </span>
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
              <input id="sim-hours" type="number" min="1" max="80" value="12" class="cyber-input" placeholder="Heures / semaine">
              <button onclick="runSimulation()" class="bg-[#ff0099] text-white px-4 rounded font-bold hover:bg-white hover:text-black transition font-orbitron text-xs">
                SIMULER
              </button>
              <div id="sim-result" class="text-xs text-gray-300 flex items-center bg-[#0a0a0a] border border-[#222] rounded px-3">--</div>
            </div>
          </div>
        </div>

        <!-- NICHE -->
        <div id="under-niche" class="u-tab-panel p-4 bg-[#0b0b0d] overflow-auto min-h-0">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
              <i class="fas fa-crosshairs mr-1"></i> Jeu : opportunit√© (meilleure heure)
              <span class="tip"><span class="qmark">?</span>
                <span class="bubble">
                  <strong>NICHE</strong><br>
                  <p><strong>C‚Äôest quoi :</strong> ratio ‚Äúviewers / concurrence‚Äù selon l‚Äôheure.</p>
                  <p><strong>Pourquoi utile :</strong> stream quand la concurrence est plus faible = plus de chances d‚Äô√™tre vu.</p>
                </span>
              </span>
            </h4>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Saturation</div>
                <div id="niche-sat" class="text-xl font-orbitron text-[#00f2ea]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">D√©couvrabilit√©</div>
                <div id="niche-discover" class="text-xl font-orbitron text-[#ff0099]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Heure id√©ale (UTC)</div>
                <div id="niche-position" class="text-xl font-orbitron text-white">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Verdict</div>
                <div id="niche-verdict" class="text-xl font-orbitron text-white">--</div>
              </div>
            </div>

            <div class="mt-3 text-xs text-gray-300" id="niche-details">‚Äî</div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-fire mr-1"></i> Heatmap opportunit√©s (jeu)</h4>
            <div class="h-44"><canvas id="chartGameHours"></canvas></div>
            <div class="text-[10px] text-gray-500 mt-2">Plus haut = plus d‚Äôopportunit√© (viewers / concurrence).</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="lg:col-span-4 flex flex-col glass-panel rounded-lg overflow-hidden h-full min-h-0">
      <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab(event,'chat')"><i class="fas fa-comments mr-1"></i> CHAT</button>
        <button class="tab-btn" onclick="openTab(event,'stats')"><i class="fas fa-chart-pie mr-1"></i> TWITCH</button>
        <button class="tab-btn" onclick="openTab(event,'tools')"><i class="fas fa-toolbox mr-1"></i> OUTILS</button>
      </div>

      <!-- CHAT -->
      <div id="tab-chat" class="tab-content active bg-[#0e0e10] min-h-0">
        <div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222]">
          <button onclick="toggleChatMode('twitch')" id="btn-mode-twitch" class="flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded">TWITCH</button>
          <button onclick="toggleChatMode('hub')" id="btn-mode-hub" class="flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white">HUB SECURE</button>
        </div>

        <div id="chat-container-twitch" class="flex-grow relative bg-[#0a0a0a] overflow-hidden min-h-0">
          <iframe id="twitch-chat-frame" src="" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no"></iframe>
        </div>

        <div id="chat-container-hub" class="flex-grow hidden flex-col relative bg-[#0b0b0d] min-h-0">
          <div id="hub-messages" class="flex-grow overflow-y-auto p-2">
            <div class="text-center text-gray-600 text-xs mt-4">
              Bienvenue sur le Hub S√©curis√© ‚Äî Connect√© en tant que : <span id="hub-user-display" class="text-[#00f2ea] font-bold">Anonyme</span>
            </div>
          </div>
          <form onsubmit="sendHubMessage(event)" class="p-2 border-t border-[#222] flex gap-2 bg-[#080808]">
            <input id="hub-input" type="text" placeholder="Message..." class="bg-[#1a1a1a] text-white text-xs p-2 rounded flex-grow outline-none border border-[#333] focus:border-[#00f2ea]">
            <button type="submit" class="text-[#00f2ea] px-2"><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>

      <!-- STATS -->
      <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] min-h-0">
        <div class="text-xs text-gray-400 mb-3">
          <strong class="text-white">üì° Twitch en direct</strong> ‚Äî √©volution intraday (les derni√®res heures).
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
            <div class="text-[10px] text-gray-500 uppercase flex items-center">
              Viewers (estim.)
              <span class="tip"><span class="qmark">?</span>
                <span class="bubble">
                  <strong>Viewers estim√©s</strong><br>
                  <p><strong>Pourquoi :</strong> Twitch renvoie un sample limit√©. On extrapole pour donner une id√©e du trafic global.</p>
                </span>
              </span>
            </div>
            <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
          </div>
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
            <div class="text-[10px] text-gray-500 uppercase">Cha√Ænes live (sample)</div>
            <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
              <i class="fas fa-chart-line mr-1"></i> Tendance (intraday)
            </h4>
            <div class="h-44"><canvas id="chartViewers"></canvas></div>
          </div>

          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
            <div class="h-48"><canvas id="chartGames"></canvas></div>
          </div>

          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
            <div class="h-40"><canvas id="chartLangs"></canvas></div>
          </div>
        </div>
      </div>

      <!-- OUTILS -->
      <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] space-y-6 min-h-0">

        <div class="bg-[#111] p-3 rounded border border-[#222]">
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-2 border-b border-[#222] pb-2">
            üéØ Meilleur Horaire (IA)
          </h3>
          <div class="text-xs text-gray-400 mb-2">
            Tape un jeu ‚Üí l‚ÄôIA te donne <strong>3 cr√©neaux pr√©cis</strong> o√π tu as plus de chances d‚Äô√™tre d√©couvert.
          </div>
          <div class="flex gap-2 mb-3">
            <input id="best-time-game" type="text" placeholder="Jeu ex: League of Legends" class="cyber-input">
            <button id="analyze-schedule-btn" onclick="analyzeBestTime()" class="bg-[#00f2ea] text-black px-4 rounded font-bold hover:bg-white">
              <i class="fas fa-clock"></i>
            </button>
          </div>
          <div id="best-time-loading" style="display:none; text-align:center; margin-top:10px; color:#00f2ea;">
            <i class="fas fa-spinner fa-spin"></i> Analyse en cours...
          </div>
          <div id="best-time-results" class="bg-[#0a0a0a] border border-[#222] rounded p-2 text-xs text-gray-300" style="display:none;"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal Jeux Netflix-like -->
  <div id="game-modal" class="modal-backdrop" onclick="closeGameModal(event)">
    <div class="modal-panel" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-orbitron text-[#00f2ea] text-sm">üé¨ Choisis un jeu (style Netflix)</h3>
        <button class="text-gray-400 hover:text-white" onclick="closeGameModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="text-xs text-gray-400 mb-3">
        Clique sur une couverture ‚Üí √ßa remplit le champ du jeu, puis tu peux faire <strong>üçÄ J‚Äôai de la chance</strong>.
      </div>

      <div id="game-grid" class="game-grid">
        <div class="text-gray-500 text-xs">Chargement...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const PARENT_DOMAINS = ['localhost','127.0.0.1',window.location.hostname,'justplayer.fr','www.justplayer.fr'];

    let socket;
    let currentChannel = 'twitch';
    let currentUser = null;
    let charts = {};
    let raidTarget = null;

    let currentChannelId = null;
    let currentGameId = null;
    let currentGameName = null;

    // INIT
    window.addEventListener('load', async () => {
      initUnderTabs();
      await checkAuth();
      initPlayer();
      loadStatsDashboard();         // ‚úÖ Twitch intraday + charts
      initCarouselScroll();
      initSocket();
      initFirebaseStatus();
      setInterval(loadStatsDashboard, 60 * 1000); // ‚úÖ refresh plus fr√©quent (1 min)
    });

    function initUnderTabs(){
      const nav = document.getElementById('under-tabs-nav');
      if (!nav) return;
      nav.querySelectorAll('.u-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ut');
          nav.querySelectorAll('.u-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#under-overview,#under-analytics,#under-niche').forEach(p=>p.classList.remove('active'));
          const panel = document.getElementById(`under-${id}`);
          if (panel) panel.classList.add('active');
        });
      });
    }

    // FIREBASE STATUS
    async function initFirebaseStatus() {
      async function checkStatus() {
        try {
          const response = await fetch(`${API_BASE}/firebase_status`);
          const data = await response.json();
          const statusEl = document.getElementById('socket-status');
          if (data.connected) {
            statusEl.innerText = 'HUB SECURE';
            statusEl.className = 'text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded';
          } else {
            statusEl.innerText = 'HUB DISCONNECTED';
            statusEl.className = 'text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded';
          }
        } catch (error) {
          console.error('Firebase status error:', error);
        }
      }
      checkStatus();
      setInterval(checkStatus, 5000);
    }

    // AUTH
    async function checkAuth() {
      const res = await fetch(`${API_BASE}/twitch_user_status`);
      const data = await res.json();
      if (data.is_connected) {
        currentUser = data.display_name;
        document.getElementById('hub-user-display').innerText = data.display_name;

        document.getElementById('btn-auth').classList.add('hidden');
        document.getElementById('user-area').classList.remove('hidden');

        document.getElementById('user-name').innerText = data.display_name;
        if (data.profile_image_url) document.getElementById('user-avatar').src = data.profile_image_url;

        await loadFollowed();
      }
    }

    function startAuth() {
      window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=700');
      const check = setInterval(async () => {
        const res = await fetch(`${API_BASE}/twitch_user_status`);
        const data = await res.json();
        if (data.is_connected) { clearInterval(check); location.reload(); }
      }, 1000);
    }
    function logout() { fetch(`${API_BASE}/twitch_logout`, { method:'POST' }).then(()=>location.reload()); }

    // PLAYER
    async function initPlayer() {
      const res = await fetch(`${API_BASE}/get_default_stream`);
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('player-mode-badge').innerText = data.mode || 'AUTO';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    function loadPlayerEmbed(channel) {
      const container = document.getElementById('video-container');
      const parentParam = PARENT_DOMAINS.join('&parent=');
      const iframeUrl = `https://player.twitch.tv/?channel=${channel}&parent=${parentParam}&theme=dark`;
      container.innerHTML = `<iframe src="${iframeUrl}" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no" style="border:none;width:100%;height:100%;"></iframe>`;
      loadStreamInfo(channel);
    }

    function loadStreamInfo(channel) {
      fetch(`${API_BASE}/stream_info`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ channel })
      })
      .then(r=>r.json())
      .then(data=>{
        if (data.success && data.stream) {
          const title = data.stream.title || 'Sans titre';
          const viewers = data.stream.viewer_count || 0;

          const display = document.getElementById('current-channel-display');
          const titleText = title.length > 40 ? title.substring(0,40) + '...' : title;
          display.innerText = `${channel.toUpperCase()} ‚Ä¢ ${titleText}`;
          display.title = title;

          document.getElementById('viewer-count').innerText = `${viewers.toLocaleString()} viewers`;

          currentGameId = data.stream.game_id || null;
          currentGameName = data.stream.game_name || null;

          // ‚úÖ charge pro data
          loadChannelProData(channel);
        } else {
          document.getElementById('viewer-count').innerText = `Offline`;
        }
      })
      .catch(e=>console.error('Stream info error:', e));
    }

    function updateTwitchChatFrame(channel){
      const parentParam = PARENT_DOMAINS.join('&parent=');
      const url = `https://www.twitch.tv/embed/${channel}/chat?parent=${parentParam}&theme=dark`;
      const frame = document.getElementById('twitch-chat-frame');
      if (frame) frame.src = url;
    }

    async function cycle(dir){
      const res = await fetch(`${API_BASE}/cycle_stream`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ direction: dir })
      });
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('viewer-count').innerText = '-- viewers';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    // ‚úÖ LUCKY PICK (<=100 viewers)
    async function luckyPick(){
      const game = document.getElementById('lucky-game').value.trim();
      // Si pas de jeu => get_default_stream (d√©j√† <=100)
      if (!game){
        initPlayer();
        return;
      }
      // Sinon => /start_raid max 100 comme ‚Äúp√©pites‚Äù dans ce jeu
      try{
        const r = await fetch(`${API_BASE}/start_raid`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game, max_viewers: 100 })
        });
        const data = await r.json();
        if (data.success && data.target?.login){
          changeChannel(data.target.login);
        } else {
          // fallback
          initPlayer();
        }
      }catch(e){
        initPlayer();
      }
    }

    // CAROUSEL
    function initCarouselScroll(){
      const el = document.getElementById('carousel');
      if (!el) return;
      el.addEventListener('wheel',(evt)=>{ evt.preventDefault(); el.scrollLeft += evt.deltaY; }, { passive:false });
    }

    async function loadFollowed(){
      const el = document.getElementById('carousel');
      el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-[#00f2ea]"></i></div>';
      try{
        const res = await fetch(`${API_BASE}/followed_streams`);
        const data = await res.json();
        if (data.success && data.streams.length > 0){
          el.innerHTML = '';
          // ‚úÖ filtre <=100 viewers
          const small = data.streams.filter(s => (s.viewer_count || 0) <= 100);
          const list = small.length ? small : data.streams;

          list.forEach(s=>{
            const thumb = (s.thumbnail_url||'').replace('{width}','400').replace('{height}','225');
            el.innerHTML += `
              <div class="stream-card flex-shrink-0" onclick="changeChannel('${s.user_login}')">
                <img src="${thumb}" class="card-img" onerror="this.src='https://via.placeholder.com/400x225'">
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">
                  <div class="font-bold text-white text-sm truncate">${s.user_name}</div>
                  <div class="text-[10px] text-gray-300">${(s.viewer_count||0)} viewers ‚Ä¢ ${s.game_name||''}</div>
                </div>
                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div>
              </div>`;
          });
        } else {
          el.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Aucun live suivi (ou aucun <=100 viewers).</div>';
        }
      }catch(e){
        console.error('Carousel error:', e);
        el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur</div>';
      }
    }

    function changeChannel(channel){
      currentChannel = channel;
      document.getElementById('current-channel-display').innerText = channel.toUpperCase();
      document.getElementById('viewer-count').innerText = '-- viewers';
      loadPlayerEmbed(channel);
      updateTwitchChatFrame(channel);
    }

    // RIGHT TABS
    function openTab(e, id){
      document.querySelectorAll('#tab-chat,#tab-stats,#tab-tools').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab-nav .tab-btn').forEach(el=>el.classList.remove('active'));
      document.getElementById(`tab-${id}`).classList.add('active');
      if (e?.currentTarget) e.currentTarget.classList.add('active');
    }

    function toggleChatMode(mode){
      const twitch = document.getElementById('chat-container-twitch');
      const hub = document.getElementById('chat-container-hub');
      const btnTw = document.getElementById('btn-mode-twitch');
      const btnHb = document.getElementById('btn-mode-hub');

      if (mode === 'hub'){
        twitch.classList.add('hidden');
        hub.classList.remove('hidden'); hub.classList.add('flex');
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded';
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      } else {
        hub.classList.add('hidden'); hub.classList.remove('flex');
        twitch.classList.remove('hidden');
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded';
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      }
    }

    // SOCKET.IO
    function initSocket(){
      try{
        socket = io({ transports:['websocket'], upgrade:false });
        socket.on('chat message',(msg)=>{
          const box = document.getElementById('hub-messages');
          const user = msg.user || 'Anon';
          const text = msg.text || msg;
          box.innerHTML += `<div class="text-xs border-b border-[#1a1a1a] py-2"><strong class="text-[#00f2ea]">${user}</strong> <span class="text-gray-300">${text}</span></div>`;
          box.scrollTop = box.scrollHeight;
        });
      }catch(e){ console.error('Socket error:', e); }
    }

    function sendHubMessage(e){
      e.preventDefault();
      const input = document.getElementById('hub-input');
      if (!input.value) return;
      if (socket) socket.emit('chat message',{ user: currentUser || 'Anon', text: input.value });
      input.value = '';
    }

    // BEST TIME
    async function analyzeBestTime(){
      const gameInput = document.getElementById('best-time-game').value.trim();
      if (!gameInput) return alert('Veuillez entrer un nom de jeu');

      const btn = document.getElementById('analyze-schedule-btn');
      const loading = document.getElementById('best-time-loading');
      const results = document.getElementById('best-time-results');

      btn.disabled = true;
      loading.style.display = 'block';
      results.style.display = 'none';
      results.innerHTML = '';

      try{
        const response = await fetch(`${API_BASE}/analyze_schedule`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game: gameInput })
        });
        const data = await response.json();
        results.innerHTML = data.html_response || '<p style="color:#ff6666;">‚ùå Erreur</p>';
        results.style.display = 'block';
      }catch(e){
        results.innerHTML = '<p style="color:#ff6666;">‚ùå Erreur r√©seau</p>';
        results.style.display = 'block';
      }finally{
        btn.disabled = false;
        loading.style.display = 'none';
      }
    }

    // ‚úÖ Twitch dashboard intraday
    async function loadStatsDashboard(){
      try{
        const res = await fetch(`${API_BASE}/api/stats/global_intraday?hours=24`);
        const data = await res.json();

        if (data.success){
          document.getElementById('kpi-viewers').innerText = Number(data.current_total_viewers||0).toLocaleString();
          document.getElementById('kpi-channels').innerText = Number(data.current_channels_live||0).toLocaleString();

          renderChart('chartViewers','line',data.series.labels,data.series.values,'Viewers (intraday)');
        } else {
          // fallback old endpoint
          const r2 = await fetch(`${API_BASE}/api/stats/global`);
          const d2 = await r2.json();
          if (d2.success){
            document.getElementById('kpi-viewers').innerText = d2.total_viewers.toLocaleString();
            document.getElementById('kpi-channels').innerText = d2.total_channels;
            renderChart('chartViewers','line',d2.history.live.labels,d2.history.live.values,'Viewers');
          }
        }

        // games / langs
        const resGames = await fetch(`${API_BASE}/api/stats/top_games`);
        const dGames = await resGames.json();
        const labels = (dGames.games||[]).map(g=>g.name);
        const values = labels.map((_,i)=>(i+1)*20);
        renderChart('chartGames','bar',labels.slice(0,5),values.slice(0,5),'Popularit√©');

        const resLang = await fetch(`${API_BASE}/api/stats/languages`);
        const dLang = await resLang.json();
        const lLabels = (dLang.languages||[]).map(l=>l.name);
        const lValues = (dLang.languages||[]).map(l=>l.percent);
        renderChart('chartLangs','doughnut',lLabels,lValues,'Part');
      }catch(e){ console.error('Stats error:', e); }
    }

    function renderChart(id,type,labels,data,label){
      const el = document.getElementById(id);
      if (!el) return;
      if (charts[id]) charts[id].destroy();

      charts[id] = new Chart(el.getContext('2d'),{
        type,
        data:{ labels, datasets:[{ label, data, borderWidth:2, fill:(type==='line'), tension:.35, borderColor:'#00f2ea', backgroundColor:'rgba(0,242,234,.15)' }]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:(type==='doughnut'), position:'right', labels:{ color:'white', boxWidth:10 } } },
          scales:{
            x:{ display:(type!=='doughnut'), ticks:{ color:'#666', maxRotation:0, autoSkip:true } },
            y:{ display:(type!=='doughnut'), grid:{ color:'#222' }, ticks:{ color:'#666' } }
          }
        }
      });
    }

    // ===== Sous le live =====
    async function loadChannelProData(login){
      if (!login || login === 'twitch') return;

      // ‚úÖ 1) Intraday (courbe journ√©e)
      try{
        const iRes = await fetch(`${API_BASE}/api/analytics/channel_intraday_by_login/${encodeURIComponent(login)}?hours=24`);
        const iData = await iRes.json();
        if (iData.success){
          renderChart('chartChannelDaily','line',iData.series.labels,iData.series.values,'Viewers (aujourd‚Äôhui)');
          document.getElementById('kpi-volatility').innerText = iData.kpis.volatility ?? '--';
        }
      }catch(e){}

      // ‚úÖ 2) 30 jours (KPIs)
      try{
        const res = await fetch(`${API_BASE}/api/analytics/channel_by_login/${encodeURIComponent(login)}?days=30`);
        const data = await res.json();

        if (!data.success){
          document.getElementById('kpi-growth-label').innerText = data.message || "Pas assez de donn√©es (laisse tourner le cron).";
          return;
        }

        currentChannelId = data.channel_id || null;

        const k = data.kpis || {};
        const fmt = v => (v==null ? '--' : Number(v).toLocaleString());

        document.getElementById('kpi-avg').innerText = fmt(k.avg_viewers);
        document.getElementById('kpi-peak').innerText = fmt(k.peak_viewers);
        document.getElementById('kpi-growth').innerText = (k.growth_percent!=null ? `${k.growth_percent}%` : '--');
        document.getElementById('kpi-hours').innerText = (k.hours_per_week_est!=null ? `${k.hours_per_week_est}h` : '--');
        document.getElementById('kpi-samples').innerText = fmt(k.days);
        document.getElementById('kpi-growth-score').innerText = (k.growth_score!=null ? `${k.growth_score}/100` : '--');

        const gs = k.growth_score;
        document.getElementById('kpi-growth-label').innerText =
          gs==null ? '--' :
          gs>=80 ? 'üî• En forte acc√©l√©ration' :
          gs>=60 ? '‚úÖ Bonne dynamique' :
          gs>=40 ? 'üü° Stable (optimisable)' :
          'üî¥ √Ä relancer';

        await loadAlerts(login);

        if (currentGameId){
          await loadGameHours(currentGameId);
        }

      }catch(e){
        console.error('loadChannelProData error:', e);
      }
    }

    async function loadAlerts(login){
      const box = document.getElementById('alerts-box');
      if (!box) return;
      box.innerHTML = '<div class="text-gray-500 text-xs"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';

      try{
        let r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
        let data = await r.json();

        if (!data.success || !data.items || data.items.length === 0){
          await fetch(`${API_BASE}/api/alerts/generate`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ login, days:30 })
          }).catch(()=>{});

          r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
          data = await r.json();
        }

        if (!data.success || !data.items){
          box.innerHTML = '<div class="text-gray-500 text-xs">Aucune alerte.</div>';
          return;
        }

        box.innerHTML = '';
        data.items.forEach(a=>{
          box.innerHTML += `
            <div class="bg-[#0a0a0a] border border-[#222] rounded p-2 mb-2">
              <div class="flex items-center justify-between gap-2">
                <div class="text-xs font-bold text-white">${a.title || 'Alerte'}</div>
                <div class="text-[10px] text-gray-500">${a.day || ''}</div>
              </div>
              <div class="text-[11px] text-gray-300 mt-1 leading-snug">${a.message || ''}</div>
            </div>`;
        });

      }catch(e){
        console.error('loadAlerts', e);
        box.innerHTML = '<div class="text-gray-500 text-xs">Erreur alertes.</div>';
      }
    }

    async function loadGameHours(gameId){
      try{
        const r = await fetch(`${API_BASE}/api/games/hours?game_id=${encodeURIComponent(gameId)}&days=7`);
        const data = await r.json();
        if (!data.success || !data.hours) return;

        const labels = data.hours.map(x => `${String(x.hour).padStart(2,'0')}h`);
        const values = data.hours.map(x => (x.discoverability_score || 0));
        renderChart('chartGameHours','line',labels,values,'Opportunit√©');

        const best = data.hours.slice().sort((a,b)=>(b.discoverability_score||0)-(a.discoverability_score||0))[0];
        document.getElementById('niche-sat').innerText = best?.saturation_score!=null ? `${best.saturation_score}/100` : '--';
        document.getElementById('niche-discover').innerText = best?.discoverability_score!=null ? `${best.discoverability_score}/100` : '--';
        document.getElementById('niche-position').innerText = best ? `${String(best.hour).padStart(2,'0')}h UTC` : '--';
        document.getElementById('niche-verdict').innerText = best?.discoverability_score>=70 ? 'üî• Tr√®s bon' : best?.discoverability_score>=45 ? '‚úÖ OK' : 'üü° Risqu√©';
        document.getElementById('niche-details').innerText =
          best ? `Meilleure fen√™tre: ${String(best.hour).padStart(2,'0')}h UTC ‚Ä¢ viewers totaux observ√©s: ${best.total_viewers || 0}` : '‚Äî';
      }catch(e){
        console.error('loadGameHours', e);
      }
    }

    async function loadAIReco(){
      if (!currentChannel || currentChannel === 'twitch') return;
      const box = document.getElementById('ai-reco-box');
      const btn = document.getElementById('btn-ai-reco');

      box.classList.add('hidden');
      box.innerHTML = '';
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';

      try{
        const res = await fetch(`${API_BASE}/api/ai/reco?login=${encodeURIComponent(currentChannel)}&days=30`);
        const data = await res.json();
        box.innerHTML = data.html_response || "<p style='color:#ff6666;'>‚ùå Pas de recommandation</p>";
        box.classList.remove('hidden');
      }catch(e){
        box.innerHTML = "<p style='color:#ff6666;'>‚ùå Erreur IA</p>";
        box.classList.remove('hidden');
      }finally{
        btn.disabled = false;
        btn.innerHTML = '‚ö° G√©n√©rer des recommandations';
      }
    }

    async function runSimulation(){
      const hours = parseInt(document.getElementById('sim-hours').value || '0',10);
      const out = document.getElementById('sim-result');
      if (!currentChannelId || !hours){ out.innerText = '‚Äî'; return; }

      out.innerText = '...';
      try{
        const res = await fetch(`${API_BASE}/api/simulate/growth?channel_id=${encodeURIComponent(currentChannelId)}&hours_per_week=${encodeURIComponent(hours)}&days=30`);
        const data = await res.json();
        if (!data.success){ out.innerText = 'Pas assez de data'; return; }
        out.innerText = `‚âà ${data.target.expected_avg_viewers} viewers ‚Ä¢ (${data.target.expected_change_percent}% estim.)`;
      }catch(e){
        out.innerText = 'Erreur';
      }
    }

    // ===== Modal Jeux =====
    async function openGameModal(){
      const modal = document.getElementById('game-modal');
      modal.classList.add('show');
      await loadGameCovers();
    }
    function closeGameModal(){
      document.getElementById('game-modal').classList.remove('show');
    }
    async function loadGameCovers(){
      const grid = document.getElementById('game-grid');
      grid.innerHTML = '<div class="text-gray-500 text-xs">Chargement...</div>';
      try{
        const r = await fetch(`${API_BASE}/api/stats/top_games`);
        const d = await r.json();
        const games = d.games || [];
        if (!games.length){
          grid.innerHTML = '<div class="text-gray-500 text-xs">Aucun jeu trouv√©.</div>';
          return;
        }
        grid.innerHTML = games.map(g=>{
          const img = (g.box_art_url || '').replace('52','300').replace('72','420');
          return `
            <div class="game-card" onclick="selectGame('${escapeHtml(g.name)}')">
              <img src="${img}" onerror="this.src='https://via.placeholder.com/300x420'">
              <div class="name">${escapeHtml(g.name)}</div>
            </div>`;
        }).join('');
      }catch(e){
        grid.innerHTML = '<div class="text-red-400 text-xs">Erreur chargement jeux.</div>';
      }
    }
    function selectGame(name){
      document.getElementById('lucky-game').value = name;
      closeGameModal();
    }
    function escapeHtml(s){
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
  </script>
</body>
</html>
