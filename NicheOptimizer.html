<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streamer Hub V52 - ULTIMATE PERFORMANCE</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    :root {
      --bg-dark: #050505;
      --bg-panel: #0b0b0d;
      --primary: #ff0099;
      --secondary: #00f2ea;
      --text-main: #e0e0e0;
      --border-color: #1f1f23;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: Inter, sans-serif;
      overflow-x: hidden;
    }

    .font-orbitron {
      font-family: Orbitron, sans-serif;
    }

    /* SCROLLBAR CUSTOM */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #000;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* CAROUSEL */
    .carousel-track {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding: 10px 5px;
      scroll-behavior: smooth;
      cursor: grab;
    }
    .carousel-track.active {
      cursor: grabbing;
    }

    .stream-card {
      flex: 0 0 300px;
      height: 170px;
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: 0.2s;
    }
    .stream-card:hover {
      border-color: var(--secondary);
      transform: translateY(-4px);
      box-shadow: 0 5px 20px rgba(0, 242, 234, 0.15);
    }

    .card-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.7;
      transition: 0.3s;
    }
    .stream-card:hover .card-img {
      opacity: 1;
    }

    /* LAYOUT */
    .glass-panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
    }

    /* TABS */
    .tab-nav {
      display: flex;
      background: #080808;
      border-bottom: 1px solid var(--border-color);
    }
    .tab-btn {
      flex: 1;
      padding: 14px;
      text-align: center;
      color: #666;
      font-family: Orbitron;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: 0.3s;
    }
    .tab-btn:hover {
      color: white;
      background: #111;
    }
    .tab-btn.active {
      color: var(--secondary);
      border-bottom-color: var(--secondary);
      background: #151515;
    }

    /* CONTENT AREAS */
    .tab-content {
      display: none;
      height: 100%;
      flex-direction: column;
    }
    .tab-content.active {
      display: flex;
    }

    /* INPUTS */
    .cyber-input {
      background: #151515;
      border: 1px solid #333;
      color: white;
      padding: 12px;
      border-radius: 4px;
      font-family: Inter;
      font-size: 13px;
      outline: none;
      transition: 0.3s;
      width: 100%;
    }
    .cyber-input:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 10px rgba(0, 242, 234, 0.2);
    }

    /* HUB CHAT */
    .hub-msg {
      padding: 8px;
      border-bottom: 1px solid #1a1a1a;
      font-size: 13px;
      line-height: 1.4;
    }
    .hub-msg strong {
      font-family: Orbitron;
      font-size: 11px;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 4px;
    }
  </style>
</head>
<body class="h-screen flex flex-col p-4">
  <!-- HEADER -->
  <header class="flex justify-between items-center mb-4 pb-2 border-b border-222">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-orbitron italic tracking-widest">
        <span class="text-00f2ea">STREAMER</span> HUB 
        <span class="bg-222 text-ff0099 px-2 rounded text-xs ml-2 not-italic">V52</span>
      </h1>
      <!-- ✅ CORRECTION 2: Status HUB CONNECTED -->
      <div id="socket-status" class="text-10px font-bold text-00f2ea border border-00f2ea px-2 rounded shadow-00 5px 00f2ea">HUB CONNECTED</div>
    </div>
    <div>
      <button id="btn-auth" onclick="startAuth()" class="bg-6441a5 hover:bg-7d5bbe text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-7d5bbe">
        <i class="fab fa-twitch"></i> CONNEXION
      </button>
      <div id="user-area" class="hidden flex items-center gap-3">
        <!-- ✅ CORRECTION 3: Avatar avec placeholder fallback -->
        <img id="user-avatar" src="https://via.placeholder.com/32x32/333/00f2ea?text=?" class="w-8 h-8 rounded-full border border-00f2ea" onerror="this.src='https://via.placeholder.com/32x32/333/00f2ea?text=?'">
        <span id="user-name" class="font-bold text-white text-sm"></span>
        <button onclick="logout()" class="text-gray-500 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </header>

  <!-- CAROUSEL -->
  <div class="mb-4 relative group">
    <div id="carousel" class="carousel-track">
      <div class="w-full text-center py-10 border border-dashed border-333 rounded text-gray-500">
        <i class="fas fa-satellite-dish mb-2"></i><br>Connectez-vous pour voir vos chaînes.
      </div>
    </div>
    <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-050505 to-transparent pointer-events-none"></div>
  </div>

  <!-- MAIN GRID -->
  <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
    <!-- VIDEO PLAYER -->
    <div class="lg:col-span-8 flex flex-col gap-4 h-full">
      <!-- PLAYER -->
      <div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl">
        <div class="bg-080808 p-3 flex justify-between items-center border-b border-222">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-0010pxred"></div>
            <span id="current-channel-display" class="font-orbitron text-00f2ea text-sm tracking-wider truncate">OFFLINE</span>
            <span id="player-mode-badge" class="text-10px bg-222 px-2 py-0.5 rounded text-gray-400 flex-shrink-0">AUTO</span>
            <span id="viewer-count" class="text-10px text-ff0099 font-bold flex-shrink-0">0 viewers</span>
          </div>
          <div class="flex gap-2 flex-shrink-0">
            <button onclick="cyclePrev()" class="bg-1a1a1a hover:bg-333 text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="cycleNext()" class="bg-1a1a1a hover:bg-333 text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        <div id="video-container" class="flex-grow bg-black relative w-full h-full overflow-hidden"></div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="lg:col-span-4 flex flex-col glass-panel rounded-lg overflow-hidden h-full max-h-calc100vh-280px lg:max-h-full">
      <!-- TAB NAV -->
      <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('chat')"><i class="fas fa-comments mr-1"></i> CHAT</button>
        <button class="tab-btn" onclick="openTab('stats')"><i class="fas fa-chart-pie mr-1"></i> STATS</button>
        <button class="tab-btn" onclick="openTab('tools')"><i class="fas fa-toolbox mr-1"></i> OUTILS</button>
      </div>

      <!-- TAB CHAT -->
      <div id="tab-chat" class="tab-content active bg-0e0e10">
        <div class="flex p-2 gap-2 bg-080808 border-b border-222">
          <button onclick="toggleChatMode('twitch')" id="btn-mode-twitch" class="flex-1 py-1 text-xs font-bold bg-6441a5 text-white rounded">TWITCH</button>
          <button onclick="toggleChatMode('hub')" id="btn-mode-hub" class="flex-1 py-1 text-xs font-bold bg-1a1a1a text-gray-400 rounded hover:text-white">HUB SECURE</button>
        </div>
        <!-- ✅ CORRECTION 4: Chat DARK MODE (bg-black) -->
        <div id="chat-container-twitch" class="flex-grow relative bg-black overflow-hidden">
          <iframe id="twitch-chat-frame" src="" width="100%" height="100%" frameborder="0" allowautoplay scrolling="no"></iframe>
        </div>
        <div id="chat-container-hub" class="flex-grow hidden flex-col relative bg-0b0b0d">
          <div id="hub-messages" class="flex-grow overflow-y-auto p-2 scrollbar-thin">
            <div class="text-center text-gray-600 text-xs mt-4">Bienvenue sur le Hub Sécurisé - Connecté en tant que <span id="hub-user-display" class="text-00f2ea font-bold">Anonyme</span></div>
          </div>
          <form onsubmit="sendHubMessage(event)" class="p-2 border-t border-222 flex gap-2 bg-080808">
            <input id="hub-input" type="text" placeholder="Message crypté..." class="bg-1a1a1a text-white text-xs p-2 rounded flex-grow outline-none border border-333 focus:border-00f2ea">
            <button type="submit" class="text-00f2ea px-2"><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>

      <!-- TAB STATS -->
      <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-0b0b0d scrollbar-thin">
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="bg-151515 p-3 rounded border-l-2 border-00f2ea">
            <div class="text-10px text-gray-500 uppercase">Viewers Totaux</div>
            <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
          </div>
          <div class="bg-151515 p-3 rounded border-l-2 border-ff0099">
            <div class="text-10px text-gray-500 uppercase">Chaînes FR</div>
            <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
          </div>
        </div>
        <div class="space-y-6">
          <div class="bg-111 p-3 rounded border border-222">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-chart-line mr-1"></i> Tendance 12h</h4>
            <div class="h-40"><canvas id="chartViewers"></canvas></div>
          </div>
          <div class="bg-111 p-3 rounded border border-222">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
            <div class="h-48"><canvas id="chartGames"></canvas></div>
          </div>
          <div class="bg-111 p-3 rounded border border-222">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
            <div class="h-40"><canvas id="chartLangs"></canvas></div>
          </div>
        </div>
      </div>

      <!-- TAB TOOLS -->
      <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-0b0b0d space-y-6">
        <!-- SCANNER IA -->
        <div>
          <h3 class="text-00f2ea font-orbitron text-sm mb-3 border-b border-222 pb-2">SCANNER IA</h3>
          <div class="flex gap-2 mb-3">
            <input id="scan-query" type="text" placeholder="Pseudo ex: ZeratoR" class="cyber-input">
            <button onclick="runScan()" class="bg-00f2ea text-black px-4 rounded font-bold hover:bg-white"><i class="fas fa-search"></i></button>
          </div>
          <div id="scan-res" class="hidden bg-151515 p-3 rounded border border-222">
            <div class="flex gap-3 items-center mb-3">
              <img id="scan-img" src="" class="w-12 h-12 rounded-full border border-00f2ea">
              <div>
                <div id="scan-name" class="font-bold text-white">--</div>
                <div id="scan-game" class="text-xs text-gray-500">--</div>
              </div>
            </div>
            <div id="scan-ai" class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto"></div>
          </div>
        </div>

        <!-- RAID FINDER -->
        <div>
          <h3 class="text-00f2ea font-orbitron text-sm mb-3 border-b border-222 pb-2">RAID FINDER</h3>
          <div class="flex gap-2 mb-3">
            <input id="raid-game" type="text" placeholder="Jeu ex: League" class="cyber-input">
            <input id="raid-viewers" type="number" placeholder="Max viewers" class="cyber-input" value="100">
          </div>
          <button onclick="runRaid()" class="w-full bg-00f2ea text-black py-2 rounded font-bold hover:bg-white mb-3">CHERCHER</button>
          <div id="raid-res" class="hidden bg-151515 p-3 rounded border border-222">
            <img id="raid-img" src="" class="w-full h-40 rounded mb-3 object-cover">
            <div id="raid-info" class="text-xs text-gray-300"></div>
            <button id="raid-btn" onclick="goToRaid()" class="w-full bg-00f2ea text-black py-2 rounded font-bold mt-2 hover:bg-white">ALLER AU RAID</button>
          </div>
        </div>

        <!-- BOOST -->
        <div>
          <h3 class="text-ff0099 font-orbitron text-sm mb-3 border-b border-222 pb-2">BOOST</h3>
          <input id="boost-query" type="text" placeholder="Chaîne..." class="cyber-input mb-2">
          <button onclick="runBoost()" class="w-full bg-ff0099 text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition">ACTIVER</button>
          <div id="boost-msg" class="text-center text-xs mt-2 text-green-400"></div>
        </div>

        <!-- ✅ CORRECTION 5: BEST TIME PREMIUM -->
        <div>
          <h3 class="text-00f2ea font-orbitron text-sm mb-3 border-b border-222 pb-2">⏰ BEST TIME PREMIUM</h3>
          <div class="flex gap-2 mb-3">
            <input id="besttime-game" type="text" placeholder="Jeu ex: League" class="cyber-input">
            <button onclick="runBestTime()" class="bg-gradient-to-r from-00f2ea to-ff0099 text-black px-4 py-2 rounded font-bold hover:shadow-lg transition">ANALYSE</button>
          </div>
          <div id="besttime-res" class="hidden bg-151515 p-4 rounded border border-222">
            <div id="besttime-loading" class="text-center py-4">
              <i class="fas fa-brain fa-spin text-00f2ea"></i><br><span class="text-00f2ea text-xs">Analyse Premium IA...</span>
            </div>
            <div id="besttime-result" class="text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto hidden"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const APIBASE = window.location.origin;
    const PARENTDOMAINS = 'localhost, 127.0.0.1, ' + window.location.hostname + ', justplayer.fr, www.justplayer.fr';
    
    let player, socket, currentChannel = 'twitch', currentUser = null, charts = {}, raidTarget = null;

    // INIT
    window.addEventListener('load', async () => {
      checkAuth();
      initPlayer();
      loadStatsDashboard();
      initCarouselScroll();
      initSocket();
      setInterval(loadStatsDashboard, 5 * 60 * 1000);
    });

    // AUTH
    async function checkAuth() {
      try {
        const res = await fetch(APIBASE + '/twitch_user_status');
        const data = await res.json();
        if (data.is_connected) {
          currentUser = data.display_name;
          document.getElementById('hub-user-display').innerText = data.display_name;
          document.getElementById('btn-auth').classList.add('hidden');
          document.getElementById('user-area').classList.remove('hidden');
          document.getElementById('user-name').innerText = data.display_name;
          if (data.profile_image_url) document.getElementById('user-avatar').src = data.profile_image_url;
          await loadFollowed();
        }
      } catch (e) {}
    }

    function startAuth() {
      window.open(APIBASE + '/twitch_auth_start', 'login', 'width=500,height=700');
      const check = setInterval(async () => {
        const res = await fetch(APIBASE + '/twitch_user_status');
        const data = await res.json();
        if (data.is_connected) {
          clearInterval(check);
          location.reload();
        }
      }, 1000);
    }

    function logout() {
      fetch(APIBASE + '/twitch_logout', { method: 'POST' }).then(() => location.reload());
    }

    // PLAYER
    async function initPlayer() {
      try {
        const res = await fetch(APIBASE + '/get_default_stream');
        const data = await res.json();
        if (data.success) {
          currentChannel = data.channel;
          document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
          document.getElementById('player-mode-badge').innerText = data.mode;
          loadPlayerEmbed(currentChannel);
          updateTwitchChatFrame(currentChannel);
        }
      } catch (e) {}
    }

    function loadPlayerEmbed(channel) {
      const container = document.getElementById('video-container');
      const parentParam = PARENTDOMAINS.split(', ').join('&parent=');
      const iframeUrl = 'https://player.twitch.tv?channel=' + channel + '&parent=' + parentParam + '&theme=dark';
      container.innerHTML = '<iframe src="' + iframeUrl + '" width="100%" height="100%" frameborder="0" allowautoplay scrolling="no" style="border:none; width:100%; height:100%;"></iframe>';
      loadStreamInfo(channel);
    }

    function loadStreamInfo(channel) {
      fetch(APIBASE + '/stream_info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel })
      }).then(res => res.json()).then(data => {
        if (data.success && data.stream) {
          const title = (data.stream.title || 'Sans titre').substring(0, 40);
          const viewers = data.stream.viewer_count || 0;
          document.getElementById('current-channel-display').innerText = channel.toUpperCase() + ' - ' + title;
          document.getElementById('viewer-count').innerText = viewers.toLocaleString() + ' viewers';
        }
      }).catch(e => {});
    }

    function updateTwitchChatFrame(channel) {
      const parentParam = PARENTDOMAINS.split(', ').join('&parent=');
      const url = 'https://www.twitch.tv/embed/' + channel + '/chat?parent=' + parentParam + '&theme=dark&popout';
      document.getElementById('twitch-chat-frame').src = url;
    }

    async function cycle(dir) {
      try {
        const res = await fetch(APIBASE + '/cycle_stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ direction: dir })
        });
        const data = await res.json();
        if (data.success) {
          currentChannel = data.channel;
          document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
          document.getElementById('viewer-count').innerText = '-- viewers';
          loadPlayerEmbed(currentChannel);
          updateTwitchChatFrame(currentChannel);
        }
      } catch (e) {}
    }

    function cyclePrev() { cycle('prev'); }
    function cycleNext() { cycle('next'); }

    // CAROUSEL
    function initCarouselScroll() {
      const el = document.getElementById('carousel');
      el.addEventListener('wheel', evt => {
        evt.preventDefault();
        el.scrollLeft += evt.deltaY;
      });
    }

    async function loadFollowed() {
      const el = document.getElementById('carousel');
      el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-00f2ea"></i></div>';
      try {
        const res = await fetch(APIBASE + '/followed_streams');
        const data = await res.json();
        if (data.success && data.streams.length) {
          el.innerHTML = '';
          data.streams.forEach(s => {
            const thumb = s.thumbnail_url.replace('{width}', '400').replace('{height}', '225');
            el.innerHTML += '<div class="stream-card flex-shrink-0" onclick="changeChannel(\'' + s.user_login + '\')">' +
              '<img src="' + thumb + '" class="card-img" onerror="this.src=\'https://via.placeholder.com/400x225\'">' +
              '<div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">' +
              '<div class="font-bold text-white text-sm truncate">' + s.user_name + '</div></div>' +
              '<div class="absolute top-2 right-2 bg-red-600 text-white text-10px font-bold px-1 rounded">LIVE</div></div>';
          });
        } else {
          el.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Aucun live</div>';
        }
      } catch (e) {
        el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur</div>';
      }
    }

    function changeChannel(channel) {
      currentChannel = channel;
      document.getElementById('current-channel-display').innerText = channel.toUpperCase();
      document.getElementById('viewer-count').innerText = '-- viewers';
      loadPlayerEmbed(channel);
      updateTwitchChatFrame(channel);
    }

    // TABS
    function openTab(id) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + id).classList.add('active');
      event.target.classList.add('active');
    }

    function toggleChatMode(mode) {
      const twitch = document.getElementById('chat-container-twitch');
      const hub = document.getElementById('chat-container-hub');
      const btnTw = document.getElementById('btn-mode-twitch');
      const btnHb = document.getElementById('btn-mode-hub');
      if (mode === 'hub') {
        twitch.classList.add('hidden');
        hub.classList.remove('hidden');
        hub.classList.add('flex');
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-00f2ea text-black rounded';
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-1a1a1a text-gray-400 rounded hover:text-white';
      } else {
        hub.classList.add('hidden');
        hub.classList.remove('flex');
        twitch.classList.remove('hidden');
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-6441a5 text-white rounded';
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-1a1a1a text-gray-400 rounded hover:text-white';
      }
    }

    // SOCKET.IO
    function initSocket() {
      try {
        socket = io();
        socket.on('connect', () => {
          document.getElementById('socket-status').innerText = 'HUB SECURE';
          document.getElementById('socket-status').className = 'text-10px font-bold text-00f2ea border border-00f2ea px-2 rounded shadow-005px00f2ea';
        });
        socket.on('disconnect', () => {
          document.getElementById('socket-status').innerText = 'DISCONNECTED';
          document.getElementById('socket-status').className = 'text-10px font-bold text-red-500 border border-red-500 px-2 rounded';
        });
        socket.on('chat message', msg => {
          const box = document.getElementById('hub-messages');
          const user = msg.user || 'Anon';
          const text = msg.text || msg;
          box.innerHTML += '<div class="hub-msg"><strong class="text-00f2ea">' + user + '</strong> <span class="text-gray-300">' + text + '</span></div>';
          box.scrollTop = box.scrollHeight;
        });
      } catch (e) {}
    }

    function sendHubMessage(e) {
      e.preventDefault();
      const input = document.getElementById('hub-input');
      if (input.value) {
        if (socket) socket.emit('chat message', { user: currentUser || 'Anon', text: input.value });
        const box = document.getElementById('hub-messages');
        box.innerHTML += '<div class="hub-msg"><strong class="text-ff0099">' + (currentUser || 'Anon') + '</strong> <span class="text-gray-300">' + input.value + '</span></div>';
        box.scrollTop = box.scrollHeight;
        input.value = '';
      }
    }

    // STATS
    async function loadStatsDashboard() {
      try {
        const res = await fetch(APIBASE + '/api/stats/global');
        const data = await res.json();
        if (data.success) {
          document.getElementById('kpi-viewers').innerText = data.total_viewers.toLocaleString();
          document.getElementById('kpi-channels').innerText = data.total_channels;
          renderChart('chartViewers', 'line', data.history.live.labels, data.history.live.values, 'Viewers', '00f2ea');
        }
        const resGames = await fetch(APIBASE + '/api/stats/top_games');
        const dGames = await resGames.json();
        const labels = dGames.games.map(g => g.name);
        const values = dGames.games.map((g, i) => i + 1 * 20);
        renderChart('chartGames', 'bar', labels.slice(0, 5), values.slice(0, 5), 'Popularité', 'ff0099');
        const resLang = await fetch(APIBASE + '/api/stats/languages');
        const dLang = await resLang.json();
        const lLabels = dLang.languages.map(l => l.name);
        const lValues = dLang.languages.map(l => l.percent);
        renderChart('chartLangs', 'doughnut', lLabels, lValues, 'Part', ['00f2ea', 'ff0099', 'ffd700', 'fff', '666']);
      } catch (e) {}
    }

    function renderChart(id, type, labels, data, label, color) {
      const ctx = document.getElementById(id);
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      const bgColors = Array.isArray(color) ? color : (type === 'line' ? 'rgba(0, 242, 234, 0.1)' : color);
      const borderColors = Array.isArray(color) ? color : color;
      charts[id] = new Chart(ctx.getContext('2d'), {
        type: type,
        data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: bgColors, borderColor: borderColors, borderWidth: 1, fill: type === 'line', tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut', position: 'right', labels: { color: 'white', boxWidth: 10 } } }, scales: { x: { display: type !== 'doughnut', ticks: { color: '666' } }, y: { display: type !== 'doughnut', grid: { color: '222' }, ticks: { color: '666' } } } }
      });
    }

    // TOOLS
    async function runScan() {
      const q = document.getElementById('scan-query').value;
      if (!q) return;
      const box = document.getElementById('scan-res');
      box.classList.remove('hidden');
      document.getElementById('scan-ai').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse...';
      try {
        const res = await fetch(APIBASE + '/scan_target', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q })
        });
        const data = await res.json();
        if (data.success && data.user_data) {
          const u = data.user_data;
          document.getElementById('scan-name').innerText = u.display_name;
          document.getElementById('scan-game').innerText = u.game_name;
          document.getElementById('scan-img').src = u.profile_image_url;
          const ai = await fetch(APIBASE + '/critique_ia', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'niche', query: u.display_name })
          });
          const aiD = await ai.json();
          document.getElementById('scan-ai').innerHTML = aiD.html_response || 'Pas disponible';
        }
      } catch (e) {}
    }

    async function runRaid() {
      const game = document.getElementById('raid-game').value;
      const maxViewers = document.getElementById('raid-viewers').value;
      if (!game) return;
      document.getElementById('raid-res').classList.add('hidden');
      try {
        const res = await fetch(APIBASE + '/start_raid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ game, max_viewers: maxViewers })
        });
        const data = await res.json();
        if (data.success && data.target) {
          raidTarget = data.target;
          const box = document.getElementById('raid-res');
          box.classList.remove('hidden');
          document.getElementById('raid-img').src = data.target.thumbnail_url;
          document.getElementById('raid-info').innerHTML = '<p class="font-bold text-white">' + data.target.name + '</p><p>Viewers: ' + data.target.viewers + '</p><p>Jeu: ' + data.target.game + '</p>';
        }
      } catch (e) {}
    }

    function goToRaid() {
      if (raidTarget) window.open('https://twitch.tv/' + raidTarget.login, '_blank');
    }

    async function runBoost() {
      const c = document.getElementById('boost-query').value;
      if (!c) return;
      const res = await fetch(APIBASE + '/stream_boost', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel: c })
      });
      const d = await res.json();
      if (d.success) {
        document.getElementById('boost-msg').innerText = '✅ Boost Activé !';
        setTimeout(() => location.reload(), 2000);
      }
    }

    // ✅ CORRECTION 5: Fonction BEST TIME avec /analyze_schedule
    async function runBestTime() {
      const game = document.getElementById('besttime-game').value;
      if (!game) return;
      
      document.getElementById('besttime-loading').style.display = 'block';
      document.getElementById('besttime-result').classList.add('hidden');
      document.getElementById('besttime-res').classList.remove('hidden');
      
      try {
        const res = await fetch(APIBASE + '/analyze_schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ game })
        });
        const data = await res.json();
        
        if (data.success || data.html_response || data.full_analysis) {
          document.getElementById('besttime-loading').style.display = 'none';
          document.getElementById('besttime-result').innerHTML = data.html_response || data.full_analysis || 'Analyse indisponible';
          document.getElementById('besttime-result').classList.remove('hidden');
        }
      } catch (e) {
        document.getElementById('besttime-loading').innerHTML = '❌ Erreur analyse';
      }
    }

    window.addEventListener('message', (e) => {
      if (e.data?.auth_success) window.location.reload();
    });
  </script>
</body>
</html>
