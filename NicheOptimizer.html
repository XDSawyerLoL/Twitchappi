<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.2 - Full Features</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- VARIABLES CSS (Ajout des ombres n√©on) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-ai-action: #e34a64; 
            --color-text-dimmed: #9aa3a8;
            --color-text-white: #e0e0e0;
        }

        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text-white);
            font-family: 'Inter', sans-serif;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .h-screen-minus-header {
            height: calc(100vh - 64px); /* Si vous aviez un header de 64px */
            height: 100vh; /* Utilisons la pleine hauteur pour la d√©mo */
        }

        /* --- STYLES NEON (Ombres) --- */
        .shadow-neon-pink { box-shadow: 0 0 5px var(--color-primary-pink), 0 0 10px var(--color-primary-pink), 0 0 20px rgba(255, 0, 153, 0.4); }
        .shadow-neon-blue { box-shadow: 0 0 5px var(--color-secondary-blue), 0 0 10px var(--color-secondary-blue), 0 0 20px rgba(34, 199, 239, 0.4); }
        
        .tab-btn { color: var(--color-text-dimmed); background-color: var(--color-bg-medium); }
        .tab-btn.active { color: white; background-color: var(--color-primary-pink); font-weight: bold; }
        .tab-btn:hover { background-color: var(--color-bg-light); }
        .tab-btn.active:hover { background-color: var(--color-primary-pink); }
    </style>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
</head>
<body class="h-screen overflow-hidden">
    
    <header class="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center z-10">
        <h1 class="text-2xl font-orbitron text-primary-pink shadow-neon-pink">
            Stream Hub AI
        </h1>
        <div id="header-auth-status" class="text-sm text-gray-400">
            Connexion Twitch requise
        </div>
    </header>

    <div class="flex flex-col lg:flex-row h-screen-minus-header">

        <div class="lg:w-1/4 h-full lg:order-1 flex flex-col bg-gray-900 border-r border-gray-700">
            <div id="tab-nav-left" class="p-2 border-b border-gray-800 sticky top-0 bg-gray-900 z-10">
                <button id="tab-followed-btn" class="tab-btn w-full text-left p-2 rounded-lg font-bold bg-primary-pink text-white shadow-neon-pink transition-all" onclick="openTab('tab-followed')">
                    <i class="fas fa-stream mr-2"></i>Fil des Streamers Suivis
                </button>
            </div>
            <div id="tab-followed" class="tab-content flex-grow overflow-y-auto p-3" style="display:block;">
                <div id="auth-status" class="text-center p-4">
                    </div>
                <div id="followed-streams-box" class="space-y-3">
                    </div>
            </div>
        </div>

        <div class="lg:w-3/4 h-full lg:order-2 flex flex-col">
            
            <div id="tab-nav-top" class="flex flex-wrap p-2 bg-gray-900 border-b border-gray-700 space-x-2 sticky top-0 z-10">
                
                <button id="tab-niche-scan-btn" class="tab-btn p-2 rounded-lg text-sm transition-colors" onclick="openTab('tab-niche-scan')">
                    <i class="fas fa-search mr-1"></i>Analyse de Niche & R√©sultats
                </button>
                
                <button id="tab-disruption-btn" class="tab-btn p-2 rounded-lg text-sm transition-colors" onclick="openTab('tab-disruption')">
                    <i class="fas fa-wave-square mr-1"></i>Disruption & Export M√©triques
                </button>
                
                <button id="tab-raid-btn" class="tab-btn p-2 rounded-lg text-sm transition-colors" onclick="openTab('tab-raid')">
                    <i class="fas fa-crosshairs mr-1"></i>Raid Al√©atoire
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto flex flex-col">
                
                <div id="top-content-area" class="p-4 bg-gray-800 flex-shrink-0">
                    
                    <div id="tab-niche-scan" class="tab-content hidden space-y-4">
                        <h3 class="text-xl font-orbitron text-ai-niche shadow-neon-blue inline-block">Analyse de Niche</h3>
                        <div id="niche-scan-form" class="bg-gray-700 p-4 rounded-lg space-y-3">
                            <label for="target-channel" class="block text-sm font-medium text-gray-300">Cha√Æne Cible (optionnel) :</label>
                            <input type="text" id="target-channel" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-primary-pink focus:border-primary-pink" placeholder="Nom de la cha√Æne ou VOD URL">
                            
                            <label for="niche-context" class="block text-sm font-medium text-gray-300 mt-3">Contexte de Niche :</label>
                            <textarea id="niche-context" rows="3" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-primary-pink focus:border-primary-pink" placeholder="Ex: 'Comment cette cha√Æne pourrait optimiser sa pr√©sence sur les jeux de r√¥le ind√©s ?'"></textarea>
                            
                            <button id="start-niche-scan-btn" class="mt-4 w-full p-3 rounded-lg font-bold bg-ai-niche text-gray-900 transition-all hover:bg-green-400 disabled:opacity-50" onclick="handleAutoAction(this, 'niche_scan')">
                                <i class="fas fa-brain mr-2"></i>Lancer l'Analyse et obtenir le Rapport
                            </button>
                        </div>
                    </div>

                    <div id="tab-disruption" class="tab-content hidden space-y-4">
                        <h3 class="text-xl font-orbitron text-ai-repurpose shadow-neon-blue inline-block">Analyse de Disruption & Export</h3>
                        <div id="disruption-form" class="bg-gray-700 p-4 rounded-lg space-y-3">
                            <label for="vod-url-disruption" class="block text-sm font-medium text-gray-300">VOD URL (Twitch/YouTube) :</label>
                            <input type="text" id="vod-url-disruption" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-primary-pink focus:border-primary-pink" placeholder="Lien vers la VOD pour l'analyse de points de disruption">
                            
                            <label for="disruption-context" class="block text-sm font-medium text-gray-300 mt-3">Objectif d'Export :</label>
                            <textarea id="disruption-context" rows="3" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-primary-pink focus:border-primary-pink" placeholder="Ex: 'Identifier les 3 meilleurs clips de moins de 60 secondes pour TikTok. Sortir le timing et le th√®me.'"></textarea>
                            
                            <button id="start-disruption-btn" class="mt-4 w-full p-3 rounded-lg font-bold bg-ai-repurpose text-gray-900 transition-all hover:bg-purple-400 disabled:opacity-50" onclick="handleAutoAction(this, 'disruption_scan')">
                                <i class="fas fa-cut mr-2"></i>Lancer l'Analyse Disruption & Export M√©triques
                            </button>
                        </div>
                    </div>
                    
                    <div id="tab-raid" class="tab-content hidden space-y-4">
                        <h3 class="text-xl font-orbitron text-secondary-blue shadow-neon-blue inline-block">Configuration du Raid Al√©atoire</h3>
                        <div id="raid-form" class="bg-gray-700 p-4 rounded-lg space-y-3">
                            </div>
                    </div>
                </div>
                
                <div id="twitch-player-container" class="w-full relative aspect-video bg-black flex-shrink-0">
                    <div id="twitch-embed" class="w-full h-full"></div>
                </div>

                <div id="ia-report-area" class="p-4 bg-gray-900 border-t border-gray-700 flex-grow overflow-y-auto">
                    <h3 class="text-lg font-orbitron text-white mb-2">R√©sultats d'Analyse / Rapport IA</h3>
                    <div id="ia-result-box" class="bg-gray-800 p-4 rounded-lg min-h-[100px] text-gray-300 space-y-4">
                        Cliquez sur un onglet d'analyse (Niche ou Disruption) pour commencer, ou d√©marrez un raid !
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    // --- VARIABLES GLOBALES ---
    const DEFAULT_CHANNEL = 'twitch'; // Cha√Æne par d√©faut
    let activePlayer = null;
    const DEFAULT_PLAYER_WIDTH = '100%';
    const DEFAULT_PLAYER_HEIGHT = '100%';

    // --- 1. GESTION DU LECTEUR TWITCH ---
    window.launchPlayer = function(channel) {
        if (!channel || channel === 'undefined' || channel === 'null') {
            channel = DEFAULT_CHANNEL;
        }

        if (activePlayer) {
            activePlayer.setChannel(channel);
        } else {
            activePlayer = new Twitch.Embed("twitch-embed", {
                width: DEFAULT_PLAYER_WIDTH,
                height: DEFAULT_PLAYER_HEIGHT,
                channel: channel,
                layout: "video-with-chat",
                theme: "dark",
                parent: ["localhost", window.location.hostname]
            });
        }
        localStorage.setItem('activeChannel', channel);
        document.getElementById('current-channel-name').textContent = channel;
    };
    
    // --- 2. GESTION DES ONGLETS ---
    window.openTab = function(tabId) {
        // Cache tous les contenus d'onglets
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });

        // D√©sactive tous les boutons d'onglets
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-primary-pink', 'text-white');
            btn.classList.add('bg-gray-700', 'text-gray-400'); // Style inactif
        });
        
        // Affiche l'onglet s√©lectionn√©
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.style.display = 'block';
        }

        // Active le bouton correspondant
        const selectedBtn = document.getElementById(tabId + '-btn');
        if (selectedBtn) {
            selectedBtn.classList.add('active', 'bg-primary-pink', 'text-white');
            selectedBtn.classList.remove('bg-gray-700', 'text-gray-400');
        }

        // Sauvegarde l'onglet actif (pour les onglets horizontaux)
        if (tabId !== 'tab-followed') {
            localStorage.setItem('activeTab', tabId);
        }
    };

    // --- 3. GESTION DE L'AUTHENTIFICATION TWITCH ---
    window.checkAuth = async function() {
        const authStatusDiv = document.getElementById('auth-status');
        const headerStatusDiv = document.getElementById('header-auth-status');

        try {
            const response = await fetch('/twitch_auth_check');
            const data = await response.json();

            if (data.is_authenticated) {
                authStatusDiv.innerHTML = `<p class="text-ai-niche font-bold">‚úÖ Connect√© : ${data.user_name}</p><button onclick="window.location.href='/followed_streams';" class="mt-2 w-full p-2 rounded-lg font-bold bg-primary-pink text-white shadow-neon-pink transition-all hover:bg-pink-600">Actualiser les Streams Suivis</button>`;
                headerStatusDiv.innerHTML = `<span class="text-ai-niche font-bold">Connect√© : ${data.user_name}</span>`;
                fetchFollowedStreams();
            } else {
                authStatusDiv.innerHTML = `<p class="text-red-400 font-bold">‚ùå D√©connect√©</p><a href="/twitch_auth_start" class="mt-2 w-full inline-block text-center p-2 rounded-lg font-bold bg-secondary-blue text-gray-900 shadow-neon-blue transition-all hover:bg-cyan-400">Connexion Twitch</a>`;
                headerStatusDiv.innerHTML = `<a href="/twitch_auth_start" class="text-secondary-blue font-bold">Se connecter √† Twitch</a>`;
            }
        } catch (e) {
            authStatusDiv.innerHTML = `<p class="text-red-400 font-bold">‚ùå Erreur de connexion au serveur.</p>`;
            headerStatusDiv.innerHTML = `<span class="text-red-400">Erreur de serveur</span>`;
        }
    };

    // --- 4. R√âCUP√âRATION DES STREAMS SUIVIS ---
    window.fetchFollowedStreams = async function() {
        const streamsBox = document.getElementById('followed-streams-box');
        streamsBox.innerHTML = `<p class="text-yellow-400 text-center"><i class="fas fa-circle-notch fa-spin mr-2"></i>Chargement des streams...</p>`;

        try {
            const response = await fetch('/followed_streams');
            const data = await response.json();

            if (data.error) {
                streamsBox.innerHTML = `<p class="text-red-400 font-bold text-center">‚ùå Erreur de chargement du fil: ${data.error}</p>`;
                return;
            }

            if (data.streams.length === 0) {
                streamsBox.innerHTML = `<p class="text-gray-400 text-center">Aucun streamer suivi en ligne. üò¥</p>`;
                return;
            }

            streamsBox.innerHTML = data.streams.map(stream => `
                <div class="stream-card p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" onclick="window.launchPlayer('${stream.user_login}')">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white text-sm truncate">${stream.user_name}</span>
                        <span class="text-xs text-primary-pink font-bold ml-2"><i class="fas fa-eye mr-1"></i>${stream.viewer_count.toLocaleString()}</span>
                    </div>
                    <p class="text-xs text-gray-400 truncate mt-1">${stream.title}</p>
                    <p class="text-xs text-secondary-blue font-medium mt-1">${stream.game_name}</p>
                </div>
            `).join('');

        } catch (e) {
            streamsBox.innerHTML = `<p class="text-red-400 font-bold text-center">‚ùå Erreur de connexion au serveur.</p>`;
        }
    };

    // --- 5. GESTION DES ACTIONS IA (Niche Scan / Disruption Scan) ---
    window.handleAutoAction = async function(btn, actionType) {
        btn.disabled = true;
        const resultBox = document.getElementById('ia-result-box');
        const isNiche = actionType === 'niche_scan';
        
        const channelInput = isNiche ? document.getElementById('target-channel').value.trim() : null;
        const contextInput = isNiche ? document.getElementById('niche-context').value.trim() : document.getElementById('disruption-context').value.trim();
        const vodUrl = isNiche ? null : document.getElementById('vod-url-disruption').value.trim();

        const channel = channelInput || localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;

        if (!contextInput) {
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Veuillez fournir un contexte pour l'analyse.</p>`;
            btn.disabled = false;
            return;
        }

        const actionName = isNiche ? "Analyse de Niche" : "Analyse de Disruption";
        resultBox.innerHTML = `<p class="text-yellow-400 font-bold text-center"><i class="fas fa-circle-notch fa-spin mr-2"></i>Lancement de l'${actionName} pour la cha√Æne ${channel}...</p>`;

        try {
            const response = await fetch('/auto_action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action_type: actionType, 
                    channel: channel, 
                    context: contextInput,
                    vod_url: vodUrl 
                })
            });

            const data = await response.json();

            if (data.success) {
                // Affiche la r√©ponse IA brute
                let outputHtml = `
                    <div class="ia-report-header border-b border-gray-700 pb-2 mb-4">
                        <h4 class="text-xl font-orbitron text-white">${actionName} pour ${channel}</h4>
                        <p class="text-gray-400 text-sm">Action effectu√©e le ${new Date().toLocaleTimeString()} ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div class="ia-html-response">${data.html_response}</div>
                `;

                // Ajoute le bloc de m√©triques si pr√©sent (pour la Disruption/Export)
                if (data.metrics && data.metrics.length > 0) {
                    const metricsHtml = data.metrics.map(m => `
                        <div class="bg-gray-700 p-3 rounded-lg border-l-4 border-ai-repurpose">
                            <p class="font-bold text-ai-repurpose">${m.title}</p>
                            <p class="text-sm text-white">${m.value}</p>
                        </div>
                    `).join('');
                    outputHtml += `<div class="mt-6 space-y-3"><h4 class="font-bold text-secondary-blue border-b border-gray-700 pb-1">üìä M√©triques/Exports Intelligents</h4>${metricsHtml}</div>`;
                }
                
                resultBox.innerHTML = outputHtml;

            } else {
                resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur lors de l'action IA: ${data.error}</p>`;
            }
        } catch (e) {
            let errorMessage = e.message;
            if (errorMessage.includes("JSON")) {
                errorMessage = "Le serveur n'a pas renvoy√© de donn√©es JSON. L'API est probablement HS.";
            } else if (errorMessage.includes("Failed to fetch")) {
                errorMessage = "√âchec de la connexion au serveur (r√©seau coup√© ou API non d√©marr√©e).";
            }
            
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur: ${errorMessage}</p>`;
        } finally {
            btn.disabled = false;
        }
    };
    
    // --- 6. Logique du RAID AL√âATOIRE (Nouveaut√©) ---
    function setupRaidForm() {
        const raidFormDiv = document.getElementById('raid-form');
        raidFormDiv.innerHTML = `
            <label for="raid-category" class="block text-sm font-medium text-gray-300">Cat√©gorie de Stream :</label>
            <input type="text" id="raid-category" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-secondary-blue focus:border-secondary-blue" placeholder="Ex: Just Chatting ou League of Legends">
            
            <label for="raid-min-viewers" class="block text-sm font-medium text-gray-300 mt-3">Spectateurs Min. (0) :</label>
            <input type="number" id="raid-min-viewers" value="0" min="0" max="1000" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white">
            
            <label for="raid-max-viewers" class="block text-sm font-medium text-gray-300 mt-3">Spectateurs Max. (100) :</label>
            <input type="number" id="raid-max-viewers" value="100" min="1" max="1000" class="w-full p-2 rounded-lg bg-gray-600 border border-gray-500 text-white">
            
            <button id="find-raid-btn" class="mt-4 w-full p-3 rounded-lg font-bold bg-secondary-blue text-gray-900 shadow-neon-blue transition-all hover:bg-cyan-400 disabled:opacity-50" onclick="findRaidTarget(this)">
                <i class="fas fa-search-location mr-2"></i>Chercher une Cible de Raid Al√©atoire
            </button>
            <div id="raid-result-output" class="mt-4 text-sm text-gray-300"></div>
        `;
    }

    async function findRaidTarget(btn) {
        btn.disabled = true;
        const category = document.getElementById('raid-category').value.trim();
        const minViewers = document.getElementById('raid-min-viewers').value;
        const maxViewers = document.getElementById('raid-max-viewers').value;
        const resultOutput = document.getElementById('raid-result-output');

        if (!category) {
            resultOutput.innerHTML = `<p style="color:#e34a64;">‚ùå Veuillez sp√©cifier une cat√©gorie.</p>`;
            btn.disabled = false;
            return;
        }

        if (parseInt(minViewers) >= parseInt(maxViewers)) {
            resultOutput.innerHTML = `<p style="color:#e34a64;">‚ùå Le minimum doit √™tre inf√©rieur au maximum.</p>`;
            btn.disabled = false;
            return;
        }

        resultOutput.innerHTML = `<p class="text-yellow-400"><i class="fas fa-circle-notch fa-spin mr-2"></i>Recherche d'un streamer...</p>`;

        try {
            const response = await fetch('/raid_target', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, minViewers: minViewers || 0, maxViewers: maxViewers || 100 })
            });

            const data = await response.json();

            if (data.success && data.streamer) {
                const streamer = data.streamer;
                // Lance imm√©diatement le joueur pour pr√©visualiser la cible
                window.launchPlayer(streamer.user_login); 
                resultOutput.innerHTML = `
                    <p class="text-lg font-bold text-secondary-blue"><i class="fas fa-bullhorn mr-2"></i>Cible trouv√©e !</p>
                    <p class="text-white">Cha√Æne: <span class="font-bold">${streamer.user_name}</span> (${streamer.viewer_count} spectateurs)</p>
                    <p class="text-gray-400 text-sm">Aper√ßu charg√© dans le lecteur. Lancez le raid manuellement sur Twitch.</p>
                    <a href="https://twitch.tv/${streamer.user_login}" target="_blank" class="mt-2 inline-block p-2 rounded-lg font-bold bg-primary-pink text-white shadow-neon-pink transition-all hover:bg-pink-600">
                        <i class="fas fa-external-link-alt mr-2"></i>Ouvrir la Cha√Æne Twitch
                    </a>
                `;
            } else {
                resultOutput.innerHTML = `<p style="color:#ffcc00;">‚ö†Ô∏è ${data.error || 'Aucun streamer trouv√© correspondant aux crit√®res.'}</p>`;
            }
        } catch (e) {
            resultOutput.innerHTML = `<p style="color:#e34a64;">‚ùå Erreur de connexion au serveur.</p>`;
        } finally {
            btn.disabled = false;
        }
    }

    // --- 7. Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        window.launchPlayer(lastChannel); 

        // Initialise le bon onglet horizontal (par d√©faut, niche scan)
        const savedTab = localStorage.getItem('activeTab') || 'tab-niche-scan'; 
        openTab('tab-followed'); // Garde le fil en display:block initialement
        openTab(savedTab);       // Active le bon onglet sup√©rieur
        
        checkAuth();
        setupRaidForm(); // Initialise le formulaire de raid
        
        // --- 8. √âcouteur des Nouveaux Boutons de Partage du Player --- (Logiciel existante)
        // ... (Votre logique de partage si elle est pr√©sente) ...
    });
</script>
</body>
</html>
