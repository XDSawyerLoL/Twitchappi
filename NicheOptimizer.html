<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.2 - Full Features</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <style>
        /* --- VARIABLES CSS (Ajout des ombres n√©on) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert pour Niche */
            --color-ai-repurpose: #9933ff; /* Violet pour Repurpose */
            --color-ai-growth: #ffcc00; /* Jaune pour Trend */
            --color-ai-action: #e34a64; /* Rouge pour Action/Erreur */
            --color-text-dimmed: #9aa3a8;
        }

        body {
            background-color: var(--color-bg-dark);
            font-family: 'Inter', sans-serif;
        }
        
        /* Titre principal et √©l√©ments futuristes */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Ombres N√©on */
        .shadow-neon-pink { box-shadow: 0 0 5px var(--color-primary-pink), 0 0 10px var(--color-primary-pink); }
        .shadow-neon-blue { box-shadow: 0 0 5px var(--color-secondary-blue), 0 0 10px var(--color-secondary-blue); }
        .shadow-neon-green { box-shadow: 0 0 5px var(--color-ai-niche), 0 0 10px var(--color-ai-niche); }
        .shadow-neon-yellow { box-shadow: 0 0 5px var(--color-ai-growth), 0 0 10px var(--color-ai-growth); }

        /* Couleur de texte des analyses */
        .text-pink-neon { color: var(--color-primary-pink); }
        .text-secondary-blue { color: var(--color-secondary-blue); }
        .text-ai-niche { color: var(--color-ai-niche); }
        .text-ai-repurpose { color: var(--color-ai-repurpose); }
        .text-ai-growth { color: var(--color-ai-growth); }
        .text-ai-action { color: var(--color-ai-action); }

        /* Style des boutons/liens pour les timestamps */
        .timestamp-link {
            display: inline-block;
            background-color: var(--color-ai-repurpose);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .timestamp-link:hover {
            background-color: #7f2ad0;
        }

        /* Styles sp√©cifiques pour le conteneur du tableau de bord */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="text-white min-h-screen">

    <header class="bg-gray-900 border-b border-gray-700 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-orbitron text-white">Streamer AI Hub <span class="text-pink-neon">V10.2</span></h1>
            <div id="auth-status">
                </div>
        </div>
    </header>

    <nav class="bg-gray-900 sticky top-0 z-10 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-4">
                <button class="tab-button text-white border-b-2 border-white py-3 px-3 transition" onclick="openTab('tab-home')">üè† Accueil/Profil</button>
                <button class="tab-button text-gray-400 hover:text-white py-3 px-3 transition" onclick="openTab('tab-niche')">üìä Niche Optimizer (IA)</button>
                <button class="tab-button text-gray-400 hover:text-white py-3 px-3 transition" onclick="openTab('tab-repurpose')">‚úÇÔ∏è Repurposing VOD (IA)</button>
                <button class="tab-button text-gray-400 hover:text-white py-3 px-3 transition" onclick="openTab('tab-followed')">üëÄ Mon Fil Suivi</button>
                <button class="tab-button text-gray-400 hover:text-white py-3 px-3 transition" onclick="openTab('tab-boost')">üöÄ Boost Raid</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="tab-home" class="tab-content">
            <h2 class="text-3xl font-orbitron text-secondary-blue mb-6">Tableau de Bord et Flux</h2>
            
            <div id="login-prompt" class="bg-gray-800 p-6 rounded-lg text-center shadow-neon-blue hidden">
                <p class="text-lg mb-4">Connectez-vous √† Twitch pour acc√©der aux statistiques de votre cha√Æne et aux fonctionnalit√©s personnalis√©es.</p>
                <button onclick="window.location.href='/twitch_auth_start'" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-purple-900/50 transition">
                    <i class="fab fa-twitch mr-2"></i> Connexion Twitch
                </button>
            </div>

            <div id="profile-info-display" class="dashboard-grid">
                <div class="col-span-1 space-y-6">
                    <div class="h-64 bg-black rounded-lg overflow-hidden shadow-neon-pink" id="twitch-player-container">
                         <p class="text-center p-4 text-gray-500">Lecteur Twitch (Charg√© apr√®s connexion/stats)</p>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-lg shadow-inner border border-gray-700">
                        <h3 class="text-lg font-semibold mb-2">Charger un Profil</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="profile-channel-name" value="" class="flex-grow bg-gray-700 border border-gray-600 p-2 rounded text-sm" placeholder="Nom de la cha√Æne">
                            <button onclick="loadProfileStats(document.getElementById('profile-channel-name').value)" class="bg-secondary-blue hover:bg-sky-500 p-2 rounded text-sm font-semibold">Charger</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-span-1 bg-gray-800 p-6 rounded-lg shadow-neon-blue border border-gray-700">
                    <h3 class="text-xl font-orbitron text-pink-neon mb-4">Statistiques de la Cha√Æne</h3>
                    </div>
            </div>
        </div>
        
        <div id="tab-niche" class="tab-content hidden">
            <h2 class="text-3xl font-orbitron text-ai-niche mb-6">Analyse de Niche Strat√©gique</h2>
            
            <form id="ai-analysis-form" class="bg-gray-800 p-6 rounded-lg shadow-neon-green mb-8 border border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-white">Sujet de l'Analyse</h3>
                <div class="flex space-x-4 mb-4">
                    <div class="flex items-center">
                        <input type="radio" id="type-niche" name="analysis_type" value="niche" checked class="form-radio text-ai-niche border-gray-600 focus:ring-ai-niche">
                        <label for="type-niche" class="ml-2 text-white">Jeu/Cat√©gorie</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="type-trend" name="analysis_type" value="trend" class="form-radio text-ai-niche border-gray-600 focus:ring-ai-niche">
                        <label for="type-trend" class="ml-2 text-white">Tendances Actuelles (Global)</label>
                    </div>
                </div>
                
                <input type="text" id="analysis_query" placeholder="Entrez le nom du jeu, du th√®me ou de la cat√©gorie..." class="w-full bg-gray-700 border border-gray-600 p-3 rounded text-lg mb-4 text-white" value="">
                
                <button type="submit" class="w-full bg-ai-niche hover:bg-opacity-90 text-gray-900 font-bold py-3 rounded-lg text-lg shadow-lg shadow-green-900/50 transition duration-300">
                    <i class="fas fa-brain mr-2"></i> Lancer l'Analyse Consolid√©e IA
                </button>
            </form>

            <div id="ai-report-result" class="text-center py-8 text-lg text-gray-500">
                Lancez une analyse pour voir le rapport ici.
            </div>

            <div id="ai-report-display" class="hidden">
                <div class="dashboard-grid">
                    
                    <div class="col-span-1 space-y-6">
                        
                        <div class="card bg-gray-800 p-6 rounded-lg shadow-neon-green border border-gray-700">
                            <h3 class="text-xl font-orbitron mb-4 text-ai-niche">Score d'Opportunit√© IA (0-100)</h3>
                            <div class="relative flex justify-center items-center h-48">
                                <canvas id="nicheScoreGauge" class="w-full h-full"></canvas>
                                <div class="absolute inset-0 flex justify-center items-center">
                                    <span id="gauge-score-text" class="text-5xl font-bold font-orbitron">--</span>
                                </div>
                            </div>
                            <div id="verdict-ia" class="text-center mt-4 p-2 bg-gray-900 rounded-lg">
                                <p class="text-lg text-white font-semibold">Chargement du verdict...</p>
                            </div>
                        </div>

                        <div class="card bg-gray-800 p-6 rounded-lg shadow-neon-pink border border-gray-700">
                            <h3 class="text-xl font-orbitron mb-2 text-pink-neon">üî• Titre Disruptif IA</h3>
                            <div id="disruptive-title-display" class="mt-4 p-3 bg-gray-900 rounded-lg border border-pink-neon/30">
                                <p class="text-xl font-orbitron text-white">...</p>
                                <span class="text-xs text-gray-500 mt-1">G√©n√©r√© par l'IA en une seule requ√™te.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-1 space-y-6">
                        
                        <div class="card bg-gray-800 p-6 rounded-lg shadow-neon-blue border border-gray-700">
                            <h3 class="text-xl font-semibold mb-4 text-secondary-blue">Points d'Attaque (Faiblesses des Concurrents)</h3>
                            <ul id="niche-strengths" class="space-y-2">
                                <li class="text-gray-500">Chargement...</li>
                            </ul>
                        </div>
                        
                        <div class="card bg-gray-800 p-6 rounded-lg shadow-neon-green border border-gray-700">
                            <h3 class="text-xl font-semibold mb-4 text-ai-niche">Id√©es de Contenu Unique pour D√©butants</h3>
                            <ul id="niche-ideas" class="space-y-2">
                                <li class="text-gray-500">Chargement...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <div id="tab-repurpose" class="tab-content hidden">
            <h2 class="text-3xl font-orbitron text-ai-repurpose mb-6">Outil de Repurposing Vid√©o IA</h2>

            <form id="ai-analysis-form-repurpose" class="bg-gray-800 p-6 rounded-lg shadow-neon-purple mb-8 border border-gray-700" onsubmit="event.preventDefault(); document.getElementById('type-repurpose').checked = true; document.getElementById('ai-analysis-form').dispatchEvent(new Event('submit'));">
                <h3 class="text-xl font-semibold mb-4 text-white">Analyser un Contenu R√©cent</h3>
                <div class="hidden">
                    <input type="radio" id="type-repurpose" name="analysis_type" value="repurpose" class="form-radio">
                </div>
                
                <input type="text" id="repurpose_query" placeholder="Collez le Titre de la VOD ou le Th√®me du Stream" class="w-full bg-gray-700 border border-gray-600 p-3 rounded text-lg mb-4 text-white">
                
                <button type="submit" class="w-full bg-ai-repurpose hover:bg-opacity-90 text-white font-bold py-3 rounded-lg text-lg shadow-lg shadow-purple-900/50 transition duration-300">
                    <i class="fas fa-cut mr-2"></i> G√©n√©rer les Meilleurs Moments (Clips)
                </button>
            </form>
            
            <div id="repurpose-section-display" class="bg-gray-900 p-6 rounded-lg shadow-neon-purple border border-gray-700">
                <p class="text-center text-gray-500">Le rapport de clips vid√©o viraux s'affichera ici apr√®s analyse.</p>
            </div>
            
            <p class="text-center text-sm text-gray-600 mt-4">Remarque: Pour une VOD sp√©cifique, utilisez le titre de votre VOD comme requ√™te pour une analyse plus pr√©cise.</p>

        </div>
        
        <div id="tab-followed" class="tab-content hidden">
            <h2 class="text-3xl font-orbitron text-white mb-6">Streams Suivis en Direct</h2>
            <div class="bg-gray-800 p-6 rounded-lg shadow-neon-blue border border-gray-700">
                <button onclick="loadFollowedStreams()" class="bg-secondary-blue hover:bg-sky-500 p-2 rounded text-sm font-semibold mb-4">Actualiser la Liste</button>
                <div id="followed-list-container">
                    <p class="text-center text-gray-500">Chargement des streams...</p>
                </div>
            </div>
        </div>
        
        <div id="tab-boost" class="tab-content hidden">
            <h2 class="text-3xl font-orbitron text-ai-action mb-6">Activation du Boost Raid (Trouver un Partenaire)</h2>
            <div class="bg-gray-800 p-6 rounded-lg shadow-neon-pink border border-gray-700">
                <p class="text-lg text-white mb-4">Utilisez le Boost pour trouver instantan√©ment un streamer en fin de live, dans votre niche (0-100 viewers), pour un raid efficace.</p>
                
                <button id="boost-button" onclick="runStreamBoost()" class="w-full bg-ai-action hover:bg-red-500 text-white font-bold py-3 rounded-lg text-lg shadow-lg shadow-red-900/50 transition duration-300">
                    <i class="fas fa-rocket mr-2"></i> ACTIVER LE BOOST MAINTENANT
                </button>
                
                <div id="boost-status" class="mt-6 p-4 bg-gray-900 rounded-lg border border-ai-action/30">
                    <p class="text-center text-gray-500">Le rapport de raid s'affichera ici.</p>
                </div>
            </div>
        </div>

        <div class="mt-12 pt-8 border-t border-gray-700">
            <h3 class="text-xl font-orbitron text-gray-500 mb-4">Mini-Assistant IA (Test de service)</h3>
            <div id="mini-assistant-response" class="p-3 bg-gray-900 rounded-lg text-sm text-gray-300 border border-gray-800">
                <p>Assistant d√©sactiv√© dans cette version pour minimiser les requ√™tes IA et se concentrer sur l'optimisation des quotas critiques.</p>
            </div>
        </div>

    </main>

    <footer class="bg-gray-900 mt-12 py-4 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-600">
            ¬© 2025 Streamer AI Hub. Propuls√© par Google Gemini & Twitch API.
        </div>
    </footer>

<script>
    // Variables globales
    const BACKEND_URL = ''; // Laisse vide pour utiliser le m√™me h√¥te
    const DEFAULT_CHANNEL = 'twitch'; // Cha√Æne par d√©faut si non connect√©

    let nicheChartInstance = null; // Instance Chart.js pour la jauge
    let currentVODTitle = ''; // Pour passer le titre VOD au repurposing

    // =========================================================
    // 1. GESTION DES ONGLETS & AFFICHAGE
    // =========================================================
    
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-b-2', 'border-white', 'text-white');
            btn.classList.add('text-gray-400', 'hover:text-white');
        });
        const activeBtn = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
        if (activeBtn) {
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('border-b-2', 'border-white', 'text-white');
        }
        localStorage.setItem('activeTab', tabName);
        
        if (tabName === 'tab-followed') loadFollowedStreams();
        
        // Synchroniser le champ de requ√™te entre Niche et Repurpose
        if (tabName === 'tab-niche') {
            document.getElementById('analysis_query').value = document.getElementById('repurpose_query').value;
        } else if (tabName === 'tab-repurpose') {
            document.getElementById('repurpose_query').value = document.getElementById('analysis_query').value;
        }
    }
    
    // =========================================================
    // 2. AUTHENTIFICATION TWITCH
    // =========================================================

    async function checkAuth() {
        const authElement = document.getElementById('auth-status');
        try {
            const response = await fetch(BACKEND_URL + '/twitch_user_status');
            const data = await response.json();

            if (data.is_connected) {
                authElement.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <img src="${data.profile_image_url}" class="w-8 h-8 rounded-full shadow-neon-blue">
                        <span class="text-sm font-semibold text-white">${data.display_name}</span>
                        <button onclick="logout()" class="ml-4 text-xs text-red-500 hover:text-red-400">D√©connexion</button>
                    </div>
                `;
                document.getElementById('profile-info-display').style.display = 'grid'; // Afficher la grille
                document.getElementById('login-prompt').classList.add('hidden');
                document.getElementById('profile-channel-name').value = data.username;
                loadProfileStats(data.username);
            } else {
                authElement.innerHTML = `
                    <button onclick="window.location.href='/twitch_auth_start'" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-purple-900/50 transition">
                        <i class="fab fa-twitch mr-2"></i> Connexion Twitch
                    </button>
                `;
                document.getElementById('profile-info-display').style.display = 'none'; // Cacher la grille
                document.getElementById('login-prompt').classList.remove('hidden');
            }
        } catch (e) {
            authElement.innerHTML = `<span class="text-red-500">Erreur r√©seau</span>`;
        }
    }

    async function logout() {
        await fetch(BACKEND_URL + '/twitch_logout', { method: 'POST' });
        checkAuth();
    }

    // =========================================================
    // 3. AFFICHAGE DES R√âSULTATS IA (CONSOLID√âS)
    // =========================================================
    
    /**
     * G√®re l'affichage des donn√©es IA consolid√©es (Niche ou Repurpose).
     * @param {object} data - Le JSON riche renvoy√© par le serveur.
     * @param {string} type - 'niche' ou 'repurpose'.
     */
    function displayConsolidatedAnalysis(data, type) {
        const score = data.score_niche;
        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        
        // --- 1. CONFIGURATION DE BASE ET DU VERDICT ---
        document.getElementById('verdict-ia').innerHTML = `
            <p class="text-xl text-white font-semibold mb-2">${data.verdict}</p>
            <p class="text-sm text-gray-400"><strong class="text-pink-neon">Persona Viewer:</strong> ${data.viewer_persona}</p>
        `;

        // --- 2. AFFICHAGE DU SCORE (JAUGE) ---
        const color = score < 30 ? '#ff0099' : (score < 70 ? '#ffcc00' : '#59d682');
        document.getElementById('gauge-score-text').textContent = score;
        document.getElementById('gauge-score-text').style.color = color;

        if (nicheChartInstance) {
            nicheChartInstance.destroy();
        }

        const ctx = document.getElementById('nicheScoreGauge').getContext('2d');
        nicheChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [color, 'rgba(255, 255, 255, 0.1)'],
                    borderWidth: 0
                }]
            },
            options: {
                rotation: 270, circumference: 180, cutout: '80%', responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
            }
        });
        
        // --- 3. POINTS FORTS & ID√âES DE CONTENU ---
        document.getElementById('niche-strengths').innerHTML = data.points_forts.map(p => 
            `<li class="flex items-start text-sm"><span class="text-pink-neon mr-2">‚úÖ</span>${p}</li>`
        ).join('');
        
        document.getElementById('niche-ideas').innerHTML = data.content_ideas.map(i => 
            `<li class="flex items-start text-sm"><span class="text-secondary-blue mr-2">üí°</span>${i}</li>`
        ).join('');

        // --- 4. TITRE DISRUPTIF ---
        document.getElementById('disruptive-title-display').innerHTML = `
            <p class="text-xl font-orbitron text-white">${data.disruptive_title}</p>
            <span class="text-xs text-gray-500 mt-1">G√©n√©r√© par l'IA en une seule requ√™te.</span>
        `;
        
        // --- 5. GESTION DES CLIPS (Si type:repurpose) ---
        const repurposeSection = document.getElementById('repurpose-section-display');
        
        if (type === 'repurpose' && data.viral_clips && data.viral_clips.length > 0) {
            let clipHTML = `
                <h3 class="text-lg font-bold text-ai-repurpose mb-3 border-b border-gray-700 pb-2">Clips Viraux Sugg√©r√©s pour "${currentVODTitle}"</h3>
                <ul class="space-y-3">
            `;
            data.viral_clips.forEach(clip => {
                clipHTML += `
                    <li class="bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-sm">
                        <p class="text-base font-semibold text-white mb-1">${clip.title}</p>
                        <p class="text-sm text-gray-400"><strong><span class="text-pink-neon">Est. Temps:</span> ${clip.time_guess}</strong></p>
                        <p class="text-xs text-gray-500 mt-1">${clip.reason}</p>
                        <button onclick="copyToClipboard('${clip.time_guess}')" class="timestamp-link bg-ai-repurpose hover:bg-opacity-80 mt-2">Copier le Timestamp</button>
                    </li>
                `;
            });
            clipHTML += '</ul>';
            repurposeSection.innerHTML = clipHTML;
        } else if (type === 'repurpose') {
             repurposeSection.innerHTML = `<p class="text-gray-500 text-center">Aucune suggestion de clip n'a pu √™tre g√©n√©r√©e pour cette VOD.</p>`;
        } else {
             // Si on vient d'une analyse Niche, on affiche le prompt de Repurpose
             repurposeSection.innerHTML = `<p class="text-center text-gray-500">Passez √† l'onglet "Repurposing VOD" pour analyser le contenu vid√©o.</p>`;
        }

        reportBox.classList.remove('hidden');
        resultBox.innerHTML = '';
        
        // Assurez-vous que l'onglet Repurpose utilise le m√™me affichage si c'est le cas
        if (type === 'repurpose') {
             document.getElementById('tab-niche').querySelector('#ai-report-display').innerHTML = reportBox.innerHTML;
        }
    }
    
    /**
     * G√®re l'affichage des r√©sultats de Tendance.
     * @param {object} data - Le JSON riche de Tendance.
     */
    function displayTrendAnalysis(data) {
        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        
        // On masque les cartes de niche/repurpose car le trend a un format diff√©rent
        reportBox.classList.add('hidden'); 
        
        resultBox.innerHTML = `
            <div class="p-6 rounded-lg bg-gray-900 border border-ai-growth shadow-neon-yellow">
                <h2 class="text-2xl font-orbitron text-ai-growth mb-4">üìà Analyse de Tendance IA</h2>
                <div class="space-y-4">
                    <p class="text-white text-lg"><strong class="text-ai-growth">Top Opportunit√©:</strong> ${data.top_opportunity}</p>
                    <p class="text-gray-400"><strong>Pourquoi :</strong> ${data.why}</p>
                    <p class="text-gray-400"><strong>Saturation:</strong> ${data.saturation_level}%</p>
                    
                    <h3 class="text-lg font-semibold text-white mt-4 border-t border-gray-700 pt-3">Jeux Sous le Radar</h3>
                    <ul class="list-disc list-inside text-gray-300 ml-4 space-y-1">
                        ${data.under_radar_games.map(g => `<li>${g}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    // =========================================================
    // 4. LOGIQUE D'APPEL SERVEUR
    // =========================================================

    /**
     * Lance l'analyse IA (Niche, Repurpose, ou Trend)
     */
    document.getElementById('ai-analysis-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const type = document.querySelector('input[name="analysis_type"]:checked').value;
        
        // S'assurer que Repurpose a le bon champ de texte
        let query;
        if (type === 'repurpose') {
            query = document.getElementById('repurpose_query').value.trim();
        } else {
             query = document.getElementById('analysis_query').value.trim();
        }
        
        // Synchronisation des valeurs des deux champs de texte
        document.getElementById('analysis_query').value = query;
        document.getElementById('repurpose_query').value = query;

        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        const btn = document.querySelector('#ai-analysis-form button[type="submit"]');

        if (type !== 'trend' && !query) {
            resultBox.innerHTML = '<p class="text-red-500 text-center">Veuillez entrer une requ√™te (jeu ou titre VOD).</p>';
            return;
        }
        
        if (type === 'repurpose') {
            currentVODTitle = query;
        }

        btn.disabled = true;
        resultBox.innerHTML = '<div class="text-center"><span class="text-lg text-ai-niche animate-pulse">Analyse IA consolid√©e en cours... üß†</span></div>';
        reportBox.classList.add('hidden'); 

        try {
            const response = await fetch(BACKEND_URL + '/critique_ia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, query })
            });

            const result = await response.json();

            if (result.success && result.data) {
                if (type === 'trend') {
                    displayTrendAnalysis(result.data);
                } else {
                    displayConsolidatedAnalysis(result.data, type);
                }
            } else {
                let errorMessage = result.error || 'Probl√®me inconnu.';
                if (response.status === 429) {
                    // Message d'erreur 429 consolid√©
                    errorMessage = `Code 429: Quota IA d√©pass√© (V√©rifiez la facturation/quota Google Cloud).`;
                } else if (response.status === 500 && errorMessage.includes("invalid character")) {
                     errorMessage = "Erreur serveur IA: L'IA n'a pas renvoy√© un format JSON valide.";
                } else if (errorMessage.includes("Failed to fetch")) {
                    errorMessage = "√âchec de la connexion au serveur (r√©seau coup√© ou serveur non d√©marr√©).";
                }
                
                resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur serveur IA: ${errorMessage}</p>`;
                reportBox.classList.add('hidden');
            }
        } catch (e) {
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur r√©seau: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });
    
    // Attacher la soumission du formulaire Repurpose au formulaire principal
    document.getElementById('ai-analysis-form-repurpose').addEventListener('submit', function(e) {
         e.preventDefault();
         document.getElementById('type-repurpose').checked = true;
         document.getElementById('analysis_query').value = document.getElementById('repurpose_query').value;
         document.getElementById('ai-analysis-form').dispatchEvent(new Event('submit'));
    });


    // =========================================================
    // 5. AUTRES FONCTIONS (Boost, Profile, etc.)
    // =========================================================

    async function runStreamBoost() {
        const status = document.getElementById('boost-status');
        status.innerHTML = '<p class="text-center text-ai-niche animate-pulse">Activation du Boost et recherche de Raid en cours...</p>';
        
        try {
            const response = await fetch(BACKEND_URL + '/stream_boost', { method: 'POST' });
            const result = await response.json();
            
            status.innerHTML = result.html_response;
            
            if(result.raidCandidate) {
                const c = result.raidCandidate;
                status.innerHTML += `<div class="p-3 rounded mt-3 bg-gray-800 border border-gray-700 shadow-neon-blue">
                    <p class="text-lg font-semibold text-white">Partenaire sugg√©r√© : ${c.user_name}</p>
                    <p class="text-sm text-gray-400">Viewers: ${c.viewer_count} | <a href="https://twitch.tv/${c.user_login}" target="_blank" class="text-secondary-blue hover:text-white">Voir la cha√Æne</a></p>
                    <button onclick="copyToClipboard('/raid ${c.user_login}')" class="bg-[#ff0099] hover:bg-opacity-80 text-white p-2 rounded mt-2 text-sm">Copier Commande de Raid</button>
                </div>`;
            }
            
        } catch (e) {
            status.innerHTML = `<p class="text-red-500 text-center">Erreur Boost: ${e.message}</p>`;
        }
    }
    
    async function loadProfileStats(username) {
        const display = document.getElementById('profile-info-display');
        display.classList.add('pointer-events-none', 'opacity-50'); // D√©sactiver pendant le chargement
        const defaultContent = display.innerHTML;
        display.innerHTML = '<p class="text-center p-8 text-gray-500">Chargement des statistiques...</p>';


        try {
            // Dans le contexte actuel, nous simulons l'appel de stats complexes non impl√©ment√© dans index.js
            // Ici, nous faisons simplement un appel de base pour l'avatar et le live status
            const userRes = await fetch(BACKEND_URL + `/scan_target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: username })
            });
            const userData = await userRes.json();
            
            if (userData.success && userData.type === 'user') {
                const user = userData.user_data;
                const stats = {
                    display_name: user.display_name,
                    avatar: user.profile_image_url,
                    broadcaster_type: user.description ? 'Partenaire/Affili√©' : 'Streamer Standard',
                    follower_count: 'N/A*', // Simul√© car n√©cessite un autre appel ou token sp√©cifique
                    view_count: 'N/A*',
                    sub_count: 'N/A*'
                };

                const playerContainer = document.getElementById('twitch-player-container');
                playerContainer.innerHTML = `<iframe src="https://player.twitch.tv/?channel=${username}&parent=${window.location.hostname}&muted=false&autoplay=true" height="100%" width="100%" allowfullscreen class="rounded-lg shadow-neon-blue"></iframe>`;
                
                display.innerHTML = `
                    <div class="col-span-1 space-y-6">
                        <div class="h-64 bg-black rounded-lg overflow-hidden shadow-neon-pink" id="twitch-player-container">
                            <iframe src="https://player.twitch.tv/?channel=${username}&parent=${window.location.hostname}&muted=false&autoplay=true" height="100%" width="100%" allowfullscreen class="rounded-lg shadow-neon-blue"></iframe>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-inner border border-gray-700">
                            <h3 class="text-lg font-semibold mb-2">Charger un Profil</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="profile-channel-name" value="${username}" class="flex-grow bg-gray-700 border border-gray-600 p-2 rounded text-sm" placeholder="Nom de la cha√Æne">
                                <button onclick="loadProfileStats(document.getElementById('profile-channel-name').value)" class="bg-secondary-blue hover:bg-sky-500 p-2 rounded text-sm font-semibold">Charger</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-1 bg-gray-800 p-6 rounded-lg shadow-neon-blue border border-gray-700">
                        <div class="flex items-center space-x-4 mb-4">
                            <img src="${stats.avatar}" class="w-16 h-16 rounded-full border-2 border-pink-neon shadow-neon-pink">
                            <div>
                                <h3 class="text-xl font-orbitron text-white">${stats.display_name}</h3>
                                <p class="text-sm text-gray-400">${stats.broadcaster_type}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-gray-900 rounded-lg">
                                <p class="text-xl font-bold text-pink-neon">12.5K*</p>
                                <p class="text-xs text-gray-400">Followers</p>
                            </div>
                            <div class="p-3 bg-gray-900 rounded-lg">
                                <p class="text-xl font-bold text-secondary-blue">240K*</p>
                                <p class="text-xs text-gray-400">Vues Totales</p>
                            </div>
                            <div class="p-3 bg-gray-900 rounded-lg">
                                <p class="text-xl font-bold text-ai-niche">65*</p>
                                <p class="text-xs text-gray-400">Subs</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-4">* Donn√©es simul√©es. Les m√©triques r√©elles n√©cessitent plus de permissions Twitch ou une API complexe.</p>
                    </div>
                `;
                
            } else {
                 display.innerHTML = defaultContent;
                 display.querySelector('.col-span-1:nth-child(2)').innerHTML = `<p class="text-red-500 text-center p-8">Cha√Æne '${username}' introuvable ou erreur de l'API Twitch.</p>`;
            }
        } catch (e) {
            display.innerHTML = `<p class="text-red-500 text-center p-8">Erreur de chargement des stats: ${e.message}</p>`;
        } finally {
            display.classList.remove('pointer-events-none', 'opacity-50');
        }
    }
    
    async function loadFollowedStreams() {
        const listContainer = document.getElementById('followed-list-container');
        listContainer.innerHTML = '<p class="text-center text-gray-500">Chargement des streams suivis...</p>';
        try {
             const response = await fetch(BACKEND_URL + '/followed_streams');
             const result = await response.json();
             
             if(result.success && result.streams.length > 0) {
                 let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                 result.streams.forEach(s => {
                     html += `
                        <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-3 border border-gray-700">
                            <img src="${s.thumbnail_url.replace('{width}', '100').replace('{height}', '56')}" class="w-20 h-11 object-cover rounded shadow-sm">
                            <div class="flex-grow min-w-0">
                                <p class="text-sm font-semibold text-white truncate">${s.user_name}</p>
                                <p class="text-xs text-gray-400 truncate">${s.title}</p>
                            </div>
                            <span class="text-xs text-red-500 font-bold flex-shrink-0"><i class="fas fa-eye mr-1"></i>${s.viewer_count}</span>
                        </div>
                     `;
                 });
                 html += '</div>';
                 listContainer.innerHTML = html;
             } else {
                 listContainer.innerHTML = '<p class="text-center text-gray-500">Aucun stream suivi en direct actuellement, ou non connect√©. Connectez-vous √† l\'onglet Accueil.</p>';
             }
        } catch (e) { listContainer.innerHTML = `<p class="text-red-500 text-center">Erreur: ${e.message}</p>`; }
    }
    
    // Utilitaires
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Commande ou Timestamp copi√©: ' + text);
        }).catch(err => {
            console.error('Erreur de copie: ', err);
            alert("Erreur de copie (navigateur non pris en charge).");
        });
    }

    // --- Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        // D√©tection de l'onglet actif ou Accueil par d√©faut
        const savedTab = localStorage.getItem('activeTab') || 'tab-home';
        openTab(savedTab);
        checkAuth();
        
        // Attacher l'√©v√©nement au bouton Boost
        document.getElementById('boost-button').addEventListener('click', runStreamBoost);
    });

</script>
</body>
</html>
