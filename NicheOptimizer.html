<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JustPlayer ‚Ä¢ Holographic Hub</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    /* ==========================
       Palette & reset
       Holographic futuriste : glow bleu / argent, glass
       ========================== */
    :root{
      --bg:#071019; /* tr√®s fonc√© */
      --panel: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --accent-blue: #5fe0ff;
      --accent-silver: #b6c7d6;
      --muted: #98a6b3;
      --success: #7ef0a6;
      --danger: #ff6b6b;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041019 0%, #071a2a 100%);font-family:"Inter",system-ui,Arial;color:#e9f3fb;-webkit-font-smoothing:antialiased;}
    a{text-decoration:none;color:inherit}

    /* Container */
    .wrap{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:1fr 420px;gap:18px;}
    @media(max-width:980px){ .wrap{grid-template-columns:1fr; padding:12px;} }

    /* Header */
    header.hdr{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo .title{font-family:'Orbitron',sans-serif;font-weight:700;color:var(--accent-blue);font-size:20px;letter-spacing:1px}
    .logo .sub{font-size:12px;color:var(--muted)}

    /* Panel (glass) */
    .panel{
      background:var(--panel);
      border:1px solid var(--glass-border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 30px rgba(3,20,30,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(8px) saturate(1.1);
    }

    /* Player area */
    .player{
      display:flex;flex-direction:column;gap:12px;
    }
    .player .meta{display:flex;align-items:center;gap:12px}
    .player .meta .status{
      margin-left:auto;font-size:13px;color:var(--muted);
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.02)
    }
    #twitch-embed{width:100%;height:460px;border-radius:10px;overflow:hidden;border:1px solid rgba(95,224,255,0.06);box-shadow:0 10px 40px rgba(42,190,255,0.06)}
    @media(max-width:640px){ #twitch-embed{height:300px} }

    /* Controls */
    .controls{display:flex;gap:8px}
    .controls input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf6ff}
    .btn{padding:10px 12px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent-blue),#8fe7ff);color:#022;box-shadow:0 6px 18px rgba(95,224,255,0.08)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Dashboard analytics */
    .dashboard{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .dash-card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);text-align:center}
    .dash-card h3{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .dash-card .value{font-size:20px;font-weight:700;color:var(--accent-blue)}

    /* IA result boxes */
    .ai-result{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);min-height:60px}
    .ai-loader{width:36px;height:36px;border-radius:50%;border:4px solid var(--accent-blue);border-top-color:transparent;margin:8px auto;animation:spin 0.8s linear infinite, pulse 1.4s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%{box-shadow:0 0 6px rgba(95,224,255,0.5)}50%{box-shadow:0 0 18px rgba(181,226,255,0.9)}100%{box-shadow:0 0 6px rgba(95,224,255,0.5)}}

    /* Floating IA assistant */
    .assistant {
      position:fixed; right:18px; bottom:18px; width:300px; max-width:92%;
      border-radius:12px; padding:12px; z-index:1200;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(95,224,255,0.08); box-shadow:0 8px 40px rgba(5,25,40,0.6);
      backdrop-filter: blur(10px);
    }
    .assistant .head{display:flex;align-items:center;gap:10px}
    .assistant .head .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-blue);box-shadow:0 0 8px rgba(95,224,255,0.8)}
    .assistant .messages{max-height:220px;overflow:auto;margin-top:8px;padding-right:6px}
    .assistant .msg{padding:8px;border-radius:8px;margin-bottom:8px;font-size:13px}
    .assistant .msg.user{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);text-align:right}
    .assistant .msg.ai{background:linear-gradient(90deg, rgba(95,224,255,0.06), rgba(181,226,255,0.03));border:1px solid rgba(95,224,255,0.08);color:#012}

    .assistant form{display:flex;gap:8px;margin-top:8px}
    .assistant input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf6ff}

    /* Small screens */
    @media(max-width:420px){
      .dashboard{grid-template-columns:repeat(2,1fr)}
      .assistant{right:8px;left:8px;width:auto}
    }
  </style>
</head>

<body>

  <header class="hdr" style="max-width:1200px;margin:0 auto;padding:12px 16px;">
    <div class="logo">
      <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#0ff 10%, #9ff 80%);display:flex;align-items:center;justify-content:center;color:#012;font-weight:800">JP</div>
      <div>
        <div class="title">JustPlayer ‚Ä¢ Holographic Hub</div>
        <div class="sub">Lecteur ‚Ä¢ Scan IA ‚Ä¢ Dashboard ‚Ä¢ Repurposing</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btn-open-assistant" class="btn btn-ghost">Assistant IA</button>
      <button id="btn-refresh" class="btn btn-ghost">‚ü≥ Refresh</button>
    </div>
  </header>

  <main class="wrap">
    <!-- LEFT: Player + Dashboard -->
    <section class="panel player">
      <div class="meta">
        <div style="font-weight:700">LECTEUR & CHAT</div>
        <div id="player-channel-status" class="status">Aucun channel</div>
      </div>

      <div id="twitch-embed"></div>

      <div class="controls" style="margin-top:4px">
        <input id="input-channel" placeholder="Entrez le nom de la cha√Æne Twitch (ex: gotaga)">
        <button id="btn-launch" class="btn btn-primary">‚ñ∂Ô∏è Charger</button>
        <button id="btn-random" class="btn btn-ghost">üé≤ Random</button>
      </div>

      <div class="dashboard" id="dashboard">
        <div class="dash-card">
          <h3>Viewers</h3><div id="dash-viewers" class="value">‚Äî</div>
        </div>
        <div class="dash-card">
          <h3>Jeu</h3><div id="dash-game" class="value">‚Äî</div>
        </div>
        <div class="dash-card">
          <h3>Titre</h3><div id="dash-title" class="value" style="font-size:14px">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Tools IA -->
    <aside class="panel">
      <h3 style="margin:0 0 10px;font-weight:700">Outils IA</h3>

      <div>
        <label style="font-size:13px;color:var(--muted)">Scan cible (Jeu/Pseudo)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="input-target" placeholder="ex: starfield ou gotaga">
          <button id="btn-scan" class="btn btn-primary">üéØ Scan</button>
        </div>
        <div id="scan-result" class="ai-result"></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div>
        <label style="font-size:13px;color:var(--muted)">Analyse de Niche</label>
        <textarea id="input-niche" rows="4" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)"></textarea>
        <button id="btn-niche" class="btn btn-primary" style="width:100%;margin-top:8px">üìà Analyser la niche</button>
        <div id="niche-result" class="ai-result"></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div>
        <label style="font-size:13px;color:var(--muted)">Repurposing (texte)</label>
        <textarea id="input-repurpose" rows="3" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)"></textarea>
        <button id="btn-repurpose" class="btn btn-primary" style="width:100%;margin-top:8px">‚ôªÔ∏è Repurposer</button>
        <div id="repurpose-result" class="ai-result"></div>
      </div>
    </aside>
  </main>

  <!-- Floating Assistant -->
  <div id="assistant" class="assistant" style="display:none">
    <div class="head"><div class="dot"></div><div style="font-weight:700">Mini IA ‚Ä¢ Live Assistant</div></div>
    <div class="messages" id="assistant-messages">
      <div class="msg ai">Salut ‚Äî je surveille le live et peux te donner id√©es & actions.</div>
    </div>
    <form id="assistant-form" style="margin-top:8px">
      <input id="assistant-input" placeholder="Demande: ex 'Id√©es pour la prochaine session'">
      <button class="btn btn-primary" type="submit">Envoyer</button>
    </form>
  </div>

  <script>
    /* ===========================
       Client JS : player, polling, IA calls
       =========================== */

    // Utilitaires
    const $ = id => document.getElementById(id);
    const API_BASE = ""; // relative -> Render will route to same host

    // Twitch embed init (auto load default)
    let currentChannel = localStorage.getItem('activeChannel') || 'twitch';
    let twitchEmbed = null;

    function launchPlayer(channel){
      if(!channel) return;
      currentChannel = channel.toLowerCase();
      localStorage.setItem('activeChannel', currentChannel);
      $('player-channel-status').textContent = `Chargement‚Ä¶ ${currentChannel}`;
      // remove previous embed
      document.getElementById('twitch-embed').innerHTML = '';
      twitchEmbed = new Twitch.Embed("twitch-embed", {
        width: "100%",
        height: "100%",
        channel: currentChannel,
        layout: "video-and-chat",
        autoplay: false,
        parent: [window.location.hostname, 'localhost', '127.0.0.1']
      });
    }

    // Launch initial
    window.addEventListener('DOMContentLoaded', ()=> {
      $('input-channel')?.value && null;
      $('input-channel')?.setAttribute('placeholder','Entrez le nom de la cha√Æne Twitch');
      launchPlayer(currentChannel);
    });

    // Buttons actions
    $('btn-launch').addEventListener('click', ()=>{
      const ch = $('input-channel').value.trim();
      if(ch) launchPlayer(ch);
    });
    $('btn-random').addEventListener('click', async ()=>{
      try{
        const r = await fetch('/random_small_streamer');
        if(r.ok){
          const d = await r.json();
          launchPlayer(d.username);
        } else alert('Impossible d\'obtenir un stream al√©atoire.');
      }catch(e){ console.error(e); alert('Erreur random'); }
    });

    // Dashboard polling & live_ping
    async function updateLiveStatus(){
      try{
        const channel = localStorage.getItem('activeChannel') || currentChannel;
        if(!channel) return;
        const r = await fetch(`/live_ping?channel=${encodeURIComponent(channel)}`);
        if(!r.ok) return;
        const data = await r.json();
        // update status
        if(data.live){
          $('player-channel-status').textContent = `üî¥ EN LIVE ‚Äî ${channel}`;
          $('dash-viewers').textContent = data.viewer_count || '‚Äî';
          $('dash-game').textContent = data.game_name || '‚Äî';
          $('dash-title').textContent = (data.title && data.title.length>36)? data.title.slice(0,36)+'‚Ä¶': (data.title||'‚Äî');
        } else {
          $('player-channel-status').textContent = `‚ö´ Offline ‚Äî ${channel}`;
          $('dash-viewers').textContent = '‚Äî';
          $('dash-game').textContent = '‚Äî';
          $('dash-title').textContent = '‚Äî';
        }
      }catch(e){
        // silent
      }
    }
    // start polling every 2s
    setInterval(updateLiveStatus, 2000);
    updateLiveStatus();

    // Helper to show loader and call API
    function showLoader(targetEl){
      targetEl.innerHTML = '<div class="ai-loader"></div>';
    }

    // Scan target
    $('btn-scan').addEventListener('click', async ()=>{
      const q = $('input-target').value.trim();
      if(!q) return alert('Saisis un jeu ou pseudo.');
      const resEl = $('scan-result');
      showLoader(resEl);
      try{
        const r = await fetch('/scan_target', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({target:q})});
        if(!r.ok){
          resEl.innerHTML = `<div style="color:var(--danger);text-align:center">Erreur ${r.status}</div>`;
          return;
        }
        const d = await r.json();
        // Format response simply
        if(d.type === 'game'){
          if(d.streams && d.streams.length){
            resEl.innerHTML = '<strong>Streams en direct</strong><ul>' + d.streams.map(s=>`<li>${s.user_name} ‚Äî ${s.viewer_count} spectateurs ‚Äî ${s.game_name}</li>`).join('') + '</ul>';
          } else {
            resEl.innerHTML = `<div style="text-align:center;color:var(--muted)">${d.message||'Aucun stream trouv√©'}</div>`;
          }
        } else if(d.type === 'user'){
          resEl.innerHTML = `<div><strong>${d.user_data.username}</strong><p>${d.user_data.title || 'Hors ligne'}</p></div>`;
        } else {
          resEl.innerHTML = `<pre style="white-space:pre-wrap">${JSON.stringify(d)}</pre>`;
        }
      }catch(e){
        resEl.innerHTML = `<div style="color:var(--danger)">Erreur r√©seau</div>`;
      }
    });

    // Niche analyse
    $('btn-niche').addEventListener('click', async ()=>{
      const txt = $('input-niche').value.trim();
      if(!txt) return alert('Entrez une description.');
      const resEl = $('niche-result');
      showLoader(resEl);
      try{
        const r = await fetch(`/niche_analyse?text=${encodeURIComponent(txt)}`);
        if(!r.ok) { resEl.innerHTML = `<div style="color:var(--danger)">Erreur ${r.status}</div>`; return; }
        const html = await r.text();
        resEl.innerHTML = html;
      }catch(e){
        resEl.innerHTML = `<div style="color:var(--danger)">Erreur</div>`;
      }
    });

    // Repurpose
    $('btn-repurpose').addEventListener('click', async ()=>{
      const txt = $('input-repurpose').value.trim();
      if(!txt) return alert('Colle le texte √† repurposer.');
      const resEl = $('repurpose-result');
      showLoader(resEl);
      try{
        const r = await fetch(`/repurpose?text=${encodeURIComponent(txt)}`);
        if(!r.ok) { resEl.innerHTML = `<div style="color:var(--danger)">Erreur ${r.status}</div>`; return; }
        const html = await r.text();
        resEl.innerHTML = html;
      }catch(e){
        resEl.innerHTML = `<div style="color:var(--danger)">Erreur</div>`;
      }
    });

    // Trend detector
    document.getElementById('btn-trend-detector')?.addEventListener('click', async ()=>{
      const resEl = $('trend-results') || document.createElement('div');
      if(!resEl.parentNode) { document.body.appendChild(resEl) }
      showLoader(resEl);
      try{
        const r = await fetch('/trend_detector');
        if(!r.ok){ resEl.innerHTML = `<div style="color:var(--danger)">Erreur ${r.status}</div>`; return; }
        resEl.innerHTML = await r.text();
      }catch(e){
        resEl.innerHTML = `<div style="color:var(--danger)">Erreur</div>`;
      }
    });

    // Assistant UI toggles + conversation
    const assistant = $('assistant');
    $('btn-open-assistant').addEventListener('click', ()=> {
      assistant.style.display = assistant.style.display === 'none' ? 'block' : 'none';
    });
    // Assistant form
    document.getElementById('assistant-form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const q = $('assistant-input').value.trim();
      if(!q) return;
      const msgs = $('assistant-messages');
      const userMsg = document.createElement('div'); userMsg.className='msg user'; userMsg.textContent=q; msgs.appendChild(userMsg);
      $('assistant-input').value='';
      const aiMsg = document.createElement('div'); aiMsg.className='msg ai'; aiMsg.innerHTML = '<div class="ai-loader" style="width:22px;height:22px;border-width:3px;margin:6px auto"></div>'; msgs.appendChild(aiMsg);
      msgs.scrollTop = msgs.scrollHeight;
      try{
        const r = await fetch('/critique_ia', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'assistant', prompt:q, channel: localStorage.getItem('activeChannel') })});
        if(!r.ok){ aiMsg.textContent = 'Erreur IA'; return; }
        const d = await r.json();
        aiMsg.className='msg ai'; aiMsg.textContent = d.text || (d.html_critique ? d.html_critique : 'R√©ponse IA');
        msgs.scrollTop = msgs.scrollHeight;
      }catch(e){
        aiMsg.textContent = 'Erreur r√©seau';
      }
    });

    // Refresh button
    $('btn-refresh').addEventListener('click', ()=> updateLiveStatus());
  </script>
</body>
</html>

