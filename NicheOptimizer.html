<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V6.9 - Ultimate</title>
    <link href="[https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap)" rel="stylesheet">
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <style>
        :root {
            --color-bg-dark: #0d0d0d; --color-bg-medium: #1a1a1a; --color-bg-light: #111;
            --color-primary-pink: #ff0099; --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; --color-ai-repurpose: #9933ff; --color-ai-growth: #ffcc00;
            --color-text-dimmed: #9aa3a8; --color-border-dark: #2e2e2e; --color-border-medium: #333;
        }
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { max-width: 1200px; margin: 20px auto; padding: 10px; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: var(--color-primary-pink); text-align: center; margin-bottom: 5px; }
        .h1-blue-accent { color: var(--color-secondary-blue); }
        .subtitle-center { color: var(--color-text-dimmed); font-size: 12px; margin-bottom: 15px; text-align: center; }
        
        /* Composants UI */
        .player-wrapper { padding: 15px; background: var(--color-bg-medium); border-radius: 12px; border: 1px solid var(--color-border-dark); margin-bottom: 20px; }
        .action-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-medium); background: var(--color-bg-dark); color: #fff; font-size: 13px; }
        .btn-primary { background: var(--color-primary-pink); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; transition: 0.2s; }
        .btn-primary:hover:not(:disabled) { background: #E6008A; transform: translateY(-1px); }
        .btn-secondary { background: var(--color-secondary-blue); color: #00161d; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        
        /* R√©sultats IA (Correction Listes) */
        .ai-result-box { background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 20px; margin-top: 15px; color: #fff; }
        .ai-result-box h4 { font-family: 'Orbitron', sans-serif; font-size: 16px; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid var(--color-border-medium); padding-bottom: 8px; color: var(--color-secondary-blue); }
        /* FORCE L'AFFICHAGE DES PUCES */
        .ai-content ul { list-style-type: disc !important; padding-left: 25px !important; margin-bottom: 15px; }
        .ai-content li { margin-bottom: 8px; line-height: 1.5; color: #e0e0e0; }
        .ai-content strong { color: #fff; font-weight: 700; }
        
        /* Onglets */
        .tab-btn { font-family: 'Orbitron', sans-serif; padding: 12px; background: var(--color-bg-light); border: 1px solid var(--color-border-medium); color: var(--color-text-dimmed); cursor: pointer; flex: 1; text-align: center; font-size: 12px; }
        .tab-btn.active { background: var(--color-bg-medium); color: #fff; border-top: 3px solid var(--color-primary-pink); font-weight: bold; }
        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid var(--color-border-dark); padding: 20px; }
        .tab-content.active { display: block; }

        /* Streams Suivis */
        #followed-streams-list { display: flex; flex-wrap: wrap; gap: 15px; }
        .followed-stream-item { width: calc(33.333% - 10px); background: var(--color-bg-light); border-radius: 8px; border: 1px solid var(--color-border-dark); cursor: pointer; overflow: hidden; transition: 0.2s; }
        .followed-stream-item:hover { border-color: var(--color-primary-pink); transform: translateY(-3px); }
        .streamer-avatar { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .stream-details { padding: 10px; }
        .stream-name { font-weight: bold; display: block; margin-bottom: 4px; }
        .stream-meta { font-size: 11px; color: var(--color-text-dimmed); }

        /* --- MINI ASSISTANT (Chatbot) --- */
        .assistant-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: linear-gradient(135deg, var(--color-secondary-blue), #0066cc);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 199, 239, 0.4);
            z-index: 1000; transition: transform 0.2s; border: none;
        }
        .assistant-btn:hover { transform: scale(1.1); }
        .assistant-panel {
            position: fixed; bottom: 90px; right: 20px;
            width: 350px; height: 500px;
            background: var(--color-bg-medium); border: 1px solid var(--color-secondary-blue);
            border-radius: 12px; display: none; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;
        }
        .assistant-header {
            padding: 15px; background: rgba(34, 199, 239, 0.1);
            border-bottom: 1px solid var(--color-border-dark);
            font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--color-secondary-blue);
            display: flex; justify-content: space-between; align-items: center;
        }
        .assistant-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 8px; font-size: 13px; line-height: 1.4; max-width: 85%; }
        .msg.user { align-self: flex-end; background: var(--color-primary-pink); color: white; border-bottom-right-radius: 0; }
        .msg.bot { align-self: flex-start; background: var(--color-bg-light); border: 1px solid var(--color-border-medium); border-bottom-left-radius: 0; }
        .msg.bot ul { list-style-type: disc; padding-left: 20px; margin-top: 5px; }
        .assistant-input-area { padding: 10px; border-top: 1px solid var(--color-border-dark); display: flex; gap: 8px; }
        
        @media (max-width: 768px) {
            .followed-stream-item { width: 100%; }
            #twitch-embed { height: 350px; }
            .assistant-panel { width: calc(100% - 40px); bottom: 90px; right: 20px; height: 400px; }
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl"><span class="h1-blue-accent">STREAMER</span> HUB V6.9</h1>
    <div class="subtitle-center">Lecteur ‚Ä¢ Scan & IA ‚Ä¢ Niche ‚Ä¢ Repurposing ‚Ä¢ Croissance</div>

    <div class="player-wrapper">
        <h2><span style="margin-right:6px;">üé¨</span> LECTEUR & CHAT <span id="player-channel-status"></span></h2> 
        <form id="form-channel-player" class="flex gap-2 mb-4">
            <input id="input-channel" type="text" placeholder="Cha√Æne Twitch (ex: gotaga)" class="action-input">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[80px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>
    </div>

    <div id="tabs-container">
        <div class="flex flex-wrap flex-tabs">
            <button class="tab-btn" onclick="openTab('tab-followed')">üîë MON FIL SUIVI</button> 
            <button class="tab-btn" onclick="openTab('tab-cible')">üéØ SCAN & RESULTATS</button>
            <button class="tab-btn" onclick="openTab('tab-niche')">üìà NICHE</button>
            <button class="tab-btn" onclick="openTab('tab-repurpose')">üöÄ REPURPOSE</button>
            <button class="tab-btn" onclick="openTab('tab-growth')">üí∞ CROISSANCE</button>
            <button class="tab-btn" onclick="openTab('tab-boost')">‚ö° BOOST</button>
        </div>

        <div id="tab-followed" class="tab-content">
            <h3 class="tab-heading text-pink">üîë Connexion & Mon Fil Suivi</h3>
            <div class="login-box mb-4">
                <p id="login-status" class="text-yellow text-xs mb-2">Statut: V√©rification...</p>
                <button id="btn-twitch-login" class="btn-primary w-full p-3 bg-[#6441a5]">üîí SE CONNECTER VIA TWITCH</button>
            </div>
            <div id="followed-streams-list"></div>
        </div>

        <div id="tab-cible" class="tab-content">
            <h3 class="tab-heading text-blue">üî≠ Scan Cible</h3>
            <form id="form-target" class="flex gap-2 mb-2">
                <input id="input-target" type="text" placeholder="Jeu ou Pseudo" class="action-input">
                <button type="submit" class="btn-secondary min-w-[80px]">üéØ CIBLER</button>
            </form>
            <div id="scan-result" class="ai-result-box" style="display:none;"></div>
        </div>

        <div id="tab-niche" class="tab-content">
            <h3 class="tab-heading text-green">üìà Analyse Niche</h3>
            <form id="form-niche-analysis" class="flex gap-2 mb-2">
                <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser" class="action-input">
                <button type="submit" class="btn-primary min-w-[120px]" style="background:var(--color-ai-niche);">‚ú® ANALYSER</button>
            </form>
            <div id="niche-results" class="ai-result-box ai-content" style="display:none; border-color:var(--color-ai-niche);"></div>
        </div>
        
        <div id="tab-repurpose" class="tab-content">
            <h3 class="tab-heading text-purple">‚úÇÔ∏è Repurposing IA</h3>
            <form id="form-repurpose" class="flex gap-2 mb-2">
                <input id="input-repurpose-channel" type="text" placeholder="Pseudo Streamer" class="action-input">
                <button type="submit" class="btn-primary p-3" style="background:var(--color-ai-repurpose);">üöÄ ANALYSER</button>
            </form>
            <div id="repurpose-results" class="ai-result-box ai-content" style="display:none; border-color:var(--color-ai-repurpose);"></div>
        </div>

        <div id="tab-growth" class="tab-content">
            <h3 class="tab-heading text-yellow">üí∞ Tendances</h3>
            <button id="btn-trend-detector" class="btn-primary w-full p-3" style="background:var(--color-ai-growth); color: #000;">üîÆ D√âTECTER LA PROCHAINE NICHE</button>
            <div id="trend-results" class="ai-result-box ai-content" style="display:none; border-color:var(--color-ai-growth); margin-top:15px;"></div>
        </div>

        <div id="tab-boost" class="tab-content">
            <h3 class="tab-heading text-pink">‚ö° Stream Boost</h3>
            <form id="form-boost" class="flex gap-2">
                <input id="input-boost" type="text" placeholder="Cha√Æne √† booster" class="action-input">
                <button type="submit" class="btn-primary min-w-[100px]">üì§ BOOST</button>
            </form>
            <div id="boost-results" class="ai-result-box ai-content" style="display:none; border-color:var(--color-primary-pink); margin-top:15px;"></div>
        </div>
    </div>
</div>

<button id="assistant-toggle" class="assistant-btn">ü§ñ</button>
<div id="assistant-panel" class="assistant-panel">
    <div class="assistant-header">
        <span>ASSISTANT IA</span>
        <span style="cursor:pointer;" onclick="toggleAssistant()">‚úñ</span>
    </div>
    <div id="assistant-messages" class="assistant-messages">
        <div class="msg bot">Salut ! Je suis ton assistant de poche. Pose-moi une question sur ton stream, un titre ou une id√©e de clip !</div>
    </div>
    <form id="assistant-form" class="assistant-input-area">
        <input id="assistant-input" type="text" placeholder="Ta question..." class="action-input" autocomplete="off">
        <button type="submit" class="btn-secondary">></button>
    </form>
</div>

<script src="[https://embed.twitch.tv/embed/v1.js](https://embed.twitch.tv/embed/v1.js)"></script>
<script>
    const API_BASE = window.location.origin;
    let embed = null;

    // --- ONGLETS ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        localStorage.setItem('activeTab', tabId);
    }

    // --- LECTEUR ---
    function launchPlayer(channel) {
        if (!channel) return;
        document.getElementById('twitch-embed').innerHTML = '';
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%", height: 550, channel: channel, layout: "video-and-chat", autoplay: true, parent: [window.location.hostname]
        });
    }
    document.getElementById('form-channel-player').addEventListener('submit', (e) => {
        e.preventDefault(); launchPlayer(document.getElementById('input-channel').value);
    });

    // --- AUTH & STREAMS ---
    const btnLogin = document.getElementById('btn-twitch-login');
    const followedList = document.getElementById('followed-streams-list');
    
    async function checkAuth() {
        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();
            if (data.is_connected) {
                document.getElementById('login-status').innerHTML = `‚úÖ Connect√©: <strong>${data.username}</strong>`;
                btnLogin.textContent = "D√âCONNEXION";
                btnLogin.onclick = () => fetch(`${API_BASE}/twitch_logout`, {method:'POST'}).then(() => window.location.reload());
                loadFollowedStreams();
            } else {
                btnLogin.onclick = () => window.location.href = `${API_BASE}/twitch_auth_start`;
            }
        } catch(e) { console.error(e); }
    }

    async function loadFollowedStreams() {
        followedList.innerHTML = '<p style="text-align:center;color:#888">Chargement...</p>';
        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const json = await res.json();
            if (json.data && json.data.length > 0) {
                followedList.innerHTML = json.data.map(s => `
                    <div class="followed-stream-item" onclick="launchPlayer('${s.user_name}')">
                        <img src="${s.thumbnail_url.replace('{width}', '320').replace('{height}', '180')}" class="streamer-avatar">
                        <div class="stream-details">
                            <span class="stream-name text-white font-bold">${s.user_name}</span>
                            <div class="stream-meta text-xs text-gray-400">üî¥ ${s.viewer_count} ‚Ä¢ ${s.game_name}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                followedList.innerHTML = '<p style="text-align:center">Aucun stream en ligne.</p>';
            }
        } catch(e) { followedList.innerHTML = '<p style="color:red">Erreur chargement streams.</p>'; }
    }

    // --- FONCTION G√âN√âRIQUE APPEL IA ---
    async function callAI(endpoint, body, resultId) {
        const box = document.getElementById(resultId);
        box.style.display = 'block';
        box.innerHTML = '<p style="text-align:center;color:#888">üß† L\'IA r√©fl√©chit...</p>';
        try {
            const res = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            const data = await res.json();
            if (data.html_critique || data.html_response) {
                box.innerHTML = data.html_critique || data.html_response;
            } else if (data.type === 'game' || data.type === 'user') {
                // Formatage simple pour le scan si pas de HTML pr√©-rendu
                box.innerHTML = `<pre style="white-space:pre-wrap;font-size:12px">${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                box.innerHTML = `<p style="color:red">Erreur: ${data.error || 'R√©ponse inconnue'}</p>`;
            }
        } catch(e) { box.innerHTML = `<p style="color:red">Erreur connexion: ${e.message}</p>`; }
    }

    // --- LISTENERS FORMULAIRES ---
    document.getElementById('form-target').addEventListener('submit', (e) => {
        e.preventDefault(); 
        const q = document.getElementById('input-target').value;
        const box = document.getElementById('scan-result');
        box.style.display = 'block';
        box.innerHTML = 'Scan en cours...';
        // Appel sp√©cifique pour le scan car le format de retour est diff√©rent
        fetch(`${API_BASE}/scan_target`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query: q}) })
        .then(r => r.json())
        .then(d => {
            if(d.type === 'game') {
                const g = d.game_data;
                box.innerHTML = `<h4 style="color:#22c7ef">Jeu : ${g.name}</h4><p>Viewers: ${g.total_viewers} | Streamers: ${g.total_streamers}</p><ul>${g.streams.map(s => `<li>${s.user_name} (${s.viewer_count})</li>`).join('')}</ul>`;
            } else if (d.type === 'user') {
                const u = d.user_data;
                box.innerHTML = `<div style="display:flex;gap:10px"><img src="${u.profile_image_url}" style="width:50px;border-radius:50%"><div><h4 style="margin:0">${u.display_name}</h4><p>${u.description}</p></div></div>`;
            } else {
                box.innerHTML = '<p>Rien trouv√©.</p>';
            }
        });
    });

    document.getElementById('form-niche-analysis').addEventListener('submit', (e) => {
        e.preventDefault(); callAI('/critique_ia', { type: 'niche', query: document.getElementById('input-niche-game').value }, 'niche-results');
    });

    document.getElementById('form-repurpose').addEventListener('submit', (e) => {
        e.preventDefault(); callAI('/critique_ia', { type: 'repurpose', query: document.getElementById('input-repurpose-channel').value }, 'repurpose-results');
    });

    document.getElementById('btn-trend-detector').addEventListener('click', () => {
        callAI('/critique_ia', { type: 'trend' }, 'trend-results');
    });

    document.getElementById('form-boost').addEventListener('submit', (e) => {
        e.preventDefault();
        const ch = document.getElementById('input-boost').value;
        fetch(`${API_BASE}/stream_boost`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({channel: ch}) })
        .then(r => r.json())
        .then(d => {
            const box = document.getElementById('boost-results');
            box.style.display = 'block';
            box.innerHTML = d.html_response || d.error;
            if(d.success) launchPlayer(ch);
        });
    });

    // --- MINI ASSISTANT LOGIC ---
    const assistantPanel = document.getElementById('assistant-panel');
    const assistantMsgs = document.getElementById('assistant-messages');
    
    function toggleAssistant() {
        assistantPanel.style.display = assistantPanel.style.display === 'flex' ? 'none' : 'flex';
    }
    document.getElementById('assistant-toggle').addEventListener('click', toggleAssistant);

    document.getElementById('assistant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('assistant-input');
        const q = input.value.trim();
        if (!q) return;

        // Ajout message user
        assistantMsgs.innerHTML += `<div class="msg user">${q}</div>`;
        input.value = '';
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;

        // Loader bot
        const loaderId = 'loader-' + Date.now();
        assistantMsgs.innerHTML += `<div id="${loaderId}" class="msg bot">...</div>`;

        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({q})
            });
            const data = await res.json();
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class="msg bot">${data.answer || "D√©sol√©, je n'ai pas compris."}</div>`;
        } catch(err) {
            document.getElementById(loaderId).innerHTML = "Erreur connexion.";
        }
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
    });

    // Init
    const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
    openTab(savedTab);
    checkAuth();
</script>
</body>
</html>
