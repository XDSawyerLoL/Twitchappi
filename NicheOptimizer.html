<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.2 - Full Features</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-action: #e34a64; 
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            
            /* OMBRES N√âON */
            --shadow-pink: 0 0 8px rgba(255, 0, 153, 0.4);
            --shadow-blue: 0 0 8px rgba(34, 199, 239, 0.4);
        }

        /* Styles Globaux */
        body { 
            background-color: var(--color-bg-dark); 
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
        }
        
        /* Conteneur principal (Centr√©) */
        .page-wrapper {
            max-width: 1300px; /* Augment√© l√©g√®rement pour plus d'espace */
            margin: 20px auto; 
            padding: 10px; 
        }

        /* Titres */
        h1 { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 32px; 
            color: var(--color-primary-pink); 
            margin-bottom: 5px; 
            text-align: center; 
            text-shadow: 0 0 5px var(--color-primary-pink), 0 0 15px rgba(255, 0, 153, 0.5);
        }
        .subtitle-center { 
            color: var(--color-text-dimmed); 
            font-size: 14px; 
            margin-bottom: 25px; 
            text-align: center; 
        }

        /* Conteneur des deux colonnes */
        #twitch-lucky-main {
            display: flex;
            gap: 20px;
            align-items: flex-start; /* Important pour que les colonnes ne s'√©tirent pas verticalement */
        }
        
        /* Colonne de Gauche (Fil) */
        #col-left {
            width: 250px; 
            flex-shrink: 0; 
        }
        
        /* Colonne de Droite (Outils/Lecteur) */
        #col-right-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Lecteur */
        .player-wrapper { 
            padding: 15px; 
            background: var(--color-bg-medium); 
            border-radius: 12px; 
            border: 1px solid var(--color-border-dark); 
            box-shadow: var(--shadow-blue);
        }
        .player-wrapper h2 { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 20px; 
            color: var(--color-secondary-blue); 
            margin: 0 0 10px; 
            display: flex; 
            align-items: center; 
            text-shadow: 0 0 4px var(--color-secondary-blue);
        }
        /* Hauteur ajust√©e pour le lecteur Twitch pour mieux s'adapter */
        #twitch-embed { width: 100%; height: 500px; border-radius: 8px; box-shadow: 0 0 15px rgba(34, 199, 239, 0.3); overflow: hidden; }

        /* Onglets (Boutons) - Style horizontal */
        .tab-btn-horizontal {
            background: var(--color-bg-medium);
            color: var(--color-text-dimmed);
            border: 1px solid var(--color-border-dark);
            border-bottom: none;
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 2px;
        }
        .tab-btn-horizontal.active {
            background: var(--color-bg-dark);
            color: var(--color-primary-pink);
            border-color: var(--color-primary-pink);
            border-bottom-color: var(--color-bg-dark); /* Donne l'effet d'√™tre sur la zone de contenu */
            box-shadow: var(--shadow-pink);
        }
        
        /* Contenu des Onglets Horizontaux */
        #tab-content-horizontal-container {
            background: var(--color-bg-dark);
            border: 1px solid var(--color-border-dark);
            border-radius: 0 6px 6px 6px;
            padding: 15px;
            margin-top: -1px; /* Jointure avec les onglets */
            margin-bottom: 20px;
        }

        /* Inputs & Boutons */
        .action-input { 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--color-border-medium); 
            background: var(--color-bg-medium); /* Plus sombre */
            color: #fff; 
            font-size: 13px; 
        }
        .btn-primary { background: var(--color-primary-pink); color: #fff; border: 0; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px; box-shadow: var(--shadow-pink); transition: all 0.2s; }
        .btn-secondary { background: var(--color-secondary-blue); color: var(--color-bg-dark); border: 0; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px; box-shadow: var(--shadow-blue); transition: all 0.2s; }
        
        /* Style des listes et r√©sultats IA */
        .ai-report-area { 
            background: var(--color-bg-medium); 
            border: 1px solid var(--color-border-dark); 
            border-radius: 12px; 
            padding: 15px; 
            color: #ffffff; 
            min-height: 100px;
        }
        .tab-heading { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 18px; 
            margin-bottom: 15px; 
        }
        .ia-report-header h4 { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--color-primary-pink); margin-bottom: 5px;}
        .ia-html-response h3 { font-size: 1.25rem; font-weight: 600; color: var(--color-ai-niche); margin-top: 15px; border-bottom: 1px solid var(--color-border-dark); padding-bottom: 5px; }
        .ia-html-response ul { list-style-type: none; padding-left: 0; margin-left: 0;}
        .ia-html-response li { margin-bottom: 5px; padding-left: 1.5em; position: relative; font-size: 14px;}
        .ia-html-response li:before {
            content: "‚û§";
            color: var(--color-secondary-blue);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1.5em;
            position: absolute;
        }
        
        /* Stream Card (Left Column) */
        .stream-card {
            padding: 8px;
            background: var(--color-bg-medium);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid var(--color-primary-pink);
        }
        .stream-card:hover {
            background: #2a2a2a;
        }
    </style>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
</head>
<body>
    
    <div class="page-wrapper">
        <h1>STREAM HUB <span style="color:var(--color-secondary-blue);">AI</span></h1>
        <p class="subtitle-center">L'outil d'optimisation et d'analyse de niche propuls√© par Gemini</p>
        
        <div id="twitch-lucky-main">
            
            <div id="col-left">
                <div class="login-box" style="background:var(--color-bg-medium); padding:15px; border-radius:12px; border:1px solid var(--color-border-dark);">
                    <div id="auth-status" class="text-center">
                        <p style="color:#e34a64; font-weight:bold;">‚ùå D√©connect√©</p>
                        <a href="/twitch_auth_start" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px; margin-top: 10px;">üîí SE CONNECTER VIA TWITCH</a>
                    </div>
                </div>
                
                <div class="mt-6 pt-5 border-t border-gray-700" style="border-color: var(--color-border-medium);">
                    <h4 class="tab-heading" style="color:var(--color-primary-pink);"><i class="fas fa-stream mr-2"></i>Vos Cha√Ænes Suivies LIVE</h4>
                    <div id="followed-streams-list" class="space-y-3">
                        <p style="color:var(--color-text-dimmed); text-align:center; padding:10px;">Connectez-vous pour voir le fil...</p>
                    </div>
                </div>
            </div>

            <div id="col-right-content">
                
                <div id="tab-nav-horizontal" class="flex flex-wrap">
                    <button id="tab-niche-scan-btn" class="tab-btn-horizontal active" data-target="tab-niche-scan" onclick="openHorizontalTab('tab-niche-scan')">
                        <i class="fas fa-search mr-1"></i>Analyse de Niche & R√©sultats
                    </button>
                    <button id="tab-disruption-btn" class="tab-btn-horizontal" data-target="tab-disruption" onclick="openHorizontalTab('tab-disruption')">
                        <i class="fas fa-wave-square mr-1"></i>Disruption & Export M√©triques
                    </button>
                    <button id="tab-raid-btn" class="tab-btn-horizontal" data-target="tab-raid" onclick="openHorizontalTab('tab-raid')">
                        <i class="fas fa-crosshairs mr-1"></i>Raid Al√©atoire
                    </button>
                </div>

                <div id="tab-content-horizontal-container">
                    
                    <div id="tab-niche-scan" class="tab-content-horizontal" style="display:block;">
                        <h3 class="tab-heading" style="color:var(--color-ai-niche);"><i class="fas fa-brain mr-2"></i>CONFIGURATION D'ANALYSE DE NICHE</h3>
                        <div id="niche-scan-form" class="flex flex-col gap-3">
                            <label for="target-channel" class="block text-sm font-medium text-gray-300">Cha√Æne Cible (optionnel) :</label>
                            <input type="text" id="target-channel" class="action-input" placeholder="Nom de la cha√Æne ou VOD URL">
                            
                            <label for="niche-context" class="block text-sm font-medium text-gray-300 mt-3">Contexte de Niche :</label>
                            <textarea id="niche-context" rows="3" class="action-input" placeholder="Ex: 'Comment cette cha√Æne pourrait optimiser sa pr√©sence sur les jeux de r√¥le ind√©s ?'"></textarea>
                            
                            <button id="start-niche-scan-btn" class="btn-primary mt-4 w-full" style="background:var(--color-ai-niche); color:var(--color-bg-dark);" onclick="handleAutoAction(this, 'niche_scan')">
                                <i class="fas fa-search mr-2"></i>Lancer l'Analyse et obtenir le Rapport
                            </button>
                        </div>
                    </div>

                    <div id="tab-disruption" class="tab-content-horizontal" style="display:none;">
                        <h3 class="tab-heading" style="color:var(--color-ai-repurpose);"><i class="fas fa-cut mr-2"></i>ANALYSE DE DISRUPTION & EXPORT</h3>
                        <div id="disruption-form" class="flex flex-col gap-3">
                            <label for="vod-url-disruption" class="block text-sm font-medium text-gray-300">VOD URL (Twitch/YouTube) :</label>
                            <input type="text" id="vod-url-disruption" class="action-input" placeholder="Lien vers la VOD pour l'analyse de points de disruption">
                            
                            <label for="disruption-context" class="block text-sm font-medium text-gray-300 mt-3">Objectif d'Export :</label>
                            <textarea id="disruption-context" rows="3" class="action-input" placeholder="Ex: 'Identifier les 3 meilleurs clips de moins de 60 secondes pour TikTok. Sortir le timing et le th√®me.'"></textarea>
                            
                            <button id="start-disruption-btn" class="btn-primary mt-4 w-full" style="background:var(--color-ai-repurpose); color:white;" onclick="handleAutoAction(this, 'disruption_scan')">
                                <i class="fas fa-wave-square mr-2"></i>Lancer l'Analyse Disruption & Export M√©triques
                            </button>
                        </div>
                    </div>
                    
                    <div id="tab-raid" class="tab-content-horizontal" style="display:none;">
                        <h3 class="tab-heading" style="color:var(--color-secondary-blue);"><i class="fas fa-crosshairs mr-2"></i>CONFIGURATION DU RAID AL√âATOIRE</h3>
                        <div id="raid-form" class="flex flex-col gap-3">
                            </div>
                    </div>
                </div>

                <div id="player-area" class="mb-4">
                    <div class="player-wrapper">
                        <h2>
                            <span id="player-icon" style="margin-right: 8px;">üé¨</span>
                            Lecteur Twitch: <span id="current-channel-name">twitch</span>
                            <span id="player-channel-status" style="color:var(--color-text-dimmed); font-size: 14px; margin-left: 10px;">Chargement...</span>
                        </h2>
                        <div id="twitch-embed"></div>
                    </div>
                </div>

                <div id="ia-report-area" class="ai-report-area">
                    <h3 class="tab-heading" style="color:var(--color-primary-pink);"><i class="fas fa-robot mr-2"></i>RAPPORT D'ANALYSE IA</h3>
                    <div id="ia-result-box">
                        Cliquez sur un onglet d'analyse pour commencer, ou d√©marrez un raid !
                    </div>
                </div>

            </div>
        </div>
        </div>

<script>
    // --- VARIABLES GLOBALES ---
    const DEFAULT_CHANNEL = 'twitch'; 
    let activePlayer = null;
    const API_BASE = ''; 
    const DEFAULT_PLAYER_WIDTH = '100%';
    const DEFAULT_PLAYER_HEIGHT = '500px';

    // --- 1. GESTION DU LECTEUR TWITCH ---
    window.launchPlayer = function(channel) {
        if (!channel || channel === 'undefined' || channel === 'null') {
            channel = DEFAULT_CHANNEL;
        }

        if (activePlayer) {
            activePlayer.setChannel(channel);
        } else {
            activePlayer = new Twitch.Embed("twitch-embed", {
                width: DEFAULT_PLAYER_WIDTH,
                height: DEFAULT_PLAYER_HEIGHT,
                channel: channel,
                layout: "video-with-chat",
                theme: "dark",
                parent: ["localhost", window.location.hostname]
            });
        }
        localStorage.setItem('activeChannel', channel);
        updatePlayerStatus(channel, false); // Statut mis √† jour lors du lancement
    };

    function updatePlayerStatus(channelName, isLive = false, videoId = null) {
        const statusEl = document.getElementById('player-channel-status');
        const iconEl = document.getElementById('player-icon'); 
        document.getElementById('current-channel-name').textContent = channelName;

        if (videoId) { 
            statusEl.innerHTML = `üìº VOD: ${channelName.toUpperCase()}`;
            statusEl.style.color = 'var(--color-ai-repurpose)';
            iconEl.innerHTML = '‚ñ∂Ô∏è';
        } else if (isLive) { 
            statusEl.innerHTML = `üî¥ ${channelName.toUpperCase()} (LIVE)`;
            statusEl.style.color = '#ff0000';
            iconEl.innerHTML = 'üî•';
        } else { 
            statusEl.innerHTML = `${channelName.toUpperCase()} (Hors ligne)`;
            statusEl.style.color = 'var(--color-text-dimmed)';
            iconEl.innerHTML = 'üé¨';
        }
    }
    
    // --- 2. GESTION DES ONGLETS HORIZONTAUX (Niche, Disruption, Raid) ---
    window.openHorizontalTab = function(tabId) {
        // Cache tous les contenus d'onglets horizontaux
        document.querySelectorAll('.tab-content-horizontal').forEach(tab => {
            tab.style.display = 'none';
        });

        // D√©sactive tous les boutons d'onglets horizontaux
        document.querySelectorAll('.tab-btn-horizontal').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Affiche l'onglet s√©lectionn√©
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.style.display = 'block';
        }

        // Active le bouton correspondant
        const selectedBtn = document.getElementById(tabId + '-btn');
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }

        localStorage.setItem('activeTab', tabId);
    };

    // --- 3. GESTION DE L'AUTHENTIFICATION TWITCH ---
    window.checkAuth = async function() {
        const authStatusDiv = document.getElementById('auth-status');

        try {
            const response = await fetch(`${API_BASE}/twitch_auth_check`);
            const data = await response.json();

            if (data.is_authenticated) {
                authStatusDiv.innerHTML = `<p class="text-white font-bold">‚úÖ Connect√© : ${data.user_name}</p><button onclick="window.location.href='/followed_streams';" class="btn-primary mt-2 w-full">Actualiser les Streams Suivis</button>`;
                fetchFollowedStreams();
            } else {
                authStatusDiv.innerHTML = `<p class="text-red-400 font-bold">‚ùå D√©connect√©</p><a href="/twitch_auth_start" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px; margin-top: 10px;">üîí SE CONNECTER VIA TWITCH</a>`;
            }
        } catch (e) {
            authStatusDiv.innerHTML = `<p class="text-red-400 font-bold">‚ùå Erreur de connexion au serveur.</p>`;
        }
    };

    // --- 4. R√âCUP√âRATION DES STREAMS SUIVIS ---
    window.fetchFollowedStreams = async function() {
        const streamsBox = document.getElementById('followed-streams-list');
        streamsBox.innerHTML = `<p class="text-yellow-400 text-center"><i class="fas fa-circle-notch fa-spin mr-2"></i>Chargement des streams...</p>`;

        try {
            const response = await fetch(`${API_BASE}/followed_streams`);
            const data = await response.json();

            if (data.error) {
                streamsBox.innerHTML = `<p class="text-red-400 font-bold text-center">‚ùå ${data.error}</p>`;
                return;
            }

            if (data.streams.length === 0) {
                streamsBox.innerHTML = `<p class="text-gray-400 text-center">Aucun streamer suivi en ligne. üò¥</p>`;
                return;
            }

            streamsBox.innerHTML = data.streams.map(stream => `
                <div class="stream-card" onclick="window.launchPlayer('${stream.user_login}')">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white text-sm truncate">${stream.user_name}</span>
                        <span class="text-xs text-primary-pink font-bold ml-2"><i class="fas fa-eye mr-1"></i>${stream.viewer_count.toLocaleString()}</span>
                    </div>
                    <p class="text-xs text-gray-400 truncate mt-1">${stream.title}</p>
                    <p class="text-xs text-secondary-blue font-medium mt-1">${stream.game_name}</p>
                </div>
            `).join('');

        } catch (e) {
            streamsBox.innerHTML = `<p class="text-red-400 font-bold text-center">‚ùå Erreur de connexion au serveur.</p>`;
        }
    };

    // --- 5. GESTION DES ACTIONS IA (Niche Scan / Disruption Scan) ---
    window.handleAutoAction = async function(btn, actionType) {
        btn.disabled = true;
        const resultBox = document.getElementById('ia-result-box');
        const isNiche = actionType === 'niche_scan';
        
        const channelInput = isNiche ? document.getElementById('target-channel').value.trim() : null;
        const contextInput = isNiche ? document.getElementById('niche-context').value.trim() : document.getElementById('disruption-context').value.trim();
        const vodUrl = isNiche ? null : document.getElementById('vod-url-disruption').value.trim();

        const channel = channelInput || localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;

        if (!contextInput) {
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Veuillez fournir un contexte pour l'analyse.</p>`;
            btn.disabled = false;
            return;
        }

        const actionName = isNiche ? "Analyse de Niche" : "Analyse de Disruption";
        resultBox.innerHTML = `<p class="text-yellow-400 font-bold text-center"><i class="fas fa-circle-notch fa-spin mr-2"></i>Lancement de l'${actionName} pour la cha√Æne ${channel}...</p>`;

        try {
            const response = await fetch(`${API_BASE}/auto_action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action_type: actionType, 
                    channel: channel, 
                    context: contextInput,
                    vod_url: vodUrl 
                })
            });

            const data = await response.json();

            if (data.success) {
                // Affiche la r√©ponse IA brute
                let outputHtml = `
                    <div class="ia-report-header border-b border-gray-700 pb-2 mb-4">
                        <h4 class="text-xl font-orbitron text-white">${actionName} pour ${channel}</h4>
                        <p class="text-gray-400 text-sm">Action effectu√©e le ${new Date().toLocaleTimeString()} ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div class="ia-html-response">${data.html_response}</div>
                `;

                // Ajoute le bloc de m√©triques si pr√©sent (pour la Disruption/Export)
                if (data.metrics && data.metrics.length > 0) {
                    const metricsHtml = data.metrics.map(m => `
                        <div class="bg-gray-700 p-3 rounded-lg border-l-4" style="border-left-color: var(--color-ai-repurpose);">
                            <p class="font-bold" style="color:var(--color-ai-repurpose);">${m.title}</p>
                            <p class="text-sm text-white">${m.value}</p>
                        </div>
                    `).join('');
                    outputHtml += `<div class="mt-6 space-y-3"><h4 class="font-bold" style="color:var(--color-secondary-blue); border-bottom: 1px solid var(--color-border-dark); padding-bottom: 5px;">üìä M√©triques/Exports Intelligents</h4>${metricsHtml}</div>`;
                }
                
                resultBox.innerHTML = outputHtml;

            } else {
                resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur lors de l'action IA: ${data.error}</p>`;
            }
        } catch (e) {
            let errorMessage = e.message;
            if (errorMessage.includes("JSON")) {
                errorMessage = "Le serveur n'a pas renvoy√© de donn√©es JSON. L'API est probablement HS.";
            } else if (errorMessage.includes("Failed to fetch")) {
                errorMessage = "√âchec de la connexion au serveur (r√©seau coup√© ou API non d√©marr√©e).";
            }
            
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur: ${errorMessage}</p>`;
        } finally {
            btn.disabled = false;
        }
    };
    
    // --- 6. Logique du RAID AL√âATOIRE (Nouveaut√©) ---
    function setupRaidForm() {
        const raidFormDiv = document.getElementById('raid-form');
        raidFormDiv.innerHTML = `
            <label for="raid-category" class="block text-sm font-medium text-gray-300">Cat√©gorie de Stream :</label>
            <input type="text" id="raid-category" class="action-input" placeholder="Ex: Just Chatting ou League of Legends">
            
            <div class="flex gap-4 mt-3">
                <div class="flex-1">
                    <label for="raid-min-viewers" class="block text-sm font-medium text-gray-300">Spectateurs Min. (0) :</label>
                    <input type="number" id="raid-min-viewers" value="0" min="0" max="1000" class="action-input">
                </div>
                <div class="flex-1">
                    <label for="raid-max-viewers" class="block text-sm font-medium text-gray-300">Spectateurs Max. (100) :</label>
                    <input type="number" id="raid-max-viewers" value="100" min="1" max="1000" class="action-input">
                </div>
            </div>
            
            <button id="find-raid-btn" class="btn-secondary mt-4 w-full" onclick="findRaidTarget(this)">
                <i class="fas fa-search-location mr-2"></i>Chercher une Cible de Raid Al√©atoire
            </button>
            <div id="raid-result-output" class="mt-4 text-sm text-gray-300"></div>
        `;
    }

    async function findRaidTarget(btn) {
        btn.disabled = true;
        const category = document.getElementById('raid-category').value.trim();
        const minViewers = document.getElementById('raid-min-viewers').value;
        const maxViewers = document.getElementById('raid-max-viewers').value;
        const resultOutput = document.getElementById('raid-result-output');

        if (!category) {
            resultOutput.innerHTML = `<p style="color:var(--color-ai-action);">‚ùå Veuillez sp√©cifier une cat√©gorie.</p>`;
            btn.disabled = false;
            return;
        }

        if (parseInt(minViewers) >= parseInt(maxViewers)) {
            resultOutput.innerHTML = `<p style="color:var(--color-ai-action);">‚ùå Le minimum doit √™tre inf√©rieur au maximum.</p>`;
            btn.disabled = false;
            return;
        }

        resultOutput.innerHTML = `<p class="text-yellow-400"><i class="fas fa-circle-notch fa-spin mr-2"></i>Recherche d'un streamer...</p>`;

        try {
            const response = await fetch(`${API_BASE}/raid_target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, minViewers: minViewers || 0, maxViewers: maxViewers || 100 })
            });

            const data = await response.json();

            if (data.success && data.streamer) {
                const streamer = data.streamer;
                window.launchPlayer(streamer.user_login); // Lance l'aper√ßu dans le lecteur
                resultOutput.innerHTML = `
                    <p class="text-lg font-bold text-secondary-blue"><i class="fas fa-bullhorn mr-2"></i>Cible trouv√©e !</p>
                    <p class="text-white">Cha√Æne: <span class="font-bold">${streamer.user_name}</span> (${streamer.viewer_count} spectateurs)</p>
                    <p class="text-gray-400 text-sm">Aper√ßu charg√© dans le lecteur. Lancez le raid manuellement sur Twitch.</p>
                    <a href="https://twitch.tv/${streamer.user_login}" target="_blank" class="mt-2 inline-block p-2 rounded-lg font-bold bg-primary-pink text-white hover:bg-pink-600">
                        <i class="fas fa-external-link-alt mr-2"></i>Ouvrir la Cha√Æne Twitch
                    </a>
                `;
            } else {
                resultOutput.innerHTML = `<p style="color:#ffcc00;">‚ö†Ô∏è ${data.error || 'Aucun streamer trouv√© correspondant aux crit√®res.'}</p>`;
            }
        } catch (e) {
            resultOutput.innerHTML = `<p style="color:var(--color-ai-action);">‚ùå Erreur de connexion au serveur.</p>`;
        } finally {
            btn.disabled = false;
        }
    }

    // --- 7. Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        window.launchPlayer(lastChannel); 

        // Active le bon onglet sup√©rieur (Fusionn√©)
        const savedTab = localStorage.getItem('activeTab') || 'tab-niche-scan'; 
        openHorizontalTab(savedTab);
        
        checkAuth();
        setupRaidForm(); // Initialise le formulaire de raid
    });
</script>
</body>
</html>
