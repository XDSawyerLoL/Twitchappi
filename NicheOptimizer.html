<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Niche Optimizer</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f172a;
      --card:#111c33;
      --card2:#0b1226;
      --text:#e6eefc;
      --muted:#99a7c2;
      --border:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --h: 100vh;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; overflow:hidden; }
    a{ color:inherit; text-decoration:none; }
    button, input, select { font:inherit; }
    .app{
      height:var(--h);
      display:flex;
      flex-direction:column;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.02);
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px rgba(110,231,255,.10); }
    .brand b{ letter-spacing:.3px; }
    .topbar .spacer{ flex:1; }
    .chip{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      max-width:55vw;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{ border-color: rgba(110,231,255,.35); background: rgba(110,231,255,.10); }
    .btn.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
    .btn.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }
    .layout{
      flex:1;
      display:flex;
      min-height:0;
    }
    .left{
      flex:1.4;
      min-width:0;
      display:flex;
      flex-direction:column;
      border-right:1px solid var(--border);
      background: radial-gradient(600px 260px at 20% 0%, rgba(110,231,255,.08), rgba(0,0,0,0));
    }
    .playerControls{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }
    .playerControls .group{ display:flex; gap:8px; flex-wrap:wrap; }
    .playerControls .right{ margin-left:auto; display:flex; gap:8px; }
    .select{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      outline:none;
    }
    .playerWrap{
      flex:1;
      min-height:0;
      padding:14px;
      display:flex;
    }
    .playerCard{
      width:100%;
      border:1px solid var(--border);
      border-radius:var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .playerHeader{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.12);
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.02);
      font-size:12px;
    }
    .playerBody{
      flex:1;
      min-height:0;
      background:#000;
      position:relative;
    }
    .playerBody iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }
    .placeholder{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:10px;
      color:var(--muted);
      padding:18px;
      text-align:center;
    }

    .right{
      flex:1;
      min-width:380px;
      max-width:540px;
      display:flex;
      flex-direction:column;
      min-height:0;
      background: radial-gradient(700px 260px at 80% 0%, rgba(110,231,255,.06), rgba(0,0,0,0));
    }
    .scroll{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
      scrollbar-width:thin;
      scrollbar-color: rgba(255,255,255,.12) rgba(255,255,255,.02);
    }
    .scroll::-webkit-scrollbar{ width:10px; }
    .scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.10); border-radius:999px; border:2px solid rgba(0,0,0,0); background-clip:padding-box; }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius2);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      padding:12px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.25px;
      color:#d9e7ff;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .field{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .input{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      outline:none;
      width:100%;
      max-width:260px;
    }
    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.12);
    }
    .kpi .label{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .kpi .value{
      font-weight:700;
      font-size:18px;
      letter-spacing:.2px;
    }
    .kpi .sub{ color:var(--muted); font-size:12px; margin-top:6px; }
    .chart{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .chart svg{ display:block; width:100%; height:160px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Tooltip (bulle info) */
    .info{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px; height:18px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:#cfe7ff;
      font-size:12px;
      cursor:help;
      flex:0 0 auto;
    }
    .info:hover .tip{ opacity:1; transform:translateY(0); pointer-events:auto; }
    .tip{
      position:absolute;
      z-index:50;
      left:50%;
      top:110%;
      transform:translate(-50%, 6px);
      opacity:0;
      pointer-events:none;
      transition:.14s;
      width:min(320px, 75vw);
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(110,231,255,.22);
      background: rgba(6,10,18,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      color:var(--text);
      text-align:left;
      line-height:1.35;
      font-size:12px;
    }
    .tip b{ color:#d9f7ff; }
    .tip .why{ color:var(--muted); margin-top:6px; }

    /* Modal Netflix-like */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:1000;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width:min(980px, 96vw);
      height:min(640px, 88vh);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,18,33,.96);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .modalHeader{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }
    .modalHeader .title{ font-weight:700; }
    .modalHeader .spacer{ flex:1; }
    .grid{
      padding:14px;
      overflow:auto;
      min-height:0;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(4, 1fr); }
      .right{ min-width:340px; }
    }
    @media (max-width: 720px){
      .layout{ flex-direction:column; }
      .right{ max-width:none; min-width:0; border-top:1px solid var(--border); }
      .grid{ grid-template-columns: repeat(3, 1fr); }
      html,body{ overflow:auto; }
      .app{ height:auto; min-height:100vh; }
      .playerWrap{ min-height:50vh; }
    }
    .gameCard{
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      overflow:hidden;
      cursor:pointer;
      transition:.15s;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .gameCard:hover{ transform:translateY(-2px); border-color: rgba(110,231,255,.26); }
    .gameThumb{
      width:100%;
      aspect-ratio: 3/4;
      background:#000;
      display:block;
      object-fit:cover;
    }
    .gameName{
      padding:8px 10px;
      font-size:12px;
      color:#dbe9ff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border-top:1px solid var(--border);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:14px;
      bottom:14px;
      z-index:2000;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
    }
    .toastItem{
      pointer-events:auto;
      border:1px solid var(--border);
      background: rgba(10,14,24,.92);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      width:min(420px, 92vw);
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .toastItem .t{ font-weight:700; }
    .toastItem .m{ color:var(--muted); font-size:12px; margin-top:2px; line-height:1.35; }
    .toastItem .x{ margin-left:auto; cursor:pointer; opacity:.8; }
    .muted{ color:var(--muted); }
    .hr{ height:1px; background:var(--border); margin:10px 0; }

    /* Chat */
    .chatBox{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chatLog{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.12);
      padding:10px;
      height:140px;
      overflow:auto;
      font-size:12px;
      color:#dbe9ff;
    }
    .chatLog .line{ margin:0 0 6px 0; color:#dbe9ff; }
    .chatInputRow{ display:flex; gap:8px; }
    .chatInputRow input{
      flex:1;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      outline:none;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <b>Streamer Hub</b>
      <span class="pill" id="firebasePill">Firebase: ‚Ä¶</span>
    </div>

    <div class="chip" id="statusChip">Pr√™t. Choisis un streamer ou clique ‚ÄúJ‚Äôai de la chance‚Äù.</div>

    <div class="spacer"></div>

    <button class="btn" id="btnAuth">üîê Connexion Twitch</button>
    <button class="btn" id="btnLogout" style="display:none">üö™ D√©connexion</button>
  </div>

  <div class="layout">
    <!-- LEFT: Player -->
    <div class="left">
      <div class="playerControls">
        <div class="group">
          <button class="btn" id="btnPrev">‚óÄ</button>
          <button class="btn" id="btnNext">‚ñ∂</button>

          <button class="btn primary" id="btnLucky">üçÄ J‚Äôai de la chance</button>

          <button class="btn" id="btnChooseGame">üé¨ Choisir un jeu</button>

          <select class="select" id="maxViewersSelect" title="Limite d'audience">
            <option value="25">‚â§ 25 viewers</option>
            <option value="50">‚â§ 50 viewers</option>
            <option value="100" selected>‚â§ 100 viewers</option>
          </select>
        </div>

        <div class="right">
          <button class="btn warn" id="btnBoost">‚ö° BOOST 15 min</button>
          <a class="btn" id="btnOpenTwitch" href="#" target="_blank" rel="noreferrer">‚Üó Ouvrir sur Twitch</a>
        </div>
      </div>

      <div class="playerWrap">
        <div class="playerCard">
          <div class="playerHeader">
            <span class="pill" id="pillChannel">Cha√Æne: ‚Äî</span>
            <span class="pill" id="pillGame">Jeu: ‚Äî</span>
            <span class="pill" id="pillViewers">Viewers: ‚Äî</span>
            <span class="spacer"></span>
            <span class="pill" id="pillMode">Mode: ‚Äî</span>
          </div>
          <div class="playerBody" id="playerBody">
            <div class="placeholder">
              <div style="font-size:18px;font-weight:800;color:#dbe9ff;">Pr√™t √† d√©couvrir des petits streamers ‚ú®</div>
              <div class="muted">Choisis un jeu (üé¨), puis clique ‚ÄúüçÄ J‚Äôai de la chance‚Äù pour tomber sur un streamer FR dans cette cat√©gorie (0‚Äì100 viewers).</div>
              <div class="muted small">Objectif : une exp√©rience cool pour les viewers + utile pour les streamers (analyse + coaching).</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Tools -->
    <div class="right">
      <div class="scroll">

        <!-- GLOBAL INTRADAY -->
        <div class="card">
          <h3>
            üìà Tendance Twitch FR (24h)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> l‚Äô√©volution de l‚Äôaudience totale des streams FR dans le temps (courbe).
                <div class="why"><b>Pourquoi c‚Äôest utile :</b> tu rep√®res les heures ‚Äúchaudes‚Äù (plus de viewers) et les creux (moins de concurrence). Id√©al pour placer tes lives.</div>
              </span>
            </span>
          </h3>

          <div class="row">
            <button class="btn" id="btnRefreshGlobal">üîÑ Actualiser</button>
            <select class="select" id="globalHours">
              <option value="6">6h</option>
              <option value="12">12h</option>
              <option value="24" selected>24h</option>
              <option value="48">48h</option>
            </select>
            <span class="small">Mis √† jour automatiquement.</span>
          </div>

          <div class="hr"></div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="label">
                Viewers FR (actuel)
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> estimation du total de viewers sur les streams FR suivis par le syst√®me.
                    <div class="why"><b>Utile :</b> si c‚Äôest haut, c‚Äôest souvent une meilleure fen√™tre pour ‚Äú√™tre d√©couvert‚Äù.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="g_total">‚Äî</div>
              <div class="sub" id="g_total_sub">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">
                Cha√Ænes live (actuel)
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> nombre de cha√Ænes live observ√©es (FR).
                    <div class="why"><b>Utile :</b> plus c‚Äôest haut, plus la concurrence est forte. Combine avec les viewers pour d√©cider.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="g_live">‚Äî</div>
              <div class="sub" id="g_live_sub">‚Äî</div>
            </div>
          </div>

          <div class="chart" id="chartGlobal"></div>
          <div class="small" id="g_hint">Astuce : vise les moments o√π la courbe monte (plus d‚Äôarriv√©e de viewers).</div>
        </div>

        <!-- CHANNEL INTRADAY -->
        <div class="card">
          <h3>
            üß≠ Tendance de ta cha√Æne (24h)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> la courbe de tes viewers (par snapshot) sur les derni√®res heures.
                <div class="why"><b>Utile :</b> tu vois si √ßa progresse en temps r√©el et √† quels moments tu gagnes/perds du monde (intro, changement de jeu, raids‚Ä¶).</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <input class="input" id="loginInput" placeholder="Ton login Twitch (ex: sansa)" />
            <button class="btn primary" id="btnLoadChannel">Charger</button>
            <select class="select" id="channelHours">
              <option value="6">6h</option>
              <option value="12">12h</option>
              <option value="24" selected>24h</option>
              <option value="48">48h</option>
            </select>
          </div>

          <div class="hr"></div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="label">
                Moyenne viewers
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> moyenne sur la p√©riode affich√©e.
                    <div class="why"><b>Utile :</b> c‚Äôest ton ‚Äúniveau stable‚Äù. Pratique pour comparer tes formats d‚Äôun jour √† l‚Äôautre.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_avg">‚Äî</div>
              <div class="sub">Sur la p√©riode s√©lectionn√©e.</div>
            </div>
            <div class="kpi">
              <div class="label">
                Pic viewers
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> meilleur moment de la p√©riode.
                    <div class="why"><b>Utile :</b> c‚Äôest souvent li√© √† un segment fort (jeu, sujet, raid, clip). √Ä reproduire.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_peak">‚Äî</div>
              <div class="sub" id="c_peak_sub">‚Äî</div>
            </div>

            <div class="kpi">
              <div class="label">
                Croissance (%)
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> √©volution entre le d√©but et la fin de la p√©riode.
                    <div class="why"><b>Utile :</b> positive = ton live ‚Äúprend‚Äù. N√©gative = tu perds du monde (intro trop longue, jeu satur√©‚Ä¶).</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_growth">‚Äî</div>
              <div class="sub">D√©but ‚Üí fin de courbe.</div>
            </div>
            <div class="kpi">
              <div class="label">
                Volatilit√©
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> √† quel point ton audience bouge (instable vs stable).
                    <div class="why"><b>Utile :</b> si c‚Äôest tr√®s haut, travaille la r√©tention (promesse, rythme, segments, overlay clair).</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_vol">‚Äî</div>
              <div class="sub">Plus haut = plus irr√©gulier.</div>
            </div>

            <div class="kpi">
              <div class="label">
                Heures / semaine (estim.)
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> estimation bas√©e sur tes stats journali√®res.
                    <div class="why"><b>Utile :</b> trop bas = difficile de grandir, trop haut = risque de fatigue. Trouver ton rythme.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_hours">‚Äî</div>
              <div class="sub">Si dispo dans Firestore.</div>
            </div>
            <div class="kpi">
              <div class="label">
                Score de croissance (0‚Äì100)
                <span class="info">?
                  <span class="tip">
                    <b>Ce que c‚Äôest :</b> score combinant moyenne, croissance, r√©gularit√© et volume.
                    <div class="why"><b>Utile :</b> te donne une lecture rapide : <b>o√π tu en es</b> et si tes efforts payent.</div>
                  </span>
                </span>
              </div>
              <div class="value" id="c_score">‚Äî</div>
              <div class="sub">Plus haut = meilleures conditions.</div>
            </div>
          </div>

          <div class="chart" id="chartChannel"></div>
          <div class="small" id="c_hint">Lis la courbe : mont√©e r√©guli√®re = bon rythme. Chutes brutales = un moment √† am√©liorer.</div>
        </div>

        <!-- BEST TIME TOOL -->
        <div class="card">
          <h3>
            üóìÔ∏è Horaires & niche (IA)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> une lecture ‚Äúcoach‚Äù : saturation + cr√©neaux + score niche.
                <div class="why"><b>Utile :</b> choisir les bonnes fen√™tres = plus de d√©couvertes et moins de concurrence.</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <input class="input" id="gameInput" placeholder="Nom du jeu (ex: Hades)" />
            <button class="btn primary" id="btnAnalyzeGame">Analyser</button>
          </div>
          <div class="small muted" id="gameSelectedHint">Jeu s√©lectionn√© : <b id="chosenGameLabel">‚Äî</b></div>

          <div class="hr"></div>
          <div id="gameAnalysis" class="small muted">Clique ‚ÄúAnalyser‚Äù pour obtenir des cr√©neaux concrets.</div>
        </div>

        <!-- ALERTS -->
        <div class="card">
          <h3>
            üö® Alertes & actions
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> des alertes bas√©es sur tes stats (ex: acc√©l√©ration, format √† ajuster).
                <div class="why"><b>Utile :</b> c‚Äôest ta ‚Äúliste d‚Äôactions du jour‚Äù. Tu sais quoi faire sans te noyer dans les chiffres.</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <button class="btn" id="btnLoadAlerts">Voir mes alertes</button>
            <button class="btn good" id="btnGenerateAlerts">G√©n√©rer (IA + r√®gles)</button>
          </div>
          <div class="hr"></div>
          <div id="alertsBox" class="small muted">Charge un login dans ‚ÄúTendance de ta cha√Æne‚Äù, puis clique ici.</div>
        </div>

        <!-- AI RECO -->
        <div class="card">
          <h3>
            üí° Recommandations IA (coach)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> conseils bas√©s sur tes KPIs (moyenne, pic, croissance‚Ä¶).
                <div class="why"><b>Utile :</b> tu obtiens des tests concrets (format, titre, rythme) √† essayer d√®s la semaine prochaine.</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <button class="btn primary" id="btnReco">G√©n√©rer des recommandations</button>
          </div>
          <div class="hr"></div>
          <div id="recoBox" class="small muted">Tu veux du concret : √ßa te donne une to-do list ‚Äústreamer friendly‚Äù.</div>
        </div>

        <!-- CO-STREAM -->
        <div class="card">
          <h3>
            ü§ù Co-stream sugg√©r√©
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> propose une cha√Æne FR live sur le m√™me jeu avec une audience proche.
                <div class="why"><b>Utile :</b> collab = √©change d‚Äôaudience. Plus facile quand les tailles sont compatibles.</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <button class="btn" id="btnCostream">Trouver un co-stream</button>
          </div>
          <div class="hr"></div>
          <div id="costreamBox" class="small muted">N√©cessite que la cha√Æne soit live (ou que le cron ait vu le jeu).</div>
        </div>

        <!-- RAID -->
        <div class="card">
          <h3>
            üß® Raid target (petits streamers)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> trouve une cible FR sur un jeu, sous un seuil de viewers.
                <div class="why"><b>Utile :</b> raids ‚Äúcompatibles‚Äù = meilleur accueil, meilleure conversion, meilleure vibe.</div>
              </span>
            </span>
          </h3>

          <div class="field">
            <button class="btn primary" id="btnRaid">Trouver une cible</button>
            <select class="select" id="raidMax">
              <option value="25">‚â§ 25 viewers</option>
              <option value="50">‚â§ 50 viewers</option>
              <option value="100" selected>‚â§ 100 viewers</option>
            </select>
          </div>
          <div class="hr"></div>
          <div id="raidBox" class="small muted">Utilise le jeu s√©lectionn√© (üé¨). Tu peux ensuite lancer le player dessus.</div>
        </div>

        <!-- CHAT -->
        <div class="card">
          <h3>
            üí¨ Chat de la room (socket)
            <span class="info">?
              <span class="tip">
                <b>Ce que c‚Äôest :</b> un mini chat interne (pas le chat Twitch).
                <div class="why"><b>Utile :</b> tests, watch party, commentaires pendant la d√©couverte de streamers.</div>
              </span>
            </span>
          </h3>

          <div class="chatBox">
            <div class="chatLog" id="chatLog"></div>
            <div class="chatInputRow">
              <input id="chatUser" placeholder="Pseudo" value="Viewer"/>
              <input id="chatText" placeholder="Message‚Ä¶"/>
              <button class="btn" id="chatSend">Envoyer</button>
            </div>
            <div class="small muted" id="socketState">Socket: ‚Ä¶</div>
          </div>
        </div>

        <div class="small muted" style="padding-bottom:10px;">
          ‚úÖ Tout est con√ßu pour √™tre <b>compr√©hensible</b> : survole les <b>?</b> pour le ‚Äúquoi / comment / pourquoi‚Äù.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Netflix -->
<div class="modal" id="gameModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHeader">
      <div class="title">üé¨ Choisis un jeu (style Netflix)</div>
      <div class="spacer"></div>
      <input class="input" id="gameSearch" style="max-width:320px" placeholder="Rechercher (ex: valorant)" />
      <button class="btn" id="btnGameSearch">Rechercher</button>
      <button class="btn" id="btnCloseModal">‚úï</button>
    </div>
    <div class="small muted" style="padding:0 14px 8px 14px;">
      Astuce : clique une cover pour s√©lectionner le jeu. Ensuite ‚ÄúüçÄ J‚Äôai de la chance‚Äù te propose un streamer <b>0‚Äì100 viewers</b> dans ce jeu.
    </div>
    <div class="grid" id="gameGrid"></div>
  </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<script>
/* =========================================================
   UTILITAIRES UI
========================================================= */
const $ = (sel) => document.querySelector(sel);

function toast(title, message, kind="info"){
  const wrap = $("#toast");
  const el = document.createElement("div");
  el.className = "toastItem";
  const icon = kind==="good" ? "‚úÖ" : kind==="warn" ? "‚ö†Ô∏è" : kind==="bad" ? "‚õî" : "‚ÑπÔ∏è";
  el.innerHTML = `
    <div>${icon}</div>
    <div>
      <div class="t">${escapeHtml(title)}</div>
      <div class="m">${escapeHtml(message)}</div>
    </div>
    <div class="x" title="Fermer">‚úï</div>
  `;
  el.querySelector(".x").onclick = () => el.remove();
  wrap.appendChild(el);
  setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function setStatus(text){
  $("#statusChip").textContent = text;
}

/* =========================================================
   API FETCH WRAPPER
========================================================= */
async function api(url, options={}){
  try{
    const res = await fetch(url, {
      headers: { "Content-Type":"application/json" },
      ...options
    });
    const isJson = (res.headers.get("content-type")||"").includes("application/json");
    const data = isJson ? await res.json() : await res.text();
    if(!res.ok){
      throw new Error(typeof data === "string" ? data : (data?.error || data?.message || "Erreur"));
    }
    return data;
  }catch(e){
    throw e;
  }
}

/* =========================================================
   TWITCH PLAYER
========================================================= */
let currentChannel = null;
let currentGameName = null;
let currentMode = null;

function twitchParent(){
  // Twitch exige le param parent= (hostname sans port)
  return location.hostname || "localhost";
}

function buildPlayerUrl(channel){
  const parent = encodeURIComponent(twitchParent());
  return `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=false`;
}

function loadChannelInPlayer(channel, meta={}){
  currentChannel = channel;
  $("#pillChannel").textContent = `Cha√Æne: ${channel || "‚Äî"}`;
  $("#pillGame").textContent = `Jeu: ${meta.game_name || meta.game || currentGameName || "‚Äî"}`;
  $("#pillViewers").textContent = `Viewers: ${meta.viewer_count ?? meta.viewers ?? "‚Äî"}`;
  $("#pillMode").textContent = `Mode: ${currentMode || "‚Äî"}`;
  $("#btnOpenTwitch").href = channel ? `https://twitch.tv/${channel}` : "#";

  const body = $("#playerBody");
  body.innerHTML = "";
  const iframe = document.createElement("iframe");
  iframe.allowFullscreen = true;
  iframe.allow = "autoplay; fullscreen";
  iframe.src = buildPlayerUrl(channel);
  body.appendChild(iframe);

  setStatus(`Lecture: ${channel} ‚Ä¢ Jeu: ${meta.game_name || meta.game || "‚Äî"} ‚Ä¢ Viewers: ${meta.viewer_count ?? meta.viewers ?? "‚Äî"}`);
}

/* =========================================================
   MINI CHART (SVG)
========================================================= */
function renderLineChart(containerEl, labels=[], values=[], options={}){
  const w = 1000, h = 160;
  const padL = 36, padR = 12, padT = 12, padB = 26;
  const minV = Math.min(...(values.length?values:[0]));
  const maxV = Math.max(...(values.length?values:[1]));
  const span = (maxV - minV) || 1;

  const x = (i) => padL + (i*(w-padL-padR))/Math.max(1,(values.length-1));
  const y = (v) => padT + ((maxV - v)/span)*(h-padT-padB);

  let d = "";
  values.forEach((v,i)=>{
    d += (i===0?`M ${x(i)} ${y(v)}`:` L ${x(i)} ${y(v)}`);
  });

  const ticks = 4;
  let grid = "";
  for(let t=0;t<=ticks;t++){
    const yy = padT + (t*(h-padT-padB))/ticks;
    grid += `<line x1="${padL}" y1="${yy}" x2="${w-padR}" y2="${yy}" stroke="rgba(255,255,255,.06)" stroke-width="1" />`;
  }

  const lastLabel = labels[labels.length-1] || "";
  const firstLabel = labels[0] || "";

  const svg = `
    <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
      <rect x="0" y="0" width="${w}" height="${h}" fill="rgba(0,0,0,.0)"></rect>
      ${grid}
      <path d="${d}" fill="none" stroke="rgba(110,231,255,.9)" stroke-width="2.5" />
      ${values.length ? `<circle cx="${x(values.length-1)}" cy="${y(values[values.length-1])}" r="4.5" fill="rgba(110,231,255,.95)"></circle>` : ""}

      <text x="${padL}" y="${h-8}" fill="rgba(255,255,255,.55)" font-size="16">${escapeHtml(firstLabel)}</text>
      <text x="${w-padR}" y="${h-8}" fill="rgba(255,255,255,.55)" font-size="16" text-anchor="end">${escapeHtml(lastLabel)}</text>
    </svg>
  `;
  containerEl.innerHTML = svg;
}

/* =========================================================
   ROUTES BRANCH√âES
========================================================= */
async function loadFirebaseStatus(){
  try{
    const d = await api("/firebase_status");
    $("#firebasePill").textContent = `Firebase: ${d.connected ? "OK" : "KO"}`;
    $("#firebasePill").style.borderColor = d.connected ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
  }catch{
    $("#firebasePill").textContent = "Firebase: ?";
  }
}

async function loadTwitchUserStatus(){
  try{
    const d = await api("/twitch_user_status");
    if(d.is_connected){
      $("#btnAuth").style.display = "none";
      $("#btnLogout").style.display = "inline-flex";
      toast("Connect√© √† Twitch", `Bonjour ${d.display_name}`, "good");
    }else{
      $("#btnAuth").style.display = "inline-flex";
      $("#btnLogout").style.display = "none";
    }
  }catch{}
}

/* ---------- Global intraday ---------- */
async function loadGlobalIntraday(){
  const hours = $("#globalHours").value;
  try{
    const d = await api(`/api/stats/global_intraday?hours=${encodeURIComponent(hours)}`);
    $("#g_total").textContent = d.current_total_viewers ?? "‚Äî";
    $("#g_live").textContent = d.current_channels_live ?? "‚Äî";
    $("#g_total_sub").textContent = "Audience totale FR (snapshot)";
    $("#g_live_sub").textContent = "Nombre de cha√Ænes FR observ√©es";

    renderLineChart($("#chartGlobal"), d.series?.labels || [], d.series?.values || []);
  }catch(e){
    toast("Global intraday", e.message, "bad");
  }
}

/* ---------- Channel intraday ---------- */
async function loadChannelIntraday(){
  const login = ($("#loginInput").value||"").trim().toLowerCase();
  const hours = $("#channelHours").value;
  if(!login){
    toast("Login requis", "Renseigne ton login Twitch (ex: sansa).", "warn");
    return;
  }
  try{
    const d = await api(`/api/analytics/channel_intraday_by_login/${encodeURIComponent(login)}?hours=${encodeURIComponent(hours)}`);
    $("#c_avg").textContent = d.kpis?.avg_viewers ?? "‚Äî";
    $("#c_peak").textContent = d.kpis?.peak_viewers ?? "‚Äî";
    $("#c_growth").textContent = (d.kpis?.growth_percent ?? "‚Äî") + (typeof d.kpis?.growth_percent === "number" ? "%" : "");
    $("#c_vol").textContent = d.kpis?.volatility ?? "‚Äî";
    $("#c_hours").textContent = d.kpis?.hours_per_week_est ?? "‚Äî";
    $("#c_score").textContent = d.kpis?.growth_score ?? "‚Äî";
    $("#c_peak_sub").textContent = `√âchantillons: ${d.kpis?.samples ?? "‚Äî"}`;

    renderLineChart($("#chartChannel"), d.series?.labels || [], d.series?.values || []);
    toast("Cha√Æne charg√©e", `Intraday OK pour ${login}`, "good");
  }catch(e){
    toast("Intraday cha√Æne", e.message, "bad");
  }
}

/* ---------- Best time (IA) ---------- */
async function analyzeGame(){
  const game = ($("#gameInput").value||"").trim() || (currentGameName || "");
  if(!game){
    toast("Jeu requis", "Choisis un jeu (üé¨) ou √©cris-en un (ex: Hades).", "warn");
    return;
  }
  $("#gameAnalysis").innerHTML = "<span class='muted'>Analyse en cours‚Ä¶</span>";
  try{
    const d = await api("/analyze_schedule", {
      method:"POST",
      body: JSON.stringify({ game })
    });
    $("#gameAnalysis").innerHTML = d.html_response || "<p class='muted'>Aucune r√©ponse.</p>";
    toast("Analyse horaire", "Conseils g√©n√©r√©s.", "good");
  }catch(e){
    $("#gameAnalysis").innerHTML = `<p class="muted">‚õî ${escapeHtml(e.message)}</p>`;
  }
}

/* ---------- Alerts ---------- */
async function loadAlerts(){
  const login = ($("#loginInput").value||"").trim().toLowerCase();
  if(!login){ toast("Login requis", "Charge un login dans la section cha√Æne.", "warn"); return; }
  $("#alertsBox").innerHTML = "<span class='muted'>Chargement‚Ä¶</span>";
  try{
    const d = await api(`/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=10`);
    const items = d.items || [];
    if(!items.length){
      $("#alertsBox").innerHTML = "<span class='muted'>Aucune alerte pour le moment. Clique ‚ÄúG√©n√©rer‚Äù.</span>";
      return;
    }
    $("#alertsBox").innerHTML = items.map(it => `
      <div style="border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(0,0,0,.12);margin-bottom:8px;">
        <div style="font-weight:800;">${escapeHtml(it.title || it.type || "Alerte")}</div>
        <div class="muted" style="margin-top:4px;">${escapeHtml(it.message || "")}</div>
        <div class="small muted" style="margin-top:6px;">Score: <b>${escapeHtml(it.score ?? "‚Äî")}</b> ‚Ä¢ Jour: ${escapeHtml(it.day ?? "‚Äî")}</div>
      </div>
    `).join("");
  }catch(e){
    $("#alertsBox").innerHTML = `<span class="muted">‚õî ${escapeHtml(e.message)}</span>`;
  }
}

async function generateAlerts(){
  const login = ($("#loginInput").value||"").trim().toLowerCase();
  if(!login){ toast("Login requis", "Charge un login dans la section cha√Æne.", "warn"); return; }
  toast("G√©n√©ration", "Cr√©ation des alertes‚Ä¶", "info");
  try{
    await api("/api/alerts/generate", {
      method:"POST",
      body: JSON.stringify({ login, days: 30 })
    });
    toast("Alertes", "Alertes g√©n√©r√©es.", "good");
    await loadAlerts();
  }catch(e){
    toast("Alertes", e.message, "bad");
  }
}

/* ---------- AI reco ---------- */
async function loadReco(){
  const login = ($("#loginInput").value||"").trim().toLowerCase();
  if(!login){ toast("Login requis", "Charge un login dans la section cha√Æne.", "warn"); return; }
  $("#recoBox").innerHTML = "<span class='muted'>G√©n√©ration‚Ä¶</span>";
  try{
    const d = await api(`/api/ai/reco?login=${encodeURIComponent(login)}&days=30`);
    $("#recoBox").innerHTML = d.html_response || "<span class='muted'>Aucune r√©ponse.</span>";
    toast("Reco IA", "Conseils pr√™ts.", "good");
  }catch(e){
    $("#recoBox").innerHTML = `<span class="muted">‚õî ${escapeHtml(e.message)}</span>`;
  }
}

/* ---------- Co-stream ---------- */
async function loadCostream(){
  const login = ($("#loginInput").value||"").trim().toLowerCase();
  if(!login){ toast("Login requis", "Charge un login dans la section cha√Æne.", "warn"); return; }
  $("#costreamBox").innerHTML = "<span class='muted'>Recherche‚Ä¶</span>";
  try{
    const d = await api(`/api/costream/best?login=${encodeURIComponent(login)}&days=14`);
    if(!d.success){
      $("#costreamBox").innerHTML = `<span class="muted">‚õî ${escapeHtml(d.message || "Impossible")}</span>`;
      return;
    }
    const b = d.best;
    $("#costreamBox").innerHTML = `
      <div style="border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(0,0,0,.12);">
        <div style="font-weight:900;">‚ú® ${escapeHtml(b.display_name)} <span class="muted">(@${escapeHtml(b.login)})</span></div>
        <div class="muted" style="margin-top:6px;">${escapeHtml(b.why || "")}</div>
        <div class="small muted" style="margin-top:8px;">Score compatibilit√©: <b>${escapeHtml(b.score ?? "‚Äî")}</b></div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" onclick="window.open('https://twitch.tv/${escapeHtml(b.login)}','_blank')">Ouvrir</button>
          <button class="btn" onclick="loadChannelInPlayer('${escapeHtml(b.login)}', {game_name:'', viewer_count:''}); currentMode='COSTREAM'; $('#pillMode').textContent='Mode: COSTREAM';">Lire dans le player</button>
        </div>
      </div>
    `;
  }catch(e){
    $("#costreamBox").innerHTML = `<span class="muted">‚õî ${escapeHtml(e.message)}</span>`;
  }
}

/* ---------- RAID + LUCKY (petits streamers) ---------- */
async function raidOrLucky(maxViewers, random=true){
  const game = currentGameName || ($("#gameInput").value||"").trim();
  if(!game){
    toast("Choisis un jeu", "Clique ‚Äúüé¨ Choisir un jeu‚Äù puis ‚ÄúüçÄ J‚Äôai de la chance‚Äù.", "warn");
    return;
  }
  const box = $("#raidBox");
  if(box) box.innerHTML = "<span class='muted'>Recherche‚Ä¶</span>";
  try{
    // On r√©utilise /start_raid (backend), max viewers configurable
    const d = await api("/start_raid", {
      method:"POST",
      body: JSON.stringify({ game, max_viewers: Number(maxViewers || 100) })
    });
    if(!d.success || !d.target){
      if(box) box.innerHTML = "<span class='muted'>Aucune cible trouv√©e.</span>";
      toast("Raid/Lucky", "Aucune cible trouv√©e dans cette cat√©gorie.", "warn");
      return;
    }

    const t = d.target;
    const html = `
      <div style="display:flex; gap:10px; align-items:center;">
        <img src="${escapeHtml(t.thumbnail_url||"")}" style="width:120px;border-radius:12px;border:1px solid var(--border);" alt="thumb"/>
        <div style="min-width:0;">
          <div style="font-weight:900;">üéØ ${escapeHtml(t.name)} <span class="muted">(@${escapeHtml(t.login)})</span></div>
          <div class="muted" style="margin-top:4px;">Jeu: <b>${escapeHtml(t.game||game)}</b> ‚Ä¢ Viewers: <b>${escapeHtml(t.viewers)}</b></div>
          <div class="small muted" style="margin-top:6px;">Conseil : raid = meilleure ambiance quand les audiences sont proches.</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnPlayRaid">Lire dans le player</button>
            <button class="btn" id="btnOpenRaid">Ouvrir sur Twitch</button>
          </div>
        </div>
      </div>
    `;
    if(box) box.innerHTML = html;

    const playBtn = $("#btnPlayRaid");
    const openBtn = $("#btnOpenRaid");
    if(playBtn) playBtn.onclick = () => {
      currentMode = random ? "LUCKY" : "RAID";
      loadChannelInPlayer(t.login, { game_name: t.game, viewer_count: t.viewers });
      toast("Lecture", `On regarde ${t.login} (‚â§ ${maxViewers} viewers)`, "good");
    };
    if(openBtn) openBtn.onclick = () => window.open(`https://twitch.tv/${t.login}`, "_blank");

    if(random){
      currentMode = "LUCKY";
      loadChannelInPlayer(t.login, { game_name: t.game, viewer_count: t.viewers });
    }
  }catch(e){
    if(box) box.innerHTML = `<span class="muted">‚õî ${escapeHtml(e.message)}</span>`;
    toast("Raid/Lucky", e.message, "bad");
  }
}

/* ---------- Default rotation (AUTO / BOOST) ---------- */
async function loadDefaultStream(){
  try{
    const d = await api("/get_default_stream");
    if(!d.success){ throw new Error("Impossible de r√©cup√©rer un stream par d√©faut."); }
    currentMode = d.mode || "AUTO";
    loadChannelInPlayer(d.channel, { viewer_count: d.viewers ?? "‚Äî", game_name: currentGameName || "‚Äî" });
    $("#pillMode").textContent = `Mode: ${currentMode}`;
  }catch(e){
    toast("Default stream", e.message, "bad");
  }
}

async function cycle(direction){
  try{
    const d = await api("/cycle_stream", {
      method:"POST",
      body: JSON.stringify({ direction })
    });
    if(!d.success){ toast("Rotation", "Impossible (boost actif ?)", "warn"); return; }
    currentMode = "AUTO";
    loadChannelInPlayer(d.channel, { viewer_count: "‚Äî", game_name: currentGameName || "‚Äî" });
    $("#pillMode").textContent = `Mode: AUTO`;
  }catch(e){
    toast("Rotation", e.message, "bad");
  }
}

async function boostCurrent(){
  if(!currentChannel){
    toast("Boost", "Lance un streamer d‚Äôabord.", "warn");
    return;
  }
  try{
    const d = await api("/stream_boost", {
      method:"POST",
      body: JSON.stringify({ channel: currentChannel })
    });
    toast("Boost", "Boost activ√© 15 minutes (rotation bloqu√©e).", "good");
  }catch(e){
    toast("Boost", e.message, "bad");
  }
}

/* ---------- stream_info (metas live) ---------- */
async function refreshStreamInfo(){
  if(!currentChannel) return;
  try{
    const d = await api("/stream_info", {
      method:"POST",
      body: JSON.stringify({ channel: currentChannel })
    });
    if(d.success){
      const s = d.stream;
      if(s){
        $("#pillGame").textContent = `Jeu: ${s.game_name || "‚Äî"}`;
        $("#pillViewers").textContent = `Viewers: ${s.viewer_count ?? "‚Äî"}`;
      }else{
        $("#pillViewers").textContent = `Viewers: offline`;
      }
    }
  }catch{}
}

/* =========================================================
   MODAL GAMES (Netflix-like)
========================================================= */
let modalLoaded = false;

async function openGameModal(){
  $("#gameModal").classList.add("open");
  $("#gameModal").setAttribute("aria-hidden","false");
  if(!modalLoaded){
    await loadTopGamesIntoModal();
    modalLoaded = true;
  }
}

function closeGameModal(){
  $("#gameModal").classList.remove("open");
  $("#gameModal").setAttribute("aria-hidden","true");
}

function setChosenGame(name){
  currentGameName = name;
  $("#chosenGameLabel").textContent = name || "‚Äî";
  $("#pillGame").textContent = `Jeu: ${name || "‚Äî"}`;
  $("#gameInput").value = name || "";
  toast("Jeu s√©lectionn√©", name, "good");
  closeGameModal();
}

async function loadTopGamesIntoModal(){
  const grid = $("#gameGrid");
  grid.innerHTML = "<div class='muted'>Chargement des covers‚Ä¶</div>";
  try{
    const d = await api("/api/stats/top_games");
    const games = d.games || [];
    if(!games.length){
      grid.innerHTML = "<div class='muted'>Aucun jeu r√©cup√©r√©.</div>";
      return;
    }
    grid.innerHTML = games.map(g => `
      <div class="gameCard" data-game="${escapeHtml(g.name)}" title="${escapeHtml(g.name)}">
        <img class="gameThumb" src="${escapeHtml(g.box_art_url)}" alt="${escapeHtml(g.name)}"/>
        <div class="gameName">${escapeHtml(g.name)}</div>
      </div>
    `).join("");
    grid.querySelectorAll(".gameCard").forEach(el=>{
      el.onclick = () => setChosenGame(el.getAttribute("data-game"));
    });
  }catch(e){
    grid.innerHTML = `<div class='muted'>‚õî ${escapeHtml(e.message)}</div>`;
  }
}

async function searchGameInModal(){
  const q = ($("#gameSearch").value||"").trim();
  if(!q){ toast("Recherche", "Tape un nom de jeu.", "warn"); return; }
  const grid = $("#gameGrid");
  grid.innerHTML = "<div class='muted'>Recherche‚Ä¶</div>";
  try{
    // /scan_target peut renvoyer type=game (mais sans ID). On l‚Äôutilise juste pour s√©lectionner le nom + cover.
    const d = await api("/scan_target", { method:"POST", body: JSON.stringify({ query: q }) });
    if(d.success && d.type === "game" && d.game_data){
      const g = d.game_data;
      const name = g.name;
      const cover = g.box_art_url;
      grid.innerHTML = `
        <div class="gameCard" data-game="${escapeHtml(name)}" title="${escapeHtml(name)}">
          <img class="gameThumb" src="${escapeHtml(cover)}" alt="${escapeHtml(name)}"/>
          <div class="gameName">${escapeHtml(name)}</div>
        </div>
      `;
      grid.querySelector(".gameCard").onclick = () => setChosenGame(name);
      toast("Jeu trouv√©", name, "good");
    }else{
      grid.innerHTML = "<div class='muted'>Aucun r√©sultat fiable. Essaie un autre nom.</div>";
    }
  }catch(e){
    grid.innerHTML = `<div class='muted'>‚õî ${escapeHtml(e.message)}</div>`;
  }
}

/* =========================================================
   SOCKET CHAT (stable, single instance)
========================================================= */
let socket = null;

function initSocket(){
  try{
    socket = io({
      transports: ["websocket"],
      upgrade: false,
      reconnection: true,
      reconnectionAttempts: 8,
      reconnectionDelay: 600
    });

    const st = $("#socketState");
    const log = $("#chatLog");

    const addLine = (txt) => {
      const p = document.createElement("div");
      p.className = "line";
      p.textContent = txt;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    };

    socket.on("connect", () => {
      st.textContent = "Socket: connect√© ‚úÖ";
      addLine("üîå connect√©.");
    });

    socket.on("disconnect", (reason) => {
      st.textContent = "Socket: d√©connect√©‚Ä¶";
      addLine("üîå d√©connect√© (" + reason + ")");
    });

    socket.on("chat message", (msg) => {
      const user = msg?.user || "Anon";
      const text = msg?.text || "";
      addLine(`${user}: ${text}`);
    });

    $("#chatSend").onclick = () => {
      const user = ($("#chatUser").value||"Viewer").trim().slice(0,40);
      const text = ($("#chatText").value||"").trim().slice(0,500);
      if(!text) return;
      socket.emit("chat message", { user, text });
      $("#chatText").value = "";
    };

    $("#chatText").addEventListener("keydown", (e)=>{
      if(e.key==="Enter") $("#chatSend").click();
    });

  }catch(e){
    $("#socketState").textContent = "Socket: indisponible";
  }
}

/* =========================================================
   EVENTS / BOOT
========================================================= */
$("#btnAuth").onclick = () => {
  // OAuth popup
  window.open("/twitch_auth_start", "twitch_auth", "width=520,height=720");
};

$("#btnLogout").onclick = async () => {
  try{
    await api("/twitch_logout", { method:"POST", body:"{}" });
    toast("D√©connexion", "OK", "good");
    await loadTwitchUserStatus();
  }catch(e){
    toast("D√©connexion", e.message, "bad");
  }
};

$("#btnPrev").onclick = () => cycle("prev");
$("#btnNext").onclick = () => cycle("next");
$("#btnBoost").onclick = boostCurrent;

$("#btnRefreshGlobal").onclick = loadGlobalIntraday;
$("#globalHours").onchange = loadGlobalIntraday;

$("#btnLoadChannel").onclick = loadChannelIntraday;
$("#channelHours").onchange = loadChannelIntraday;

$("#btnAnalyzeGame").onclick = analyzeGame;

$("#btnLoadAlerts").onclick = loadAlerts;
$("#btnGenerateAlerts").onclick = generateAlerts;

$("#btnReco").onclick = loadReco;
$("#btnCostream").onclick = loadCostream;

$("#btnRaid").onclick = () => raidOrLucky($("#raidMax").value, false);

$("#btnLucky").onclick = () => {
  const mv = $("#maxViewersSelect").value || 100;
  raidOrLucky(mv, true);
};

$("#btnChooseGame").onclick = openGameModal;
$("#btnCloseModal").onclick = closeGameModal;
$("#gameModal").addEventListener("click", (e)=>{
  if(e.target === $("#gameModal")) closeGameModal();
});
$("#btnGameSearch").onclick = searchGameInModal;
$("#gameSearch").addEventListener("keydown",(e)=>{ if(e.key==="Enter") searchGameInModal(); });

/* Auto refresh of stream_info */
setInterval(refreshStreamInfo, 35_000);

/* Auto refresh global + channel */
setInterval(()=>{ loadGlobalIntraday().catch(()=>{}); }, 90_000);

/* Boot */
(async function boot(){
  await loadFirebaseStatus();
  await loadTwitchUserStatus();
  initSocket();

  // Charge tendance globale direct
  loadGlobalIntraday().catch(()=>{});

  // Propose un stream par d√©faut (petit streamer) d√®s l'ouverture
  loadDefaultStream().catch(()=>{});

  // UI hint game
  $("#chosenGameLabel").textContent = currentGameName || "‚Äî";
})();
</script>
</body>
</html>
