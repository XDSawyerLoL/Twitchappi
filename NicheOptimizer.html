<div id="niche-optimizer-main" style="all:initial;display:block;max-width:550px;margin:20px auto;padding:10px;">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap');
        /* Styles de base pour le conteneur principal */
        #niche-optimizer-main {
            font-family: 'Inter', Arial, sans-serif;
            color: #fff;
        }
        .card {
            background: #1a1a1a;
            border: 1px solid #2e2e2e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,.4);
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: #ff9900;
            margin: 0 0 10px;
            text-align: center;
        }
        h2 {
            font-size: 14px;
            font-weight: 700;
            margin: 15px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #333;
            color: #22c7ef;
        }
        button {
            cursor: pointer;
            border: 0;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 700;
            transition: all .2s ease;
            letter-spacing: .5px;
            text-transform: uppercase;
            font-size: 13px;
            width: 100%;
            margin-top: 10px;
        }
        .btn-analyze {
            background: #ff9900;
            color: #000;
            box-shadow: 0 0 8px rgba(255,153,0,.6);
        }
        .btn-analyze:not(:disabled):hover {
            background: #e68a00;
            transform: translateY(-2px);
        }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #0d0d0d;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            border-color: #ff9900;
            outline: none;
        }
        .flex-gap-8 {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .report-wrapper {
            background: #0d0d0d;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
            margin-top: 20px;
        }
        .critique-loading {
            text-align: center;
            color: #ff9900;
            font-weight: 600;
            padding: 10px 0;
        }
        .error { color: #e34a64; font-weight: 700; }
        .success { color: #59d682; font-weight: 700; }
        .info-chip {
            font-size: 11px;
            margin-bottom: 10px;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #f90;
            display: block;
        }
        /* Styles pour le rapport structur√© */
        .report-section {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid #ff9900;
            background: #141414;
            border-radius: 4px;
        }
        .report-section strong {
            display: block;
            color: #22c7ef;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .time-slot {
            margin-top: 8px;
            padding: 5px 0;
            border-top: 1px dotted #333;
        }
        .time-slot:first-child {
            border-top: none;
        }
        .time-slot-detail {
            font-size: 12px;
            color: #ccc;
        }
    </style>

    <div class="card">
        <h1><span style="font-size:1.2em; vertical-align:middle;">üìà</span> OPTIMISATION DE NICHE</h1>
        <div style="color:#9aa3a8;font-size:12px;margin-bottom:15px;text-align:center;">Analyse de Concurrence bas√©e sur l'IA (Gemini)</div>

        <div id="gemini-key-diagnostic" class="info-chip">
            Statut Cl√© API Gemini: <span id="key-status" style="font-weight:700;">Diagnostic en cours...</span>
        </div>

        <form id="form-niche-game" style="margin-top: 20px;">
            <h2>D√âFINIR LE JEU CIBLE</h2>
            <div class="flex-gap-8">
                <input id="input-niche-game" type="text" placeholder="Entrez le jeu (ex: Elden Ring ou Baldur's Gate 3)">
                <button type="submit" id="btn-niche-set" class="btn-analyze" style="min-width: 100px;">D√âFINIR</button>
            </div>
        </form>

        <div id="optimizer-controls" style="margin-top: 20px;">
            <button id="btn-niche-analyze-snippet" class="btn-analyze" disabled>
                Veuillez D√âFINIR UN JEU pour l'analyse
            </button>
        </div>
        
        <div id="optimizer-result" style="margin-top: 15px;" class="hidden">
            <div class="report-wrapper">
                <h3 style="font-size:18px;color:#ff9900;font-family:'Orbitron',sans-serif;margin-top:0; border-bottom: none;">
                    üéÆ Rapport de Niche pour <span id="optimized-game-name" style="color:#fff;">[Jeu Cible]</span>
                </h3>
                <div id="optimizer-content" style="color:#fff; font-size: 13px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
(async function(){

/* ============================ 1. CONFIG ============================ */
const MAX_RETRIES = 3; // Pour les appels API
let nicheGameName = null;
const API_BASE_URL = window.location.origin;

/* ============================ 2. UTILS POUR DOM ============================ */
const $ = sel => document.querySelector(sel);

// Formatage des scores de comp√©tition pour l'affichage
function formatCompetitionPressure(pressure) {
    switch(pressure.toLowerCase()) {
        case 'faible':
            return `<span style="color: #59d682; font-weight: 700;">${pressure.toUpperCase()}</span>`; // Vert
        case 'moyenne':
            return `<span style="color: #ff9900; font-weight: 700;">${pressure.toUpperCase()}</span>`; // Orange
        case '√©lev√©e':
            return `<span style="color: #e34a64; font-weight: 700;">${pressure.toUpperCase()}</span>`; // Rouge
        default:
            return pressure;
    }
}

// Fonction de rendu du rapport
function renderReport(report) {
    let html = `
        <div class="report-section">
            <strong>Pression Concurrentielle :</strong>
            <p style="font-size: 16px; margin: 0 0 5px;">${formatCompetitionPressure(report.competition_pressure)}</p>
            <p style="font-size: 12px; color: #aaa;">${report.competition_details}</p>
        </div>

        <div class="report-section">
            <strong>Cr√©neaux Horaires Optimaux (CET) :</strong>
            ${report.optimal_time_slots.map(slot => `
                <div class="time-slot">
                    <p style="margin: 0;">
                        üìÖ **${slot.day.toUpperCase()}** - üïí ${slot.time}
                    </p>
                    <p class="time-slot-detail">
                        ${slot.reason}
                    </p>
                </div>
            `).join('')}
        </div>

        <div class="report-section" style="border-left: 3px solid #22c7ef;">
            <strong>Recommandation Strat√©gique Cl√© :</strong>
            <p style="margin: 0; font-style: italic;">
                ${report.key_recommendation}
            </p>
        </div>
    `;
    optimizerContent.innerHTML = html;
}


/* ============================ 3. GEMINI API HANDLERS (Niche Optimization) ============================ */

const btnNicheAnalyze = $("#btn-niche-analyze-snippet");
const inputNicheGame = $("#input-niche-game");
const btnNicheSet = $("#btn-niche-set"); 
const optimizerResult = $("#optimizer-result");
const optimizedGameName = $("#optimized-game-name");
const optimizerContent = $("#optimizer-content");
const keyStatusDisplay = $("#key-status");

// 3.1 Diagnostic de cl√© API (utilise uniquement les variables d'environnement s√©curis√©es)
function diagnoseApiKey() {
    let finalApiKey = "";
    
    // Priorit√© 1: Cl√© d'API inject√©e (standard pour Gemini)
    if (typeof __api_key !== 'undefined' && String(__api_key).trim().length > 0) {
        finalApiKey = String(__api_key).trim();
    } 
    // Priorit√© 2: Cl√© d'authentification (fallback si __api_key n'est pas utilis√©)
    else if (typeof __initial_auth_token !== 'undefined' && String(__initial_auth_token).trim().length > 0) {
        // NOTE: Utiliser un token d'auth comme cl√© API est un fallback non standard pour les environnements qui le permettent.
        finalApiKey = String(__initial_auth_token).trim();
    } 
    // Priorit√© 3: Variable globale "apyKey" (si inject√©e par Render ou autre)
    else if (typeof apyKey !== 'undefined' && typeof apyKey === 'string' && apyKey.trim().length > 5) {
        finalApiKey = apyKey.trim();
    }

    if (finalApiKey && finalApiKey.length > 5) {
        keyStatusDisplay.textContent = `OK (Cl√© d√©tect√©e. Longueur: ${finalApiKey.length})`;
        keyStatusDisplay.style.color = '#59d682'; // Vert
        return finalApiKey;
    } else {
        keyStatusDisplay.textContent = `ABSENTE (‚ö†Ô∏è Cl√© introuvable ou trop courte)`;
        keyStatusDisplay.style.color = '#e34a64'; // Rouge
        return null;
    }
}
const apiKey = diagnoseApiKey();


// 3.2 Fonction pour d√©finir le jeu cible de niche
btnNicheSet.addEventListener('click', (e) => {
    e.preventDefault();
    const name = inputNicheGame.value.trim();
    if (name) {
        nicheGameName = name;
        
        // Activation du bouton d'analyse
        btnNicheAnalyze.disabled = false;
        btnNicheAnalyze.style.backgroundColor = '#ff9900';
        btnNicheAnalyze.style.color = '#000';
        btnNicheAnalyze.textContent = `Analyser la Niche pour ${nicheGameName}`;
        
        optimizedGameName.textContent = nicheGameName;
        // Masquer le r√©sultat pr√©c√©dent
        optimizerResult.classList.add('hidden'); 
    }
});


// 3.3 Fonction pour lancer l'analyse de Niche (via Gemini API)
async function runNicheOptimization() {
    if (!nicheGameName) {
        optimizerContent.innerHTML = `<div class="error">Veuillez d√©finir un jeu cible en premier.</div>`;
        return;
    }
    if (!apiKey) {
        optimizerContent.innerHTML = `<div class="error">‚ùå ERREUR FATALE: Cl√© API Gemini non d√©tect√©e. L'analyse ne peut pas d√©marrer.</div>`;
        return;
    }


    optimizerResult.classList.remove("hidden");
    optimizerContent.innerHTML = `<div class="critique-loading">‚ü≥ Analyse de la concurrence pour ${nicheGameName} via l'API Gemini...</div>`;
    btnNicheAnalyze.disabled = true;
    btnNicheAnalyze.textContent = `ANALYSE EN COURS...`;

    let report = null;
    let rawError = "Inconnu. Aucune r√©ponse re√ßue.";
    
    // Le code du backend inclut d√©j√† l'Exponential Backoff
    const url = `${API_BASE_URL}/niche_analysis`;
    const payload = { gameName: nicheGameName };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const responseData = await response.json();
        
        if (response.ok) {
            report = responseData;
        } else {
            rawError = responseData.message || responseData.diagnostic || 'Erreur serveur non sp√©cifi√©e.';
        }

    } catch (error) {
        rawError = `Erreur r√©seau: ${error.message}`;
    }


    // --- 4. Affichage du R√©sultat ---

    if (report && report.optimal_time_slots) {
        // Le rapport structur√© est bon
        renderReport(report);
        btnNicheAnalyze.style.backgroundColor = '#59d682';
        btnNicheAnalyze.textContent = `‚úÖ ANALYSE TERMIN√âE`;
    } else {
        // Erreur ou √©chec du parsing
        optimizerContent.innerHTML = `
            <div class="error">
                <strong>Analyse √âchou√©e ‚ùå</strong>
                <p>Le service IA n'a pas pu g√©n√©rer un rapport structur√©.</p>
                <p style="font-size: 11px; margin-top: 5px;">D√©tail de l'erreur: ${rawError}</p>
            </div>
        `;
        btnNicheAnalyze.style.backgroundColor = '#e34a64';
        btnNicheAnalyze.textContent = `‚ùå √âCHEC DE L'ANALYSE`;
    }
    
    // R√©activation du bouton apr√®s un court d√©lai pour l'utilisateur
    setTimeout(() => {
        btnNicheAnalyze.disabled = false;
        btnNicheAnalyze.style.backgroundColor = '#ff9900';
        btnNicheAnalyze.textContent = `Analyser la Niche pour ${nicheGameName}`;
    }, 3000);
}

// 3.4 √âcouteur pour lancer l'analyse
btnNicheAnalyze.addEventListener('click', runNicheOptimization);

})();
});
</script>
