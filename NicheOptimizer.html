<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub - COCKPIT MODE (V15 - Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- VOTRE CSS ORIGINAL (INTACT) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-ai-action: #e34a64; 
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
            --shadow-pink: 0 0 15px rgba(255, 0, 153, 0.4);
            --shadow-blue: 0 0 15px rgba(34, 199, 239, 0.4);
            --shadow-niche: 0 0 15px rgba(89, 214, 130, 0.4);
            --shadow-repurpose: 0 0 15px rgba(153, 51, 255, 0.4);
            --shadow-action: 0 0 15px rgba(227, 74, 100, 0.4);
            --shadow-growth: 0 0 15px rgba(255, 204, 0, 0.4);
        }

        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { all: initial; display: block; max-width: 1400px; margin: 20px auto; padding: 10px; font-family: 'Inter', sans-serif; color: #fff; }
        
        h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: var(--color-primary-pink); margin-bottom: 5px; text-align: center; text-shadow: 0 0 5px var(--color-primary-pink), 0 0 15px rgba(255, 0, 153, 0.5); }
        .h1-blue-accent { color: var(--color-secondary-blue); }
        .subtitle-center { color: var(--color-text-dimmed); font-size: 12px; margin-bottom: 15px; text-align: center; letter-spacing: 1px; }
        
        .tab-btn { font-family: 'Orbitron', sans-serif; padding: 12px 15px; background: var(--color-bg-light); border: 1px solid var(--color-border-medium); border-bottom: none; color: var(--color-text-dimmed); cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; flex: 1; text-align: center; font-size: 12px; }
        .tab-btn.active { background: var(--color-bg-medium); color: #fff; border-top: 3px solid var(--color-primary-pink); font-weight: bold; box-shadow: var(--shadow-pink); z-index: 10; }

        .player-wrapper { margin-bottom: 20px; padding: 15px; background: var(--color-bg-medium); border-radius: 12px; border: 1px solid var(--color-border-dark); box-shadow: var(--shadow-blue); }
        #twitch-embed { width: 100%; height: 500px; border-radius: 8px; overflow: hidden; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .dashboard-box { background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 15px; min-height: 250px; }
        
        .btn-primary { background: var(--color-primary-pink); color: #fff; border: 0; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; transition: all 0.2s; }
        .action-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-medium); background: var(--color-bg-dark); color: #fff; }

        .followed-stream-item { width: calc(20% - 12px); min-width: 150px; padding: 10px; background: var(--color-bg-light); border-radius: 8px; border: 1px solid var(--color-border-dark); cursor: pointer; text-align: center; }
        .followed-stream-item img { width: 100%; border-radius: 4px; margin-bottom: 5px; }

        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid var(--color-border-dark); border-radius: 10px; padding: 20px; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1><span class="h1-blue-accent">STREAMER</span> HUB V15</h1>
    <div class="subtitle-center">Cockpit UnifiÃ© â€¢ Intelligence Artificielle</div>

    <div class="tabs-nav-container">
        <div class="flex flex-wrap gap-1">
            <button class="tab-btn active" data-tab-id="tab-followed" onclick="openTab('tab-followed')">ðŸ”‘ MON FIL SUIVI</button> 
            <button class="tab-btn" data-tab-id="tab-dashboard" onclick="openTab('tab-dashboard')">ðŸ“Š DASHBOARD 360Â°</button>
            <button class="tab-btn" data-tab-id="tab-boost" onclick="openTab('tab-boost')">âš¡ BOOST</button>
            <button class="tab-btn" data-tab-id="tab-raid" onclick="openTab('tab-raid')">ðŸ’¥ RAID</button>
        </div>
    </div>

    <div class="player-wrapper">
        <div id="twitch-embed"></div>
    </div>

    <div id="content-area">
        <div id="tab-followed" class="tab-content active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:var(--color-primary-pink);">ðŸ”´ Vos ChaÃ®nes Suivies LIVE</h3>
                <button id="btn-twitch-login" class="btn-primary" style="background:#6441a5;">ðŸ”’ CONNEXION TWITCH</button>
            </div>
            <div id="followed-streams-list" class="flex flex-wrap gap-4"></div>
        </div>

        <div id="tab-dashboard" class="tab-content">...</div>
        <div id="tab-boost" class="tab-content">...</div>
        <div id="tab-raid" class="tab-content">...</div>
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    let isConnected = false;
    let authWindow = null;

    function openTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-tab-id="${tabId}"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
    }

    // --- REPARATION DU POPUP ET DECONNEXION ---
    async function startAuth() {
        // LOGIQUE DE DÃ‰CONNEXION
        if (isConnected) {
            if (confirm("Voulez-vous vous dÃ©connecter ?")) {
                try {
                    await fetch(`${API_BASE}/twitch_logout`, { method: 'POST' });
                    checkAuthStatus();
                    document.getElementById('followed-streams-list').innerHTML = '';
                } catch (e) { console.error(e); }
            }
            return;
        }

        // LOGIQUE D'OUVERTURE POPUP
        const authUrl = `${API_BASE}/twitch_auth_start`;
        const width = 500, height = 650;
        const left = (window.screen.width / 2) - (width / 2);
        const top = (window.screen.height / 2) - (height / 2);
        
        authWindow = window.open(authUrl, 'twitch_login_popup', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);

        // SURVEILLANCE DE FERMETURE (REPARE LE POPUP)
        const checkChild = setInterval(() => {
            if (!authWindow || authWindow.closed) {
                clearInterval(checkChild);
                checkAuthStatus(); // Actualise la page d'origine
            }
        }, 1000);
    }

    async function checkAuthStatus() {
        const loginBtn = document.getElementById('btn-twitch-login');
        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();
            isConnected = data.is_connected;
            
            if (isConnected) {
                loginBtn.innerHTML = `âŒ DECONNEXION (${data.display_name})`;
                loginBtn.style.background = '#e34a64'; 
                loadFollowedStreams();
            } else {
                loginBtn.innerHTML = 'ðŸ”’ CONNEXION TWITCH';
                loginBtn.style.background = '#6441a5';
            }
        } catch (e) { isConnected = false; }
    }

    async function loadFollowedStreams() {
        if (!isConnected) return;
        const list = document.getElementById('followed-streams-list');
        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();
            if (data.success) {
                list.innerHTML = data.streams.map(s => `
                    <div class="followed-stream-item" onclick="launchPlayer('${s.user_login}')">
                        <img src="${s.thumbnail_url.replace('{width}','320').replace('{height}','180')}">
                        <div>${s.user_name}</div>
                    </div>
                `).join('');
            }
        } catch(e) { console.error(e); }
    }

    function launchPlayer(channel) {
        document.getElementById('twitch-embed').innerHTML = '';
        new Twitch.Embed("twitch-embed", {
            width: "100%", height: "100%", channel: channel,
            parent: [window.location.hostname]
        });
    }

    document.getElementById('btn-twitch-login').onclick = startAuth;
    window.onload = () => { checkAuthStatus(); };
</script>
</body>
</html>
