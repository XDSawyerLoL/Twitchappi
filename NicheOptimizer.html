<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Streamer Hub ‚Äì Analytics & D√©couverte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #0e0e10;
      color: #f1f1f1;
    }

    header {
      padding: 12px 20px;
      background: #18181b;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
    }

    main {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 56px);
    }

    /* ===== PLAYER ===== */
    #player-zone {
      background: #000;
      padding: 10px;
    }

    #player-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      align-items: center;
    }

    button {
      background: #9147ff;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    button.secondary {
      background: #2a2a2d;
    }

    iframe {
      width: 100%;
      height: 420px;
      border-radius: 10px;
      border: none;
    }

    /* ===== TABS ===== */
    #tabs {
      display: flex;
      background: #18181b;
    }

    #tabs button {
      flex: 1;
      background: transparent;
      border-bottom: 3px solid transparent;
    }

    #tabs button.active {
      border-color: #9147ff;
      background: #1f1f23;
    }

    .tab {
      display: none;
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .tab.active {
      display: block;
    }

    /* ===== CARDS ===== */
    .card {
      background: #1f1f23;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .help {
      color: #aaa;
      font-size: 13px;
      cursor: help;
      margin-left: 6px;
    }

    /* ===== MODAL ===== */
    #game-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      z-index: 1000;
      padding: 30px;
    }

    #game-modal h2 {
      margin-top: 0;
    }

    #games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 14px;
    }

    .game-card {
      cursor: pointer;
      text-align: center;
    }

    .game-card img {
      width: 100%;
      border-radius: 8px;
    }

    .game-card span {
      font-size: 13px;
      display: block;
      margin-top: 6px;
    }
  </style>
</head>

<body>

<header>
  <h1>üé• Streamer Hub ‚Äì Analytics & D√©couverte</h1>
  <button class="secondary" onclick="openGameModal()">üéÆ Choisir un jeu</button>
</header>

<main>

  <!-- PLAYER -->
  <section id="player-zone">
    <div id="player-controls">
      <button onclick="lucky()">üé≤ J‚Äôai de la chance</button>
      <span id="current-info"></span>
    </div>

    <iframe id="twitch-player"></iframe>
  </section>

  <!-- TABS -->
  <div id="tabs">
    <button class="active" onclick="openTab('analytics')">üìä Analytics</button>
    <button onclick="openTab('niche')">üéØ Niche</button>
    <button onclick="openTab('alerts')">üö® Alertes</button>
  </div>

  <!-- ANALYTICS -->
  <div id="analytics" class="tab active">
    <div class="card">
      <h3>
        Audience en temps r√©el
        <span class="help" title="√âvolution du nombre de viewers sur la journ√©e. Permet de voir les heures fortes et faibles.">‚ùî</span>
      </h3>
      <canvas id="chartViewers"></canvas>
    </div>

    <div class="card" id="kpis"></div>
  </div>

  <!-- NICHE -->
  <div id="niche" class="tab">
    <div class="card" id="niche-content">
      S√©lectionne un jeu pour analyser la niche.
    </div>
  </div>

  <!-- ALERTS -->
  <div id="alerts" class="tab">
    <div class="card" id="alerts-content">
      Aucune alerte pour le moment.
    </div>
  </div>

</main>

<!-- MODAL -->
<div id="game-modal">
  <h2>Choisis un jeu</h2>
  <div id="games-grid"></div>
  <br />
  <button class="secondary" onclick="closeGameModal()">Fermer</button>
</div>

<script>
/* ======================
   STATE
====================== */
let currentChannel = null;
let currentGame = null;

/* ======================
   TABS
====================== */
function openTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
}

/* ======================
   PLAYER
====================== */
function loadPlayer(channel) {
  currentChannel = channel;
  document.getElementById('current-info').innerText = `Cha√Æne : ${channel}`;
  document.getElementById('twitch-player').src =
    `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}`;
  loadAnalytics(channel);
}

/* ======================
   LUCKY (0‚Äì100 viewers)
====================== */
async function lucky() {
  const res = await fetch('/get_default_stream');
  const data = await res.json();
  if (data.success) loadPlayer(data.channel);
}

/* ======================
   ANALYTICS
====================== */
async function loadAnalytics(login) {
  const res = await fetch(`/api/analytics/channel_intraday_by_login/${login}`);
  const data = await res.json();
  if (!data.success) return;

  const ctx = document.getElementById('chartViewers').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.series.labels,
      datasets: [{
        label: 'Viewers',
        data: data.series.values,
        borderColor: '#9147ff'
      }]
    }
  });

  document.getElementById('kpis').innerHTML = `
    <strong>Moyenne viewers :</strong> ${data.kpis.avg_viewers}
    <span class="help" title="Nombre moyen de viewers sur la p√©riode. Indique ta base r√©elle.">‚ùî</span><br>
    <strong>Pic viewers :</strong> ${data.kpis.peak_viewers}
    <span class="help" title="Maximum atteint. Sert √† comprendre ce qui a fonctionn√©.">‚ùî</span><br>
    <strong>Croissance :</strong> ${data.kpis.growth_percent} %
    <span class="help" title="Progression ou perte d‚Äôaudience. Indicateur cl√© de momentum.">‚ùî</span><br>
    <strong>Growth score :</strong> ${data.kpis.growth_score} / 100
    <span class="help" title="Score propri√©taire combinant r√©gularit√©, croissance et stabilit√©.">‚ùî</span>
  `;
}

/* ======================
   GAMES MODAL
====================== */
async function openGameModal() {
  document.getElementById('game-modal').style.display = 'block';
  const res = await fetch('/api/stats/top_games');
  const data = await res.json();
  const grid = document.getElementById('games-grid');
  grid.innerHTML = '';
  data.games.forEach(g => {
    const div = document.createElement('div');
    div.className = 'game-card';
    div.innerHTML = `<img src="${g.box_art_url}"><span>${g.name}</span>`;
    div.onclick = () => {
      currentGame = g.name;
      closeGameModal();
    };
    grid.appendChild(div);
  });
}

function closeGameModal() {
  document.getElementById('game-modal').style.display = 'none';
}
</script>

</body>
</html>
