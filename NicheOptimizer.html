<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustPlayer Hub V51 - VISUAL PRIME</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0a0a0a;
            --primary: #ff0099;   /* Rose Cyber */
            --secondary: #00f2ea; /* Bleu Néon */
            --accent: #ffd700;    /* Or */
            --text-main: #e0e0e0;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        /* SCROLLBAR INVISIBLE MAIS FONCTIONNELLE */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- CAROUSEL (TOP) --- */
        .carousel-track { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scroll-behavior: smooth; }
        .stream-card { 
            flex: 0 0 280px; height: 160px;
            background: #111; border: 1px solid #222; border-radius: 12px; 
            overflow: hidden; position: relative; cursor: pointer; transition: 0.3s;
        }
        .stream-card:hover { border-color: var(--secondary); transform: scale(1.02); box-shadow: 0 0 20px rgba(0, 242, 234, 0.2); }
        .stream-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: 0.3s; }
        .stream-card:hover img { opacity: 1; }
        .card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, black, transparent); padding: 10px; }
        
        /* --- MAIN LAYOUT --- */
        .glass-panel { background: #0f0f11; border: 1px solid #1f1f1f; border-radius: 8px; }
        
        /* --- TABS SIDEBAR --- */
        .tab-btn { flex: 1; padding: 12px; text-align: center; background: #080808; color: #666; font-family: 'Orbitron'; font-size: 11px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn:hover { color: white; background: #111; }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: #151515; text-shadow: 0 0 8px rgba(0,242,234,0.4); }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; }

        /* --- STATS TRACKER VISUAL --- */
        .stat-box { background: #151515; border-radius: 6px; padding: 15px; border-left: 3px solid #333; margin-bottom: 10px; }
        .stat-box.blue { border-left-color: var(--secondary); }
        .stat-box.pink { border-left-color: var(--primary); }
        .stat-val { font-family: 'Orbitron'; font-size: 24px; font-weight: bold; color: white; }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* --- SCANNER --- */
        .input-cyber { background: #111; border: 1px solid #333; color: white; padding: 10px; width: 100%; border-radius: 4px; outline: none; font-family: 'Orbitron'; font-size: 12px; }
        .input-cyber:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(0,242,234,0.2); }
        .btn-cyber { background: var(--secondary); color: black; font-weight: bold; padding: 10px; border-radius: 4px; width: 100%; font-family: 'Orbitron'; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-cyber:hover { background: white; box-shadow: 0 0 15px var(--secondary); }

    </style>
</head>
<body class="h-screen flex flex-col p-4">

    <header class="flex justify-between items-end mb-6 pb-2 border-b border-[#222]">
        <div>
            <h1 class="text-3xl font-orbitron italic"><span class="text-[#00f2ea]">STREAMER</span> HUB <span class="bg-[#ff0099] text-white text-xs px-2 py-0.5 rounded not-italic ml-2">V51</span></h1>
        </div>
        <div>
             <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-6 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron">
                <i class="fab fa-twitch"></i> CONNEXION
            </button>
            <div id="user-display" class="hidden flex items-center gap-3">
                <span id="username" class="font-bold text-[#00f2ea]">Guest</span>
                <button onclick="logout()" class="text-gray-500 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>

    <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xs font-orbitron text-gray-500"><i class="fas fa-satellite-dish mr-2 text-[#ff0099]"></i>LIVE FEED</h3>
            <button onclick="loadFollowed()" class="text-xs text-[#00f2ea] hover:text-white"><i class="fas fa-sync"></i> Refresh</button>
        </div>
        <div id="carousel" class="carousel-track hide-scrollbar">
            <div class="w-full text-center py-8 text-gray-600 border border-dashed border-gray-800 rounded">
                Connectez-vous pour voir vos chaînes.
            </div>
        </div>
    </div>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
        
        <div class="lg:col-span-8 flex flex-col gap-4">
            <div class="glass-panel flex-grow relative overflow-hidden flex flex-col">
                <div class="bg-black p-2 flex justify-between items-center border-b border-[#222]">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                        <span id="current-channel" class="font-orbitron text-[#00f2ea] text-sm">LOADING...</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="cycle('prev')" class="bg-[#222] hover:bg-[#333] text-white px-3 py-1 rounded text-xs"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="cycle('next')" class="bg-[#222] hover:bg-[#333] text-white px-3 py-1 rounded text-xs"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="video-embed" class="flex-grow bg-black relative"></div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col glass-panel overflow-hidden h-full max-h-[600px] lg:max-h-auto">
            
            <div class="flex border-b border-[#222]">
                <button class="tab-btn active" onclick="switchTab('tchat')">TCHAT</button>
                <button class="tab-btn" onclick="switchTab('stats')">STATS</button>
                <button class="tab-btn" onclick="switchTab('tools')">OUTILS</button>
            </div>

            <div id="tab-tchat" class="tab-content active h-full">
                <iframe id="chat-frame" src="" width="100%" height="100%" frameborder="0"></iframe>
            </div>

            <div id="tab-stats" class="tab-content p-4 overflow-y-auto">
                <h3 class="font-orbitron text-[#00f2ea] mb-4 text-center">ANALYSE GLOBALE</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="stat-box blue">
                        <div id="stat-viewers" class="stat-val">--</div>
                        <div class="stat-label">Total Viewers</div>
                    </div>
                    <div class="stat-box pink">
                        <div id="stat-channels" class="stat-val">--</div>
                        <div class="stat-label">Chaînes Actives</div>
                    </div>
                </div>

                <div class="bg-[#111] p-3 rounded flex items-center gap-4 mb-6 border border-[#222]">
                    <div class="text-3xl text-[#ffd700]"><i class="fas fa-trophy"></i></div>
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase">Top Catégorie</div>
                        <div id="stat-game" class="text-white font-bold truncate">Chargement...</div>
                    </div>
                </div>

                <div class="h-40 w-full bg-[#111] rounded p-2 border border-[#222]">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <div id="tab-tools" class="tab-content p-5 space-y-6 overflow-y-auto">
                
                <div>
                    <h3 class="text-[#00f2ea] font-orbitron text-sm mb-2"><i class="fas fa-search mr-2"></i>SCANNER IA</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="scan-input" type="text" placeholder="Pseudo (ex: Kamet0)..." class="input-cyber">
                        <button onclick="runScan()" class="bg-[#222] text-white px-3 rounded hover:bg-[#333]"><i class="fas fa-arrow-right"></i></button>
                    </div>
                    <div id="scan-res" class="hidden bg-[#111] p-3 rounded border border-[#222]">
                        <div class="flex items-center gap-3 mb-2">
                            <img id="scan-img" src="" class="w-10 h-10 rounded-full border border-[#00f2ea]">
                            <div>
                                <div id="scan-name" class="font-bold text-white text-sm">--</div>
                                <div id="scan-score" class="text-[10px] text-[#00f2ea]">Score: --</div>
                            </div>
                        </div>
                        <div id="scan-ai" class="text-[10px] text-gray-400 leading-relaxed max-h-32 overflow-y-auto"></div>
                    </div>
                </div>

                <hr class="border-[#222]">

                <div>
                    <h3 class="text-[#ff0099] font-orbitron text-sm mb-2"><i class="fas fa-bolt mr-2"></i>BOOST</h3>
                    <input id="boost-input" type="text" placeholder="Chaîne à propulser..." class="input-cyber mb-2">
                    <button onclick="activateBoost()" class="btn-cyber" style="background:#ff0099; color:white;">ACTIVER</button>
                    <div id="boost-msg" class="text-center text-[10px] mt-2 text-gray-500"></div>
                </div>

            </div>

        </div>
    </div>

    <script>
        const DOMAINS = ["justplayer.fr", "www.justplayer.fr", "localhost", "127.0.0.1"];
        let player;
        let currentChannel = "twitch";

        // --- INIT ---
        window.onload = () => {
            // HTTPS Force (Twitch requirement)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                location.replace(`https:${location.href.substring(location.protocol.length)}`);
            }

            checkAuth();
            initPlayer(); // Lance le player + chat
            loadStats();  // Lance les stats (avec fix visuel)

            // Callback Auth
            window.addEventListener("message", (e) => {
                if(e.data === "auth_success") location.reload();
            });
        };

        // --- TABS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            
            // Trouver le bouton qui a l'onclick correspondant (astuce simple)
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => {
                if(b.innerText.toLowerCase().includes(id) || (id === 'tchat' && b.innerText === 'TCHAT') || (id === 'tools' && b.innerText === 'OUTILS')) {
                    b.classList.add('active');
                }
            });
        }

        // --- PLAYER & CHAT FIX ---
        async function initPlayer() {
            try {
                // 1. Récupérer la chaîne (Boost ou Auto)
                const res = await fetch('/get_default_stream');
                const data = await res.json();
                const channel = data.success ? data.channel : "twitch";
                currentChannel = channel;

                document.getElementById('current-channel').innerText = channel.toUpperCase();

                // 2. Lancer la Vidéo
                document.getElementById('video-embed').innerHTML = "";
                const options = { width: "100%", height: "100%", channel: channel, layout: "video", parent: DOMAINS };
                player = new Twitch.Embed("video-embed", options);

                // 3. Lancer le Chat (Iframe manuelle pour éviter les bugs)
                updateChat(channel);

            } catch(e) { console.error("Player Init Error", e); }
        }

        function updateChat(channel) {
            const parents = DOMAINS.map(p => `parent=${p}`).join('&');
            // darkpopout est important pour le thème sombre
            const url = `https://www.twitch.tv/embed/${channel}/chat?${parents}&darkpopout`;
            const frame = document.getElementById('chat-frame');
            if(frame) frame.src = url;
        }

        async function cycle(dir) {
            try {
                const res = await fetch('/cycle_stream', { 
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({direction:dir}) 
                });
                const data = await res.json();
                if(data.success) {
                    currentChannel = data.channel;
                    player.setChannel(currentChannel);
                    updateChat(currentChannel);
                    document.getElementById('current-channel').innerText = currentChannel.toUpperCase();
                }
            } catch(e) {}
        }

        // --- STATS TRACKER (VISUAL FIX) ---
        async function loadStats() {
            try {
                const res = await fetch('/api/stats/global');
                const data = await res.json();

                if(data.success) {
                    // Remplissage Chiffres
                    document.getElementById('stat-viewers').innerText = Number(data.total_viewers).toLocaleString();
                    document.getElementById('stat-channels').innerText = data.total_channels;
                    document.getElementById('stat-game').innerText = data.top_game_name;

                    // Graphique
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.history.live.labels,
                            datasets: [{
                                label: 'Viewers',
                                data: data.history.live.values,
                                borderColor: '#00f2ea',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: 'rgba(0, 242, 234, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false, grid: { display: false } } }
                        }
                    });
                }
            } catch(e) { console.log("Stats error", e); }
        }

        // --- CAROUSEL ---
        async function loadFollowed() {
            const c = document.getElementById('carousel');
            c.innerHTML = '<div class="text-center w-full text-gray-500 py-6"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch('/followed_streams');
                const data = await res.json();
                if(data.success && data.streams.length > 0) {
                    c.innerHTML = "";
                    data.streams.forEach(s => {
                        const thumb = s.thumbnail_url.replace('{width}', '320').replace('{height}', '180');
                        c.innerHTML += `
                            <div class="stream-card flex-shrink-0" onclick="player.setChannel('${s.user_login}'); updateChat('${s.user_login}');">
                                <img src="${thumb}">
                                <div class="card-overlay">
                                    <div class="text-white font-bold text-sm truncate">${s.user_name}</div>
                                    <div class="text-[#00f2ea] text-xs truncate">${s.game_name}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    c.innerHTML = '<div class="text-center w-full text-gray-500 py-6">Aucun live favori.</div>';
                }
            } catch(e) { c.innerHTML = '<div class="text-center w-full text-red-500 py-6">Erreur.</div>'; }
        }

        // --- AUTH ---
        async function checkAuth() {
            const res = await fetch('/twitch_user_status');
            const data = await res.json();
            if(data.is_connected) {
                document.getElementById('btn-auth').classList.add('hidden');
                document.getElementById('user-display').classList.remove('hidden');
                document.getElementById('username').innerText = data.display_name;
                loadFollowed();
            }
        }
        function startAuth() { window.open('/twitch_auth_start', 'login', 'width=500,height=700'); }
        function logout() { fetch('/twitch_logout', {method:'POST'}).then(()=>location.reload()); }

        // --- TOOLS ---
        async function runScan() {
            const q = document.getElementById('scan-input').value;
            const resBox = document.getElementById('scan-res');
            resBox.classList.remove('hidden');
            document.getElementById('scan-ai').innerText = "Analyse IA...";
            
            const res = await fetch('/scan_target', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})});
            const data = await res.json();
            if(data.success) {
                const u = data.user_data;
                document.getElementById('scan-name').innerText = u.display_name;
                document.getElementById('scan-img').src = u.profile_image_url;
                document.getElementById('scan-score').innerText = "Niche Score: " + u.ai_calculated_niche_score;
                
                const ai = await fetch('/critique_ia', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'niche', query:u.display_name})});
                const aiData = await ai.json();
                document.getElementById('scan-ai').innerHTML = aiData.html_response;
            }
        }

        async function activateBoost() {
            const c = document.getElementById('boost-input').value;
            const m = document.getElementById('boost-msg');
            m.innerText = "Activation...";
            const res = await fetch('/stream_boost', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:c})});
            const d = await res.json();
            if(d.success) { m.innerText = "BOOST OK !"; m.className = "text-center text-[10px] mt-2 text-[#00f2ea]"; setTimeout(()=>location.reload(), 2000); }
        }

    </script>
</body>
</html>
