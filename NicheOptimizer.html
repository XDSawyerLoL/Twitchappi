<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.2 - Full Features</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* --- VARIABLES CSS (Ajout des ombres n√©on) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-ai-action: #e34a64; 
            --color-text-dimmed: #9aa3a8;
            
            /* Styles g√©n√©raux */
            body { background: var(--color-bg-dark); font-family: 'Inter', sans-serif; color: white; }
            h1, h2, h3, h4 { font-family: 'Orbitron', sans-serif; }
            .neon-shadow-pink { box-shadow: 0 0 5px var(--color-primary-pink), 0 0 10px var(--color-primary-pink); }
            .neon-shadow-green { box-shadow: 0 0 5px var(--color-ai-niche), 0 0 10px var(--color-ai-niche); }
            .bg-twitch { background-color: #6441a5; }

            /* Styles des boutons d'onglet */
            .tab-btn { transition: all 0.2s; border-bottom: 3px solid transparent; }
            .tab-btn:hover { border-bottom-color: var(--color-primary-pink); }
            .tab-btn.active { border-bottom-color: var(--color-secondary-blue); color: var(--color-secondary-blue); font-weight: bold; }

            /* Styles des rapports IA */
            .ai-report-box { border-left: 5px solid; padding-left: 15px; margin-top: 15px; }
            .ai-report-box h4 { border-bottom: 2px solid; padding-bottom: 5px; margin-bottom: 10px; }
            .ai-niche-report h4 { border-color: var(--color-ai-niche); color: var(--color-ai-niche); }
            .ai-repurpose-report h4 { border-color: var(--color-ai-repurpose); color: var(--color-ai-repurpose); }
            .ai-growth-report h4 { border-color: var(--color-ai-growth); color: var(--color-ai-growth); }
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold text-white tracking-widest">
                STREAMER <span class="text-xs text-red-500">v10.2</span> <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-blue-400">AI HUB</span>
            </h1>
            <div id="auth-area" class="text-right">
                <p id="user-status" class="text-sm text-yellow-500">Statut: D√©connect√©</p>
                <button id="twitch-auth-btn" class="bg-twitch text-white px-4 py-2 rounded-lg text-sm transition duration-150 ease-in-out hover:bg-opacity-80">
                    Connexion Twitch
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="md:col-span-2 space-y-6">
                
                <div class="bg-black p-2 rounded-lg neon-shadow-pink">
                    <div id="twitch-player" class="w-full aspect-video">
                        <p class="text-center p-20 text-gray-500">Lecteur Twitch en attente...</p>
                    </div>
                </div>

                <div id="twitch-player-share" class="flex justify-center space-x-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <p class="text-sm text-white pt-2">Lecteur : <strong id="current-channel-name">...</strong></p>
                    <button class="bg-gray-700 text-sm text-white px-3 py-2 rounded-lg transition duration-150 hover:bg-gray-600 share-player-btn" 
                            data-platform="twitch" data-share-url="https://twitch.tv/" data-channel="">
                        Voir sur Twitch
                    </button>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-xl text-secondary-blue mb-4">Streams Suivis LIVE (Max 12)</h3>
                    <div id="followed-streams-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <p class="text-gray-500 col-span-3 text-center">Connectez-vous √† Twitch pour charger votre fil suivi.</p>
                    </div>
                    <p id="followed-streams-error" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>
            </div>

            <div class="md:col-span-1 bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-4">
                <h3 class="text-xl text-white mb-4">AI Hub - Outils d'Optimisation</h3>

                <div class="flex border-b border-gray-700">
                    <button class="tab-btn active px-3 py-2 text-white" data-tab="tab-followed">Fil & Stats</button>
                    <button class="tab-btn px-3 py-2 text-white ml-3" data-tab="tab-niche">Niche IA</button>
                    <button class="tab-btn px-3 py-2 text-white ml-3" data-tab="tab-repurpose">Recyclage VOD</button>
                    <button class="tab-btn px-3 py-2 text-white ml-3" data-tab="tab-actions">Actions</button>
                </div>

                <div id="tab-content" class="space-y-4 pt-3">
                    
                    <div id="tab-followed" class="tab-pane">
                        <h4 class="text-lg text-secondary-blue mb-3">Statistiques de Streamer</h4>
                        <div class="bg-gray-900 p-3 rounded-lg mb-4">
                            <label for="scan-query" class="block text-sm font-medium text-white mb-2">Scanner (Pseudo ou Jeu):</label>
                            <div class="flex space-x-2">
                                <input type="text" id="scan-query" placeholder="Ex: ZeratoR ou Elden Ring" class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                <button id="scan-btn" class="bg-primary-pink text-white px-4 rounded transition duration-150 hover:bg-opacity-80">
                                    Scanner <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="scan-result-box" class="min-h-[150px] p-3 rounded bg-gray-900 border border-gray-600">
                            <p class="text-sm text-gray-400">R√©sultat du scan (Utilisateur ou Jeu)</p>
                        </div>
                    </div>
                    
                    <div id="tab-niche" class="tab-pane hidden">
                        <h4 class="text-lg text-ai-niche mb-3">Critique de Niche IA</h4>
                        <div class="bg-gray-900 p-3 rounded-lg mb-4">
                            <label for="niche-query" class="block text-sm font-medium text-white mb-2">Jeu ou Cat√©gorie √† analyser:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="niche-query" placeholder="Ex: 'Niche Gaming' ou un nom de jeu" class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                <button id="niche-btn" data-type="niche" class="bg-ai-niche text-white px-4 rounded transition duration-150 hover:bg-opacity-80">
                                    Analyser <i class="fas fa-brain"></i>
                                </button>
                            </div>
                        </div>
                        <div id="niche-report-box" class="ai-report-box min-h-[150px] p-3 rounded bg-gray-900 border border-gray-600">
                            <p class="text-sm text-gray-400">Le rapport IA s'affichera ici.</p>
                        </div>
                    </div>

                    <div id="tab-repurpose" class="tab-pane hidden">
                        <h4 class="text-lg text-ai-repurpose mb-3">Recyclage VOD/Clips IA</h4>
                        <div class="bg-gray-900 p-3 rounded-lg mb-4">
                            <label for="vod-channel" class="block text-sm font-medium text-white mb-2">Cha√Æne Twitch pour VOD:</label>
                            <div class="flex space-x-2 mb-2">
                                <input type="text" id="vod-channel" placeholder="Ex: user_twitch" class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                <button id="vod-btn" class="bg-ai-repurpose text-white px-4 rounded transition duration-150 hover:bg-opacity-80">
                                    Charger VOD <i class="fas fa-video"></i>
                                </button>
                            </div>
                            <label for="vod-title" class="block text-sm font-medium text-white mb-2 mt-4">Titre de la VOD charg√©e (ou Entrez un titre):</label>
                            <div class="flex space-x-2">
                                <input type="text" id="vod-title" placeholder="Ex: J'ai battu le boss apr√®s 10h" class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-white">
                                <button id="repurpose-btn" data-type="repurpose" class="bg-ai-repurpose text-white px-4 rounded transition duration-150 hover:bg-opacity-80" disabled>
                                    Critique IA <i class="fas fa-clipboard-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="repurpose-report-box" class="ai-report-box min-h-[150px] p-3 rounded bg-gray-900 border border-gray-600">
                            <p class="text-sm text-gray-400">Le rapport de recyclage de contenu s'affichera ici.</p>
                        </div>
                    </div>

                    <div id="tab-actions" class="tab-pane hidden">
                        <h4 class="text-lg text-ai-action mb-3">Actions Automatiques & Boost</h4>
                        <div class="space-y-3">
                            
                            <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center border border-gray-700">
                                <span class="text-white text-sm">Raid Niche Boost (0-100 viewers)</span>
                                <button id="raid-btn" data-type="raid_action" class="bg-ai-action text-white px-3 py-1 rounded transition duration-150 hover:bg-opacity-80" disabled>
                                    Lancer <i class="fas fa-hand-rock"></i>
                                </button>
                            </div>
                            
                            <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center border border-gray-700">
                                <span class="text-white text-sm">Cr√©er Clip (Canal actif)</span>
                                <button id="clip-btn" data-type="create_clip" class="bg-ai-repurpose text-white px-3 py-1 rounded transition duration-150 hover:bg-opacity-80" disabled>
                                    Clipper <i class="fas fa-scissors"></i>
                                </button>
                            </div>

                            <div class="bg-gray-900 p-3 rounded-lg flex items-center border border-gray-700">
                                <input type="text" id="title-query" placeholder="Th√®me VOD pour titre IA" class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-white mr-2">
                                <button id="title-btn" data-type="title_disruption" class="bg-ai-repurpose text-white px-3 py-1 rounded transition duration-150 hover:bg-opacity-80">
                                    Titres IA <i class="fas fa-bolt"></i>
                                </button>
                            </div>
                            
                            <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center border border-gray-700">
                                <span class="text-white text-sm">Boost de Visibilit√© (Traffic)</span>
                                <button id="boost-btn" class="bg-primary-pink text-white px-3 py-1 rounded transition duration-150 hover:bg-opacity-80" disabled>
                                    BOOST <i class="fas fa-arrow-up"></i>
                                </button>
                            </div>

                        </div>
                        
                        <div id="action-result-box" class="min-h-[150px] p-3 rounded bg-gray-900 border border-gray-600 mt-4">
                            <p class="text-sm text-gray-400">R√©sultats des actions automatiques.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    
    // =========================================================
    // üõë ATTENTION : CORRECTION CRUCIALE POUR RENDER
    // =========================================================
    // Remplacez cette variable par l'URL HTTPS de votre d√©ploiement Render !
    // Elle doit correspondre √† votre domaine Render (ex: https://monserveur.onrender.com)
    const API_BASE = 'https://justplayerstreamhubpro.onrender.com';
    // ---------------------------------------------------------
    
    const DEFAULT_CHANNEL = 'twitch'; // Cha√Æne par d√©faut si aucune n'est active
    let ACTIVE_CHANNEL = DEFAULT_CHANNEL;
    let IS_USER_CONNECTED = false;

    // --- 1. Utilitaire de Requ√™te API ---
    async function fetchAPI(endpoint, method = 'GET', data = null) {
        const url = `${API_BASE}${endpoint}`;
        
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            // Note: les cookies sont envoy√©s automatiquement pour l'authentification
        };

        if (data && method !== 'GET') {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);

            // V√©rifier les erreurs de statut HTTP (4xx, 5xx)
            if (!response.ok) {
                // Tente de lire l'erreur JSON envoy√©e par le serveur
                let errorData = {};
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { error: `Erreur serveur (${response.status} ${response.statusText}).` };
                }
                // Si le serveur a fourni une r√©ponse HTML d'erreur, on la renvoie
                if (errorData.html_response) {
                    throw new Error(errorData.html_response);
                }
                throw new Error(errorData.error || `Erreur serveur non sp√©cifi√©e (${response.status})`);
            }
            
            // Retourne le JSON
            return await response.json();

        } catch (error) {
            // Cette erreur est souvent une erreur r√©seau (pas de connexion)
            if (error.message.includes('Failed to fetch') || error.message.includes('TypeError')) {
                throw new Error("√âchec de la connexion au serveur (r√©seau coup√© ou API non d√©marr√©e / Mauvaise BASE_URL).");
            }
            throw error; // Propage les autres erreurs
        }
    }

    // --- 2. Fonctions d'Interface (Tabs et Player) ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');

        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

        localStorage.setItem('activeTab', tabId);
    }

    window.launchPlayer = function(channel) {
        if (!channel) return;
        
        ACTIVE_CHANNEL = channel;
        localStorage.setItem('activeChannel', channel);
        document.getElementById('current-channel-name').textContent = channel.toUpperCase();
        
        const playerDiv = document.getElementById('twitch-player');
        playerDiv.innerHTML = ''; // Nettoyer l'ancien lecteur

        new Twitch.Player("twitch-player", {
            width: '100%',
            height: '100%',
            channel: channel,
            parent: ["justplayerstreamhubpro.onrender.com", "localhost"] // IMPORTANT pour l'embed Twitch
        });
        
        // Mettre √† jour les boutons de clip et de boost (ils n√©cessitent la cha√Æne active)
        document.getElementById('clip-btn').dataset.query = channel;
        document.getElementById('boost-btn').dataset.query = channel;
    }

    // --- 3. Gestion de l'Authentification Twitch ---
    async function checkAuth() {
        try {
            const data = await fetchAPI('/twitch_user_status');
            const authBtn = document.getElementById('twitch-auth-btn');
            const userStatus = document.getElementById('user-status');
            
            IS_USER_CONNECTED = data.is_connected;

            if (data.is_connected) {
                userStatus.textContent = `Connect√© en tant que: ${data.display_name}`;
                authBtn.textContent = 'D√©connexion';
                authBtn.onclick = logout;
                loadFollowedStreams(); // Charger le fil si connect√©
                // Activer les boutons n√©cessitant l'auth
                document.getElementById('raid-btn').disabled = false;
                document.getElementById('clip-btn').disabled = false;
                document.getElementById('boost-btn').disabled = false;
            } else {
                userStatus.textContent = 'Statut: D√©connect√©';
                authBtn.textContent = 'Connexion Twitch';
                authBtn.onclick = startAuth;
                document.getElementById('followed-streams-list').innerHTML = `<p class="text-gray-500 col-span-3 text-center">Connectez-vous √† Twitch pour charger votre fil suivi.</p>`;
                // D√©sactiver les boutons
                document.getElementById('raid-btn').disabled = true;
                document.getElementById('clip-btn').disabled = true;
                document.getElementById('boost-btn').disabled = true;
            }
        } catch (error) {
            console.error("Erreur de statut d'authentification:", error);
            // Si l'API est injoignable, on affiche un message dans la console seulement.
        }
    }
    
    function startAuth() {
        window.location.href = `${API_BASE}/twitch_auth_start`;
    }

    async function logout() {
        if (!confirm("Voulez-vous vraiment vous d√©connecter de Twitch?")) return;
        try {
            await fetchAPI('/twitch_logout', 'POST');
            checkAuth();
        } catch (error) {
            alert(`Erreur lors de la d√©connexion: ${error.message}`);
        }
    }

    // --- 4. Charger les Streams Suivis ---
    async function loadFollowedStreams() {
        const listDiv = document.getElementById('followed-streams-list');
        const errorP = document.getElementById('followed-streams-error');
        listDiv.innerHTML = `<p class="text-white col-span-3 text-center"><i class="fas fa-sync fa-spin"></i> Chargement de votre fil...</p>`;
        errorP.classList.add('hidden');

        try {
            const data = await fetchAPI('/followed_streams');
            if (data.success && data.streams.length > 0) {
                listDiv.innerHTML = data.streams.map(stream => `
                    <div class="cursor-pointer bg-gray-900 p-2 rounded-lg transition duration-150 hover:bg-gray-700" 
                         onclick="window.launchPlayer('${stream.user_login}')">
                        <p class="text-sm font-bold text-white">${stream.user_name}</p>
                        <p class="text-xs text-secondary-blue truncate">${stream.game_name}</p>
                        <p class="text-xs text-red-400">${stream.viewer_count.toLocaleString()} vues</p>
                    </div>
                `).join('');
            } else {
                listDiv.innerHTML = `<p class="text-gray-500 col-span-3 text-center">Aucun stream LIVE trouv√© dans votre fil.</p>`;
            }
        } catch (error) {
            listDiv.innerHTML = `<p class="text-gray-500 col-span-3 text-center">Impossible de charger le fil.</p>`;
            errorP.textContent = `Erreur: ${error.message}`;
            errorP.classList.remove('hidden');
        }
    }
    
    // --- 5. Gestionnaire Universel pour les Boutons IA/Action ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => openTab(btn.dataset.tab));
    });

    // ... (Le reste des √©couteurs d'√©v√©nements pour les boutons IA doit √™tre ici, 
    //     utilisant la fonction fetchAPI et la variable API_BASE) ...

    // --- 8. Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        // Ajouter la librairie Twitch si elle n'est pas d√©j√† dans le header
        const script = document.createElement('script');
        script.setAttribute('src', 'https://player.twitch.tv/js/embed/v1.js');
        document.head.appendChild(script);

        // Charger le joueur et l'onglet par d√©faut
        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        window.launchPlayer(lastChannel); 

        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        
        checkAuth();
        
        // --- √âcouteur g√©n√©rique pour la majorit√© des requ√™tes POST ---
        document.querySelectorAll('#scan-btn, #niche-btn, #repurpose-btn, #title-btn, #raid-btn, #clip-btn, #boost-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const actionType = btn.dataset.type;
                let endpoint, query;
                let resultBox;

                switch (btn.id) {
                    case 'scan-btn':
                        endpoint = '/scan_target';
                        query = document.getElementById('scan-query').value;
                        resultBox = document.getElementById('scan-result-box');
                        break;
                    case 'niche-btn':
                        endpoint = '/critique_ia';
                        query = document.getElementById('niche-query').value;
                        resultBox = document.getElementById('niche-report-box');
                        break;
                    case 'repurpose-btn':
                        endpoint = '/critique_ia';
                        query = document.getElementById('vod-title').value;
                        resultBox = document.getElementById('repurpose-report-box');
                        break;
                    case 'title-btn':
                        endpoint = '/auto_action';
                        query = document.getElementById('title-query').value;
                        resultBox = document.getElementById('action-result-box');
                        break;
                    case 'raid-btn':
                        endpoint = '/auto_action';
                        query = ACTIVE_CHANNEL; // Le raid utilise la cha√Æne active
                        resultBox = document.getElementById('action-result-box');
                        break;
                    case 'clip-btn':
                        endpoint = '/auto_action';
                        query = ACTIVE_CHANNEL; // Le clip utilise la cha√Æne active
                        resultBox = document.getElementById('action-result-box');
                        break;
                    case 'boost-btn':
                        endpoint = '/stream_boost';
                        query = ACTIVE_CHANNEL; // Le boost utilise la cha√Æne active
                        resultBox = document.getElementById('action-result-box');
                        break;
                    default:
                        return;
                }
                
                if (!query && btn.id !== 'raid-btn' && btn.id !== 'clip-btn' && btn.id !== 'boost-btn') {
                    resultBox.innerHTML = '<p style="color:red; text-align:center;">Veuillez entrer une requ√™te.</p>';
                    return;
                }

                btn.disabled = true;
                resultBox.innerHTML = `<p class="text-white text-center"><i class="fas fa-sync fa-spin"></i> Traitement de la requ√™te...</p>`;

                try {
                    const postData = (endpoint.includes('critique_ia') || endpoint.includes('auto_action'))
                        ? { type: actionType, query: query }
                        : { query: query };

                    if (btn.id === 'boost-btn') {
                         postData.channel = query;
                    }
                    
                    const data = await fetchAPI(endpoint, 'POST', postData);

                    if (data.html_response) {
                        resultBox.innerHTML = data.html_response;
                    } else if (data.success && data.type === 'game') {
                        // Affichage du r√©sultat de scan de jeu
                        resultBox.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <img src="${data.game_data.box_art_url.replace('{width}x{height}', '50x68')}" class="w-12 h-16 rounded">
                                <div>
                                    <p class="text-lg text-white font-bold">${data.game_data.name}</p>
                                    <p class="text-sm text-secondary-blue">Streams LIVE: ${data.game_data.total_streamers.toLocaleString()}</p>
                                    <p class="text-sm text-primary-pink">Viewers Totaux: ${data.game_data.total_viewers.toLocaleString()}</p>
                                    <p class="text-xs text-white mt-1">Ratio V/S: ${(data.game_data.total_viewers / (data.game_data.total_streamers || 1)).toFixed(2)}</p>
                                </div>
                            </div>
                        `;
                    } else if (data.success && data.type === 'user') {
                         // Affichage du r√©sultat de scan d'utilisateur
                        resultBox.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <img src="${data.user_data.profile_image_url}" class="w-12 h-12 rounded-full">
                                <div>
                                    <p class="text-lg text-white font-bold">${data.user_data.display_name} (${data.user_data.login})</p>
                                    <p class="text-sm ${data.user_data.is_live ? 'text-red-500' : 'text-gray-500'}">
                                        <i class="fas fa-circle ${data.user_data.is_live ? 'animate-pulse' : ''}"></i> ${data.user_data.is_live ? 'LIVE' : 'HORS LIGNE'}
                                    </p>
                                    <p class="text-sm text-secondary-blue">Followers: ${data.user_data.follower_count.toLocaleString()}</p>
                                    ${data.user_data.is_live ? `<p class="text-sm text-primary-pink">Viewers: ${data.user_data.stream_details.viewer_count.toLocaleString()}</p>` : ''}
                                </div>
                            </div>
                        `;
                    } else if (data.error) {
                         throw new Error(data.error);
                    } else {
                        resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå Format de r√©ponse non reconnu.</p>`;
                    }

                } catch (error) {
                    let errorMessage = error.message;
                    if (errorMessage.includes("Bad Request") && !errorMessage.includes("Erreur")) {
                        errorMessage = "V√©rifiez vos donn√©es d'entr√©e ou les cl√©s API.";
                    } else if (errorMessage.includes("Erreur serveur non sp√©cifi√©e")) {
                        errorMessage = "Erreur serveur inattendue. L'API a retourn√© un statut non-JSON au lieu des donn√©es JSON. L'API est probablement HS.";
                    } else if (errorMessage.includes("√âchec de la connexion au serveur")) {
                        // C'est l'erreur que vous voulez √©viter : elle est maintenant plus explicite.
                        errorMessage = "√âchec de la connexion au serveur (r√©seau coup√©, API non d√©marr√©e ou mauvaise BASE_URL dans ce fichier HTML).";
                    }
                    
                    resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur r√©seau ou API: ${errorMessage}</p>`;
                } finally {
                    btn.disabled = false;
                }
            });
        });
        
        // √âcouteur sp√©cifique pour la VOD, car il n√©cessite une √©tape de plus (chargement du titre)
        document.getElementById('vod-btn').addEventListener('click', async function() {
            const btn = this;
            const channel = document.getElementById('vod-channel').value;
            const titleInput = document.getElementById('vod-title');
            const critiqueBtn = document.getElementById('repurpose-btn');
            const resultBox = document.getElementById('repurpose-report-box');

            if (!channel) {
                resultBox.innerHTML = '<p style="color:red; text-align:center;">Veuillez entrer une cha√Æne Twitch.</p>';
                return;
            }

            btn.disabled = true;
            critiqueBtn.disabled = true;
            resultBox.innerHTML = `<p class="text-white text-center"><i class="fas fa-sync fa-spin"></i> Recherche de la derni√®re VOD...</p>`;

            try {
                const data = await fetchAPI(`/get_latest_vod?channel=${channel}`);

                if (data.success && data.vod) {
                    titleInput.value = data.vod.title;
                    resultBox.innerHTML = `<p style="color:var(--color-ai-repurpose); font-weight:bold;">‚úÖ VOD trouv√©e:</p>
                                            <p class="text-sm text-white">${data.vod.title}</p>
                                            <a href="${data.vod.url}" target="_blank" class="text-xs text-blue-400 hover:underline">Voir la VOD</a>`;
                    critiqueBtn.disabled = false;
                } else {
                    throw new Error(data.error || "Aucune VOD trouv√©e.");
                }
            } catch (error) {
                let errorMessage = error.message;
                if (errorMessage.includes("√âchec de la connexion au serveur")) {
                    errorMessage = "√âchec de la connexion au serveur (r√©seau coup√©, API non d√©marr√©e ou mauvaise BASE_URL).";
                }
                resultBox.innerHTML = `<p style="color:red; font-weight:bold; text-align:center;">‚ùå Erreur VOD: ${errorMessage}</p>`;
            } finally {
                btn.disabled = false;
            }
        });
    });
</script>
</body>
</html>
