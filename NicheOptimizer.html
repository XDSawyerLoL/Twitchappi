<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streamer Hub ‚Äì Pro Analytics & TwitFlix</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:hidden;
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background:#000; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--secondary); }

    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }

    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    .hub-msg{ padding:8px; border-bottom:1px solid #1a1a1a; font-size:13px; line-height:1.4; }
    .hub-msg strong{ font-family:Orbitron; font-size:11px; }
    .scrollbar-thin::-webkit-scrollbar{ width:4px; }

    /* badge statut */
    #socket-status{ transition:all .3s ease; }
    #socket-status.connected{
      color:#00f2ea; border-color:#00f2ea;
      box-shadow:0 0 8px rgba(0,242,234,.6);
      animation:hub-pulse 2s infinite;
    }
    @keyframes hub-pulse{ 0%,100%{opacity:1} 50%{opacity:.6} }

    /* BEST TIME TOOL */
    .best-time-tool{
      background:#151515; border:1px solid #00f2ea; border-radius:10px;
      padding:16px; margin-bottom:16px; box-shadow:inset 0 0 10px rgba(0,242,234,.1);
    }
    .best-time-tool h4{
      color:#00f2ea; font-family:Orbitron; font-size:12px;
      margin-bottom:10px; border-bottom:1px solid #00f2ea; padding-bottom:8px;
    }
    .best-time-tool input{
      width:100%; padding:10px; background:#0a0a0a; border:1px solid #333;
      color:#fff; border-radius:6px; font-size:12px; margin-bottom:8px;
    }
    .best-time-tool input:focus{ border-color:#00f2ea; box-shadow:0 0 8px rgba(0,242,234,.2); outline:none; }
    .best-time-tool button{
      width:100%; background:#00f2ea; color:#000; padding:10px;
      border:none; border-radius:6px; font-weight:bold; cursor:pointer;
      font-family:Orbitron; font-size:11px; transition:all .3s ease;
    }
    .best-time-tool button:hover:not(:disabled){ background:#fff; box-shadow:0 0 15px rgba(0,242,234,.4); transform:translateY(-1px); }
    .best-time-tool button:disabled{ opacity:.5; cursor:not-allowed; }
    .best-time-results{
      background:#0a0a0a; border:1px solid #333; border-radius:6px;
      padding:12px; margin-top:12px; font-size:12px; max-height:220px; overflow-y:auto;
    }
    .best-time-spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(0,242,234,.3); border-radius:50%;
      border-top-color:#00f2ea; animation:bt-spin 1s linear infinite;
      margin-right:6px; vertical-align:middle;
    }
    @keyframes bt-spin{ to{ transform:rotate(360deg) } }

    /* PLAYER sizing (grand) */
    .player-shell{ min-height:72vh; }
    #video-container{ min-height:62vh; }

    /* ====== ONGLETS SOUS LE LIVE (ind√©pendants) ====== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }

    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* ====== TWITFLIX MODAL ====== */
    .tf-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px);
      z-index: 9999; display: none; align-items: center; justify-content: center;
    }
    .tf-modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .tf-modal-content {
      width: 90%; max-width: 1200px; height: 85vh;
      background: #0b0b0d; border: 1px solid #333; border-radius: 12px;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 242, 234, 0.1);
    }
    .tf-header {
      padding: 20px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
      background: #080808;
    }
    .tf-title { font-family: 'Orbitron'; color: #ff0099; font-size: 24px; letter-spacing: 2px; }
    .tf-title span { color: #00f2ea; }
    .tf-close { color: #666; cursor: pointer; font-size: 24px; transition: .3s; }
    .tf-close:hover { color: #fff; transform: rotate(90deg); }

    .tf-grid {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; align-content: start;
    }
    .tf-card {
      position: relative; aspect-ratio: 3/4; border-radius: 6px; overflow: hidden;
      cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border: 2px solid transparent;
    }
    .tf-card:hover {
      transform: scale(1.05); border-color: #00f2ea; z-index: 10;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.3);
    }
    .tf-poster { width: 100%; height: 100%; object-fit: cover; }
    .tf-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, black, transparent);
      padding: 10px; opacity: 0; transition: 0.3s;
    }
    .tf-card:hover .tf-overlay { opacity: 1; }
    .tf-name { font-size: 12px; font-weight: bold; color: white; text-align: center; }
  
    /* ====== TWITFLIX ‚Äî Netflix rows (catalogue only, sans toucher le reste) ====== */
    .tf-controls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding: 0 16px 12px 16px;
      border-bottom:1px solid #1f1f23;
      background: rgba(11,11,13,.92);
    }
    .tf-view-toggle{
      display:flex; gap:6px; padding:4px; border-radius:12px;
      border:1px solid #2b2b31; background:#0a0a0a;
    }
    .tf-toggle-btn{
      border:0; background:transparent; color:#a7a7b2;
      font-family:Orbitron; font-size:10px; font-weight:900;
      letter-spacing:.10em;
      padding:8px 10px; border-radius:10px; cursor:pointer; transition:.2s;
    }
    .tf-toggle-btn:hover{ color:#fff; background:#151515; }
    .tf-toggle-btn.active{ color:#000; background:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.18); }

    .tf-grid{ padding: 14px 16px 18px 16px; }
    .tf-section{ margin-top: 18px; }
    .tf-section-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #eaeaf0;
      margin: 8px 0 10px 2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .tf-section-title .hint{ color:#7f7f8a; font-size:10px; letter-spacing:.06em; text-transform:none; font-family:Inter; font-weight:700; }

    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    /* Card sizing for rows (lisible) */
    .tf-card{ flex: 0 0 170px; aspect-ratio: 2/3; }
    .tf-card:hover{ transform: scale(1.06); } /* moins agressif pour √©viter le clipping */
    .tf-name{ font-size: 11px; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* A‚ÄìZ bar */
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.74));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 8px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }


    /* ====== TWITFLIX ‚Äî performance + Netflix rows ====== */
    .tf-rows{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: block;
    }
    .tf-row{ margin-bottom: 22px; }
    .tf-row-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color:#eaeaf0;
      margin: 8px 0 10px 2px;
    }
    .tf-row-title span{ color:#00f2ea; }
    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    .tf-az{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display:block;
    }
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.78));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 10px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }

    .tf-sentinel{
      padding: 18px 0 4px 0;
      display:flex;
      justify-content:center;
    }
    .tf-sentinel-inner{
      font-size: 12px;
      color:#9b9ba3;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .tf-sentinel-inner.done{
      color:#00f2ea;
      border-color:#00f2ea;
      background: rgba(0,242,234,.06);
    }
    .tf-retry{
      background:#151515;
      border:1px solid #2b2b31;
      color:#fff;
      padding:10px 14px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:.2s;
    }
    .tf-retry:hover{
      border-color:#00f2ea;
      box-shadow:0 0 18px rgba(0,242,234,.18);
      transform: translateY(-1px);
    }


    /* TwitFlix search (Netflix style) */
    .tf-search-wrap{ position:relative; width:min(520px, 100%); }
    .tf-search{
      width:100%;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      color:#fff;
      border-radius:10px;
      padding:10px 12px 10px 36px;
      font-size:13px;
      outline:none;
      transition:.2s;
    }
    .tf-search:focus{
      border-color:#00f2ea;
      box-shadow:0 0 0 3px rgba(0,242,234,.12);
    }
    .tf-search-ico{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:#777;
      font-size:13px;
      pointer-events:none;
    }


/* === TwitFlix UX Overhaul (Netflix-like) ‚Äî overrides only (does not touch rest of app) === */
#twitflix-modal .tf-modal-content{ max-width: 1400px; }

#twitflix-modal .tf-topbar{ position: sticky; top:0; z-index: 60; }
#twitflix-modal .tf-actions{ gap: 12px; }
#twitflix-modal .tf-search{ font-size: 14px; padding: 12px 14px 12px 38px; }

#twitflix-modal .tf-grid{
  display:flex;
  flex-direction: column;
  gap: 18px;
  padding: 14px 18px 24px 18px;
}

#twitflix-modal .tf-hero{
  position: relative;
  height: 220px;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid #1f1f23;
  background: #0a0a0a;
}
#twitflix-modal .tf-hero::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 20%, rgba(0,242,234,.18), transparent 60%),
              radial-gradient(circle at 80% 30%, rgba(255,0,153,.14), transparent 55%),
              linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.20));
  z-index:2;
}
#twitflix-modal .tf-hero-bg{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
  filter: saturate(1.05) contrast(1.05);
  opacity:.55;
}
#twitflix-modal .tf-hero-content{
  position:absolute; inset:0;
  z-index:3;
  display:flex;
  align-items:flex-end;
  padding: 18px;
}
#twitflix-modal .tf-hero-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .08em;
  font-size: 18px;
  font-weight: 900;
  color:#fff;
  text-shadow: 0 6px 24px rgba(0,0,0,.8);
}
#twitflix-modal .tf-hero-sub{
  margin-top: 6px;
  font-size: 12px;
  color:#cfcfda;
  max-width: 70ch;
  line-height: 1.35;
}

#twitflix-modal .tf-row{ display:flex; flex-direction:column; gap: 10px; }
#twitflix-modal .tf-row-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: 12px;
  color:#eaeaf0;
  display:flex; align-items:center; justify-content:space-between;
}
#twitflix-modal .tf-row-title span{ color:#00f2ea; }
#twitflix-modal .tf-row-track{
  display:flex;
  gap: 16px;
  overflow-x:auto;
  padding-bottom: 10px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}
#twitflix-modal .tf-row-track::-webkit-scrollbar{ height: 6px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

#twitflix-modal .tf-card{
  flex: 0 0 170px;
  border-radius: 12px;
  overflow:hidden;
  background:#101013;
  border:1px solid #1d1d22;
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}
#twitflix-modal .tf-card:hover{
  transform: scale(1.06);
  z-index: 40;
  border-color:#00f2ea;
  box-shadow: 0 18px 45px rgba(0,0,0,.55), 0 0 18px rgba(0,242,234,.18);
}
#twitflix-modal .tf-poster{
  width:100%; height:100%;
  object-fit: cover;
  transform: scale(1.02);
  opacity:.95;
}
#twitflix-modal .tf-card:hover .tf-poster{ opacity:.35; }

#twitflix-modal .tf-overlay{
  padding: 10px 10px 12px 10px;
}
#twitflix-modal .tf-name{
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
#twitflix-modal .tf-meta{ display:none; } /* cache le texte ‚ÄúSurvol‚Ä¶‚Äù */
#twitflix-modal .tf-actions-row{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-top: 10px;
}
#twitflix-modal .tf-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 10px;
  font-weight: 900;
  color:#000;
  background:#00f2ea;
}
#twitflix-modal .tf-pill.ghost{
  background: rgba(255,255,255,.08);
  color:#e8e8ee;
  border:1px solid rgba(255,255,255,.14);
}

#twitflix-modal .tf-search-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  padding-top: 10px;
}

#twitflix-modal .tf-azbar{
  position: sticky;
  top: 66px; /* sous la topbar */
  z-index: 55;
  display:flex;
  flex-wrap:wrap;
  gap: 6px;
  padding: 10px 0 8px 0;
  background: linear-gradient(180deg, rgba(11,11,13,.96), rgba(11,11,13,.72));
  border-bottom: 1px solid #1f1f23;
}
#twitflix-modal .tf-azlink{
  font-family: Orbitron, sans-serif;
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .12em;
  color:#a7a7b2;
  text-decoration:none;
  padding: 6px 8px;
  border-radius: 10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.12);
  transition:.2s;
}
#twitflix-modal .tf-azlink:hover{ color:#000; background:#00f2ea; border-color:#00f2ea; }

#twitflix-modal .tf-end{
  text-align:center;
  color:#9b9ba3;
  padding: 18px 0 6px 0;
}
#twitflix-modal .tf-retry{
  margin-top: 10px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #2b2b31;
  background:#151515;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
#twitflix-modal .tf-retry:hover{ border-color:#00f2ea; box-shadow:0 0 18px rgba(0,242,234,.18); transform: translateY(-1px); }


    /* HUB extras (emotes, gifs, r√©actions) */
    .hub-emo{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8ee;
      padding:6px 10px;
      border-radius: 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .hub-emo:hover{ border-color:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.15); }
    .hub-msg{
      padding:8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hub-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      margin-left:6px;
    }
    .hub-gif{
      margin-top:6px;
      border-radius: 12px;
      max-width: 260px;
      border:1px solid rgba(255,255,255,.10);
    }
    .hub-reactions{
      display:flex;
      gap:6px;
      margin-top:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hub-react-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-react-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:#e8e8ee;
      font-size:12px;
    }



/* === EXTRAORDINAIRES (SAFE) === */
.hub-msg .hub-react-row{ opacity:0; max-height:0; overflow:hidden; transition: .18s ease; }
.hub-msg:hover .hub-react-row{ opacity:1; max-height:40px; }
.hub-msg.is-tapped .hub-react-row{ opacity:1; max-height:40px; }

.hub-gif{ max-width: 240px; border-radius: 10px; margin-top: 8px; border:1px solid rgba(255,255,255,.10); display:block; }

#ambilight{
  position:absolute; inset:-14px;
  filter: blur(26px);
  opacity:.55;
  z-index:0;
  pointer-events:none;
  transition: background .25s ease;
}
#player-wrap{ position:relative; }
#player-wrap > *{ position:relative; z-index:1; }

.mosaic-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 8px;
  width: 100%;
  height: 100%;
}
.mosaic-grid iframe{ width:100%; height:100%; border:0; border-radius:14px; }

.vibe-chill{ border:1px solid rgba(34,197,94,.55)!important; box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset; }
.vibe-hype{ border:1px solid rgba(0,242,234,.70)!important; box-shadow: 0 0 0 1px rgba(0,242,234,.25) inset; }
.vibe-toxic{ border:1px solid rgba(239,68,68,.60)!important; box-shadow: 0 0 0 1px rgba(239,68,68,.22) inset; }


    /* ==== HUB Chat UX fixes ==== */
    #chat-container-hub { min-height: 520px; }
    #hub-messages { scroll-behavior: smooth; padding-bottom: 90px; }
    /* Keep input always visible */
    #chat-container-hub form { position: sticky; bottom: 0; z-index: 20; }

    /* Messenger-like reactions: hidden until hover/tap */
    .hub-react-row{ 
      opacity: 0; 
      max-height: 0; 
      overflow: hidden;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity .15s ease, max-height .15s ease, transform .15s ease;
    }
    .hub-msg:hover .hub-react-row, .hub-msg.show-reactions .hub-react-row{
      opacity: 1;
      max-height: 44px;
      pointer-events: auto;
      transform: translateY(0);
    }
    .hub-react-btn{
      width: 34px; height: 34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-reactions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .hub-reaction-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    /* Ensure modules below player aren't clipped inside iframe */
    body { overflow-y: auto; }
    .page-wrap { padding-bottom: 40px; }


/* === Tools overlay (safe) === */

#player-tools{
  position:absolute;
  top:10px;
  right:10px;
  z-index:99999 !important;
  display:flex;
  gap:8px;
  pointer-events:auto;
}
#player-tools .toolbtn{ pointer-events:auto; }
#video-container iframe{ position:relative; z-index:1 !important; }
#video-container .player-wrap, #video-container #player{ position:relative; z-index:1 !important; }

#video-container{ position:relative; overflow: visible !important; }
.toolbtn{
  width:38px;height:34px;border-radius:12px;
  background:rgba(16,16,18,.86);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;font-weight:900;cursor:pointer;
}
.toolbtn:hover{ border-color:#00f2ea; transform: translateY(-1px); }
.toolbtn.active{ border-color:#00f2ea; box-shadow:0 0 0 2px rgba(0,242,234,.22) inset; }

#ambilight{
  position:absolute; inset:-90px; z-index:0;
  filter: blur(60px);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s ease;
}
#ambilight.on{ opacity:.78; }

#video-container iframe, #video-container .player-wrap, #video-container #player{ position:relative; z-index:2; }

/* Vibe borders */
.vibe-chill{ box-shadow: 0 0 0 2px rgba(0,242,234,.35) inset, 0 0 18px rgba(0,242,234,.18); }
.vibe-hype{ box-shadow: 0 0 0 2px rgba(255,0,153,.35) inset, 0 0 18px rgba(255,0,153,.18); }
.vibe-toxic{ box-shadow: 0 0 0 2px rgba(255,214,0,.35) inset, 0 0 18px rgba(255,214,0,.18); }

/* Modals (reuse if not already) */
.modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.75);
  display:none; align-items:center; justify-content:center;
  z-index:99999;
}
.modal-overlay.active{ display:flex; }
.modal-card{
  width:min(1100px,94vw);
  max-height:92vh;
  overflow:auto;
  background:#0b0b0d;
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: 0 0 40px rgba(0,0,0,.6);
  padding:14px;
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px; }
.modal-title{ font-family:Orbitron, sans-serif; letter-spacing:.12em; font-weight:900; font-size:12px; color:#eaeaf0; text-transform:uppercase; }
.modal-close{
  background:#151515; border:1px solid #2b2b31; color:#fff;
  width:36px; height:36px; border-radius:12px; cursor:pointer;
}
.modal-close:hover{ border-color:#00f2ea; }

.mosaic-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
.mosaic-tile{ background:#000; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; position:relative; aspect-ratio:16/9; }
.mosaic-tile button{
  position:absolute; top:10px; right:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.18);
  color:#fff; border-radius:12px;
  padding:6px 10px; font-weight:900; cursor:pointer;
}
.mosaic-tile button:hover{ border-color:#00f2ea; }


    /* Help dots */
    .help-dot{
      display:inline-flex; align-items:center; justify-content:center;
      width:16px; height:16px; border-radius:999px;
      border:1px solid #2a2a2a; color:#9ca3af;
      font-size:11px; margin-left:6px;
      background: rgba(0,0,0,0.35);
      cursor:pointer;
    }
    .help-dot:hover{ border-color: var(--secondary); color: var(--secondary); }
    .help-dot-mini{
      display:inline-flex; align-items:center; justify-content:center;
      width:14px; height:14px; border-radius:999px;
      border:1px solid #2a2a2a; color:#9ca3af;
      font-size:10px;
      background: rgba(0,0,0,0.35);
      cursor:pointer;
    }
    .help-dot-mini:hover{ border-color: var(--secondary); color: var(--secondary); }

    /* Help modal */
    #helpModal{
      position:fixed; inset:0; z-index:9999;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.65);
      padding: 16px;
    }
    #helpModal.active{ display:flex; }
    #helpCard{
      width:min(720px, 96vw);
      background: #0b0b0d;
      border:1px solid #222;
      border-radius:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    #helpCardHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: linear-gradient(90deg, rgba(255,0,153,0.12), rgba(0,242,234,0.10));
      border-bottom: 1px solid #222;
    }
    #helpTitle{ font-family: Orbitron, Inter, system-ui; font-size: 14px; color:#e5e7eb; }
    #helpClose{
      width:34px; height:34px; border-radius:10px;
      border:1px solid #2a2a2a; background:#111; color:#e5e7eb;
      cursor:pointer;
    }
    #helpClose:hover{ border-color: var(--secondary); color: var(--secondary); }
    #helpBody{ padding: 12px 14px; color:#d1d5db; font-size: 13px; line-height:1.45; }
    #helpBody ul{ margin-left: 18px; list-style: disc; }

  
    /* === FULL-WIDTH (EDGE TO EDGE) === */
    body{ width:100%; }
    /* √âtend le module OVERVIEW/ANALYTICS/NICHE/BOURSE sur toute la largeur (m√™me sous la sidebar) */
    .full-width-module{
      width: calc(100% + 360px + 24px); /* sidebar min + gap-6 */
      margin-right: calc(-1 * (360px + 24px));
    }
    /* Si sidebar plus large (jusqu'√† 520px), on √©vite d'√©craser : */
    @media (min-width: 1200px){
      .full-width-module{
        width: calc(100% + 420px + 24px);
        margin-right: calc(-1 * (420px + 24px));
      }
    }



/* =========================================================
   FIX: Chat Hub Secure must NOT stretch the Twitch player
   - Locks the stream row height (player + sidebar)
   - Forces internal scrolling in chat panels
   ========================================================= */
:root{
  --stream-panel-h: clamp(560px, 76vh, 920px);
}

/* The row that contains player + right panel */
#stream-row{
  height: var(--stream-panel-h) !important;
  align-items: stretch !important; /* grid items same height */
}

/* Left column wrapper and player shell fill the row */
#stream-row > .col-span-8{
  height: 100% !important;
  min-height: 0 !important;
}
#stream-row .player-shell{
  height: 100% !important;
  min-height: 0 !important;
}

/* Video container must be allowed to shrink */
#video-container{
  flex: 1 1 auto !important;
  min-height: 0 !important;
  height: auto !important;
}
#video-container iframe{
  width: 100% !important;
  height: 100% !important;
  display:block;
}

/* Right panel locked to same height as player */
#side-panel{
  height: 100% !important;
  min-height: 0 !important;
}

/* Tabs must not expand the panel; each tab manages its own scrolling */
#side-panel .tab-body,
#side-panel .tab-content{
  flex: 1 1 auto !important;
  min-height: 0 !important;
}

/* Chat tab: keep layout locked; only its inner areas scroll */
#tab-chat{
  display:flex !important;
  flex-direction:column !important;
  overflow:hidden !important;
}

/* Stats/Tools tabs: allow internal scrolling */
#tab-stats,
#tab-tools{
  overflow-y:auto !important;
  overscroll-behavior: contain;
}

/* Chat containers: fixed height + internal scroll */
#chat-container-twitch,
#chat-container-hub{
  display:flex !important;
  flex-direction: column !important;
  flex: 1 1 auto !important;
  min-height: 0 !important;
  overflow: hidden !important;
}

/* Message list scroll */
#hub-messages,
#twitch-chat-wrap{
  flex: 1 1 auto !important;
  min-height: 0 !important;
  overflow-y: auto !important;
}

/* Prevent page-height ‚Äúanchor‚Äù jumps */
#hub-messages{ overflow-anchor: none; }


/* === FIX: Side panel height must match Twitch player only (not modules below) === */
:root{ --jp-player-h: 720px; }

#side-panel{
  height: var(--jp-player-h) !important;
  max-height: var(--jp-player-h) !important;
  align-self: start !important;
}

/* Ensure the tab bar never stretches; tab contents decide their own overflow */
#side-panel .tab-nav{ flex: 0 0 auto; }
#side-panel .tab-content{ flex: 1 1 auto !important; min-height: 0 !important; }
#side-panel .tab-content.active{ display:flex !important; flex-direction:column !important; }
#side-panel #chat-container-twitch,
#side-panel #chat-container-hub{ flex: 1 1 auto !important; min-height: 0 !important; }

/* Twitch iframe must fill its container and not affect layout */
#twitch-chat-frame{ width:100% !important; height:100% !important; display:block; }

/* Prevent the main grid row from stretching because of lower modules */
.main-grid, #main-grid, .grid-root{
  align-items: start !important;
}

</style>

<style id="jp-market-patch">
  /* ====== PATCH LAYOUT: Player + Side panel always same height, no distortion ====== */
  :root{ --jpPlayerH: 620px; }
  #player-and-side, .player-and-side{ display:grid !important; grid-template-columns: 1fr minmax(360px, 520px) !important; gap: 16px !important; align-items:stretch !important; }
  @media (max-width: 1024px){ #player-and-side, .player-and-side{ grid-template-columns: 1fr !important; } }
  #twitch-player-wrap, .twitch-player-wrap{ height: var(--jpPlayerH) !important; min-height: 420px !important; }
  #twitch-embed, #twitch-embed iframe{ width:100% !important; height:100% !important; }
  #right-panel, .right-panel, #side-tabs, .side-tabs{ height: var(--jpPlayerH) !important; min-height: 420px !important; overflow:hidden !important; }
  .side-tabs{ display:flex !important; flex-direction:column !important; }
  .side-tabs .tabs-header{ flex:0 0 auto !important; }
  .side-tabs .tabs-body{ flex:1 1 auto !important; min-height:0 !important; overflow:hidden !important; }
  .side-tabs .tab-pane{ height:100% !important; display:none; }
  .side-tabs .tab-pane.active{ display:flex !important; flex-direction:column !important; }
  .side-tabs .tab-pane .pane-scroll{ flex:1 1 auto !important; min-height:0 !important; overflow:auto !important; }
  /* Twitch + secure chat: never stack */
  #twitch-chat-iframe{ width:100% !important; height:100% !important; border:0 !important; }
  #secure-chat-wrap{ width:100% !important; height:100% !important; }
  /* Remove bottom Bourse tab cleanly */
  [data-ut="bourse"], #under-bourse{ display:none !important; }
  /* Market modal styling (reuse tf but add panels) */
  #market-modal.hidden{ display:none !important; }
  #market-modal .tf-modal-content{ max-width: 1500px; }
  #market-modal .tf-kpi{ background: rgba(15,15,18,.7); border:1px solid rgba(255,255,255,.06); border-radius: 14px; padding: 10px 12px; }
  #market-modal .tf-kpi-label{ font-size:11px; color:#9aa3ad; }
  #market-modal .tf-kpi-value{ font-size:18px; font-weight:800; color:#fff; letter-spacing:.3px; }
  #market-modal .tf-kpi-sub{ font-size:11px; color:#7c8590; margin-top:2px; }
  #market-modal .tf-panel{ background: rgba(10,10,12,.7); border:1px solid rgba(255,255,255,.07); border-radius: 16px; padding: 14px; }
  #market-modal .tf-panel-title{ font-weight:800; color:#e9eef6; font-size:13px; letter-spacing:.35px; margin-bottom:10px; }
  #market-modal .tf-list{ display:flex; flex-direction:column; gap:10px; }
  #market-modal .tf-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius: 14px; background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.05); }
  #market-modal .tf-item:hover{ border-color: rgba(0,242,234,.35); background: rgba(0,242,234,.04); }
  #market-modal .tf-chip{ padding:10px 12px; border-radius: 999px; border:1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.35); color:#cfd6de; font-size:12px; font-weight:800; }
  #market-modal .tf-chip.active{ border-color: rgba(0,242,234,.55); box-shadow: 0 0 0 3px rgba(0,242,234,.10); color:#fff; }
  #market-modal .tf-input{ width:100%; padding:10px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.35); color:#fff; font-size:13px; outline:none; }
  #market-modal .tf-input:focus{ border-color: rgba(0,242,234,.55); box-shadow: 0 0 0 3px rgba(0,242,234,.10); }
  #market-modal .tf-table-wrap{ overflow:auto; border-radius: 14px; border: 1px solid rgba(255,255,255,.07); }
  #market-modal .tf-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
  #market-modal .tf-table th{ position:sticky; top:0; background: rgba(12,12,14,.92); text-align:left; padding:10px 12px; color:#9aa3ad; font-weight:800; border-bottom: 1px solid rgba(255,255,255,.07); }
  #market-modal .tf-table td{ padding:10px 12px; border-bottom: 1px solid rgba(255,255,255,.05); color:#e9eef6; }
  #market-modal .tf-book{ display:flex; flex-direction:column; gap:6px; }
  #market-modal .tf-book-row{ display:flex; justify-content:space-between; gap:10px; font-size:12px; padding:8px 10px; border-radius: 12px; background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.05); }
</style>

</head>

<body class="min-h-screen flex flex-col m-0 p-0 w-full">

  <!-- Spacer (embed-safe): √©vite que le haut soit coup√© dans certains iframes -->
  <div style="height:18px;"></div>


  <header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-orbitron italic tracking-widest">
        <span class="text-[#00f2ea]">STREAMER</span> HUB
        <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">PRO</span>
      </h1>
      <div id="socket-status" class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">
        HUB DISCONNECTED
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="openTwitFlix()" class="bg-[#111] hover:bg-[#222] text-[#ff0099] px-4 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#333] hover:border-[#ff0099] shadow-[0_0_10px_rgba(255,0,153,0.1)]">
        <i class="fas fa-play-circle"></i> TWITFLIX
      </button>

      <button onclick="openMarket()" class="bg-[#111] hover:bg-[#171717] text-white px-4 py-2 rounded-xl border border-[#1f1f1f] hover:border-[#00f2ea] shadow-[0_0_10px_rgba(0,242,234,0.10)]">
        <i class="fas fa-chart-line mr-2 text-[#00f2ea]"></i> MARCH√â
      </button>


      <div class="h-6 w-[1px] bg-[#333]"></div>

      <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
        <i class="fab fa-twitch"></i> CONNEXION
      </button>

      <div id="user-area" class="hidden flex items-center gap-3">
        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-[#00f2ea]">
        <span id="user-name" class="font-bold text-white text-sm"></span>
        <button onclick="logout()" class="text-gray-500 hover:text-white">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="mb-4 relative group">
    <div id="carousel" class="carousel-track">
      <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
        <i class="fas fa-satellite-dish mb-2"></i><br>
        Connectez-vous pour voir vos cha√Ænes.
      </div>
    </div>
    <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
  </div>

  <div id="stream-row" class="flex-grow grid grid-cols-12 gap-6 min-h-0 w-full overflow-x-auto">

    <div class="col-span-8 flex flex-col gap-4 min-h-0 min-w-[720px]">

      <div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl player-shell">
        <div class="bg-[#080808] p-3 flex justify-between items-center border-b border-[#222]">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
            <span id="current-channel-display" class="font-orbitron text-[#00f2ea] text-sm tracking-wider truncate">OFFLINE</span>
            <span id="player-mode-badge" class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400 flex-shrink-0">AUTO</span>
            <span id="viewer-count" class="text-[10px] text-[#ff0099] font-bold flex-shrink-0">0 viewers</span>
          </div>

          <div class="flex gap-2 flex-shrink-0">
            <button onclick="cycle('prev')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="cycle('next')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div id="video-container" class="flex-grow bg-black relative w-full h-full overflow-hidden">
  <div id="player-tools" style="position:absolute;top:10px;right:10px;z-index:50;display:flex;gap:8px;">
    <button id="tool-mosaic" class="toolbtn" onclick="openMosaic()">üì∫</button>
    <button id="tool-fantasy" class="toolbtn" onclick="openFantasy()">üèÜ</button>
    <button id="tool-ambilight" class="toolbtn" onclick="toggleAmbilight()">üí°</button>
    <button id="tool-vibe" class="toolbtn" onclick="toggleVibe()">üß†</button>
  </div>
  <div id="ambilight" aria-hidden="true"></div>
</div>
      </div>

      <div id="under-module" class="glass-panel rounded-lg overflow-hidden min-h-[360px] full-width-module">
        <div class="u-nav" id="under-tabs-nav">
          <button class="u-tab-btn active" data-ut="overview"><i class="fas fa-bolt mr-1"></i> OVERVIEW <span class="help-dot" onclick="openHelp('overview');event.stopPropagation()">?</span></button>
          <button class="u-tab-btn" data-ut="analytics"><i class="fas fa-chart-line mr-1"></i> ANALYTICS PRO <span class="help-dot" onclick="openHelp('analytics');event.stopPropagation()">?</span></button>
          <button class="u-tab-btn" data-ut="niche"><i class="fas fa-compass mr-1"></i> NICHE <span class="help-dot" onclick="openHelp('niche');event.stopPropagation()">?</span></button>
</div>

        <div id="under-overview" class="u-tab-panel active p-4 bg-[#0b0b0d]">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Growth Score</div>
              <div id="kpi-growth-score" class="text-2xl font-orbitron text-[#00f2ea]">--</div>
              <div id="kpi-growth-label" class="text-[10px] text-gray-400 mt-1">--</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Moy. viewers (30j)</div>
              <div id="kpi-avg" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">donn√©es Firestore</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Pic viewers</div>
              <div id="kpi-peak" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">sur p√©riode</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Croissance</div>
              <div id="kpi-growth" class="text-2xl font-orbitron text-[#ff0099]">--</div>
              <div class="text-[10px] text-gray-500 mt-1">d√©but ‚Üí fin</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-bell mr-1"></i> Alertes automatiques
              </h4>
              <div id="alerts-box" class="text-xs text-gray-400">‚Äî</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-wave-square mr-1"></i> Courbe daily
              </h4>
              <div class="h-44"><canvas id="chartChannelDaily"></canvas></div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222] lg:col-span-2">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-magic mr-1"></i> IA ‚Äì plan d‚Äôaction
              </h4>
              <button id="btn-ai-reco" onclick="loadAIReco()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
                ‚ö° G√©n√©rer des recommandations
              </button>
              <div id="ai-reco-box" class="mt-3 text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto bg-[#0a0a0a] border border-[#222] rounded p-2 hidden"></div>
            </div>
          </div>
        </div>

        <div id="under-analytics" class="u-tab-panel p-4 bg-[#0b0b0d]">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Volatilit√©</div>
              <div id="kpi-volatility" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">plus bas = plus stable</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Heures / semaine (estim.)</div>
              <div id="kpi-hours" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">bas√© sur snapshots</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">√âchantillons</div>
              <div id="kpi-samples" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">jours couverts</div>
            </div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-flask mr-1"></i> Simulation</h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
              <input id="sim-hours" type="number" min="1" max="80" value="12" class="cyber-input" placeholder="Heures / semaine">
              <button onclick="runSimulation()" class="bg-[#ff0099] text-white px-4 rounded font-bold hover:bg-white hover:text-black transition font-orbitron text-xs">
                SIMULER
              </button>
              <div id="sim-result" class="text-xs text-gray-300 flex items-center bg-[#0a0a0a] border border-[#222] rounded px-3">--</div>
            </div>
          </div>
        </div>

        <div id="under-niche" class="u-tab-panel p-4 bg-[#0b0b0d]">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-crosshairs mr-1"></i> Cha√Æne vs Jeu</h4>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Saturation</div>
                <div id="niche-sat" class="text-xl font-orbitron text-[#00f2ea]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">D√©couvrabilit√©</div>
                <div id="niche-discover" class="text-xl font-orbitron text-[#ff0099]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Position</div>
                <div id="niche-position" class="text-xl font-orbitron text-white">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Verdict</div>
                <div id="niche-verdict" class="text-xl font-orbitron text-white">--</div>
              </div>
            </div>

            <div class="mt-3 text-xs text-gray-300" id="niche-details">‚Äî</div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-fire mr-1"></i> Heatmap meilleures heures (jeu)</h4>
            <div class="h-44"><canvas id="chartGameHours"></canvas></div>
            <div class="text-[10px] text-gray-500 mt-2">Plus haut = plus d‚Äôopportunit√© (viewers / concurrence).</div>
          </div>
        </div>
      </div>
</div>

      <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] scrollbar-thin">
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
            <div class="text-[10px] text-gray-500 uppercase">Viewers Totaux</div>
            <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
          </div>
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
            <div class="text-[10px] text-gray-500 uppercase">Cha√Ænes FR</div>
            <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-chart-line mr-1"></i> Tendance</h4>
            <div class="h-40"><canvas id="chartViewers"></canvas></div>
          </div>
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
            <div class="h-48"><canvas id="chartGames"></canvas></div>
          </div>
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
            <div class="h-40"><canvas id="chartLangs"></canvas></div>
          </div>
        </div>
      </div>

      <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] space-y-6 scrollbar-thin">

        <div class="best-time-tool">
          <h4>üéØ BEST TIME TO STREAM</h4>
          <input id="best-time-game" type="text" placeholder="Jeu ex: League of Legends...">
          <button id="analyze-schedule-btn" onclick="analyzeBestTime()"><i class="fas fa-clock"></i> ANALYSER</button>
          <div id="best-time-loading" style="display:none; text-align:center; margin-top:10px; color:#00f2ea;">
            <span class="best-time-spinner"></span>Analyse en cours...
          </div>
          <div id="best-time-results" class="best-time-results" style="display:none;"></div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">SCANNER IA</h3>
          <div class="flex gap-2 mb-3">
            <input id="scan-query" type="text" placeholder="Pseudo ex: ZeratoR" class="cyber-input">
            <button onclick="runScan()" class="bg-[#00f2ea] text-black px-4 rounded font-bold hover:bg-white">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div id="scan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
            <div class="flex gap-3 items-center mb-3">
              <img id="scan-img" src="" class="w-12 h-12 rounded-full border border-[#00f2ea]">
              <div>
                <div id="scan-name" class="font-bold text-white">--</div>
                <div id="scan-game" class="text-xs text-gray-500">--</div>
              </div>
            </div>
            <div id="scan-ai" class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto"></div>
          </div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">RAID FINDER</h3>
          <div class="flex gap-2 mb-3">
            <input id="raid-game" type="text" placeholder="Jeu ex: League" class="cyber-input">
            <input id="raid-viewers" type="number" placeholder="Max viewers" class="cyber-input" value="100">
          </div>
          <button onclick="runRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white mb-3">üîç CHERCHER</button>

          <div id="raid-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
            <img id="raid-img" src="" class="w-full h-40 rounded mb-3 object-cover">
            <div id="raid-info" class="text-xs text-gray-300"></div>
            <button id="raid-btn" onclick="goToRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold mt-2 hover:bg-white">üéÆ ALLER AU RAID</button>
          </div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">CO-STREAM MATCH</h3>
          <div class="text-xs text-gray-400 mb-2">Trouve un co-streamer compatible (jeu/langue/taille).</div>
          <button id="costream-btn" onclick="loadCoStreamer()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
            ü§ù TROUVER
          </button>
          <div id="costream-out" class="mt-3 bg-[#151515] p-3 rounded border border-[#222]" style="display:none;"></div>
        </div>

        <div>
          <h3 class="text-[#ff0099] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">BOOST</h3>
          <input id="boost-query" type="text" placeholder="Cha√Æne..." class="cyber-input mb-2">
          <button onclick="runBoost()" class="w-full bg-[#ff0099] text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition">ACTIVER</button>
          <div id="boost-msg" class="text-center text-xs mt-2 text-green-400"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="twitflix-modal" class="tf-modal-overlay">
    <div class="tf-modal-content">
      <div class="tf-topbar">
        <div class="tf-brand"><span class="dot"></span><span><span style="color:#00f2ea;">TWIT</span>FLIX</span></div>

        <div class="tf-actions">
          <div class="tf-search-wrap">
            <i class="fas fa-search tf-search-ico"></i>
            <input id="twitflix-search" class="tf-search" type="text" placeholder="Rechercher un jeu (ex: Minecraft, Valorant...)" autocomplete="off">
          </div>

          <div class="tf-view-toggle">
            <button id="tf-btn-rows" class="tf-toggle-btn active" type="button" onclick="setTwitFlixView('rows')">LIGNES</button>
            <button id="tf-btn-az" class="tf-toggle-btn" type="button" onclick="setTwitFlixView('az')">A‚ÄìZ</button>
          </div>

          <i class="fas fa-times tf-close" onclick="closeTwitFlix()"></i>
        </div>
      </div>

      <div class="tf-sub" style="display:none;"></div>

      <div class="tf-hero"><img id="tf-hero-bg" class="tf-hero-bg" src="" alt=""><div class="tf-hero-content"><div><div id="tf-hero-title" class="tf-hero-title">TWITFLIX</div><div id="tf-hero-sub" class="tf-hero-sub">D√©couvre des jeux, survole pour une preview, clique pour lancer un stream.</div></div></div></div>

      <div id="twitflix-grid" class="tf-grid">
        <div id="tf-loading" class="text-center w-full text-gray-500 py-20">
          <i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...
        </div>
      </div>
    </div>
  </div></div>

  <script>
    const API_BASE = window.location.origin;
    const __urlParams = new URLSearchParams(window.location.search);
    const TWITCH_PARENT = __urlParams.get('parent') || window.location.hostname;
    const PARENT_DOMAINS = ['localhost','127.0.0.1',window.location.hostname,'justplayer.fr','www.justplayer.fr'];

    // --- SFX (Base64 short sounds) ---
    // Son "Open/Whoosh" court
    const sfxOpen = new Audio("data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 
    // (J'ai mis un placeholder vide pour la taille du code, en vrai je vais g√©n√©rer un son synth√©tique simple via WebAudio ou un vrai Base64 si tu veux, mais pour l'instant simulons par log ou un beep simple)
    // Pour que √ßa marche vraiment sans fichier externe, voici des sons tr√®s courts encod√©s:
    
    // Son "Futuristic Click"
    const sfxClick = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 

    // Fonction de lecture s√©curis√©e
    function playSound(type) {
        // En prod, remplacez les src ci-dessus par de vrais fichiers mp3/wav
        // ou des base64 valides. Ici c'est pour l'exemple structurel.
        // ex: if(type==='open') sfxOpen.play().catch(()=>{});
        // ex: if(type==='click') sfxClick.play().catch(()=>{});
        console.log("üîä Audio:", type);
    }

    let socket;
    let currentChannel = 'twitch';
    let currentUser = null;
    let charts = {};
    let raidTarget = null;

    let currentChannelId = null;
    let currentGameId = null;
    let currentGameName = null;

    // TwitFlix infinite scroll
    let currentCursor = null;
    let isLoadingGames = false;

    // INIT
    window.addEventListener('load', async () => {
      initUnderTabs();
      await checkAuth();
      initPlayer();
      loadStatsDashboard();
      initCarouselScroll();
      initSocket();
      initFirebaseStatus();
      setInterval(loadStatsDashboard, 5 * 60 * 1000);
      
      // Infinite scroll listener
      const tfGrid = document.getElementById('twitflix-grid');
      if(tfGrid){
        tfGrid.addEventListener('scroll', () => {
             if (tfGrid.scrollTop + tfGrid.clientHeight >= tfGrid.scrollHeight - 200) {
                 loadMoreCategories();
             }
        });
      }
    });

    function initUnderTabs(){
      const nav = document.getElementById('under-tabs-nav');
      if (!nav) return;
      nav.querySelectorAll('.u-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ut');
          if(id === 'bourse'){ setTimeout(refreshBoursePanel, 50); }
          nav.querySelectorAll('.u-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#under-overview,#under-analytics,#under-niche').forEach(p=>p.classList.remove('active'));
          const panel = document.getElementById(`under-${id}`);
          if (panel) panel.classList.add('active');
        });
      });
    }

    // FIREBASE STATUS
    async function initFirebaseStatus() {
      async function checkStatus() {
        try {
          const response = await fetch(`${API_BASE}/firebase_status`);
          const data = await response.json();
          const statusEl = document.getElementById('socket-status');
          if (data.connected) {
            statusEl.innerText = 'HUB SECURE';
            statusEl.className = 'text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded connected';
          } else {
            statusEl.innerText = 'HUB DISCONNECTED';
            statusEl.className = 'text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded';
          }
        } catch (error) {
          console.error('Firebase status error:', error);
        }
      }
      checkStatus();
      setInterval(checkStatus, 5000);
    }

    // AUTH
    async function checkAuth() {
      const res = await fetch(`${API_BASE}/twitch_user_status`);
      const data = await res.json();
      if (data.is_connected) {
        currentUser = data.display_name;
        document.getElementById('hub-user-display').innerText = data.display_name;

        document.getElementById('btn-auth').classList.add('hidden');
        document.getElementById('user-area').classList.remove('hidden');

        document.getElementById('user-name').innerText = data.display_name;
        if (data.profile_image_url) document.getElementById('user-avatar').src = data.profile_image_url;

        await loadFollowed();
      }
    }

    function startAuth() {
      window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=700');
      const check = setInterval(async () => {
        const res = await fetch(`${API_BASE}/twitch_user_status`);
        const data = await res.json();
        if (data.is_connected) { clearInterval(check); location.reload(); }
      }, 1000);
    }

    function logout() { fetch(`${API_BASE}/twitch_logout`, { method:'POST' }).then(()=>location.reload()); }

    // PLAYER
    async function initPlayer() {
      const res = await fetch(`${API_BASE}/get_default_stream`);
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('player-mode-badge').innerText = data.mode || 'AUTO';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    function loadPlayerEmbed(channel) {
      const container = document.getElementById('video-container');
      const parentParam = PARENT_DOMAINS.join('&parent=');
      const iframeUrl = `https://player.twitch.tv/?channel=${channel}&parent=${parentParam}&theme=dark`;
      container.innerHTML = `<iframe src="${iframeUrl}" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no" style="border:none;width:100%;height:100%;"></iframe>`;
      loadStreamInfo(channel);
    }

    function loadStreamInfo(channel) {
      fetch(`${API_BASE}/stream_info`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ channel })
      })
      .then(r=>r.json())
      .then(data=>{
        if (data.success && data.stream) {
          const title = data.stream.title || 'Sans titre';
          const viewers = data.stream.viewer_count || 0;

          const display = document.getElementById('current-channel-display');
          const titleText = title.length > 40 ? title.substring(0,40) + '...' : title;
          display.innerText = `${channel.toUpperCase()} ‚Ä¢ ${titleText}`;
          display.title = title;

          document.getElementById('viewer-count').innerText = `${viewers.toLocaleString()} viewers`;

          currentGameId = data.stream.game_id || null;
          currentGameName = data.stream.game_name || null;

          // üî• Pro data sous le live
          loadChannelProData(channel);
        } else {
          document.getElementById('viewer-count').innerText = `0 viewers`;
        }
      })
      .catch(e=>console.error('Stream info error:', e));
    }

    function updateTwitchChatFrame(channel){
      const parentParam = PARENT_DOMAINS.join('&parent=');
      // FORCE DARK THEME
      const url = `https://www.twitch.tv/embed/${channel}/chat?parent=${parentParam}&theme=dark&darkpopout`;
      const frame = document.getElementById('twitch-chat-frame');
      if (frame) frame.src = url;
    }

    async function cycle(dir){
      const res = await fetch(`${API_BASE}/cycle_stream`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ direction: dir })
      });
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('viewer-count').innerText = '-- viewers';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    // CAROUSEL
    function initCarouselScroll(){
      const el = document.getElementById('carousel');
      if (!el) return;
      el.addEventListener('wheel',(evt)=>{ evt.preventDefault(); el.scrollLeft += evt.deltaY; }, { passive:false });
    }

    async function loadFollowed(){
      const el = document.getElementById('carousel');
      el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-[#00f2ea]"></i></div>';
      try{
        const res = await fetch(`${API_BASE}/followed_streams`);
        const data = await res.json();
        if (data.success && data.streams.length > 0){
          el.innerHTML = '';
          data.streams.forEach(s=>{
            const thumb = (s.thumbnail_url||'').replace('{width}','400').replace('{height}','225');
            el.innerHTML += `
              <div class="stream-card flex-shrink-0" onclick="changeChannel('${s.user_login}')">
                <img src="${thumb}" class="card-img" onerror="this.src='https://via.placeholder.com/400x225'">
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">
                  <div class="font-bold text-white text-sm truncate">${s.user_name}</div>
                </div>
                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div>
              </div>`;
          });
        } else {
          el.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Aucune cha√Æne suivie en live.</div>';
        }
      }catch(e){
        console.error('Carousel error:', e);
        el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur</div>';
      }
    }

    function changeChannel(channel){
      currentChannel = channel;
      document.getElementById('current-channel-display').innerText = channel.toUpperCase();
      document.getElementById('viewer-count').innerText = '-- viewers';
      loadPlayerEmbed(channel);
      updateTwitchChatFrame(channel);
    }

    // RIGHT TABS
    function openTab(e, id){
      document.querySelectorAll('#tab-chat,#tab-stats,#tab-tools').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab-nav .tab-btn').forEach(el=>el.classList.remove('active'));
      document.getElementById(`tab-${id}`).classList.add('active');
      if (e?.currentTarget) e.currentTarget.classList.add('active');
    }

    function toggleChatMode(mode){
      const twitch = document.getElementById('chat-container-twitch');
      const hub = document.getElementById('chat-container-hub');
      const btnTw = document.getElementById('btn-mode-twitch');
      const btnHb = document.getElementById('btn-mode-hub');

      if (mode === 'hub'){
        twitch.classList.add('hidden');
        hub.classList.remove('hidden'); hub.classList.add('flex');
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded';
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      } else {
        hub.classList.add('hidden'); hub.classList.remove('flex');
        twitch.classList.remove('hidden');
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded';
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      }
    }

    // SOCKET.IO
    function initSocket(){
      if (window.__hubSocketInited) return;
      window.__hubSocketInited = true;

      try{
        socket = io(undefined, { transports: ['websocket','polling'] });

        const status = document.getElementById('socket-status');
        const setStatus = (ok) => {
          if (!status) return;
          status.textContent = ok ? 'HUB CONNECT√â' : 'HUB D√âCONNECT√â';
          status.className = ok
            ? 'text-xs font-bold px-2 py-1 rounded bg-[#00f2ea] text-black'
            : 'text-xs font-bold px-2 py-1 rounded bg-red-600 text-white';
        };

        setStatus(false);
        socket.on('connect', () => setStatus(true));
        socket.on('disconnect', () => setStatus(false));
        socket.on('connect_error', () => setStatus(false));

        // Anti-doublon (√©vite le double affichage quand le serveur renvoie la m√™me chose via 2 events)
        const seen = new Set();

        // Helpers: √©mettre "nouvelle" ET "ancienne" API (compat)
        window.emitHubMessage = (payload) => {
          if (!socket) return;
          socket.emit('chat message', payload);
          socket.emit('hub:message', payload); // compat si backend ancien
        };
        window.emitHubReact = (payload) => {
          if (!socket) return;
          socket.emit('chat react', payload);
          socket.emit('hub:react', payload); // compat si backend ancien
        };

        const box = document.getElementById('hub-messages');

        const replaceAllMessages = (msgs) => {
          if (!box) return;
          box.innerHTML = '';
          (msgs || []).forEach(m => {
            if (m && m.id) seen.add(m.id);
            renderHubMessage(m);
          });
          box.scrollTop = box.scrollHeight;
        };

        // === API actuelle (app.js): historique + messages + updates r√©actions
        socket.on('chat history', (msgs) => {
          try { replaceAllMessages(msgs); } catch(_){}
        });

        socket.on('chat message', (msg) => {
          try{
            if (!msg || !msg.id) return;
            if (seen.has(msg.id)) return;
            seen.add(msg.id);
            if (seen.size > 1200) {
              const arr = Array.from(seen);
              for (let i=0;i<400;i++) seen.delete(arr[i]);
            }
            renderHubMessage(msg);
          }catch(_){}
        });

        socket.on('chat update', ({ id, reactions }) => {
          try{
            const el = document.querySelector(`[data-msg-id="${cssEscape(id)}"] .hub-reactions`);
            if (!el) return;
            el.innerHTML = renderReactionsHtml(reactions || {});
          }catch(_){}
        });

        // === API legacy (si jamais): hub:init / hub:message / hub:react
        socket.on('hub:init', (data) => {
          try{
            const msgs = (data && data.messages) ? data.messages : [];
            replaceAllMessages(msgs);

            if (data && data.profile){
              window.__hubProfile = data.profile;
              renderHubProfile();
            }
          }catch(_){}
        });

        socket.on('hub:message', (msg) => {
          try{
            if (!msg || !msg.id) return;
            if (seen.has(msg.id)) return;
            seen.add(msg.id);
            renderHubMessage(msg);
          }catch(_){}
        });

        socket.on('hub:react', ({ messageId, reactions }) => {
          try{
            const el = document.querySelector(`[data-msg-id="${cssEscape(messageId)}"] .hub-reactions`);
            if (!el) return;
            el.innerHTML = renderReactionsHtml(reactions || {});
          }catch(_){}
        });

      }catch(e){
        console.error('Socket init error', e);
      }
    }

    function sendHubMessage(e){
      e.preventDefault();
      const input = document.getElementById('hub-input');
      const raw = (input?.value || '').trim();
      if (!raw) return;

      // /gif <url>
      let gif = '';
      let text = raw;
      const m = raw.match(/^\/gif\s+(https?:\/\/\S+)/i);
      if (m){
        gif = m[1];
        text = '';
      }

      if (window.emitHubMessage) window.emitHubMessage({ user: currentUser || 'Anon', text, gif });
      input.value = '';
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }
    // ================== HUB UI (persistant + emotes + gifs + r√©actions) ==================
    const EMOTE_MAP = {
      ':kappa:':'üòè', ':pog:':'ü§Ø', ':gg:':'üèÜ', ':love:':'üíñ',
      ':hype:':'üöÄ', ':rip:':'ü™¶', ':clap:':'üëè', ':fire:':'üî•'
    };

    function parseEmotes(text){
      let out = String(text||'');
      Object.keys(EMOTE_MAP).forEach(k => {
        out = out.split(k).join(EMOTE_MAP[k]);
      });
      return out;
    }

    function cssEscape(s){
      return String(s||'').replace(/[^a-zA-Z0-9_-]/g, '_');
    }

    function renderHubProfile(){
      // Optionnel : affiche grade / XP dans le header si tu as des √©l√©ments d√©di√©s
      // On garde simple pour ne pas casser ton layout
    }

    function renderReactionsHtml(reactions){
      const entries = Object.entries(reactions||{}).sort((a,b)=>b[1]-a[1]);
      return entries.map(([emo,count]) => `<span class="hub-react-pill">${escapeHtml(emo)} <span class="text-gray-400">${count}</span></span>`).join('');
    }

    function renderHubMessage(msg){
      const box = document.getElementById('hub-messages');
      if (!box) return;

      const id = msg.id || (Date.now()+'-'+Math.random().toString(36).slice(2));
      const user = escapeHtml(msg.user || 'Anon');
      const grade = msg.grade?.label || msg.grade?.key || '';
      const badgeColor = msg.grade?.color || '#9ca3af';
      const text = msg.text ? escapeHtml(parseEmotes(msg.text)) : '';
      const gif = msg.gif ? String(msg.gif) : '';
      const ts = msg.ts ? new Date(msg.ts) : new Date();

      const el = document.createElement('div');
      el.className = 'hub-msg';
      el.setAttribute('data-msg-id', id);

      el.innerHTML = `
        <div class="flex items-center gap-2">
          <strong class="text-[#00f2ea]">${user}</strong>
          ${grade ? `<span class="hub-badge" style="border-color:${badgeColor}; color:${badgeColor};">${escapeHtml(grade)}</span>` : ``}
          <span class="text-[10px] text-gray-600 ml-auto">${ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
        ${text ? `<div class="text-gray-200 mt-1">${text}</div>` : ``}
        ${gif ? `<img src="${escapeHtml(gif)}" class="hub-gif" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">` : ``}
        <div class="hub-reactions">${renderReactionsHtml(msg.reactions || {})}</div>
        <div class="hub-react-row flex gap-2 mt-2">
          <button type="button" class="hub-react-btn" data-react="üî•" data-msg="${'${encodeURIComponent(id)}'}">üî•</button>
          <button type="button" class="hub-react-btn" data-react="üòÇ" data-msg="${'${encodeURIComponent(id)}'}">üòÇ</button>
          <button type="button" class="hub-react-btn" data-react="üíñ" data-msg="${'${encodeURIComponent(id)}'}">üíñ</button>
          <button type="button" class="hub-react-btn" data-react="üëç" data-msg="${'${encodeURIComponent(id)}'}">üëç</button>
        </div>
      `;

      box.appendChild(el);
      box.scrollTop = box.scrollHeight;
    }

    function reactToMsg(messageIdEscaped, emoji){
      // On retrouve l'id original via dataset
      const el = document.querySelector(`[data-msg-id]`);
      // On envoie directement l'id pass√© (d√©j√† safe c√¥t√© serveur)
      if (socket) if (window.emitHubReact) window.emitHubReact({ messageId: messageIdEscaped.replace(/_/g,'-'), emoji });
    }

    function insertAtCursor(input, text){
      const start = input.selectionStart || 0;
      const end = input.selectionEnd || 0;
      const val = input.value || '';
      input.value = val.slice(0,start) + text + val.slice(end);
      input.focus();
      const pos = start + text.length;
      input.setSelectionRange(pos,pos);
    }

    async function openGifModal(){
      const modal = document.getElementById('hub-gif-modal');
      const grid = document.getElementById('hub-gif-grid');
      const search = document.getElementById('hub-gif-search');
      if (!modal || !grid || !search) return;

      modal.classList.remove('hidden');
      grid.innerHTML = `<div class="col-span-full text-gray-400 text-sm">Chargement...</div>`;

      async function loadTrending(){
        const r = await fetch(`${API_BASE}/api/gifs/trending?limit=28`);
        const j = await r.json();
        if (!j.success) {
          grid.innerHTML = `<div class="col-span-full text-red-400 text-sm">GIF indisponibles (ajoute GIPHY_API_KEY c√¥t√© serveur).</div>`;
          return;
        }
        renderGifGrid(j.gifs || []);
      }

      function renderGifGrid(items){
        grid.innerHTML = '';
        items.forEach(g => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'rounded-xl overflow-hidden border border-[#222] hover:border-[#00f2ea] bg-black';
          b.innerHTML = `<img src="${escapeHtml(g.url)}" class="w-full h-auto block" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">`;
          b.onclick = () => {
            if (socket) if (window.emitHubMessage) window.emitHubMessage({ user: currentUser || 'Anon', text:'', gif: g.url });
            modal.classList.add('hidden');
          };
          grid.appendChild(b);
        });
      }

      let t = null;
      search.oninput = () => {
        clearTimeout(t);
        const q = (search.value || '').trim();
        t = setTimeout(async () => {
          if (!q) return loadTrending();
          grid.innerHTML = `<div class="col-span-full text-gray-400 text-sm">Recherche...</div>`;
          const r = await fetch(`${API_BASE}/api/gifs/search?q=${encodeURIComponent(q)}&limit=28`);
          const j = await r.json();
          if (!j.success) {
            grid.innerHTML = `<div class="col-span-full text-red-400 text-sm">GIF indisponibles.</div>`;
            return;
          }
          renderGifGrid(j.gifs || []);
        }, 220);
      };

      await loadTrending();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const emojiBtn = document.getElementById('hub-emoji-btn');
      const emojiPanel = document.getElementById('hub-emoji-panel');
      const gifBtn = document.getElementById('hub-gif-btn');
      const gifClose = document.getElementById('hub-gif-close');
      const gifModal = document.getElementById('hub-gif-modal');
      const input = document.getElementById('hub-input');

      if (emojiBtn && emojiPanel){
        emojiBtn.onclick = () => emojiPanel.classList.toggle('hidden');
        emojiPanel.querySelectorAll('.hub-emo').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!input) return;
            insertAtCursor(input, btn.textContent + ' ');
            emojiPanel.classList.add('hidden');
          });
        });
        document.addEventListener('click', (e) => {
          if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) emojiPanel.classList.add('hidden');
        });
      }

      if (gifBtn){
        gifBtn.onclick = openGifModal;
      }
      if (gifClose && gifModal){
        gifClose.onclick = () => gifModal.classList.add('hidden');
      }
      if (gifModal){
        gifModal.addEventListener('click', (e) => {
          if (e.target === gifModal) gifModal.classList.add('hidden');
        });
      }
    });


    // TWITFLIX ‚Äî Netflix-like catalogue (only). Does NOT touch the rest of the app.
    // Requires:
    //  - GET  /api/categories/top?cursor=...
    //  - (optional) GET /api/categories/search?q=...
    //  - POST /api/stream/by_category { game_id } -> { channel }

    let tfModalOpen = false;
    let tfViewMode = 'rows'; // rows | az
    let tfAllCategories = [];
    let tfCursor = null;
    let tfLoading = false;
    let tfHasMore = true;
    let tfLastLoadAt = 0;

    let tfSearchQuery = '';
    let tfSearchResults = [];
    let tfSearchTimer = null;

    let tfObserver = null;

    // Preview cache
    const tfPreviewCache = new Map(); // gameId -> {channel, t}
    const tfPreviewInflight = new Map();
    const TF_PREVIEW_TTL = 10 * 60 * 1000;

    function tfNormalizeBoxArt(url){
      // request higher res to avoid blur, then we downscale in CSS
      const u = String(url || '');
      if (!u) return '';
      return u.replace('{width}','600').replace('{height}','800');
    }

    function setTwitFlixView(mode){
      tfViewMode = (mode === 'az') ? 'az' : 'rows';
      const bRows = document.getElementById('tf-btn-rows');
      const bAz = document.getElementById('tf-btn-az');
      if (bRows && bAz){
        bRows.classList.toggle('active', tfViewMode === 'rows');
        bAz.classList.toggle('active', tfViewMode === 'az');
      }
      renderTwitFlix();
    }

    async function openTwitFlix(){
      const modal = document.getElementById('twitflix-modal');
      const host = document.getElementById('twitflix-grid');
      const search = document.getElementById('twitflix-search');

      tfModalOpen = true;
      modal.classList.add('active');

      // reset
      tfViewMode = 'rows';
      tfAllCategories = [];
      tfCursor = null;
      tfLoading = false;
      tfHasMore = true;
      tfSearchQuery = '';
      tfSearchResults = [];
      if (search) search.value = '';

      // hero default
      tfSetHero({ title: 'TWITFLIX', sub: 'D√©couvre des jeux, survole pour une preview, clique pour lancer un stream.' });

      // empty ui
      if (host){
        host.innerHTML = '<div id="tf-loading" class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...</div>';
      }

      setTwitFlixView('rows');

      // search handler (server if possible, fallback local)
      if (search){
        search.oninput = (e) => {
          const v = String(e.target.value || '').trim();
          tfSearchQuery = v;

          if (tfSearchTimer) clearTimeout(tfSearchTimer);
          tfSearchTimer = setTimeout(async () => {
            await tfRunSearch(v);
          }, 180);
        };
      }

      // sentinel observer for infinite loading
      tfSetupObserver();

      // warm load (2 pages)
      await tfLoadMore(true);
      await tfLoadMore(true);
      renderTwitFlix();
    }

    function closeTwitFlix(){
      tfModalOpen = false;
      document.querySelectorAll('.tf-card.previewing').forEach(tfStopPreview);
      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
        tfObserver = null;
      }
      const modal = document.getElementById('twitflix-modal');
      modal.classList.remove('active');
    }

    function tfSetupObserver(){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      let sentinel = document.getElementById('tf-sentinel');
      if (!sentinel){
        sentinel = document.createElement('div');
        sentinel.id = 'tf-sentinel';
        sentinel.style.height = '1px';
        host.appendChild(sentinel);
      }

      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
      }

      tfObserver = new IntersectionObserver(async (entries) => {
        if (!tfModalOpen) return;
        if (tfSearchQuery) return; // no infinite scroll while searching
        if (!tfHasMore) return;
        const entry = entries && entries[0];
        if (entry && entry.isIntersecting){
          await tfLoadMore(false);
          renderTwitFlix();
        }
      }, { root: host, threshold: 0.1 });

      tfObserver.observe(sentinel);
    }

    async function tfRunSearch(query){
      const q = String(query || '').trim();
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      if (!q){
        tfSearchResults = [];
        renderTwitFlix();
        return;
      }

      // Try server search (best)
      try{
        const r = await fetch(`${API_BASE}/api/categories/search?q=${encodeURIComponent(q)}`);
        if (r.ok){
          const d = await r.json();
          if (d && d.success && Array.isArray(d.categories)){
            tfSearchResults = d.categories.map(c => ({
              id: c.id,
              name: c.name,
              box_art_url: tfNormalizeBoxArt(c.box_art_url || c.boxArtUrl || '')
            }));
            renderTwitFlix();
            return;
          }
        }
      }catch(_){}

      // Fallback: local filter on already loaded catalogue
      const low = q.toLowerCase();
      tfSearchResults = tfAllCategories
        .filter(c => (c.name||'').toLowerCase().includes(low))
        .slice(0, 120);
      renderTwitFlix();
    }

    async function tfLoadMore(force){
      if (!tfModalOpen) return;
      if (tfLoading) return;
      if (!tfHasMore) return;

      const now = Date.now();
      if (!force && (now - tfLastLoadAt) < 650) return; // throttle
      tfLastLoadAt = now;

      tfLoading = true;

      try{
        let url = `${API_BASE}/api/categories/top`;
        if (tfCursor) url += `?cursor=${encodeURIComponent(tfCursor)}`;

        const res = await fetch(url);
        const data = await res.json();

        const loader = document.getElementById('tf-loading');
        if (loader) loader.remove();

        if (data && data.success && Array.isArray(data.categories)){
          tfCursor = data.cursor || null;

          // If no cursor returned => end
          if (!tfCursor) tfHasMore = false;

          for (const cat of data.categories){
            if (!cat || !cat.id) continue;
            // prevent duplicates
            if (tfAllCategories.find(x => x.id === cat.id)) continue;
            tfAllCategories.push({
              id: cat.id,
              name: cat.name,
              box_art_url: tfNormalizeBoxArt(cat.box_art_url || '')
            });
          }
        } else {
          // stop to avoid looping ‚Äúin the void‚Äù
          tfHasMore = false;
          tfRenderError('Erreur chargement du catalogue.');
        }
      } catch (e){
        tfHasMore = false;
        tfRenderError('Erreur r√©seau TwitFlix.');
      } finally {
        tfLoading = false;
      }
    }

    function tfRenderError(msg){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;
      host.innerHTML = `
        <div class="tf-empty" style="color:#ff8080;">
          ${escapeHtml(msg || 'Erreur')}
          <div><button class="tf-retry" type="button" onclick="tfRetryLoad()">R√©essayer</button></div>
        </div>
      `;
    }

    async function tfRetryLoad(){
      tfHasMore = true;
      await tfLoadMore(true);
      await tfLoadMore(true);
      renderTwitFlix();
      tfSetupObserver();
    }

    function renderTwitFlix(){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      // Keep sentinel at bottom
      const sentinel = document.getElementById('tf-sentinel');

      // SEARCH MODE
      if (tfSearchQuery && tfSearchQuery.trim()){
        host.innerHTML = '';
        const q = tfSearchQuery.trim();
        tfSetHero({ title: q, sub: 'R√©sultats de recherche' });

        if (!tfSearchResults.length){
          host.innerHTML = `<div class="tf-empty">Aucun r√©sultat pour <span style="color:#00f2ea;font-weight:900;">${escapeHtml(q)}</span>.</div>`;
          if (sentinel) host.appendChild(sentinel);
          return;
        }

        const grid = document.createElement('div');
        grid.className = 'tf-search-grid';
        tfSearchResults.forEach(cat => grid.appendChild(tfBuildCard(cat)));
        host.appendChild(grid);
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      // CATALOG MODE
      host.innerHTML = '';
      tfSetHero({ title: 'TWITFLIX', sub: 'Survole un jeu pour la preview, clique pour lancer un stream.' });

      const list = tfAllCategories.slice(0);
      if (!list.length){
        host.innerHTML = '<div class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      if (tfViewMode === 'az'){
        tfRenderAZ(host, list);
      } else {
        tfRenderRows(host, list);
      }

      if (!tfHasMore){
        const end = document.createElement('div');
        end.className = 'tf-end';
        end.innerHTML = 'Fin du catalogue.';
        host.appendChild(end);
      } else if (tfLoading){
        const loading = document.createElement('div');
        loading.className = 'tf-empty';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
        host.appendChild(loading);
      }

      if (sentinel) host.appendChild(sentinel);
    }

    function tfRenderRows(host, list){
      const picks1 = list.slice(0, 28);
      const picks2 = list.slice(28, 56);
      const picks3 = tfShuffle(list).slice(0, 28);
      const picks4 = tfShuffle(list).slice(28, 56);

      host.appendChild(tfBuildRow('Top du moment <span>(Twitch)</span>', picks1));
      host.appendChild(tfBuildRow('Tendances <span>FR</span>', picks2));
      host.appendChild(tfBuildRow('D√©couverte <span>(al√©atoire)</span>', picks3));
      host.appendChild(tfBuildRow('√Ä essayer <span>ce soir</span>', picks4));
    }

    function tfRenderAZ(host, list){
      // group
      const groups = {};
      for (const c of list){
        const n = (c.name || '').trim();
        if (!n) continue;
        const first = n[0].toUpperCase();
        const key = /[A-Z]/.test(first) ? first : (/[0-9]/.test(first) ? '0-9' : '#');
        (groups[key] ||= []).push(c);
      }
      const keys = Object.keys(groups).sort((a,b)=>{
        if (a==='0-9') return -1;
        if (b==='0-9') return 1;
        if (a==='#') return 1;
        if (b==='#') return -1;
        return a.localeCompare(b);
      });

      const bar = document.createElement('div');
      bar.className = 'tf-azbar';
      bar.innerHTML = keys.map(k => `<a class="tf-azlink" href="#tf-${k.replace(/[^a-z0-9]/ig,'_')}">${k}</a>`).join('');
      host.appendChild(bar);

      keys.forEach(k => {
        groups[k].sort((x,y)=> (x.name||'').localeCompare(y.name||''));
        const row = tfBuildRow(`<span>${k}</span>`, groups[k], `tf-${k.replace(/[^a-z0-9]/ig,'_')}`);
        host.appendChild(row);
      });
    }

    function tfBuildRow(titleHtml, items, id){
      const row = document.createElement('div');
      row.className = 'tf-row';
      if (id) row.id = id;

      const title = document.createElement('div');
      title.className = 'tf-row-title';
      title.innerHTML = titleHtml;

      const track = document.createElement('div');
      track.className = 'tf-row-track';

      (items || []).forEach(cat => track.appendChild(tfBuildCard(cat)));

      row.appendChild(title);
      row.appendChild(track);
      return row;
    }

    function tfBuildCard(cat){
      const div = document.createElement('div');
      div.className = 'tf-card';
      div.dataset.gameId = cat.id;
      div.dataset.gameName = cat.name;

      const poster = tfNormalizeBoxArt(cat.box_art_url || '');

      div.innerHTML = `
        <img class="tf-poster" src="${poster}" loading="lazy" alt="">
        <div class="tf-preview" aria-hidden="true"></div>
        <div class="tf-overlay">
          <div class="tf-name" title="${escapeHtml(cat.name)}">${escapeHtml(cat.name)}</div>
          <div class="tf-actions-row">
            <span class="tf-pill"><i class="fas fa-play"></i> Lire</span>
            <span class="tf-pill ghost"><i class="fas fa-volume-mute"></i> Preview</span>
          </div>
        </div>
      `;

      // hero update on hover/focus
      div.addEventListener('mouseenter', () => tfSetHero({ title: cat.name, poster }));
      div.addEventListener('focus', () => tfSetHero({ title: cat.name, poster }));

      // click play
      div.onclick = () => playTwitFlixCategory(cat.id, cat.name);

      // Hover preview (Netflix-like delay)
      let t = null;
      div.addEventListener('mouseenter', () => { t = setTimeout(() => tfStartPreview(div), 420); });
      div.addEventListener('mouseleave', () => { if (t) clearTimeout(t); tfStopPreview(div); });

      return div;
    }

    function tfSetHero({ title, sub, poster }){
      const bg = document.getElementById('tf-hero-bg');
      const t = document.getElementById('tf-hero-title');
      const s = document.getElementById('tf-hero-sub');
      if (t) t.textContent = String(title || 'TWITFLIX');
      if (s) s.textContent = String(sub || '');
      if (bg){
        if (poster) { bg.src = poster; bg.style.opacity = '.55'; }
        else { bg.removeAttribute('src'); bg.style.opacity = '.15'; }
      }
    }

    async function tfStartPreview(cardEl){
      try{
        if (!cardEl || cardEl.classList.contains('previewing')) return;
        const gameId = String(cardEl.dataset.gameId || '');
        if (!gameId) return;

        const host = cardEl.querySelector('.tf-preview');
        if (!host) return;

        const channel = await tfGetPreviewChannel(gameId);
        if (!channel) return;

        const parent = encodeURIComponent(TWITCH_PARENT || window.location.hostname);
        const src = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=true&autoplay=true`;

        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.allow = 'autoplay; fullscreen';
        iframe.frameBorder = '0';

        host.innerHTML = '';
        host.appendChild(iframe);
        cardEl.classList.add('previewing');
      }catch(_){}
    }

    function tfStopPreview(cardEl){
      try{
        if (!cardEl) return;
        const host = cardEl.querySelector('.tf-preview');
        if (host) host.innerHTML = '';
        cardEl.classList.remove('previewing');
      }catch(_){}
    }

    async function tfGetPreviewChannel(gameId){
      const now = Date.now();
      const cached = tfPreviewCache.get(gameId);
      if (cached && (now - cached.t) < TF_PREVIEW_TTL) return cached.channel;

      if (tfPreviewInflight.has(gameId)) return tfPreviewInflight.get(gameId);

      const p = (async () => {
        try{
          const res = await fetch(`${API_BASE}/api/stream/by_category`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ game_id: gameId })
          });
          const data = await res.json();
          const channel = data && data.success ? data.channel : null;
          if (channel) tfPreviewCache.set(gameId,{ channel, t: Date.now() });
          return channel;
        }catch(_){
          return null;
        }finally{
          tfPreviewInflight.delete(gameId);
        }
      })();

      tfPreviewInflight.set(gameId, p);
      return p;
    }

    async function playTwitFlixCategory(gameId, gameName){
      closeTwitFlix();
      document.getElementById('current-channel-display').innerText = "TWITFLIX‚Ä¶";

      try{
        const res = await fetch(`${API_BASE}/api/stream/by_category`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game_id: gameId })
        });
        const data = await res.json();

        if (data && data.success && data.channel){
          changeChannel(data.channel);
          const badge = document.getElementById('player-mode-badge');
          if (badge) badge.innerText = "TWITFLIX";
        } else {
          alert("Aucun stream trouv√© pour ce jeu.");
          document.getElementById('current-channel-display').innerText = "OFFLINE";
        }
      }catch(_){
        alert("Erreur lors de la recherche TwitFlix.");
      }
    }

    function tfShuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
// BEST TIME

    async function analyzeBestTime(){
      const gameInput = document.getElementById('best-time-game').value.trim();
      if (!gameInput) return alert('Veuillez entrer un nom de jeu');

      const btn = document.getElementById('analyze-schedule-btn');
      const loading = document.getElementById('best-time-loading');
      const results = document.getElementById('best-time-results');

      btn.disabled = true;
      loading.style.display = 'block';
      results.style.display = 'none';
      results.innerHTML = '';

      try{
        const response = await fetch(`${API_BASE}/analyze_schedule`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game: gameInput })
        });
        const data = await response.json();
        results.innerHTML = data.html_response || '<p style="color:#ff6666;">‚ùå Erreur</p>';
        results.style.display = 'block';
      }catch(e){
        results.innerHTML = '<p style="color:#ff6666;">‚ùå Erreur r√©seau</p>';
        results.style.display = 'block';
      }finally{
        btn.disabled = false;
        loading.style.display = 'none';
      }
    }

    // STATS DASH
    async function loadStatsDashboard(){
      try{
        const res = await fetch(`${API_BASE}/api/stats/global`);
        const data = await res.json();
        if (data.success){
          document.getElementById('kpi-viewers').innerText = Number(data.total_viewers||0).toLocaleString();
          document.getElementById('kpi-channels').innerText = data.total_channels;
          renderChart('chartViewers','line',data.history.live.labels,data.history.live.values,'Viewers');
        }

        const resGames = await fetch(`${API_BASE}/api/stats/top_games`);
        const dGames = await resGames.json();
        const labels = (dGames.games||[]).map(g=>g.name);
        const values = (dGames.games||[]).map((g,i)=>(i+1)*20);
        renderChart('chartGames','bar',labels.slice(0,5),values.slice(0,5),'Popularit√©');

        const resLang = await fetch(`${API_BASE}/api/stats/languages`);
        const dLang = await resLang.json();
        const lLabels = (dLang.languages||[]).map(l=>l.name);
        const lValues = (dLang.languages||[]).map(l=>l.percent);
        renderChart('chartLangs','doughnut',lLabels,lValues,'Part');
      }catch(e){ console.error('Stats error:', e); }
    }

    function renderChart(id,type,labels,data,label){
      const el = document.getElementById(id);
      if (!el) return;
      if (charts[id]) charts[id].destroy();

      charts[id] = new Chart(el.getContext('2d'),{
        type,
        data:{ labels, datasets:[{ label, data, borderWidth:1, fill:(type==='line'), tension:.35 }]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:(type==='doughnut'), position:'right', labels:{ color:'white', boxWidth:10 } } },
          scales:{
            x:{ display:(type!=='doughnut'), ticks:{ color:'#666' } },
            y:{ display:(type!=='doughnut'), grid:{ color:'#222' }, ticks:{ color:'#666' } }
          }
        }
      });
    }

    // ===== Sous le live (donn√©es backend) =====
    async function loadChannelProData(login){
      if (!login || login === 'twitch') return;

      try{
        const res = await fetch(`${API_BASE}/api/analytics/channel_by_login/${encodeURIComponent(login)}?days=30`);
        const data = await res.json();

        if (!data.success){
          document.getElementById('kpi-growth-label').innerText =
            data.message || data.error || "Pas assez de donn√©es (laisse tourner le cron).";
          return;
        }

        currentChannelId = data.channel_id || null;

        const k = data.kpis || {};
        const fmt = v => (v==null ? '--' : Number(v).toLocaleString());

        document.getElementById('kpi-avg').innerText = fmt(k.avg_viewers);
        document.getElementById('kpi-peak').innerText = fmt(k.peak_viewers);
        document.getElementById('kpi-growth').innerText = (k.growth_percent!=null ? `${k.growth_percent}%` : '--');
        document.getElementById('kpi-volatility').innerText = fmt(k.volatility);
        document.getElementById('kpi-hours').innerText = (k.hours_per_week_est!=null ? `${k.hours_per_week_est}h` : '--');
        document.getElementById('kpi-samples').innerText = fmt(k.days);

        const gs = k.growth_score;
        document.getElementById('kpi-growth-score').innerText = (gs!=null ? `${gs}/100` : '--');
        document.getElementById('kpi-growth-label').innerText =
          gs==null ? '--' :
          gs>=80 ? 'üî• En forte acc√©l√©ration' :
          gs>=60 ? '‚úÖ Bonne dynamique' :
          gs>=40 ? 'üü° Stable (optimisable)' :
          'üî¥ √Ä relancer';

        if (data.series?.labels?.length){
          renderChart('chartChannelDaily','line',data.series.labels,data.series.values,'Viewers moyens/jour');
        }

        await loadAlerts(login);

        if (currentGameId){
          await loadGameHours(currentGameId);
        }
      }catch(e){
        console.error('loadChannelProData error:', e);
      }
    }

    async function loadAlerts(login){
      const box = document.getElementById('alerts-box');
      if (!box) return;
      box.innerHTML = '<div class="text-gray-500 text-xs"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';

      try{
        let r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
        let data = await r.json();

        if (!data.success || !data.items || data.items.length === 0){
          await fetch(`${API_BASE}/api/alerts/generate`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ login, days:30 })
          }).catch(()=>{});

          r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
          data = await r.json();
        }

        if (!data.success || !data.items){
          box.innerHTML = '<div class="text-gray-500 text-xs">Aucune alerte.</div>';
          return;
        }

        box.innerHTML = '';
        data.items.forEach(a=>{
          box.innerHTML += `
            <div class="bg-[#0a0a0a] border border-[#222] rounded p-2 mb-2">
              <div class="flex items-center justify-between gap-2">
                <div class="text-xs font-bold text-white">${escapeHtml(a.title || 'Alerte')}</div>
                <div class="text-[10px] text-gray-500">${escapeHtml(a.day || '')}</div>
              </div>
              <div class="text-[11px] text-gray-300 mt-1 leading-snug">${escapeHtml(a.message || '')}</div>
            </div>`;
        });

      }catch(e){
        console.error('loadAlerts', e);
        box.innerHTML = '<div class="text-gray-500 text-xs">Erreur alertes.</div>';
      }
    }

    async function loadGameHours(gameId){
      try{
        const r = await fetch(`${API_BASE}/api/games/hours?game_id=${encodeURIComponent(gameId)}&days=7`);
        const data = await r.json();
        if (!data.success || !data.hours) return;

        const labels = data.hours.map(x => `${String(x.hour).padStart(2,'0')}h`);
        const values = data.hours.map(x => (x.discoverability_score || 0));
        renderChart('chartGameHours','line',labels,values,'Opportunit√©');

        const best = data.best || data.hours.slice().sort((a,b)=>(b.discoverability_score||0)-(a.discoverability_score||0))[0];
        document.getElementById('niche-sat').innerText = best?.saturation_score!=null ? `${best.saturation_score}/100` : '--';
        document.getElementById('niche-discover').innerText = best?.discoverability_score!=null ? `${best.discoverability_score}/100` : '--';
        document.getElementById('niche-position').innerText = best ? `${String(best.hour).padStart(2,'0')}h UTC` : '--';
        document.getElementById('niche-verdict').innerText = best?.discoverability_score>=70 ? 'üî• Tr√®s bon' : best?.discoverability_score>=45 ? '‚úÖ OK' : 'üü° Risqu√©';
        document.getElementById('niche-details').innerText =
          best ? `Meilleure fen√™tre d√©tect√©e: ${String(best.hour).padStart(2,'0')}h UTC ‚Ä¢ viewers totaux observ√©s: ${best.total_viewers || 0}` : '‚Äî';
      }catch(e){
        console.error('loadGameHours', e);
      }
    }

    async function loadAIReco(){
      if (!currentChannel || currentChannel === 'twitch') return;
      const box = document.getElementById('ai-reco-box');
      const btn = document.getElementById('btn-ai-reco');

      box.classList.add('hidden');
      box.innerHTML = '';
      btn.disabled = true;
      btn.innerHTML = '<span class="best-time-spinner"></span> G√©n√©ration...';

      try{
        const res = await fetch(`${API_BASE}/api/ai/reco?login=${encodeURIComponent(currentChannel)}&days=30`);
        const data = await res.json();
        box.innerHTML = data.html_response || "<p style='color:#ff6666;'>‚ùå Pas de recommandation</p>";
        box.classList.remove('hidden');
      }catch(e){
        box.innerHTML = "<p style='color:#ff6666;'>‚ùå Erreur IA</p>";
        box.classList.remove('hidden');
      }finally{
        btn.disabled = false;
        btn.innerHTML = '‚ö° G√©n√©rer des recommandations';
      }
    }

    async function runSimulation(){
      const hours = parseInt(document.getElementById('sim-hours').value || '0',10);
      const out = document.getElementById('sim-result');
      if (!currentChannelId || !hours){ out.innerText = '‚Äî'; return; }

      out.innerText = '...';
      try{
        const res = await fetch(`${API_BASE}/api/simulate/growth?channel_id=${encodeURIComponent(currentChannelId)}&hours_per_week=${encodeURIComponent(hours)}&days=30`);
        const data = await res.json();
        if (!data.success){ out.innerText = data.message || 'Pas assez de data'; return; }
        const delta = data.target?.expected_change_percent ?? null;
        const expected = data.target?.expected_avg_viewers ?? null;
        out.innerText = (delta==null || expected==null)
          ? 'OK'
          : `${delta >= 0 ? '+' : ''}${delta}% ‚Ä¢ ~${expected} avg viewers`;
      }catch(e){
        out.innerText = 'Erreur';
      }
    }

    async function loadCoStreamer(){
      const out = document.getElementById('costream-out');
      const btn = document.getElementById('costream-btn');
      if (!out || !btn) return;

      btn.disabled = true;
      out.style.display = 'block';
      out.innerHTML = '<div class="text-gray-500 text-xs"><i class="fas fa-spinner fa-spin"></i> Analyse...</div>';

      try{
        const r = await fetch(`${API_BASE}/api/costream/best?login=${encodeURIComponent(currentChannel)}&days=14`);
        const data = await r.json();

        if (!data.success){
          out.innerHTML = `<p style="color:#ff6666;">‚ùå ${escapeHtml(data.message || 'Impossible')}</p>`;
          return;
        }

        const best = data.best;
        const list = data.candidates || [];

        out.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
            <img src="${best?.profile_image_url || ''}" onerror="this.style.display='none'" class="w-10 h-10 rounded-full border border-[#00f2ea]">
            <div class="min-w-0">
              <div class="text-white font-bold text-sm">${escapeHtml(best?.display_name || '‚Äî')} <span class="text-gray-500">@${escapeHtml(best?.login || '')}</span></div>
              <div class="text-[11px] text-gray-400">Score: <span class="text-[#00f2ea] font-bold">${best?.score ?? '--'}</span></div>
            </div>
            <a class="ml-auto text-[11px] bg-[#00f2ea] text-black px-2 py-1 rounded font-bold" target="_blank" href="https://twitch.tv/${best?.login || ''}">Voir</a>
          </div>
          <div class="text-[11px] text-gray-300">${escapeHtml(best?.why || '')}</div>
          ${list.length ? `
            <div class="mt-3 text-[11px] text-gray-400 font-bold uppercase">Autres options</div>
            <ul class="mt-1 text-[11px] text-gray-300 list-disc pl-5">
              ${list.slice(0,5).map(x=>`<li>${escapeHtml(x.display_name)} ‚Äî score ${x.score}</li>`).join('')}
            </ul>` : '' }
        `;
      }catch(e){
        out.innerHTML = '<p style="color:#ff6666;">‚ùå Erreur r√©seau</p>';
      }finally{
        btn.disabled = false;
      }
    }

    // ====== SCAN / RAID / BOOST (r√©par√©s) ======
    async function runScan(){
      const q = document.getElementById('scan-query').value.trim();
      if (!q) return;

      const box = document.getElementById('scan-res');
      box.classList.remove('hidden');
      document.getElementById('scan-ai').innerHTML = `<span class="best-time-spinner"></span> Scan...`;

      try{
        const r = await fetch(`${API_BASE}/scan_target`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ query:q })
        });
        const data = await r.json();
        if (!data.success){
          document.getElementById('scan-ai').innerHTML = `<p style="color:#ff6666;">‚ùå Introuvable</p>`;
          return;
        }

        if (data.type === 'user'){
          const u = data.user_data;
          document.getElementById('scan-img').src = u.profile_image_url || '';
          document.getElementById('scan-name').innerText = `${u.display_name} (@${u.login})`;
          document.getElementById('scan-game').innerText = `${u.game_name || '‚Äî'} ‚Ä¢ ${u.is_live ? (u.viewer_count+' viewers') : 'offline'}`;

          // mini critique IA (optionnel)
          const ai = await fetch(`${API_BASE}/critique_ia`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ type:'niche', query: u.game_name || q })
          }).then(x=>x.json()).catch(()=>null);

          document.getElementById('scan-ai').innerHTML =
            `<p><strong>Titre:</strong> ${escapeHtml(u.title||'‚Äî')}</p>
             <p><strong>Tags:</strong> ${escapeHtml(u.tags||'‚Äî')}</p>
             <p><strong>Lang:</strong> ${escapeHtml(u.language||'‚Äî')}</p>
             <hr style="border-color:#222;margin:8px 0;">
             ${ai?.html_response || '<p class="text-gray-400">IA indisponible.</p>'}`;
        } else {
          const g = data.game_data;
          document.getElementById('scan-img').src = g.box_art_url || '';
          document.getElementById('scan-name').innerText = `${g.name}`;
          document.getElementById('scan-game').innerText = `Total viewers (snapshot): ${g.total_viewers||0}`;
          document.getElementById('scan-ai').innerHTML = `<p>Score niche estim√©: <strong>${g.ai_calculated_niche_score}</strong></p>`;
        }
      }catch(e){
        document.getElementById('scan-ai').innerHTML = `<p style="color:#ff6666;">‚ùå Erreur</p>`;
      }
    }

    async function runRaid(){
      const game = document.getElementById('raid-game').value.trim();
      const max_viewers = parseInt(document.getElementById('raid-viewers').value||'100',10);
      if (!game) return;

      const box = document.getElementById('raid-res');
      box.classList.remove('hidden');
      document.getElementById('raid-info').innerHTML = `<span class="best-time-spinner"></span> Recherche...`;

      try{
        const r = await fetch(`${API_BASE}/start_raid`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game, max_viewers })
        });
        const data = await r.json();
        if (!data.success || !data.target){
          document.getElementById('raid-info').innerHTML = `<p style="color:#ff6666;">‚ùå Aucun raid trouv√©</p>`;
          return;
        }
        raidTarget = data.target;
        document.getElementById('raid-img').src = raidTarget.thumbnail_url || '';
        document.getElementById('raid-info').innerHTML =
          `<p><strong>${escapeHtml(raidTarget.name)}</strong> (@${escapeHtml(raidTarget.login)})</p>
           <p>${escapeHtml(raidTarget.game)} ‚Ä¢ ${raidTarget.viewers} viewers</p>`;
      }catch(e){
        document.getElementById('raid-info').innerHTML = `<p style="color:#ff6666;">‚ùå Erreur</p>`;
      }
    }

    function goToRaid(){
      if (raidTarget) window.open(`https://twitch.tv/${raidTarget.login}`, '_blank');
    }

    async function runBoost(){
      const channel = document.getElementById('boost-query').value.trim();
      const msg = document.getElementById('boost-msg');
      msg.innerText = '';
      if (!channel) return;

      msg.innerText = '...';
      try{
        const r = await fetch(`${API_BASE}/stream_boost`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ channel })
        });
        const data = await r.json();
        msg.innerText = data.success ? '‚úÖ Boost activ√© (15 min)' : '‚ùå Boost refus√©';
      }catch(e){
        msg.innerText = '‚ùå Erreur';
      }
      setTimeout(()=>{ msg.innerText=''; }, 4000);
    }
  
    // Messenger-style reactions: tap message to reveal on mobile
    document.addEventListener('click', (e) => {
      const msgEl = e.target.closest('.hub-msg');
      if(!msgEl) return;
      // if clicked on button, keep
      if(e.target.closest('.hub-react-btn')) return;
      msgEl.classList.toggle('is-tapped');
    });

</script>

<script>
(function(){
  // ===== Ambilight =====
  const ambi = document.createElement('div');
  ambi.id = 'ambilight';
  const wrap = document.getElementById('player-wrap') || document.getElementById('player-container') || document.querySelector('.player-wrap') || document.body;
  if(wrap && !document.getElementById('ambilight')){
    wrap.prepend(ambi);
  }
  function avgColorFromImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.referrerPolicy = 'no-referrer';
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const w = c.width = 64, h = c.height = 36;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0,0,w,h);
        const d = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0,n=0;
        for(let i=0;i<d.length;i+=16){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; }
        r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
        resolve(`rgb(${r},${g},${b})`);
      };
      img.onerror = ()=>resolve('rgba(0,242,234,.18)');
      img.src = url + (url.includes('?')?'&':'?') + 'rand=' + Date.now();
    });
  }
  async function updateAmbilight(channel){
    if(!channel) return;
    const color = await avgColorFromImage(`https://static-cdn.jtvnw.net/previews-ttv/live_user_${encodeURIComponent(channel)}-440x248.jpg`);
    const el = document.getElementById('ambilight');
    if(el) el.style.background = `radial-gradient(circle at 30% 25%, ${color}, rgba(0,0,0,0) 55%), radial-gradient(circle at 70% 70%, rgba(0,242,234,.18), rgba(0,0,0,0) 60%)`;
  }
  // Hook into existing channel change if present
  const _set = window.setChannel || window.setTwitchChannel || null;
  if(_set){
    const fnName = _set.name;
    const original = _set;
    window[fnName] = function(ch){
      const r = original.apply(this, arguments);
      updateAmbilight(ch);
      return r;
    };
  } else {
    // fallback: observe current channel variable if exists
    setInterval(()=>{ 
      const ch = window.currentChannel || window.selectedChannel; 
      if(ch && window.__lastAmbiCh !== ch){ window.__lastAmbiCh = ch; updateAmbilight(ch); }
    }, 1500);
  }

  // ===== Vibe Check (deterministic) =====
  function vibeFor(name){
    const s = String(name||'');
    let h=0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) >>> 0; }
    const r = h % 3;
    return r===0 ? 'vibe-chill' : r===1 ? 'vibe-hype' : 'vibe-toxic';
  }
  // apply vibe to any TwitFlix card that has data-game or title
  function applyVibes(){
    document.querySelectorAll('[data-tf-card]').forEach(card=>{
      if(card.dataset.vibeApplied) return;
      const name = card.getAttribute('data-name') || card.querySelector('.tf-name')?.textContent || '';
      card.classList.add(vibeFor(name));
      card.dataset.vibeApplied = '1';
    });
  }
  setInterval(applyVibes, 1200);

  // ===== Mosaic Mode (Squad) =====
  function ensureMosaicBtn(){
    if(document.getElementById('mosaic-btn')) return;
    const host = document.querySelector('#player-controls') || document.querySelector('.player-controls') || document.querySelector('#player-wrap') || null;
    if(!host) return;
    const btn = document.createElement('button');
    btn.id = 'mosaic-btn';
    btn.type = 'button';
    btn.textContent = 'üì∫ Mosaic';
    btn.style.cssText = 'margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff; font-weight:900; font-size:12px; cursor:pointer;';
    host.appendChild(btn);

    btn.addEventListener('click', ()=>{
      const playerHost = document.getElementById('twitch-player') || document.getElementById('player') || document.querySelector('iframe[src*="player.twitch.tv"]')?.parentElement;
      if(!playerHost) return;
      const isOn = playerHost.dataset.mosaic === '1';
      if(isOn){
        // restore single
        const single = playerHost.dataset.singleHtml;
        if(single){ playerHost.innerHTML = single; }
        playerHost.dataset.mosaic = '0';
        return;
      }
      playerHost.dataset.singleHtml = playerHost.innerHTML;
      playerHost.dataset.mosaic = '1';
      const parent = new URLSearchParams(location.search).get('parent_host') || new URLSearchParams(location.search).get('parent') || location.hostname;
      const ch = window.currentChannel || window.selectedChannel || 'twitch';
      const tpl = (c)=>`https://player.twitch.tv/?channel=${encodeURIComponent(c)}&parent=${encodeURIComponent(parent)}&muted=true`;
      playerHost.innerHTML = `
        <div class="mosaic-grid">
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <input id="mosaic-channels" placeholder="channels (ex: ninja,shroud,...)"
            style="flex:1; min-width:220px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
          <button id="mosaic-apply" style="padding:8px 10px; border-radius:10px; border:1px solid rgba(0,242,234,.35); background:#00f2ea; color:#000; font-weight:900; cursor:pointer;">Appliquer</button>
        </div>`;
      const applyBtn = playerHost.querySelector('#mosaic-apply');
      applyBtn?.addEventListener('click', ()=>{
        const raw = playerHost.querySelector('#mosaic-channels')?.value || '';
        const list = raw.split(',').map(x=>x.trim()).filter(Boolean).slice(0,4);
        while(list.length<4) list.push(ch);
        const ifr = playerHost.querySelectorAll('iframe');
        ifr.forEach((f,i)=> f.src = tpl(list[i]));
      });
    });
  }
  setInterval(ensureMosaicBtn, 1200);

  // ===== Fantasy League UI (simple modal) =====
  function ensureFantasy(){
    if(document.getElementById('fantasy-open')) return;
    const nav = document.querySelector('#left-menu') || document.querySelector('.left-menu') || document.querySelector('#sidebar') || null;
    if(!nav) return;
    const b = document.createElement('button');
    b.id = 'fantasy-open';
    b.textContent = 'üèÜ Fantasy';
    b.style.cssText = 'width:100%; margin-top:8px; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:#fff; font-weight:900; cursor:pointer;';
    nav.appendChild(b);

    const modal = document.createElement('div');
    modal.id = 'fantasy-modal';
    modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:9999;';
    modal.innerHTML = `
      <div style="width:min(920px,92vw); max-height:86vh; overflow:auto; background:#0b0b0d; border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:1000; letter-spacing:.12em; font-size:14px;">FANTASY LEAGUE</div>
          <div style="margin-left:auto;"></div>
          <button id="fantasy-close" style="padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;">Fermer</button>
        </div>
        <div style="margin-top:10px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;">
          <div style="border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px;">
            <div style="font-weight:900; margin-bottom:8px;">Portefeuille</div>
            <div id="fantasy-summary" style="color:#cbd5e1; font-size:12px;">Chargement‚Ä¶</div>
            <div id="fantasy-holdings" style="margin-top:10px;"></div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <input id="fantasy-streamer" placeholder="streamer login (ex: ninja)" style="flex:1; min-width:220px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
              <input id="fantasy-amount" placeholder="montant (ex: 500)" type="number" style="width:160px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
              <button id="fantasy-buy" style="padding:8px 10px; border-radius:12px; border:1px solid rgba(0,242,234,.35); background:#00f2ea; color:#000; font-weight:900; cursor:pointer;">Investir</button>
            </div>
            <div id="fantasy-msg" style="margin-top:8px; font-size:12px; color:#94a3b8;"></div>
          </div>
          <div style="border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px;">
            <div style="font-weight:900; margin-bottom:8px;">Top Hub</div>
            <div id="fantasy-leaderboard" style="font-size:12px; color:#cbd5e1;">Chargement‚Ä¶</div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);

    function getUser(){
      return (window.currentUser && window.currentUser.name) || localStorage.getItem('hubUser') || 'Anon';
    }
    async function loadProfile(){
      const user = getUser();
      const r = await fetch(`/api/fantasy/profile?user=${encodeURIComponent(user)}`);
      const j = await r.json();
      if(!j.success) throw new Error(j.error||'Erreur');
      const sum = document.getElementById('fantasy-summary');
      sum.textContent = `Utilisateur: ${j.user} ‚Ä¢ Cash: ${Math.round(j.cash)} ‚Ä¢ Net Worth: ${Math.round(j.netWorth)}`;
      const hold = document.getElementById('fantasy-holdings');
      if(!j.holdings.length){ hold.innerHTML = '<div style="color:#64748b;">Aucune position.</div>'; return; }
      hold.innerHTML = j.holdings.map(h=>`
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);">
          <div><strong>${h.login}</strong> <span style="color:#64748b;">(${h.shares} parts)</span></div>
          <div style="color:#a7f3d0;">${Math.round(h.value)}</div>
        </div>`).join('');
    }
    async function loadLeaderboard(){
      const r = await fetch('/api/fantasy/leaderboard?limit=15');
      const j = await r.json();
      const box = document.getElementById('fantasy-leaderboard');
      if(!j.success){ box.textContent = j.error||'Erreur'; return; }
      box.innerHTML = j.leaderboard.map((x,i)=>`
        <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06);">
          <div>${i+1}. <strong>${x.user}</strong></div>
          <div style="color:#fde68a;">${Math.round(x.netWorth)}</div>
        </div>`).join('');
    }
    async function buy(){
      const user = getUser();
      const streamer = document.getElementById('fantasy-streamer').value.trim();
      const amount = Number(document.getElementById('fantasy-amount').value||0);
      const msg = document.getElementById('fantasy-msg');
      msg.textContent = '...';
      const r = await fetch('/api/fantasy/invest',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user, streamer, amount})});
      const j = await r.json();
      msg.textContent = j.success ? `‚úÖ Achat: ${j.shares} parts @ ${j.price} (co√ªt ${j.cost})` : `‚ùå ${j.error||'Erreur'}`;
      await loadProfile(); await loadLeaderboard();
    }

    b.addEventListener('click', async ()=>{
      modal.style.display = 'flex';
      try{ await loadProfile(); await loadLeaderboard(); }catch(e){ document.getElementById('fantasy-msg').textContent = e.message; }
    });
    modal.querySelector('#fantasy-close').addEventListener('click', ()=> modal.style.display='none');
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    modal.querySelector('#fantasy-buy').addEventListener('click', buy);
  }
  setInterval(ensureFantasy, 1400);
})();

    // ==== Messenger-like reactions handlers (hover/tap) ====
    (function(){
      const hubBox = document.getElementById('hub-messages');
      if(!hubBox) return;

      // Tap/click on a message toggles reaction bar (mobile-friendly)
      hubBox.addEventListener('click', (e)=>{
        const msgEl = e.target.closest('.hub-msg');
        if(msgEl && !e.target.closest('.hub-react-btn')) {
          msgEl.classList.toggle('show-reactions');
          return;
        }
        const btn = e.target.closest('.hub-react-btn');
        if(btn){
          const emoji = btn.getAttribute('data-react');
          const idEnc = btn.getAttribute('data-msg') || '';
          const msgId = decodeURIComponent(idEnc);
          if(window.emitHubReact) window.emitHubReact({ messageId: msgId, emoji });
        }
      });
    })();



// ===== Extra tools logic (Fantasy/Mosaic/Ambilight/Vibe) =====
let __ambOn = localStorage.getItem('jp_amb_on') === '1';
let __vibeOn = localStorage.getItem('jp_vibe_on') === '1';

function getParentParam(){
  const sp = new URLSearchParams(location.search);
  return sp.get('parent_host') || sp.get('parent') || location.hostname;
}

function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border:1px solid rgba(255,255,255,.18);border-radius:14px;z-index:999999;font-weight:900;';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1400);
}

function hashColor(str){
  str = String(str||'');
  let h=0; for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))>>>0;
  const a = 120 + (h % 120);
  const b = 90 + ((h>>8)%140);
  return `radial-gradient(circle at 25% 25%, rgba(0,242,234,.90), transparent 55%), radial-gradient(circle at 75% 75%, rgba(255,0,153,.78), transparent 55%), radial-gradient(circle at 50% 10%, rgba(${a},${b},255,.55), transparent 60%)`;
}

function refreshAmbilight(){
  const amb = document.getElementById('ambilight');
  if(!amb) return;
  const ch = (window.currentChannel || document.getElementById('current-channel-display')?.innerText || '').trim();
  amb.style.background = hashColor(ch || 'twitch');
}



let __toolsSched = false;
function ensurePlayerTools(){
  const vc = document.getElementById('video-container');
  if(!vc) return;

  // Ensure ambilight layer exists (behind player)
  if(!document.getElementById('ambilight')){
    const amb = document.createElement('div');
    amb.id = 'ambilight';
    vc.prepend(amb);
  }

  // Ensure tools exist (above player)
  let tools = document.getElementById('player-tools');
  if(!tools){
    tools = document.createElement('div');
    tools.id = 'player-tools';
    tools.innerHTML = `
      <button id="tool-mosaic" class="toolbtn" onclick="openMosaic()">üì∫</button>
      <button id="tool-fantasy" class="toolbtn" onclick="openFantasy()">üèÜ</button>
      <button id="tool-ambilight" class="toolbtn" onclick="toggleAmbilight()">üí°</button>
      <button id="tool-vibe" class="toolbtn" onclick="toggleVibe()">üß†</button>
    `;
    vc.appendChild(tools);
  } else if (tools.parentElement !== vc) {
    vc.appendChild(tools);
  }

  // Force player iframe below tools
  vc.querySelectorAll('iframe').forEach(f=>{
    try{
      if(f.style.zIndex !== '1') f.style.zIndex = '1';
      if(f.style.position !== 'relative') f.style.position = 'relative';
    }catch(e){}
  });
}

// Re-ensure tools if Twitch replaces the player DOM (debounced to avoid infinite loops)
(function(){
  const vc = document.getElementById('video-container');
  if(!vc) return;

  ensurePlayerTools();

  const obs = new MutationObserver(()=>{
    if(__toolsSched) return;
    __toolsSched = true;
    requestAnimationFrame(()=>{
      __toolsSched = false;
      ensurePlayerTools();
    });
  });

  obs.observe(vc, { childList: true, subtree: true });

  window.addEventListener('load', ()=>setTimeout(ensurePlayerTools, 600));
  setTimeout(ensurePlayerTools, 1200);
})();


function toggleAmbilight(){
  __ambOn = !__ambOn;
  localStorage.setItem('jp_amb_on', __ambOn ? '1' : '0');
  const btn = document.getElementById('tool-ambilight');
  const amb = document.getElementById('ambilight');
  if(btn) btn.classList.toggle('active', __ambOn);
  if(amb) amb.classList.toggle('on', __ambOn);
  refreshAmbilight();
  toast(`Ambilight ${__ambOn ? 'activ√©' : 'd√©sactiv√©'}`);
}

function vibeClass(name){
  const s = String(name||'');
  let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0;
  const v = h % 3;
  return v===0 ? 'vibe-chill' : (v===1 ? 'vibe-hype' : 'vibe-toxic');
}
function applyVibe(){
  document.querySelectorAll('.tf-card').forEach(card=>{
    card.classList.remove('vibe-chill','vibe-hype','vibe-toxic');
    if(!__vibeOn) return;
    const name = card.dataset.gameName || card.getAttribute('data-game-name') || card.querySelector('.tf-title')?.textContent || '';
    card.classList.add(vibeClass(name));
  });
}
function toggleVibe(){
  __vibeOn = !__vibeOn;
  localStorage.setItem('jp_vibe_on', __vibeOn ? '1' : '0');
  const btn = document.getElementById('tool-vibe');
  if(btn) btn.classList.toggle('active', __vibeOn);
  applyVibe();
  toast(`Vibe Check ${__vibeOn ? 'activ√©' : 'd√©sactiv√©'}`);
}

// reapply vibe on mutations
new MutationObserver(()=>{ if(__vibeOn) applyVibe(); }).observe(document.body, {childList:true, subtree:true});

// Mosaic
function openMosaic(){
  const m = document.getElementById('mosaicModal');
  const grid = document.getElementById('mosaicGrid');
  if(!m||!grid) return;
  const parent = getParentParam();
  const current = (window.currentChannel || document.getElementById('current-channel-display')?.innerText || '').trim();
  const list = [];
  if(current) list.push(current);
  if(Array.isArray(window.recentChannels)) list.push(...window.recentChannels);
  while(list.length < 4) list.push(current || 'twitch');
  const channels = list.filter(Boolean).slice(0,4);

  grid.innerHTML = '';
  channels.forEach(ch=>{
    const tile = document.createElement('div');
    tile.className='mosaic-tile';
    const src = `https://player.twitch.tv/?channel=${encodeURIComponent(ch)}&parent=${encodeURIComponent(parent)}&muted=true&autoplay=true`;
    tile.innerHTML = `<iframe src="${src}" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen"></iframe>
      <button onclick="focusChannel('${encodeURIComponent(ch)}')">Focus</button>`;
    grid.appendChild(tile);
  });
  m.classList.add('active');
}
function closeMosaic(e){ if(e) e.preventDefault(); document.getElementById('mosaicModal')?.classList.remove('active'); }
function focusChannel(enc){
  const ch = decodeURIComponent(enc);
  if(typeof changeChannel === 'function') changeChannel(ch);
  refreshAmbilight();
  closeMosaic(new Event('click'));
}

// Fantasy API + chart
function openFantasy(){ document.getElementById('fantasyModal')?.classList.add('active'); refreshFantasy(); }
function closeFantasy(e){ if(e) e.preventDefault(); document.getElementById('fantasyModal')?.classList.remove('active'); }

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

async function refreshFantasy(){
  const user = (window.currentUser || 'Anon');
  const prof = await fetch(`/api/fantasy/profile?user=${encodeURIComponent(user)}`).then(r=>r.json()).catch(()=>null);
  if(prof && prof.success){
    document.getElementById('fantasyCash').textContent = `${Number(prof.cash||0).toLocaleString('fr-FR')} cr√©dits`;
    const h = document.getElementById('fantasyHoldings');
    if(h){
      h.innerHTML = (prof.holdings||[]).map(x=>`
        <div style="display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.15);cursor:pointer;"
             onclick="loadMarket('${escapeHtml(x.login)}')">
          <div style="font-weight:900;color:#fff;">${escapeHtml(x.login)} <span style="color:#a7a7b2;font-weight:700;">(${x.shares} sh)</span></div>
          <div style="font-weight:900;color:#00f2ea;">${Math.round(x.value).toLocaleString('fr-FR')}</div>
        </div>`).join('') || `<div style="color:#a7a7b2;">Aucun streamer en portefeuille.</div>`;
    }
  }

  const lb = await fetch(`/api/fantasy/leaderboard`).then(r=>r.json()).catch(()=>null);
  if(lb && lb.success){
    const el = document.getElementById('fantasyLeaderboard');
    if(el){
      el.innerHTML = (lb.items||[]).slice(0,10).map((u,i)=>`
        <div style="display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.15);">
          <div style="font-weight:900;color:#fff;">#${i+1} ${escapeHtml(u.user||'')}</div>
          <div style="font-weight:900;color:#ffd600;">${Math.round(u.netWorth||0).toLocaleString('fr-FR')}</div>
        </div>`).join('') || `<div style="color:#a7a7b2;">Aucun classement.</div>`;
    }
  }
}

async function loadMarket(login){
  if(!login) return;
  const d = await fetch(`/api/fantasy/market?streamer=${encodeURIComponent(login)}`).then(r=>r.json()).catch(()=>null);
  if(!d || !d.success) return toast('March√© indisponible');
  const m = d.market;
  const info = document.getElementById('marketInfo');
  if(info){
    info.innerHTML = `
      <div>Base: <b style="color:#fff">${m.basePrice}</b></div>
      <div>Impact: <b style="color:#fff">x${Number(m.mult).toFixed(2)}</b></div>
      <div>Shares: <b style="color:#fff">${Math.round(m.sharesOutstanding)}</b></div>
      <div>Prix: <b style="color:#00f2ea">${m.price}</b></div>
    `;
  }
  drawChart(d.history || [], m.price);
  document.getElementById('fantasyStreamer').value = login;
}

function drawChart(history, last){
  const c = document.getElementById('marketChart');
  if(!c) return;
  const ctx = c.getContext('2d');
  const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0b0b0d';
  ctx.fillRect(0,0,W,H);
  const pts = (history||[]).map(x=>Number(x.price||0)).filter(x=>x>0);
  if(pts.length < 2){
    ctx.fillStyle = '#a7a7b2';
    ctx.font = '14px system-ui';
    ctx.fillText('Historique insuffisant (2+ points requis)', 16, 30);
    return;
  }
  const minP=Math.min(...pts), maxP=Math.max(...pts);
  const pad=18;
  const sx=(W-pad*2)/(pts.length-1);
  const sy=(H-pad*2)/(maxP-minP||1);
  ctx.strokeStyle='rgba(0,242,234,.85)';
  ctx.lineWidth=3;
  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x=pad+i*sx;
    const y=H-pad-(p-minP)*sy;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle='#00f2ea';
  ctx.font='bold 16px system-ui';
  ctx.fillText(String(last||pts[pts.length-1]), W-70, 26);
}

async function fantasyBuy(){
  const user = (window.currentUser || 'Anon');
  const login = document.getElementById('fantasyStreamer')?.value?.trim();
  const amount = Number(document.getElementById('fantasyAmount')?.value || 0);
  if(!login || !amount) return alert('Streamer + montant requis.');
  const r = await fetch('/api/fantasy/invest', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ user, streamer: login, amount })}).then(r=>r.json()).catch(()=>null);
  if(!r || !r.success) return alert(r?.error || 'Erreur invest.');
  toast('Investissement effectu√©');
  await refreshFantasy();
  await loadMarket(login);
}
async function fantasySell(){
  const user = (window.currentUser || 'Anon');
  const login = document.getElementById('fantasyStreamer')?.value?.trim();
  const amount = Number(document.getElementById('fantasyAmount')?.value || 0);
  if(!login || !amount) return alert('Streamer + montant requis.');
  const r = await fetch('/api/fantasy/sell', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ user, streamer: login, amount })}).then(r=>r.json()).catch(()=>null);
  if(!r || !r.success) return alert(r?.error || 'Erreur sell.');
  toast('Vente effectu√©e');
  await refreshFantasy();
  await loadMarket(login);
}

// initialize buttons state
document.getElementById('tool-ambilight')?.classList.toggle('active', __ambOn);
document.getElementById('ambilight')?.classList.toggle('on', __ambOn);
document.getElementById('tool-vibe')?.classList.toggle('active', __vibeOn);
setTimeout(()=>{ if(__ambOn) refreshAmbilight(); if(__vibeOn) applyVibe(); }, 700);


// ================= HELP SYSTEM (pedagogic) =================
const HELP = {
  chat: {
    title: "Chat Hub (Secure)",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> discuter avec d‚Äôautres streamers et viewers dans un chat interne (s√©curis√©) pour partager des retours, trouver des id√©es de contenus, et cr√©er du r√©seau.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> √©cris un message court + clair (objectif, niche, probl√®me). Ajoute un GIF si tu veux. Utilise les r√©actions pour valider une id√©e sans spam.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu obtiens des r√©ponses concr√®tes, tu identifies ce qui int√©resse vraiment les gens, et tu peux m√™me gagner des cr√©dits via l‚Äôactivit√©.</p>"
      + "<p><strong>Exemple :</strong> ‚ÄúJe stream <em>EA FC</em>, je stagne √† 15 viewers. Vous feriez quoi : d√©fi, co-stream, ou shorts ?‚Äù</p>"
  },
  stats: {
    title: "Stats (tendances Twitch)",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> voir l‚Äô√©tat du march√© Twitch (viewers, langues, jeux qui montent) pour √©viter de streamer au mauvais moment ou sur une niche trop satur√©e.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> rep√®re les pics, compare les jeux, puis ajuste ton planning (horaires) et ton choix de cat√©gorie.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu choisis un timing et un contexte o√π tu as plus de chances d‚Äô√™tre d√©couvert.</p>"
  },
  tools: {
    title: "Outils (actions rapides)",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> regrouper des actions utiles (scan, critique IA, raid, best-time, etc.) sans chercher dans toute l‚Äôinterface.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> pars d‚Äôun objectif (ex: ‚Äútrouver une niche‚Äù, ‚Äúam√©liorer mon titre‚Äù, ‚Äúpr√©parer un raid‚Äù), puis lance l‚Äôoutil correspondant.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu transformes des donn√©es en d√©cisions (tester ‚Üí mesurer ‚Üí it√©rer) au lieu de rester dans l‚Äôintuition.</p>"
  },
  overview: {
    title: "Overview",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> r√©sum√© rapide de ton contexte (√©tat du live, infos utiles, acc√®s direct aux modules).</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> commence ici : v√©rifie le stream charg√©, lis les indicateurs, puis passe √† Analytics/Niche/Bourse selon ton besoin.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu sais imm√©diatement ‚Äúo√π tu en es‚Äù et quelle action a le meilleur impact.</p>"
  },
  analytics: {
    title: "Analytics Pro",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> analyser une cha√Æne (ou la tienne) avec des KPI concrets : moyenne, pic, croissance, volatilit√©, temps de live.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> scanne un login ‚Üí observe la courbe ‚Üí identifie 1 levier (horaire, jeu, format) ‚Üí teste 1 changement.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu prends des d√©cisions bas√©es sur les donn√©es, pas sur des impressions.</p>"
  },
  niche: {
    title: "Niche",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> mesurer saturation / opportunit√© d‚Äôun jeu ou d‚Äôun sujet pour trouver des zones o√π tu peux √™tre d√©couvert plus facilement.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> cherche une cat√©gorie ‚Üí compare viewers vs nombre de cha√Ænes ‚Üí vise les niches o√π l‚Äôopportunit√© est haute et la concurrence raisonnable.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu √©vites les ‚Äúoc√©ans rouges‚Äù et tu trouves des angles gagnants.</p>"
  },
  bourse: {
    title: "Bourse des streamers",
    html: "<p><strong>√Ä quoi √ßa sert :</strong> un ‚Äúfantasy market‚Äù : tu utilises tes cr√©dits pour investir sur des streamers (positions), suivre des tendances et apprendre le timing.</p>"
      + "<p><strong>Comment l‚Äôutiliser :</strong> gagne des cr√©dits (TwitFlix/Stats/Chat) ‚Üí investis sur un streamer ‚Üí suis la valeur dans le Trading Desk.</p>"
      + "<p><strong>En quoi √ßa t‚Äôaide :</strong> tu apprends √† rep√©rer les signaux (croissance, hype, r√©gularit√©) et tu gamifies ton analyse.</p>"
  },
  bourse_cash: { title:"Cash", html:"<p><strong>Cr√©dits disponibles :</strong> c‚Äôest ton solde utilisable imm√©diatement pour investir. Tu en gagnes en utilisant l‚Äôapp (TwitFlix, Stats, Chat) selon un cooldown.</p>" },
  bourse_networth: { title:"Net Worth", html:"<p><strong>Valeur totale :</strong> cash + valeur de tes positions au prix actuel. C‚Äôest l‚Äôindicateur principal pour voir si ta strat√©gie est bonne.</p>" },
  bourse_reserved: { title:"R√©serv√©", html:"<p><strong>Somme bloqu√©e :</strong> cr√©dits mis de c√¥t√© pour des ordres en attente. Ils reviennent si l‚Äôordre est annul√© ou non ex√©cut√©.</p>" },
  bourse_orders: { title:"Ordres ouverts", html:"<p><strong>Ordres en attente :</strong> tes achats/ventes limit non ex√©cut√©s. Utile pour entrer/sortir √† un prix pr√©cis sans surveiller en permanence.</p>" }
};

function openHelp(key){
  const item = HELP[key] || { title:"Aide", html:"<p>Aucune aide disponible pour ce module.</p>" };
  const modal = document.getElementById('helpModal');
  const title = document.getElementById('helpTitle');
  const body = document.getElementById('helpBody');
  if(title) title.textContent = item.title || 'Aide';
  if(body) body.innerHTML = item.html || '';
  modal?.classList.add('active');
}
function closeHelp(){ document.getElementById('helpModal')?.classList.remove('active'); }

// ================= BOURSE PANEL =================
async function refreshBoursePanel(){
  try{
    const prof = await fetch('/api/fantasy/profile', { credentials:'include' }).then(r=>r.json());
    if(!prof.success){
      document.getElementById('bourse-portfolio').textContent = "Connecte-toi Twitch pour utiliser la Bourse.";
      document.getElementById('bourse-cash').textContent = '--';
      document.getElementById('bourse-networth').textContent = '--';
      document.getElementById('bourse-reserved').textContent = '--';
      document.getElementById('bourse-open-orders').textContent = '--';
      return;
    }

    const cash = Number(prof.cash||0);
    const net = Number(prof.netWorth||0);
    // reserved not returned by profile (yet) ‚Üí try read wallet fields via profile? fallback 0
    const reserved = Number(prof.cashReserved||0) || 0;

    document.getElementById('bourse-cash').textContent = cash.toLocaleString('fr-FR');
    document.getElementById('bourse-networth').textContent = net.toLocaleString('fr-FR');
    document.getElementById('bourse-reserved').textContent = reserved.toLocaleString('fr-FR');

    const holdings = Array.isArray(prof.holdings) ? prof.holdings : [];
    if(!holdings.length){
      document.getElementById('bourse-portfolio').innerHTML = "<div class='text-gray-500'>Aucune position pour l‚Äôinstant.</div>";
    }else{
      const rows = holdings
        .sort((a,b)=> (b.value||0)-(a.value||0))
        .slice(0, 12)
        .map(h=>`<div class="flex items-center justify-between py-1 border-b border-[#1d1d1d]">
          <div class="text-gray-200"><strong>${escapeHtml(h.login)}</strong> <span class="text-gray-500">x${Number(h.shares||0)}</span></div>
          <div class="text-gray-300">${Number(h.value||0).toLocaleString('fr-FR')}</div>
        </div>`).join('');
      document.getElementById('bourse-portfolio').innerHTML = rows;
    }

    // Open orders count
    const orders = await fetch('/api/fantasy/orders', { credentials:'include' }).then(r=>r.json());
    const openCount = orders.success ? (orders.orders?.length||0) : 0;
    document.getElementById('bourse-open-orders').textContent = String(openCount);

    // Leaderboard
    const lb = await fetch('/api/fantasy/leaderboard').then(r=>r.json());
    if(lb.success && Array.isArray(lb.items)){
      const lines = lb.items.slice(0,10).map((x,i)=>`<div class="flex items-center justify-between py-1 border-b border-[#1d1d1d]">
        <div class="text-gray-200">#${i+1} ${escapeHtml(x.user||'')}</div>
        <div class="text-gray-300">${Math.round(x.netWorth||0).toLocaleString('fr-FR')}</div>
      </div>`).join('');
      document.getElementById('bourse-leaderboard').innerHTML = lines || "<div class='text-gray-500'>‚Äî</div>";
    }else{
      document.getElementById('bourse-leaderboard').innerHTML = "<div class='text-gray-500'>‚Äî</div>";
    }
  }catch(e){
    console.warn('refreshBoursePanel error', e);
  }
}

async function earnCredits(type){
  try{
    const r = await fetch('/api/fantasy/reward', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      credentials:'include',
      body: JSON.stringify({ type })
    }).then(r=>r.json());
    if(r.success){
      refreshBoursePanel();
      (typeof toast==='function') && toast('+'+r.amount+' cr√©dits', true);
    }else{
      (typeof toast==='function') && toast(r.error || 'Reward indisponible', false);
    }
  }catch(e){}
}


// === FIX: lock right side-panel height to player height ===
(function(){
  const setH = ()=>{
    const panel = document.getElementById('side-panel');
    const player = document.querySelector('.player-shell') || document.getElementById('video-container')?.closest('.glass-panel') || document.getElementById('video-container');
    if(!panel || !player) return;
    // Use the visible player shell height (includes borders/tools)
    const h = Math.round(player.getBoundingClientRect().height);
    if(h > 200) document.documentElement.style.setProperty('--jp-player-h', h + 'px');
  };
  window.addEventListener('load', ()=>{ setH(); setTimeout(setH, 300); setTimeout(setH, 900); });
  window.addEventListener('resize', ()=>{ setH(); });
  // watch for twitch embed resize
  const vc = document.getElementById('video-container');
  if(vc){
    const ro = new ResizeObserver(()=>setH());
    try{ ro.observe(vc); }catch(e){}
  }
})();

</script>

<div id="mosaicModal" class="modal-overlay" onclick="closeMosaic(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-title">Mosaic Mode</div>
      <button class="modal-close" onclick="closeMosaic(event)">‚úï</button>
    </div>
    <div class="mosaic-grid" id="mosaicGrid"></div>
  </div>
</div>

<div id="fantasyModal" class="modal-overlay" onclick="closeFantasy(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-title">Fantasy League</div>
      <button class="modal-close" onclick="closeFantasy(event)">‚úï</button>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:290px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
        <div style="font-weight:900;color:#00f2ea;margin-bottom:6px;">Portefeuille (max 10 streamers)</div>
        <div id="fantasyCash" style="font-size:22px;font-weight:900;color:#fff;">‚Äî</div>
        <div id="fantasyHoldings" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
      </div>

      <div style="flex:2;min-width:320px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="fantasyStreamer" placeholder="Streamer (login)" style="flex:1;min-width:220px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;">
          <input id="fantasyAmount" placeholder="Montant" type="number" min="1" style="width:140px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;">
          <button onclick="fantasyBuy()" style="background:#00f2ea;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Investir</button>
          <button onclick="fantasySell()" style="background:#ff0099;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Vendre</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:260px;">
            <div style="font-weight:900;color:#eaeaf0;margin-bottom:6px;">Cours</div>
            <div id="marketInfo" style="display:flex;gap:10px;flex-wrap:wrap;color:#a7a7b2;font-size:12px;"></div>
            <canvas id="marketChart" width="640" height="220" style="width:100%;background:#0b0b0d;border:1px solid rgba(255,255,255,.10);border-radius:14px;"></canvas>
          </div>
          <div style="flex:1;min-width:260px;">
            <div style="font-weight:900;color:#ffd600;margin-bottom:6px;">Leaderboard</div>
            <div id="fantasyLeaderboard" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>


  <!-- Help Modal -->
  <div id="helpModal" onclick="if(event.target.id==='helpModal') closeHelp()">
    <div id="helpCard">
      <div id="helpCardHeader">
        <div id="helpTitle">Aide</div>
        <button id="helpClose" onclick="closeHelp()" title="Fermer">‚úï</button>
      </div>
      <div id="helpBody"></div>
    </div>
  </div>


<!-- ===================== MARCH√â (Streamer Stock Market) ‚Äî MODAL ===================== -->
<div id="market-modal" class="tf-modal hidden" aria-hidden="true">
  <div class="tf-modal-backdrop" onclick="closeMarket()"></div>
  <div class="tf-modal-content">
    <div class="tf-topbar">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="text-lg font-extrabold tracking-wide text-white">
            <i class="fas fa-coins mr-2 text-[#00f2ea]"></i> March√© des Streamers
            <span class="ml-2 text-xs font-bold px-2 py-1 rounded bg-[#0f1b1b] text-[#00f2ea] border border-[#113]">BETA</span>
          </div>
          <div class="text-xs text-gray-400 hidden md:block">
            Prix = base (viewers live) + impact (offre/demande). Objectif: te donner des signaux de croissance & d'opportunit√©.
          </div>
        </div>
        <div class="tf-actions flex items-center gap-2">
          <button class="tf-btn" onclick="marketRefresh(true)"><i class="fas fa-sync-alt mr-2"></i>Actualiser</button>
          <button class="tf-btn" onclick="marketToggleCinema()"><i class="fas fa-expand mr-2"></i>Mode cin√©ma</button>
          <button class="tf-btn tf-btn-primary" onclick="closeMarket()"><i class="fas fa-times mr-2"></i>Fermer</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-3">
        <div class="lg:col-span-7 relative">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
          <input id="market-search" class="tf-search w-full" placeholder="Rechercher un streamer (login)‚Ä¶ ex: zerator / gotaga / sardoche"
                 oninput="marketSearch(this.value)" />
        </div>

        <div class="lg:col-span-5 grid grid-cols-3 gap-3">
          <div class="tf-kpi">
            <div class="tf-kpi-label">Indice global</div>
            <div class="tf-kpi-value" id="market-index">‚Äî</div>
            <div class="tf-kpi-sub" id="market-index-sub">tendance</div>
          </div>
          <div class="tf-kpi">
            <div class="tf-kpi-label">Volatilit√©</div>
            <div class="tf-kpi-value" id="market-vol">‚Äî</div>
            <div class="tf-kpi-sub">7 derniers points</div>
          </div>
          <div class="tf-kpi">
            <div class="tf-kpi-label">Top momentum</div>
            <div class="tf-kpi-value" id="market-top">‚Äî</div>
            <div class="tf-kpi-sub" id="market-top-sub">+%</div>
          </div>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button class="tf-chip active" data-market-tab="overview" onclick="marketOpenTab('overview', this)">Vue g√©n√©rale</button>
        <button class="tf-chip" data-market-tab="screener" onclick="marketOpenTab('screener', this)">Screener</button>
        <button class="tf-chip" data-market-tab="orderbook" onclick="marketOpenTab('orderbook', this)">Carnet d'ordres</button>
        <button class="tf-chip" data-market-tab="portfolio" onclick="marketOpenTab('portfolio', this)">Mon portefeuille</button>
        <button class="tf-chip" data-market-tab="leaderboard" onclick="marketOpenTab('leaderboard', this)">Classement</button>
        <button class="tf-chip" data-market-tab="how" onclick="marketOpenTab('how', this)">Comment √ßa marche ?</button>
      </div>
    </div>

    <div class="tf-body">
      <!-- OVERVIEW -->
      <section id="market-tab-overview" class="market-tab">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-8">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-wave-square mr-2 text-[#00f2ea]"></i>Indice global (simulation)</div>
              <canvas id="market-index-chart" height="110"></canvas>
              <div class="text-xs text-gray-400 mt-2">
                P√©dago : l'indice est une moyenne pond√©r√©e des prix (impact + viewers). Il te sert √† voir si ‚Äúle march√©‚Äù est chaud ou froid.
              </div>
            </div>

            <div class="tf-panel mt-4">
              <div class="tf-panel-title"><i class="fas fa-bolt mr-2 text-[#ff0099]"></i>Alertes & opportunit√©s (√† actionner)</div>
              <div id="market-opportunities" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </div>
          </div>

          <div class="xl:col-span-4">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-crosshairs mr-2 text-[#00f2ea]"></i>Streamers √† surveiller</div>
              <div id="market-watchlist" class="tf-list"></div>
              <div class="mt-3 text-xs text-gray-400">
                P√©dago : ajoute ici les streamers que tu veux suivre. Le prix bouge selon leur audience live et la pression d'achat/vente.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SCREENER -->
      <section id="market-tab-screener" class="market-tab hidden">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-8">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-filter mr-2 text-[#00f2ea]"></i>Screener ‚Äî trouve des p√©pites</div>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <select id="scr-sort" class="tf-input" onchange="marketRefresh()">
                  <option value="momentum">Tendance (momentum)</option>
                  <option value="price">Prix</option>
                  <option value="viewers">Viewers live</option>
                  <option value="vol">Volatilit√©</option>
                </select>
                <input id="scr-maxprice" class="tf-input" placeholder="Prix max (ex: 300)" oninput="marketRefresh()" />
                <input id="scr-minviewers" class="tf-input" placeholder="Viewers min (ex: 50)" oninput="marketRefresh()" />
                <select id="scr-risk" class="tf-input" onchange="marketRefresh()">
                  <option value="all">Risque: tous</option>
                  <option value="low">Faible volatilit√©</option>
                  <option value="mid">Moyen</option>
                  <option value="high">√âlev√©</option>
                </select>
              </div>

              <div class="mt-4 tf-table-wrap">
                <table class="tf-table">
                  <thead>
                    <tr>
                      <th>Streamer</th><th>Prix</th><th>Œî%</th><th>Viewers</th><th>Vol</th><th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="market-screener"></tbody>
                </table>
              </div>

              <div class="text-xs text-gray-400 mt-3">
                P√©dago : ‚ÄúŒî%‚Äù = variation r√©cente. ‚ÄúVol‚Äù = instabilit√©. Objectif : rep√©rer un bon ratio opportunit√©/risque.
              </div>
            </div>
          </div>

          <div class="xl:col-span-4">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-info-circle mr-2 text-[#00f2ea]"></i>Fiche Streamer</div>
              <div id="market-profile" class="text-sm text-gray-200">Clique sur un streamer dans le screener.</div>
              <div class="mt-3">
                <div class="tf-order grid grid-cols-2 gap-2">
                  <input id="order-login" class="tf-input col-span-2" placeholder="login streamer" />
                  <input id="order-amount" class="tf-input" placeholder="Montant (cr√©dits)" />
                  <select id="order-side" class="tf-input">
                    <option value="buy">Acheter</option>
                    <option value="sell">Vendre</option>
                  </select>
                  <button class="tf-btn tf-btn-primary col-span-2" onclick="marketPlaceOrder()">
                    <i class="fas fa-paper-plane mr-2"></i>Passer l'ordre
                  </button>
                </div>
                <div class="text-xs text-gray-400 mt-2">
                  P√©dago : tu ach√®tes des ‚Äúparts‚Äù au prix actuel. Le prix peut monter/descendre selon l'audience live + la demande.
                </div>
                <div id="market-order-status" class="text-xs mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ORDERBOOK -->
      <section id="market-tab-orderbook" class="market-tab hidden">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-4">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-layer-group mr-2 text-[#00f2ea]"></i>Streamers suivis</div>
              <div id="market-book-list" class="tf-list"></div>
            </div>
          </div>
          <div class="xl:col-span-8">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-book mr-2 text-[#00f2ea]"></i>Carnet d'ordres (simulation)</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="text-xs text-gray-400 mb-2">ACHATS</div>
                  <div id="market-bids" class="tf-book"></div>
                </div>
                <div>
                  <div class="text-xs text-gray-400 mb-2">VENTES</div>
                  <div id="market-asks" class="tf-book"></div>
                </div>
              </div>
              <div class="text-xs text-gray-400 mt-3">
                P√©dago : ici on simule un carnet. En prod tu peux connecter une vraie logique serveur (ordres limites, matching, historique).
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PORTFOLIO -->
      <section id="market-tab-portfolio" class="market-tab hidden">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-4">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-wallet mr-2 text-[#00f2ea]"></i>R√©sum√©</div>
              <div class="text-sm text-gray-200">
                <div>Utilisateur: <strong id="market-user">Anon</strong></div>
                <div class="mt-1">Cash: <strong id="market-cash">‚Äî</strong></div>
                <div class="mt-1">Valeur positions: <strong id="market-posval">‚Äî</strong></div>
                <div class="mt-1">Net worth: <strong id="market-net">‚Äî</strong></div>
              </div>
              <div class="mt-3 text-xs text-gray-400">
                P√©dago : ‚ÄúNet worth‚Äù = cash + valeur de toutes tes positions au prix actuel.
              </div>
            </div>

            <div class="tf-panel mt-4">
              <div class="tf-panel-title"><i class="fas fa-user-shield mr-2 text-[#00f2ea]"></i>Param√®tres</div>
              <input id="market-user-input" class="tf-input" placeholder="Nom utilisateur (pour portefeuille)" />
              <button class="tf-btn mt-2 w-full" onclick="marketSetUser()"><i class="fas fa-save mr-2"></i>Appliquer</button>
              <div class="text-xs text-gray-400 mt-2">P√©dago : ton pseudo sert de cl√© pour sauvegarder ton portefeuille.</div>
            </div>
          </div>

          <div class="xl:col-span-8">
            <div class="tf-panel">
              <div class="tf-panel-title"><i class="fas fa-briefcase mr-2 text-[#00f2ea]"></i>Mes positions</div>
              <div class="tf-table-wrap">
                <table class="tf-table">
                  <thead>
                    <tr><th>Streamer</th><th>Parts</th><th>Prix</th><th>Valeur</th><th>Action</th></tr>
                  </thead>
                  <tbody id="market-positions"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD -->
      <section id="market-tab-leaderboard" class="market-tab hidden">
        <div class="tf-panel">
          <div class="tf-panel-title"><i class="fas fa-trophy mr-2 text-[#ff0099]"></i>Classement (net worth)</div>
          <div class="tf-table-wrap">
            <table class="tf-table">
              <thead><tr><th>#</th><th>Utilisateur</th><th>Net worth</th></tr></thead>
              <tbody id="market-leaderboard"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- HOW -->
      <section id="market-tab-how" class="market-tab hidden">
        <div class="tf-panel">
          <div class="tf-panel-title"><i class="fas fa-graduation-cap mr-2 text-[#00f2ea]"></i>Comment √ßa marche ? (version ‚Äúvraie bourse‚Äù)</div>

          <div class="prose prose-invert max-w-none text-sm text-gray-200">
            <p><strong>Objectif</strong> : te donner un tableau de bord ‚Äúbourse‚Äù qui transforme les signaux Twitch en m√©triques actionnables (croissance, risque, opportunit√©).</p>

            <h4 class="mt-3">1) Le prix d'un streamer</h4>
            <ul>
              <li><strong>Base price</strong> : d√©riv√© des viewers live (plus l'audience est haute, plus la base monte).</li>
              <li><strong>Impact</strong> : augmente si beaucoup de gens ach√®tent (parts ‚Äúoutstanding‚Äù). Baisse si √ßa vend.</li>
              <li><strong>R√©sultat</strong> : un prix simple √† lire + une variation (%) qui te sert de ‚Äúmomentum‚Äù.</li>
            </ul>

            <h4 class="mt-3">2) Ordres</h4>
            <ul>
              <li>Version actuelle : ‚Äúmarket orders‚Äù (tu ach√®tes/vends au prix du moment).</li>
              <li>Version vraie bourse : ajouter des <strong>ordres limites</strong> + un <strong>matching engine</strong> serveur (carnet + ex√©cution).</li>
            </ul>

            <h4 class="mt-3">3) Indice global</h4>
            <ul>
              <li>Moyenne pond√©r√©e des prix du watchlist (ou des top streamers).</li>
              <li>Te dit si le ‚Äúmarch√©‚Äù est en expansion (plus d'audience, plus de demande).</li>
            </ul>

            <h4 class="mt-3">4) Comment √ßa aide un streamer ?</h4>
            <ul>
              <li>Tu vois qui ‚Äúprend de la traction‚Äù rapidement.</li>
              <li>Tu peux t'inspirer (formats, horaires) + d√©tecter les niches moins satur√©es.</li>
              <li>Tu ajoutes un <strong>feedback loop</strong> : tes d√©cisions (investir/observer) te forcent √† analyser les signaux.</li>
            </ul>

            <h4 class="mt-3">5) Brancher √† ton backend</h4>
            <ul>
              <li><code>/api/fantasy/market?streamer=LOGIN</code> pour prix + historique</li>
              <li><code>/api/fantasy/profile?user=NAME</code> pour portefeuille</li>
              <li><code>/api/fantasy/invest</code> / <code>/api/fantasy/sell</code> pour acheter/vendre</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>


<script id="jp-market-js">
(function(){
  // ============ Player height lock (prevents secure chat from affecting player) ============
  function syncPlayerHeight(){
    const playerWrap = document.getElementById('twitch-player-wrap') || document.querySelector('.twitch-player-wrap');
    const right = document.getElementById('right-panel') || document.querySelector('.right-panel') || document.getElementById('side-tabs');
    if(!playerWrap || !right) return;

    const h = Math.max(420, Math.min(860, playerWrap.getBoundingClientRect().height || 0));
    document.documentElement.style.setProperty('--jpPlayerH', h + 'px');
  }
  window.addEventListener('resize', syncPlayerHeight);
  window.addEventListener('load', () => {
    // ResizeObserver gives best results when Twitch reflows
    try{
      const el = document.getElementById('twitch-player-wrap') || document.querySelector('.twitch-player-wrap');
      if(el && 'ResizeObserver' in window){
        new ResizeObserver(()=>syncPlayerHeight()).observe(el);
      }
    }catch(_){}
    setTimeout(syncPlayerHeight, 400);
    setTimeout(syncPlayerHeight, 1200);
  });

  // ============ Market modal ============
  window.openMarket = function(){
    const m = document.getElementById('market-modal');
    if(!m) return;
    m.classList.remove('hidden');
    m.setAttribute('aria-hidden','false');
    marketBoot();
  };
  window.closeMarket = function(){
    const m = document.getElementById('market-modal');
    if(!m) return;
    m.classList.add('hidden');
    m.setAttribute('aria-hidden','true');
  };

  window.marketToggleCinema = function(){
    // re-use your existing cinema mode if present
    if (typeof window.toggleCinemaMode === 'function') window.toggleCinemaMode(true);
    else {
      document.body.classList.toggle('cinema-mode');
      document.documentElement.classList.toggle('cinema-mode');
    }
  };

  // Tabs inside market
  window.marketOpenTab = function(key, btn){
    document.querySelectorAll('#market-modal .tf-chip').forEach(x=>x.classList.remove('active'));
    if(btn) btn.classList.add('active');
    document.querySelectorAll('#market-modal .market-tab').forEach(s=>s.classList.add('hidden'));
    const sec = document.getElementById('market-tab-' + key);
    if(sec) sec.classList.remove('hidden');
  };

  // ======= Data layer: uses backend endpoints if present, else fallback demo =======
  const state = {
    user: localStorage.getItem('marketUser') || 'Anon',
    watch: (localStorage.getItem('marketWatch')||'zerator,gota,kamet0').split(',').map(s=>s.trim()).filter(Boolean),
    cache: new Map(),
    demo: null
  };

  function fmt(n){ try{ return new Intl.NumberFormat('fr-FR').format(Math.round(n)); }catch(_){ return String(Math.round(n)); } }
  function pct(n){ const v = Number(n||0); const s = v>=0?'+':''; return s + v.toFixed(1) + '%'; }

  async function apiJson(url, opt){
    const r = await fetch(url, opt||{});
    const j = await r.json();
    return j;
  }

  function demoData(){
    // deterministic pseudo data to keep UI readable if backend not running
    if(state.demo) return state.demo;
    const base = [
      'zerator','gotaga','sardoche','kamel','aminematue','domingo','pape_san','squeezie','ponce','xari','kamet0','locklear'
    ];
    const rows = base.map((login,i)=>{
      const viewers = 40 + (i*37)%480;
      const price = Math.round(25 + Math.sqrt(viewers)*6 + (i%3)*12);
      const chg = ((i%7)-3) * 1.7;
      const vol = 6 + (i%8)*4;
      return { login, price, viewers, changePct: chg, vol };
    });
    state.demo = rows;
    return rows;
  }

  async function getStreamerMarket(login){
    const key = String(login||'').toLowerCase().trim();
    if(!key) return null;
    if(state.cache.has(key)) return state.cache.get(key);

    // Prefer your backend fantasy endpoints if available
    try{
      const j = await apiJson(`/api/fantasy/market?streamer=${encodeURIComponent(key)}`);
      if(j && j.success && j.market){
        const m = {
          login: j.market.login,
          price: Number(j.market.price||0),
          basePrice: Number(j.market.basePrice||0),
          viewers: null,
          changePct: 0,
          vol: computeVol(j.history||[])
        };
        // compute recent change
        if((j.history||[]).length>=2){
          const a = j.history[j.history.length-2]?.price||m.price;
          const b = j.history[j.history.length-1]?.price||m.price;
          m.changePct = a? ((b-a)/a)*100 : 0;
        }
        state.cache.set(key, m);
        return m;
      }
    }catch(_){}

    // Fallback demo
    const d = demoData().find(x=>x.login===key) || { login:key, price: 50, viewers: 0, changePct: 0, vol: 10 };
    state.cache.set(key, d);
    return d;
  }

  function computeVol(history){
    const h = (history||[]).slice(-7).map(x=>Number(x.price||0)).filter(Boolean);
    if(h.length<3) return 0;
    const mean = h.reduce((a,b)=>a+b,0)/h.length;
    const variance = h.reduce((a,v)=>a+(v-mean)*(v-mean),0)/h.length;
    return Math.round(Math.sqrt(variance));
  }

  function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
  function setHTML(id, v){ const el=document.getElementById(id); if(el) el.innerHTML=v; }

  function renderWatchlist(items){
    const box = document.getElementById('market-watchlist');
    if(!box) return;
    box.innerHTML = '';
    items.forEach(m=>{
      const row = document.createElement('div');
      row.className='tf-item';
      row.innerHTML = `
        <div class="flex flex-col">
          <div class="font-extrabold text-white text-sm">${m.login}</div>
          <div class="text-xs text-gray-400">Prix: <strong class="text-white">${fmt(m.price)}</strong> ‚Ä¢ Œî ${pct(m.changePct||0)}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="tf-btn" onclick="marketQuick('${m.login}')">D√©tails</button>
        </div>`;
      box.appendChild(row);
    });
  }

  window.marketQuick = async function(login){
    document.querySelector('[data-market-tab="screener"]')?.click();
    const m = await getStreamerMarket(login);
    fillProfile(m);
    const o = document.getElementById('order-login'); if(o) o.value = login;
  };

  function fillOpportunities(items){
    const box = document.getElementById('market-opportunities');
    if(!box) return;
    box.innerHTML='';
    items.slice(0,6).forEach(m=>{
      const card = document.createElement('div');
      card.className='tf-item';
      const badge = (m.changePct||0)>=0 ? 'text-[#00f2ea]' : 'text-[#ff0099]';
      card.innerHTML = `
        <div>
          <div class="font-extrabold text-white">${m.login} <span class="${badge}">${pct(m.changePct||0)}</span></div>
          <div class="text-xs text-gray-400">Prix ${fmt(m.price)} ‚Ä¢ Vol ${fmt(m.vol||0)}</div>
          <div class="text-xs text-gray-500 mt-1">Action: surveille le momentum + compare la niche/heure.</div>
        </div>
        <button class="tf-btn tf-btn-primary" onclick="marketQuick('${m.login}')">Ouvrir</button>
      `;
      box.appendChild(card);
    });
  }

  function renderScreener(items){
    const tb=document.getElementById('market-screener');
    if(!tb) return;
    tb.innerHTML='';
    items.forEach(m=>{
      const tr=document.createElement('tr');
      const badge = (m.changePct||0)>=0 ? 'style="color:#00f2ea;font-weight:800;"' : 'style="color:#ff0099;font-weight:800;"';
      tr.innerHTML = `
        <td><button class="tf-btn" onclick="marketSelect('${m.login}')">${m.login}</button></td>
        <td>${fmt(m.price)}</td>
        <td ${badge}>${pct(m.changePct||0)}</td>
        <td>${m.viewers!=null?fmt(m.viewers):'‚Äî'}</td>
        <td>${fmt(m.vol||0)}</td>
        <td><button class="tf-btn tf-btn-primary" onclick="marketQuick('${m.login}')">Trade</button></td>`;
      tb.appendChild(tr);
    });
  }

  window.marketSelect = async function(login){
    const m = await getStreamerMarket(login);
    fillProfile(m);
  };

  function fillProfile(m){
    if(!m) return;
    setHTML('market-profile', `
      <div class="text-sm">
        <div class="font-extrabold text-white text-lg">${m.login}</div>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <div class="tf-kpi"><div class="tf-kpi-label">Prix</div><div class="tf-kpi-value">${fmt(m.price)}</div><div class="tf-kpi-sub">base ${fmt(m.basePrice||m.price)}</div></div>
          <div class="tf-kpi"><div class="tf-kpi-label">Œî%</div><div class="tf-kpi-value">${pct(m.changePct||0)}</div><div class="tf-kpi-sub">momentum</div></div>
        </div>
        <div class="mt-2 text-xs text-gray-400">P√©dago : si Œî% monte et que la niche est peu satur√©e, c'est souvent un bon signal d'opportunit√©.</div>
      </div>
    `);
    const o=document.getElementById('order-login'); if(o) o.value=m.login;
  }

  function sortAndFilter(items){
    const sort = (document.getElementById('scr-sort')?.value)||'momentum';
    const maxp = Number((document.getElementById('scr-maxprice')?.value||'').trim()||0);
    const minv = Number((document.getElementById('scr-minviewers')?.value||'').trim()||0);
    const risk = (document.getElementById('scr-risk')?.value)||'all';

    let out = items.slice();
    if(maxp>0) out = out.filter(x=>Number(x.price||0)<=maxp);
    if(minv>0) out = out.filter(x=>Number(x.viewers||0)>=minv);

    if(risk!=='all'){
      out = out.filter(x=>{
        const v=Number(x.vol||0);
        if(risk==='low') return v<=12;
        if(risk==='mid') return v>12 && v<=22;
        return v>22;
      });
    }

    out.sort((a,b)=>{
      if(sort==='price') return (b.price||0)-(a.price||0);
      if(sort==='viewers') return (b.viewers||0)-(a.viewers||0);
      if(sort==='vol') return (b.vol||0)-(a.vol||0);
      return (b.changePct||0)-(a.changePct||0);
    });
    return out;
  }

  // Portfolio (backend preferred)
  async function loadPortfolio(){
    setText('market-user', state.user);
    try{
      const j = await apiJson(`/api/fantasy/profile?user=${encodeURIComponent(state.user)}`);
      if(j && j.success){
        const cash = Number(j.cash||0);
        const holdings = j.holdings||[];
        const posVal = holdings.reduce((a,x)=>a+Number(x.value||0),0);
        setText('market-cash', fmt(cash));
        setText('market-posval', fmt(posVal));
        setText('market-net', fmt(cash+posVal));
        renderPositions(holdings);
        return;
      }
    }catch(_){}
    // demo
    setText('market-cash', fmt(10000));
    setText('market-posval', fmt(0));
    setText('market-net', fmt(10000));
    renderPositions([]);
  }

  function renderPositions(holdings){
    const tb=document.getElementById('market-positions');
    if(!tb) return;
    tb.innerHTML='';
    if(!holdings.length){
      tb.innerHTML = `<tr><td colspan="5" class="text-gray-400">Aucune position pour l'instant. Passe un ordre dans le Screener.</td></tr>`;
      return;
    }
    holdings.forEach(h=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${h.login}</td>
        <td>${fmt(h.shares)}</td>
        <td>${fmt(h.price)}</td>
        <td>${fmt(h.value)}</td>
        <td>
          <button class="tf-btn" onclick="marketQuick('${h.login}')">Trader</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  async function loadLeaderboard(){
    try{
      const j = await apiJson(`/api/fantasy/leaderboard`);
      if(j && j.success){
        const tb=document.getElementById('market-leaderboard');
        if(!tb) return;
        tb.innerHTML='';
        (j.items||[]).forEach((it,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${it.user}</td><td>${fmt(it.netWorth)}</td>`;
          tb.appendChild(tr);
        });
        return;
      }
    }catch(_){}
    const tb=document.getElementById('market-leaderboard');
    if(tb) tb.innerHTML = `<tr><td colspan="3" class="text-gray-400">Classement indisponible (backend).</td></tr>`;
  }

  // Orders: connect to backend /api/fantasy/invest or /api/fantasy/sell
  window.marketPlaceOrder = async function(){
    const login = String(document.getElementById('order-login')?.value||'').trim().toLowerCase();
    const amount = Number(String(document.getElementById('order-amount')?.value||'').trim()||0);
    const side = String(document.getElementById('order-side')?.value||'buy');
    const out = document.getElementById('market-order-status');
    if(out) out.textContent='';
    if(!login || !amount || amount<=0){
      if(out) out.innerHTML = '<span style="color:#ff0099;font-weight:800;">Montant + streamer requis.</span>';
      return;
    }
    try{
      const url = side==='sell' ? '/api/fantasy/sell' : '/api/fantasy/invest';
      const j = await apiJson(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user: state.user, streamer: login, amount })
      });
      if(j && j.success){
        if(out) out.innerHTML = `<span style="color:#00f2ea;font-weight:800;">‚úÖ OK</span> ‚Äî ${side==='sell'?'Vendu':'Achet√©'}: ${fmt(j.shares||j.sharesToSell||0)} parts`;
        // refresh
        state.cache.delete(login);
        await marketRefresh(true);
        await loadPortfolio();
      }else{
        if(out) out.innerHTML = `<span style="color:#ff0099;font-weight:800;">‚ùå ${j?.error||'Erreur ordre'}</span>`;
      }
    }catch(e){
      if(out) out.innerHTML = `<span style="color:#ff0099;font-weight:800;">‚ùå Backend indisponible</span>`;
    }
  };

  window.marketSetUser = function(){
    const v = String(document.getElementById('market-user-input')?.value||'').trim();
    if(!v) return;
    state.user = v.slice(0,50);
    localStorage.setItem('marketUser', state.user);
    loadPortfolio();
  };

  // Search field highlights screener rows
  window.marketSearch = async function(q){
    const s = String(q||'').trim().toLowerCase();
    if(!s){
      marketRefresh();
      return;
    }
    const items = await marketLoadUniverse();
    const filtered = items.filter(x=>String(x.login||'').toLowerCase().includes(s)).slice(0,60);
    renderScreener(sortAndFilter(filtered));
  };

  async function marketLoadUniverse(){
    // Universe = watchlist + some demo entries (or from backend later)
    const universe = new Set(state.watch);
    demoData().forEach(x=>universe.add(x.login));
    const list = [];
    for(const login of universe){
      const m = await getStreamerMarket(login);
      if(m) list.push(m);
    }
    return list;
  }

  // Render minimal chart (no libs) for index
  function drawIndexChart(points){
    const c = document.getElementById('market-index-chart');
    if(!c) return;
    const ctx = c.getContext('2d');
    const w = c.width = c.parentElement.clientWidth;
    const h = c.height = 110;
    ctx.clearRect(0,0,w,h);

    if(!points || points.length<2) return;

    const min = Math.min(...points);
    const max = Math.max(...points);
    const pad = 8;
    const scaleX = (w - pad*2) / (points.length - 1);
    const scaleY = (h - pad*2) / Math.max(1, (max - min));

    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((v,i)=>{
      const x = pad + i*scaleX;
      const y = h - pad - ((v-min)*scaleY);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.strokeStyle = 'rgba(0,242,234,0.9)';
    ctx.stroke();

    // baseline
    ctx.beginPath();
    ctx.moveTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  async function buildOrderbook(items){
    const list = document.getElementById('market-book-list');
    const bids = document.getElementById('market-bids');
    const asks = document.getElementById('market-asks');
    if(!list || !bids || !asks) return;

    list.innerHTML='';
    bids.innerHTML='';
    asks.innerHTML='';
    items.slice(0,8).forEach(m=>{
      const row=document.createElement('div');
      row.className='tf-item';
      row.innerHTML = `<div><div class="font-extrabold text-white">${m.login}</div><div class="text-xs text-gray-400">Prix ${fmt(m.price)}</div></div>
      <button class="tf-btn" onclick="marketSelectBook('${m.login}')">Voir carnet</button>`;
      list.appendChild(row);
    });

    // default: first
    if(items[0]) marketSelectBook(items[0].login);
  }

  window.marketSelectBook = async function(login){
    const m = await getStreamerMarket(login);
    const bids = document.getElementById('market-bids');
    const asks = document.getElementById('market-asks');
    if(!bids || !asks || !m) return;

    // simulate 10 levels around price
    const p = Number(m.price||50);
    const make = (side)=>{
      const arr=[];
      for(let i=0;i<10;i++){
        const price = side==='bid' ? Math.max(1, p - i*2) : (p + i*2);
        const qty = Math.max(1, Math.round((10-i) * (8 + (m.vol||10)/4)));
        arr.push({ price, qty });
      }
      return arr;
    };
    const bb = make('bid');
    const aa = make('ask');

    bids.innerHTML = bb.map(x=>`<div class="tf-book-row"><span>${fmt(x.qty)} parts</span><span style="color:#00f2ea;font-weight:800;">${fmt(x.price)}</span></div>`).join('');
    asks.innerHTML = aa.map(x=>`<div class="tf-book-row"><span>${fmt(x.qty)} parts</span><span style="color:#ff0099;font-weight:800;">${fmt(x.price)}</span></div>`).join('');
  };

  // Main refresh
  window.marketRefresh = async function(hard){
    if(hard) state.cache.clear();

    // KPIs + watchlist
    const items = await marketLoadUniverse();
    // index = avg price of watchlist
    const watchItems = await Promise.all(state.watch.map(getStreamerMarket));
    const valid = watchItems.filter(Boolean);
    const idx = valid.length ? valid.reduce((a,x)=>a+Number(x.price||0),0) / valid.length : 0;
    setText('market-index', idx ? fmt(idx) : '‚Äî');
    setText('market-index-sub', idx ? 'moyenne watchlist' : '‚Äî');

    const vol = valid.length ? Math.round(valid.reduce((a,x)=>a+Number(x.vol||0),0)/valid.length) : 0;
    setText('market-vol', vol ? fmt(vol) : '‚Äî');

    const top = items.slice().sort((a,b)=>(b.changePct||0)-(a.changePct||0))[0];
    setText('market-top', top? top.login : '‚Äî');
    setText('market-top-sub', top? pct(top.changePct||0) : '‚Äî');

    renderWatchlist(valid.slice(0,10));
    fillOpportunities(items.slice().sort((a,b)=>Math.abs(b.changePct||0)-Math.abs(a.changePct||0)));

    // screener
    renderScreener(sortAndFilter(items));

    // orderbook
    await buildOrderbook(items);

    // chart points (simulate recent index points)
    const pts = [];
    const base = idx || 80;
    for(let i=0;i<14;i++){
      pts.push(base * (1 + ((i%5)-2)*0.006));
    }
    drawIndexChart(pts);

    // portfolio + leaderboard
    await loadPortfolio();
    await loadLeaderboard();
  };

  function marketBoot(){
    // ensure initial tab
    marketOpenTab('overview', document.querySelector('#market-modal [data-market-tab="overview"]'));
    setText('market-user', state.user);
    const u = document.getElementById('market-user-input'); if(u) u.value = state.user;
    marketRefresh(true);
  }

  // Expose for other handlers
  window.marketBoot = marketBoot;
})();
</script>

</body>
</html>
