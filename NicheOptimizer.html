<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V60 - ULTIMATE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root { --bg: #050505; --panel: #0e0e10; --cyan: #00f2ea; --pink: #ff0099; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* UTILS */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .glass { background: var(--panel); border: 1px solid #222; }

        /* CAROUSEL */
        .carousel-track { display: flex; gap: 15px; overflow-x: auto; padding: 10px; scrollbar-width: none; }
        .stream-card { flex: 0 0 280px; height: 157px; background: #111; border: 1px solid #333; border-radius: 8px; position: relative; cursor: pointer; transition: 0.2s; }
        .stream-card:hover { border-color: var(--cyan); transform: translateY(-4px); }
        .stream-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .stream-card:hover img { opacity: 1; }

        /* SIDEBAR TABS */
        .nav-btn { width: 100%; text-align: left; padding: 12px 15px; font-family: 'Orbitron'; font-size: 11px; color: #888; border-left: 3px solid transparent; transition: 0.2s; background: #080808; display: flex; align-items: center; gap: 10px; margin-bottom: 2px; }
        .nav-btn:hover { background: #151515; color: white; }
        .nav-btn.active { background: #1a1a1a; color: var(--cyan); border-left-color: var(--cyan); }
        .nav-header { font-size: 10px; color: #555; font-weight: bold; padding: 15px 15px 5px; text-transform: uppercase; }

        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <header class="h-14 flex justify-between items-center px-4 border-b border-[#222] bg-black shrink-0">
        <h1 class="text-xl font-orbitron italic tracking-widest text-white">
            <span class="text-[#00f2ea]">STREAMER</span> HUB <span class="bg-[#222] text-[#ff0099] px-2 rounded text-[10px] ml-2 not-italic">V60</span>
        </h1>
        <div id="socket-status" class="text-[10px] font-bold text-gray-500 border border-gray-700 px-2 rounded">CONNECTING...</div>
    </header>

    <div class="h-48 bg-[#080808] border-b border-[#222] relative shrink-0">
        <div id="carousel" class="carousel-track h-full items-center" onwheel="this.scrollLeft += event.deltaY; event.preventDefault();">
            </div>
    </div>

    <div class="flex-grow grid grid-cols-12 gap-0 overflow-hidden">
        
        <div class="col-span-8 bg-black flex flex-col border-r border-[#222]">
            <div class="h-10 bg-[#0e0e10] border-b border-[#222] flex justify-between items-center px-3">
                <span id="current-chan" class="font-orbitron text-[#00f2ea] text-xs">OFFLINE</span>
                <button onclick="initPlayer()" class="text-gray-500 hover:text-white text-xs"><i class="fas fa-sync"></i></button>
            </div>
            <div id="twitch-embed" class="flex-grow w-full h-full bg-black relative"></div>
        </div>

        <div class="col-span-4 bg-[#0e0e10] flex flex-col h-full overflow-hidden border-l border-[#222]">
            
            <div class="flex h-full">
                <div class="w-14 bg-black border-r border-[#222] flex flex-col items-center py-4 gap-4 shrink-0">
                    <button onclick="openTab('chat')" id="btn-chat" class="text-gray-500 hover:text-white active-icon text-xl" title="Tchat"><i class="fas fa-comments"></i></button>
                    <button onclick="openTab('stats')" id="btn-stats" class="text-gray-500 hover:text-white text-xl" title="Stats"><i class="fas fa-chart-pie"></i></button>
                    <div class="w-8 h-[1px] bg-[#333]"></div>
                    <button onclick="openTab('scanner')" id="btn-scanner" class="text-gray-500 hover:text-[#00f2ea] text-xl" title="Scanner"><i class="fas fa-search"></i></button>
                    <button onclick="openTab('planning')" id="btn-planning" class="text-gray-500 hover:text-[#ffd700] text-xl" title="Planning"><i class="fas fa-clock"></i></button>
                    <button onclick="openTab('raid')" id="btn-raid" class="text-gray-500 hover:text-[#10b981] text-xl" title="Raid Finder"><i class="fas fa-crosshairs"></i></button>
                </div>

                <div class="flex-grow relative bg-[#0e0e10]">
                    
                    <div id="tab-chat" class="tab-content active">
                        <div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222]">
                            <button onclick="toggleChat('twitch')" class="flex-1 py-1 text-[10px] font-bold bg-[#6441a5] text-white rounded">TWITCH</button>
                            <button onclick="toggleChat('hub')" class="flex-1 py-1 text-[10px] font-bold bg-[#222] text-gray-300 rounded hover:bg-[#333]">HUB</button>
                        </div>
                        <div id="chat-twitch" class="flex-grow relative w-full h-full">
                            <iframe id="twitch-frame" src="" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                        <div id="chat-hub" class="flex-grow hidden flex-col bg-[#111] h-full">
                            <div id="hub-msgs" class="flex-grow overflow-y-auto p-3"></div>
                            <form onsubmit="sendMsg(event)" class="p-2 border-t border-[#222] flex gap-2">
                                <input id="hub-in" class="bg-[#222] text-white text-xs p-2 rounded flex-grow outline-none border border-[#333]" placeholder="Message...">
                                <button class="text-[#00f2ea]"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>

                    <div id="tab-stats" class="tab-content p-4 overflow-y-auto space-y-4">
                        <h3 class="font-orbitron text-white text-sm border-b border-[#222] pb-2">DASHBOARD ANALYTICS</h3>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="glass p-3 border-l-2 border-[#00f2ea]">
                                <div class="text-[9px] text-gray-500 uppercase">Viewers</div>
                                <div id="stat-viewers" class="text-xl font-orbitron text-white">--</div>
                            </div>
                            <div class="glass p-3 border-l-2 border-[#ff0099]">
                                <div class="text-[9px] text-gray-500 uppercase">Chaînes</div>
                                <div id="stat-channels" class="text-xl font-orbitron text-white">--</div>
                            </div>
                        </div>

                        <div class="glass p-3">
                            <h4 class="text-[10px] text-gray-400 mb-2 font-bold uppercase">Tendance (24h)</h4>
                            <div class="h-32"><canvas id="chartTrend"></canvas></div>
                        </div>
                        
                        <div class="glass p-3">
                            <h4 class="text-[10px] text-gray-400 mb-2 font-bold uppercase">Top Jeux</h4>
                            <div class="h-32"><canvas id="chartGames"></canvas></div>
                        </div>

                        <div class="glass p-3">
                            <h4 class="text-[10px] text-gray-400 mb-2 font-bold uppercase">Langues</h4>
                            <div class="h-32"><canvas id="chartLangs"></canvas></div>
                        </div>
                    </div>

                    <div id="tab-scanner" class="tab-content p-4 space-y-4">
                        <h3 class="font-orbitron text-[#00f2ea] text-sm border-b border-[#222] pb-2"><i class="fas fa-search mr-2"></i>SCANNER & AUDIT</h3>
                        <div class="flex gap-2">
                            <input id="scan-in" type="text" placeholder="Pseudo..." class="bg-[#222] text-white text-xs p-2 rounded w-full border border-[#333]">
                            <button onclick="runScan()" class="bg-[#00f2ea] text-black px-3 rounded font-bold"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <div id="scan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
                            <div class="flex gap-3 items-center mb-3">
                                <img id="scan-img" src="" class="w-10 h-10 rounded-full border border-[#00f2ea]">
                                <div>
                                    <div id="scan-name" class="font-bold text-white text-sm">--</div>
                                    <div id="scan-score" class="text-[10px] text-[#00f2ea]">Score: --</div>
                                </div>
                            </div>
                            <div id="scan-ai" class="text-[10px] text-gray-400 leading-relaxed bg-black/50 p-2 rounded"></div>
                        </div>
                    </div>

                    <div id="tab-planning" class="tab-content p-4 space-y-4">
                        <h3 class="font-orbitron text-[#ffd700] text-sm border-b border-[#222] pb-2"><i class="fas fa-clock mr-2"></i>PLANNING OPTIMIZER</h3>
                        <div class="flex gap-2">
                            <input id="plan-in" type="text" placeholder="Jeu (ex: Valorant)..." class="bg-[#222] text-white text-xs p-2 rounded w-full border border-[#333]">
                            <button onclick="runPlan()" class="bg-[#ffd700] text-black px-3 rounded font-bold"><i class="fas fa-magic"></i></button>
                        </div>
                        <div id="plan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222] text-[11px]"></div>
                    </div>

                    <div id="tab-raid" class="tab-content p-4 space-y-4">
                        <h3 class="font-orbitron text-[#10b981] text-sm border-b border-[#222] pb-2"><i class="fas fa-crosshairs mr-2"></i>RAID FINDER</h3>
                        <div class="flex gap-2">
                            <input id="raid-game" type="text" placeholder="Catégorie..." class="bg-[#222] text-white text-xs p-2 rounded w-full border border-[#333]">
                            <button onclick="runRaid()" class="bg-[#10b981] text-black px-3 rounded font-bold"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="raid-res" class="hidden mt-2 bg-[#151515] p-2 rounded text-center cursor-pointer hover:bg-[#222] border border-green-900" onclick="setChannel('zerator')">
                            <img id="raid-img" src="" class="w-full h-20 object-cover rounded mb-2">
                            <div id="raid-name" class="font-bold text-white text-xs"></div>
                            <div id="raid-meta" class="text-[9px] text-green-400"></div>
                            <button class="w-full bg-green-700 text-white text-[9px] font-bold py-1 mt-2 rounded uppercase">LANCER LE RAID</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG AUTO DOMAINE (CRITIQUE POUR TWITCH)
        const HOST = window.location.hostname;
        const PARENTS = ["localhost", "127.0.0.1", "justplayer.fr", "www.justplayer.fr"];
        if(!PARENTS.includes(HOST)) PARENTS.push(HOST);

        let socket, player, charts = {};

        window.onload = () => {
            initSocket();
            loadCarousel();
            initPlayer();
            loadStats();
        };

        // --- 1. PLAYER & CHAT ---
        async function initPlayer() {
            const res = await fetch('/api/player');
            const data = await res.json();
            setChannel(data.channel);
        }

        function setChannel(channel) {
            document.getElementById('current-chan').innerText = channel.toUpperCase();
            document.getElementById('twitch-embed').innerHTML = "";
            
            // LECTEUR VIDEO
            player = new Twitch.Embed("twitch-embed", {
                width: "100%", height: "100%", channel: channel, layout: "video", parent: PARENTS
            });

            // TCHAT IFRAME (Solution robuste)
            const p = PARENTS.map(d=>`parent=${d}`).join('&');
            document.getElementById('twitch-frame').src = `https://www.twitch.tv/embed/${channel}/chat?${p}&darkpopout`;
        }

        // --- 2. CAROUSEL ---
        async function loadCarousel() {
            const res = await fetch('/api/live-feed');
            const data = await res.json();
            const el = document.getElementById('carousel');
            el.innerHTML = "";
            data.streams.forEach(s => {
                el.innerHTML += `
                <div class="stream-card flex-shrink-0" onclick="setChannel('${s.user}')">
                    <img src="${s.thumb}">
                    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-2">
                        <div class="font-bold text-white text-xs truncate">${s.user}</div>
                        <div class="text-[#00f2ea] text-[10px]">${s.viewers} Viewers</div>
                    </div>
                </div>`;
            });
        }

        // --- 3. STATS GRAPHIQUES ---
        async function loadStats() {
            const res = await fetch('/api/stats/full');
            const d = await res.json();

            // KPI
            document.getElementById('stat-viewers').innerText = d.kpi.total_viewers.toLocaleString();
            document.getElementById('stat-channels').innerText = d.kpi.total_channels;

            // Trend Chart
            createChart('chartTrend', 'line', d.charts.trend.labels, d.charts.trend.data, '#00f2ea', true);
            // Games Chart
            createChart('chartGames', 'bar', d.charts.games.labels, d.charts.games.data, '#ff0099', false);
            // Langs Chart
            createChart('chartLangs', 'doughnut', d.charts.langs.labels, d.charts.langs.data, ['#00f2ea', '#ff0099', '#ffd700', '#fff'], false);
        }

        function createChart(id, type, labels, data, colors, fill) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: type==='line'?'rgba(0,242,234,0.1)':colors,
                        borderColor: Array.isArray(colors)?'#000':colors,
                        fill: fill,
                        tension: 0.4
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        // --- 4. OUTILS ---
        async function runScan() {
            const q = document.getElementById('scan-in').value;
            const box = document.getElementById('scan-res');
            box.classList.remove('hidden');
            const res = await fetch('/api/tools/scan', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})});
            const d = await res.json();
            document.getElementById('scan-name').innerText = d.data.name;
            document.getElementById('scan-img').src = d.data.avatar;
            document.getElementById('scan-score').innerText = "Score: " + d.data.score;
            document.getElementById('scan-ai').innerText = d.data.analysis;
        }

        async function runPlan() {
            const g = document.getElementById('plan-in').value;
            const res = await fetch('/api/tools/planning', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({game:g})});
            const d = await res.json();
            const box = document.getElementById('plan-res');
            box.classList.remove('hidden'); box.innerHTML = d.html;
        }

        async function runRaid() {
            const g = document.getElementById('raid-game').value;
            const res = await fetch('/api/tools/raid', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({game:g})});
            const d = await res.json();
            const box = document.getElementById('raid-res');
            box.classList.remove('hidden');
            document.getElementById('raid-name').innerText = d.target.name;
            document.getElementById('raid-img').src = d.target.thumb;
            document.getElementById('raid-meta').innerText = d.target.viewers + " Viewers";
        }

        // --- 5. SYSTEME ---
        function initSocket() {
            try {
                socket = io();
                socket.on('connect', () => { document.getElementById('socket-status').innerText="ONLINE"; document.getElementById('socket-status').className="text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded"; });
                socket.on('chat message', (m) => {
                    const b = document.getElementById('hub-msgs');
                    b.innerHTML+=`<div class="hub-msg"><strong class="text-[#00f2ea]">${m.user}:</strong> ${m.text}</div>`;
                    b.scrollTop=b.scrollHeight;
                });
            } catch(e){}
        }
        function sendMsg(e) {
            e.preventDefault();
            const i = document.getElementById('hub-in');
            if(i.value){ socket.emit('chat message', i.value); i.value=""; }
        }
        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            // Highlight icon
            document.querySelectorAll('#btn-chat, #btn-stats, #btn-scanner, #btn-planning, #btn-raid').forEach(b=>b.style.color="#888");
            const activeBtn = document.querySelector(`button[onclick="openTab('${id}')"]`);
            if(activeBtn) activeBtn.style.color = "white";
        }
        function toggleChat(m){
            if(m==='hub'){document.getElementById('chat-container-twitch').classList.add('hidden');document.getElementById('chat-container-hub').classList.remove('hidden');document.getElementById('chat-container-hub').classList.add('flex');}
            else{document.getElementById('chat-container-hub').classList.add('hidden');document.getElementById('chat-container-hub').classList.remove('flex');document.getElementById('chat-container-twitch').classList.remove('hidden');}
        }
    </script>
</body>
</html>
