<div id="tab-followed" class="tab-content">
            <h3 class="tab-heading text-pink"><span class="icon">üîë</span> Connexion & Mon Fil Suivi</h3>
            <div class="login-box">
                <h4 class="text-blue font-bold text-sm mb-2">Connexion Utilisateur Twitch (OAuth)</h4>
                <p id="login-status" class="text-yellow text-xs mb-4">Statut: V√©rification...</p>
                <button id="btn-twitch-login" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px;">üîí SE CONNECTER VIA TWITCH</button>
            </div> 
            <div class="mt-6 pt-5 border-t border-gray-700" style="border-color: var(--color-border-medium);"> 
                <h4 class="tab-heading text-pink"><span class="icon">üî¥</span> Vos Cha√Ænes Suivies LIVE</h4> 
                <div id="followed-streams-list"><p style="color:#555; text-align:center; padding:10px;">Chargement du fil...</p></div> 
            </div> 
        </div>

    <script>
    
    // =========================================================
    // ‚úÖ CORRECTION CRUCIALE POUR RENDER
    // =========================================================
    // Cette variable doit √™tre l'URL HTTPS de votre d√©ploiement Render
    const API_BASE = 'https://justplayerstreamhubpro.onrender.com';
    // ---------------------------------------------------------
    
    const DEFAULT_CHANNEL = 'twitch'; 
    let ACTIVE_CHANNEL = DEFAULT_CHANNEL;
    let IS_USER_CONNECTED = false;

    // --- 1. Utilitaire de Requ√™te API ---
    async function fetchAPI(endpoint, method = 'GET', data = null) {
        // Utilise la variable API_BASE corrig√©e
        const url = `${API_BASE}${endpoint}`;
        
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            // CRUCIAL : Permet l'envoi des cookies de session pour l'authentification
            credentials: 'include' 
        };

        if (data && method !== 'GET') { options.body = JSON.stringify(data); }

        try {
            const response = await fetch(url, options);

            if (!response.ok) {
                let errorData = {};
                try { errorData = await response.json(); } catch (e) { errorData = { error: `Erreur serveur (${response.status} ${response.statusText}).` }; }
                if (errorData.html_response) { throw new Error(errorData.html_response); }
                throw new Error(errorData.error || `Erreur serveur non sp√©cifi√©e (${response.status})`);
            }
            
            return await response.json();

        } catch (error) {
            if (error.message.includes('Failed to fetch') || error.message.includes('TypeError')) {
                throw new Error("√âchec de la connexion au serveur (r√©seau coup√©, API non d√©marr√©e ou API_BASE incorrecte).");
            }
            throw error; 
        }
    }

    // --- 2. Fonctions d'Interface (Tabs et Player) ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`).classList.add('active');
        localStorage.setItem('activeTab', tabId);
    }
    
    // Fonction lanc√©e par le bouton "LANCER" du lecteur
    window.launchPlayer = function(channel) {
        if (!channel) return;
        
        ACTIVE_CHANNEL = channel;
        localStorage.setItem('activeChannel', channel);
        
        const playerDiv = document.getElementById('twitch-embed');
        playerDiv.innerHTML = ''; 
        
        // La librairie Twitch Player est charg√©e dans le DOMContentLoaded
        if (typeof Twitch === 'undefined') {
             // S'assurer que le script est charg√© avant d'initialiser
            console.error("Twitch Player n'est pas encore charg√©.");
            setTimeout(() => window.launchPlayer(channel), 500);
            return;
        }

        // Assurez-vous d'utiliser un nom de domaine parent valide pour Twitch Embed (Render + localhost)
        new Twitch.Embed("twitch-embed", {
            width: '100%',
            height: '100%',
            channel: channel,
            parent: [RENDER_DOMAIN.replace('https://', ''), "localhost"]
        });
        
        // Mise √† jour de l'UI (statut, boutons)
        updatePlayerUI(channel, null, false, null);
        document.getElementById('clip-btn').dataset.query = channel;
        document.getElementById('boost-btn').dataset.query = channel;
    }
    
    // Ajout√© pour le Repurposing (n√©cessite la variable API_BASE)
    window.seekVod = function(vodId, seconds) {
        const playerDiv = document.getElementById('twitch-embed');
        playerDiv.innerHTML = ''; 

        if (typeof Twitch === 'undefined') {
            console.error("Twitch Player n'est pas encore charg√©.");
            return;
        }

        new Twitch.Embed("twitch-embed", {
            width: '100%',
            height: '100%',
            video: vodId,
            time: secondsToHms(seconds),
            parent: [RENDER_DOMAIN.replace('https://', ''), "localhost"]
        });
        
        updatePlayerUI(vodId, vodId, false, null);
    }

    // Simule la mise √† jour de l'UI pour le joueur
    function updatePlayerUI(channelName, videoId, isLive, viewerCount) {
        const statusEl = document.getElementById('player-channel-status');
        const iconEl = document.getElementById('player-icon');
        // (Logique de votre UI inchang√©e)
        if (videoId) { 
            statusEl.innerHTML = `üìº VOD: ${channelName.toUpperCase()}`; 
            statusEl.style.color = 'var(--color-ai-repurpose)'; 
            iconEl.innerHTML = '‚ñ∂Ô∏è'; 
        } else if (isLive) { 
            statusEl.innerHTML = `üî¥ ${channelName.toUpperCase()} (LIVE) - ${viewerCount ? viewerCount.toLocaleString('fr-FR') + ' vues' : ''}`; 
            statusEl.style.color = '#ff0000'; 
            iconEl.innerHTML = 'üî•'; 
        } else { 
            statusEl.innerHTML = `${channelName.toUpperCase()} (Hors ligne)`; 
            statusEl.style.color = 'var(--color-text-dimmed)'; 
            iconEl.innerHTML = 'üé¨'; 
        }
    }
    
    function secondsToHms(d) {
        d = Number(d);
        const h = Math.floor(d / 3600);
        const m = Math.floor(d % 3600 / 60);
        const s = Math.floor(d % 3600 % 60);
        
        const hDisplay = h > 0 ? h + ":" : "";
        const mDisplay = m < 10 ? (h > 0 ? "0" + m : m) + ":" : m + ":";
        const sDisplay = s < 10 ? "0" + s : s;
        return hDisplay + mDisplay + sDisplay;
    }

    // --- 3. Gestion de l'Authentification Twitch ---
    
    // ‚úÖ CORRIG√â : L'appel de d√©part pointe vers l'API_BASE (Render)
    function startAuth() {
        window.location.href = `${API_BASE}/twitch_auth_start`;
    }

    async function logout() {
        if (!confirm("Voulez-vous vraiment vous d√©connecter de Twitch?")) return;
        try {
            await fetchAPI('/twitch_logout', 'POST');
            checkAuth();
        } catch (error) {
            alert(`Erreur lors de la d√©connexion: ${error.message}`);
        }
    }

    async function checkAuth() {
        const loginStatus = document.getElementById('login-status');
        const loginButton = document.getElementById('btn-twitch-login');
        loginStatus.textContent = 'Statut: V√©rification...';
        
        try {
            // Utilise fetchAPI qui pointe vers l'API_BASE (Render)
            const data = await fetchAPI('/twitch_user_status'); 
            
            IS_USER_CONNECTED = data.is_connected;

            if (data.is_connected) {
                loginStatus.innerHTML = `Connect√© en tant que: <strong>${data.display_name}</strong>`;
                loginButton.textContent = 'üîí D√âCONNEXION';
                loginButton.onclick = logout;
                loginButton.style.background = '#e34a64'; // Couleur de d√©connexion
                loadFollowedStreams(); 
                // document.getElementById('raid-btn').disabled = false; // D√©sactiv√© par d√©faut si non trouv√©
                // document.getElementById('clip-btn').disabled = false; // D√©sactiv√© par d√©faut si non trouv√©
                // document.getElementById('boost-btn').disabled = false; // D√©sactiv√© par d√©faut si non trouv√©

            } else {
                loginStatus.textContent = 'Statut: D√©connect√©';
                loginButton.textContent = 'üîí SE CONNECTER VIA TWITCH';
                loginButton.onclick = startAuth; // Attache la fonction startAuth corrig√©e
                loginButton.style.background = '#6441a5'; // Couleur Twitch
                document.getElementById('followed-streams-list').innerHTML = `<p style="color:var(--color-text-dimmed); text-align:center; padding:10px;">Connectez-vous √† Twitch pour charger votre fil suivi.</p>`;
                // D√©sactivation des boutons d'actions n√©cessitant la connexion
                // ... (Logique pour d√©sactiver les autres boutons)
            }
        } catch (error) {
            if (error.message.includes("Non authentifi√©")) {
                 loginStatus.textContent = 'Statut: D√©connect√© (Session expir√©e)';
                 loginButton.textContent = 'üîí SE CONNECTER VIA TWITCH';
                 loginButton.onclick = startAuth; 
                 loginButton.style.background = '#6441a5';
            } else {
                loginStatus.innerHTML = `Statut: ‚ùå API non disponible (${error.message})`;
                loginButton.disabled = true;
            }
        }
    }

    // --- 4. Chargement des Streams Suivis (Utilise fetchAPI corrig√©) ---
    async function loadFollowedStreams() {
        const followedStreamsList = document.getElementById('followed-streams-list');
        followedStreamsList.innerHTML = '<p style="text-align:center; color:var(--color-primary-pink); padding:10px;">Chargement de votre fil...</p>';

        try {
            const data = await fetchAPI('/followed_streams');
            if (data.streams.length === 0) {
                followedStreamsList.innerHTML = '<p style="text-align:center; color:var(--color-text-dimmed); padding:10px;">Aucune cha√Æne suivie n\'est actuellement en direct.</p>';
                return;
            }
            // ... (Logique d'affichage des streams inchang√©e) ...
            followedStreamsList.innerHTML = ''; // Clear loading message
             data.streams.forEach(stream => { 
                const item = document.createElement('div');
                item.className = 'followed-stream-item';
                item.onclick = () => window.launchPlayer(stream.user_login);
                const thumbnailUrl = stream.thumbnail_url
                    .replace('{width}', '320')
                    .replace('{height}', '180');
                item.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${stream.user_name}" style="border-radius: 6px; width:100%;">
                    <strong style="color:var(--color-primary-pink); font-size: 13px; margin-top: 5px;">${stream.user_name}</strong>
                    <div class="stream-meta text-xs text-gray-400 flex justify-between">
                        <span>${stream.game_name}</span>
                        <span style="color:#ff0000;">${stream.viewer_count.toLocaleString()} vues</span>
                    </div>
                    <p class="text-xs text-white mt-1">${stream.title.substring(0, 50)}...</p>
                `;
                followedStreamsList.appendChild(item);
            });
        } catch (error) {
            followedStreamsList.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå Erreur de chargement du fil: ${error.message}</p>`;
        }
    }

    // --- (Ajoutez ici toutes vos autres fonctions JS : callAI, hmsToSeconds, etc. pour un fichier complet) ---
    
    // --- 8. Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        // Ajout de la librairie Twitch Player
        const script = document.createElement('script');
        script.setAttribute('src', 'https://player.twitch.tv/js/embed/v1.js');
        document.head.appendChild(script);

        // Attendre que le script Twitch Embed soit charg√© avant de lancer le lecteur
        script.onload = () => {
             const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
             window.launchPlayer(lastChannel); 
        };

        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        
        checkAuth(); // D√©clenche la v√©rification et configure le bouton de connexion.
        
        // √âv√©nement pour le lecteur personnalis√©
        document.getElementById('form-channel-player').addEventListener('submit', function(e) {
            e.preventDefault();
            const channel = document.getElementById('input-channel').value.trim();
            if (channel) {
                window.launchPlayer(channel);
            }
        });
        
        // ... (Autres √©couteurs d'√©v√©nements) ...
        
        // --- √âcouteur pour le bouton de connexion au d√©marrage (m√™me si checkAuth le fait d√©j√†) ---
        document.getElementById('btn-twitch-login').onclick = startAuth; // Default click handler
        
    });
</script>
</body>
</html>
