<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    
    <style>
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-chat-bubble: #33aaff;
        }
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', sans-serif; margin: 0; }
        #main-container { max-width: 1200px; margin: 20px auto; padding: 10px; }
        
        /* Elements */
        h1 { font-family: 'Orbitron', sans-serif; color: var(--color-primary-pink); text-align: center; font-size: 28px; }
        .btn-primary { background: var(--color-primary-pink); color: #fff; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.8; }
        .btn-secondary { background: var(--color-secondary-blue); color: #000; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* Onglets */
        .tabs-header { display: flex; border-bottom: 2px solid #333; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 12px 20px; background: #111; color: #aaa; cursor: pointer; border: 1px solid #333; border-bottom: none; font-family: 'Orbitron'; white-space: nowrap; }
        .tab-btn.active { background: var(--color-bg-medium); color: #fff; border-top: 3px solid var(--color-primary-pink); font-weight: bold; }
        .tab-content { display: none; padding: 20px; background: var(--color-bg-medium); border: 1px solid #333; }
        .tab-content.active { display: block; }
        
        /* Cartes & Inputs */
        .input-std { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .result-box { background: #0a0a0a; border: 1px solid #333; padding: 15px; margin-top: 15px; border-radius: 6px; min-height: 50px; }
        
        /* Chat Flottant */
        #ai-chat-bubble { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--color-chat-bubble); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; z-index: 1000; box-shadow: 0 0 10px rgba(51,170,255,0.5); }
        #ai-chat-panel { position: fixed; bottom: 100px; right: 30px; width: 320px; height: 450px; background: #222; border: 2px solid var(--color-chat-bubble); border-radius: 12px; display: none; flex-direction: column; z-index: 999; }
        #ai-chat-panel.open { display: flex; }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .msg { padding: 8px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .msg.ai { background: #333; text-align: left; }
        .msg.user { background: var(--color-primary-pink); text-align: right; }
    </style>
</head>
<body>

<div id="main-container">
    <h1>Streamer Hub V8</h1>
    
    <div style="background: #1a1a1a; padding: 10px; margin-bottom: 20px; border-radius: 8px;">
        <div id="twitch-embed" style="height: 400px;"></div>
        <div class="flex gap-2 mt-2">
            <input id="channel-input" class="input-std" placeholder="Nom de la chaÃ®ne..." style="width: auto; flex-grow: 1;">
            <button id="btn-load-player" class="btn-primary">Charger</button>
        </div>
    </div>

    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab('tab-scan')">ðŸŽ¯ Scanner</button>
        <button class="tab-btn" onclick="openTab('tab-niche')">ðŸ“ˆ Niche IA</button>
        <button class="tab-btn" onclick="openTab('tab-followed')">ðŸ”‘ Mon Compte</button>
        <button class="tab-btn" onclick="openTab('tab-boost')">âš¡ Boost</button>
    </div>

    <div id="tab-scan" class="tab-content active">
        <h3>Scanner de ChaÃ®ne / Jeu</h3>
        <input id="scan-query" class="input-std mb-2" placeholder="Jeu ou Pseudo...">
        <button id="btn-scan" class="btn-primary">Scanner</button>
        <div id="scan-result" class="result-box">RÃ©sultats ici...</div>
    </div>

    <div id="tab-niche" class="tab-content">
        <h3>Analyse IA</h3>
        <div class="flex gap-2 mb-2">
            <select id="ia-type" class="input-std" style="width: 150px;">
                <option value="niche">Niche</option>
                <option value="repurpose">Repurpose</option>
                <option value="trend">Trend</option>
            </select>
            <input id="ia-query" class="input-std" placeholder="Sujet...">
        </div>
        <button id="btn-ia" class="btn-secondary">Lancer Analyse</button>
        <div id="ia-result" class="result-box">L'IA rÃ©pondra ici...</div>
    </div>

    <div id="tab-followed" class="tab-content">
        <div id="login-section">
            <p>Connectez-vous pour voir vos stats et points.</p>
            <a href="/twitch_auth_start" class="btn-primary">Connexion Twitch</a>
        </div>
        <div id="user-section" style="display:none;">
            <h3>Bienvenue <span id="user-name" style="color: #ff0099;"></span></h3>
            <p>Points : <strong id="user-points">0</strong></p>
            <button onclick="logout()" class="btn-secondary text-xs">DÃ©connexion</button>
            <hr class="my-4 border-gray-700">
            <h4>Vos Streams Suivis :</h4>
            <div id="followed-list" class="flex flex-wrap gap-2">Chargement...</div>
        </div>
    </div>

    <div id="tab-boost" class="tab-content">
        <h3>Boost de Stream (CoÃ»t: 3h)</h3>
        <input id="boost-channel" class="input-std mb-2" placeholder="Votre chaÃ®ne...">
        <button id="btn-boost" class="btn-primary">Activer Boost</button>
        <div id="boost-result" class="result-box"></div>
    </div>

</div>

<div id="ai-chat-bubble">ðŸ’¬</div>
<div id="ai-chat-panel">
    <div style="padding: 10px; border-bottom: 1px solid #444; font-weight: bold;">Assistant IA</div>
    <div id="chat-window"></div>
    <div style="padding: 10px; display: flex;">
        <input id="chat-input" class="input-std" placeholder="Question...">
        <button id="btn-chat" class="btn-primary" style="margin-left: 5px;">></button>
    </div>
</div>

<script>
    // --- NAVIGATION ---
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Hack simple pour surligner le bouton
        event.target.classList.add('active');
    }

    // --- PLAYER TWITCH ---
    let embed;
    function loadPlayer(channel) {
        document.getElementById('twitch-embed').innerHTML = '';
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%", height: "100%", channel: channel, layout: "video",
            parent: [window.location.hostname, "localhost"]
        });
    }
    document.getElementById('btn-load-player').onclick = () => loadPlayer(document.getElementById('channel-input').value);

    // --- AUTH & USER ---
    async function checkAuth() {
        try {
            const res = await fetch('/twitch_user_status');
            const data = await res.json();
            if (data.is_connected) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                document.getElementById('user-name').innerText = data.username;
                document.getElementById('user-points').innerText = data.points;
                loadFollowed();
            }
        } catch(e) { console.error(e); }
    }
    async function logout() {
        await fetch('/twitch_logout', {method:'POST'});
        location.reload();
    }
    async function loadFollowed() {
        const res = await fetch('/followed_streams');
        const data = await res.json();
        const div = document.getElementById('followed-list');
        div.innerHTML = '';
        if (data.data) {
            data.data.forEach(s => {
                div.innerHTML += `<div onclick="loadPlayer('${s.user_name}')" style="background:#000; padding:5px; cursor:pointer; border:1px solid #333;">${s.user_name} (${s.viewer_count})</div>`;
            });
        }
    }

    // --- API CALLS (GENERIC) ---
    async function apiCall(url, body) {
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error(`Status ${res.status}`);
            return await res.json();
        } catch (e) {
            return { error: e.message };
        }
    }

    // --- SCANNER ---
    document.getElementById('btn-scan').onclick = async () => {
        const q = document.getElementById('scan-query').value;
        const div = document.getElementById('scan-result');
        div.innerHTML = "Chargement...";
        const data = await apiCall('/scan_target', { query: q });
        
        if (data.type === 'game') {
            div.innerHTML = `<strong>Jeu : ${data.game_data.name}</strong><br>Viewers: ${data.game_data.total_viewers}`;
        } else if (data.type === 'user') {
            div.innerHTML = `<strong>User : ${data.user_data.display_name}</strong><br>${data.user_data.is_live ? 'EN LIVE' : 'OFFLINE'}`;
        } else {
            div.innerHTML = data.message || data.error;
        }
    };

    // --- IA CRITIQUE ---
    document.getElementById('btn-ia').onclick = async () => {
        const type = document.getElementById('ia-type').value;
        const q = document.getElementById('ia-query').value;
        const div = document.getElementById('ia-result');
        div.innerHTML = "L'IA rÃ©flÃ©chit...";
        const data = await apiCall('/critique_ia', { type, query: q });
        div.innerHTML = data.html_critique || data.error;
    };

    // --- CHAT IA ---
    document.getElementById('ai-chat-bubble').onclick = () => {
        document.getElementById('ai-chat-panel').classList.toggle('open');
    };
    document.getElementById('btn-chat').onclick = async () => {
        const input = document.getElementById('chat-input');
        const win = document.getElementById('chat-window');
        const txt = input.value;
        if(!txt) return;
        
        win.innerHTML += `<div class="msg user">${txt}</div>`;
        input.value = '';
        win.scrollTop = win.scrollHeight;
        
        const data = await apiCall('/ai_chat_query', { query: txt });
        win.innerHTML += `<div class="msg ai">${data.response || data.error}</div>`;
        win.scrollTop = win.scrollHeight;
    };

    // --- BOOST ---
    document.getElementById('btn-boost').onclick = async () => {
        const c = document.getElementById('boost-channel').value;
        const data = await apiCall('/stream_boost', { channel: c });
        document.getElementById('boost-result').innerHTML = data.html_response || data.error;
    };

    // INIT
    loadPlayer('zerator');
    checkAuth();
</script>

</body>
</html>
