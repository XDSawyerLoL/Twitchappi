<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub - COCKPIT MODE (V17 - Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root { --color-bg-dark: #0d0d0d; --color-bg-medium: #1a1a1a; --color-primary-pink: #ff0099; --color-secondary-blue: #22c7ef; --color-time-gold: #ffd700; --color-ai-niche: #59d682; --color-ai-repurpose: #9933ff; --color-ai-action: #e34a64; --color-text-dimmed: #9aa3a8; --color-border-dark: #2e2e2e; }
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { max-width: 1400px; margin: 20px auto; padding: 10px; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: var(--color-primary-pink); margin-bottom: 5px; text-align: center; text-shadow: 0 0 5px var(--color-primary-pink); }
        .tab-btn { font-family: 'Orbitron', sans-serif; padding: 12px 15px; background: #111; border: 1px solid #333; cursor: pointer; flex: 1; text-align: center; color: #888; }
        .tab-btn.active { background: #1a1a1a; color: #fff; border-top: 3px solid var(--color-primary-pink); font-weight: bold; }
        .tab-content { display: none; background: #1a1a1a; padding: 20px; border: 1px solid #2e2e2e; min-height: 300px; }
        .tab-content.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .dashboard-box { background: #0a0a0a; border: 1px solid #2e2e2e; border-radius: 6px; padding: 15px; min-height: 250px; }
        .box-stats { border-top: 2px solid var(--color-secondary-blue); } .box-niche { border-top: 2px solid var(--color-ai-niche); } .box-vod { border-top: 2px solid var(--color-ai-repurpose); }
        .btn-primary { background: var(--color-primary-pink); color: #fff; padding: 10px 15px; border-radius: 6px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
        #twitch-embed { width: 100%; height: 500px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; background: #000; }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .player-quick-input { background: #0d0d0d; border: 1px solid #333; color: white; padding: 5px; border-radius: 4px; }
        .metric-value { font-family: 'Orbitron'; font-size: 22px; }
        .ai-output-enhanced { font-size: 13px; line-height: 1.5; color: #ddd; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1><span style="color:var(--color-secondary-blue)">STREAMER</span> HUB V17</h1>
    
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button class="tab-btn active" onclick="openTab('tab-followed')">üîë MON FIL</button> 
        <button class="tab-btn" onclick="openTab('tab-dashboard')">üìä DASHBOARD</button>
        <button class="tab-btn" onclick="openTab('tab-time')">‚è∞ BEST TIME</button>
        <button class="tab-btn" onclick="openTab('tab-boost')">‚ö° BOOST</button>
        <button class="tab-btn" onclick="openTab('tab-raid')">üí• RAID</button>
    </div>

    <div class="player-wrapper">
        <div class="player-header">
            <h2 class="orbitron text-xl text-blue-400">üé¨ LECTEUR <span id="player-channel-status" class="text-sm text-gray-500 ml-2">...</span></h2>
            <div class="flex gap-2">
                <button onclick="cycleStream('prev')" class="bg-gray-800 text-white px-3 py-1 rounded">‚óÄ</button>
                <button onclick="cycleStream('next')" class="bg-gray-800 text-white px-3 py-1 rounded">‚ñ∂</button>
                <form onsubmit="event.preventDefault(); launchPlayer(document.getElementById('input-channel').value)" class="flex gap-2">
                    <input id="input-channel" type="text" placeholder="Cha√Æne..." class="player-quick-input">
                    <button type="submit" class="bg-pink-600 text-white px-3 py-1 rounded font-bold">GO</button>
                </form>
            </div>
        </div>
        <div id="twitch-embed"></div>
    </div>

    <div id="tab-followed" class="tab-content active">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-pink-500 font-bold">üî¥ Vos Cha√Ænes LIVE</h3>
            <button id="btn-twitch-login" onclick="loginTwitch()" class="bg-purple-700 px-3 py-1 rounded text-xs font-bold">CONNEXION TWITCH</button>
        </div>
        <div id="followed-streams-list" class="flex flex-wrap gap-3 text-gray-500 text-center p-10">Connectez-vous pour voir vos favoris.</div>
    </div>

    <div id="tab-dashboard" class="tab-content">
        <div class="text-center mb-5">
            <h3 class="text-blue-400 font-bold text-lg">ANALYSE 360¬∞ & IA</h3>
            <form id="form-global-scan">
                <input id="input-global-target" type="text" placeholder="Pseudo ou Jeu..." class="w-full bg-black border border-gray-700 p-2 rounded text-white text-center mb-2">
                <button type="submit" class="btn-primary">üöÄ ANALYSE RADAR</button>
            </form>
        </div>
        <div class="dashboard-grid">
            <div class="dashboard-box box-stats">
                <div class="text-blue-400 font-bold mb-2 orbitron">üìä TRACKER</div>
                <div id="res-scan-content" class="text-gray-400 text-center mt-10">En attente...</div>
            </div>
            <div class="dashboard-box box-niche">
                <div class="text-green-400 font-bold mb-2 orbitron">üß† STRAT√âGIE IA</div>
                <div id="res-niche-content" class="ai-output-enhanced text-center mt-10">L'IA attend vos ordres.</div>
            </div>
            <div class="dashboard-box box-vod">
                <div class="text-purple-400 font-bold mb-2 orbitron">‚úÇÔ∏è CLIPS & VOD</div>
                <div id="res-vod-content" class="text-center mt-10">Analyse VOD...</div>
            </div>
        </div>
    </div>

    <div id="tab-time" class="tab-content">
        <h3 class="text-yellow-400 font-bold mb-4">‚è∞ OPTIMISATION HORAIRE</h3>
        <form id="form-schedule" class="flex gap-2">
            <input id="input-schedule-game" type="text" placeholder="Jeu (ex: LoL)" class="w-full bg-black border border-gray-700 p-2 rounded text-white">
            <button type="submit" class="bg-yellow-500 text-black px-4 py-2 rounded font-bold">CALCULER</button>
        </form>
        <div id="schedule-results" class="mt-4 bg-gray-900 p-4 rounded border border-yellow-500 hidden">
            <div id="schedule-ai-content" class="ai-output-enhanced"></div>
        </div>
    </div>

    <div id="tab-boost" class="tab-content">
        <h3 class="text-pink-500 font-bold mb-4">‚ö° STREAM BOOST</h3>
        <form id="form-boost" class="flex gap-2">
            <input id="input-boost" type="text" placeholder="Pseudo Twitch" class="w-full bg-black border border-gray-700 p-2 rounded text-white">
            <button type="submit" class="btn-primary">ACTIVER</button>
        </form>
        <div id="boost-results" class="mt-4 text-center text-gray-400"></div>
    </div>

    <div id="tab-raid" class="tab-content">
        <h3 class="text-red-500 font-bold mb-4">üí• RAID OPTIMIS√â</h3>
        <form id="form-raid" class="flex flex-col gap-3">
            <input id="input-raid-game" type="text" placeholder="Jeu..." class="w-full bg-black border border-gray-700 p-2 rounded text-white">
            <select id="select-raid-viewers" class="w-full bg-black border border-gray-700 p-2 rounded text-white">
                <option value="10">Max 10 Vues</option><option value="50" selected>Max 50 Vues</option><option value="100">Max 100 Vues</option>
            </select>
            <button type="submit" class="bg-red-600 text-white p-2 rounded font-bold w-full">RECHERCHER</button>
        </form>
        <div id="raid-results" class="mt-4 text-center text-gray-400"></div>
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    let embed = null;

    // --- ONGLETS ---
    window.openTab = function(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display='block';
        event.currentTarget.classList.add('active');
        if(id === 'tab-followed') loadFollowed();
    };

    // --- LECTEUR (AUTOPLAY FIX) ---
    window.launchPlayer = function(channel) {
        if(embed) { embed.setChannel(channel); return; }
        document.getElementById('twitch-embed').innerHTML = "";
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%", height: "100%", channel: channel, layout: "video-and-chat", autoplay: true, muted: false,
            parent: [window.location.hostname, "justplayer.fr", "justplayerstreamhubpro.onrender.com"]
        });
        document.getElementById('input-channel').value = channel;
        document.getElementById('player-channel-status').innerText = channel;
    };

    // --- SCAN & TRACKER ---
    document.getElementById('form-global-scan').onsubmit = async (e) => {
        e.preventDefault();
        const q = document.getElementById('input-global-target').value;
        const boxS = document.getElementById('res-scan-content');
        const boxN = document.getElementById('res-niche-content');
        
        boxS.innerHTML = "Chargement..."; boxN.innerHTML = "Analyse IA...";
        
        const res = await fetch(API_BASE + '/scan_target', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query: q})
        });
        const data = await res.json();
        
        if(data.success && data.type === 'user') {
            const u = data.user_data;
            boxS.innerHTML = `
                <div class="flex items-center gap-3 mb-4">
                    <img src="${u.profile_image_url}" class="w-12 h-12 rounded-full border-2 border-blue-500">
                    <div class="font-bold text-lg">${u.display_name}</div>
                </div>
                <div class="text-2xl font-bold text-white">${u.total_followers} Abos</div>
                <div class="text-green-400 text-sm mt-2">"${u.growth_info}"</div>
                <button onclick="launchPlayer('${u.login}')" class="btn-primary mt-4">LANCER</button>
            `;
            
            // APPEL IA
            const aiRes = await fetch(API_BASE + '/critique_ia', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: 'niche', query: u.display_name, growth_info: u.growth_info})
            });
            const aiData = await aiRes.json();
            boxN.innerHTML = aiData.html_response;
            
            // VOD
            const vRes = await fetch(API_BASE + '/get_latest_vod?channel=' + u.login);
            const vData = await vRes.json();
            if(vData.success) {
                document.getElementById('res-vod-content').innerHTML = `<img src="${vData.vod.thumbnail_url}" width="100%"><br><b>${vData.vod.title}</b>`;
            }
        }
    };

    // --- AUTRES ACTIONS ---
    document.getElementById('form-schedule').onsubmit = async (e) => {
        e.preventDefault();
        const g = document.getElementById('input-schedule-game').value;
        const res = await fetch(API_BASE + '/analyze_schedule', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({game: g})
        });
        const data = await res.json();
        document.getElementById('schedule-results').classList.remove('hidden');
        document.getElementById('schedule-ai-content').innerHTML = data.html_response;
    };

    document.getElementById('form-raid').onsubmit = async (e) => {
        e.preventDefault();
        const g = document.getElementById('input-raid-game').value;
        const max = document.getElementById('select-raid-viewers').value;
        const res = await fetch(API_BASE + '/start_raid', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({game: g, max_viewers: max})
        });
        const d = await res.json();
        document.getElementById('raid-results').innerHTML = d.success ? 
            `<b>${d.target.name}</b> (${d.target.viewers} v) <button onclick="launchPlayer('${d.target.login}')" class="text-red-500">GO</button>` : d.error;
    };

    // --- INIT ---
    window.onload = async () => {
        const r = await fetch(API_BASE + '/get_default_stream');
        const d = await r.json();
        launchPlayer(d.channel || 'twitch');
    };
    
    window.cycleStream = async (dir) => {
        const r = await fetch(API_BASE + '/cycle_stream', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({direction: dir})
        });
        const d = await r.json();
        if(d.success) launchPlayer(d.channel);
    };
</script>
</body>
</html>
