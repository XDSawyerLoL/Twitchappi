<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V9.2 - LIVE DASHBOARD ULTRA-EFFICACE</title> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert pour la niche */
            --color-ai-repurpose: #9933ff; /* Violet pour le repurposing */
            --color-ai-growth: #ffcc00; /* Jaune pour la croissance/alertes */
            --color-ai-action: #e34a64; /* Rouge/Corail pour l'action/export */ 
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { all: initial; display: block; max-width: 1200px; margin: 20px auto; padding: 10px; font-family: 'Inter', sans-serif; color: #fff; }
        /* TITRE MIS √Ä JOUR EN V9.2 */
        h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: var(--color-primary-pink); margin-bottom: 5px; text-align: center; }
        .h1-blue-accent { color: var(--color-secondary-blue); }
        .subtitle-center { color: var(--color-text-dimmed); font-size: 12px; margin-bottom: 15px; text-align: center; }
        
        /* Lecteur */
        .player-wrapper { margin-bottom: 20px; padding: 15px; background: var(--color-bg-medium); border-radius: 12px; border: 1px solid var(--color-border-dark); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .player-wrapper h2 { font-family: 'Orbitron', sans-serif; font-size: 20px; color: var(--color-secondary-blue); margin: 0 0 10px; display: flex; align-items: center; }
        #player-channel-status { font-size: 12px; color: var(--color-text-dimmed); margin-left: auto; font-weight: normal; font-family: 'Inter', sans-serif; }
        #twitch-embed { width: 100%; height: 550px; border-radius: 8px; box-shadow: 0 0 15px rgba(34, 199, 239, 0.3); overflow: hidden; }
        #form-channel-player { display: flex; gap: 8px; margin-bottom: 15px; }

        /* Infos Streamer Actif (V9.1) */
        #active-streamer-info { 
            display: none; 
            background: var(--color-bg-light); 
            border: 1px solid var(--color-border-medium); 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 15px; 
        }
        #active-streamer-info h4 { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 14px; 
            color: var(--color-primary-pink); 
            margin-bottom: 8px; 
        }
        .streamer-stat { 
            display: inline-block; 
            margin-right: 15px; 
            font-size: 12px; 
            color: var(--color-text-dimmed); 
        }
        .stat-value { 
            font-weight: 700; 
            color: white; 
            margin-left: 4px; 
        }
        
        /* Inputs & Boutons */
        .action-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-medium); background: var(--color-bg-dark); color: #fff; font-size: 13px; }
        .btn-primary { background: var(--color-primary-pink); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; box-shadow: 0 0 6px rgba(255,0,153,.4); }
        .btn-primary:hover:not(:disabled) { background: #E6008A; }
        .btn-secondary { background: var(--color-secondary-blue); color: var(--color-bg-dark); border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; box-shadow: 0 0 6px rgba(34,199,239,.4); }
        .btn-secondary:hover:not(:disabled) { background: #1eafdd; }

        /* Boutons de Partage (V9.1 SVG) */
        .share-btn-group button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 4px;
            transition: opacity 0.2s;
        }
        .share-btn-group button:hover { opacity: 0.8; }
        .share-btn-group svg {
            width: 18px;
            height: 18px;
        }
        .share-btn-group .btn-x { background-color: #000; color: #fff; border: 1px solid #444; }
        .share-btn-group .btn-facebook { background-color: #1877F2; color: #fff; }
        .share-btn-group .btn-reddit { background-color: #FF4500; color: #fff; }
        .share-btn-group .btn-copy { background-color: var(--color-text-dimmed); color: #fff; }
        
        /* R√©sultats IA */
        .ai-result-box { background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 15px; margin-top: 15px; color: #ffffff; }
        .ai-result-box p { margin-bottom: 12px; line-height: 1.6; font-size: 13px; }
        .ai-result-box h4 { font-family: 'Orbitron', sans-serif; font-size: 16px; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid var(--color-primary-pink); padding-bottom: 5px; color: var(--color-secondary-blue); }
        .ai-result-box strong { font-weight: 700; }
        
        /* Style des listes IA */
        .ai-result-box ul { margin-left: 0; padding-left: 0; list-style-type: none; margin-bottom: 15px; font-size: 13px; line-height: 1.5; }
        .ai-result-box li { margin-bottom: 8px; padding-left: 1.5em; position: relative; }
        
        /* Ic√¥nes par d√©faut (‚ö°) */
        .ai-result-box li:before {
            content: "‚ö°";
            color: var(--color-primary-pink);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1.5em;
            position: absolute;
        }

        /* Couleurs IA sp√©cifiques pour les ic√¥nes */
        #niche-result-container li:before { content: "‚úÖ"; color: var(--color-ai-niche); }
        #repurpose-result-container li:before { content: "‚úÇÔ∏è"; color: var(--color-ai-repurpose); }
        .game-item li:before, #ai-trend-critique-container li:before { content: "üíé"; color: var(--color-ai-growth); }
        #live-alerts li:before { content: "üö®"; color: var(--color-ai-action); } /* Nouvelle ic√¥ne pour LIVE */


        /* Couleurs IA des titres et bordures */
        #scan-result { border-color: var(--color-secondary-blue); }
        #niche-result-container { border-color: var(--color-ai-niche); }
        #repurpose-result-container { border-color: var(--color-ai-repurpose); }
        #ai-trend-critique-container { border-color: var(--color-ai-growth); }
        #boost-results { border-color: var(--color-primary-pink); }
        #live-alerts { border-color: var(--color-ai-action); } /* Nouveau style */
        
        #niche-result-container h4 { color: var(--color-ai-niche); border-color: var(--color-ai-niche); }
        #repurpose-result-container h4 { color: var(--color-ai-repurpose); border-color: var(--color-ai-repurpose); }
        #ai-trend-critique-container h4 { color: var(--color-ai-growth); border-color: var(--color-ai-growth); }
        
        #niche-result-container strong { color: var(--color-ai-niche); }
        #repurpose-result-container strong { color: var(--color-ai-repurpose); }
        #ai-trend-critique-container strong { color: var(--color-ai-growth); }
        
        /* Style pour la zone de Repurposing visuel */
        #repurpose-vod-preview {
            background: var(--color-bg-light);
            border: 1px solid var(--color-ai-repurpose);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none; 
            align-items: flex-start;
            gap: 15px;
        }
        #repurpose-vod-preview img {
            width: 150px;
            height: auto;
            min-width: 150px;
            border-radius: 4px;
            border: 1px solid var(--color-border-medium);
        }
        #vod-title-display {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-ai-repurpose);
            margin-bottom: 5px;
            line-height: 1.4;
        }
        .timestamp-link {
            background: var(--color-ai-repurpose);
            color: var(--color-bg-dark);
            padding: 3px 8px;
            border:none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 5px;
            display: inline-block;
            text-transform: uppercase;
        }
        .timestamp-link:hover {
            background: #cc99ff;
        }
        
        /* Styles sp√©cifiques pour l'Auto-Export V9.0 & Clip Instantan√© */
        .export-btn { 
            background: var(--color-ai-action); 
            color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; 
            cursor: pointer; font-weight: 700; text-transform: uppercase; 
            font-size: 12px; box-shadow: 0 0 6px rgba(227, 74, 100, .4);
        }
        .export-btn:hover:not(:disabled) {
            background: #D5445B;
        }

        /* Onglets (V9.1 Draggable) */
        .tab-btn { 
            font-family: 'Orbitron', sans-serif; 
            padding: 12px 15px; 
            background: var(--color-bg-light); 
            border: 1px solid var(--color-border-medium); 
            border-bottom: none; 
            color: var(--color-text-dimmed); 
            cursor: grab; /* Curseur de drag */
            border-radius: 8px 8px 0 0; 
            transition: all 0.2s; 
            flex: 1; 
            text-align: center; 
            font-size: 12px; 
            white-space: nowrap; 
        }
        .tab-btn:active { cursor: grabbing; }
        .tab-btn.active { 
            background: var(--color-bg-medium); 
            color: #fff; 
            border-top: 3px solid var(--color-primary-pink); 
            font-weight: bold; 
        }
        /* Nouvelle couleur pour l'onglet LIVE */
        .tab-btn[data-tab-id="tab-live"].active {
            border-top: 3px solid var(--color-ai-action);
        }

        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid var(--color-border-dark); border-top: none; border-radius: 0 0 10px 10px; padding: 20px; }
        .tab-content.active { display: block; }
        .tab-heading { font-family:'Orbitron',sans-serif; margin-bottom:15px; font-size:16px; }
        .login-box { padding:15px; background:var(--color-bg-light); border-radius:8px; margin-bottom:20px; border: 1px solid #444; }

        /* Liste Streams & Jeux */
        #followed-streams-list, #trending-games-list { display: flex; flex-wrap: wrap; gap: 15px; padding: 0; margin: 0; }
        .followed-stream-item { display: flex; flex-direction: column; width: calc(33.333% - 10px); min-width: 180px; padding: 10px; background: var(--color-bg-light); border-radius: 8px; border: 1px solid var(--color-border-dark); cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
        .followed-stream-item:hover { background: #280517; border-color: var(--color-primary-pink); transform: translateY(-2px); }
        .streamer-avatar { width: 100%; aspect-ratio: 16 / 9; border-radius: 4px; border: 1px solid var(--color-primary-pink); object-fit: cover; flex-shrink: 0; }
        .game-item .streamer-avatar { aspect-ratio: 180 / 240; border-color: var(--color-ai-niche); }
        .stream-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--color-text-dimmed); margin-top: 5px; }

        /* --- MINI ASSISTANT CSS --- */
        .assistant-btn { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, var(--color-secondary-blue), #0066cc); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 199, 239, 0.4); z-index: 1000; transition: transform 0.2s; border: none; }
        .assistant-btn:hover { transform: scale(1.1); }
        .assistant-panel { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: var(--color-bg-medium); border: 1px solid var(--color-secondary-blue); border-radius: 12px; display: none; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden; }
        .assistant-header { padding: 15px; background: rgba(34, 199, 239, 0.1); border-bottom: 1px solid var(--color-border-dark); font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--color-secondary-blue); display: flex; justify-content: space-between; align-items: center; }
        .assistant-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 8px; font-size: 13px; line-height: 1.4; max-width: 85%; color: #fff; }
        .msg.user { align-self: flex-end; background: var(--color-primary-pink); border-bottom-right-radius: 0; }
        .msg.bot { align-self: flex-start; background: var(--color-bg-light); border: 1px solid var(--color-border-medium); border-bottom-left-radius: 0; }
        .msg.bot ul { list-style-type: disc; padding-left: 20px; margin-top: 5px; }
        .assistant-input-area { padding: 10px; border-top: 1px solid var(--color-border-dark); display: flex; gap: 8px; }

        /* V9.2 Styles Sp√©cifiques pour LIVE DASHBOARD */
        #live-dashboard > div {
             box-shadow: 0 0 10px rgba(227, 74, 100, 0.2);
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .followed-stream-item { width: 100%; min-width: unset; }
            #twitch-embed { height: 350px; }
            /* Les tabs deviennent flexibles pour s'adapter */
            .tab-btn { flex-basis: 50%; max-width: 50%; } 
            .assistant-panel { width: calc(100% - 40px); bottom: 90px; right: 20px; height: 400px; }
            #live-dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl"><span class="h1-blue-accent">STREAMER</span> HUB V9.2</h1>
    <div class="subtitle-center">Lecteur ‚Ä¢ Scan & IA ‚Ä¢ **LIVE DASHBOARD (Ultra-Efficace)** ‚Ä¢ Repurposing ‚Ä¢ Croissance ‚Ä¢ Glisser-D√©poser</div>

    <div class="player-wrapper">
        <h2>
            <span style="margin-right:6px;" id="player-icon">üé¨</span> LECTEUR & CHAT
            <span id="player-channel-status"></span>
        </h2> 
        <form id="form-channel-player" class="flex">
            <input id="input-channel" type="text" placeholder="Nom de la cha√Æne Twitch (ex: gotaga)" title="Nom de la cha√Æne Twitch √† regarder" class="action-input flex-grow">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[80px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>

        <div id="active-streamer-info">
            <h4 id="streamer-info-name">D√©tails Streamer</h4>
            <div class="flex flex-wrap gap-4 mb-2">
                <span class="streamer-stat">Followers: <span id="streamer-followers" class="stat-value">...</span></span>
                <span class="streamer-stat">Vues Totales: <span id="streamer-views" class="stat-value">...</span></span>
                <span class="streamer-stat">En Ligne: <span id="streamer-live-status" class="stat-value">...</span></span>
            </div>
            <p id="streamer-description" class="text-xs text-gray-400 mt-2 italic"></p>
        </div>

        <div id="twitch-player-share" class="pt-3 border-t border-gray-700 mt-3" style="border-color:var(--color-border-dark);">
            </div>
    </div>

    <div id="tabs-container">
        <div class="flex flex-wrap flex-tabs" id="tab-button-container">
            <button class="tab-btn" data-tab-id="tab-followed" data-default-order="1" onclick="openTab('tab-followed')">üîë MON FIL SUIVI</button> 
            <button class="tab-btn" data-tab-id="tab-cible" data-default-order="2" onclick="openTab('tab-cible')">üéØ SCAN & RESULTATS</button>
            <button class="tab-btn" data-tab-id="tab-live" data-default-order="3" onclick="openTab('tab-live')">üî¥ LIVE DASHBOARD</button> <button class="tab-btn" data-tab-id="tab-niche" data-default-order="4" onclick="openTab('tab-niche')">üìà OPTIMISATION NICHE</button>
            <button class="tab-btn" data-tab-id="tab-repurpose" data-default-order="5" onclick="openTab('tab-repurpose')">üöÄ REPURPOSING</button>
            <button class="tab-btn" data-tab-id="tab-growth" data-default-order="6" onclick="openTab('tab-growth')">üí∞ CROISSANCE</button>
            <button class="tab-btn" data-tab-id="tab-boost" data-default-order="7" onclick="openTab('tab-boost')">‚ö° BOOST</button>
        </div>

        <div id="tab-followed" class="tab-content">
            <h3 class="tab-heading text-pink"><span class="icon">üîë</span> Connexion & Mon Fil Suivi</h3>
            <div class="login-box">
                <h4 class="text-blue font-bold text-sm mb-2">Connexion Utilisateur Twitch (OAuth)</h4>
                <p id="login-status" class="text-yellow text-xs mb-4">Statut: V√©rification...</p>
                <button id="btn-twitch-login" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px;">üîí SE CONNECTER VIA TWITCH</button>
            </div>
            <div class="mt-6 pt-5 border-t border-gray-700" style="border-color: var(--color-border-medium);">
                <h4 class="tab-heading text-pink"><span class="icon">üî¥</span> Vos Cha√Ænes Suivies LIVE</h4>
                <div id="followed-streams-list"><p style="color:#555; text-align:center; padding:10px;">Chargement du fil...</p></div>
            </div>
        </div>

        <div id="tab-cible" class="tab-content">
            <h3 class="tab-heading text-blue"><span class="icon">üî≠</span> Configuration & Scan</h3>
            <form id="form-target" class="flex gap-2 mb-2">
                <input id="input-target" type="text" placeholder="Jeu ou Pseudo" class="action-input">
                <button type="submit" id="btn-target" class="btn-secondary min-w-[80px]">üéØ CIBLER</button>
            </form>
            <div id="scan-result" class="ai-result-box"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Entrez un jeu ou un pseudo et cliquez sur CIBLER.</p></div>
        </div>

        <div id="tab-live" class="tab-content">
            <h3 class="tab-heading" style="color:var(--color-ai-action);"><span class="icon">üî¥</span> Tableau de Bord LIVE (Analyse en Temps R√©el)</h3>
            <div id="live-dashboard" class="grid grid-cols-3 gap-4 mb-4">
                <div class="p-4 bg-gray-900 rounded-lg border border-red-500/50">
                    <div class="text-sm text-gray-400 font-bold">SPECTATEURS ACTUELS</div>
                    <div id="live-metric-viewers" class="text-3xl font-orbitron text-red-500 mt-1">N/A</div>
                </div>
                <div class="p-4 bg-gray-900 rounded-lg border border-red-500/50">
                    <div class="text-sm text-gray-400 font-bold">SCORE DE SANT√â IA</div>
                    <div id="live-metric-health" class="text-3xl font-orbitron text-yellow-500 mt-1">N/A</div>
                </div>
                <div class="p-4 bg-gray-900 rounded-lg border border-red-500/50">
                    <div class="text-sm text-gray-400 font-bold">DUR√âE DU STREAM</div>
                    <div id="live-metric-uptime" class="text-3xl font-orbitron text-green-500 mt-1">00:00:00</div>
                </div>
            </div>
            
            <div id="live-stream-details" class="p-4 bg-gray-900 rounded-lg border border-gray-700 mb-4">
                <h4 class="text-lg font-orbitron text-white mb-2">D√©tails Actuels</h4>
                <p class="text-sm text-gray-400">Titre: <strong id="live-detail-title" class="text-white">...</strong></p>
                <p class="text-sm text-gray-400">Jeu: <strong id="live-detail-game" class="text-white">...</strong></p>
            </div>

            <h4 class="tab-heading" style="color:var(--color-ai-action); margin-top: 20px;"><span class="icon">üö®</span> ALERTES IA & ACTIONS RAPIDES</h4>
            <div id="live-alerts" class="ai-result-box">
                <p style="color:var(--color-text-dimmed);">Aucune alerte IA pour le moment. Lancez un stream et connectez-vous pour commencer l'analyse.</p>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button id="btn-live-ia-title" class="btn-primary flex-1" style="background:var(--color-ai-growth); color:var(--color-bg-dark); font-weight:bold;">üîÆ TITRE IA</button>
                <button id="btn-live-ia-health" class="btn-primary flex-1" style="background:var(--color-secondary-blue); color:var(--color-bg-dark); font-weight:bold;">ü©∫ SANT√â STREAM</button>
                <button id="btn-live-clip" class="export-btn flex-1">üé¨ CLIP INSTANTAN√â</button>
            </div>
        </div>

        <div id="tab-niche" class="tab-content">
            <h3 class="tab-heading text-green"><span class="icon">üìà</span> Analyse de Niche</h3>
            <form id="form-niche-analysis" class="flex gap-2 mb-2">
                <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser (ex: Starfield)" class="action-input">
                <button type="submit" id="btn-niche-analyse" class="btn-primary min-w-[120px]" style="background:var(--color-ai-niche);">‚ú® ANALYSER</button>
            </form>
            <div id="niche-result-container" class="ai-result-box"><div id="niche-results" class="ai-content"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les r√©sultats de l'analyse de niche IA appara√Ætront ici.</p></div></div>
        </div>
        
        <div id="tab-repurpose" class="tab-content">
            <h3 class="tab-heading text-purple"><span class="icon">‚úÇÔ∏è</span> Repurposing IA & Auto-Export</h3>
            <form id="form-repurpose" class="flex gap-2 mb-2 flex-col">
                <input id="input-repurpose-channel" type="text" placeholder="Pseudo du Streamer" class="action-input">
                <button type="submit" id="btn-repurpose-analyse" class="btn-primary p-3" style="background:var(--color-ai-repurpose);">üöÄ ANALYSER VOD</button>
            </form>
            
            <div id="repurpose-vod-preview">
                <img id="vod-thumbnail" src="https://placehold.co/150x84/222/9933ff.png?text=VOD" alt="Miniature VOD">
                <div class="flex-1">
                    <div id="vod-title-display">Saisissez un pseudo pour analyser sa derni√®re VOD.</div>
                    <a id="vod-link" href="#" target="_blank" class="btn-secondary" style="background: var(--color-secondary-blue); padding: 5px 10px; font-size: 11px;">Voir la VOD compl√®te</a>
                </div>
            </div>

            <div id="repurpose-result-container" class="ai-result-box">
                <div id="repurpose-results" class="ai-content">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les suggestions de contenu court appara√Ætront ici.</p>
                </div>
                <button id="btn-export-vod" class="export-btn w-full mt-4 p-3" style="display:none;">üì§ EXPORTER LE CLIP S√âLECTIONN√â</button>
            </div>
        </div>

        <div id="tab-growth" class="tab-content">
            <h3 class="tab-heading text-yellow"><span class="icon">üí∞</span> Tableau de Bord Croissance</h3>
            <div class="login-box">
                <button id="btn-hype-games" class="btn-primary w-full p-3 mb-4" style="background:var(--color-ai-niche); color: var(--color-bg-dark);">üïπÔ∏è MEILLEURS JEUX HYPE DU MOMENT</button>
                
                <button id="btn-trend-detector" class="btn-primary w-full p-3" style="background:var(--color-ai-growth); color: var(--color-bg-dark);">üîÆ D√âTECTER LA PROCHAINE NICHE (IA)</button>
                
                <div id="ai-trend-critique-container" class="ai-result-box" style="border-color: var(--color-ai-growth); margin-top: 15px;"><p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Cliquez sur le bouton du dessus pour lancer l'analyse des tendances V/S.</p></div>
            </div>
             <div class="mt-6 pt-5 border-t border-gray-700" style="border-color: var(--color-border-medium);">
                <h4 class="tab-heading text-yellow" style="color:var(--color-ai-niche);"><span class="icon">üìà</span> Jeux en Tendance (Twitch)</h4>
                <div id="trending-games-list" class="flex flex-wrap gap-4 justify-center">
                    <p style="color:#555; text-align:center; padding:10px;">Cliquez sur "Jeux Hype" pour charger les r√©sultats.</p>
                </div>
            </div>
        </div>

        <div id="tab-boost" class="tab-content">
            <h3 class="tab-heading text-pink"><span class="icon">‚¨ÜÔ∏è</span> STREAM BOOST</h3>
            <div class="login-box">
                <form id="form-boost" class="flex gap-2">
                    <input id="input-boost" type="text" placeholder="Cha√Æne √† promouvoir" class="action-input">
                    <button type="submit" id="btn-boost" class="btn-primary min-w-[100px]">üì§ BOOST</button>
                </form>
                <div id="boost-results" class="ai-result-box" style="border-color: var(--color-primary-pink); margin-top: 15px;"><p style="text-align:center; color: var(--color-text-dimmed);">Entrez le nom de la cha√Æne et cliquez sur BOOST. (Cooldown de 3 heures)</p></div>
            </div>
        </div>
    </div>
</div>

<button id="assistant-toggle" class="assistant-btn">ü§ñ</button>
<div id="assistant-panel" class="assistant-panel">
    <div class="assistant-header">
        <span>ASSISTANT IA</span>
        <span style="cursor:pointer;" onclick="toggleAssistant()">‚úñ</span>
    </div>
    <div id="assistant-messages" class="assistant-messages">
        <div class="msg bot">Salut ! Je suis ton assistant de poche. Pose-moi une question sur ton stream, un titre ou une id√©e de clip !</div>
    </div>
    <form id="assistant-form" class="assistant-input-area">
        <input id="assistant-input" type="text" placeholder="Ta question..." class="action-input" autocomplete="off">
        <button type="submit" class="btn-secondary">></button>
    </form>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 
    let embed = null;
    let twitchUserConnected = false;
    let currentVODId = null; 
    let selectedClipTime = null; 
    const aiTrendCritiqueContainer = document.getElementById('ai-trend-critique-container');
    const exportButton = document.getElementById('btn-export-vod');
    const tabButtonContainer = document.getElementById('tab-button-container');

    // V9.2 - GESTION DU DASHBOARD LIVE
    let liveDashboardInterval = null;

    function startLiveDashboard(channelName) {
        if (liveDashboardInterval) clearInterval(liveDashboardInterval);
        
        const dashboardLogic = async () => {
            const alertsBox = document.getElementById('live-alerts');
            alertsBox.innerHTML = '<p style="color:var(--color-ai-action);">‚öôÔ∏è Rafra√Æchissement des donn√©es LIVE...</p>';

            // MOCK: Simulation d'un appel API pour les donn√©es LIVE
            try {
                // Pour la d√©mo, on simule une cha√Æne "live" avec des donn√©es
                const isChannelLive = channelName !== DEFAULT_CHANNEL && channelName.toLowerCase() !== 'offline'; 
                
                if (isChannelLive) {
                    // Donn√©es mock√©es plus r√©alistes
                    const viewers = Math.floor(Math.random() * 200) + 50; 
                    const vsRatio = (Math.random() * 0.5 + 0.5).toFixed(2);
                    const healthScore = Math.min(100, (viewers / 10 + vsRatio * 50)).toFixed(0); 
                    
                    // Formatage du temps (simplifi√©)
                    let uptimeHours = Math.floor(Math.random() * 4); 
                    let uptimeMinutes = Math.floor(Math.random() * 60);
                    let uptimeSeconds = Math.floor(Math.random() * 60);
                    const uptime = `${String(uptimeHours).padStart(2, '0')}:${String(uptimeMinutes).padStart(2, '0')}:${String(uptimeSeconds).padStart(2, '0')}`;
                    
                    const mockStreamData = {
                        viewer_count: viewers,
                        avg_viewers_per_streamer: parseFloat(vsRatio),
                        uptime: uptime,
                        title: `LIVE: Je test la nouvelle IA v9.2 ! ${Math.random().toFixed(2)}`,
                        game_name: "The Legend of Zelda: Tears of the Kingdom (Mock)",
                    };
                    
                    // Update Metrics
                    document.getElementById('live-dashboard').style.opacity = '1';
                    document.getElementById('live-metric-viewers').textContent = mockStreamData.viewer_count.toLocaleString('fr-FR');
                    document.getElementById('live-metric-health').textContent = `${healthScore} / 100`;
                    document.getElementById('live-metric-uptime').textContent = mockStreamData.uptime; 
                    
                    // Update Details
                    document.getElementById('live-detail-title').textContent = mockStreamData.title;
                    document.getElementById('live-detail-game').textContent = mockStreamData.game_name;

                    // Simulation des Alertes IA (Appel Critique IA)
                    const alertRes = await fetch(`${API_BASE}/critique_ia`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        // On demande des alertes bas√©es sur les donn√©es mock√©es
                        body: JSON.stringify({ 
                            type: 'live_alerts', 
                            query: `viewers:${viewers}, health:${healthScore}, vsRatio:${vsRatio}` 
                        })
                    });
                    const alertData = await alertRes.json();
                    
                    if(alertData.success && alertData.html_response) {
                        document.getElementById('live-alerts').innerHTML = alertData.html_response;
                    } else {
                        alertsBox.innerHTML = `<p style="color:var(--color-text-dimmed);">Aucune alerte IA urgente. Tout est en ordre (Score: ${healthScore}).</p>`;
                    }
                    
                } else {
                    // If not live, display appropriate message
                    document.getElementById('live-dashboard').style.opacity = '0.5';
                    document.getElementById('live-metric-viewers').textContent = 'OFF';
                    document.getElementById('live-metric-health').textContent = 'N/A';
                    document.getElementById('live-metric-uptime').textContent = '00:00:00';
                    document.getElementById('live-detail-title').textContent = '...';
                    document.getElementById('live-detail-game').textContent = '...';
                    alertsBox.innerHTML = `<p style="color:var(--color-text-dimmed);">Le dashboard LIVE est inactif. Le canal <strong>${channelName}</strong> n'est pas en direct ou est une VOD.</p>`;
                }
            } catch (e) {
                console.error("Erreur Dashboard LIVE:", e);
                alertsBox.innerHTML = `<p style="color:red;">‚ùå Erreur de connexion aux donn√©es LIVE.</p>`;
            }
        };
        
        // Run immediately and every 30 seconds
        dashboardLogic();
        liveDashboardInterval = setInterval(dashboardLogic, 30000); 
    }

    function stopLiveDashboard() {
        if (liveDashboardInterval) {
            clearInterval(liveDashboardInterval);
            liveDashboardInterval = null;
        }
    }
    // FIN V9.2 - GESTION DU DASHBOARD LIVE

    // --- 1. FONCTIONS DE GESTION DES ONGLET ET DU VOD (AJOUT DRAGGABLE) ---

    function saveTabOrder() {
        const order = Array.from(tabButtonContainer.children).map(btn => btn.dataset.tabId);
        localStorage.setItem('tabOrder', JSON.stringify(order));
    }

    function loadTabOrder() {
        const savedOrder = JSON.parse(localStorage.getItem('tabOrder'));
        if (savedOrder && savedOrder.length === tabButtonContainer.children.length) {
            const buttons = Array.from(tabButtonContainer.children);
            const orderedButtons = savedOrder.map(tabId => buttons.find(btn => btn.dataset.tabId === tabId));
            orderedButtons.forEach(btn => tabButtonContainer.appendChild(btn));
        } else {
             // Si l'ordre est invalide ou manquant, r√©initialiser l'ordre par d√©faut (bas√© sur data-default-order)
            const buttons = Array.from(tabButtonContainer.children);
            buttons.sort((a, b) => a.dataset.defaultOrder - b.dataset.defaultOrder);
            buttons.forEach(btn => tabButtonContainer.appendChild(btn));
        }
    }

    let draggingTab = null;
    tabButtonContainer.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            draggingTab = e.target;
            e.dataTransfer.effectAllowed = 'move';
            // Utiliser un petit d√©lai pour que la classe soit ajout√©e apr√®s le dragstart par le navigateur
            setTimeout(() => e.target.style.opacity = '0.5', 0); 
        }
    });

    tabButtonContainer.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        if (draggingTab && e.target.classList.contains('tab-btn') && e.target !== draggingTab) {
            const rect = e.target.getBoundingClientRect();
            const next = (e.clientX > rect.left + rect.width / 2);
            tabButtonContainer.insertBefore(draggingTab, next ? e.target.nextSibling : e.target);
        }
    });

    tabButtonContainer.addEventListener('dragend', (e) => {
        if (draggingTab) {
            draggingTab.style.opacity = '1';
            draggingTab = null;
            saveTabOrder();
        }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => btn.setAttribute('draggable', 'true'));


    function openTab(tabId) {
        localStorage.setItem('activeTab', tabId);
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            const targetBtn = document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
            if (targetBtn) targetBtn.classList.add('active');
        }
    }

    function analyzeGameNiche(gameName) {
        document.getElementById('input-niche-game').value = gameName;
        openTab('tab-niche');
        document.getElementById('btn-niche-analyse').click();
    }

    function hmsToSeconds(hms) {
        const parts = hms.split(':').map(p => parseInt(p, 10));
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) { 
            return parts[0] * 60 + parts[1];
        }
        return 0; 
    }

    // AJOUT V9.1 : Mise √† jour des informations du streamer
    function updateStreamerInfo(info) {
        const infoBox = document.getElementById('active-streamer-info');
        const statusEl = document.getElementById('player-channel-status');
        const iconEl = document.getElementById('player-icon');

        if (!info || info.is_vod) {
            infoBox.style.display = 'none';
            return;
        }

        infoBox.style.display = 'block';
        document.getElementById('streamer-info-name').innerHTML = `D√©tails Streamer: <strong style="color:var(--color-secondary-blue);">${info.display_name || info.channel_name}</strong>`;
        document.getElementById('streamer-followers').textContent = info.follower_count ? info.follower_count.toLocaleString('fr-FR') : 'N/A';
        document.getElementById('streamer-views').textContent = info.view_count ? info.view_count.toLocaleString('fr-FR') : 'N/A';
        document.getElementById('streamer-description').textContent = info.description || 'Pas de description fournie.';
        
        const liveStatusEl = document.getElementById('streamer-live-status');

        if (info.is_live) {
            liveStatusEl.innerHTML = `<span style="color:red;">üî¥ OUI</span>`;
            statusEl.innerHTML = `üî¥ ${info.channel_name.toUpperCase()} (LIVE)`;
            statusEl.style.color = '#ff0000';
            iconEl.innerHTML = 'üî•';
        } else {
            liveStatusEl.innerHTML = `<span style="color:var(--color-text-dimmed);">Non</span>`;
             statusEl.innerHTML = `${info.channel_name.toUpperCase()} (Hors ligne)`;
            statusEl.style.color = 'var(--color-text-dimmed)';
            iconEl.innerHTML = 'üé¨';
        }
    }
    
    async function fetchStreamerDetails(channelName) {
        try {
            const res = await fetch(`${API_BASE}/streamer_details?channel=${channelName}`);
            const data = await res.json();
            if (data.success && data.details) {
                // MOCK : Ajouter des donn√©es LIVE simul√©es pour le test du dashboard
                const isLive = channelName.toLowerCase() !== DEFAULT_CHANNEL && channelName.toLowerCase() !== 'offline';
                updateStreamerInfo({ 
                    ...data.details, 
                    channel_name: channelName, 
                    is_vod: false, 
                    is_live: isLive,
                    stream_details: { viewer_count: isLive ? 150 : 0 } // Mock viewer count
                });
            } else {
                updateStreamerInfo({ channel_name: channelName, is_live: false, is_vod: false }); 
            }
        } catch (error) {
            console.error("Erreur de r√©cup√©ration des d√©tails du streamer:", error);
            updateStreamerInfo({ channel_name: channelName, is_live: false, is_vod: false });
        }
    }


    // AJOUT V9.1 : Ic√¥nes SVG pour les boutons de partage
    function generateShareButtons(channel, url) {
        const shareContainer = document.getElementById('twitch-player-share');
        if (!shareContainer) return;

        const shareUrl = url || `https://twitch.tv/${channel}`;
        const encodedUrl = encodeURIComponent(shareUrl);
        const encodedText = encodeURIComponent(`D√©couvrez le stream/VOD de ${channel} sur Twitch !`);

        const twitterLink = `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
        const facebookLink = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
        const redditLink = `https://www.reddit.com/submit?url=${encodedUrl}&title=${encodedText}`;

        shareContainer.innerHTML = `
            <div class="flex space-x-2 mt-2 items-center text-sm share-btn-group">
                <span class="text-xs text-gray-400">Partager :</span>
                <button onclick="window.open('${twitterLink}', '_blank')" class="btn-x" title="Partager sur X (Twitter)">
                    <svg fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" style="color:white;"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.619L11.75 14.61 3.542 22.847H.851l8.084-9.25L0 1.154h8.05l5.051 6.223 5.799-7.22zM17.86 20.669H19.1L6.467 3.19H5.11L17.86 20.67z"></path></svg>
                </button>
                <button onclick="window.open('${facebookLink}', '_blank')" class="btn-facebook" title="Partager sur Facebook">
                    <svg fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.874V15.45H8.086v-3.45h2.352V9.897c0-2.322 1.4-3.606 3.513-3.606.99 0 1.83.074 2.08.106v2.44h-1.44c-1.13 0-1.349.535-1.349 1.325v1.733h2.713l-.353 3.45H12.9V21.874C17.34 21.128 22 16.99 22 12z"/></svg>
                </button>
                <button onclick="window.open('${redditLink}', '_blank')" class="btn-reddit" title="Partager sur Reddit">
                    <svg fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10zm-3.085 1.574c-.7.66-1.576 1.196-2.45 1.455.518-.426.837-1.042.837-1.748 0-.58-.2-1.116-.537-1.554.437-.156.915-.228 1.41-.228 1.444 0 2.62.973 2.62 2.175s-1.176 2.175-2.62 2.175a2.593 2.593 0 01-1.258-.337l-2.035 1.705v1.23h3.587v2.493H8.381V18.17h3.587v-1.23l-2.035-1.705a2.593 2.593 0 01-1.258.337c-1.444 0-2.62-.973-2.62-2.175s1.176-2.175 2.62-2.175c.495 0 .973.072 1.41.228-.337.438-.537.974-.537 1.554 0 .706.32 1.322.837 1.748-.874-.259-1.75-1.095-2.45-1.455a4.17 4.17 0 01-1.235-1.294c.148-.094.316-.168.495-.219.006-.002.013-.004.019-.006.19-.052.41-.077.625-.077 2.053 0 3.725 1.637 3.725 3.655S14.053 19 12 19s-3.725-1.637-3.725-3.655c0-1.956 1.597-3.55 3.587-3.55.19 0 .39.02.58.058l.18.037.195.04c.184.04.37.07.56.07 1.99 0 3.587 1.594 3.587 3.55s-1.672 3.655-3.725 3.655c-.215 0-.435-.025-.625-.077-.006-.002-.013-.004-.019-.006-.179-.047-.357-.121-.495-.219a4.17 4.17 0 01-1.235 1.294zM12 7.55c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5z"/></svg>
                </button>
                <button onclick="navigator.clipboard.writeText('${shareUrl}'); alert('Lien copi√© !')" class="btn-copy" title="Copier le lien">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.182-5.918a4 4 0 005.656 0l4-4a4 4 0 10-5.656-5.656l-1.1 1.1"></path></svg>
                </button>
            </div>
        `;
    }

    window.launchPlayer = async function(channelName = DEFAULT_CHANNEL, videoId = null, time = 0) {
        const embedContainer = document.getElementById('twitch-embed');
        if (embedContainer) {
             embedContainer.innerHTML = ''; 
        }
        
        if (embed) {
            embed = null; 
        }
        
        // V9.2 - Arr√™ter l'intervalle du Dashboard pr√©c√©dent
        stopLiveDashboard(); 

        const config = {
            width: "100%",
            height: "100%",
            allowfullscreen: true,
            layout: "video-and-chat",
            parent: [window.location.hostname] 
        };

        let shareUrl = `https://twitch.tv/${channelName}`;
        
        if (videoId) {
            config.video = videoId;
            config.channel = undefined; 
            shareUrl = `https://www.twitch.tv/videos/${videoId}`;
            
            if (time > 0) {
                 config.time = `${time}s`; 
            }
        } else {
            config.channel = channelName;
        }

        localStorage.setItem('activeChannel', channelName);
        document.getElementById('input-channel').value = channelName;
        
        embed = new Twitch.Embed("twitch-embed", config);

        if (videoId && time > 0) {
            shareUrl = shareUrl + `?t=${time}s`;
        }

        // V9.2 - D√©marrer l'analyse LIVE uniquement pour les cha√Ænes en direct (pas pour les VOD)
        if (!videoId) {
            await fetchStreamerDetails(channelName);
            startLiveDashboard(channelName);
        } else {
            // C'est une VOD, les infos sont limit√©es ou non pertinentes
            const statusEl = document.getElementById('player-channel-status');
            const iconEl = document.getElementById('player-icon');
            statusEl.innerHTML = `üìº VOD: ${channelName.toUpperCase()}`;
            statusEl.style.color = 'var(--color-ai-repurpose)';
            iconEl.innerHTML = '‚ñ∂Ô∏è';
            document.getElementById('active-streamer-info').style.display = 'none';
        }

        generateShareButtons(channelName, shareUrl);
    }
    
    window.seekVod = function(videoId, seconds, timeString) {
        const channel = localStorage.getItem('input-repurpose-channel') || DEFAULT_CHANNEL;
        selectedClipTime = timeString; 
        exportButton.style.display = 'block';
        exportButton.textContent = `üì§ EXPORTER CLIP (${timeString})`;

        window.launchPlayer(channel, videoId, seconds);
        document.getElementById('twitch-lucky-main').scrollIntoView({ behavior: 'smooth' });
    }

    // --- 2. LOGIQUE D'AUTHENTIFICATION TWITCH (MON FIL SUIVI) ---

    function handleLogin() {
        window.location.href = `${API_BASE}/twitch_auth_start`;
    }

    async function handleLogout() {
        await fetch(`${API_BASE}/twitch_logout`, { method: 'POST' });
        checkAuth(); 
    }

    async function loadFollowedStreams() {
        const followedStreamsList = document.getElementById('followed-streams-list');
        followedStreamsList.innerHTML = '<p style="text-align:center; color:#555; padding:10px;">Chargement des streams LIVE...</p>';

        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();
            
            if (!res.ok) { 
                throw new Error(data.error || `Erreur serveur lors de la r√©cup√©ration du fil: Statut ${res.status}`);
            }

            if (!data.success) {
                 throw new Error(data.error || "√âchec de l'API serveur.");
            }

            if (data.streams.length === 0) {
                followedStreamsList.innerHTML = '<p style="text-align:center; color:var(--color-text-dimmed); padding:10px;">Aucune cha√Æne suivie n\'est actuellement en direct.</p>';
                return;
            }

            followedStreamsList.innerHTML = ''; 
            data.streams.forEach(stream => {
                const item = document.createElement('div');
                item.className = 'followed-stream-item';
                item.onclick = () => window.launchPlayer(stream.user_login); 
                
                const thumbnailUrl = stream.thumbnail_url
                    .replace('{width}', '320')
                    .replace('{height}', '180'); 

                item.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${stream.user_name}" class="streamer-avatar">
                    <strong style="color:var(--color-primary-pink); font-size: 13px; margin-top: 5px;">${stream.user_name}</strong>
                    <div class="stream-meta">
                        <span>${stream.game_name}</span>
                        <span style="color:#ff0000;">${stream.viewer_count.toLocaleString()} vues</span>
                    </div>
                    <p class="text-xs text-white mt-1">${stream.title.substring(0, 50)}...</p>
                `;
                followedStreamsList.appendChild(item);
            });

        } catch (error) {
            followedStreamsList.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå Erreur de chargement du fil: ${error.message}</p>`;
        }
    }

    async function checkAuth() {
        const loginStatus = document.getElementById('login-status');
        const loginButton = document.getElementById('btn-twitch-login');
        loginStatus.textContent = 'Statut: V√©rification...';
        loginButton.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();
            
            if (data.is_connected) {
                twitchUserConnected = true;
                loginStatus.innerHTML = `‚úÖ Connect√© en tant que <strong style="color:var(--color-secondary-blue)">${data.display_name || data.username}</strong>`;
                loginButton.textContent = 'üîí D√âCONNEXION';
                loginButton.style.background = '#e34a64'; 
                loginButton.onclick = handleLogout;
                
                await loadFollowedStreams(); 
            } else {
                twitchUserConnected = false;
                loginStatus.textContent = '‚ùå D√©connect√©. Connectez-vous pour voir vos streams suivis.';
                loginButton.textContent = 'üîí SE CONNECTER VIA TWITCH';
                loginButton.style.background = '#6441a5';
                loginButton.onclick = handleLogin;
                document.getElementById('followed-streams-list').innerHTML = '<p style="color:var(--color-text-dimmed); text-align:center; padding:10px;">Veuillez vous connecter pour voir votre fil suivi.</p>';
            }
        } catch (error) {
            loginStatus.textContent = `‚ö†Ô∏è Erreur de connexion au serveur d'authentification.`;
        }
        loginButton.disabled = false;
    }
    
    document.getElementById('btn-twitch-login').addEventListener('click', () => {
        if(twitchUserConnected) handleLogout(); else handleLogin();
    });


    // --- 3. GESTIONNAIRES D'√âV√âNEMENTS : LECTEUR & ASSISTANT ---

    document.getElementById('form-channel-player').addEventListener('submit', function(e) {
        e.preventDefault();
        const channelName = document.getElementById('input-channel').value.trim();
        if (channelName) {
            window.launchPlayer(channelName);
        }
    });

    function toggleAssistant() {
        const panel = document.getElementById('assistant-panel');
        panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }
    document.getElementById('assistant-toggle').onclick = toggleAssistant;

    // Mini Assistant Logic 
    const assistantForm = document.getElementById('assistant-form');
    const assistantMsgs = document.getElementById('assistant-messages');

    assistantForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('assistant-input');
        const q = input.value.trim();
        const currentChannel = localStorage.getItem('activeChannel') || 'Twitch'; 
        
        if (!q) return;
        assistantMsgs.innerHTML += `<div class=\"msg user\">${q}</div>`;
        input.value = '';
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
        const loaderId = 'loader-' + Date.now();
        assistantMsgs.innerHTML += `<div id=\"${loaderId}\" class=\"msg bot\">...</div>`;
        
        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ q, context: currentChannel }) 
            });
            const data = await res.json();
            
            document.getElementById(loaderId).remove();

            if (!res.ok) { 
                // Mise √† jour de la gestion d'erreur dans l'assistant
                const errorMessage = data.html_response || data.error || `‚ùå Erreur de l'API IA: Code ${res.status}. D√©tail: ${data.message || 'Probl√®me inconnu.'}`;
                assistantMsgs.innerHTML += `<div class=\"msg bot\" style=\"color:red;\">${errorMessage}</div>`;
            } else {
                assistantMsgs.innerHTML += `<div class=\"msg bot\">${data.html_response || "D√©sol√©, probl√®me IA ou r√©ponse bloqu√©e."}</div>`;
            }

        } catch(err) { 
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class=\"msg bot\" style=\"color:red;\">‚ùå Erreur r√©seau ou serveur.</div>`;
        }
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
    });
    
    // V9.2 - GESTIONNAIRES LIVE DASHBOARD
    document.getElementById('btn-live-ia-title').addEventListener('click', function() {
        const btn = this;
        const channel = localStorage.getItem('activeChannel') || 'gotaga';
        const alertsBox = document.getElementById('live-alerts');
        
        alertsBox.innerHTML = '<p style="color:var(--color-ai-growth);">üîÆ G√©n√©ration d\'un nouveau titre viral...</p>';
        btn.disabled = true;
        
        setTimeout(async () => {
            try {
                const res = await fetch(`${API_BASE}/critique_ia`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'live_title', query: channel })
                });
                const data = await res.json();
                
                if (data.success && data.html_response) {
                     alertsBox.innerHTML = `<h4 style="color:var(--color-ai-growth); margin-top:0; border-bottom: none;">üí° Titre IA Sugg√©r√©:</h4> ${data.html_response}`;
                } else {
                     alertsBox.innerHTML = `<p style="color:red;">‚ùå √âchec de la g√©n√©ration de titre.</p>`;
                }
            } catch(e) {
                 alertsBox.innerHTML = `<p style="color:red;">‚ùå Erreur r√©seau.</p>`;
            } finally {
                btn.disabled = false;
            }
        }, 1500);
    });

    document.getElementById('btn-live-ia-health').addEventListener('click', function() {
        const btn = this;
        const channel = localStorage.getItem('activeChannel') || 'gotaga';
        const alertsBox = document.getElementById('live-alerts');
        
        alertsBox.innerHTML = '<p style="color:var(--color-secondary-blue);">ü©∫ Analyse de la sant√© du stream en cours...</p>';
        btn.disabled = true;
        
        setTimeout(async () => {
            try {
                const res = await fetch(`${API_BASE}/critique_ia`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'live_health', query: channel })
                });
                const data = await res.json();
                
                if (data.success && data.html_response) {
                     alertsBox.innerHTML = `<h4 style="color:var(--color-secondary-blue); margin-top:0; border-bottom: none;">ü©∫ Rapport de Sant√© IA:</h4> ${data.html_response}`;
                } else {
                     alertsBox.innerHTML = `<p style="color:red;">‚ùå √âchec du rapport de sant√©.</p>`;
                }
            } catch(e) {
                 alertsBox.innerHTML = `<p style="color:red;">‚ùå Erreur r√©seau.</p>`;
            } finally {
                btn.disabled = false;
            }
        }, 1500);
    });

    document.getElementById('btn-live-clip').addEventListener('click', function() {
        const btn = this;
        const channel = localStorage.getItem('activeChannel') || 'gotaga';
        const alertsBox = document.getElementById('live-alerts');
        
        alertsBox.innerHTML = '<p style="color:var(--color-ai-action);">üé¨ Cr√©ation d\'un clip instantan√© (derni√®res 30s)...</p>';
        btn.disabled = true;
        
        // Simuler Clip Creation API Call
        setTimeout(() => {
            const clipUrl = `https://clips.twitch.tv/${channel}-InstantClip-${Date.now()}`; 
            alertsBox.innerHTML = `<p style="color:var(--color-ai-action);">‚úÖ Clip cr√©√©: <a href="${clipUrl}" target="_blank" style="color:var(--color-primary-pink); font-weight:bold;">${channel} Clip Instantan√©</a></p>`;
            btn.disabled = false;
        }, 2000);
    });
    // FIN V9.2 - GESTIONNAIRES LIVE DASHBOARD
    
    // --- 4. GESTIONNAIRES D'√âV√âNEMENTS : ANALYSE ---

    const nicheResults = document.getElementById('niche-results');
    const repurposeResults = document.getElementById('repurpose-results');
    
    // Fonction d'appel IA g√©n√©rique 
    async function callAI(type, query, targetElement, button) {
        targetElement.innerHTML = `<p style="text-align:center; color:var(--color-primary-pink);">ü§ñ L'IA est en train d'analyser...</p>`;
        button.disabled = true;
        
        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, query })
            });
            
            const data = await res.json();

            if (!res.ok) {
                 targetElement.innerHTML = data.html_response || `<p style="color:red; padding:10px;">‚ùå Erreur serveur IA: ${data.error || `Statut HTTP ${res.status}.`}</p>`;
                 return;
            }
            
            if (data.success) {
                targetElement.innerHTML = data.html_response;
            } else {
                 throw new Error(data.error || "√âchec de l'analyse IA.");
            }

        } catch (e) {
            targetElement.innerHTML = `<p style="color:red; padding:10px;">‚ùå Erreur: ${e.message}</p>`;
        } finally {
            button.disabled = false;
        }
    }

    document.getElementById('form-target').addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = document.getElementById('input-target').value.trim();
        const resultBox = document.getElementById('scan-result');
        const btn = document.getElementById('btn-target');
        if (!query) return;

        resultBox.innerHTML = `<p style="text-align:center; color:var(--color-secondary-blue);">üöÄ Scan de la cible en cours pour <strong>${query}</strong>...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query })
            });
            
            const data = await res.json();

            if (!res.ok) { 
                throw new Error(data.error || `Erreur lors de l'appel au service de Scan (Statut: ${res.status}).`);
            }
            
            let htmlOutput = '';

            if (data.success) {
                if (data.type === 'game' && data.game_data) {
                    const g = data.game_data;
                    htmlOutput += `<h4 style="color:var(--color-secondary-blue); border-color:var(--color-secondary-blue);">Analyse de Jeu: ${g.name}</h4>`;
                    htmlOutput += `<div class="flex items-start gap-4 mb-4"> <img src="${g.box_art_url.replace('{width}', '80').replace('{height}', '80')}" alt="Box Art" style="width: 80px; height: 80px; border-radius: 4px; border: 1px solid var(--color-secondary-blue);"> <div class="text-sm"> <p><strong>Total Streamers LIVE:</strong> ${g.total_streamers.toLocaleString('fr-FR')}</p> <p><strong>Total Spectateurs LIVE:</strong> ${g.total_viewers.toLocaleString('fr-FR')}</p> <p><strong>Spectateurs/Streamer (V/S):</strong> <strong style="color:var(--color-ai-niche);">${g.avg_viewers_per_streamer}</strong></p> </div> </div>`;
                    htmlOutput += `<h5>Top Streams LIVE:</h5><ul class="list-none p-0">`;
                    htmlOutput += g.streams.slice(0, 5).map(stream => `
                        <li style="position:relative; padding-left:0; margin-bottom:5px;">
                            <span onclick="window.launchPlayer('${stream.user_login}')" style="cursor:pointer; color:var(--color-primary-pink); font-weight:bold;">${stream.user_name}</span> - ${stream.title.substring(0, 40)}... 
                            <span class="text-red-500 text-xs ml-2">${stream.viewer_count.toLocaleString('fr-FR')} vues</span>
                        </li>
                    `).join('');
                    htmlOutput += `</ul>`;
                    htmlOutput += `<button onclick="analyzeGameNiche('${g.name}')" class="btn-primary w-full mt-3" style="background:var(--color-ai-niche);">üëâ ANALYSER EN NICHE (IA)</button>`;

                } else if (data.type === 'user' && data.user_data) {
                    const u = data.user_data;
                    htmlOutput += `<h4 style="color:var(--color-primary-pink); border-color:var(--color-primary-pink);">Analyse de Streamer: ${u.display_name}</h4>`;
                    htmlOutput += `<div class="flex items-start gap-4 mb-4"> <img src="${u.profile_image_url}" alt="Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--color-primary-pink);"> <div class="text-sm"> <p><strong>Statut:</strong> <span class="${u.is_live ? 'text-red-500 font-bold' : 'text-gray-500'}">${u.is_live ? `üî¥ EN DIRECT (${u.stream_details.viewer_count.toLocaleString('fr-FR')} vues)` : 'Hors Ligne'}</span></p> <p>${u.description.substring(0, 100) || 'Pas de description.'}</p> </div> </div>`;
                    htmlOutput += `<button onclick="window.launchPlayer('${u.login}')" class="btn-primary w-full mb-2">‚ñ∂Ô∏è REGARDER</button>`;
                    htmlOutput += `<button onclick="document.getElementById('input-repurpose-channel').value='${u.login}'; openTab('tab-repurpose');" class="btn-primary w-full" style="background:var(--color-ai-repurpose);">‚úÇÔ∏è ANALYSER VOD (REPURPOSE)</button>`;
                    htmlOutput += `<button onclick="window.launchPlayer('${u.login}'); openTab('tab-live');" class="btn-secondary w-full mt-2" style="background:var(--color-ai-action);">üî¥ VOIR DASHBOARD LIVE</button>`;

                }
            } else {
                htmlOutput = `<p style="color:red; padding:10px;">‚ùå ${data.message}</p>`;
            }
            resultBox.innerHTML = htmlOutput;
        } catch (e) {
            resultBox.innerHTML = `<p style="color:red; padding:10px;">‚ùå Erreur r√©seau ou API: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    document.getElementById('form-niche-analysis').addEventListener('submit', function(e) {
        e.preventDefault();
        const game = document.getElementById('input-niche-game').value.trim();
        const btn = document.getElementById('btn-niche-analyse');
        if (game) {
            callAI('niche', game, nicheResults, btn);
        }
    });

    document.getElementById('form-repurpose').addEventListener('submit', async function(e) {
        e.preventDefault();
        const channel = document.getElementById('input-repurpose-channel').value.trim();
        if (!channel) return;
        
        const previewBox = document.getElementById('repurpose-vod-preview');
        const btn = document.getElementById('btn-repurpose-analyse');
        repurposeResults.innerHTML = `<p style="color:var(--color-ai-repurpose);">1/2 R√©cup√©ration VOD & 2/2 Analyse IA pour <strong>${channel}</strong>...</p>`;
        btn.disabled = true;
        previewBox.style.display = 'none';
        exportButton.style.display = 'none'; 
        currentVODId = null;
        selectedClipTime = null;
        stopLiveDashboard(); // Assurez-vous que le dashboard s'arr√™te si on passe en mode VOD Repurpose

        try {
            // 1. R√©cup√©rer les d√©tails de la VOD
            const vodRes = await fetch(`${API_BASE}/get_latest_vod?channel=${channel}`);
            const vodData = await vodRes.json();
            
            if (!vodRes.ok) {
                 throw new Error(vodData.error || `Erreur serveur VOD (HTTP ${vodRes.status}).`);
            }
            
            if (vodData.success && vodData.vod) {
                const vod = vodData.vod;
                currentVODId = vod.id;
                document.getElementById('vod-thumbnail').src = vod.thumbnail_url.replace('%{width}', '150').replace('%{height}', '84');
                document.getElementById('vod-title-display').textContent = vod.title.substring(0, 100);
                document.getElementById('vod-link').href = `https://www.twitch.tv/videos/${vod.id}`;
                previewBox.style.display = 'flex';
                repurposeResults.innerHTML = `<p style="color:var(--color-ai-repurpose);">‚úÖ VOD r√©cente trouv√©e (${vod.title.substring(0, 30)}...). 2/2 Lancement de l'analyse IA...</p>`;

                // 2. Lancer l'analyse IA
                const aiRes = await fetch(`${API_BASE}/critique_ia`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query: `${channel} | ${vod.title}`, type: 'repurpose' })
                });
                
                const aiData = await aiRes.json();

                if (!aiRes.ok) {
                    repurposeResults.innerHTML = aiData.html_response || `<p style="color:red; padding:10px;">‚ùå Erreur serveur IA: ${aiData.error || `Statut HTTP ${aiRes.status}.`}</p>`;
                    return;
                }
                
                if (aiData.success && aiData.html_response) {
                    let htmlOutput = aiData.html_response;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlOutput;
                    
                    // Transformation des timestamps en boutons cliquables 
                    const timestampRegex = /\*\*Point de Clip:\*\* (\d{2}:\d{2}:\d{2})|(\d{2}:\d{2})/g; 

                    const nodes = tempDiv.querySelectorAll('li, p');
                    nodes.forEach(node => {
                        if (node.innerHTML.match(timestampRegex)) {
                            node.innerHTML = node.innerHTML.replace(timestampRegex, (fullMatch, timeStringHMS, timeStringMS) => {
                                const timeString = timeStringHMS || timeStringMS;
                                const seconds = hmsToSeconds(timeString);
                                const launchScript = `window.seekVod('${currentVODId}', ${seconds}, '${timeString}')`;
                                return `<span style="color:var(--color-ai-repurpose); font-weight:bold;">${timeString}</span> <button onclick="${launchScript}" class="timestamp-link">‚ñ∂Ô∏è VOIR CLIP</button>`;
                            });
                        }
                    });
                    htmlOutput = tempDiv.innerHTML;
                    repurposeResults.innerHTML = htmlOutput;
                } else {
                    repurposeResults.innerHTML = `<p style="color:red;">‚ùå Erreur IA: ${aiData.error || "Probl√®me de l'analyse IA."}</p>`;
                }

            } else {
                previewBox.style.display = 'none';
                repurposeResults.innerHTML = `<p style="color:red;">‚ùå ${vodData.error || "Aucune VOD trouv√©e pour cette cha√Æne ou erreur API."}</p>`;
            }
        } catch(e) { 
            repurposeResults.innerHTML = `<p style="color:red">‚ùå Erreur r√©seau ou VOD: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // LOGIQUE DE L'EXPORT
    exportButton.addEventListener('click', async function() {
        if (!currentVODId || !selectedClipTime) {
            alert("Veuillez d'abord s√©lectionner un point de clip √† exporter.");
            return;
        }

        const channel = document.getElementById('input-repurpose-channel').value.trim();
        exportButton.disabled = true;
        exportButton.textContent = "‚öôÔ∏è EXPORT EN COURS...";
        
        try {
            const res = await fetch(`${API_BASE}/auto_export`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    vod_id: currentVODId, 
                    channel: channel,
                    timestamp: selectedClipTime
                })
            });

            const data = await res.json();
            
            if (!res.ok) { 
                alert(`‚ùå √âchec de l'export: ${data.error || `Statut HTTP ${res.status}`}`);
                return;
            }

            if (data.success) {
                alert(`‚úÖ Export lanc√© avec succ√®s ! Lien du clip: ${data.clip_url || 'Bient√¥t disponible.'}`);
                exportButton.textContent = `‚úÖ EXPORT LANC√â (${selectedClipTime})`;
            } else {
                alert(`‚ùå √âchec de l'export: ${data.error || 'Probl√®me inconnu.'}`);
            }

        } catch (e) {
            alert(`‚ùå Erreur r√©seau lors de l'export: ${e.message}`);
        } finally {
            exportButton.disabled = false;
            if (!exportButton.textContent.includes('LANC√â')) {
                 exportButton.textContent = `üì§ EXPORTER CLIP (${selectedClipTime})`;
            }
        }
    });
    
    // --- 5. LOGIQUE DES JEUX HYPE (CROISSANCE) ---

    async function fetchTrendingGames() {
        const listContainer = document.getElementById('trending-games-list');
        const btn = document.getElementById('btn-hype-games');
        listContainer.innerHTML = '<p style="text-align:center; color:var(--color-ai-niche);">Chargement des jeux en tendance...</p>';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/trending_games`);
            const data = await res.json();
            
            if (!res.ok) { 
                throw new Error(data.error || `Erreur serveur (HTTP ${res.status}).`);
            }
            
            if (!data.success || !data.games || data.games.length === 0) {
                 listContainer.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå ${data.error || "Aucun jeu en tendance trouv√© ou API vide."}</p>`;
                 return;
            }

            listContainer.innerHTML = ''; 
            data.games.forEach(game => {
                const item = document.createElement('div');
                item.className = 'game-item followed-stream-item'; 
                item.style.cssText = 'width: 180px; min-width: 180px; flex-shrink: 0;';
                item.onclick = () => analyzeGameNiche(game.name); 
                
                const thumbnailUrl = game.box_art_url
                    .replace('{width}', '180')
                    .replace('{height}', '240'); 

                item.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${game.name}" class="streamer-avatar" style="aspect-ratio: 180 / 240;">
                    <strong style="color:var(--color-ai-niche); font-size: 13px; margin-top: 5px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${game.name}</strong>
                    <div class="stream-meta" style="justify-content:center;">
                        <span style="color:var(--color-primary-pink); font-weight:bold;">Tendance</span>
                    </div>
                `;
                listContainer.appendChild(item);
            });

        } catch (error) {
            listContainer.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå Erreur de chargement des jeux hype: ${error.message}</p>`;
        } finally {
             btn.disabled = false;
        }
    }
    
    document.getElementById('btn-hype-games').addEventListener('click', fetchTrendingGames);

    document.getElementById('btn-trend-detector').addEventListener('click', function() {
        const btn = document.getElementById('btn-trend-detector');
        callAI('trend', 'Analyse des tendances V/S Twitch', aiTrendCritiqueContainer, btn);
    });
    
    // --- 6. GESTION DU BOOST ---
    document.getElementById('form-boost').addEventListener('submit', async function(e) {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim() || localStorage.getItem('activeChannel') || 'Cha√Æne Inconnue';
        const boostMessage = document.getElementById('boost-results');
        const btn = document.getElementById('btn-boost');
        btn.disabled = true;
        boostMessage.innerHTML = '<p style="color:yellow;">‚ö° Traitement du Boost...</p>';
        
        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel })
            });
            
            const data = await res.json();
            
             // V√©rification robuste du statut HTTP (pour le 429 de cooldown ou autre erreur)
            if (!res.ok) {
                 boostMessage.innerHTML = data.html_response || `<p style="color:red;">‚ùå Erreur Boost: ${data.error || `Statut HTTP ${res.status}.`}</p>`;
                 return;
            }
            
            boostMessage.innerHTML = data.html_response || `<p style="color:red;">‚ùå Erreur Boost: ${data.error || 'Statut inconnu'}</p>`;
            
        } catch (e) {
            boostMessage.innerHTML = `<p style="color:red;">‚ùå Erreur r√©seau lors de l'appel Boost: ${e.message}</p>`;
        } finally {
             btn.disabled = false;
        }
    });


    // --- 7. Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', function() {
        // Chargement et application de l'ordre des onglets
        loadTabOrder(); 

        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        window.launchPlayer(lastChannel); 

        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        
        checkAuth();
    });
</script>
</body>
</html>
