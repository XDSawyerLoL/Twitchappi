<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamHub Pro - Co-pilote pour Streamer</title>
    
    <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0d1117; color: #f0f6fc; margin: 0; }
        #app-container { display: flex; min-height: 100vh; }
        #sidebar { width: 250px; background-color: #161b22; padding: 20px 0; border-right: 1px solid #30363d; }
        #main-content { flex-grow: 1; padding: 40px; }
        .nav-button { display: block; width: 100%; padding: 10px 20px; text-align: left; background: none; border: none; color: #c9d1d9; font-size: 16px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .nav-button:hover, .nav-button.active { background-color: #007bff; color: white; }
        .section-content { display: none; }
        .dashboard-section { padding: 20px; background-color: #1a1a1a; border-radius: 10px; margin-top: 20px; }
        .grid-layout { display: grid; grid-template-areas: "gauge verdict" "strengths ideas"; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background-color: #2c2c2c; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); position: relative; }
        h3 { border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 0; color: #ff0099; }
        .clean-list { list-style: none; padding: 0; }
        .clean-list li { padding: 5px 0; border-bottom: 1px dotted #3a3a3a; }
        .gauge-center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; font-weight: bold; }
        #auth-status { padding: 10px 20px; text-align: center; color: #ff0099; border-bottom: 1px solid #30363d; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="sidebar">
            <div id="auth-status">Chargement...</div>
            <button class="nav-button active" onclick="showSection('accueil')">üè† Accueil & Live</button>
            <button class="nav-button" onclick="showSection('analyse-ia')">ü§ñ Analyse de Niche</button>
            <button class="nav-button" onclick="showSection('raid-boost')">üöÄ Raid Finder & Boost</button>
            <button class="nav-button" onclick="showSection('vod-repurpose')">‚úÇÔ∏è Repurposing VOD</button>
        </div>

        <div id="main-content">
            
            <div id="accueil" class="section-content active">
                <h2>Bienvenue sur StreamHub Pro</h2>
                <div id="profile-display" class="dashboard-section">
                    <p>Connectez-vous √† Twitch pour voir vos m√©triques et votre player live.</p>
                </div>

                <div id="followed-streams-list" class="dashboard-section">
                    <h3>Streams Suivis Actuellement en LIVE</h3>
                    </div>
            </div>

            <div id="analyse-ia" class="section-content">
                <h2>ü§ñ Analyse de Niche & Strat√©gie</h2>
                <div class="dashboard-section">
                    <p>Recherchez un Jeu ou une Cat√©gorie pour obtenir une critique IA bas√©e sur le march√© Twitch.</p>
                    <input type="text" id="ia-query" placeholder="Ex: Elden Ring, Just Chatting, etc.">
                    <button onclick="runAnalysis('niche', document.getElementById('ia-query').value)">Analyser la Niche</button>
                    <button onclick="runAnalysis('trend', '')">Analyser les Tendances (Global)</button>
                </div>
                
                <div id="ai-results-display" class="dashboard-section">
                    <h2 id="ai-title">R√©sultats de l'Analyse IA</h2>
                    <p>Les r√©sultats structur√©s par l'IA s'afficheront ici.</p>
                </div>
            </div>

            <div id="raid-boost" class="section-content">
                <h2>üöÄ Raid Finder & Boost</h2>
                <div class="dashboard-section">
                    <p>Le Boost recherche automatiquement des partenaires de Raid pour vous !</p>
                    <button onclick="runStreamBoost()">ACTIVER LE BOOST (Raid intelligent)</button>
                    <div id="boost-status" style="margin-top: 15px;"></div>
                </div>

                <div class="dashboard-section">
                    <h3>Recherche Manuelle de Partenaires Raid (0-100 Viewers)</h3>
                    <input type="text" id="raid-category" placeholder="Ex: Valorant, Code, etc.">
                    <button onclick="runRaidFinder(document.getElementById('raid-category').value)">Chercher des Raids</button>
                    <div id="raid-candidates-list" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="vod-repurpose" class="section-content">
                <h2>‚úÇÔ∏è Repurposing VOD & Clips Viraux</h2>
                <div class="dashboard-section">
                    <p>Entrez le titre de votre derni√®re VOD pour obtenir des suggestions de clips √† cr√©er.</p>
                    <input type="text" id="vod-query" placeholder="Titre de la VOD (Ex: J'ai fini Dark Souls sans les mains!)">
                    <button onclick="runAnalysis('repurpose', document.getElementById('vod-query').value)">Analyser la VOD</button>
                    <div id="repurpose-results-display" style="margin-top: 15px;"></div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // La variable globale pour l'utilisateur connect√©
        let currentUser = null; 

        // =========================================================
        // A. FONCTIONS DE NAVIGATION (UX/UI)
        // =========================================================

        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-button[onclick*="${sectionId}"]`).classList.add('active');
            
            // Recharger les donn√©es importantes √† chaque changement de section
            if (sectionId === 'accueil') {
                loadProfileStats();
                loadFollowedStreams();
            }
        }

        // =========================================================
        // B. AFFICHAGE DES R√âSULTATS IA (JSON -> Graphiques)
        // =========================================================

        function displayNicheAnalysis(data) {
            const display = document.getElementById('ai-results-display');
            display.innerHTML = `
                <h2 class="title">üéØ Analyse de Niche: ${document.getElementById('ia-query').value}</h2>
                
                <div class="grid-layout">
                    <div class="card" style="grid-area: gauge; height: 200px; position: relative;">
                        <h3>Score d'Opportunit√©</h3>
                        <canvas id="nicheScoreGauge" style="max-height: 100%;"></canvas>
                        <div id="gauge-score-text" class="gauge-center-text">${data.score_niche}</div>
                    </div>

                    <div class="card" style="grid-area: verdict;">
                        <h3>Verdict de l'IA</h3>
                        <p><strong>${data.verdict}</strong></p>
                        <p><strong>Persona Viewer:</strong> ${data.viewer_persona}</p>
                    </div>
                    
                    <div class="card" style="grid-area: strengths;">
                        <h3>Points Forts (Opportunit√©s)</h3>
                        <ul class="clean-list">
                            ${data.points_forts.map(p => `<li>‚úÖ ${p}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="card" style="grid-area: ideas;">
                        <h3>Id√©es de Contenu Uniques</h3>
                        <ul class="clean-list">
                            ${data.content_ideas.map(i => `<li>üí° ${i}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            // --- G√©n√©ration du Graphique (Jauge) ---
            const ctx = document.getElementById('nicheScoreGauge').getContext('2d');
            let score = data.score_niche;
            let color;
            if (score < 30) { color = '#ff6384'; } // Rouge
            else if (score < 70) { color = '#ffcd56'; } // Jaune
            else { color = '#4bc0c0'; } // Vert
            
            // Mettre √† jour la couleur du texte du score
            document.getElementById('gauge-score-text').style.color = color;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Opportunit√©', 'Satur√©'],
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [color, '#1a1a1a'],
                        borderWidth: 0
                    }]
                },
                options: {
                    rotation: 270, 
                    circumference: 180, 
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                }
            });
        }
        
        // ... (Ajoutez ici les fonctions displayRepurposeAnalysis et displayTrendAnalysis) ...

        // =========================================================
        // C. LOGIQUE G√âN√âRALE (Connexion & Backend Calls)
        // =========================================================
        
        // Fonction principale pour appeler l'analyse IA
        async function runAnalysis(type, query) {
            const display = type === 'niche' || type === 'trend' ? document.getElementById('ai-results-display') : document.getElementById('repurpose-results-display');
            
            // Point C: Skeleton Loader (impl√©mentation simple)
            display.innerHTML = '<p>Analyse IA en cours, veuillez patienter... ‚è≥</p>'; 

            try {
                const response = await fetch('/critique_ia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, query })
                });
                
                const result = await response.json();

                if (result.success) {
                    if (type === 'niche') {
                        displayNicheAnalysis(result.data);
                    } else if (type === 'trend') {
                         // TODO: Impl√©menter displayTrendAnalysis(result.data);
                        display.innerHTML = '<h3>R√©sultat Tendances (JSON re√ßu, affichage graphique √† impl√©menter)</h3>' + JSON.stringify(result.data, null, 2);
                    } else if (type === 'repurpose') {
                         // TODO: Impl√©menter displayRepurposeAnalysis(result.data);
                        display.innerHTML = '<h3>R√©sultat Repurposing (JSON re√ßu, affichage √† impl√©menter)</h3>' + JSON.stringify(result.data, null, 2);
                    }
                } else {
                    display.innerHTML = `<p style="color:red;">Erreur IA: ${result.error || 'Erreur inconnue'}</p>`;
                }
            } catch (e) {
                display.innerHTML = `<p style="color:red;">Erreur r√©seau lors de l'appel IA: ${e.message}</p>`;
            }
        }
        
        // Fonction pour le Raid Finder
        async function runRaidFinder(category) {
            const list = document.getElementById('raid-candidates-list');
            list.innerHTML = 'Recherche en cours...';

            try {
                const response = await fetch('/raid_finder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category })
                });
                const result = await response.json();
                
                if (result.success && result.candidates.length > 0) {
                    let html = `<h4>Top ${result.candidates.length} Raids pour ${result.game_name} (0-100 Viewers)</h4><ul>`;
                    result.candidates.forEach(c => {
                        html += `<li><strong>${c.user_name}</strong> (${c.viewer_count} viewers) - "${c.title}" 
                                 <button onclick="copyToClipboard('/raid ${c.user_login}')">Copier Commande</button></li>`;
                    });
                    html += `</ul>`;
                    list.innerHTML = html;
                } else {
                    list.innerHTML = `<p>Aucun candidat trouv√© pour la cat√©gorie ${category}.</p>`;
                }
            } catch (e) {
                list.innerHTML = `<p style="color:red;">Erreur Raid Finder: ${e.message}</p>`;
            }
        }
        
        // Fonction pour le Boost (appelle le Raid Finder en arri√®re-plan)
        async function runStreamBoost() {
            const status = document.getElementById('boost-status');
            status.innerHTML = '<p>Activation du Boost et recherche de Raid en cours...</p>';
            
            try {
                const response = await fetch('/stream_boost', { method: 'POST' });
                const result = await response.json();
                
                // Le backend renvoie maintenant l'√©tat/suggestion en HTML
                status.innerHTML = result.html_response;
                
                // Si le boost a trouv√© un candidat, on peut l'afficher plus joliment (utiliser result.raidCandidate)
                if(result.raidCandidate) {
                    const c = result.raidCandidate;
                    status.innerHTML += `<div class="card" style="margin-top: 10px;">
                        <h4>Partenaire sugg√©r√© : ${c.user_name}</h4>
                        <p><strong>Viewers:</strong> ${c.viewer_count} | <strong>Titre:</strong> ${c.title}</p>
                        <button onclick="copyToClipboard('/raid ${c.user_login}')" style="background-color: #ff0099;">Copier Commande de Raid</button>
                    </div>`;
                }
                
            } catch (e) {
                status.innerHTML = `<p style="color:red;">Erreur Boost: ${e.message}</p>`;
            }
        }
        
        // Fonction pour charger les stats de l'utilisateur
        async function loadProfileStats() {
            const display = document.getElementById('profile-display');
            display.innerHTML = '<p>Chargement des statistiques...</p>';

            try {
                const response = await fetch('/my_profile_stats');
                const result = await response.json();

                if (result.success) {
                    const stats = result.stats;
                    display.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <img src="${stats.avatar}" alt="${stats.display_name}" style="width: 80px; height: 80px; border-radius: 50%;">
                            <div>
                                <h3>${stats.display_name} (${stats.broadcaster_type || 'Standard'})</h3>
                                <p>${stats.description || 'Pas de description.'}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 30px;">
                            <p>üë• **Followers:** ${stats.follower_count}</p>
                            <p>üëÅÔ∏è **Vues Totales:** ${stats.view_count}</p>
                            <p>‚≠ê **Subs Estim√©s:** ${stats.sub_count}</p>
                        </div>
                    `;
                } else {
                    // Si non connect√©, afficher le bouton de connexion
                    display.innerHTML = `<p style="color:red;">${result.error || 'Non connect√©.'}</p>
                                         <a href="/twitch_auth_start" style="background-color: #9146FF; color: white; padding: 10px; text-decoration: none; border-radius: 5px;">Se connecter √† Twitch</a>`;
                }
            } catch (e) {
                display.innerHTML = `<p style="color:red;">Erreur de connexion: ${e.message}</p>`;
            }
        }
        
        // Fonction pour v√©rifier le statut de connexion
        async function checkAuthStatus() {
            const statusElement = document.getElementById('auth-status');
            const response = await fetch('/twitch_user_status');
            const result = await response.json();

            if (result.is_connected) {
                currentUser = result;
                statusElement.innerHTML = `<img src="${result.profile_image_url}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 5px;"> Connect√©: ${result.display_name}`;
                loadProfileStats(); // Charge les stats une fois connect√©
            } else {
                statusElement.innerHTML = `<span style="color: red;">D√©connect√©</span>`;
            }
        }
        
        // Fonction utilitaire pour copier
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Commande copi√©e : ' + text);
            });
        }
        
        // =========================================================
        // D. INITIALISATION
        // =========================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            showSection('accueil'); // Afficher la premi√®re section par d√©faut
        });
        
        // Placeholder pour l'impl√©mentation compl√®te
        async function loadFollowedStreams() {
            const list = document.getElementById('followed-streams-list');
            list.innerHTML = 'Chargement des streams suivis...';
            try {
                 const response = await fetch('/followed_streams');
                 const result = await response.json();
                 if(result.success && result.streams.length > 0) {
                     let html = '<ul>';
                     result.streams.forEach(s => {
                         html += `<li><strong>${s.user_name}</strong> | ${s.game_name} (${s.viewer_count} viewers)</li>`;
                     });
                     html += '</ul>';
                     list.innerHTML = html;
                 } else {
                     list.innerHTML = '<p>Aucun stream suivi en direct actuellement, ou non connect√©.</p>';
                 }
            } catch (e) { list.innerHTML = `<p style="color:red;">Erreur: ${e.message}</p>`; }
        }

    </script>
</body>
</html>
