<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Streamer Hub V43 - Real Engine">
    <title>Streamer Hub V43 - REAL ENGINE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --bg-dark: #09090b;
            --bg-panel: #121214;
            --bg-card: #18181b;
            --primary: #ff0099;
            --secondary: #22c7ef;
            --accent-gold: #ffd700;
            --accent-green: #10b981;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --border: #27272a;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .text-glow-blue { text-shadow: 0 0 10px rgba(34, 199, 239, 0.5); }
        .text-glow-green { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }

        /* NAVIGATION */
        .nav-container { display: flex; gap: 2px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .nav-btn { flex: 1; padding: 16px; background: var(--bg-panel); color: var(--text-muted); font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; border-top: 2px solid transparent; }
        .nav-btn:hover { background: #1f1f22; color: white; }
        .nav-btn.active { background: var(--bg-dark); color: white; border-top-color: var(--secondary); }
        .nav-btn.active.pink-border { border-top-color: var(--primary); }
        .nav-btn.active.gold-border { border-top-color: var(--accent-gold); }

        /* PLAYER & CHAT */
        .player-wrapper { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-bottom: 25px; }
        .split-view { display: flex; height: 550px; }
        .video-area { flex: 1; background: black; position: relative; }
        .chat-area { width: 340px; background: #0e0e10; border-left: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
        .hub-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; scrollbar-width: thin; scrollbar-color: #333 #111; }
        .hub-msg { background: rgba(255,255,255,0.03); padding: 8px 10px; border-radius: 4px; font-size: 12px; border-left: 2px solid; word-wrap: break-word; }

        /* SCANNER UI */
        .scanner-layout { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .profile-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .profile-banner { height: 80px; background: linear-gradient(45deg, #111, #222); position: relative; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--bg-panel); position: absolute; bottom: -40px; left: 20px; background: #333; object-fit: cover; }
        .profile-info { padding: 50px 20px 20px 20px; }
        .audit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .audit-box { background: var(--bg-card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
        
        /* STREAM LIST */
        .stream-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .stream-card-hz { display: flex; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; height: 80px; }
        .stream-card-hz:hover { border-color: var(--secondary); transform: translateX(5px); }
        .stream-card-img { width: 120px; height: 100%; object-fit: cover; }
        .stream-card-info { padding: 8px 12px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }

        /* UTILS */
        .tab-content { display: none; padding: 10px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 1024px) { .split-view { flex-direction: column; height: auto; } .video-area { height: 56.25vw; } .chat-area { width: 100%; height: 400px; } .scanner-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="max-w-[1500px] mx-auto p-4">
    
    <header class="flex justify-between items-end mb-6 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-3xl font-orbitron text-white"><span class="text-[#22c7ef]">STREAMER</span> HUB <span class="text-xs bg-red-600 px-2 py-0.5 rounded ml-2">V43 REAL</span></h1>
            <p class="text-xs text-gray-500 mt-1 uppercase tracking-widest">Connected to Node.js & Firebase</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="connection-status-dot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse" title="Socket Disconnected"></div>
            <button id="btn-auth" onclick="startTwitchAuth()" class="bg-[#18181b] hover:bg-[#202024] text-white px-4 py-2 rounded text-xs font-bold border border-gray-700 transition flex items-center gap-2">
                <i class="fab fa-twitch text-[#a970ff]"></i> <span>CONNEXION</span>
            </button>
        </div>
    </header>

    <nav class="nav-container">
        <button class="nav-btn active" onclick="openTab('tab-live', this)"><i class="fas fa-play mr-2"></i> LIVE CENTER</button>
        <button class="nav-btn pink-border" onclick="openTab('tab-stats', this)"><i class="fas fa-chart-pie mr-2"></i> STATS TRACKER</button>
        <button class="nav-btn gold-border" onclick="openTab('tab-tools', this)"><i class="fas fa-toolbox mr-2"></i> DASHBOARD TOOLS</button>
    </nav>

    <div class="player-wrapper">
        <div class="player-header flex justify-between items-center p-3 bg-black border-b border-[#27272a]">
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold text-[#22c7ef] font-orbitron">ACTIVE FEED</span>
                <span id="player-status" class="text-xs text-gray-400 border-l border-gray-700 pl-3">En attente...</span>
            </div>
            <div class="flex items-center gap-3">
                <form onsubmit="event.preventDefault(); launchPlayer(document.getElementById('quick-input').value)" class="flex">
                    <input id="quick-input" type="text" placeholder="Chaine..." class="bg-[#18181b] border border-[#333] text-white text-xs px-2 py-1 rounded w-32 focus:border-[#22c7ef] outline-none">
                    <button type="submit" class="bg-gray-800 px-3 py-1 rounded text-white text-xs hover:bg-gray-700 ml-1"><i class="fas fa-arrow-right"></i></button>
                </form>
                <div class="bg-[#18181b] p-0.5 rounded flex gap-1">
                    <button id="btn-chat-twitch" class="px-3 py-1 text-[10px] font-bold rounded bg-[#6441a5] text-white" onclick="toggleChat('twitch')"><i class="fab fa-twitch"></i></button>
                    <button id="btn-chat-hub" class="px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white" onclick="toggleChat('hub')"><i class="fas fa-satellite-dish"></i></button>
                </div>
            </div>
        </div>
        
        <div class="split-view">
            <div class="video-area" id="twitch-video-embed"></div>
            
            <div class="chat-area">
                <div id="layer-twitch" class="absolute inset-0 z-10 bg-black">
                    <div id="twitch-chat-embed" class="w-full h-full"></div>
                </div>
                
                <div id="layer-hub" class="absolute inset-0 z-0 bg-[#0e0e10] flex flex-col">
                    <div class="p-2 border-b border-gray-800 text-[10px] flex justify-between items-center">
                        <span class="text-[#22c7ef] font-bold uppercase tracking-widest">Hub Secure</span>
                        <span id="socket-status-text" class="text-red-500 font-bold">OFFLINE</span>
                    </div>
                    <div id="hub-messages" class="hub-messages">
                        </div>
                    <form class="p-3 bg-[#121212] border-t border-[#222] flex gap-2" onsubmit="sendSocketMessage(event)">
                        <input id="socket-input" type="text" placeholder="Message..." class="flex-1 bg-[#18181b] border border-[#333] text-white text-xs px-3 py-2 rounded focus:border-[#22c7ef] outline-none">
                        <button type="submit" class="text-[#22c7ef] px-2 hover:text-white"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-live" class="tab-content active">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white"><i class="fas fa-heart text-pink-500 mr-2"></i> Vos Cha√Ænes Suivies</h2>
            <button onclick="loadFollowedStreams()" class="text-xs text-gray-400 hover:text-white"><i class="fas fa-sync-alt"></i> Actualiser</button>
        </div>
        <div id="followed-list" class="stream-list-grid">
            <div class="col-span-full text-center py-10 text-gray-600">Connectez-vous pour charger vos favoris.</div>
        </div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-[#18181b] p-4 rounded border-l-4 border-l-pink-500 border-gray-800">
                <div class="text-gray-500 text-[10px] uppercase font-bold">Total Viewers</div>
                <div id="stat-viewers" class="text-2xl font-orbitron text-white mt-1">--</div>
            </div>
            <div class="bg-[#18181b] p-4 rounded border-l-4 border-l-blue-400 border-gray-800">
                <div class="text-gray-500 text-[10px] uppercase font-bold">Cha√Ænes Actives</div>
                <div id="stat-channels" class="text-2xl font-orbitron text-white mt-1">--</div>
            </div>
            <div class="bg-[#18181b] p-4 rounded border-l-4 border-l-yellow-400 border-gray-800">
                <div class="text-gray-500 text-[10px] uppercase font-bold">Top Jeu</div>
                <div id="stat-game" class="text-xl font-orbitron text-white mt-1 truncate">--</div>
            </div>
            <div class="bg-[#18181b] p-4 rounded border-l-4 border-l-green-500 border-gray-800">
                <div class="text-gray-500 text-[10px] uppercase font-bold">Status Server</div>
                <div id="stat-uptime" class="text-lg font-orbitron text-white mt-1">OK</div>
            </div>
        </div>
        <div class="bg-[#121214] p-5 rounded border border-gray-800 h-[350px]">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Global Trend</h3>
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div id="tab-tools" class="tab-content">
        <div class="flex gap-4 border-b border-gray-800 mb-6 pb-2 overflow-x-auto">
            <button class="text-xs font-bold text-white border-b-2 border-[#22c7ef] pb-2">SCANNER & AUDIT</button>
            <button class="text-xs font-bold text-gray-500 hover:text-white pb-2">BOOST</button>
            <button class="text-xs font-bold text-gray-500 hover:text-white pb-2">RAID FINDER</button>
        </div>

        <div class="flex justify-center mb-8">
            <form id="scan-form" class="relative w-full max-w-lg" onsubmit="handleScan(event)">
                <input id="scan-target" type="text" placeholder="Streamer (ex: Kamet0)..." class="w-full bg-[#0a0a0a] border border-[#22c7ef] text-white p-4 rounded-full pl-6 pr-32 outline-none focus:shadow-[0_0_15px_rgba(34,199,239,0.3)]">
                <button type="submit" class="absolute right-1 top-1 bottom-1 bg-[#22c7ef] text-black font-bold rounded-full px-6 hover:bg-white transition">SCAN</button>
            </form>
        </div>

        <div id="scan-results" class="hidden scanner-layout">
            <div class="profile-card">
                <div class="profile-banner"></div>
                <img id="res-avatar" src="" class="profile-avatar">
                <div class="profile-info">
                    <h2 id="res-name" class="text-xl font-bold text-white mt-2">--</h2>
                    <div class="mt-6 space-y-3">
                        <div class="flex justify-between text-sm border-b border-gray-800 pb-2">
                            <span class="text-gray-500">Viewers</span><span id="res-viewers" class="font-bold text-[#22c7ef]">--</span>
                        </div>
                        <div class="flex justify-between text-sm border-b border-gray-800 pb-2">
                            <span class="text-gray-500">Jeu</span><span id="res-game" class="font-bold text-pink-500">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#18181b] border border-gray-800 p-5 rounded-lg relative">
                <h3 class="text-[#22c7ef] font-orbitron text-lg mb-4"><i class="fas fa-microchip mr-2"></i> ANALYSE IA</h3>
                <div id="ai-content" class="text-sm text-gray-300 leading-relaxed border-l-2 border-[#22c7ef] pl-4">
                    <i class="fas fa-circle-notch fa-spin"></i> Analyse en cours...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_BASE = window.location.origin; // Dynamique selon ton serveur Node
    const PARENT_DOMAINS = ["justplayer.fr", "www.justplayer.fr", "localhost", "127.0.0.1", window.location.hostname];
    
    // --- SOCKET.IO (REEL) ---
    // On suppose que socket.io.js est servi par ton Node server
    let socket;
    try {
        socket = io(); // Connexion automatique √† l'origine
    } catch(e) {
        console.error("Socket.io non trouv√©. V√©rifiez que le serveur Node tourne.", e);
    }

    if(socket) {
        // Events de connexion
        socket.on('connect', () => {
            document.getElementById('socket-status-text').innerText = "ONLINE";
            document.getElementById('socket-status-text').className = "text-[#10b981] font-bold text-glow-green";
            const dot = document.getElementById('connection-status-dot');
            dot.classList.remove('bg-red-500'); dot.classList.add('bg-[#10b981]');
            
            addHubMessage("System", "Connexion √©tablie avec le serveur.", false);
        });

        socket.on('disconnect', () => {
            document.getElementById('socket-status-text').innerText = "OFFLINE";
            document.getElementById('socket-status-text').className = "text-red-500 font-bold";
            const dot = document.getElementById('connection-status-dot');
            dot.classList.remove('bg-[#10b981]'); dot.classList.add('bg-red-500');
        });

        // Event Chat entrant (nom de l'event √† adapter selon ton app.js, ex: 'chat message' ou 'message')
        socket.on('chat message', (msg) => {
            // msg peut √™tre un objet {user: '...', text: '...'} ou juste une string
            const user = msg.user || 'Anon';
            const text = msg.text || msg;
            addHubMessage(user, text, false);
        });
    }

    function sendSocketMessage(e) {
        e.preventDefault();
        const input = document.getElementById('socket-input');
        const text = input.value;
        if(!text || !socket) return;
        
        // Optimistic UI update
        addHubMessage('Moi', text, true);
        
        // Envoi r√©el au serveur
        socket.emit('chat message', text); 
        input.value = '';
    }

    function addHubMessage(user, text, isMe) {
        const box = document.getElementById('hub-messages');
        const div = document.createElement('div');
        div.className = `hub-msg border-l-2 ${isMe ? 'border-[#22c7ef]' : 'border-pink-500'}`;
        div.innerHTML = `<strong class="${isMe ? 'text-[#22c7ef]' : 'text-pink-500'}">${user}:</strong> <span class="text-gray-300">${text}</span>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- NAVIGATION & TABS ---
    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        
        if(tabId === 'tab-stats') loadStats();
        if(tabId === 'tab-live') loadFollowedStreams();
    }

    // --- PLAYER TWITCH & CHAT TOGGLE ---
    function launchPlayer(channel) {
        if(!channel) return;
        document.getElementById('twitch-video-embed').innerHTML = '';
        document.getElementById('player-status').innerText = "LIVE : " + channel;
        
        // Player Embed
        new Twitch.Embed("twitch-video-embed", {
            width: "100%", height: "100%", channel: channel, layout: "video", parent: PARENT_DOMAINS
        });

        // Chat Embed
        const parentParams = PARENT_DOMAINS.map(p => `parent=${p}`).join('&');
        document.getElementById('twitch-chat-embed').innerHTML = 
            `<iframe src="https://www.twitch.tv/embed/${channel}/chat?${parentParams}&darkpopout" width="100%" height="100%" frameborder="0"></iframe>`;
    }

    function toggleChat(mode) {
        const layerTwitch = document.getElementById('layer-twitch');
        const layerHub = document.getElementById('layer-hub');
        const btnTwitch = document.getElementById('btn-chat-twitch');
        const btnHub = document.getElementById('btn-chat-hub');

        if(mode === 'hub') {
            layerTwitch.classList.add('hidden'); layerHub.classList.remove('hidden');
            btnHub.className = "px-3 py-1 text-[10px] font-bold rounded bg-[#22c7ef] text-black";
            btnTwitch.className = "px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white";
        } else {
            layerHub.classList.add('hidden'); layerTwitch.classList.remove('hidden');
            btnTwitch.className = "px-3 py-1 text-[10px] font-bold rounded bg-[#6441a5] text-white";
            btnHub.className = "px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white";
        }
    }

    // --- AUTHENTIFICATION ---
    async function startTwitchAuth() {
        // Redirection vers ta route backend Node qui g√®re Passport/OAuth
        window.open('/twitch_auth_start', 'twitch_login_window', 'width=500,height=700');
    }
    
    // Fonction appel√©e au chargement pour v√©rifier si l'user est d√©j√† logg√© (via session cookie)
    async function checkAuth() {
        try {
            const res = await fetch('/twitch_user_status');
            const data = await res.json();
            if(data.is_connected) {
                const btn = document.getElementById('btn-auth');
                btn.innerHTML = `<img src="${data.profile_image_url}" class="w-5 h-5 rounded-full mr-2"> ${data.display_name}`;
                btn.classList.replace('bg-[#18181b]', 'bg-green-700');
                btn.onclick = () => { fetch('/twitch_logout', {method:'POST'}).then(()=>window.location.reload()); };
                loadFollowedStreams();
            }
        } catch(e) { console.log("Non connect√©"); }
    }

    // --- API CALLS (REAL DATA) ---

    // 1. Followed Streams
    async function loadFollowedStreams() {
        const list = document.getElementById('followed-list');
        list.innerHTML = '<div class="col-span-full text-center"><i class="fas fa-spinner fa-spin text-[#22c7ef] text-2xl"></i></div>';
        try {
            const res = await fetch('/followed_streams');
            const data = await res.json();
            if(data.success && data.streams.length > 0) {
                list.innerHTML = '';
                data.streams.forEach(s => {
                    const thumb = s.thumbnail_url.replace('{width}', '320').replace('{height}', '180');
                    list.innerHTML += `
                    <div class="stream-card-hz" onclick="launchPlayer('${s.user_login}')">
                        <img src="${thumb}" class="stream-card-img">
                        <div class="stream-card-info flex-1 min-w-0">
                            <div class="text-xs font-bold text-white truncate">${s.user_name}</div>
                            <div class="text-[10px] text-[#22c7ef] truncate">${s.game_name}</div>
                            <div class="text-[10px] text-gray-500 truncate text-right">${s.viewer_count} üëÅÔ∏è</div>
                        </div>
                    </div>`;
                });
            } else {
                list.innerHTML = '<div class="col-span-full text-center text-gray-500">Aucun live en cours ou non connect√©.</div>';
            }
        } catch(e) { list.innerHTML = '<div class="col-span-full text-center text-red-500">Erreur de chargement.</div>'; }
    }

    // 2. Stats
    let chartInstance = null;
    async function loadStats() {
        try {
            const res = await fetch('/api/stats/global');
            const data = await res.json();
            if(data.success) {
                document.getElementById('stat-viewers').innerText = Number(data.total_viewers).toLocaleString();
                document.getElementById('stat-channels').innerText = Number(data.total_channels).toLocaleString();
                document.getElementById('stat-game').innerText = data.top_game_name;

                // Chart.js Update
                const ctx = document.getElementById('mainChart');
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.live.labels, // Vient du backend
                        datasets: [{
                            label: 'Viewers',
                            data: data.history.live.values,
                            borderColor: '#22c7ef',
                            backgroundColor: 'rgba(34, 199, 239, 0.1)',
                            fill: true, tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#333'}}} }
                });
            }
        } catch(e) {}
    }

    // 3. Scanner & IA
    async function handleScan(e) {
        e.preventDefault();
        const query = document.getElementById('scan-target').value;
        const resBox = document.getElementById('scan-results');
        const aiBox = document.getElementById('ai-content');
        
        resBox.classList.remove('hidden');
        document.getElementById('res-name').innerText = "Recherche...";
        aiBox.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Audit en cours...';

        try {
            // Step 1: Data Twitch
            const resTwitch = await fetch('/scan_target', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query})
            });
            const dataTwitch = await resTwitch.json();
            
            if(dataTwitch.success) {
                const u = dataTwitch.user_data;
                document.getElementById('res-name').innerText = u.display_name;
                document.getElementById('res-viewers').innerText = u.viewer_count || "OFF";
                document.getElementById('res-game').innerText = u.game_name || "N/A";
                document.getElementById('res-avatar').src = u.profile_image_url || ""; // Assure-toi que le backend renvoie l'image
                
                // Step 2: IA Analysis
                const resIA = await fetch('/critique_ia', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: 'niche', query: u.display_name})
                });
                const dataIA = await resIA.json();
                aiBox.innerHTML = dataIA.html_response;
            } else {
                aiBox.innerText = "Streamer introuvable.";
            }
        } catch(e) { aiBox.innerText = "Erreur technique."; }
    }

    // Init
    window.onload = () => {
        checkAuth();
        // Optionnel : Lancer une cha√Æne par d√©faut si pr√©sente dans l'URL ou config
        launchPlayer('twitch'); 
    };

</script>
</body>
</html>
