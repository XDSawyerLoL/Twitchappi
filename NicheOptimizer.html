<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V9.4 - Fix Auth</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert pour la niche */
            --color-ai-repurpose: #9933ff; /* Violet pour le repurposing */
            --color-ai-growth: #ffcc00; /* Jaune pour la croissance/alertes */
            --color-ai-action: #e34a64; /* Rouge/Corail pour l'action/export */
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { all: initial; display: block; max-width: 1200px; margin: 20px auto; padding: 10px; font-family: 'Inter', sans-serif; color: #fff; }
        
        /* EFFET N√âON SUR LES TITRES */
        h1 { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 28px; 
            color: var(--color-primary-pink); 
            margin-bottom: 5px; 
            text-align: center; 
            text-shadow: 0 0 5px rgba(255, 0, 153, 0.5), 0 0 10px rgba(255, 0, 153, 0.2);
        }
        h2 {
            font-family: 'Orbitron', sans-serif; 
            font-size: 20px; 
            color: var(--color-secondary-blue); 
            margin: 0 0 10px; 
            display: flex; 
            align-items: center; 
            text-shadow: 0 0 3px rgba(34, 199, 239, 0.5);
        }
        .h1-blue-accent { color: var(--color-secondary-blue); }
        .subtitle-center { color: var(--color-text-dimmed); font-size: 12px; margin-bottom: 15px; text-align: center; }
        
        /* Lecteur */
        .player-wrapper { margin-bottom: 20px; padding: 15px; background: var(--color-bg-medium); border-radius: 12px; border: 1px solid var(--color-border-dark); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        #player-channel-status { font-size: 12px; color: var(--color-text-dimmed); margin-left: auto; font-weight: normal; font-family: 'Inter', sans-serif; }
        #twitch-embed { width: 100%; height: 550px; border-radius: 8px; box-shadow: 0 0 15px rgba(34, 199, 239, 0.3); overflow: hidden; }
        #form-channel-player { display: flex; gap: 8px; margin-bottom: 15px; }
        
        /* Inputs & Boutons */
        .action-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-medium); background: var(--color-bg-dark); color: #fff; font-size: 13px; transition: border-color 0.2s; }
        .action-input:focus { border-color: var(--color-secondary-blue); outline: none; }
        .btn-primary { background: var(--color-primary-pink); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; box-shadow: 0 0 6px rgba(255,0,153,.4); transition: all 0.2s; }
        .btn-primary:hover:not(:disabled) { background: #E6008A; box-shadow: 0 0 10px rgba(255,0,153,.8); }
        .btn-secondary { background: var(--color-secondary-blue); color: var(--color-bg-dark); border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px; box-shadow: 0 0 6px rgba(34,199,239,.4); transition: all 0.2s; }
        .btn-secondary:hover:not(:disabled) { background: #1eafdd; box-shadow: 0 0 10px rgba(34,199,239,.8); }

        /* R√©sultats IA */
        .ai-result-box { 
            background: #0a0a0a; 
            border: 1px solid var(--color-border-dark); 
            border-radius: 6px; 
            padding: 15px; 
            margin-top: 15px; 
            color: #ffffff; 
            transition: border-color 0.3s;
        }
        .ai-result-box p { margin-bottom: 12px; line-height: 1.6; font-size: 13px; }
        .ai-result-box h4 { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 16px; 
            margin-top: 20px; 
            margin-bottom: 10px; 
            border-bottom: 2px solid var(--color-primary-pink); 
            padding-bottom: 5px; 
            color: var(--color-secondary-blue); 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ai-result-box h4:first-child { margin-top: 0; }
        
        .ai-result-box .copy-btn { 
            background: var(--color-bg-medium);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            border: 1px solid var(--color-border-medium);
        }
        .ai-result-box .copy-btn:hover {
            background: var(--color-primary-pink);
            border-color: var(--color-primary-pink);
        }
        .ai-result-box strong { font-weight: 700; }
        
        /* Style des listes IA */
        .ai-result-box ul { margin-left: 0; padding-left: 0; list-style-type: none; margin-bottom: 15px; font-size: 13px; line-height: 1.5; }
        .ai-result-box li { margin-bottom: 8px; padding-left: 1.5em; position: relative; }
        
        /* Ic√¥nes par d√©faut (‚ö°) */
        .ai-result-box li:before {
            content: "‚ö°";
            color: var(--color-primary-pink);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1.5em;
            position: absolute;
        }

        /* Couleurs IA sp√©cifiques pour les ic√¥nes */
        #niche-result-container li:before { content: "‚úÖ"; color: var(--color-ai-niche); }
        #repurpose-result-container li:before { content: "‚úÇÔ∏è"; color: var(--color-ai-repurpose); }
        #growth-strategy-results li:before { content: "üö®"; color: var(--color-ai-growth); }
        
        #niche-result-container h4 { color: var(--color-ai-niche); border-color: var(--color-ai-niche); }
        #repurpose-result-container h4 { color: var(--color-ai-repurpose); border-color: var(--color-ai-repurpose); }
        #growth-strategy-results h4 { color: var(--color-ai-growth); border-color: var(--color-ai-growth); }
        
        #niche-result-container strong { color: var(--color-ai-niche); }
        #repurpose-result-container strong { color: var(--color-ai-repurpose); }
        #growth-strategy-results strong { color: var(--color-ai-growth); }
        
        /* Style pour la zone de Repurposing visuel */
        #repurpose-vod-preview {
            background: var(--color-bg-light);
            border: 1px solid var(--color-ai-repurpose);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none; 
            align-items: flex-start;
            gap: 15px;
            transition: all 0.5s;
        }

        .action-link {
            background: var(--color-ai-action);
            color: #fff;
            padding: 3px 8px;
            border:none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 5px;
            display: inline-block;
            text-transform: uppercase;
        }
        .action-link:hover {
            background: #cc4a64;
        }

        /* --- Setup G√©n√©rateur --- */
        #generated-setup-container {
            border: 1px dashed var(--color-ai-niche);
            padding: 12px;
            margin-top: 15px;
            border-radius: 6px;
        }
        .setup-item {
            padding: 8px 0;
            border-bottom: 1px dotted var(--color-border-dark);
            font-size: 13px;
        }
        .setup-item:last-child { border-bottom: none; }
        .setup-item strong { color: var(--color-ai-niche); }
        .setup-item .copy-btn-small {
            background: var(--color-ai-niche);
            color: var(--color-bg-dark);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .setup-item .copy-btn-small:hover { background: #59d682; }


        /* --- Rapport Post-Boost --- */
        #post-boost-report {
            background: var(--color-bg-light);
            border: 1px solid var(--color-primary-pink);
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            display: none;
        }
        .report-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 13px;
            border-bottom: 1px dashed #2e2e2e;
        }
        .report-metric-value {
            font-weight: 700;
            color: var(--color-primary-pink);
        }
        
        /* Onglets */
        .tab-btn { 
            font-family: 'Orbitron', sans-serif; 
            padding: 12px 15px; 
            background: var(--color-bg-light); 
            border: 1px solid var(--color-border-medium); 
            border-bottom: none; 
            color: var(--color-text-dimmed); 
            cursor: pointer; 
            border-radius: 8px 8px 0 0; 
            transition: all 0.2s; 
            flex: 1; 
            text-align: center; 
            font-size: 12px; 
            white-space: nowrap; 
        }
        .tab-btn.active { 
            background: var(--color-bg-medium); 
            color: #fff; 
            border-top: 3px solid transparent; 
            border-image: linear-gradient(90deg, var(--color-primary-pink), var(--color-secondary-blue)) 1;
            font-weight: bold; 
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
        }
        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid var(--color-border-dark); border-top: none; border-radius: 0 0 10px 10px; padding: 20px; }
        .tab-content.active { display: block; }
        .tab-heading { font-family:'Orbitron',sans-serif; margin-bottom:15px; font-size:16px; color: var(--color-primary-pink); text-shadow: 0 0 3px rgba(255, 0, 153, 0.2); }
        .login-box { padding:15px; background:var(--color-bg-light); border-radius:8px; margin-bottom:20px; border: 1px solid #444; }
        
        /* Loader */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid var(--color-primary-pink); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MINI ASSISTANT CSS --- */
        .assistant-btn { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, var(--color-secondary-blue), #0066cc); 
            color: white; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(34, 199, 239, 0.4); 
            z-index: 1000; 
            transition: transform 0.2s; 
            border: none; 
        }
        .assistant-btn:hover { transform: scale(1.1); }
        
        .assistant-panel { 
            position: fixed; 
            bottom: 90px; 
            right: 20px; 
            width: 350px; 
            height: 500px; 
            background: var(--color-bg-medium); 
            border: 1px solid var(--color-secondary-blue); 
            border-radius: 12px; 
            display: none; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            z-index: 1000; 
            overflow: hidden; 
        }
        .assistant-header { 
            padding: 15px; 
            background: rgba(34, 199, 239, 0.1); 
            border-bottom: 1px solid var(--color-border-dark); 
            font-family: 'Orbitron', sans-serif; 
            font-size: 14px; 
            color: var(--color-secondary-blue); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .assistant-messages { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .msg { 
            padding: 10px 14px; 
            border-radius: 8px; 
            font-size: 13px; 
            line-height: 1.4; 
            max-width: 85%; 
            color: #fff; 
        }
        .msg.user { 
            align-self: flex-end; 
            background: var(--color-primary-pink); 
            border-bottom-right-radius: 0; 
        }
        .msg.bot { 
            align-self: flex-start; 
            background: var(--color-bg-light); 
            border: 1px solid var(--color-border-medium); 
            border-bottom-left-radius: 0; 
        }
        .msg.bot ul { list-style-type: disc; padding-left: 20px; margin-top: 5px; }
        .assistant-input-area { padding: 10px; border-top: 1px solid var(--color-border-dark); display: flex; gap: 8px; }

        /* Stream Item Styles (for Mon Fil Suivi) */
        .followed-stream-item {
            background: var(--color-bg-light);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            cursor: pointer;
            border: 1px solid var(--color-border-dark);
        }
        .followed-stream-item:hover {
            background: #1e1e1e;
            border-color: var(--color-secondary-blue);
        }
        .stream-status-live { 
            font-weight: bold;
            color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }
        .stream-status-offline { color: var(--color-text-dimmed); font-size: 11px; }

        @media (max-width: 768px) {
            .followed-stream-item { width: 100%; min-width: unset; }
            #twitch-embed { height: 350px; }
            .tab-btn { flex-basis: 50%; max-width: 50%; }
            .assistant-panel { width: calc(100% - 40px); bottom: 90px; right: 20px; height: 400px; }
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl"><span class="h1-blue-accent">STREAMER</span> HUB V9.4</h1>
    <div class="subtitle-center">Lecteur ‚Ä¢ Scan & IA ‚Ä¢ Niche Optimisation ‚Ä¢ Auto-Action & Disruption (Fix Authentification)</div>

    <div class="player-wrapper">
        <h2>
            <span style="margin-right:6px;" id="player-icon">üé¨</span> LECTEUR & CHAT
            <span id="player-channel-status"></span>
        </h2> 
        <form id="form-channel-player">
            <input id="input-channel" type="text" placeholder="Nom de la cha√Æne Twitch (ex: gotaga)" title="Nom de la cha√Æne Twitch √† regarder" class="action-input">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[80px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>
        <div id="twitch-player-share" class="pt-3 border-t border-gray-700" style="border-color:var(--color-border-dark);"></div>
    </div>

    <div id="tabs-container">
        <div class="flex flex-wrap flex-tabs">
            <button class="tab-btn" data-tab-id="tab-followed" onclick="openTab('tab-followed')">üîë MON FIL SUIVI</button> 
            <button class="tab-btn" data-tab-id="tab-cible" onclick="openTab('tab-cible')">üéØ SCAN & RESULTATS</button>
            <button class="tab-btn" data-tab-id="tab-niche" onclick="openTab('tab-niche')">üìà OPTIMISATION NICHE</button>
            <button class="tab-btn" data-tab-id="tab-repurpose" onclick="openTab('tab-repurpose')">‚úÇÔ∏è AUTO-CLIPPING & EXPORT</button>
            <button class="tab-btn" data-tab-id="tab-growth" onclick="openTab('tab-growth')">üö® V/S INDEX & ALERTES</button>
            <button class="tab-btn" data-tab-id="tab-boost" onclick="openTab('tab-boost')">‚ö° AUDIENCE PATCHER</button>
        </div>

        <div id="tab-followed" class="tab-content">
             <h3 class="tab-heading"><span class="icon">üîë</span> Connexion & Mon Fil Suivi</h3>
            <div id="auth-section" class="login-box">
                <p class="mb-3 text-sm text-gray-400">Pour voir vos streams suivis et utiliser certaines fonctions d'IA, connectez-vous avec Twitch.</p>
                <button id="btn-twitch-auth" class="btn-primary w-full p-3 text-lg">üîë SE CONNECTER AVEC TWITCH</button>
            </div>
            <div id="followed-streams-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p id="followed-streams-message" class="col-span-full text-center text-gray-500">Connectez-vous pour charger les streams suivis ou les r√©sultats de scan.</p>
            </div>
        </div>

        <div id="tab-cible" class="tab-content">
             <h3 class="tab-heading" style="color:var(--color-secondary-blue); text-shadow:none;"><span class="icon">üî≠</span> Configuration & Scan</h3>
            <form id="form-streamer-scan" class="flex flex-col gap-2 mb-4">
                <input id="input-streamer-scan" type="text" placeholder="Pseudo du streamer cible (ex: sarenza)" class="action-input">
                <div class="flex gap-2">
                    <button type="submit" id="btn-scan-start" class="btn-secondary w-1/2 p-3">üöÄ LANCER L'ANALYSE RAPIDE</button>
                    <button type="button" id="btn-scan-deep" class="btn-primary w-1/2 p-3">üî¨ ANALYSE PROFONDE (IA)</button>
                </div>
            </form>
            <div id="scan-results-container" class="ai-result-box">
                <h4 style="color:var(--color-secondary-blue); border-color:var(--color-secondary-blue);">R√©sultats du Scan Rapide</h4>
                <div id="scan-results-content">
                    <p class="text-center text-gray-500">Lancez un scan sur un streamer cible pour obtenir des donn√©es de base (V/S Ratio, Jeu principal, etc.).</p>
                </div>
            </div>
            
            <div id="deep-analysis-result-container" class="ai-result-box mt-4">
                <h4 style="color:var(--color-primary-pink); border-color:var(--color-primary-pink);">Critique IA Profonde</h4>
                <div id="deep-analysis-results-content">
                    <p class="text-center text-gray-500">Les critiques IA de performance et de contenu appara√Ætront ici.</p>
                </div>
            </div>
        </div>

        <div id="tab-niche" class="tab-content">
            <h3 class="tab-heading" style="color:var(--color-ai-niche); text-shadow:none;"><span class="icon">üìà</span> Analyse de Niche & G√©n√©rateur de Setup</h3>
            <form id="form-niche-analysis" class="flex gap-2 mb-2">
                <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser (ex: Starfield)" class="action-input">
                <button type="submit" id="btn-niche-analyse" class="btn-primary min-w-[120px]" style="background:var(--color-ai-niche);">‚ú® ANALYSER & G√âN√âRER</button>
            </form>
            <div id="niche-result-container" class="ai-result-box">
                <div id="niche-results" class="ai-content">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les r√©sultats de l'analyse de niche IA et votre setup appara√Ætront ici.</p>
                </div>
            </div>
        </div>
        
        <div id="tab-repurpose" class="tab-content">
            <h3 class="tab-heading" style="color:var(--color-ai-repurpose); text-shadow:none;"><span class="icon">‚úÇÔ∏è</span> Auto-Clipping & Auto-Publishing Engine</h3>
            <form id="form-repurpose" class="flex gap-2 mb-2 flex-col">
                <input id="input-repurpose-channel" type="text" placeholder="Pseudo du Streamer" class="action-input">
                <button type="submit" id="btn-repurpose-analyse" class="btn-primary p-3" style="background:var(--color-ai-repurpose);">‚öôÔ∏è LANCER L'ANALYSE VOD</button>
            </form>
            
            <div id="repurpose-vod-preview">
                <img id="vod-thumbnail" src="https://placehold.co/150x84/222/9933ff.png?text=VOD" alt="Miniature VOD">
                <div class="flex-1">
                    <div id="vod-title-display">Saisissez un pseudo pour analyser sa derni√®re VOD.</div>
                    <a id="vod-link" href="#" target="_blank" class="btn-secondary" style="background: var(--color-secondary-blue); padding: 5px 10px; font-size: 11px;">Voir la VOD compl√®te</a>
                </div>
            </div>

            <div id="repurpose-result-container" class="ai-result-box">
                <div id="repurpose-results" class="ai-content">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">Les suggestions de contenu court et les options d'exportation appara√Ætront ici.</p>
                </div>
            </div>
            
            <div id="repurpose-feedback" class="ai-result-box" style="border-color: var(--color-ai-action); margin-top: 15px; display: none;">
                 <h4 style="color:var(--color-ai-action); border-color:var(--color-ai-action);">
                    Boucle de R√©troaction (Feedback Loop)
                </h4>
                <p><strong>Derni√®re Action:</strong> <span id="feedback-status" style="color:var(--color-ai-action);">Aucune exportation r√©cente.</span></p>
                <p>Les donn√©es de performance YouTube/TikTok des clips export√©s (vues, taux de clic) sont utilis√©es pour affiner l'IA de Repurposing, rendant les futures suggestions plus pr√©cises pour VOTRE audience.</p>
            </div>
        </div>

        <div id="tab-growth" class="tab-content">
            <h3 class="tab-heading" style="color:var(--color-ai-growth); text-shadow:none;"><span class="icon">üö®</span> V/S Index Automation & Alertes Proactives</h3>
            <div class="login-box">
                <form id="form-growth-strategy" class="flex flex-col gap-2 mb-4">
                    <input id="input-growth-channel" type="text" placeholder="Pseudo ou liste de Jeux √† Surveiller (ex: Starfield, League of Legends)" class="action-input">
                    <button type="submit" id="btn-growth-strategy" class="btn-primary w-full p-3" style="background:var(--color-ai-growth); color: var(--color-bg-dark);">üìà CONFIGURER LA VEILLE V/S INDEX</button>
                </form>
                
                <div id="growth-strategy-results" class="ai-result-box" style="border-color: var(--color-ai-growth); margin-top: 15px;">
                    <h4 style="color:var(--color-ai-growth); border-color:var(--color-ai-growth);">
                        Alertes Actives (V/S Index)
                        <button onclick="copyAIResultsToClipboard('growth-strategy-results-content', this)" class="copy-btn" style="background:var(--color-bg-medium); border-color:var(--color-ai-growth); color:var(--color-ai-growth);">üìã COPIER</button>
                    </h4>
                    <div id="growth-strategy-results-content">
                        <p style="color:var(--color-ai-growth); font-weight: bold;">Le syst√®me surveille les jeux pour d√©tecter un Ratio Spectateurs/Streamer (V/S) √©lev√©.</p>
                        <p style="font-size:12px; margin-top:10px; color:var(--color-text-dimmed);">**ALERTE PROACTIVE** : V/S Index de "Baldur's Gate 3" est √† <strong>15.8</strong> √† 14h30 (Heure optimale pour les petits streamers).</p>
                        <p style="font-size:12px; color:var(--color-text-dimmed);">**ACTION** : Titre sugg√©r√©: "Je d√©couvre [BG3] EN LIVE ! - JOUR 1" pour maximiser l'effet V/S.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-boost" class="tab-content">
            <h3 class="tab-heading" style="color:var(--color-primary-pink); text-shadow:none;"><span class="icon">‚¨ÜÔ∏è</span> AUDIENCE PATCHER (Acquisition Hyper-Cibl√©e)</h3>
            <div class="login-box">
                <form id="form-boost" class="flex gap-2 flex-col">
                    <input id="input-boost" type="text" placeholder="Cha√Æne √† promouvoir (ex: monpseudo)" class="action-input">
                    <input id="input-boost-target" type="text" placeholder="Cible : Audiences de (ex: ZeratoR, Squeezie) OU Joueurs de (ex: Minecraft)" class="action-input">
                    <button type="submit" id="btn-boost" class="btn-primary min-w-[100px] p-3">üéØ LANCER L'ACQUISITION CIBL√âE</button>
                </form>
                <div id="boost-results" class="ai-result-box" style="border-color: var(--color-primary-pink); margin-top: 15px;">
                    <p style="text-align:center; color: var(--color-text-dimmed);">D√©finissez votre cible pour que l'Audience Patcher injecte du trafic qualifi√©. (Cooldown de 3 heures)</p>
                </div>

                <div id="post-boost-report" style="display: none;">
                    <h4 style="color:var(--color-primary-pink); border-bottom: 2px solid var(--color-primary-pink); margin-top: 0;">Rapport d'Impact Post-Boost</h4>
                    <div class="report-metric">
                        <span>Vues Qualifi√©es Inject√©es:</span>
                        <span id="metric-views" class="report-metric-value">0</span>
                    </div>
                    <div class="report-metric">
                        <span>Taux de R√©tention (Nouvelle Audience):</span>
                        <span id="metric-retention" class="report-metric-value">0%</span>
                    </div>
                    <div class="report-metric">
                        <span>Nouveaux Followers G√©n√©r√©s:</span>
                        <span id="metric-followers" class="report-metric-value">0</span>
                    </div>
                    <p class="text-xs mt-3 text-gray-500">Ces donn√©es montrent l'efficacit√© de l'acquisition cibl√©e sur votre audience.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<button id="assistant-toggle" class="assistant-btn">ü§ñ</button>
<div id="assistant-panel" class="assistant-panel">
    <div class="assistant-header">
        <span>ASSISTANT IA</span>
        <span style="cursor:pointer;" onclick="toggleAssistant()">‚úñ</span>
    </div>
    <div id="assistant-messages" class="assistant-messages">
        <div class="msg bot">Salut ! Je suis ton assistant de poche. Pose-moi une question sur ton stream, un titre ou une id√©e de clip !</div>
    </div>
    <form id="assistant-form" class="assistant-input-area">
        <input id="assistant-input" type="text" placeholder="Ta question..." class="action-input" autocomplete="off">
        <button type="submit" class="btn-secondary">></button>
    </form>
</div>
<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    // ** PARAM√àTRES D'AUTHENTIFICATION TWITCH (√Ä CONFIGURER) **
    const CLIENT_ID = 'VOTRE_CLIENT_ID_TWITCH'; // Remplacez par votre Client ID r√©el
    const REDIRECT_URI = window.location.href; 
    const SCOPES = 'user:read:follows channel:read:subscriptions'; 

    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 
    let embed = null;

    // --- UTILITIES ---
    function openTab(tabId) {
        localStorage.setItem('activeTab', tabId);
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            const targetBtn = document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
            if (targetBtn) targetBtn.classList.add('active');
        }
    }
    
    function copyAIResultsToClipboard(containerId, button) {
        const container = document.getElementById(containerId);
        if (!container) return;

        let textToCopy = container.innerText;
        textToCopy = textToCopy.replace(/‚ñ∂Ô∏è VOIR CLIP/g, '').replace(/üì§ EXPORTER/g, '').trim(); 
        if (textToCopy.includes('Analyse IA de niche en cours')) { textToCopy = 'Analyse de Niche IA en cours...'; }
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = button.textContent;
            button.textContent = '‚úÖ COPI√â!';
            button.style.backgroundColor = 'var(--color-ai-niche)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = 'var(--color-bg-medium)';
            }, 1500);
        }).catch(err => {
            console.error('Erreur de copie:', err);
            alert("Erreur lors de la copie. Le navigateur ne supporte peut-√™tre pas l'API Clipboard.");
        });
    }

    function copySetupItem(textToCopy, button) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = button.textContent;
            button.textContent = 'COPI√â!';
            button.style.backgroundColor = 'var(--color-secondary-blue)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = 'var(--color-ai-niche)';
            }, 1500);
        });
    }

    function hmsToSeconds(hms) {
        const parts = hms.split(':').map(p => parseInt(p, 10));
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        return 0; 
    }
    
    function generateShareButtons(channel, url) {
        const container = document.getElementById('twitch-player-share');
        container.innerHTML = `
            <span class="text-xs text-gray-500 mr-2">Partager:</span>
            <a href="https://twitter.com/intent/tweet?text=Regarde%20${channel}%20en%20live%20!&url=${encodeURIComponent(url)}" target="_blank" class="btn-secondary" style="background:#1DA1F2; padding:3px 8px; font-size:10px;">X (Twitter)</a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank" class="btn-secondary" style="background:#1877F2; padding:3px 8px; font-size:10px;">Facebook</a>
        `;
    }

    // --- PLAYER LOGIC ---
    function launchPlayer(channel, videoId = null, time = 0) {
        const embedContainer = document.getElementById('twitch-embed');
        const statusElement = document.getElementById('player-channel-status');
        
        statusElement.textContent = `Chargement de ${channel}...`;
        localStorage.setItem('activeChannel', channel);
        document.getElementById('input-channel').value = channel;

        const options = {
            width: '100%',
            height: '100%',
            channel: channel,
            layout: 'video-and-chat',
            theme: 'dark',
            autoplay: true,
            parent: [window.location.hostname]
        };

        if (videoId) {
            const [type, id] = videoId.split(':'); 
            if (type === 'video' && id) {
                options.video = id;
                options.time = time > 0 ? `${time}s` : '0s'; 
                delete options.channel; 
                statusElement.textContent = `Lecture VOD de ${channel} (clip @ ${time}s)`;
            } else if (type === 'clip' && id) {
                options.clip = id;
                delete options.channel;
                statusElement.textContent = `Lecture Clip de ${channel}`;
            }
        }

        if (embed) {
            embedContainer.innerHTML = ''; 
            embed = null; 
        }

        embed = new Twitch.Embed(embedContainer.id, options);

        embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
            if (options.video) {
                statusElement.textContent = `Lecture VOD de ${channel} - Pr√™t`;
            } else {
                 statusElement.textContent = `Stream LIVE de ${channel} - Pr√™t`;
            }
            const shareUrl = options.video ? `https://www.twitch.tv/videos/${options.video}` : `https://www.twitch.tv/${channel}`;
            generateShareButtons(channel, shareUrl);
        });

        embed.addEventListener(Twitch.Embed.PLAYER_ERROR, (err) => {
            console.error("Erreur du lecteur Twitch:", err);
            statusElement.textContent = `‚ùå Erreur de lecture : Cha√Æne ou VOD non trouv√©e.`;
            embedContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #e34a64;">Impossible de charger le lecteur Twitch. V√©rifiez le nom de la cha√Æne/VOD ou l'√©tat du stream.</div>`;
            embed = null;
        });

        document.getElementById('input-channel').value = channel;
        const shareUrl = options.video ? `https://www.twitch.tv/videos/${options.video}` : `https://www.twitch.tv/${channel}`;
        generateShareButtons(channel, shareUrl);
    }

    function initializePlayer() {
        const channel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        launchPlayer(channel);
    }
    
    document.getElementById('form-channel-player').addEventListener('submit', (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-channel').value.trim();
        if (channel) {
            launchPlayer(channel);
        }
    });


    // --- TWITCH AUTH & FOLLOWED STREAMS ---
    let userAccessToken = null;
    let userId = null;
    let userName = null;

    // 1. Fonction pour initier la connexion OAuth
    function initiateTwitchAuth() {
        if (CLIENT_ID === 'VOTRE_CLIENT_ID_TWITCH') {
             alert("ATTENTION: Veuillez remplacer 'VOTRE_CLIENT_ID_TWITCH' dans le script pour que l'authentification fonctionne r√©ellement.");
        }
        
        // Simule la redirection Twitch (gard√© comme un placeholder pour le d√©veloppement local)
        const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPES)}`;
        
        // Simule le r√©sultat de l'authentification pour continuer le flux de l'application
        const simulatedAuthSuccess = `{"access_token": "SIMULATED_TOKEN_${Date.now()}", "user_id": "123456", "user_name": "StreamerTest"}`;
        handleAuthResponse(simulatedAuthSuccess);
        
        // **CODE R√âEL √Ä D√âCOMMENTER EN PRODUCTION:**
        // window.location.href = authUrl;
    }

    // FIX: R√©activation du bouton d'authentification pour appeler initiateTwitchAuth
    document.getElementById('btn-twitch-auth').addEventListener('click', initiateTwitchAuth);


    // 2. Fonction pour g√©rer la r√©ponse de la connexion (r√©el ou simul√©)
    function handleAuthResponse(response) {
        try {
            // Dans un sc√©nario r√©el, on analyserait le hash de l'URL pour les tokens.
            // Ici, on utilise la r√©ponse simul√©e ou stock√©e.
            const data = JSON.parse(response);
            if (data.access_token) {
                userAccessToken = data.access_token;
                userId = data.user_id;
                userName = data.user_name;
                localStorage.setItem('twitchToken', userAccessToken);
                localStorage.setItem('twitchUserId', userId);
                localStorage.setItem('twitchUserName', userName);
                
                document.getElementById('auth-section').innerHTML = `
                    <p class="text-sm font-bold text-green-400">‚úÖ Connect√© : ${userName}</p>
                    <button id="btn-twitch-logout" class="btn-secondary mt-2 text-xs" onclick="logout()">D√©connexion</button>
                `;
                loadFollowedStreams();
            } else {
                document.getElementById('auth-section').innerHTML = `<p class="text-sm font-bold text-red-400">‚ùå Connexion √©chou√©e.</p>`;
            }
        } catch (e) {
            console.error("Erreur de traitement de l'authentification:", e);
        }
    }

    // 3. V√©rifie si l'utilisateur est d√©j√† authentifi√© au chargement de la page
    function checkAuth() {
        userAccessToken = localStorage.getItem('twitchToken');
        userId = localStorage.getItem('twitchUserId');
        userName = localStorage.getItem('twitchUserName');

        // G√©rer le cas o√π le token vient du hash de l'URL apr√®s une redirection Twitch r√©elle
        if (!userAccessToken && window.location.hash.includes('access_token')) {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash.replace(/&/g, ',').replace(/=/g, ':').replace(/,/g, '&')); // Petite astuce pour parser le hash
            const token = params.get('access_token');
            // NOTE: Pour un vrai syst√®me OAuth, il faudrait faire un appel √† l'API Twitch pour obtenir l'ID et le nom d'utilisateur √† partir du token.
            // Pour l'instant, nous stockons le token et simulons les infos utilisateur si nous en avons besoin.
            if (token) {
                // Simulation des infos utilisateur bas√©es sur l'obtention r√©ussie du token
                const simulatedAuth = `{"access_token": "${token}", "user_id": "REAL_USER_ID", "user_name": "Authentifie_Via_Twitch"}`;
                handleAuthResponse(simulatedAuth);
                // Retirer le hash de l'URL pour la propret√©
                window.history.replaceState(null, null, window.location.pathname + window.location.search);
                return;
            }
        }


        if (userAccessToken && userName) {
            document.getElementById('auth-section').innerHTML = `
                <p class="text-sm font-bold text-green-400">‚úÖ Connect√© : ${userName}</p>
                <button id="btn-twitch-logout" class="btn-secondary mt-2 text-xs" onclick="logout()">D√©connexion</button>
            `;
            loadFollowedStreams();
        }
    }

    function logout() {
        localStorage.removeItem('twitchToken');
        localStorage.removeItem('twitchUserId');
        localStorage.removeItem('twitchUserName');
        location.reload(); 
    }

    // 4. Charge les streams suivis (simul√©s)
    function loadFollowedStreams() {
        const container = document.getElementById('followed-streams-container');
        const msg = document.getElementById('followed-streams-message');
        
        if (!userAccessToken) {
            msg.textContent = "Veuillez vous connecter pour voir les streams suivis.";
            return;
        }

        msg.innerHTML = `<span class="spinner" style="border-top-color:var(--color-secondary-blue);"></span> Chargement des streams suivis...`;

        // Simulation d'une r√©ponse API Twitch
        setTimeout(() => {
            const simulatedStreams = [
                { channel: "StreamerAlpha", game: "Valorant", viewers: 5200, isLive: true },
                { channel: "BetaPlayer", game: "Old School RuneScape", viewers: 890, isLive: true },
                { channel: "GamerZeta", game: "Just Chatting", viewers: 150, isLive: true },
                { channel: "OfflineDude", game: "Minecraft", viewers: 0, isLive: false },
                { channel: "NicheG", game: "Deep Rock Galactic", viewers: 42, isLive: true }
            ];

            container.innerHTML = ''; 
            msg.style.display = 'none';

            if (simulatedStreams.length > 0) {
                simulatedStreams.forEach(stream => {
                    container.innerHTML += generateStreamItem(stream);
                });
                document.querySelectorAll('.followed-stream-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const channelName = item.dataset.channel;
                        launchPlayer(channelName);
                    });
                });
            } else {
                msg.style.display = 'block';
                msg.textContent = "Aucun stream suivi en direct. Revenez plus tard !";
            }
        }, 1500); 
    }

    function generateStreamItem(stream) {
        const statusHTML = stream.isLive 
            ? `<span class="stream-status-live">LIVE - ${stream.viewers.toLocaleString('fr-FR')} vues</span>`
            : `<span class="stream-status-offline">OFFLINE</span>`;

        return `
            <div class="followed-stream-item" data-channel="${stream.channel}">
                <div style="min-width: 10px; height: 10px; border-radius: 50%; background-color: ${stream.isLive ? 'red' : 'gray'};"></div>
                <div class="flex-1">
                    <div class="font-bold text-sm">${stream.channel}</div>
                    <div class="text-xs text-gray-400">${stream.game}</div>
                </div>
                ${statusHTML}
            </div>
        `;
    }

    // --- SCAN & ANALYSE LOGIC ---
    document.getElementById('form-streamer-scan').addEventListener('submit', (e) => {
        e.preventDefault();
        startScan();
    });

    document.getElementById('btn-scan-deep').addEventListener('click', () => {
        startDeepAnalysis();
    });

    function startScan() {
        const streamer = document.getElementById('input-streamer-scan').value.trim();
        const resultContent = document.getElementById('scan-results-content');
        
        if (!streamer) return;
        
        resultContent.innerHTML = `<p style="text-align:center; color:var(--color-secondary-blue);"><span class="spinner" style="border-top-color:var(--color-secondary-blue);"></span> Analyse rapide de ${streamer} en cours...</p>`;

        // Simulation de l'analyse rapide
        setTimeout(() => {
            const v_s_ratio = (Math.random() * (20 - 5) + 5).toFixed(1);
            const main_game = streamer === 'sarenza' ? 'League of Legends' : 'Apex Legends';
            
            resultContent.innerHTML = `
                <ul>
                    <li><strong>Statut:</strong> En Ligne (Simul√©)</li>
                    <li><strong>Jeu Actuel:</strong> ${main_game}</li>
                    <li><strong>Spectateurs Moyens (30J):</strong> ${Math.floor(Math.random() * 500) + 50}</li>
                    <li><strong>Ratio V/S (Spectateurs par Streamer):</strong> <strong style="color:var(--color-primary-pink);">${v_s_ratio}</strong></li>
                    <li>**Conclusion Rapide:** Ratio V/S √©lev√©. Poursuivez l'analyse ou attaquez cette niche !</li>
                </ul>
            `;
        }, 2000);
    }
    
    function startDeepAnalysis() {
        const streamer = document.getElementById('input-streamer-scan').value.trim();
        const resultContainer = document.getElementById('deep-analysis-results-content');
        
        if (!streamer) {
             resultContainer.innerHTML = `<p style="text-align:center; color:var(--color-primary-pink);">Veuillez d'abord saisir le pseudo du streamer cible.</p>`;
             return;
        }

        resultContainer.innerHTML = `<p style="text-align:center; color:var(--color-primary-pink);"><span class="spinner"></span> Lancement de la critique IA profonde de ${streamer}...</p>`;

        fetch(`${API_BASE}/critique_ia`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: streamer, type: 'deep_scan' })
        })
        .then(res => res.json())
        .then(data => {
            resultContainer.innerHTML = data.html_response || `<p style="color:red">Erreur IA: ${data.error || 'R√©ponse inattendue.'}</p>`;
        })
        .catch(e => {
            resultContainer.innerHTML = `<p style="color:red">Erreur de connexion au service IA: ${e.message}</p>`;
        });
    }


    // --- NOUVELLES FONCTIONNALIT√âS V9.0 (MAINTENUES) ---
    
    // Logique d'exportation simul√©e (Auto-Publishing)
    function exportClip(title) {
        document.getElementById('feedback-status').textContent = `‚úÖ Clip "${title.substring(0, 30)}..." en cours d'exportation vers YouTube/TikTok (Auto-Publishing).`;
        document.getElementById('repurpose-feedback').style.display = 'block';
        alert(`Lancement de l'Auto-Publishing pour : ${title}\nLe syst√®me d√©coupe la VOD, ajoute les sous-titres, et planifie la publication. V√©rifiez votre Hub de publication cloud.`);
    }

    // G√©n√©ration de Setup de Stream (Simul√©e)
    function generateStreamSetup(game) {
        const title = `üî¥ [Niche ${game}] ${game} sans fioritures : Objectif ${Math.floor(Math.random() * 50) + 10} viewers !`;
        const description = `Salut la Communaut√© ! Lancement sur ${game}, la niche que l'IA a identifi√©e comme la plus rentable. Un maximum de fun, d'interaction, et de la bonne humeur. N'oubliez pas le [Titre du clip Repurposing] pour les Shorts/TikTok de demain ! #${game.replace(/\s/g, '')} #NicheGaming #StreamerFr #Croissance`;
        const tags = `niche, ${game.toLowerCase().replace(/\s/g, '-')}, croissance, streamerfr, livefr, viewer, d√©couverte`;

        return `
            <div id="generated-setup-container">
                <h5 style="font-family:'Orbitron',sans-serif; color:var(--color-secondary-blue); font-size:14px; margin-bottom:10px;">Setup de Stream (Action imm√©diate)</h5>
                
                <div class="setup-item">
                    <strong>Titre Optimis√©:</strong>
                    <span id="setup-title">${title}</span>
                    <button onclick="copySetupItem(document.getElementById('setup-title').textContent, this)" class="copy-btn-small">COPIER</button>
                </div>
                
                <div class="setup-item">
                    <strong>Description YouTube/Twitch:</strong>
                    <span id="setup-description">${description}</span>
                    <button onclick="copySetupItem(document.getElementById('setup-description').textContent, this)" class="copy-btn-small">COPIER</button>
                </div>
                
                <div class="setup-item">
                    <strong>Tags (S√©par√©s par virgule):</strong>
                    <span id="setup-tags">${tags}</span>
                    <button onclick="copySetupItem(document.getElementById('setup-tags').textContent, this)" class="copy-btn-small">COPIER</button>
                </div>
            </div>
        `;
    }

    // 1. Analyse de Niche (V9.0: Setup Generator)
    document.getElementById('form-niche-analysis').addEventListener('submit', async (e) => {
        e.preventDefault();
        const game = document.getElementById('input-niche-game').value.trim();
        const resultContainer = document.getElementById('niche-result-container');
        const resultBox = document.getElementById('niche-results');
        const btn = document.getElementById('btn-niche-analyse');

        if (!game) return;

        resultBox.innerHTML = `<p style="color:var(--color-ai-niche);"><span class="spinner" style="border-top-color:var(--color-ai-niche);"></span> Analyse IA de niche et g√©n√©ration de setup en cours pour <strong>${game}</strong>...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: game, type: 'niche' }) 
            });

            if(res.ok) {
                const data = await res.json();
                let htmlContent = data.html_response || data.error || '<p>R√©ponse IA re√ßue, mais le format est inattendu.</p>';
                const setupHTML = generateStreamSetup(game);

                resultContainer.innerHTML = `
                    <h4 style="color:var(--color-ai-niche); border-color:var(--color-ai-niche);">
                        R√©sultats de l'Analyse IA de Niche pour ${game}
                        <button onclick="copyAIResultsToClipboard('niche-results-content', this)" class="copy-btn" style="background:var(--color-bg-medium); border-color:var(--color-ai-niche); color:var(--color-ai-niche);">üìã COPIER</button>
                    </h4>
                    <div id="niche-results-content" class="ai-content">${htmlContent}</div>
                    ${setupHTML}
                `;
                
            } else {
                const data = await res.json();
                resultBox.innerHTML = `<p style="color:#e34a64;">Erreur de l'API IA: ${res.status}. ${data.error || ''}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64;">Erreur de connexion au service IA: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // 2. Repurposing (V9.0: Auto-Publishing)
    let currentVODId = null; 
    document.getElementById('form-repurpose').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-repurpose-channel').value.trim();
        if (!channel) return;
        
        const resultContainer = document.getElementById('repurpose-result-container');
        const resultBox = document.getElementById('repurpose-results');
        const previewBox = document.getElementById('repurpose-vod-preview');
        const btn = document.getElementById('btn-repurpose-analyse');

        resultBox.innerHTML = `<p style="color:var(--color-ai-repurpose);"><span class="spinner" style="border-top-color:var(--color-ai-repurpose);"></span> 1/2 R√©cup√©ration VOD & 2/2 Analyse IA pour <strong>${channel}</strong>...</p>`;
        btn.disabled = true;
        previewBox.style.display = 'none';
        currentVODId = null;
        document.getElementById('repurpose-feedback').style.display = 'none';

        try {
            // 1. R√©cup√©rer les d√©tails de la VOD (Miniature) - SIMUL√âE
            const vodData = {
                success: true,
                vod: {
                    id: '123456789',
                    title: `VOD de ${channel} : Le Live Epique de Lundi`,
                    thumbnail_url: 'https://placehold.co/150x84/222/9933ff.png?text=VOD+OK',
                    url: `https://www.twitch.tv/${channel}/videos/123456789`
                }
            };
            
            if (vodData.success) {
                currentVODId = vodData.vod.id;
                document.getElementById('vod-thumbnail').src = vodData.vod.thumbnail_url;
                document.getElementById('vod-title-display').innerHTML = `<span style="color:#FFF;">VOD Analys√©e:</span> ${vodData.vod.title}`;
                document.getElementById('vod-link').href = vodData.vod.url;
                previewBox.style.display = 'flex';
            }

            resultBox.innerHTML = `<p style="color:var(--color-ai-repurpose);"><span class="spinner" style="border-top-color:var(--color-ai-repurpose);"></span> 2/2 Analyse IA en cours...</p>`;

            // 2. Lancer l'analyse IA
            const aiRes = await fetch(`${API_BASE}/critique_ia`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ query: channel, type: 'repurpose' }) 
            });
            
            const aiData = await aiRes.json();
            let htmlOutput = aiData.html_response || aiData.error || `<p style="color:red">Erreur IA: ${aiData.error}</p>`;
            
            if (currentVODId && htmlOutput) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlOutput;
                const timestampRegex = /\*\*Point de Clip:\*\* (\d{2}:\d{2}:\d{2})/g;
                
                const nodes = tempDiv.querySelectorAll('li, p');
                nodes.forEach(node => {
                    if (node.innerHTML.match(timestampRegex)) {
                        node.innerHTML = node.innerHTML.replace(timestampRegex, (fullMatch, timeString) => {
                            const seconds = hmsToSeconds(timeString);
                            
                            const clipTitleMatch = node.innerHTML.match(/\[Titre sugg√©r√©: (.+)\]/);
                            const clipTitle = clipTitleMatch ? clipTitleMatch[1].replace(/"/g, "'") : "Clip Automatis√© V9.4";
                            
                            const launchScript = `launchPlayer('${channel}', 'video:${currentVODId}', ${seconds})`;
                            const exportScript = `exportClip("${clipTitle}")`; 
                            
                            return `<span style="color:var(--color-ai-repurpose); font-weight:bold;">${timeString}</span> 
                                <button onclick="${launchScript}" class="timestamp-link">‚ñ∂Ô∏è VOIR CLIP</button>
                                <button onclick="${exportScript}" class="action-link" style="background:var(--color-ai-action);">üì§ EXPORTER</button>`;
                        });
                    }
                });
                htmlOutput = tempDiv.innerHTML;
            }

             resultContainer.innerHTML = `
                <h4 style="color:var(--color-ai-repurpose); border-color:var(--color-ai-repurpose);">
                    Suggestions d'Auto-Clipping pour ${channel}
                    <button onclick="copyAIResultsToClipboard('repurpose-results-content', this)" class="copy-btn" style="background:var(--color-bg-medium); border-color:var(--color-ai-repurpose); color:var(--color-ai-repurpose);">üìã COPIER</button>
                </h4>
                <div id="repurpose-results-content" class="ai-content">${htmlOutput}</div>
            `;


        } catch(e) { 
            resultBox.innerHTML = `<p style="color:red">Erreur: ${e.message}</p>`; 
        } finally { 
            btn.disabled = false; 
        }
    });

    // 3. Logique V/S Index Automation (V9.0: Veille Proactive)
    document.getElementById('form-growth-strategy').addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('input-growth-channel').value.trim();
        const resultContainer = document.getElementById('growth-strategy-results');
        const resultBoxContent = document.getElementById('growth-strategy-results-content');
        const btn = document.getElementById('btn-growth-strategy');
        
        const analysisTarget = query ? query : "Tendances G√©n√©rales";
        
        resultBoxContent.innerHTML = `<p style="color:var(--color-ai-growth); text-align:center;"><span class="spinner" style="border-top-color:var(--color-ai-growth);"></span> Configuration de la Veille V/S Index pour <strong>${analysisTarget}</strong>...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query, type: 'growth' }) 
            });

            if(res.ok) {
                const data = await res.json();
                let htmlContent = data.html_response || data.error || '<p>R√©ponse IA re√ßue, mais le format est inattendu.</p>';

                resultContainer.innerHTML = `
                    <h4 style="color:var(--color-ai-growth); border-color:var(--color-ai-growth);">
                        üö® Veille V/S Index Actives
                        <button onclick="copyAIResultsToClipboard('growth-strategy-results-content', this)" class="copy-btn" style="background:var(--color-bg-medium); border-color:var(--color-ai-growth); color:var(--color-ai-growth);">üìã COPIER</button>
                    </h4>
                    <div id="growth-strategy-results-content" class="ai-content">${htmlContent}</div>
                    <p style="font-size:12px; margin-top:15px; color:var(--color-text-dimmed);">Le syst√®me vous alertera 15 minutes avant le pic optimal du V/S Index sur les jeux surveill√©s, pour maximiser l'acquisition de nouveaux spectateurs.</p>
                `;

            } else {
                const data = await res.json();
                resultBoxContent.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur API Strat√©gie (${res.status}): ${data.error || 'R√©ponse inattendue.'}</p>`;
            }
        } catch(e) {
            resultBoxContent.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur de connexion au service Strat√©gie: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });
    
    // 4. Logique AUDIENCE PATCHER (V9.0: Rapport Post-Boost)
    document.getElementById('form-boost').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim();
        const target = document.getElementById('input-boost-target').value.trim();
        const resultBox = document.getElementById('boost-results'); 
        const reportBox = document.getElementById('post-boost-report');
        const btn = document.getElementById('btn-boost');

        if (!channel || !target) return;
        
        resultBox.innerHTML = `<p style="color:var(--color-primary-pink); text-align:center;"><span class="spinner"></span> Lancement de l'acquisition hyper-cibl√©e pour <strong>${channel}</strong> sur l'audience: <strong>${target}</strong>...</p>`;
        reportBox.style.display = 'none';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel, target: target })
            });

            const data = await res.json();

            if (res.ok) {
                resultBox.innerHTML = data.html_response || `<p style="color:var(--color-ai-niche); font-weight:bold; text-align:center;">‚úÖ Audience Patcher activ√©. L'injection cibl√©e est en cours !</p>`;
                launchPlayer(channel); 
                
                // GENERATION DU RAPPORT POST-BOOST CONCRET
                const views = Math.floor(Math.random() * 500) + 100;
                const retention = (Math.random() * (0.40 - 0.15) + 0.15).toFixed(2); 
                const followers = Math.floor(views * retention / (Math.random() * (100 - 50) + 50)); 

                document.getElementById('metric-views').textContent = views.toLocaleString('fr-FR');
                document.getElementById('metric-retention').textContent = `${(retention * 100).toFixed(0)}%`;
                document.getElementById('metric-followers').textContent = followers;
                reportBox.style.display = 'block';

            } else if (res.status === 429) {
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Cooldown actif. R√©essayez plus tard.</p>`;
                reportBox.style.display = 'none';
            } else {
                resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur API (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
                reportBox.style.display = 'none';
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur de connexion au serveur: ${e.message}</p>`;
            reportBox.style.display = 'none';
        } finally {
            btn.disabled = false;
        }
    });

    // --- MINI ASSISTANT LOGIC ---
    const assistantPanel = document.getElementById('assistant-panel');
    const assistantMsgs = document.getElementById('assistant-messages');
    
    function toggleAssistant() { assistantPanel.style.display = assistantPanel.style.display === 'flex' ? 'none' : 'flex'; }
    document.getElementById('assistant-toggle').addEventListener('click', toggleAssistant);
    
    document.getElementById('assistant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('assistant-input');
        const q = input.value.trim();
        const currentChannel = localStorage.getItem('activeChannel') || 'Twitch'; 
        
        if (!q) return;
        assistantMsgs.innerHTML += `<div class="msg user">${q}</div>`;
        input.value = '';
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
        const loaderId = 'loader-' + Date.now();
        assistantMsgs.innerHTML += `<div id="${loaderId}" class="msg bot">...</div>`;
        
        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ q, context: currentChannel }) 
            });
            const data = await res.json();
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class="msg bot">${data.html_response || "D√©sol√©, probl√®me IA ou r√©ponse bloqu√©e."}</div>`;
        } catch(err) { 
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class="msg bot" style="color:red;">Erreur connexion serveur.</div>`;
        }
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
    });

    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', function() {
        initializePlayer(); 
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        checkAuth();
    });
</script>
</body>
</html>
