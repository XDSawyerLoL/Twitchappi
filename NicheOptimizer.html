<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Streamer & Niche AI Hub - Ultimate Cockpit Dashboard">
<title>Streamer & Niche AI Hub - COCKPIT MASTER V55 (XP & EMOTES)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://embed.twitch.tv/embed/v1.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<style>
/* --- STYLES EXISTANTS --- */
:root{--color-bg-dark:#0d0d0d;--color-bg-medium:#1a1a1a;--color-bg-light:#111;--color-primary-pink:#ff0099;--color-secondary-blue:#22c7ef;--color-time-gold:#ffd700;--color-ai-niche:#59d682;--color-ai-repurpose:#9933ff;--color-ai-growth:#ffcc00;--color-ai-action:#e34a64;--color-text-dimmed:#9aa3a8;--color-border-dark:#2e2e2e;--color-border-medium:#333;--shadow-pink:0 0 15px rgba(255, 0, 153, 0.4);--shadow-blue:0 0 15px rgba(34, 199, 239, 0.4);--shadow-action:0 0 15px rgba(227, 74, 100, 0.4);}
body{background-color:var(--color-bg-dark);color:#fff;font-family:'Inter', Arial, sans-serif;margin:0;padding:0;overflow-x:hidden;}
#twitch-lucky-main{max-width:1400px;margin:20px auto;padding:10px;}
h1{font-family:'Orbitron', sans-serif;font-size:28px;color:var(--color-primary-pink);margin-bottom:5px;text-align:center;text-shadow:0 0 5px var(--color-primary-pink);}
.h1-blue-accent{color:var(--color-secondary-blue);}
.subtitle-center{color:var(--color-text-dimmed);font-size:12px;margin-bottom:25px;text-align:center;letter-spacing:1px;text-transform:uppercase;}
.tabs-nav-container{margin-bottom:20px;}
.flex-tabs{display:flex;gap:5px;flex-wrap:wrap;}
.tab-btn{font-family:'Orbitron', sans-serif;padding:15px 20px;background:var(--color-bg-light);border:1px solid var(--color-border-medium);border-bottom:none;color:var(--color-text-dimmed);cursor:pointer;border-radius:8px 8px 0 0;transition:all 0.3s ease;flex:1;text-align:center;font-size:12px;white-space:nowrap;font-weight:600;}
.tab-btn:hover{color:#fff;background:#232323;}
.tab-btn.active{background:var(--color-bg-medium);color:#fff;border-top:3px solid var(--color-primary-pink);font-weight:bold;box-shadow:var(--shadow-pink);z-index:10;position:relative;}
.player-wrapper{margin-bottom:25px;padding:0;background:var(--color-bg-medium);border-radius:12px;border:1px solid var(--color-border-dark);box-shadow:var(--shadow-blue);overflow:hidden;} 
.player-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:var(--color-bg-medium);border-bottom:1px solid var(--color-border-medium);}
.player-title{font-family:'Orbitron', sans-serif;font-size:20px;color:var(--color-secondary-blue);display:flex;align-items:center;gap:10px;}

/* --- STYLES SPLIT CHAT/VIDEO --- */
.player-split-container { display: flex; height: 600px; background: #000; }
.video-column { flex: 1; height: 100%; position: relative; border-right: 1px solid var(--color-border-dark); }
#twitch-embed { width: 100%; height: 100%; border:none; border-radius: 0; }
.chat-column { width: 340px; height: 100%; display: flex; flex-direction: column; background: var(--color-bg-light); flex-shrink: 0; }

.chat-tabs-header { display: flex; height: 40px; border-bottom: 1px solid var(--color-border-dark); }
.chat-tab-btn { flex: 1; background: #151515; border: none; color: #888; font-size: 11px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
.chat-tab-btn:hover { background: #222; color: white; }
.chat-tab-btn.active { background: var(--color-bg-medium); color: white; border-bottom: 2px solid var(--color-secondary-blue); }
.chat-view-container { flex: 1; position: relative; overflow: hidden; }
.chat-view { display: none; width: 100%; height: 100%; }
.chat-view.active { display: block; }

/* --- STYLES HUB CHAT (UPDATE AVATAR & EMOTES & XP) --- */
#hub-chat-interface { display: flex; flex-direction: column; height: 100%; background: #0e0e0e; }
#hub-points-display { padding: 8px 15px; background: linear-gradient(90deg, #111, #0a0a0a); border-bottom: 1px solid #333; font-size: 11px; color: var(--color-time-gold); display: flex; justify-content: space-between; align-items: center; font-family: 'Orbitron', sans-serif; }
#hub-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }

/* Nouveau Style Message avec Avatar */
.hub-msg-row { display: flex; gap: 10px; align-items: flex-start; }
.hub-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #333; object-fit: cover; flex-shrink: 0; }
.hub-msg-content { background: #1a1a1a; padding: 8px 12px; border-radius: 0 10px 10px 10px; font-size: 13px; border-left: 2px solid var(--color-border-medium); word-wrap: break-word; line-height: 1.4; flex-grow: 1; }
.hub-msg-row.user-me { flex-direction: row-reverse; }
.hub-msg-row.user-me .hub-msg-content { border-left-color: var(--color-primary-pink); background: #261019; border-radius: 10px 0 10px 10px; text-align: right; }
.hub-msg-row.user-me .hub-avatar { border-color: var(--color-primary-pink); }
.msg-author { font-size: 10px; color: #888; font-weight: bold; margin-bottom: 3px; display: block; text-transform: uppercase; }
.chat-emote { vertical-align: middle; height: 22px; display: inline-block; margin: 0 2px; }

/* Barre d'√©motes */
.emote-bar { display: flex; gap: 5px; padding: 5px 10px; background: #151515; overflow-x: auto; border-top: 1px solid #333; }
.emote-btn { cursor: pointer; padding: 2px; border-radius: 4px; transition: 0.2s; background: transparent; border: none; }
.emote-btn:hover { background: rgba(255,255,255,0.1); }
.emote-btn img { height: 20px; }

.hub-msg.system { border-left: 3px solid var(--color-secondary-blue); font-style: italic; color: #aaa; background: transparent; padding: 5px 10px; }
.hub-input-area { padding: 10px; border-top: 1px solid var(--color-border-dark); background: #111; display: flex; gap: 5px; }

/* --- FIN NOUVEAUX STYLES --- */

.player-quick-input{background:var(--color-bg-dark);border:1px solid var(--color-border-medium);color:white;padding:8px 12px;border-radius:4px;font-size:13px;width:220px;transition:border-color 0.3s;}
.player-quick-input:focus{border-color:var(--color-secondary-blue);outline:none;}
.btn-cycle{background:var(--color-bg-dark);color:var(--color-secondary-blue);border:1px solid var(--color-secondary-blue);padding:8px 15px;border-radius:4px;font-size:12px;transition:0.2s;cursor:pointer;}
.btn-cycle:hover:not(:disabled){background:var(--color-secondary-blue);color:var(--color-bg-dark);}
.btn-cycle:disabled{opacity:0.5;cursor:not-allowed;border-color:#555;color:#555;}
.tab-content{display:none;background:var(--color-bg-medium);border:1px solid var(--color-border-dark);border-radius:10px;padding:25px;min-height:400px;}
.tab-content.active{display:block;animation:fadeEffect 0.4s ease-in-out;}
@keyframes fadeEffect{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
.sub-tab-btn{transition:all 0.3s;padding-bottom:8px;border-bottom:2px solid transparent;cursor:pointer;margin-right:20px;color:#888;font-weight:bold;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;}
.sub-tab-btn:hover{color:#fff;}
.active-sub{border-bottom:2px solid var(--color-secondary-blue);color:white;}
.hidden{display:none !important;}
.dashboard-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;margin-top:25px;}
.dashboard-box{background:#0a0a0a;border:1px solid var(--color-border-dark);border-radius:8px;padding:20px;min-height:300px;display:flex;flex-direction:column;transition:transform 0.2s;}
.dashboard-box:hover{transform:translateY(-2px);}
.box-stats{border-top:3px solid var(--color-secondary-blue);box-shadow:var(--shadow-blue);}
.box-niche{border-top:3px solid var(--color-ai-niche);box-shadow:0 0 10px rgba(89, 214, 130, 0.2);}
.box-vod{border-top:3px solid var(--color-ai-repurpose);box-shadow:0 0 10px rgba(153, 51, 255, 0.2);}
.dashboard-title{font-family:'Orbitron', sans-serif;font-size:16px;margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:10px;letter-spacing:1px;}
.ai-output-enhanced{color:#ddd;font-size:14px;line-height:1.6;}
.ai-output-enhanced h4{font-family:'Orbitron', sans-serif;margin-top:20px;margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);color:var(--color-secondary-blue);font-size:14px;}
.ai-output-enhanced ul{list-style:none;padding-left:5px;}
.ai-output-enhanced li{margin-bottom:8px;border-left:3px solid #444;padding-left:12px;background:rgba(255,255,255,0.02);padding-top:4px;padding-bottom:4px;}
.box-niche .ai-output-enhanced li{border-left-color:var(--color-ai-niche);}
.box-schedule .ai-output-enhanced li{border-left-color:var(--color-time-gold);}
.action-input{width:100%;padding:12px;border-radius:6px;border:1px solid var(--color-border-medium);background:var(--color-bg-dark);color:#fff;font-size:14px;transition:0.3s; z-index: 100 !important; position: relative;}
.action-input:focus{border-color:var(--color-secondary-blue);outline:none;box-shadow:0 0 5px rgba(34, 199, 239, 0.3);}
.btn-primary{background:var(--color-primary-pink);color:#fff;border:0;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:700;text-transform:uppercase;font-size:12px;transition:all 0.2s;letter-spacing:1px;}
.btn-primary:hover:not(:disabled){transform:scale(1.02);filter:brightness(1.1);box-shadow:var(--shadow-pink);}
.btn-big-scan{width:100%;background:linear-gradient(90deg, var(--color-secondary-blue), var(--color-ai-repurpose));font-size:14px;padding:15px;margin-top:15px;}
#followed-streams-list{display:flex;flex-wrap:wrap;gap:15px;}
.followed-stream-item{width:calc(20% - 12px);min-width:160px;padding:10px;background:var(--color-bg-light);border-radius:8px;border:1px solid var(--color-border-dark);cursor:pointer;transition:0.3s;}
.followed-stream-item:hover{transform:translateY(-5px);border-color:var(--color-primary-pink);box-shadow:0 5px 15px rgba(0,0,0,0.5);}
.followed-stream-item img{width:100%;border-radius:6px;margin-bottom:8px;aspect-ratio:16/9;object-fit:cover;}
.raid-target-box{padding:20px;background:#111;border-radius:8px;border:2px solid var(--color-ai-action);display:flex;gap:20px;align-items:center;box-shadow:var(--shadow-action);}
.raid-target-box img{width:120px;height:68px;object-fit:cover;border-radius:6px;}
.schedule-box{border:2px solid var(--color-time-gold);padding:20px;background:#121212;border-radius:8px;margin-top:20px;box-shadow:0 0 15px rgba(255, 215, 0, 0.2);}
.schedule-header{color:var(--color-time-gold);font-family:'Orbitron', sans-serif;font-size:20px;margin-bottom:10px;}
.kpi-card{background:#111;padding:20px;border-radius:8px;border-left:4px solid #333;box-shadow:0 4px 6px rgba(0,0,0,0.5);position:relative;transition:background 0.3s;}
.kpi-card:hover{background:#151515;}
.kpi-value{font-size:28px;font-weight:800;color:white;font-family:'Orbitron', sans-serif;line-height:1.2;}
.kpi-label{font-size:11px;color:#888;text-transform:uppercase;margin-top:5px;letter-spacing:1px;}
.loading-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;border-radius:8px;display:none;z-index:5;}
.stars{color:#333;font-size:16px;margin-top:8px;}
.stars .filled{color:#ffd700;text-shadow:0 0 8px rgba(255, 215, 0, 0.6);}
@media (max-width:1024px){
    .dashboard-grid{grid-template-columns:1fr;}
    .followed-stream-item{width:calc(50% - 10px);}
    .kpi-card{padding:15px;}.kpi-value{font-size:20px;}
    .player-split-container { flex-direction: column; height: auto; }
    .video-column { height: 300px; width: 100%; }
    .chat-column { width: 100%; height: 450px; border-left: none; border-top: 1px solid var(--color-border-dark); }
}
</style>
</head>
<body>
<div id="twitch-lucky-main">
<h1 class="text-3xl">
<span class="h1-blue-accent">STREAMER</span> HUB V55 <span style="font-size:14px; vertical-align:middle; background:#222; padding:2px 6px; border-radius:4px;">XP & EMOTES</span>
</h1>
<div class="subtitle-center">Cockpit Unifi√© ‚Ä¢ Donn√©es R√©elles ‚Ä¢ Intelligence Artificielle ‚Ä¢ Rotation 3min</div>
<div class="tabs-nav-container">
<div class="flex flex-wrap flex-tabs">
<button class="tab-btn active" data-tab-id="tab-followed" onclick="openTab('tab-followed')">
<i class="fas fa-key mr-2"></i> MON FIL
</button>
<button class="tab-btn" data-tab-id="tab-dashboard" onclick="openTab('tab-dashboard')" style="color:white; border-top: 3px solid var(--color-secondary-blue);">
<i class="fas fa-chart-line mr-2"></i> DASHBOARD
</button>
<button class="tab-btn" data-tab-id="tab-time" onclick="openTab('tab-time')" style="border-top: 3px solid var(--color-time-gold);">
<i class="fas fa-clock mr-2"></i> BEST TIME
</button>
<button class="tab-btn" data-tab-id="tab-boost" onclick="openTab('tab-boost')">
<i class="fas fa-bolt mr-2"></i> BOOST
</button>
<button class="tab-btn" data-tab-id="tab-raid" onclick="openTab('tab-raid')" style="border-top: 3px solid var(--color-ai-action);">
<i class="fas fa-users mr-2"></i> RAID
</button>
</div>
</div>

<div class="player-wrapper">
    <div class="player-header">
        <h2 class="player-title">
            <span style="margin-right:8px;"><i class="fab fa-twitch"></i></span> LECTEUR
            <span id="player-channel-status" style="font-size:12px; color:#888; margin-left:15px; font-weight:normal;">En attente de connexion...</span>
        </h2>
        <div class="flex gap-2 items-center">
            <button id="btn-prev-stream" class="btn-cycle" onclick="cycleStream('prev')" disabled title="Cha√Æne pr√©c√©dente"><i class="fas fa-arrow-left"></i></button>
            <button id="btn-next-stream" class="btn-cycle" onclick="cycleStream('next')" disabled title="Cha√Æne suivante"><i class="fas fa-arrow-right"></i></button>
            <form id="mini-player-form" class="flex gap-2" onsubmit="event.preventDefault(); launchPlayer(document.getElementById('input-channel').value)">
                <input id="input-channel" type="text" placeholder="Cha√Æne..." class="player-quick-input">
                <button type="submit" class="btn-primary" style="padding: 5px 15px;">GO</button>
            </form>
        </div>
    </div>
    
    <div class="player-split-container">
        <div class="video-column">
            <div id="twitch-embed"></div>
        </div>
        <div class="chat-column">
            <div class="chat-tabs-header">
                <button class="chat-tab-btn active" onclick="switchChatTab('twitch', this)"><i class="fab fa-twitch text-purple-400"></i> TWITCH</button>
                <button class="chat-tab-btn" onclick="switchChatTab('hub', this)"><i class="fas fa-globe text-blue-400"></i> HUB</button>
            </div>
            
            <div class="chat-view-container">
                <div id="chat-view-twitch" class="chat-view active">
                    <iframe id="chat-embed-frame" src="" scrolling="no" width="100%" height="100%" frameborder="0"></iframe>
                </div>
                
                <div id="chat-view-hub" class="chat-view">
                    <div id="hub-chat-interface">
                        <div id="hub-points-display">
                            <div class="flex items-center gap-2">
                                <img id="hub-current-avatar" src="https://ui-avatars.com/api/?name=Invit√©" class="w-6 h-6 rounded-full border border-gray-500">
                                <span id="hub-username" class="font-bold text-white">Invit√©</span>
                            </div>
                            <span><i class="fas fa-star text-yellow-500 mr-1"></i> <span id="hub-user-points">0</span> XP</span>
                        </div>
                        <div id="hub-messages">
                            <div class="hub-msg system">Connectez-vous pour rejoindre le Hub Chat et gagner de l'XP !</div>
                        </div>
                        
                        <div class="emote-bar">
                            <button class="emote-btn" onclick="addEmote('Kappa')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/25/default/dark/1.0"></button>
                            <button class="emote-btn" onclick="addEmote('PogChamp')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/88/default/dark/1.0"></button>
                            <button class="emote-btn" onclick="addEmote('Kreygasm')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/41/default/dark/1.0"></button>
                            <button class="emote-btn" onclick="addEmote('LUL')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/425618/default/dark/1.0"></button>
                            <button class="emote-btn" onclick="addEmote('HeyGuys')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/30259/default/dark/1.0"></button>
                            <button class="emote-btn" onclick="addEmote(':)')"><img src="https://static-cdn.jtvnw.net/emoticons/v2/1/default/dark/1.0"></button>
                        </div>

                        <form class="hub-input-area" onsubmit="sendHubMessage(event)">
                            <input id="hub-input-msg" type="text" placeholder="Message..." class="action-input" style="padding:8px;">
                            <button type="submit" class="btn-primary" style="padding: 8px 12px; background:var(--color-secondary-blue);"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="content-area">
<div id="tab-followed" class="tab-content active">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
<h3 class="text-pink font-bold text-lg" style="color:var(--color-primary-pink);">
<i class="fas fa-circle text-red-500 mr-2 animate-pulse"></i> Vos Cha√Ænes Suivies LIVE
</h3>
<div class="flex gap-2 items-center">
<button id="btn-export-pdf" class="btn-primary" style="background:var(--color-ai-growth); font-size:10px;">
<i class="fas fa-file-csv mr-1"></i> CSV
</button>
<button id="btn-twitch-login" class="btn-primary" style="background:#6441a5; font-size:10px;">
<i class="fas fa-lock mr-1"></i> CONNEXION TWITCH
</button>
</div>
</div>
<div id="followed-streams-list">
<p style="color:#555; text-align:center; padding: 60px;">
<i class="fas fa-plug fa-3x mb-4"></i><br>
Connectez-vous pour voir vos favoris en direct.
</p>
</div>
</div>
<div id="tab-dashboard" class="tab-content">
<div id="dashboard-sub-nav" class="flex gap-6 border-b border-gray-800 mb-8 overflow-x-auto pb-2 text-[11px] font-bold uppercase tracking-wider text-gray-400">
<button onclick="showSubTab('overview', this)" class="sub-tab-btn active-sub">Overview</button>
<button onclick="showSubTab('games', this)" class="sub-tab-btn text-blue-400">üéÆ Games</button>
<button onclick="showSubTab('languages', this)" class="sub-tab-btn text-pink-400">üåç Languages</button>
<button onclick="showSubTab('scanner', this)" class="sub-tab-btn" style="color:var(--color-ai-niche);">üîç SCANNER & AUDIT</button>
</div>
<div id="sub-overview" class="sub-content">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
<div class="kpi-card" style="border-left-color: var(--color-secondary-blue);">
<div class="loading-overlay" id="load-kpi-1"><i class="fas fa-spin fa-spinner text-white text-2xl"></i></div>
<div id="val-total-viewers" class="kpi-value">...</div>
<div class="kpi-label">Total Viewers (Live)</div>
</div>
<div class="kpi-card" style="border-left-color: var(--color-ai-repurpose);">
<div class="loading-overlay" id="load-kpi-2"><i class="fas fa-spin fa-spinner text-white text-2xl"></i></div>
<div id="val-total-channels" class="kpi-value">...</div>
<div class="kpi-label">Total Channels</div>
</div>
<div class="kpi-card" style="border-left-color: var(--color-ai-niche);">
<div class="loading-overlay" id="load-kpi-3"><i class="fas fa-spin fa-spinner text-white text-2xl"></i></div>
<div id="val-top-game" class="kpi-value truncate text-xl">...</div>
<div class="kpi-label">Top Cat√©gorie</div>
</div>
<div class="kpi-card" style="border-left-color: var(--color-primary-pink);">
<div class="loading-overlay" id="load-kpi-4"><i class="fas fa-spin fa-spinner text-white text-2xl"></i></div>
<div id="val-uptime" class="kpi-value">En Ligne</div>
<div class="kpi-label">√âtat du Serveur</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
<div class="bg-[#0a0a0a] p-6 rounded-xl border border-gray-800" style="height:350px;">
<h4 class="text-xs font-bold text-gray-400 uppercase mb-6 flex justify-between">
<span>üìà Tendance Viewers (24h)</span>
<span class="text-blue-400">‚óè LIVE</span>
</h4>
<canvas id="liveStreamsChart"></canvas>
</div>
<div class="bg-[#0a0a0a] p-6 rounded-xl border border-gray-800" style="height:350px;">
<h4 class="text-xs font-bold text-gray-400 uppercase mb-6">üìä Canaux Actifs (Estimation)</h4>
<canvas id="yoyChannelsChart"></canvas>
</div>
</div>
</div>
<div id="sub-games" class="sub-content hidden">
<h3 class="text-blue-400 font-bold uppercase text-sm mb-6"><i class="fas fa-gamepad mr-2"></i> Top Games (Donn√©es R√©elles)</h3>
<div id="games-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
</div>
</div>
<div id="sub-languages" class="sub-content hidden">
<h3 class="text-pink-400 font-bold uppercase text-sm mb-6"><i class="fas fa-language mr-2"></i> Top Langues</h3>
<div id="languages-list-container" class="bg-[#0a0a0a] p-6 rounded-xl border border-gray-800 space-y-6">
</div>
</div>
<div id="sub-scanner" class="sub-content hidden">
<div style="text-align:center; margin-bottom:30px;">
<h3 class="text-blue-400 font-bold text-xl mb-3" style="color:var(--color-secondary-blue);">SCANNER D'INTELLIGENCE</h3>
<p class="text-gray-500 text-sm mb-6">Analyse compl√®te : Score 5 √âtoiles + Audit IA + Id√©es VOD</p>
<form id="form-global-scan" class="max-w-xl mx-auto">
<input id="input-global-target" type="text" placeholder="Entrez un Streamer (ex: Kamet0) ou un Jeu..." class="action-input" style="font-size:16px; text-align:center;">
<button type="submit" id="btn-global-scan" class="btn-primary btn-big-scan">
<i class="fas fa-radar mr-2"></i> LANCER LE SCAN
</button>
</form>
</div>
<div class="dashboard-grid">
<div id="res-scan-content" class="dashboard-box box-stats">
<div class="dashboard-title" style="color:var(--color-secondary-blue)">üìä PROFIL & SCORE</div>
<div class="flex flex-col items-center justify-center h-full text-gray-600">
<i class="fas fa-user-astronaut fa-3x mb-4"></i>
<p>En attente de scan...</p>
</div>
</div>
<div id="res-niche-content" class="dashboard-box box-niche">
<div class="dashboard-title" style="color:var(--color-ai-niche)">üß† CRITIQUE NICHE</div>
<div class="flex flex-col items-center justify-center h-full text-gray-600">
<i class="fas fa-brain fa-3x mb-4"></i>
<p>L'IA affichera l'audit ici.</p>
</div>
</div>
<div id="res-vod-content" class="dashboard-box box-vod">
<div class="dashboard-title" style="color:var(--color-ai-repurpose)">‚úÇÔ∏è VOD & CLIPS</div>
<div class="flex flex-col items-center justify-center h-full text-gray-600">
<i class="fas fa-cut fa-3x mb-4"></i>
<p>Analyse de contenu...</p>
</div>
</div>
</div>
</div>
</div>
<div id="tab-time" class="tab-content">
<h3 style="color:var(--color-time-gold); margin-bottom:15px; font-size:18px; font-weight:bold;">
<i class="fas fa-hourglass-half mr-2"></i> OPTIMISATION DE L'HORAIRE
</h3>
<p style="color:#888; font-size:13px; margin-bottom:20px;">
L'IA analyse le ratio Viewers/Streamers actuel d'un jeu et pr√©dit les meilleurs cr√©neaux horaires pour maximiser votre visibilit√©.
</p>
<form id="form-schedule" class="flex gap-3">
<input id="input-schedule-game" type="text" placeholder="Nom du jeu (ex: League of Legends)" class="action-input" style="flex-grow:1;">
<button type="submit" id="btn-schedule" class="btn-primary" style="background:var(--color-time-gold); color:#000;">
CALCULER
</button>
</form>
<div id="schedule-results" style="display:none;" class="schedule-box box-schedule">
<div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
<img id="schedule-img" src="" style="width:60px; border-radius:6px; border:1px solid #444;">
<div class="schedule-header" id="schedule-game-name">Jeu</div>
</div>
<div id="schedule-ai-content" class="ai-output-enhanced"></div>
</div>
</div>
<div id="tab-boost" class="tab-content">
<h3 style="color:var(--color-primary-pink); margin-bottom:15px; font-size:18px; font-weight:bold;">
<i class="fas fa-rocket mr-2"></i> STREAM BOOST (15 Minutes)
</h3>
<p style="color:#888; font-size:13px; margin-bottom:20px;">
Force l'affichage de votre cha√Æne sur tous les lecteurs connect√©s au Hub.
</p>
<form id="form-boost" class="flex gap-3">
<input id="input-boost" type="text" placeholder="Votre Cha√Æne Twitch" class="action-input" style="flex-grow:1;">
<button type="submit" class="btn-primary" style="background:var(--color-primary-pink);">
ACTIVER LE BOOST
</button>
</form>
<div id="boost-results" style="margin-top:20px; padding:15px; background:#111; border-radius:6px; min-height:60px; display:flex; align-items:center; justify-content:center;">
<p style="color:#777;">En attente d'activation...</p>
</div>
</div>
<div id="tab-raid" class="tab-content">
<h3 style="color:var(--color-ai-action); margin-bottom:15px; font-size:18px; font-weight:bold;">
<i class="fas fa-bullhorn mr-2"></i> RAID FINDER (FR)
</h3>
<p style="color:#888; font-size:13px; margin-bottom:20px;">
Trouvez la meilleure cible francophone pour votre raid selon la taille de l'audience.
</p>
<form id="form-raid" class="flex gap-3 flex-col sm:flex-row">
<input id="input-raid-game" type="text" placeholder="Jeu cible (Ex: Minecraft)" class="action-input" style="flex-grow:1;">
<select id="select-raid-viewers" class="action-input" style="width:auto;">
<option value="10">Max 10 Vues (Micro)</option>
<option value="30">Max 30 Vues (Petit)</option>
<option value="50">Max 50 Vues (Moyen)</option>
<option value="70">Max 70 Vues (Inter)</option>
<option value="100" selected>Max 100 Vues (Gros)</option>
</select>
<button type="submit" id="btn-start-raid" class="btn-primary" style="background:var(--color-ai-action);">
RECHERCHER
</button>
</form>
<div id="raid-results" style="margin-top:20px; padding:20px; border:1px solid var(--color-ai-action); border-radius:6px; min-height:80px;">
<p style="text-align:center; color:#777; margin-top:10px;">Les r√©sultats s'afficheront ici.</p>
</div>
</div>
</div>
</div>
<script>
// --- CONFIGURATION ---
const API_BASE = window.location.origin; 
const DEFAULT_CHANNEL = 'twitch';
const AUTO_CYCLE_DURATION_MS = 3 * 60 * 1000;
let embed = null;
let autoCycleTimer = null;
let boostTimeout = null;
let isConnected = false;

// --- CONFIG FIREBASE (A REMPLIR IMPERATIVEMENT) ---
const firebaseConfig = {
    apiKey: "TA_CLE_API_ICI",
    authDomain: "TON_PROJET.firebaseapp.com",
    projectId: "TON_PROJET",
    storageBucket: "TON_PROJET.appspot.com",
    messagingSenderId: "TON_ID",
    appId: "TON_APP_ID"
};
let db = null;
let currentUserData = { login: 'guest', display_name: 'Invit√©', avatar: 'https://ui-avatars.com/api/?name=Invit√©&background=random' };

// --- DICTIONNAIRE EMOTES ---
const EMOTES = {
    "Kappa": "https://static-cdn.jtvnw.net/emoticons/v2/25/default/dark/1.0",
    "PogChamp": "https://static-cdn.jtvnw.net/emoticons/v2/88/default/dark/1.0",
    "Kreygasm": "https://static-cdn.jtvnw.net/emoticons/v2/41/default/dark/1.0",
    "LUL": "https://static-cdn.jtvnw.net/emoticons/v2/425618/default/dark/1.0",
    "HeyGuys": "https://static-cdn.jtvnw.net/emoticons/v2/30259/default/dark/1.0",
    ":)": "https://static-cdn.jtvnw.net/emoticons/v2/1/default/dark/1.0"
};

function parseText(text) {
    let newText = text;
    for (const [key, url] of Object.entries(EMOTES)) {
        const regex = new RegExp(`\\b${key}\\b`, 'g');
        newText = newText.replace(regex, `<img src="${url}" class="chat-emote" title="${key}">`);
    }
    return newText;
}

function addEmote(code) {
    const input = document.getElementById('hub-input-msg');
    input.value += (input.value ? ' ' : '') + code;
    input.focus();
}

function initFirebase() {
    if(!firebase.apps.length) {
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            listenToMessages();
            listenToXP(); // Lancement √©coute XP
        } catch(e) { console.error("Firebase err:", e); }
    }
}

// --- GESTION ONGLETS ---
function openTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if (tabId === 'tab-followed') {
        if(isConnected) loadFollowedStreams();
        else document.getElementById('followed-streams-list').innerHTML = '<p style="color:#777; padding:40px; text-align:center;">Veuillez vous connecter.</p>';
    }
    if (tabId === 'tab-dashboard') loadDashboardData();
}

function switchChatTab(type, btn) {
    document.querySelectorAll('.chat-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.chat-view').forEach(v => v.classList.remove('active'));
    document.getElementById('chat-view-' + type).classList.add('active');
}

// --- LOGIQUE CHAT (XP + ENVOI + AVATAR) ---
async function sendHubMessage(e) {
    e.preventDefault();
    const input = document.getElementById('hub-input-msg');
    const text = input.value.trim();
    if(!text) return;
    if(!db) { alert("Erreur: Firebase non connect√©. V√©rifiez les cl√©s API."); return; }
    
    try {
        // 1. Sauvegarde Message
        await db.collection("hub_messages").add({
            text: text,
            user: currentUserData.display_name,
            login: currentUserData.login,
            avatar: currentUserData.avatar,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. Ajout XP
        if(currentUserData.login !== 'guest') {
            const userRef = db.collection('users').doc(currentUserData.login);
            await userRef.set({
                username: currentUserData.display_name,
                avatar: currentUserData.avatar,
                xp: firebase.firestore.FieldValue.increment(10), // +10 XP
                last_active: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        input.value = '';
    } catch(err) { console.error("Erreur envoi:", err); alert("Echec envoi message."); }
}

function listenToMessages() {
    if(!db) return;
    db.collection("hub_messages").orderBy("timestamp", "asc").limitToLast(50).onSnapshot((snapshot) => {
        const container = document.getElementById('hub-messages');
        container.innerHTML = '';
        snapshot.forEach((doc) => {
            const data = doc.data();
            const isMe = data.login === currentUserData.login;
            const userAvatar = data.avatar || `https://ui-avatars.com/api/?name=${data.user}&background=random`;
            const processedText = parseText(data.text);

            const div = document.createElement('div');
            div.className = `hub-msg-row ${isMe ? 'user-me' : ''}`;
            div.innerHTML = `
                <img src="${userAvatar}" class="hub-avatar" alt="Avatar">
                <div class="hub-msg-content">
                    <span class="msg-author">${data.user}</span>
                    ${processedText}
                </div>`;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    });
}

function listenToXP() {
    if(!db || currentUserData.login === 'guest') return;
    db.collection('users').doc(currentUserData.login).onSnapshot((doc) => {
        if(doc.exists) {
            const data = doc.data();
            document.getElementById('hub-user-points').innerText = data.xp || 0;
        }
    });
}

function showSubTab(subName, btnElement) {
document.querySelectorAll('.sub-content').forEach(el => el.classList.add('hidden'));
const target = document.getElementById('sub-' + subName);
if(target) target.classList.remove('hidden');
document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active-sub'));
if(btnElement) btnElement.classList.add('active-sub');
if(subName === 'games') loadTopGames();
if(subName === 'languages') loadTopLanguages();
}

// --- DATA DASHBOARD ---
async function loadDashboardData() {
initCharts();
try {
document.querySelectorAll('.loading-overlay').forEach(el => el.style.display = 'flex');
const res = await fetch(`${API_BASE}/api/stats/global`);
const data = await res.json();
if(data.success) {
document.getElementById('val-total-viewers').innerText = safeFormat(data.total_viewers);
document.getElementById('val-total-channels').innerText = safeFormat(data.total_channels);
document.getElementById('val-top-game').innerText = data.top_game_name;
document.getElementById('val-uptime').innerText = data.uptime || "Online";
if(data.history) updateCharts(data.history);
}
} catch(e) {} finally {
document.querySelectorAll('.loading-overlay').forEach(el => el.style.display = 'none');
}
}
async function loadTopGames() {
const container = document.getElementById('games-list-container');
container.innerHTML = "<p class='text-gray-500'>Chargement...</p>";
try {
const res = await fetch(`${API_BASE}/api/stats/top_games`);
const data = await res.json();
if(data.games) {
container.innerHTML = data.games.map((g, i) => `
<div class="flex items-center gap-3 bg-[#111] p-3 rounded border border-gray-800">
<span class="text-gray-500 font-bold w-6 text-center text-lg">#${i+1}</span>
<img src="${g.box_art_url.replace('{width}','52').replace('{height}','72')}" class="w-10 rounded">
<div class="flex-grow"><div class="font-bold text-sm text-white">${g.name}</div></div>
</div>`).join('');
}
} catch(e) { container.innerHTML = "Erreur."; }
}
async function loadTopLanguages() {
const container = document.getElementById('languages-list-container');
try {
const res = await fetch(`${API_BASE}/api/stats/languages`);
const data = await res.json();
if(data.languages) {
container.innerHTML = data.languages.map(l => `
<div class="mb-3"><div class="flex justify-between text-[11px] mb-1 text-gray-300 font-bold"><span>${l.name}</span><span class="text-white">${l.percent}%</span></div><div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden"><div class="h-2 rounded-full bg-pink-600" style="width: ${l.percent}%;"></div></div></div>`).join('');
}
} catch(e) {}
}

let liveChart, yoyChart;
function initCharts() {
if(liveChart) return;
const ctxLive = document.getElementById('liveStreamsChart');
if(ctxLive) liveChart = new Chart(ctxLive, {type: 'line', data: {labels: [], datasets: [{data: [], borderColor: '#22c7ef', fill: true}]}, options: {responsive: true, plugins: { legend: { display: false } }, scales: {x: { display:false }, y: { display:false }}}});
}
function updateCharts(historyData) {
if(liveChart && historyData.live) {
liveChart.data.labels = historyData.live.labels;
liveChart.data.datasets[0].data = historyData.live.values;
liveChart.update();
}
}

async function runGlobalScan(query) {
const boxS = document.getElementById('res-scan-content');
const boxN = document.getElementById('res-niche-content');
const boxV = document.getElementById('res-vod-content');
boxS.innerHTML = "Scan...";
try {
const res = await fetch(`${API_BASE}/scan_target`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query }) });
const data = await res.json();
if(data.success && data.type === 'user') {
const u = data.user_data;
boxS.innerHTML = `<div class="text-center"><img src="${u.profile_image_url}" class="w-16 h-16 rounded-full mx-auto mb-2 border-2 border-blue-500"><b>${u.display_name}</b><br>${u.is_live?'üî¥ LIVE':'‚ö´ OFF'}</div>`;
runAIAnalysis('niche', `${u.display_name} | ${u.game_name}`, boxN);
}
} catch(e) { boxS.innerHTML = "Erreur"; }
}
document.getElementById('form-global-scan').addEventListener('submit', (e) => { e.preventDefault(); runGlobalScan(document.getElementById('input-global-target').value); });
async function runAIAnalysis(type, query, box) {
box.innerHTML = "IA...";
try {
const res = await fetch(`${API_BASE}/critique_ia`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type, query }) });
const data = await res.json();
box.innerHTML = `<div class="ai-output-enhanced">${data.html_response}</div>`;
} catch(e) { box.innerHTML = "Err IA"; }
}
const safeFormat = (val) => val ? Number(val).toLocaleString('fr-FR') : '-';

// --- PLAYER LOGIC (FIX MULTI-PARENTS) ---
window.launchPlayer = function(channelName, videoId = null) {
    if(!channelName) return;
    
    if (embed) {
        if(!videoId && embed.getChannel() !== channelName) embed.setChannel(channelName);
        else if(videoId && embed.getVideo() !== videoId) embed.setVideo(videoId);
    } else {
        document.getElementById('twitch-embed').innerHTML = '';
        const parents = ["localhost", "127.0.0.1", "justplayer.fr", "justplayerstreamhubpro.onrender.com"];
        if(window.location.hostname) parents.push(window.location.hostname);

        const config = { width: "100%", height: "100%", layout: "video", channel: channelName, parent: parents };
        if (videoId) { delete config.channel; config.video = videoId; }
        embed = new Twitch.Embed("twitch-embed", config);
    }

    const host = window.location.hostname || "localhost";
    let chatUrl = `https://www.twitch.tv/embed/${channelName}/chat?darkpopout&theme=dark`;
    chatUrl += `&parent=${host}`;
    if (host !== 'justplayer.fr') chatUrl += `&parent=justplayer.fr`;
    if (host !== 'localhost') chatUrl += `&parent=localhost`;

    document.getElementById('chat-embed-frame').src = chatUrl;
    document.getElementById('input-channel').value = channelName;
}

async function checkBoostAndPlay() {
if (autoCycleTimer) clearInterval(autoCycleTimer);
try {
const res = await fetch(`${API_BASE}/get_default_stream`);
const data = await res.json();
if (data.success) {
launchPlayer(data.channel);
document.getElementById('player-channel-status').innerText = data.message;
if (data.mode !== 'BOOST') autoCycleTimer = setInterval(() => cycleStream('next'), AUTO_CYCLE_DURATION_MS);
} else { launchPlayer(DEFAULT_CHANNEL); }
} catch(e) { launchPlayer(DEFAULT_CHANNEL); }
}
async function cycleStream(direction) {
try {
const res = await fetch(`${API_BASE}/cycle_stream`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ direction }) });
const data = await res.json();
if (data.success) { launchPlayer(data.channel); checkBoostAndPlay(); }
} catch(e) {}
}

// --- AUTH & AVATAR SYNC ---
function startAuth() { window.open(`${API_BASE}/twitch_auth_start`, 'twitch_login_popup', 'width=500,height=650'); }
window.addEventListener('message', (event) => { if (event.data === 'auth_success') window.location.reload(); });
async function checkAuthStatus() {
const btn = document.getElementById('btn-twitch-login');
try {
const res = await fetch(`${API_BASE}/twitch_user_status`);
const data = await res.json();
isConnected = data.is_connected;
if (isConnected) {
    // RECUPERATION AVATAR & UPDATE UI
    const avatarUrl = data.profile_image_url || `https://ui-avatars.com/api/?name=${data.display_name}&background=random`;
    currentUserData = { login: data.login || 'user', display_name: data.display_name, avatar: avatarUrl };
    
    document.getElementById('hub-username').innerText = data.display_name;
    document.getElementById('hub-current-avatar').src = avatarUrl;
    
    btn.innerHTML = `<i class="fas fa-check mr-1"></i> ${data.display_name}`;
    btn.style.background = '#0e7e0e';
    btn.onclick = async () => { if(confirm('D√©connecter?')) { await fetch(`${API_BASE}/twitch_logout`, {method:'POST'}); window.location.reload(); }};
    
    listenToXP(); // Lance l'√©couteur d'XP personnel
    if(document.getElementById('tab-followed').classList.contains('active')) loadFollowedStreams();
} else {
    btn.onclick = startAuth;
}
} catch (e) {}
}
async function loadFollowedStreams() {
const list = document.getElementById('followed-streams-list');
if (!isConnected) return;
list.innerHTML = "Chargement...";
try {
const res = await fetch(`${API_BASE}/followed_streams`);
const data = await res.json();
if (data.success && data.streams.length > 0) {
list.innerHTML = "";
data.streams.forEach(s => {
const thumb = s.thumbnail_url.replace('{width}', '320').replace('{height}', '180');
list.innerHTML += `<div class='followed-stream-item' onclick="launchPlayer('${s.user_login}')"><div class="relative"><img src="${thumb}"><div class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div></div><div class="mt-2"><div style="font-weight:bold; font-size:13px; color:white;">${s.user_name}</div></div></div>`;
});
} else { list.innerHTML = "Aucun live."; }
} catch(e) {}
}

document.getElementById('form-schedule').addEventListener('submit', async (e) => { e.preventDefault(); /* Logic kept */ });
document.getElementById('form-boost').addEventListener('submit', async (e) => { e.preventDefault(); const c = document.getElementById('input-boost').value; if(c) fetch(`${API_BASE}/stream_boost`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({channel:c})}).then(()=>checkBoostAndPlay(true)); });
document.getElementById('form-raid').addEventListener('submit', async (e) => { e.preventDefault(); /* Logic kept */ });
document.getElementById('btn-export-pdf').addEventListener('click', () => window.open(`${API_BASE}/export_csv`, '_blank'));

window.onload = () => {
initFirebase();
checkAuthStatus();
checkBoostAndPlay();
openTab('tab-followed');
};
</script>
</body>
</html>
