<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V65 - MASTER</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --color-bg-dark: #0d0d0d; --color-bg-medium: #1a1a1a; --color-bg-light: #111;
            --color-primary-pink: #ff0099; --color-secondary-blue: #22c7ef; --color-time-gold: #ffd700;
            --color-ai-niche: #59d682; --color-ai-repurpose: #9933ff;
            --shadow-pink: 0 0 15px rgba(255, 0, 153, 0.4);
        }
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        #twitch-lucky-main { max-width: 1600px; margin: 20px auto; padding: 10px; }
        
        h1 { font-family: 'Orbitron'; font-size: 28px; color: var(--color-primary-pink); text-align: center; text-shadow: 0 0 5px var(--color-primary-pink); }
        .subtitle-center { color: #888; font-size: 12px; text-align: center; letter-spacing: 1px; margin-bottom: 20px; }

        /* TABS */
        .flex-tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab-btn { font-family: 'Orbitron'; padding: 15px; background: #111; border: 1px solid #333; color: #888; flex: 1; cursor: pointer; transition: 0.3s; font-size: 12px; font-weight: bold; border-bottom: none; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: #1a1a1a; color: white; border-top: 3px solid var(--color-primary-pink); box-shadow: var(--shadow-pink); }

        /* PLAYER SPLIT */
        .player-wrapper { margin-bottom: 25px; padding: 20px; background: #1a1a1a; border-radius: 12px; border: 1px solid #2e2e2e; }
        .player-grid { display: grid; grid-template-columns: 1fr 350px; gap: 15px; height: 600px; }
        #twitch-embed { width: 100%; height: 100%; background: black; }

        /* CHAT */
        .chat-box { background: #0a0a0a; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-tabs { display: flex; border-bottom: 1px solid #333; background: #111; }
        .chat-tab { flex: 1; padding: 10px; font-size: 11px; font-weight: bold; text-align: center; cursor: pointer; color: #666; font-family: 'Orbitron'; }
        .chat-tab.active { color: white; background: #1a1a1a; border-bottom: 2px solid var(--color-secondary-blue); }
        .chat-content { flex: 1; position: relative; }
        #hub-ui { display: none; flex-direction: column; height: 100%; }
        #hub-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; font-family: 'Inter'; }
        #hub-msgs div { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px; }
        #hub-msgs img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #444; }
        #hub-input-area { padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px; background: #111; }

        /* CARDS & LISTS */
        .followed-stream-item { width: calc(20% - 12px); min-width: 160px; padding: 10px; background: #111; border: 1px solid #333; cursor: pointer; transition: 0.3s; border-radius: 8px; }
        .followed-stream-item:hover { transform: translateY(-5px); border-color: var(--color-primary-pink); }
        .followed-stream-item img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        
        .kpi-card { background: #111; padding: 20px; border-radius: 8px; border-left: 4px solid #333; }
        .kpi-value { font-size: 24px; font-weight: 800; font-family: 'Orbitron'; }
        
        .tab-content { display: none; background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .tab-content.active { display: block; animation: fade 0.4s; }
        @keyframes fade { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        
        .btn-primary { background: var(--color-primary-pink); padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 12px; }
        .btn-primary:hover { transform: scale(1.05); }
        .action-input { width: 100%; background: #0d0d0d; border: 1px solid #333; padding: 10px; color: white; border-radius: 4px; }

        @media (max-width: 1024px) { .player-grid { grid-template-columns: 1fr; height: auto; } .chat-box { height: 400px; } }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1>STREAMER HUB V65</h1>
    <div class="subtitle-center">Cockpit Unifié • Chat Global avec Avatars • Intelligence Artificielle</div>

    <div class="tabs-nav-container">
        <div class="flex-tabs">
            <button class="tab-btn active" onclick="openTab('tab-followed', this)">MON FIL</button> 
            <button class="tab-btn" onclick="openTab('tab-dashboard', this)">DASHBOARD</button>
            <button class="tab-btn" onclick="openTab('tab-tools', this)">OUTILS (Scan/Raid)</button>
        </div>
    </div>

    <div class="player-wrapper">
        <div class="player-header">
            <h2 class="font-bold text-blue-400">LECTEUR LIVE <span id="player-channel-status" class="text-gray-500 text-xs font-normal ml-2">Chargement...</span></h2>
            <div class="flex gap-2">
                <button onclick="cycleStream('prev')" class="bg-black border border-blue-500 text-blue-500 px-3 py-1 rounded hover:bg-blue-500 hover:text-black transition">PREV</button>
                <button onclick="cycleStream('next')" class="bg-black border-blue-500 text-blue-500 px-3 py-1 rounded hover:bg-blue-500 hover:text-black transition">NEXT</button>
            </div>
        </div>
        
        <div class="player-grid">
            <div id="twitch-embed"></div>
            
            <div class="chat-box">
                <div class="chat-tabs">
                    <div class="chat-tab" onclick="switchChat('twitch')" id="tab-c-twitch">STREAM</div>
                    <div class="chat-tab active" onclick="switchChat('hub')" id="tab-c-hub">HUB GLOBAL</div>
                </div>
                <div class="chat-content">
                    <iframe id="chat-frame" style="width:100%; height:100%; border:none; display:none;"></iframe>
                    <div id="hub-ui">
                        <div id="hub-msgs">
                            <div style="color:#666; font-style:italic;">Bienvenue sur le Chat Global !</div>
                        </div>
                        <div id="hub-input-area">
                            <input type="text" id="hub-in" placeholder="Message..." class="flex-1 bg-black border border-gray-700 p-2 rounded text-white text-sm">
                            <button onclick="sendMsg()" class="bg-blue-500 px-4 rounded text-black font-bold">➤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="content-area">
        
        <div id="tab-followed" class="tab-content active">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-pink-500 font-bold">CHAÎNES SUIVIES</h3>
                <button id="btn-twitch-login" class="bg-purple-700 px-4 py-2 rounded text-xs font-bold hover:bg-purple-600 transition">CONNEXION TWITCH</button>
            </div>
            <div id="followed-streams-list" class="flex flex-wrap gap-4">
                <p class="text-gray-500 p-10 w-full text-center">Connectez-vous pour voir vos favoris.</p>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="kpi-card"><div id="val-viewers" class="kpi-value">...</div><div class="kpi-label">Viewers</div></div>
                <div class="kpi-card"><div id="val-channels" class="kpi-value">...</div><div class="kpi-label">Channels</div></div>
                <div class="kpi-card"><div id="val-game" class="kpi-value text-lg">...</div><div class="kpi-label">Top Game</div></div>
                <div class="kpi-card"><div class="kpi-value text-green-400">OK</div><div class="kpi-label">Serveur</div></div>
            </div>
            <div class="bg-black p-4 rounded border border-gray-800 h-64">
                <canvas id="liveChart"></canvas>
            </div>
        </div>

        <div id="tab-tools" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="bg-black p-5 rounded border border-blue-900">
                    <h3 class="text-blue-400 font-bold mb-4">SCANNER & VOD</h3>
                    <form id="form-scan" class="flex gap-2 mb-4">
                        <input id="input-scan" type="text" placeholder="Pseudo..." class="action-input">
                        <button type="submit" class="btn-primary">GO</button>
                    </form>
                    <div id="res-scan" class="text-center text-gray-500 text-sm p-4 border border-gray-800 rounded min-h-[150px]">En attente...</div>
                    <div id="res-vod" class="mt-4"></div>
                </div>

                <div class="bg-black p-5 rounded border border-red-900">
                    <h3 class="text-red-400 font-bold mb-4">RAID FINDER</h3>
                    <form id="form-raid" class="flex gap-2 mb-4">
                        <input id="input-raid" type="text" placeholder="Jeu..." class="action-input">
                        <button type="submit" class="btn-primary">GO</button>
                    </form>
                    <div id="res-raid" class="min-h-[150px]"></div>
                </div>

                <div class="bg-black p-5 rounded border border-purple-900">
                    <h3 class="text-purple-400 font-bold mb-4">BOOST</h3>
                    <form id="form-boost" class="flex gap-2 mb-4">
                        <input id="input-boost" type="text" placeholder="Chaîne..." class="action-input">
                        <button type="submit" class="btn-primary">ACTIVER</button>
                    </form>
                    <div id="res-boost" class="text-gray-500 text-center text-sm">Boostez votre visibilité.</div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
    const API = window.location.origin;
    let embed, autoTimer, myPseudo = "Guest", myAvatar = "https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-70x70.png";
    let isConnected = false;

    // --- SOCKET.IO ---
    const socket = io();
    const chatMsgs = document.getElementById('hub-msgs');

    socket.on('chat_message', m => addMsg(m));
    socket.on('history', h => h.forEach(m => addMsg(m)));

    function switchChat(t) {
        document.getElementById('tab-c-twitch').className = t==='twitch'?'chat-tab active':'chat-tab';
        document.getElementById('tab-c-hub').className = t==='hub'?'chat-tab active':'chat-tab';
        document.getElementById('chat-frame').style.display = t==='twitch'?'block':'none';
        document.getElementById('hub-ui').style.display = t==='hub'?'flex':'none';
        if(t==='hub') chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }
    
    function sendMsg() {
        const i = document.getElementById('hub-in');
        if(!i.value) return;
        socket.emit('send_message', { user: myPseudo, text: i.value, avatar: myAvatar });
        i.value = "";
    }
    document.getElementById('hub-in').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMsg(); });
    
    function addMsg(data) {
        const d = document.createElement('div');
        d.innerHTML = `<img src="${data.avatar}"><div><span style="color:${data.user===myPseudo?'#00ffcc':'#ff00ff'}; font-weight:bold; font-size:12px;">${data.user}</span><div style="color:#ddd;">${data.text}</div></div>`;
        chatMsgs.appendChild(d);
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }

    // --- PLAYER (FIX JUSTPLAYER) ---
    window.launchPlayer = function(c, vid=null) {
        document.getElementById('twitch-embed').innerHTML = '';
        // AJOUT DE justplayer.fr DANS LES PARENTS
        const parents = ["localhost", "127.0.0.1", "justplayer.fr", window.location.hostname];
        const opts = { width: "100%", height: "100%", layout: "video", parent: parents };
        if(vid) opts.video = vid; else opts.channel = c;
        embed = new Twitch.Embed("twitch-embed", opts);
        document.getElementById('chat-frame').src = `https://www.twitch.tv/embed/${c}/chat?parent=${window.location.hostname}&darkpopout`;
    }

    async function checkRot() {
        const d = await fetch(`${API}/get_default_stream`).then(r=>r.json());
        if(d.success) {
            launchPlayer(d.channel);
            document.getElementById('player-channel-status').innerText = d.message;
            if(d.mode !== 'BOOST') autoTimer = setInterval(() => cycle('next'), 180000);
        }
    }
    async function cycle(dir) { 
        await fetch(`${API}/cycle_stream`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ direction: dir }) });
        checkRot(); 
    }

    // --- LOGIC TABS ---
    window.openTab = function(id, el) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        if(id === 'tab-dashboard') loadStats();
        if(id === 'tab-followed') loadFollow();
    }

    // --- DATA & TOOLS ---
    async function loadStats() {
        const d = await fetch(`${API}/api/stats/global`).then(r=>r.json());
        document.getElementById('val-viewers').innerText = d.total_viewers;
        document.getElementById('val-channels').innerText = d.total_channels;
        document.getElementById('val-game').innerText = d.top_game_name;
        // Simple Chart
        new Chart(document.getElementById('liveChart'), { type:'line', data:{labels:d.history.live.labels, datasets:[{data:d.history.live.values, borderColor:'#22c7ef', fill:false}]}, options:{maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}} });
    }

    // SCANNER & VOD FIX
    document.getElementById('form-scan').addEventListener('submit', async(e)=>{
        e.preventDefault(); 
        const q = document.getElementById('input-scan').value;
        const box = document.getElementById('res-scan');
        box.innerHTML = "Scan...";
        
        const res = await fetch(`${API}/scan_target`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q}) }).then(r=>r.json());
        if(res.success && res.type === 'user') {
            const u = res.user_data;
            box.innerHTML = `
                <div class="flex items-center gap-4 text-left">
                    <img src="${u.profile_image_url}" class="w-16 h-16 rounded-full border-2 border-blue-500">
                    <div>
                        <div class="font-bold text-lg">${u.display_name}</div>
                        <div class="text-xs text-gray-400">${u.game_name}</div>
                        <div class="text-xs ${u.is_live?'text-green-400':'text-gray-600'}">${u.is_live?'LIVE':'OFFLINE'}</div>
                    </div>
                </div>`;
            
            // VOD FETCH
            const vRes = await fetch(`${API}/get_latest_vod?channel=${u.login}`).then(r=>r.json());
            if(vRes.success) {
                document.getElementById('res-vod').innerHTML = `
                    <div class="relative group cursor-pointer" onclick="launchPlayer('${u.login}', '${vRes.vod.id}')">
                        <img src="${vRes.vod.thumbnail_url}" class="w-full rounded border border-gray-700 opacity-80 hover:opacity-100 transition">
                        <div class="absolute bottom-2 left-2 bg-black/80 px-2 rounded text-xs">Dernière VOD</div>
                    </div>`;
            }
        } else box.innerHTML = "Non trouvé.";
    });

    // RAID FIX
    document.getElementById('form-raid').addEventListener('submit', async(e)=>{
        e.preventDefault();
        const res = await fetch(`${API}/start_raid`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({game:document.getElementById('input-raid').value, max_viewers:100}) }).then(r=>r.json());
        if(res.success) {
            document.getElementById('res-raid').innerHTML = `
                <div class="bg-[#111] p-3 rounded flex gap-3 items-center border border-green-900 mt-4">
                    <img src="${res.target.thumbnail_url}" class="w-24 rounded">
                    <div>
                        <div class="font-bold text-white">${res.target.name}</div>
                        <div class="text-xs text-green-400 font-bold">${res.target.viewers} viewers</div>
                    </div>
                    <button onclick="launchPlayer('${res.target.login}')" class="btn-primary ml-auto">GO</button>
                </div>`;
        } else document.getElementById('res-raid').innerHTML = "Rien trouvé.";
    });

    document.getElementById('form-boost').addEventListener('submit', async(e)=>{
        e.preventDefault();
        const r = await fetch(`${API}/stream_boost`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:document.getElementById('input-boost').value}) }).then(j=>j.json());
        document.getElementById('res-boost').innerText = r.html_response || "Fait.";
        checkRot();
    });

    // AUTH & LOAD FIX
    async function loadFollow() {
        const list = document.getElementById('followed-streams-list');
        if(!isConnected) return;
        list.innerHTML = "Chargement...";
        const res = await fetch(`${API}/followed_streams`).then(r=>r.json());
        if(res.success) {
            list.innerHTML = "";
            res.streams.forEach(s => {
                // FIX MINIATURES
                const thumb = s.thumbnail_url.replace('{width}', '320').replace('{height}', '180');
                list.innerHTML += `<div class="followed-stream-item" onclick="launchPlayer('${s.user_login}')"><img src="${thumb}"><div class="font-bold text-sm text-white mt-2">${s.user_name}</div><div class="text-xs text-gray-500">${s.game_name}</div></div>`;
            });
        }
    }

    async function checkAuth() {
        const d = await fetch(`${API}/twitch_user_status`).then(r=>r.json());
        isConnected = d.is_connected;
        const btn = document.getElementById('btn-twitch-login');
        if (isConnected) {
            btn.innerHTML = d.display_name;
            btn.style.backgroundColor = "#10b981"; // Vert
            myPseudo = d.display_name;
            if(d.profile_image_url) myAvatar = d.profile_image_url; // Avatar récupéré
        } else btn.onclick = () => window.open(`${API}/twitch_auth_start`, 'login', 'width=500,height=600');
    }
    window.addEventListener('message', (e) => { if(e.data === 'auth_success') window.location.reload(); });

    // INIT
    window.onload = () => { checkAuth(); checkRot(); openTab('tab-followed', document.querySelector('.tab-btn')); switchChat('hub'); };
</script>
</body>
</html>
