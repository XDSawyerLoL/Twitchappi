<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    // --- Configuration Globale ---
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 

    // --- Gestion des Onglets ---
    function openTab(tabId) {
        localStorage.setItem('activeTab', tabId);
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            const targetBtn = document.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
            if (targetBtn) targetBtn.classList.add('active');
        }
    }

    // --- Lecteur Twitch ---
    let embed = null;
    const twitchEmbedContainer = document.getElementById('twitch-embed');
    const inputChannel = document.getElementById('input-channel');

    function launchPlayer(channelName) {
        if (!channelName) return;

        localStorage.setItem('activeChannel', channelName);
        inputChannel.value = channelName;

        twitchEmbedContainer.innerHTML = '';
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: 550, 
            channel: channelName,
            layout: "video-and-chat", 
            autoplay: true,
            parent: [window.location.hostname] 
        });
        document.getElementById('player-channel-status').textContent = `Cha√Æne: ${channelName.toUpperCase()}`;
    }

    function initializePlayer() {
        const storedChannel = localStorage.getItem('activeChannel');
        const channelToLoad = storedChannel || DEFAULT_CHANNEL;
        launchPlayer(channelToLoad);
    }
    
    document.getElementById('form-channel-player').addEventListener('submit', (e) => {
        e.preventDefault();
        const channel = inputChannel.value.trim().toLowerCase();
        if(channel) {
            launchPlayer(channel);
        }
    });

    // --- Authentification Twitch et Fil Suivi ---
    const btnLogin = document.getElementById('btn-twitch-login');
    const loginStatus = document.getElementById('login-status');
    const followedStreamsList = document.getElementById('followed-streams-list');
    let twitchUserConnected = false; 

    async function checkAuth() {
        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            if(res.ok) {
                const data = await res.json();
                if(data.is_connected) {
                    twitchUserConnected = true;
                    loginStatus.innerHTML = `‚úÖ Connect√© en tant que <strong style="color:var(--color-secondary-blue)">${data.username}</strong>`;
                    btnLogin.textContent = "üîí D√âCONNEXION";
                    btnLogin.style.background = "#e34a64"; 
                    loadFollowedStreams(); 
                } else {
                    twitchUserConnected = false;
                    loginStatus.textContent = "Statut: D√©connect√©.";
                    btnLogin.textContent = "üîí SE CONNECTER VIA TWITCH";
                    btnLogin.style.background = "#6441a5"; 
                    followedStreamsList.innerHTML = '<p style="color:var(--color-ai-growth); text-align:center;">Veuillez vous connecter pour voir ceci.</p>';
                }
            } else {
                twitchUserConnected = false;
                loginStatus.innerHTML = `‚ùå Erreur API (${res.status}). Veuillez v√©rifier le serveur backend.`;
                followedStreamsList.innerHTML = '<p style="color:red; text-align:center;">Erreur de connexion au service Twitch.</p>';
            }
        } catch(e) {
            console.error("Erreur check auth:", e);
            twitchUserConnected = false;
            loginStatus.innerHTML = `‚ùå Erreur technique: ${e.message}.`;
            followedStreamsList.innerHTML = `<p style="color:red; text-align:center;">Erreur API: ${e.message}</p>`;
        }
    }

    btnLogin.addEventListener('click', () => {
        if(twitchUserConnected) {
            // NOTE: Le chemin twitch_logout doit √™tre POST. Si ce n'est pas le cas, cela doit √™tre corrig√© c√¥t√© backend.
            // Pour le frontend, on utilise la redirection pour l'exemple mais la m√©thode POST est meilleure.
            fetch(`${API_BASE}/twitch_logout`, { method: 'POST' }).then(() => {
                window.location.reload(); 
            });
        } else {
            window.location.href = `${API_BASE}/twitch_auth_start`;
        }
    });

    async function loadFollowedStreams() {
        if(!twitchUserConnected) {
            followedStreamsList.innerHTML = '<p style="color:var(--color-ai-growth); text-align:center;">Veuillez vous connecter pour voir ceci.</p>';
            return;
        }
        
        followedStreamsList.innerHTML = '<p style="text-align:center; color:#555;">Chargement des streams en direct...</p>';
        
        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            
            if(res.ok) {
                const data = await res.json();
                
                if(data.data && data.data.length > 0) {
                    followedStreamsList.innerHTML = ''; 
                    data.data.forEach(stream => {
                        const div = document.createElement('div');
                        div.className = 'followed-stream-item';
                        
                        const imageUrl = stream.thumbnail_url 
                                        ? stream.thumbnail_url.replace('{width}', '320').replace('{height}', '180') 
                                        : stream.profile_image_url || 'https://static-cdn.jtvnw.net/jtv_user_pictures/default_profile.png'; 

                        div.innerHTML = `
                            <img src="${imageUrl}" alt="Preview de ${stream.user_name}" class="streamer-avatar">
                            <div class="stream-details">
                                <span class="stream-name" title="${stream.user_name}">${stream.user_name}</span>
                                <div class="stream-meta">
                                    <span class="stream-viewers">üî¥ ${stream.viewer_count} spectateurs</span>
                                    <span class="stream-game" title="${stream.game_name}">${stream.game_name}</span>
                                </div>
                            </div>
                        `;

                        div.onclick = () => {
                            launchPlayer(stream.user_name);
                        };
                        followedStreamsList.appendChild(div);
                    });
                } else {
                    followedStreamsList.innerHTML = '<p style="text-align:center;">Aucun stream en direct parmi vos cha√Ænes suivies.</p>';
                }
            } else {
                followedStreamsList.innerHTML = `<p style="color:red; text-align:center;">Erreur chargement du fil (Statut: ${res.status}).</p>`;
            }
        } catch(e) {
            followedStreamsList.innerHTML = `<p style="color:red; text-align:center;">Erreur API: ${e.message}</p>`;
        }
    }


    // --- Logique de Scan Cible (CORRIG√â: Envoi de 'query' au lieu de 'target') ---
    document.getElementById('form-target').addEventListener('submit', async (e) => {
        e.preventDefault();
        const target = document.getElementById('input-target').value.trim();
        const resultBox = document.getElementById('scan-result');
        const placeholder = document.getElementById('scan-result-placeholder');
        const btn = document.getElementById('btn-target');

        if (!target) {
            placeholder.textContent = "Veuillez entrer un Jeu ou un Pseudo pour lancer le scan.";
            placeholder.classList.remove('hidden');
            resultBox.classList.add('hidden');
            return;
        }

        placeholder.classList.add('hidden');
        resultBox.classList.remove('hidden');
        resultBox.innerHTML = '<p style="text-align:center; color:var(--color-ai-growth);">üöÄ Scan de la cible en cours pour ' + target + '... (Appel API r√©el)</p>';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: target }) // <-- CORRIG√â
            });

            if(res.ok) {
                const data = await res.json();
                
                // Le backend renvoie maintenant un objet structur√©, pas html_results
                if (data.type === 'game') {
                    const gameData = data.game_data;
                    let streamsList = gameData.streams.map(s => `
                        <li>${s.user_name} (${s.viewer_count} spectateurs) - ${s.title}</li>
                    `).join('');

                    resultBox.innerHTML = `
                        <div class="p-4 border border-blue-500 rounded-lg mt-4" style="border-color:var(--color-secondary-blue);">
                            <h4 class="text-blue tab-heading">R√©sultat du Scan de Jeu: ${gameData.name}</h4>
                            <div class="flex items-center mb-4">
                                <img src="${gameData.box_art_url}" alt="${gameData.name}" class="w-20 h-auto rounded mr-4">
                                <div>
                                    <p><strong>Total Spectateurs:</strong> ${gameData.total_viewers}</p>
                                    <p><strong>Total Streamers:</strong> ${gameData.total_streamers}</p>
                                    <p><strong>Ratio V/S (Moyenne):</strong> <span class="text-pink">${gameData.avg_viewers_per_streamer}</span></p>
                                </div>
                            </div>
                            <h5 class="font-bold mt-3 text-pink">Top 10 Streams Actuels:</h5>
                            <ul class="list-disc ml-5 text-sm">${streamsList}</ul>
                        </div>
                    `;

                } else if (data.type === 'user') {
                    const userData = data.user_data;
                    resultBox.innerHTML = `
                        <div class="p-4 border border-blue-500 rounded-lg mt-4" style="border-color:var(--color-secondary-blue);">
                            <h4 class="text-blue tab-heading">R√©sultat du Scan d'Utilisateur: ${userData.display_name}</h4>
                            <div class="flex items-center mb-4">
                                <img src="${userData.profile_image_url}" alt="${userData.display_name}" class="w-20 h-20 rounded-full mr-4">
                                <div>
                                    <p><strong>Statut:</strong> ${userData.is_live ? '<span class="text-pink">üî¥ EN DIRECT</span>' : 'HORS LIGNE'}</p>
                                    <p><strong>Description:</strong> ${userData.description || 'Non fournie.'}</p>
                                    ${userData.is_live ? `<p><strong>Jeu:</strong> ${userData.stream_details.game_name} (${userData.stream_details.viewer_count} viewers)</p>` : ''}
                                </div>
                            </div>
                            <button class="btn-primary mt-2" onclick="launchPlayer('${userData.login}')">Regarder le Stream</button>
                        </div>
                    `;
                } else if (data.type === 'none') {
                    resultBox.innerHTML = `<p style="color:red; text-align:center;">${data.message}</p>`;
                } else {
                     resultBox.innerHTML = `<p style="color:red; text-align:center;">Format de r√©ponse API inattendu. Le backend ne renvoie pas un type connu.</p>`;
                }

            } else {
                let errorMsg = `Erreur lors de l'appel au service de Scan (Statut: ${res.status}).`;
                const errorData = await res.json();
                 if (errorData && errorData.error) {
                    errorMsg = `Erreur Backend: ${errorData.error}`;
                }
                resultBox.innerHTML = `<p style="color:red; text-align:center; font-weight: bold;">${errorMsg}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:red; text-align:center;">Erreur de connexion au service de Scan: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });


    // --- Logique d'interaction IA ---
    
    // 1. Analyse de Niche (CORRIG√â: Envoi de 'query' au lieu de 'game')
    document.getElementById('form-niche-analysis').addEventListener('submit', async (e) => {
        e.preventDefault();
        const game = document.getElementById('input-niche-game').value.trim();
        const resultBox = document.getElementById('niche-results');
        const container = document.getElementById('niche-result-container');
        const btn = document.getElementById('btn-niche-analyse');

        if (!game) return;

        container.style.display = 'block';
        resultBox.innerHTML = '<p style="color:var(--color-ai-niche);">Analyse IA de niche en cours pour ' + game + '... (Appel API r√©el)</p>';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: game, type: 'niche' }) // <-- CORRIG√â
            });

            if(res.ok) {
                const data = await res.json();
                resultBox.innerHTML = data.html_critique || data.error || '<p>R√©ponse IA re√ßue, mais le format est inattendu.</p>';
            } else {
                 const errorData = await res.json();
                resultBox.innerHTML = `<p style="color:red;">Erreur de l'API IA: ${res.status}. ${errorData.error || ''}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:red;">Erreur de connexion au service IA: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // 2. Repurposing (CORRIG√â: Envoi de 'query' au lieu de 'channel')
    document.getElementById('form-repurpose').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-repurpose-channel').value.trim();
        const resultBox = document.getElementById('repurpose-results');
        const container = document.getElementById('repurpose-result-container');
        const btn = document.getElementById('btn-repurpose-analyse');

        if (!channel) return;

        container.style.display = 'block';
        resultBox.innerHTML = `<p style="color:var(--color-ai-repurpose);">Analyse de VOD pour ${channel} en cours... (Appel API r√©el)</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: channel, type: 'repurpose' }) // <-- CORRIG√â
            });

            if(res.ok) {
                const data = await res.json();
                resultBox.innerHTML = data.html_critique || data.error || '<p>R√©ponse IA re√ßue, mais le format est inattendu.</p>';
            } else {
                 const errorData = await res.json();
                resultBox.innerHTML = `<p style="color:red;">Erreur de l'API Repurposing: ${res.status}. ${errorData.error || ''}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:red;">Erreur de connexion au service Repurposing: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // 3. Trend Detector
    document.getElementById('btn-trend-detector').addEventListener('click', async () => {
        const resultBox = document.getElementById('trend-results');
        const container = document.getElementById('trend-results');
        const btn = document.getElementById('btn-trend-detector');

        container.style.display = 'block';
        resultBox.innerHTML = `<p style="color:var(--color-ai-growth);">D√©tection des tendances en cours... (Appel API r√©el)</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: 'trend' })
            });

            if(res.ok) {
                const data = await res.json();
                resultBox.innerHTML = data.html_critique || data.error || '<p>R√©ponse IA re√ßue, mais le format est inattendu.</p>';
            } else {
                const errorData = await res.json();
                resultBox.innerHTML = `<p style="color:red;">Erreur de l'API Trend: ${res.status}. ${errorData.error || ''}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:red;">Erreur de connexion au service Trend: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // --- NOUVELLE LOGIQUE : Stream Boost (Avec Cooldown) ---
    document.getElementById('form-boost').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim();
        const resultContainer = document.getElementById('tab-boost');
        const btn = document.getElementById('btn-boost');

        if (!channel) {
             alert("Veuillez entrer une cha√Æne √† booster.");
             return;
        }

        // Ajoute un placeholder pour le message de boost
        let messagePlaceholder = resultContainer.querySelector('#boost-message');
        if (!messagePlaceholder) {
            messagePlaceholder = document.createElement('div');
            messagePlaceholder.id = 'boost-message';
            messagePlaceholder.style.marginTop = '15px';
            resultContainer.appendChild(messagePlaceholder);
        }

        messagePlaceholder.innerHTML = `<p style="color:var(--color-ai-growth);">üì§ Boost en cours de v√©rification pour ${channel}...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();
            
            if (res.ok) {
                // Succ√®s : le backend envoie la r√©ponse en HTML
                messagePlaceholder.innerHTML = data.html_response;
            } else {
                // √âchec (Cooldown 429 ou 400)
                messagePlaceholder.innerHTML = `<p style="color:red; font-weight:bold;">${data.error || 'Erreur inconnue du Boost.'}</p>`;
            }
        } catch(e) {
            messagePlaceholder.innerHTML = `<p style="color:red;">Erreur de connexion au service Boost: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', function() {
        initializePlayer();
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        checkAuth();
    });
</script>
