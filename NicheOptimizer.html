<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub - COCKPIT MODE (V22 - Ultimate)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-time-gold: #ffd700;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --shadow-pink: 0 0 15px rgba(255, 0, 153, 0.4);
            --shadow-blue: 0 0 15px rgba(34, 199, 239, 0.4);
        }

        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
        #twitch-lucky-main { max-width: 1400px; margin: 20px auto; padding: 10px; }
        
        h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: var(--color-primary-pink); text-align: center; text-shadow: 0 0 5px var(--color-primary-pink); }
        .h1-blue-accent { color: var(--color-secondary-blue); }
        .subtitle-center { color: var(--color-text-dimmed); font-size: 11px; text-align: center; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }

        .flex-tabs { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .tab-btn { font-family: 'Orbitron', sans-serif; padding: 12px 15px; background: var(--color-bg-light); border: 1px solid #333; color: var(--color-text-dimmed); cursor: pointer; border-radius: 8px 8px 0 0; transition: 0.3s; flex: 1; text-align: center; font-size: 10px; }
        .tab-btn.active { background: var(--color-bg-medium); color: #fff; border-top: 3px solid var(--color-primary-pink); box-shadow: var(--shadow-pink); font-weight: bold; }

        .player-wrapper { margin-bottom: 20px; padding: 15px; background: var(--color-bg-medium); border-radius: 12px; border: 1px solid #222; box-shadow: var(--shadow-blue); }
        #twitch-embed { width: 100%; height: 500px; border-radius: 8px; overflow: hidden; background: #000; }

        .tracker-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 11px; }
        .tracker-table th { color: #666; font-size: 8px; text-transform: uppercase; padding: 10px; text-align: left; }
        .tracker-table td { background: #111; padding: 12px; border-top: 1px solid #222; }
        .badge-rating { background: linear-gradient(45deg, var(--color-primary-pink), #9146FF); padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .dashboard-box { background: #0a0a0a; border: 1px solid #222; border-radius: 6px; padding: 15px; min-height: 250px; }
        .tab-content { display: none; background: var(--color-bg-medium); border: 1px solid #222; border-radius: 10px; padding: 20px; }
        .tab-content.active { display: block; }

        .btn-primary { background: var(--color-primary-pink); color: #fff; padding: 10px 15px; border-radius: 6px; font-weight: 600; font-size: 11px; transition: 0.2s; }
        .action-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #000; color: #fff; font-size: 13px; }
        
        .followed-stream-item { width: 18%; min-width: 160px; padding: 10px; background: #111; border-radius: 8px; border: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .followed-stream-item:hover { border-color: var(--color-primary-pink); transform: translateY(-3px); }
        .followed-stream-item img { width: 100%; border-radius: 4px; margin-bottom: 5px; }

        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } .followed-stream-item { width: 48%; } }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1><span class="h1-blue-accent">STREAMER</span> HUB COCKPIT V22</h1>
    <div class="subtitle-center">Cockpit Unifi√© ‚Ä¢ Intelligence Artificielle ‚Ä¢ Tracker Fusion</div>

    <div class="tabs-nav-container">
        <div class="flex-tabs">
            <button class="tab-btn active" data-tab-id="tab-followed" onclick="openTab('tab-followed')">üîë MON FIL LIVE</button> 
            <button class="tab-btn" data-tab-id="tab-tracker" onclick="openTab('tab-tracker')" style="border-top: 3px solid var(--color-secondary-blue);">üìà TRACKER OVERVIEW</button>
            <button class="tab-btn" data-tab-id="tab-dashboard" onclick="openTab('tab-dashboard')">üìä DASHBOARD & IA</button>
            <button class="tab-btn" data-tab-id="tab-boost" onclick="openTab('tab-boost')">‚ö° BOOST</button>
            <button class="tab-btn" data-tab-id="tab-raid" onclick="openTab('tab-raid')" style="border-top: 3px solid var(--color-ai-action);">üí• RAID</button>
        </div>
    </div>

    <div class="player-wrapper">
        <div class="flex justify-between items-center mb-3">
            <h2 class="orbitron text-xs text-blue-400 font-bold"><i class="fas fa-play mr-2"></i>FEED LECTEUR</h2>
            <div class="flex gap-2">
                <input id="input-channel" type="text" placeholder="Pseudo..." class="bg-black border border-gray-800 text-xs px-3 py-1 rounded w-32 outline-none">
                <button onclick="launchPlayer(document.getElementById('input-channel').value)" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold">GO</button>
            </div>
        </div>
        <div id="twitch-embed"></div>
    </div>

    <div id="content-area">
        <!-- Onglet 1: MON FIL (Prioritaire) -->
        <div id="tab-followed" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h3 style="color:var(--color-primary-pink);" class="font-bold">üî¥ Vos Favoris en Direct</h3>
                <button onclick="login()" id="btn-auth" class="btn-primary" style="background:#6441a5;">üîí CONNEXION TWITCH</button>
            </div>
            <div id="followed-streams-list" class="flex flex-wrap gap-4">
                <p class="w-full text-center py-20 text-gray-600 italic">Authentifiez-vous pour charger votre cockpit.</p>
            </div>
        </div>

        <!-- Onglet 2: TRACKER (TwitchTracker Style) -->
        <div id="tab-tracker" class="tab-content">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                <div class="bg-black p-4 rounded border-l-4 border-pink-500"><p class="text-[9px] text-gray-500 uppercase">Viewers</p><h3 id="stat-viewers" class="orbitron text-xl">--</h3></div>
                <div class="bg-black p-4 rounded border-l-4 border-purple-500"><p class="text-[9px] text-gray-500 uppercase">Channels</p><h3 id="stat-channels" class="orbitron text-xl">--</h3></div>
                <div class="bg-black p-4 rounded border-l-4 border-green-500"><p class="text-[9px] text-gray-500 uppercase">Watch Time</p><h3 class="orbitron text-xl">4.2M h</h3></div>
                <div class="bg-black p-4 rounded border-l-4 border-blue-500"><p class="text-[9px] text-gray-500 uppercase">Market Rating</p><h3 class="orbitron text-xl text-green-400">OPTIMAL</h3></div>
            </div>
            <div class="overflow-x-auto bg-black rounded border border-[#222]">
                <table class="tracker-table">
                    <thead>
                        <tr>
                            <th># Game</th><th>Unified Rating</th><th>Viewers</th><th>Channels</th><th>Hours Watched</th><th>Live</th><th>Peak Viewers</th><th>Peak Channels</th><th>Recommend</th>
                        </tr>
                    </thead>
                    <tbody id="tracker-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Onglet 3: DASHBOARD & COMPARATEUR -->
        <div id="tab-dashboard" class="tab-content">
            <div class="text-center mb-6 max-w-3xl mx-auto">
                <h3 class="orbitron text-blue-400 mb-2">ANALYSEUR COMPL√àTE & COMPARATEUR IA</h3>
                <div class="flex gap-2 items-center">
                    <input id="q1" type="text" placeholder="Sujet 1 (ex: Minecraft)" class="action-input">
                    <span class="font-bold text-gray-600">VS</span>
                    <input id="q2" type="text" placeholder="Sujet 2 (Optionnel)" class="action-input">
                    <button onclick="runIA()" class="btn-primary flex-shrink-0">LANCER L'IA</button>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="dashboard-box border-t-2 border-blue-500">
                    <div class="orbitron text-[10px] text-blue-500 mb-2">üìä M√âTRIQUES TRACKER</div>
                    <div id="box-metrics" class="text-xs text-gray-500 space-y-4">Scan en attente...</div>
                </div>
                <div class="dashboard-box border-t-2 border-pink-500">
                    <div class="orbitron text-[10px] text-pink-500 mb-2">üß† IA GROUNDING (LIVE)</div>
                    <div id="box-ia" class="ai-output-enhanced text-[11px]"></div>
                </div>
                <div class="dashboard-box border-t-2 border-purple-500">
                    <div class="orbitron text-[10px] text-purple-500 mb-2">‚úÇÔ∏è VOD & CLIPS</div>
                    <div id="box-vod" class="text-[11px] text-gray-500"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API = "https://justplayerstreamhubpro.onrender.com"; 
    const fs = (v) => (v !== undefined && v !== null) ? v.toLocaleString('fr-FR') : "0";

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const t = document.getElementById(id);
        const b = document.querySelector(`[data-tab-id="${id}"]`);
        if(t && b) { t.classList.add('active'); b.classList.add('active'); }
        if(id === 'tab-tracker') loadTracker();
        if(id === 'tab-followed') loadFollows();
    }

    function launchPlayer(channel) {
        if(!channel) return;
        document.getElementById('twitch-embed').innerHTML = '';
        new Twitch.Embed("twitch-embed", {
            width: "100%", height: "100%", channel,
            parent: [window.location.hostname, "justplayer.fr", "justplayerstreamhubpro.onrender.com"]
        });
        document.getElementById('input-channel').value = channel;
    }

    async function loadTracker() {
        const body = document.getElementById('tracker-body');
        body.innerHTML = '<tr><td colspan="9" class="text-center py-20"><i class="fas fa-spinner fa-spin text-pink-500 text-3xl"></i></td></tr>';
        try {
            const res = await fetch(`${API}/tracker_stats`);
            const data = await res.json();
            body.innerHTML = '';
            let tV = 0, tC = 0;
            data.games.forEach((g, i) => {
                tV += g.viewers; tC += g.channels;
                body.innerHTML += `
                    <tr>
                        <td><div class="flex items-center gap-3"><span>${i+1}</span><img src="${g.box_art}" class="w-8 h-10 rounded"><b>${g.name}</b></div></td>
                        <td><span class="badge-rating">${Math.round(g.rating)}</span></td>
                        <td class="font-bold">${fs(g.viewers)}</td>
                        <td class="text-gray-500">${fs(g.channels)}</td>
                        <td class="text-gray-500">${fs(g.watch_time)}h</td>
                        <td class="text-red-500 font-bold">LIVE</td>
                        <td class="text-gray-500">${fs(g.peak_viewers)}</td>
                        <td class="text-gray-500">${fs(g.peak_channels)}</td>
                        <td><span class="text-green-400 font-bold text-[10px]">ALGO PICK</span></td>
                    </tr>`;
            });
            document.getElementById('stat-viewers').innerText = (tV/1000).toFixed(1) + "K";
            document.getElementById('stat-channels').innerText = fs(tC);
        } catch(e) { body.innerHTML = '<tr><td colspan="9">Erreur stats.</td></tr>'; }
    }

    async function runIA() {
        const q1 = document.getElementById('q1').value;
        const q2 = document.getElementById('q2').value;
        const boxIA = document.getElementById('box-ia');
        const boxM = document.getElementById('box-metrics');
        if(!q1) return;
        boxIA.innerHTML = "<div class='text-center'><i class='fas fa-brain fa-spin text-pink-500 text-2xl'></i><br>Recherche Grounding...</div>";
        try {
            const sRes = await fetch(`${API}/scan_target`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({query:q1}) });
            const sData = await sRes.json();
            if(sData.success) {
                if(sData.type === 'user') boxM.innerHTML = `<div class="bg-blue-900/10 p-2 rounded"><b>${sData.user_data.display_name}</b><br>Followers: ${fs(sData.user_data.total_followers)}</div>`;
                else boxM.innerHTML = `<div class="bg-purple-900/10 p-2 rounded"><b>${sData.game_data.name}</b><br>Score: ${sData.game_data.ai_calculated_niche_score}</div>`;
            }
            const iRes = await fetch(`${API}/critique_ia`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({type: q2?'compare':'niche', query: q2?`${q1} vs ${q2}`:q1, stats: sData}) });
            const iData = await iRes.json();
            boxIA.innerHTML = iData.html_response;
        } catch(e) { boxIA.innerHTML = "Erreur IA."; }
    }

    async function loadFollows() {
        const list = document.getElementById('followed-streams-list');
        list.innerHTML = "<p class='col-span-full text-center py-20'><i class='fas fa-sync fa-spin'></i> Synchronisation...</p>";
        try {
            const res = await fetch(`${API}/followed_streams`, { credentials: 'include' });
            const data = await res.json();
            if(!data.success) throw new Error();
            list.innerHTML = '';
            data.streams.forEach(s => {
                list.innerHTML += `
                    <div class="followed-stream-item" onclick="launchPlayer('${s.user_login}')">
                        <img src="${s.thumbnail_url.replace('{width}','320').replace('{height}','180')}">
                        <div class="font-bold text-[10px] truncate">${s.user_name}</div>
                        <div class="text-pink-500 text-[9px]">üî¥ ${fs(s.viewer_count)} vues</div>
                    </div>`;
            });
        } catch(e) { list.innerHTML = '<p class="w-full text-center py-20 text-gray-700">Veuillez vous connecter √† Twitch.</p>'; }
    }

    function login() { window.location.href = `${API}/twitch_auth_start`; }

    window.onload = () => {
        openTab('tab-followed'); 
        launchPlayer('twitch');
    };
</script>
</body>
</html>
