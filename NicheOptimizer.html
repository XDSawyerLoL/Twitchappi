<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub - COCKPIT V27 (PRODUCTION)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://embed.twitch.tv/embed/v1.js"></script>

    <style>
        :root {
            /* Palette Principale */
            --bg-dark: #050505;
            --panel-bg: #0f0f0f;
            --border-col: #222;
            
            /* Couleurs d'Accentuation */
            --twitch-purple: #9146FF;
            --neon-blue: #00f0ff;
            --neon-green: #00ff9d;
            --neon-pink: #ff0055;
            --neon-yellow: #facc15;
            
            /* Effets */
            --glass: rgba(20, 20, 20, 0.7);
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'ui-sans-serif', 'system-ui', sans-serif;
            overflow-x: hidden;
        }

        /* --- NAVIGATION --- */
        .nav-container {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-col);
        }

        .nav-btn {
            padding: 15px 20px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-btn:hover {
            color: white;
            background: #111;
        }

        .nav-btn.active {
            color: white;
            border-bottom-color: var(--twitch-purple);
            background: linear-gradient(to top, #1a1a1a, transparent);
        }

        /* --- CARTES & PANNEAUX --- */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-col);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        
        .card:hover {
            border-color: #333;
        }

        .stat-box {
            background: #0a0a0a;
            border: 1px solid #1f1f1f;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #777;
            letter-spacing: 1px;
        }

        /* --- √âL√âMENTS SP√âCIFIQUES --- */
        .stars {
            color: #333;
            font-size: 1.2rem;
        }
        .stars .filled {
            color: var(--neon-yellow);
            text-shadow: 0 0 10px rgba(250, 204, 21, 0.4);
        }

        .live-badge {
            background: var(--neon-pink);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .loader-spin {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--neon-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CONTENU IA --- */
        .ai-content h4 { color: var(--neon-blue); font-weight: bold; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; font-size: 0.8rem; }
        .ai-content ul { padding-left: 20px; margin-bottom: 10px; list-style-type: disc; color: #ccc; font-size: 0.9rem; }
        .ai-content li { margin-bottom: 4px; }
        .ai-content p { margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        .ai-content strong { color: white; }

        /* --- INPUTS & BOUTONS --- */
        .input-dark {
            background: #000;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            outline: none;
            font-family: 'Courier New', monospace;
        }
        .input-dark:focus { border-color: var(--neon-blue); }

        .btn-action {
            background: var(--twitch-purple);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.8rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="bg-black border-b border-[#222] py-4">
        <div class="max-w-[1400px] mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-chart-line text-2xl" style="color:var(--neon-blue)"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-tighter text-white">STREAMER <span style="color:var(--twitch-purple)">HUB</span></h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest">Cockpit V27 ‚Ä¢ Production</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="auth-status" class="text-xs font-mono text-gray-500">
                    <span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span> D√©connect√©
                </div>
                <button onclick="toggleAuth()" id="btn-auth" class="bg-[#1a1a1a] hover:bg-[#252525] text-white px-3 py-1.5 rounded text-xs font-bold border border-[#333]">
                    <i class="fab fa-twitch"></i> CONNEXION
                </button>
            </div>
        </div>
    </header>

    <div class="nav-container">
        <div class="max-w-[1400px] mx-auto px-4 flex overflow-x-auto">
            <button onclick="switchTab('market')" class="nav-btn active" id="nav-market">
                <i class="fas fa-globe-americas mr-2"></i> Market Data
            </button>
            <button onclick="switchTab('audit')" class="nav-btn" id="nav-audit">
                <i class="fas fa-search mr-2"></i> Scanner & IA
            </button>
            <button onclick="switchTab('feed')" class="nav-btn" id="nav-feed">
                <i class="fas fa-tv mr-2"></i> Mon Feed
            </button>
            <button onclick="switchTab('tools')" class="nav-btn" id="nav-tools">
                <i class="fas fa-bolt mr-2"></i> Outils
            </button>
        </div>
    </div>

    <main class="max-w-[1400px] mx-auto px-4 min-h-screen pb-20">

        <div id="tab-market" class="tab-content active">
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-8">
                <div class="stat-box border-t-2 border-blue-500">
                    <div class="stat-value" id="kpi-viewers">-</div>
                    <div class="stat-label">Viewers</div>
                </div>
                <div class="stat-box border-t-2 border-green-500">
                    <div class="stat-value" id="kpi-channels">-</div>
                    <div class="stat-label">Channels</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="kpi-active">-</div>
                    <div class="stat-label">Streamers Live</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="kpi-watch">-</div>
                    <div class="stat-label">Watch Time</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="kpi-stream">-</div>
                    <div class="stat-label">Stream Time</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="kpi-games">-</div>
                    <div class="stat-label">Games</div>
                </div>
                <div class="stat-box border-t-2 border-pink-500">
                    <div class="stat-value text-sm truncate" id="kpi-topgame">-</div>
                    <div class="stat-label">Top Category</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value text-[var(--neon-blue)]">EN</div>
                    <div class="stat-label">Top Lang</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card h-[400px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-gray-400 uppercase">üìà √âvolution du March√© (24H)</h3>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-[var(--neon-green)] animate-pulse"></span>
                            <span class="text-[10px] text-[var(--neon-green)]">LIVE UPDATE</span>
                        </div>
                    </div>
                    <div class="flex-grow relative">
                        <canvas id="chart-market"></canvas>
                    </div>
                </div>

                <div class="space-y-4">
                    
                    <div class="card bg-gradient-to-br from-[#120a1f] to-[#0a0a0a] border border-[#333]">
                        <h4 class="text-xs font-bold text-[var(--twitch-purple)] mb-2 uppercase">
                            <i class="fas fa-brain mr-1"></i> Analyse du March√©
                        </h4>
                        <div id="ai-market-insight" class="text-xs text-gray-300 min-h-[60px]">
                            L'IA analyse les donn√©es en temps r√©el...
                        </div>
                        <button onclick="refreshAiMarket()" class="mt-3 w-full py-1.5 text-[10px] bg-[#222] hover:bg-[#333] text-gray-400 rounded border border-[#333]">
                            <i class="fas fa-sync mr-1"></i> ACTUALISER L'ANALYSE
                        </button>
                    </div>

                    <div class="card p-0 overflow-hidden">
                        <div class="bg-[#111] px-4 py-2 border-b border-[#222]">
                            <h4 class="text-xs font-bold text-gray-400 uppercase">üî• Top Cat√©gories</h4>
                        </div>
                        <div id="list-games" class="p-2 space-y-1">
                            <p class="text-center text-xs text-gray-600 py-4">Chargement...</p>
                        </div>
                    </div>

                    <div class="card p-0 overflow-hidden">
                        <div class="bg-[#111] px-4 py-2 border-b border-[#222]">
                            <h4 class="text-xs font-bold text-gray-400 uppercase">üåç Langues</h4>
                        </div>
                        <div id="list-langs" class="p-3 space-y-3">
                            </div>
                    </div>

                </div>
            </div>
        </div>


        <div id="tab-audit" class="tab-content">
            
            <div class="max-w-2xl mx-auto mb-10 text-center">
                <h2 class="text-2xl font-bold mb-2">SCANNER D'INTELLIGENCE</h2>
                <p class="text-sm text-gray-500 mb-6">Analysez n'importe quel Streamer ou Jeu. Obtenez un audit IA complet.</p>
                
                <form id="form-scan" class="relative">
                    <input type="text" id="scan-input" placeholder="Ex: Gotaga, League of Legends, Squeezie..." class="input-dark pl-12 text-lg">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-500"></i>
                    <button type="submit" class="absolute right-2 top-2 btn-action bg-[var(--neon-green)] text-black">
                        LANCER
                    </button>
                </form>
            </div>

            <div id="scan-results" class="hidden grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <div class="md:col-span-4 space-y-6">
                    <div class="card text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-[var(--neon-green)]"></div>
                        <img id="res-img" src="" class="w-32 h-32 rounded-full mx-auto border-4 border-[#222] mt-4 object-cover">
                        
                        <h2 id="res-name" class="text-xl font-bold mt-4 text-white">Nom</h2>
                        <p id="res-type" class="text-xs text-gray-500 uppercase tracking-widest mb-4">Type</p>
                        
                        <div class="flex justify-center gap-2 mb-4">
                            <span id="res-live" class="live-badge hidden">EN LIVE</span>
                        </div>

                        <div class="grid grid-cols-2 gap-2 border-t border-[#222] pt-4 mb-4">
                            <div>
                                <div class="text-lg font-bold text-white" id="res-viewers">-</div>
                                <div class="text-[10px] text-gray-500 uppercase">Viewers</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-white" id="res-followers">-</div>
                                <div class="text-[10px] text-gray-500 uppercase">Total/Follows</div>
                            </div>
                        </div>

                        <div class="bg-[#111] p-3 rounded">
                            <div class="text-[10px] text-gray-400 mb-1 uppercase">SCORE DE POTENTIEL</div>
                            <div class="stars" id="res-stars">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-8 space-y-6">
                    
                    <div class="card border-l-4 border-l-[var(--neon-blue)]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-[var(--neon-blue)] uppercase"><i class="fas fa-microscope mr-2"></i> Audit Strat√©gique (IA)</h3>
                            <span class="text-[10px] bg-[#111] px-2 py-1 rounded text-gray-500">Gemini 2.0 Flash</span>
                        </div>
                        <div id="ai-audit-content" class="ai-content bg-[#050505] p-4 rounded border border-[#222] min-h-[150px]">
                            En attente du scan...
                        </div>
                    </div>

                    <div class="card border-l-4 border-l-[var(--twitch-purple)]">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-[var(--twitch-purple)] uppercase"><i class="fas fa-video mr-2"></i> Analyse VOD & Clips</h3>
                                <p id="vod-title" class="text-xs text-gray-500 mt-1 truncate max-w-md">...</p>
                            </div>
                            <button id="btn-analyze-vod" onclick="analyzeVod()" class="text-xs bg-[#222] px-3 py-2 rounded text-white hover:bg-[#333]" disabled>
                                <i class="fas fa-play mr-1"></i> ANALYSER
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1">
                                <img id="vod-thumb" src="" class="w-full rounded border border-[#333] hidden">
                                <div id="vod-placeholder" class="w-full h-24 bg-[#111] rounded flex items-center justify-center text-gray-700 text-xs">Pas de VOD</div>
                            </div>
                            <div class="md:col-span-2">
                                <div id="ai-vod-content" class="ai-content text-xs text-gray-400 h-full">
                                    L'IA identifiera les moments viraux ici apr√®s analyse.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <div id="tab-feed" class="tab-content">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[80vh]">
                
                <div class="lg:col-span-9 flex flex-col h-full">
                    <div class="bg-black border border-[#222] rounded-t-lg p-2 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                            <span id="player-status" class="text-sm font-bold text-white">LECTEUR PR√äT</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="cycleStream('prev')" class="bg-[#222] w-8 h-8 rounded hover:bg-[#333] text-white"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="cycleStream('next')" class="bg-[#222] w-8 h-8 rounded hover:bg-[#333] text-white"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div id="twitch-embed" class="flex-grow bg-black border-x border-b border-[#222] rounded-b-lg"></div>
                </div>

                <div class="lg:col-span-3 flex flex-col h-full bg-[#0f0f0f] border border-[#222] rounded-lg overflow-hidden">
                    <div class="p-3 border-b border-[#222] bg-[#111]">
                        <h3 class="text-xs font-bold text-gray-400 uppercase">Cha√Ænes Suivies</h3>
                    </div>
                    <div id="followed-list" class="flex-grow overflow-y-auto p-2 space-y-2">
                        <p class="text-center text-xs text-gray-600 mt-10">Connectez-vous pour voir vos favoris.</p>
                    </div>
                    <div class="p-3 border-t border-[#222] bg-[#111]">
                        <button onclick="authTwitch()" class="w-full btn-action text-xs bg-[#6441a5]">Connexion Twitch</button>
                    </div>
                </div>

            </div>
        </div>


        <div id="tab-tools" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="card border-t-4 border-t-[var(--neon-pink)]">
                    <h3 class="text-lg font-bold text-white mb-2"><i class="fas fa-rocket mr-2 text-[var(--neon-pink)]"></i> Stream Boost</h3>
                    <p class="text-xs text-gray-500 mb-4">Mettez votre cha√Æne en avant sur le r√©seau pendant 15 minutes.</p>
                    <input type="text" id="boost-input" placeholder="Cha√Æne √† booster..." class="input-dark mb-2">
                    <button onclick="activateBoost()" class="btn-action w-full bg-[var(--neon-pink)]">ACTIVER LE BOOST</button>
                    <div id="boost-msg" class="mt-2 text-xs text-center text-gray-400 min-h-[20px]"></div>
                </div>

                <div class="card border-t-4 border-t-[var(--neon-green)]">
                    <h3 class="text-lg font-bold text-white mb-2"><i class="fas fa-users mr-2 text-[var(--neon-green)]"></i> Raid Finder</h3>
                    <p class="text-xs text-gray-500 mb-4">Trouvez la cible parfaite pour votre raid (Langue FR).</p>
                    <input type="text" id="raid-game" placeholder="Jeu (ex: Minecraft)" class="input-dark mb-2">
                    <select id="raid-size" class="input-dark mb-2">
                        <option value="10">Micro (0-10 viewers)</option>
                        <option value="50" selected>Petit (10-50 viewers)</option>
                        <option value="100">Moyen (50-100 viewers)</option>
                    </select>
                    <button onclick="findRaid()" class="btn-action w-full bg-[var(--neon-green)] text-black">CHERCHER CIBLE</button>
                    <div id="raid-res" class="mt-4"></div>
                </div>

                <div class="card border-t-4 border-t-[var(--neon-yellow)]">
                    <h3 class="text-lg font-bold text-white mb-2"><i class="fas fa-clock mr-2 text-[var(--neon-yellow)]"></i> Smart Schedule</h3>
                    <p class="text-xs text-gray-500 mb-4">L'IA analyse la saturation pour vous dire quand streamer.</p>
                    <input type="text" id="sched-game" placeholder="Jeu √† analyser..." class="input-dark mb-2">
                    <button onclick="calcSchedule()" class="btn-action w-full bg-[var(--neon-yellow)] text-black">CALCULER</button>
                    <div id="sched-res" class="mt-2 text-xs text-gray-300"></div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // Configuration
        const API_BASE = window.location.origin; // S'adapte auto (Localhost ou Render)
        let currentChart = null;
        let currentAuditLogin = null;
        let player = null;

        // --- GESTION DES ONGLETS ---
        function switchTab(tabId) {
            // Masquer tout
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            // Afficher cible
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active');

            // Logique sp√©cifique par onglet
            if (tabId === 'market') loadMarketStats();
            if (tabId === 'feed' && !player) initPlayer('twitch'); // Init player si besoin
        }

        // --- 1. MARKET LOGIC (DASHBOARD) ---
        async function loadMarketStats() {
            try {
                // 1. Stats Globales & Graphique
                const resGlobal = await fetch(`${API_BASE}/api/stats/global`);
                const globalData = await resGlobal.json();

                if (globalData.success) {
                    // Update KPIs
                    updateKpi('viewers', globalData.viewers);
                    updateKpi('channels', globalData.channels);
                    updateKpi('active', globalData.active_streamers);
                    updateKpi('watch', globalData.watch_time);
                    updateKpi('stream', globalData.stream_time);
                    updateKpi('games', globalData.games_live);
                    document.getElementById('kpi-topgame').innerText = globalData.top_game;

                    // Update Chart
                    renderMarketChart(globalData.history.labels, globalData.history.data);
                    
                    // Trigger AI explainer if empty
                    const aiBox = document.getElementById('ai-market-insight');
                    if (aiBox.innerText.includes('analyse')) {
                        refreshAiMarket({ 
                            viewers: globalData.viewers, 
                            active_streamers: globalData.active_streamers, 
                            top_game: globalData.top_game 
                        });
                    }
                }

                // 2. Top Games
                const resGames = await fetch(`${API_BASE}/api/stats/top_games`);
                const gamesData = await resGames.json();
                if (gamesData.games) {
                    document.getElementById('list-games').innerHTML = gamesData.games.map((g, i) => `
                        <div class="flex items-center justify-between bg-[#1a1a1a] p-2 rounded border border-[#222] hover:border-gray-600 transition">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-600 font-mono font-bold w-4">#${i+1}</span>
                                <img src="${g.img}" class="w-6 rounded">
                                <span class="text-xs font-bold text-gray-300 truncate w-32">${g.name}</span>
                            </div>
                            <span class="text-[10px] text-blue-400 font-bold">TOP</span>
                        </div>
                    `).join('');
                }

                // 3. Languages
                const resLang = await fetch(`${API_BASE}/api/stats/languages`);
                const langData = await resLang.json();
                if (langData.languages) {
                    document.getElementById('list-langs').innerHTML = langData.languages.map(l => `
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                <span>${l.name}</span>
                                <span class="font-bold text-white">${l.percent}%</span>
                            </div>
                            <div class="w-full bg-[#222] h-1.5 rounded-full overflow-hidden">
                                <div class="h-full bg-pink-500" style="width: ${l.percent}%"></div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (e) { console.error("Erreur Market:", e); }
        }

        function updateKpi(id, value) {
            document.getElementById(`kpi-${id}`).innerText = typeof value === 'number' ? value.toLocaleString() : value;
        }

        function renderMarketChart(labels, data) {
            const ctx = document.getElementById('chart-market').getContext('2d');
            
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spectateurs Mondiaux',
                        data: data,
                        borderColor: '#00f0ff',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(0, 240, 255, 0.2)');
                            gradient.addColorStop(1, 'rgba(0, 240, 255, 0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#fff',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false, color: '#222' }, ticks: { color: '#666', font: { size: 10 } } },
                        y: { grid: { color: '#222' }, ticks: { color: '#666', font: { size: 10 } } }
                    }
                }
            });
        }

        async function refreshAiMarket(statsObj = null) {
            const box = document.getElementById('ai-market-insight');
            box.innerHTML = '<div class="loader-spin w-4 h-4"></div> Analyse...';
            
            // Si pas de stats pass√©es, on lit le DOM (fallback)
            const stats = statsObj || {
                viewers: document.getElementById('kpi-viewers').innerText,
                active_streamers: document.getElementById('kpi-active').innerText,
                top_game: document.getElementById('kpi-topgame').innerText
            };

            const res = await fetch(`${API_BASE}/api/explain_stats`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ stats })
            });
            const data = await res.json();
            if (data.html) box.innerHTML = data.html;
        }


        // --- 2. AUDIT LOGIC (SCANNER) ---
        document.getElementById('form-scan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('scan-input').value;
            if(!query) return;

            // UI Reset
            document.getElementById('scan-results').classList.remove('hidden');
            document.getElementById('res-name').innerText = "Recherche...";
            document.getElementById('ai-audit-content').innerHTML = '<div class="flex items-center gap-2 text-gray-500"><span class="loader-spin"></span> Audit en cours...</div>';
            
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query })
            });
            const data = await res.json();

            if (data.success) {
                const d = data.data;
                currentAuditLogin = d.login || d.name; // Save for VOD

                // Fill Profile
                document.getElementById('res-name').innerText = d.name;
                document.getElementById('res-type').innerText = d.type;
                document.getElementById('res-img').src = d.img;
                document.getElementById('res-viewers').innerText = d.viewers.toLocaleString();
                
                if (d.type === 'user') {
                    document.getElementById('res-followers').innerText = d.total_followers || 'N/A';
                    document.getElementById('res-live').classList.toggle('hidden', !d.live);
                } else {
                    document.getElementById('res-followers').parentElement.innerHTML = `<div class="text-lg font-bold text-white">${d.total_streamers}</div><div class="text-[10px] text-gray-500 uppercase">Streamers</div>`;
                }

                // Stars
                let starsHtml = '';
                for(let i=1; i<=5; i++) {
                    starsHtml += i <= Math.round(d.score_stars) ? '<i class="fas fa-star filled"></i>' : '<i class="fas fa-star text-gray-800"></i>';
                }
                document.getElementById('res-stars').innerHTML = starsHtml;

                // Trigger AI Audit
                const aiRes = await fetch(`${API_BASE}/critique_ia`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ type: 'niche', query: d.name, niche_score: d.score_stars })
                });
                const aiData = await aiRes.json();
                document.getElementById('ai-audit-content').innerHTML = aiData.html;

                // Check VOD
                if(d.type === 'user') {
                    checkVod(d.login);
                } else {
                    document.getElementById('vod-title').innerText = "L'analyse VOD est r√©serv√©e aux cha√Ænes.";
                    document.getElementById('btn-analyze-vod').disabled = true;
                }
            } else {
                document.getElementById('res-name').innerText = "Introuvable.";
            }
        });

        async function checkVod(channel) {
            document.getElementById('btn-analyze-vod').disabled = true;
            document.getElementById('vod-title').innerText = "Recherche VOD...";
            const res = await fetch(`${API_BASE}/get_latest_vod?channel=${channel}`);
            const data = await res.json();
            if(data.success) {
                document.getElementById('vod-title').innerText = data.vod.title;
                document.getElementById('vod-thumb').src = data.vod.thumbnail_url;
                document.getElementById('vod-thumb').classList.remove('hidden');
                document.getElementById('vod-placeholder').classList.add('hidden');
                document.getElementById('btn-analyze-vod').disabled = false;
            } else {
                document.getElementById('vod-title').innerText = "Aucune VOD disponible.";
            }
        }

        async function analyzeVod() {
            document.getElementById('ai-vod-content').innerHTML = '<div class="loader-spin"></div> Analyse de la vid√©o...';
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: 'repurpose', query: document.getElementById('vod-title').innerText })
            });
            const data = await res.json();
            document.getElementById('ai-vod-content').innerHTML = data.html;
        }


        // --- 3. FEED LOGIC (PLAYER) ---
        function initPlayer(channel) {
            if (player) {
                player.setChannel(channel);
            } else {
                document.getElementById('twitch-embed').innerHTML = '';
                const options = { width: "100%", height: "100%", channel: channel, layout: "video", parent: ["localhost", window.location.hostname] };
                player = new Twitch.Embed("twitch-embed", options);
            }
            document.getElementById('player-status').innerText = `LECTURE : ${channel.toUpperCase()}`;
        }

        async function loadFollows() {
            // Check status first
            const statusRes = await fetch(`${API_BASE}/twitch_user_status`);
            const status = await statusRes.json();
            
            if (status.is_connected) {
                document.getElementById('auth-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span> ${status.display_name}`;
                document.getElementById('btn-auth').innerText = "D√âCONNEXION";
                document.getElementById('btn-auth').onclick = logout;

                // Load list
                const listRes = await fetch(`${API_BASE}/followed_streams`);
                const listData = await listRes.json();
                const container = document.getElementById('followed-list');
                
                if (listData.success && listData.streams.length > 0) {
                    container.innerHTML = listData.streams.map(s => `
                        <div onclick="initPlayer('${s.user_login}')" class="flex items-center gap-3 p-2 bg-[#111] rounded border border-[#222] cursor-pointer hover:border-purple-500">
                            <img src="${s.thumbnail_url.replace('{width}', '50').replace('{height}', '50')}" class="w-10 h-10 rounded-full">
                            <div class="overflow-hidden">
                                <div class="text-xs font-bold text-white truncate">${s.user_name}</div>
                                <div class="text-[10px] text-gray-500 truncate">${s.game_name}</div>
                                <div class="text-[10px] text-red-500 font-bold">üî¥ ${s.viewer_count}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-center text-xs text-gray-600 mt-4">Aucun live en cours.</p>';
                }
            }
        }

        function authTwitch() { window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=600'); }
        async function logout() { await fetch(`${API_BASE}/twitch_logout`, {method:'POST'}); window.location.reload(); }
        
        async function cycleStream(dir) {
            const res = await fetch(`${API_BASE}/cycle_stream`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direction: dir }) });
            const data = await res.json();
            if(data.success) initPlayer(data.channel);
        }


        // --- 4. TOOLS LOGIC ---
        async function activateBoost() {
            const channel = document.getElementById('boost-input').value;
            const msg = document.getElementById('boost-msg');
            msg.innerText = "Activation...";
            
            const res = await fetch(`${API_BASE}/stream_boost`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ channel }) });
            const data = await res.json();
            msg.innerHTML = data.html_response || data.error;
            if(data.success) initPlayer(channel);
        }

        async function findRaid() {
            const resBox = document.getElementById('raid-res');
            resBox.innerHTML = "Recherche...";
            const res = await fetch(`${API_BASE}/start_raid`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ game: document.getElementById('raid-game').value, max_viewers: document.getElementById('raid-size').value })
            });
            const data = await res.json();
            if(data.success) {
                const t = data.target;
                resBox.innerHTML = `
                    <div class="flex items-center gap-4 bg-[#111] p-3 rounded border border-[#00ff9d]">
                        <img src="${t.thumbnail_url}" class="w-16 h-10 rounded object-cover">
                        <div>
                            <div class="font-bold text-white text-sm">${t.name}</div>
                            <div class="text-xs text-[#00ff9d]">üü¢ ${t.viewers} viewers</div>
                        </div>
                        <button onclick="initPlayer('${t.login}')" class="ml-auto text-xs bg-[#00ff9d] text-black px-2 py-1 rounded font-bold">GO</button>
                    </div>`;
            } else { resBox.innerText = data.error; }
        }

        async function calcSchedule() {
            const box = document.getElementById('sched-res');
            box.innerHTML = "Calcul IA...";
            const res = await fetch(`${API_BASE}/analyze_schedule`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ game: document.getElementById('sched-game').value }) });
            const data = await res.json();
            box.innerHTML = data.html_response || "Erreur.";
        }

        // --- INIT ---
        window.onload = () => {
            loadMarketStats();
            loadFollows();
            // Check auto stream
            fetch(`${API_BASE}/get_default_stream`).then(r=>r.json()).then(d => { if(d.success) initPlayer(d.channel); });
        };

        // Ecouteur message auth
        window.addEventListener('message', (event) => { if(event.data === 'auth_success') window.location.reload(); });

    </script>
</body>
</html>
