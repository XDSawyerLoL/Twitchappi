<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.3 - Partage Social Am√©lior√©</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert pour la niche */
            --color-ai-repurpose: #9933ff; /* Violet pour le repurposing */
            --color-ai-growth: #ffcc00; /* Jaune pour la croissance/alertes */
            --color-ai-action: #e34a64; /* Rouge/Corail pour l'action/export */
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        body { 
            background-color: var(--color-bg-dark); 
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif;
        }
        .container-wrapper {
            max-width: 1400px;
        }
        h1, h2, h3, h4, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .bg-primary-pink { background-color: var(--color-primary-pink); }
        .text-primary-pink { color: var(--color-primary-pink); }
        .border-primary-pink { border-color: var(--color-primary-pink); }
        .bg-secondary-blue { background-color: var(--color-secondary-blue); }
        .text-secondary-blue { color: var(--color-secondary-blue); }
        .tab-button {
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-color: var(--color-primary-pink);
            color: var(--color-primary-pink);
            font-weight: 700;
        }
        /* ‚úÖ EFFET VISUEL : Bordure lumineuse pour la section de partage */
        .glow-border {
            border: 1px solid var(--color-border-dark);
            box-shadow: 0 0 15px rgba(255, 0, 153, 0.15); /* Ombre rose subtile */
        }
        
        /* Styles pour les rapports IA */
        .ai-report h4 {
            color: var(--color-ai-growth);
            font-size: 1.25rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dashed var(--color-border-dark);
            padding-bottom: 5px;
        }
        .ai-report ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 1rem;
            color: #ccc;
        }
        .ai-report p {
            margin-bottom: 1rem;
        }
        .ai-report strong {
            color: var(--color-primary-pink);
        }
        /* Style sp√©cifique pour le r√©sultat de l'action */
        #auto-action-result p {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<div class="container-wrapper mx-auto p-4 md:p-8">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b border-gray-700 pb-4">
        <h1 class="text-3xl font-orbitron font-bold text-primary-pink mb-4 md:mb-0">
            <i class="fas fa-satellite-dish mr-2"></i> Streamer AI Hub
        </h1>
        <div id="auth-status" class="text-sm text-gray-400">
            <span id="twitch-status-message">Non connect√© √† Twitch.</span>
            <button id="twitch-auth-btn" class="ml-3 bg-secondary-blue hover:bg-opacity-80 text-white font-semibold py-1 px-3 rounded text-xs transition duration-200">
                Connexion Twitch
            </button>
            <button id="twitch-logout-btn" style="display:none;" class="ml-3 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-1 px-3 rounded text-xs transition duration-200">
                D√©connexion
            </button>
        </div>
    </header>

    <div class="flex border-b border-gray-700 mb-6">
        <button class="tab-button active py-2 px-4 hover:text-primary-pink" data-tab="tab-followed">
            <i class="fas fa-rss mr-2"></i> Flux Suivi
        </button>
        <button class="tab-button py-2 px-4 hover:text-primary-pink" data-tab="tab-search">
            <i class="fas fa-search mr-2"></i> Analyse Cible
        </button>
        <button class="tab-button py-2 px-4 hover:text-primary-pink" data-tab="tab-ia-reports">
            <i class="fas fa-brain mr-2"></i> Rapports IA
        </button>
        <button class="tab-button py-2 px-4 hover:text-primary-pink" data-tab="tab-disruption">
            <i class="fas fa-bomb mr-2"></i> Disruption/Action
        </button>
    </div>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <div class="md:col-span-2">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-3">Player <span class="text-secondary-blue" id="current-channel-display"></span></h2>
                <div id="twitch-embed" class="w-full aspect-video rounded-lg overflow-hidden bg-black">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        Chargement du Player...
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-3 flex justify-between items-center">
                    Mini Assistant IA <span class="text-sm font-inter text-gray-500">(Chat en direct)</span>
                </h2>
                <div id="assistant-chat-box" class="h-64 overflow-y-auto p-3 mb-3 bg-gray-900 rounded border border-gray-700">
                    <p class="text-gray-400 text-sm">Bienvenue ! Posez une question rapide √† l'IA concernant le stream actuel (ex: "Quel devrait √™tre mon prochain jeu ?").</p>
                </div>
                <form id="form-mini-assistant" class="flex gap-2">
                    <input type="text" id="assistant-input" placeholder="Demandez √† l'IA..." class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                    <button type="submit" id="assistant-send-btn" class="bg-primary-pink hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded transition duration-200">
                        Envoyer
                    </button>
                </form>
            </div>
        </div>

        <div class="md:col-span-1">
            
            <div id="tab-followed" class="tab-content">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-4">Streams Suivis</h2>
                <div id="followed-streams-list" class="space-y-3 h-[70vh] overflow-y-auto pr-2">
                    <p class="text-gray-500">Connectez-vous √† Twitch pour voir les cha√Ænes suivies.</p>
                </div>
            </div>

            <div id="tab-search" class="tab-content hidden">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-4">Analyse de Niche & Cible</h2>
                
                <form id="form-scan-target" class="flex flex-col gap-3 mb-6">
                    <input type="text" id="scan-target-input" placeholder="Entrez un jeu ou un nom de cha√Æne Twitch..." required class="p-3 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                    <button type="submit" id="scan-target-btn" class="bg-primary-pink hover:bg-opacity-80 text-white font-semibold py-3 px-4 rounded transition duration-200">
                        <i class="fas fa-crosshairs mr-2"></i> Scanner la Cible
                    </button>
                </form>

                <div id="scan-result-box" class="p-4 rounded-xl bg-gray-800 border border-gray-700 h-[60vh] overflow-y-auto">
                    <p class="text-gray-500">Le r√©sultat du scan s'affichera ici.</p>
                </div>
            </div>
            
            <div id="tab-ia-reports" class="tab-content hidden">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-4">G√©n√©rer un Rapport IA</h2>
                
                <form id="form-critique-ia" class="space-y-4">
                    <select id="ia-report-type" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                        <option value="">S√©lectionnez le type de rapport...</option>
                        <option value="niche">Analyse de Niche pour un jeu</option>
                        <option value="repurpose">Id√©es de Repurposing VOD</option>
                        <option value="trend">Tendances Globales de Croissance</option>
                    </select>
                    <input type="text" id="ia-report-query" placeholder="Sujet, Jeu ou VOD √† analyser..." required class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                    <button type="submit" id="ia-report-btn" class="w-full bg-primary-pink hover:bg-opacity-80 text-white font-semibold py-3 px-4 rounded transition duration-200">
                        <i class="fas fa-clipboard-list mr-2"></i> G√©n√©rer le Rapport
                    </button>
                </form>

                <div id="ia-report-result" class="ai-report mt-6 p-4 rounded-xl bg-gray-800 border border-gray-700 h-[45vh] overflow-y-auto">
                    <p class="text-gray-500">Le rapport de l'intelligence artificielle s'affichera ici.</p>
                </div>
            </div>

            <div id="tab-disruption" class="tab-content hidden">
                <h2 class="text-2xl font-orbitron font-semibold text-white mb-4">Outils d'Action Instantan√©e</h2>
                
                <form id="form-auto-action" class="space-y-4">
                    <input type="text" id="auto-action-query" placeholder="Jeu, VOD ou cha√Æne cible..." required class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                    
                    <div class="flex flex-col gap-2">
                        <button type="submit" data-action="export_metrics" class="auto-action-btn w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded transition duration-200 border border-gray-600">
                            <i class="fas fa-chart-line mr-2"></i> 1. Exporter les M√©triques Cl√©s
                        </button>
                        <button type="submit" data-action="create_clip" class="auto-action-btn w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded transition duration-200 border border-gray-600">
                            <i class="fas fa-cut mr-2"></i> 2. Id√©es de Clip & Titres IA
                        </button>
                        <button type="submit" data-action="title_disruption" class="auto-action-btn w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded transition duration-200 border border-gray-600">
                            <i class="fas fa-fire-alt mr-2"></i> 3. Titre Disruptif Instant
                        </button>
                    </div>
                </form>

                <div id="metrics-report-box" class="ai-report mt-6 p-4 rounded-xl bg-gray-800 border border-gray-700" style="display:none;">
                    <h4 class="text-xl font-orbitron text-primary-pink mb-2">üìä Rapport d'Export de M√©triques</h4>
                    <div class="grid grid-cols-3 gap-4 text-center mt-3">
                        <div>
                            <p class="text-2xl font-bold text-secondary-blue" id="metric-views">0</p>
                            <p class="text-sm text-gray-400">Vues VOD R√©centes</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-secondary-blue" id="metric-retention">0%</p>
                            <p class="text-sm text-gray-400">R√©tention Moyenne</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-secondary-blue" id="metric-followers">0</p>
                            <p class="text-sm text-gray-400">Followers GAGN√âS</p>
                        </div>
                    </div>
                </div>

                <div id="auto-action-result" class="ai-report mt-4 p-4 rounded-xl bg-gray-800 border border-gray-700 min-h-[100px] flex items-center justify-center">
                    <p class="text-gray-500">Le r√©sultat de l'action s'affichera ici.</p>
                </div>
                
                <div class="mt-4 p-4 rounded-xl bg-gray-800 glow-border">
                    <h4 class="text-xl font-orbitron text-white mb-3 flex items-center">
                        <span class="mr-2 text-primary-pink">üöÄ</span> Partage Social & Promotion
                    </h4>
                    
                    <div id="share-buttons" class="flex flex-wrap gap-2 justify-start">
                        <button data-platform="twitter" class="share-btn bg-[#1DA1F2] hover:bg-[#1A91DA] text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fab fa-twitter mr-1.5"></i> X (Twitter)
                        </button>
                        <button data-platform="reddit" class="share-btn bg-[#FF4500] hover:bg-[#E53D00] text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fab fa-reddit-alien mr-1.5"></i> Reddit
                        </button>
                        <button data-platform="discord" class="share-btn bg-[#5865F2] hover:bg-[#4752C4] text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fab fa-discord mr-1.5"></i> Discord (Copier)
                        </button>
                        <button data-platform="whatsapp" class="share-btn bg-[#25D366] hover:bg-[#1DA853] text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fab fa-whatsapp mr-1.5"></i> WhatsApp
                        </button>
                        <button data-platform="telegram" class="share-btn bg-[#0088CC] hover:bg-[#007AB8] text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fab fa-telegram-plane mr-1.5"></i> Telegram
                        </button>
                        <button data-platform="copy" id="copy-link-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-3 rounded-full text-sm font-semibold flex items-center transition duration-200 disabled:opacity-50" disabled>
                            <i class="fas fa-link mr-1.5"></i> Copier le Texte
                        </button>
                    </div>
                    
                    <div id="share-content-preview" class="mt-3 p-3 bg-gray-900 border border-gray-700 rounded text-sm text-gray-300">
                        Pr√©parez une action (Clip ou Titre Disruptif) pour g√©n√©rer le contenu √† partager.
                    </div>
                </div>
            </div>

            <div class="mt-6 p-4 rounded-xl bg-gray-800 border border-gray-700">
                <h4 class="text-xl font-orbitron text-primary-pink mb-2 flex items-center">
                    <i class="fas fa-bolt mr-2"></i> Boost de Stream
                </h4>
                <p class="text-sm text-gray-400 mb-3">Activez une rotation de promotion de 10 minutes (Cooldown: 3h).</p>
                <form id="form-stream-boost" class="flex flex-col gap-3">
                    <input type="text" id="boost-channel-input" placeholder="Votre cha√Æne Twitch (login)" required class="p-2 rounded bg-gray-700 border border-gray-600 focus:border-primary-pink focus:outline-none text-white">
                    <button type="submit" id="boost-btn" class="bg-secondary-blue hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded transition duration-200">
                        Activer le Boost
                    </button>
                </form>
                <div id="boost-message" class="mt-3 text-sm text-center"></div>
            </div>

        </div>
    </main>

</div>

<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script>
    const API_BASE = "http://localhost:10000"; 
    const DEFAULT_CHANNEL = "shroud"; 
    let twitchPlayer;

    // --- 1. Gestion des Onglets ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabId).classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        localStorage.setItem('activeTab', tabId);
    }
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => openTab(btn.dataset.tab));
    });

    // --- 2. Twitch Player ---
    function initializePlayer() {
        if (!document.getElementById('twitch-embed')) return;
        twitchPlayer = new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: "100%",
            channel: DEFAULT_CHANNEL,
            layout: "video-with-chat",
            parent: ["localhost"] // REMPLACER avec vos domaines de production
        });
    }

    window.launchPlayer = function(channel) {
        if (twitchPlayer) {
            twitchPlayer.setChannel(channel);
            document.getElementById('current-channel-display').textContent = ` : ${channel}`;
            localStorage.setItem('activeChannel', channel);
        } else {
            // Re-initialisation si player non charg√© (cas rare)
            document.getElementById('twitch-embed').innerHTML = '';
            initializePlayer();
            twitchPlayer.addEventListener(Twitch.Embed.VIDEO_READY, () => {
                twitchPlayer.setChannel(channel);
                document.getElementById('current-channel-display').textContent = ` : ${channel}`;
                localStorage.setItem('activeChannel', channel);
            });
        }
    }
    
    // --- 3. Gestion de l'Authentification (Fonctions de base inchang√©es) ---
    async function checkAuth() {
        const statusEl = document.getElementById('twitch-status-message');
        const loginBtn = document.getElementById('twitch-auth-btn');
        const logoutBtn = document.getElementById('twitch-logout-btn');

        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();

            if (data.is_connected) {
                statusEl.innerHTML = `Connect√© : <strong class="text-primary-pink">${data.display_name}</strong>`;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
                // Assurez-vous que l'input du boost prend le nom d'utilisateur par d√©faut
                document.getElementById('boost-channel-input').value = data.username; 
                fetchFollowedStreams();
            } else {
                statusEl.textContent = 'Non connect√© √† Twitch.';
                loginBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
            }
        } catch (e) {
            statusEl.textContent = 'Erreur: Impossible de v√©rifier l\'auth Twitch.';
            console.error("Auth check failed:", e);
        }
    }

    document.getElementById('twitch-auth-btn').addEventListener('click', () => {
        window.location.href = `${API_BASE}/twitch_auth_start`;
    });

    document.getElementById('twitch-logout-btn').addEventListener('click', async () => {
        try {
            await fetch(`${API_BASE}/twitch_logout`, { method: 'POST' });
            checkAuth();
            window.launchPlayer(DEFAULT_CHANNEL);
            document.getElementById('followed-streams-list').innerHTML = '<p class="text-gray-500">Connectez-vous √† Twitch pour voir les cha√Ænes suivies.</p>';
        } catch (e) {
            console.error("Logout failed:", e);
        }
    });

    // --- 4. Flux Suivi ---
    async function fetchFollowedStreams() {
        const listEl = document.getElementById('followed-streams-list');
        listEl.innerHTML = '<p class="text-secondary-blue">Chargement des streams suivis...</p>';
        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();
            
            if (!res.ok) throw new Error(data.error);

            if (data.streams.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">Aucun stream suivi en direct actuellement.</p>';
                return;
            }

            listEl.innerHTML = data.streams.map(stream => `
                <div class="stream-card p-3 rounded-lg bg-gray-900 hover:bg-gray-700 cursor-pointer flex gap-3 items-center" data-channel="${stream.user_login}">
                    <img src="${stream.thumbnail_url.replace('-{width}x{height}', '-150x84')}" alt="${stream.title}" class="w-12 h-12 object-cover rounded-full">
                    <div class="flex-grow">
                        <p class="text-white font-semibold">${stream.user_name}</p>
                        <p class="text-sm text-gray-400 truncate">${stream.title}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <span class="inline-flex items-center text-sm text-primary-pink">
                            <i class="fas fa-eye mr-1"></i> ${stream.viewer_count.toLocaleString('fr-FR')}
                        </span>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.stream-card').forEach(card => {
                card.addEventListener('click', () => {
                    window.launchPlayer(card.dataset.channel);
                });
            });

        } catch (e) {
            listEl.innerHTML = `<p class="text-red-500">Erreur: ${e.message}</p>`;
        }
    }
    
    // --- 5. Logique des Formulaires (Scan, Critique, Mini-Assistant, Boost) - (Logique inchang√©e) ---
    
    // Scan Target
    document.getElementById('form-scan-target').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('scan-target-btn');
        const query = document.getElementById('scan-target-input').value.trim();
        const resultBox = document.getElementById('scan-result-box');
        
        btn.disabled = true;
        resultBox.innerHTML = '<p class="text-secondary-blue text-center">Analyse en cours... <i class="fas fa-spinner fa-spin"></i></p>';

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                if (data.type === 'game') {
                    const game = data.game_data;
                    resultBox.innerHTML = `
                        <h4 class="text-2xl font-orbitron text-primary-pink mb-3">${game.name}</h4>
                        <div class="space-y-2 text-gray-300">
                            <p><strong>Total Streamers (Top 50):</strong> ${game.total_streamers}</p>
                            <p><strong>Total Viewers (Top 50):</strong> ${game.total_viewers.toLocaleString('fr-FR')}</p>
                            <p><strong>Moyenne par Streamer:</strong> <strong class="text-secondary-blue">${game.avg_viewers_per_streamer}</strong> vues</p>
                        </div>
                        <h5 class="text-xl font-semibold text-white mt-4 mb-2 border-b border-gray-700 pb-1">Top 5 Streamers Actuels:</h5>
                        <ul class="space-y-2">
                            ${game.streams.map(s => `
                                <li class="text-sm flex justify-between items-center bg-gray-700 p-2 rounded">
                                    <span class="font-semibold">${s.user_name}</span> 
                                    <span class="text-primary-pink">${s.viewer_count.toLocaleString('fr-FR')} vues</span>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else if (data.type === 'user') {
                     const user = data.user_data;
                     resultBox.innerHTML = `
                        <div class="flex items-center gap-4 mb-3">
                            <img src="${user.profile_image_url}" alt="${user.display_name}" class="w-16 h-16 rounded-full border-2 border-primary-pink">
                            <div>
                                <h4 class="text-2xl font-orbitron text-primary-pink">${user.display_name}</h4>
                                <p class="text-sm text-gray-400">@${user.login}</p>
                            </div>
                        </div>
                        <p class="text-gray-300 mb-4">${user.description || 'Pas de description.'}</p>
                        <p class="font-semibold ${user.is_live ? 'text-green-400' : 'text-red-400'}">
                            Statut : ${user.is_live ? 'üî¥ EN DIRECT' : 'OFFLINE'}
                        </p>
                        ${user.is_live && user.stream_details ? `
                            <div class="mt-4 p-3 bg-gray-700 rounded">
                                <p><strong>Titre:</strong> ${user.stream_details.title}</p>
                                <p><strong>Jeu:</strong> ${user.stream_details.game_name}</p>
                                <p><strong>Viewers:</strong> ${user.stream_details.viewer_count.toLocaleString('fr-FR')}</p>
                            </div>
                        ` : ''}
                        <button onclick="window.launchPlayer('${user.login}')" class="mt-4 w-full bg-secondary-blue hover:bg-opacity-80 text-white font-semibold py-2 rounded">
                            Lancer le Player
                        </button>
                     `;
                } else {
                     resultBox.innerHTML = `<p class="text-red-500">Erreur: Type de donn√©es inconnu.</p>`;
                }

            } else {
                resultBox.innerHTML = `<p class="text-red-500">Erreur API (${res.status}): ${data.message || data.error || "Cible introuvable."}</p>`;
            }
        } catch (e) {
            resultBox.innerHTML = `<p class="text-red-500">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // Critique IA
    document.getElementById('form-critique-ia').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('ia-report-btn');
        const type = document.getElementById('ia-report-type').value;
        const query = document.getElementById('ia-report-query').value.trim();
        const resultBox = document.getElementById('ia-report-result');
        
        if (!type || !query) {
             resultBox.innerHTML = '<p class="text-red-500">Veuillez s√©lectionner un type et entrer une requ√™te.</p>';
             return;
        }

        btn.disabled = true;
        resultBox.innerHTML = '<p class="text-secondary-blue text-center">G√©n√©ration du rapport IA... <i class="fas fa-brain fa-spin"></i></p>';
        
        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, query })
            });

            const data = await res.json();
            
            if (res.ok && data.success) {
                resultBox.innerHTML = data.html_response;
            } else {
                resultBox.innerHTML = data.html_response || `<p class="text-red-500">Erreur API (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
            }
        } catch (e) {
            resultBox.innerHTML = `<p class="text-red-500">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // Mini Assistant
    document.getElementById('form-mini-assistant').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('assistant-input');
        const q = input.value.trim();
        const chatBox = document.getElementById('assistant-chat-box');
        const sendBtn = document.getElementById('assistant-send-btn');
        const contextChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;

        if (!q) return;

        // Afficher la question de l'utilisateur
        chatBox.innerHTML += `<p class="text-right text-white bg-gray-700 p-2 rounded-lg my-1"><strong>Vous :</strong> ${q}</p>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        sendBtn.disabled = true;
        input.value = '';
        
        // Afficher le message de chargement de l'IA
        const loadingMessage = document.createElement('p');
        loadingMessage.className = 'text-left text-secondary-blue bg-gray-900 p-2 rounded-lg my-1';
        loadingMessage.innerHTML = '<strong>IA :</strong> <i class="fas fa-spinner fa-spin"></i> R√©flexion en cours...';
        chatBox.appendChild(loadingMessage);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ q, context: contextChannel })
            });

            const data = await res.json();
            
            // Retirer le message de chargement
            chatBox.removeChild(loadingMessage);

            if (res.ok && data.success) {
                const aiResponse = document.createElement('div');
                aiResponse.className = 'text-left text-gray-300 bg-gray-800 p-2 rounded-lg my-1';
                aiResponse.innerHTML = `<strong>IA :</strong> ${data.html_response}`;
                chatBox.appendChild(aiResponse);
            } else {
                 const errorMessage = document.createElement('p');
                 errorMessage.className = 'text-left text-red-500 bg-gray-800 p-2 rounded-lg my-1';
                 errorMessage.innerHTML = `<strong>IA :</strong> ‚ùå Erreur (${res.status}): ${data.error || 'Probl√®me de connexion.'}`;
                 chatBox.appendChild(errorMessage);
            }
        } catch (e) {
             chatBox.removeChild(loadingMessage);
             const errorMessage = document.createElement('p');
             errorMessage.className = 'text-left text-red-500 bg-gray-800 p-2 rounded-lg my-1';
             errorMessage.innerHTML = `<strong>IA :</strong> ‚ùå Erreur r√©seau: ${e.message}`;
             chatBox.appendChild(errorMessage);
        } finally {
            sendBtn.disabled = false;
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
    
    // Auto Action
    document.getElementById('form-auto-action').addEventListener('click', async function(e) {
        if (!e.target.classList.contains('auto-action-btn')) return;

        e.preventDefault();
        const btn = e.target;
        const actionType = btn.dataset.action;
        const query = document.getElementById('auto-action-query').value.trim();
        const resultBox = document.getElementById('auto-action-result');
        const reportBox = document.getElementById('metrics-report-box');
        
        if (!query) {
             resultBox.innerHTML = '<p class="text-red-500">Veuillez entrer une requ√™te (Jeu, VOD ou Cha√Æne).</p>';
             return;
        }

        // D√©sactiver tous les boutons d'action
        document.querySelectorAll('.auto-action-btn').forEach(b => b.disabled = true);
        // D√©sactiver les boutons de partage
        document.querySelectorAll('.share-btn').forEach(b => b.disabled = true);
        
        resultBox.innerHTML = `<p class="text-secondary-blue text-center">${actionType === 'export_metrics' ? 'Export des m√©triques...' : 'G√©n√©ration du contenu IA...'} <i class="fas fa-cogs fa-spin"></i></p>`;

        try {
            const res = await fetch(`${API_BASE}/auto_action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action_type: actionType, query })
            });

            const data = await res.json();
            
            if (res.ok && data.success) {
                resultBox.innerHTML = data.html_response;
                
                // Si c'est un succ√®s (200)
                
                // Mettre √† jour la bo√Æte de partage
                const contentToShare = resultBox.textContent || 'Analyse de croissance Twitch g√©n√©r√©e par l\'IA !';
                document.getElementById('share-content-preview').textContent = contentToShare;
                document.querySelectorAll('.share-btn').forEach(btn => btn.disabled = false);
                
                // Logique pour l'action 'export_metrics'
                if (actionType === 'export_metrics' && data.metrics) {
                    const { views, retention, followers } = data.metrics;
                    document.getElementById('metric-views').textContent = views.toLocaleString('fr-FR');
                    document.getElementById('metric-retention').textContent = `${(retention * 100).toFixed(0)}%`;
                    document.getElementById('metric-followers').textContent = followers;
                    reportBox.style.display = 'block';
                } else {
                    reportBox.style.display = 'none';
                }

            } else if (res.status === 429) {
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Cooldown actif. R√©essayez plus tard.</p>`;
                reportBox.style.display = 'none';
            } else {
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur API (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
                reportBox.style.display = 'none';
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur de connexion au serveur: ${e.message}</p>`;
            reportBox.style.display = 'none';
        } finally {
            document.querySelectorAll('.auto-action-btn').forEach(b => b.disabled = false);
        }
    });

    // Stream Boost
    document.getElementById('form-stream-boost').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('boost-btn');
        const channel = document.getElementById('boost-channel-input').value.trim();
        const boostMessage = document.getElementById('boost-message');

        if (!channel) return;

        btn.disabled = true;
        boostMessage.innerHTML = '<p style="color:yellow;">‚ö° Traitement du Boost...</p>';
        
        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel })
            });
            
            const data = await res.json();
            
             // V√©rification robuste du statut HTTP (pour le 429 de cooldown ou autre erreur)
            if (!res.ok) {
                 boostMessage.innerHTML = data.html_response || `<p style="color:red;">‚ùå Erreur Boost: ${data.error || `Statut HTTP ${res.status}.`}</p>`;
                 return;
            }
            
            boostMessage.innerHTML = data.html_response || `<p style="color:red;">‚ùå Erreur Boost: ${data.error || 'Statut inconnu'}</p>`;
            
        } catch (e) {
            boostMessage.innerHTML = `<p style="color:red;">‚ùå Erreur r√©seau lors de l'appel Boost: ${e.message}</p>`;
        } finally {
             btn.disabled = false;
        }
    });
    
    // --- 6. Logique de Partage Social (Nouvelle Logique) ---

    /**
     * Ouvre une fen√™tre de partage pour le contenu g√©n√©r√©.
     * @param {string} platform - Le r√©seau social (twitter, reddit, discord, etc.)
     * @param {string} text - Le texte √† partager (provenant du rapport IA).
     */
    function shareContent(platform, text) {
        const defaultUrl = 'https://twitch.tv/'; // URL de base √† lier au partage
        // Nous formatons le texte pour qu'il inclut un pr√©ambule.
        const content = `‚ö° Rapport IA Streamer Hub :\n\n${text}\n\n`;
        const formattedText = encodeURIComponent(content);
        let url = '';

        switch (platform) {
            case 'twitter': // Anciennement Twitter, maintenant X
                // Le lien par d√©faut est ajout√© s√©par√©ment pour Twitter
                url = `https://twitter.com/intent/tweet?text=${formattedText}&url=${encodeURIComponent(link)}`;
                break;
            case 'reddit':
                // Reddit a besoin d'un titre et d'un corps de texte
                url = `https://www.reddit.com/submit?title=${encodeURIComponent('Analyse de Croissance Twitch IA')}&text=${formattedText + encodeURIComponent('\n\n') + encodeURIComponent(defaultUrl)}`;
                break;
            case 'discord':
                // Pour Discord, on copie le message. L'utilisateur le collera dans un canal.
                navigator.clipboard.writeText(content).then(() => {
                    alert('‚úÖ Le message de partage a √©t√© copi√© dans votre presse-papiers ! Collez-le sur Discord.');
                }).catch(err => {
                    console.error('Erreur de copie:', err);
                });
                return; // Sortir car aucune fen√™tre pop-up n'est ouverte
            case 'whatsapp':
                // WhatsApp utilise le param√®tre text
                url = `whatsapp://send?text=${formattedText + encodeURIComponent('\n') + encodeURIComponent(defaultUrl)}`;
                break;
            case 'telegram':
                // Telegram utilise le param√®tre text
                url = `https://t.me/share/url?url=${encodeURIComponent(defaultUrl)}&text=${formattedText}`;
                break;
            default:
                return;
        }

        // Ouverture de la fen√™tre pop-up pour les plateformes web
        if (url) {
            window.open(url, '_blank', 'width=600,height=400');
        }
    }

    // --- √âcouteur des Boutons de Partage ---
    document.addEventListener('DOMContentLoaded', function() {
        // ... (votre logique d'initialisation existante) ...
        
        const shareButtonsContainer = document.getElementById('share-buttons');
        const copyLinkButton = document.getElementById('copy-link-btn');
        const shareContentPreview = document.getElementById('share-content-preview');

        // Initialisation du joueur et de l'auth au d√©marrage
        initializePlayer(); 
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        checkAuth();
        
        // Clic sur un bouton de partage
        if (shareButtonsContainer) {
            shareButtonsContainer.addEventListener('click', function(e) {
                const btn = e.target.closest('.share-btn');
                if (!btn) return;

                const platform = btn.dataset.platform;
                const content = shareContentPreview.textContent;
                
                // V√©rification si le contenu est le message par d√©faut
                if (content.includes('Pr√©parez une action')) {
                    alert('Veuillez d\'abord ex√©cuter une action (Clip ou Titre Disruptif) pour g√©n√©rer du contenu √† partager.');
                    return;
                }

                // Ex√©cuter la fonction de partage
                if (platform === 'copy') {
                    // Logique pour le bouton "Copier le Texte"
                    const fullContent = `‚ö° Rapport IA Streamer Hub :\n\n${content}\n\n(Lien vers l'outil: ${window.location.href})`;

                    navigator.clipboard.writeText(fullContent).then(() => {
                        alert('‚úÖ Le rapport IA complet et le lien ont √©t√© copi√©s dans le presse-papiers !');
                    }).catch(err => {
                        console.error('Erreur de copie:', err);
                    });
                } else {
                    shareContent(platform, content);
                }
            });
        }
    });

</script>
</body>
</html>
