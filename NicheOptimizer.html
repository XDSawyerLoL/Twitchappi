<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V7.3 - Viral Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght=400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- VARIABLES CSS & STYLES GLOBALES (Inchag√©s) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert */
            --color-ai-repurpose: #9933ff; /* Violet */
            --color-ai-growth: #ffcc00; /* Jaune */
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
            --color-chat-bubble: #33aaff; /* Bleu clair */
            --color-title-suggest: #ff6600; /* Orange pour le SEO */
        }

        body {
            background-color: var(--color-bg-dark);
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #twitch-lucky-main {
            all: initial;
            display: block;
            max-width: 1200px;
            margin: 20px auto;
            padding: 10px;
            font-family: 'Inter', sans-serif;
            color: #fff; 
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            color: var(--color-primary-pink);
            margin-bottom: 5px;
            text-align: center;
        }
        .h1-blue-accent {
            color: var(--color-secondary-blue);
        }
        .subtitle-center {
            color: var(--color-text-dimmed);
            font-size: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Styles d'Onglets */
        .tab-btn {
            /* ... (Styles inchang√©s) ... */
            font-family: 'Orbitron', sans-serif;
            padding: 12px 15px;
            background: var(--color-bg-light);
            border: 1px solid var(--color-border-medium);
            border-bottom: none;
            color: var(--color-text-dimmed);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            font-size: 12px;
            white-space: nowrap;
        }
        .tab-btn.active {
            background: var(--color-bg-medium);
            color: #fff;
            border-top: 3px solid var(--color-primary-pink);
            font-weight: bold;
        }

        /* Conteneur pour le Drag & Drop */
        #tabs-container {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espace entre les blocs d√©pla√ßables */
        }
        .tab-block {
            background: var(--color-bg-medium);
            border: 1px solid var(--color-border-dark);
            border-radius: 10px;
            margin-bottom: 15px;
            
            /* Styles Drag & Drop */
            cursor: grab;
            user-select: none;
            transition: border-color 0.2s;
        }
        .tab-block:hover {
            border-color: var(--color-primary-pink);
        }
        .tab-block.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary-pink);
        }
        .tab-content {
            padding: 20px;
        }
        
        /* Styles de boutons, inputs, etc. (Inchag√©s) */
        .action-input {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-medium);
            background: var(--color-bg-dark); color: #fff; font-size: 13px; 
        }
        .btn-primary {
            background: var(--color-primary-pink); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px;
            cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px;
            box-shadow: 0 0 6px rgba(255,0,153,.4);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Style sp√©cifique pour le bouton de partage */
        .share-btn {
            background: var(--color-secondary-blue);
            color: var(--color-bg-dark);
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
            transition: background 0.2s;
        }
        .share-btn:hover { background: #1eafdd; }

        /* Autres styles d'affichage des r√©sultats (Inchag√©s) */
        .ai-result-box {
            background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 15px; margin-top: 15px;
            color: #ffffff; 
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl"><span class="h1-blue-accent">STREAMER</span> HUB V7.3</h1>
    <div class="subtitle-center">L'outil viral pour votre croissance. Visionnage r√©compens√© et IA.</div>

    <div class="player-wrapper">
        <h2>
            <span style="margin-right:6px;" id="player-icon">üé¨</span> LECTEUR & CHAT
            <span id="player-channel-status"></span>
            <button id="btn-share-stream" class="share-btn">üîó PARTAGER</button>
        </h2> 
        <form id="form-channel-player">
            <input id="input-channel" type="text" placeholder="Nom de la cha√Æne Twitch (ex: gotaga)" title="Nom de la cha√Æne Twitch √† regarder" class="action-input">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[80px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>
    </div>

    <div id="tabs-container">
        
        <div id="block-account" class="tab-block" draggable="true" data-tab-id="tab-account">
            <button class="tab-btn account-points w-full active" data-tab-id="tab-account" onclick="openTab('tab-account')">üí∞ MON COMPTE (Streampoints)</button>
            <div id="tab-account" class="tab-content active">
                 <h3 class="tab-heading" style="color:var(--color-ai-growth);">
                    <span class="icon">üë§</span> Statut Utilisateur & Streampoints
                </h3>

                <div class="login-box" style="border-color:var(--color-ai-growth);">
                    <h4 class="font-bold text-sm mb-2" style="color:var(--color-secondary-blue);">Connexion Twitch</h4>
                    <p id="login-status" class="text-yellow text-xs mb-4">Statut: D√©connect√©</p>
                    <button id="btn-twitch-login" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px;">
                        üîí SE CONNECTER VIA TWITCH
                    </button>
                </div>
                
                <div class="login-box" style="border-color:var(--color-ai-growth); margin-top: 20px;">
                    <h4 class="font-bold text-sm mb-2" style="color:var(--color-ai-growth);">Votre Solde Streampoints</h4>
                    <p id="streampoints-status" class="text-3xl font-extrabold" style="color:var(--color-ai-growth);">
                        0
                    </p>
                    <p id="streampoints-daily-status" class="text-xs mt-2" style="color:var(--color-text-dimmed);">
                        Bonus quotidien de 5 points disponible.
                    </p>
                    <p class="text-xs mt-2 font-bold" style="color:var(--color-primary-pink);">
                        Gagnez +1 Point par heure de visionnage sur le lecteur !
                    </p>
                </div>
            </div>
        </div>

        <div id="block-followed" class="tab-block" draggable="true" data-tab-id="tab-followed">
            <button class="tab-btn w-full" data-tab-id="tab-followed" onclick="openTab('tab-followed')">üî¥ MON FIL LIVE</button>
            <div id="tab-followed" class="tab-content">
                <h3 class="tab-heading text-pink">
                    <span class="icon">üîë</span> Mon Fil Suivi
                </h3>
                <div class="mt-6 pt-5 border-t border-gray-700" style="border-color: var(--color-border-medium);">
                    <h4 class="tab-heading text-pink">
                        <span class="icon">üî¥</span> Vos Cha√Ænes Suivies LIVE
                    </h4>
                    <div id="followed-streams-list">
                        <p style="color:#555; text-align:center; padding:10px;">Veuillez vous connecter pour voir ceci.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="block-scan-niche" class="tab-block" draggable="true" data-tab-id="tab-scan-niche">
            <button class="tab-btn niche-scan w-full" data-tab-id="tab-scan-niche" onclick="openTab('tab-scan-niche')">üéØ SCAN & ANALYSE V/S</button>
            <div id="tab-scan-niche" class="tab-content">
                <h3 class="tab-heading" style="color:var(--color-secondary-blue);">
                    <span class="icon">üî≠</span> Scan de Cible (Jeu ou Streamer)
                </h3>
                <form id="form-target" class="flex gap-2 mb-2">
                    <input id="input-target" type="text" placeholder="Jeu ou Pseudo" class="action-input">
                    <button type="submit" id="btn-target" class="btn-secondary min-w-[80px]">üéØ CIBLER</button>
                </form>
                <div id="scan-result" class="ai-result-box">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">
                        Entrez un jeu ou un pseudo et cliquez sur CIBLER.
                    </p>
                </div>
                
                <h3 class="tab-heading mt-8" style="color:var(--color-ai-niche);">
                    <span class="icon">üìà</span> Critiques de Niche & D√©tection de Trend IA
                </h3>
                
                <form id="form-niche-analysis" class="flex gap-2 mb-2 mt-4">
                    <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser (ex: Starfield)" class="action-input">
                    <button type="submit" id="btn-niche-analyse" class="btn-secondary min-w-[100px]" style="background:var(--color-ai-niche); color: var(--color-bg-dark);">
                        ‚ú® CRITIQUE IA
                    </button>
                </form>
                <div id="niche-result-container" class="ai-result-box" style="border-color: var(--color-ai-niche);">
                    <div id="niche-results">
                        <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">
                            Analyse la saturation et propose des sous-niches sp√©cifiques.
                        </p>
                    </div>
                </div>

                <h4 class="font-bold text-sm mt-6 mb-2" style="color:var(--color-ai-growth);">D√©tection de Trend V/S</h4>
                <button id="btn-trend-detector" class="btn-primary" style="background:var(--color-ai-growth); color:var(--color-bg-dark); width:100%; padding:12px;">
                    üîÆ D√âTECTER LA PROCHAINE NICHE CHAUDE
                </button>
                <div id="trend-results" class="ai-result-box" style="border-color: var(--color-ai-growth); margin-top: 15px;">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">
                        Analyse des tendances V/S en cours.
                    </p>
                </div>
            </div>
        </div>

        <div id="block-ai-tools" class="tab-block" draggable="true" data-tab-id="tab-ai-tools">
            <button class="tab-btn ai-tools w-full" data-tab-id="tab-ai-tools" onclick="openTab('tab-ai-tools')">üõ†Ô∏è OUTILS IA</button>
            <div id="tab-ai-tools" class="tab-content">
                 <h3 class="tab-heading" style="color:var(--color-ai-repurpose);">
                    <span class="icon">‚úÇÔ∏è</span> Repurposing Contenu IA (VOD vers Shorts/TikTok)
                </h3>
                <form id="form-repurpose" class="flex gap-2 mb-2">
                    <input id="input-repurpose-channel" type="text" placeholder="Pseudo du Streamer pour VOD" class="action-input">
                    <button type="submit" id="btn-repurpose-analyse" class="btn-secondary min-w-[100px]" style="background:var(--color-ai-repurpose);">
                        üöÄ ANALYSER VOD
                    </button>
                </form>
                <div id="repurpose-result-container" class="ai-result-box" style="border-color: var(--color-ai-repurpose);">
                    <div id="repurpose-results">
                        <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">
                            L'IA g√©n√®re des id√©es de clips/shorts bas√©es sur le style du streamer.
                        </p>
                    </div>
                </div>

                <h3 class="tab-heading mt-8" style="color:var(--color-title-suggest);">
                    <span class="icon">üìù</span> Suggestion de Titre & Tag IA (SEO)
                </h3>
                <form id="form-title-suggest">
                    <input id="input-title-game" type="text" placeholder="Jeu (ex: Baldur's Gate 3)" class="action-input mb-2">
                    <input id="input-title-angle" type="text" placeholder="Angle du Stream (ex: D√©fi No Hit / Lore d√©taill√©e / Fun)" class="action-input mb-2">
                    <button type="submit" id="btn-title-suggest" class="btn-primary" style="background:var(--color-title-suggest); width:100%; padding: 12px;">
                        ‚ú® G√âN√âRER TITRES & TAGS SEO
                    </button>
                </form>

                <div id="title-suggest-results" class="ai-result-box" style="border-color: var(--color-title-suggest);">
                    <p style="text-align:center; color:var(--color-text-dimmed); font-weight: bold;">
                        L'IA g√©n√®re 3 titres clickbait/SEO et 10 tags Twitch optimis√©s.
                    </p>
                </div>
            </div>
        </div>

        <div id="block-boost-raid" class="tab-block" draggable="true" data-tab-id="tab-boost-raid">
            <button class="tab-btn boost-raid w-full" data-tab-id="tab-boost-raid" onclick="openTab('tab-boost-raid')">‚ö° BOOST & RAID</button>
            <div id="tab-boost-raid" class="tab-content">
                <h3 class="tab-heading text-pink">
                    <span class="icon">‚¨ÜÔ∏è</span> STREAM BOOST (Co√ªt : 20 Points)
                </h3>
                <div class="login-box mb-6" style="border-color: var(--color-primary-pink);">
                    <p class="text-xs mb-4" style="color:var(--color-text-dimmed);">
                        Activez un boost pour votre cha√Æne ou celle d'un ami. Co√ªte 20 Streampoints.
                    </p>
                    <form id="form-boost" class="flex gap-2">
                        <input id="input-boost" type="text" placeholder="Cha√Æne √† promouvoir" class="action-input">
                        <button type="submit" id="btn-boost" class="btn-primary min-w-[100px]">üì§ BOOST</button>
                    </form>
                    <div id="boost-results" class="ai-result-box" style="border-color: var(--color-primary-pink); margin-top: 15px;">
                        <p style="text-align:center; color: var(--color-text-dimmed);">
                            Entrez le nom de la cha√Æne et cliquez sur BOOST.
                        </p>
                    </div>
                </div>
                
                <h3 class="tab-heading" style="color:#6441a5;">
                    <span class="icon">‚öîÔ∏è</span> Raid Rapide (Fonctionnalit√© D√©pendante du Scope Twitch)
                </h3>
                 <div class="login-box" style="border-color:#6441a5;">
                    <form id="form-raid" class="flex gap-2">
                        <input id="input-raid-target" type="text" placeholder="Cha√Æne cible du Raid (ex: gotaga)" class="action-input">
                        <button type="submit" id="btn-raid" class="btn-primary min-w-[100px]" style="background:#6441a5;">‚öîÔ∏è RAID</button>
                    </form>
                    <div id="raid-results" class="ai-result-box" style="border-color: #6441a5; margin-top: 15px;">
                        <p style="text-align:center; color: var(--color-text-dimmed);">
                            Connectez-vous avec le scope 'channel:manage:raids' pour initier un Raid.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="social-share-container" class="mt-8 pt-4 border-t border-gray-700 max-w-lg mx-auto" style="border-color:var(--color-border-medium);">
        <h4 class="text-white text-lg mb-3 font-semibold border-l-2 border-l-primary-pink pl-2">‚≠ê Aidez-nous √† grandir, Partagez !</h4>
        <div class="flex space-x-4">
            <button onclick="sharePageGeneric('twitter')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm">
                Partager sur X
            </button>
            <button onclick="sharePageGeneric('facebook')" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm">
                Partager sur Facebook
            </button>
        </div>
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 
    const STREAMPPOINTS_COST_BOOST = 20;

    let twitchUserConnected = false; 
    let currentStreampoints = 0;
    let currentChannel = DEFAULT_CHANNEL;
    let currentChannelGame = 'Just Chatting'; // √Ä mettre √† jour par le Player Listener si possible

    // Variables pour le suivi du temps de visionnage
    let watchTimeInterval = null;
    let watchTimeMinutes = 0;
    const WATCH_TIME_UPDATE_INTERVAL_MS = 60000; // 1 minute

    // --- Glisser-D√©poser des Blocs (NOUVEAU) ---
    const TABS_ORDER_KEY = 'tabsOrder';
    const tabsContainer = document.getElementById('tabs-container');
    let draggedItem = null;

    function saveTabsOrder() {
        const order = Array.from(tabsContainer.children).map(child => child.id);
        localStorage.setItem(TABS_ORDER_KEY, JSON.stringify(order));
    }

    function loadTabsOrder() {
        const savedOrder = localStorage.getItem(TABS_ORDER_KEY);
        if (savedOrder) {
            const order = JSON.parse(savedOrder);
            const fragment = document.createDocumentFragment();

            order.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    fragment.appendChild(element);
                }
            });
            tabsContainer.appendChild(fragment);
        }
    }

    // Gestion des √©v√©nements de Drag & Drop
    tabsContainer.addEventListener('dragstart', (e) => {
        draggedItem = e.target.closest('.tab-block');
        if (draggedItem) {
            setTimeout(() => draggedItem.classList.add('dragging'), 0);
            e.dataTransfer.setData('text/plain', draggedItem.id);
        }
    });

    tabsContainer.addEventListener('dragend', () => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
        saveTabsOrder();
    });

    tabsContainer.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        const target = e.target.closest('.tab-block');
        if (target && target !== draggedItem) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / rect.height > 0.5;
            tabsContainer.insertBefore(draggedItem, next ? target.nextSibling : target);
        }
    });

    // --- Gestion des Onglets (Mis √† jour pour le drag & drop) ---
    function openTab(tabId) {
        // En mode blocs, on active le contenu en bas du bouton cliqu√©
        const container = document.getElementById(tabId).closest('.tab-block');
        
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        if (container) {
            document.getElementById(tabId).style.display = 'block';
            container.querySelector('.tab-btn').classList.add('active');
        }
    }

    // --- Lecteur Twitch (Mise √† jour pour le Watchtime) ---
    let embed = null;
    const twitchEmbedContainer = document.getElementById('twitch-embed');
    const inputChannel = document.getElementById('input-channel');
    const btnShareStream = document.getElementById('btn-share-stream');

    function launchPlayer(channelName, gameName = 'Jeu Inconnu') {
        if (!channelName) return;

        currentChannel = channelName;
        currentChannelGame = gameName; // D√©faut ou mis √† jour par l'API
        localStorage.setItem('activeChannel', channelName);
        inputChannel.value = channelName;

        twitchEmbedContainer.innerHTML = '';
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: 550,
            channel: channelName,
            layout: "video-and-chat", 
            autoplay: true,
            parent: [window.location.hostname] 
        });
        document.getElementById('player-channel-status').textContent = `Cha√Æne: ${channelName.toUpperCase()}`;
        
        // D√©marrer ou r√©initialiser le suivi du temps de visionnage
        startWatchTimeTracking();
    }
    
    // --- Suivi du Temps de Visionnage (NOUVEAU) ---
    function startWatchTimeTracking() {
        if (watchTimeInterval) {
            clearInterval(watchTimeInterval);
            watchTimeInterval = null;
        }
        watchTimeMinutes = 0; // R√©initialiser le compteur √† chaque nouveau stream
        
        if (twitchUserConnected) {
            watchTimeInterval = setInterval(() => {
                watchTimeMinutes++;
                if (watchTimeMinutes >= 60) { // Toutes les 60 minutes
                    sendWatchTimeUpdate();
                    watchTimeMinutes = 0;
                }
            }, WATCH_TIME_UPDATE_INTERVAL_MS);
            console.log("Suivi du temps de visionnage d√©marr√©.");
        }
    }

    async function sendWatchTimeUpdate() {
        if (!twitchUserConnected || watchTimeMinutes === 0) return;
        
        const minutesToSend = watchTimeMinutes;
        
        try {
            const res = await fetch(`${API_BASE}/earn_streampoints_watchtime`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ minutes_watched: minutesToSend }) 
            });
            
            const data = await res.json();

            if (res.ok && data.success) {
                console.log(`Watchtime enregistr√©. Points gagn√©s: ${data.points_earned}.`);
                currentStreampoints = data.new_points;
                updateStreampointsDisplay();
            } else {
                console.error("√âchec de l'enregistrement du temps de visionnage:", data.error);
            }
        } catch(e) {
            console.error("Erreur d'API Watchtime:", e);
        }
        // Le compteur est r√©initialis√© dans la boucle si l'envoi a r√©ussi, ou il continuera √† s'accumuler
    }

    // --- Authentification et Streampoints ---
    // ... (Code checkAuth inchang√© dans la logique de base) ...
    // Le reste du code de connexion est g√©r√© par la fonction ci-dessous
    const btnLogin = document.getElementById('btn-twitch-login');
    const loginStatus = document.getElementById('login-status');
    const streampointsStatus = document.getElementById('streampoints-status');
    const streampointsDailyStatus = document.getElementById('streampoints-daily-status');
    const btnBoost = document.getElementById('btn-boost');

    async function checkAuth() {
        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            if(res.ok) {
                const data = await res.json();
                if(data.is_connected) {
                    twitchUserConnected = true;
                    loginStatus.innerHTML = `‚úÖ Connect√© en tant que <strong style="color:var(--color-secondary-blue)">${data.username}</strong>`;
                    btnLogin.textContent = "üîí D√âCONNEXION";
                    btnLogin.style.background = "#e34a64"; 
                    loadFollowedStreams(); 
                    loadStreampoints(); 
                } else {
                    handleLogoutState();
                }
            } else {
                handleLogoutState();
                loginStatus.innerHTML = `‚ùå Erreur API (${res.status}). Veuillez v√©rifier le serveur backend.`;
            }
        } catch(e) {
            handleLogoutState();
            loginStatus.innerHTML = `‚ùå Erreur technique: ${e.message}.`;
        }
    }

    function handleLogoutState() {
        twitchUserConnected = false;
        loginStatus.textContent = "Statut: D√©connect√©.";
        btnLogin.textContent = "üîí SE CONNECTER VIA TWITCH";
        btnLogin.style.background = "#6441a5"; 
        document.getElementById('followed-streams-list').innerHTML = '<p style="color:var(--color-ai-growth); text-align:center;">Veuillez vous connecter pour voir ceci.</p>';
        currentStreampoints = 0;
        updateStreampointsDisplay();
        btnBoost.disabled = true;
        if (watchTimeInterval) {
            clearInterval(watchTimeInterval);
            watchTimeInterval = null;
        }
    }

    async function loadStreampoints() {
         if(!twitchUserConnected) return;

         try {
            const res = await fetch(`${API_BASE}/user_streampoints`);
            const data = await res.json();

            if (data.is_connected) {
                currentStreampoints = data.points;
                updateStreampointsDisplay();

                if (data.daily_bonus_claimed) {
                    streampointsDailyStatus.innerHTML = `<span style="color:var(--color-ai-niche); font-weight:bold;">‚úÖ Bonus quotidien (+5 pts) r√©clam√© aujourd'hui.</span>`;
                } else {
                    streampointsDailyStatus.innerHTML = `Bonus quotidien de 5 points disponible.`;
                }
                
                startWatchTimeTracking(); // Assurez-vous que le suivi est actif
            } else {
                currentStreampoints = 0;
                updateStreampointsDisplay();
                streampointsDailyStatus.textContent = "Non connect√©.";
            }
         } catch(e) {
             currentStreampoints = 0;
             updateStreampointsDisplay();
             streampointsDailyStatus.textContent = "Erreur de chargement !";
             console.error("Erreur Streampoints:", e);
         }
    }

    function updateStreampointsDisplay() {
        streampointsStatus.innerHTML = `${currentStreampoints.toLocaleString('fr-FR')} <span class="text-base" style="color:var(--color-text-dimmed);">Points</span>`;
        btnBoost.disabled = currentStreampoints < STREAMPPOINTS_COST_BOOST || !twitchUserConnected;
    }

    // --- Logique du Stream Boost (Payant) ---
    document.getElementById('form-boost').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim();
        const resultBox = document.getElementById('boost-results'); 
        const btn = document.getElementById('btn-boost');

        if (!channel || btn.disabled) return;
        
        resultBox.innerHTML = `<p style="color:var(--color-primary-pink); text-align:center;">üí∞ V√©rification des ${STREAMPPOINTS_COST_BOOST} points et envoi du boost...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();

            if (res.ok) {
                // Succ√®s: Points d√©pens√©s, Boost activ√©
                resultBox.innerHTML = data.html_response;
                launchPlayer(channel); 
                // Mettre √† jour le solde (la r√©ponse HTML peut contenir le nouveau solde, mais on le recharge pour √™tre s√ªr)
                loadStreampoints(); 
            } else {
                // √âchec (Cooldown, Fonds Insuffisants, etc.)
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå √âchec: ${data.error || "Erreur inconnue."}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            // La d√©sactivation/r√©activation est g√©r√©e par la v√©rification du solde dans updateStreampointsDisplay()
            // On peut cependant r√©activer le bouton *si* l'erreur n'est pas due √† un solde insuffisant ou un cooldown
            btn.disabled = currentStreampoints < STREAMPPOINTS_COST_BOOST;
        }
    });

    // --- Fonction de Partage de Stream (NOUVEAU) ---
    btnShareStream.addEventListener('click', () => {
        const streamUrl = `https://twitch.tv/${currentChannel}`;
        const title = `Je regarde ${currentChannel} jouer √† ${currentChannelGame} sur Twitch via le Streamer AI Hub.`;

        if (navigator.share) {
            navigator.share({
                title: 'Streamer AI Hub',
                text: title,
                url: streamUrl,
            }).catch(error => console.error('Erreur de partage:', error));
        } else {
            // Fallback pour les navigateurs non support√©s (utilise le partage g√©n√©rique)
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(streamUrl)}`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
        }
    });

    // --- Fonctions Partage G√©n√©rique (Inchag√©es) ---
    function sharePageGeneric(platform) {
        const url = window.location.href;
        const text = encodeURIComponent("J'utilise l'outil Streamer & Niche AI Hub pour optimiser ma croissance sur Twitch/YouTube ! #StreamerAI #GrowthHacking");
        
        let shareUrl = "";

        switch (platform) {
            case 'twitter':
                shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
                break;
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                break;
            default:
                return;
        }

        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
    
    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', function() {
        loadTabsOrder(); // Charger l'ordre des blocs
        initializePlayer();
        checkAuth();
        
        // Initialiser l'affichage des onglets
        const tabs = ['tab-account', 'tab-followed', 'tab-scan-niche', 'tab-ai-tools', 'tab-boost-raid'];
        // Fermer tous les contenus par d√©faut (pour que seule l'ouverture par le bouton fonctionne)
        tabs.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
        
        // Ouvrir l'onglet Mon Compte par d√©faut au lancement
        openTab('tab-account'); 
    });
</script>
</body>
</html>
