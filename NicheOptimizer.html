<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Twitch & Gemini Pro</title>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <style>
        :root { --bg: #0e0e10; --card: #18181b; --text: #efeff1; --accent: #a970ff; --success: #4ade80; --error: #ff4f4d; --wait: #fbbf24; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        /* Structure */
        .container { display: flex; width: 100%; gap: 20px; height: 90vh; }
        .column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        
        /* Twitch Section */
        #twitch-header { display: flex; justify-content: space-between; align-items: center; background: #26262c; padding: 10px 15px; border-radius: 8px 8px 0 0; }
        #twitch-container { background: var(--card); border-radius: 0 0 8px 8px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #twitch-embed { flex-grow: 1; background: #000; width: 100%; height: 100%; }
        .timer-bar-container { height: 6px; background: #333; width: 100%; }
        .timer-bar { height: 100%; background: var(--accent); width: 100%; transition: width 1s linear; }
        
        /* Gemini Section */
        .control-panel { background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #333; flex-grow: 1; display: flex; flex-direction: column; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        button { flex: 1; background: var(--accent); color: white; border: none; padding: 15px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: background 0.2s; }
        button:hover { background: #9147ff; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        
        #status-display { margin-bottom: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 10px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; display: inline-block; }
        .dot.ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.wait { background: var(--wait); box-shadow: 0 0 8px var(--wait); }
        .dot.error { background: var(--error); box-shadow: 0 0 8px var(--error); }

        #output-area { background: #1f1f23; padding: 20px; border-radius: 6px; flex-grow: 1; white-space: pre-wrap; overflow-y: auto; font-family: 'Consolas', monospace; border-left: 4px solid var(--accent); line-height: 1.6; font-size: 0.95rem; color: #d3d3d3; }
        #output-area strong { color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div class="column">
        <div>
            <div id="twitch-header">
                <strong>üì∫ Focus Stream (0-100 viewers)</strong>
                <span id="current-channel" style="color:var(--accent); font-weight:bold;">Chargement...</span>
            </div>
            <div id="twitch-container">
                <div id="twitch-embed"></div>
                <div class="timer-bar-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
            </div>
        </div>
        <small style="color:#aaa;">*Rotation automatique toutes les 3 minutes. Le player se recharge compl√®tement √† chaque cycle pour √©viter les √©crans noirs.*</small>
    </div>

    <div class="column">
        <div class="control-panel">
            <h2 style="margin-top:0;">üß† Analyse IA (Mode Pro)</h2>
            
            <div id="status-display">
                <span class="dot ok" id="status-dot"></span>
                <span id="status-text">Syst√®me Pr√™t (Gemini Pro)</span>
            </div>

            <div class="btn-group">
                <button onclick="runGeminiAnalysis('CRITIQUE NICHE (IA)')">üì¢ Critique Niche</button>
                <button onclick="runGeminiAnalysis('BEST NICHE')">üèÜ Best Niche</button>
            </div>
            
            <div id="output-area">Les r√©sultats de l'IA s'afficheront ici...</div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIGURATION =================
    const GEMINI_API_KEY = "TA_CLE_API_ICI"; // ‚ö†Ô∏è METS TA CL√â ICI
    
    // Si tu as vraiment acc√®s √† Gemini 3, remplace 'gemini-1.5-pro' par 'gemini-3.0-pro' ci-dessous.
    // Mais 'gemini-1.5-pro' est la valeur s√ªre pour ton forfait actuel.
    const GEMINI_MODEL = "gemini-1.5-pro"; 
    
    const TWITCH_ROTATION_MS = 180000; // 3 minutes
    // =================================================

    // --- PARTIE TWITCH ---
    
    // Liste simul√©e (Remplacer par ton appel API Helix si tu l'as)
    // Astuce: Mets des cha√Ænes qui sont souvent en live pour tester
    let streamList = ["monstercat", "solary", "otplol_", "zerator"]; 
    let currentIndex = 0;
    let timerInterval = null;

    function initTwitch() {
        loadStream(streamList[0]);
        startTimer();
    }

    function loadStream(channelName) {
        const container = document.getElementById("twitch-embed");
        container.innerHTML = ""; // Reset propre du DOM
        
        document.getElementById("current-channel").innerText = channelName.toUpperCase();

        new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: "100%",
            channel: channelName,
            layout: "video",
            autoplay: true,
            muted: false,
            parent: ["localhost", "127.0.0.1"] // ‚ö†Ô∏è AJOUTE TON DOMAINE EN PROD
        });
    }

    function rotateStream() {
        currentIndex = (currentIndex + 1) % streamList.length;
        // Ici tu pourrais ajouter: fetchNewStreamsFromAPI()
        loadStream(streamList[currentIndex]);
        startTimer();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        
        const bar = document.getElementById("timer-bar");
        let percent = 100;
        const step = 100 / (TWITCH_ROTATION_MS / 1000); // % par seconde
        
        bar.style.width = "100%";
        
        timerInterval = setInterval(() => {
            percent -= step;
            if (percent <= 0) {
                rotateStream();
            } else {
                bar.style.width = percent + "%";
            }
        }, 1000);
    }

    // --- PARTIE GEMINI (Fix 429 & Pro Plan) ---

    async function runGeminiAnalysis(type) {
        const output = document.getElementById("output-area");
        const dot = document.getElementById("status-dot");
        const statusText = document.getElementById("status-text");
        
        // UI Loading
        output.innerText = "‚è≥ Interrogation de l'IA en cours...";
        dot.className = "dot wait";
        statusText.innerText = "Analyse en cours...";
        
        // D√©finition du prompt
        let prompt = "";
        if (type === 'CRITIQUE NICHE (IA)') {
            prompt = "Analyse de fa√ßon critique et brutale les niches actuelles sur Twitch. Identifie 3 erreurs que tout le monde fait et donne 1 opportunit√© 'Oc√©an Bleu' inexploit√©e.";
        } else {
            prompt = "Quelle est la meilleure niche √©mergente pour un streamer d√©butant aujourd'hui ? R√©ponse courte, argument√©e avec des donn√©es probables.";
        }

        try {
            const responseText = await callGeminiAPI(prompt);
            
            // Affichage propre Markdown simple
            const formatted = responseText
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#a970ff">$1</strong>') // Gras color√©
                .replace(/## (.*?)\n/g, '<h3>$1</h3>') // Titres
                .replace(/\n/g, '<br>'); // Sauts de ligne

            output.innerHTML = formatted;
            dot.className = "dot ok";
            statusText.innerText = "Termin√© avec succ√®s";
            
        } catch (err) {
            output.innerHTML = `<span style="color:#ff4f4d">‚ùå ERREUR: ${err.message}</span>`;
            dot.className = "dot error";
            statusText.innerText = "Erreur API";
        }
    }

    async function callGeminiAPI(userPrompt) {
        // Utilisation de l'endpoint standard (non-exp√©rimental) pour b√©n√©ficier du quota PRO
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        const payload = {
            contents: [{
                parts: [{ text: userPrompt }]
            }]
        };

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
            // Gestion d'erreur d√©taill√©e
            if (data.error) {
                if (data.error.code === 429) {
                    throw new Error("Quota d√©pass√© (429). M√™me en Pro, v√©rifie que tu n'utilises pas un mod√®le 'Experimental' ou que tu n'as pas atteint le plafond journalier.");
                }
                throw new Error(`${data.error.message} (Code: ${data.error.code})`);
            }
            throw new Error(`Erreur HTTP: ${response.status}`);
        }

        // Extraction de la r√©ponse
        return data.candidates[0].content.parts[0].text;
    }

    // D√©marrage
    window.onload = initTwitch;
</script>
</body>
</html>
