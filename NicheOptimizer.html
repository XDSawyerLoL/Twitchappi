<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streamer Hub ‚Äì Pro Analytics & TwitFlix</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:hidden;
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background:#000; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--secondary); }

    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }

    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    .hub-msg{ padding:8px; border-bottom:1px solid #1a1a1a; font-size:13px; line-height:1.4; }
    .hub-msg strong{ font-family:Orbitron; font-size:11px; }
    .scrollbar-thin::-webkit-scrollbar{ width:4px; }

    /* badge statut */
    #socket-status{ transition:all .3s ease; }
    #socket-status.connected{
      color:#00f2ea; border-color:#00f2ea;
      box-shadow:0 0 8px rgba(0,242,234,.6);
      animation:hub-pulse 2s infinite;
    }
    @keyframes hub-pulse{ 0%,100%{opacity:1} 50%{opacity:.6} }

    /* BEST TIME TOOL */
    .best-time-tool{
      background:#151515; border:1px solid #00f2ea; border-radius:10px;
      padding:16px; margin-bottom:16px; box-shadow:inset 0 0 10px rgba(0,242,234,.1);
    }
    .best-time-tool h4{
      color:#00f2ea; font-family:Orbitron; font-size:12px;
      margin-bottom:10px; border-bottom:1px solid #00f2ea; padding-bottom:8px;
    }
    .best-time-tool input{
      width:100%; padding:10px; background:#0a0a0a; border:1px solid #333;
      color:#fff; border-radius:6px; font-size:12px; margin-bottom:8px;
    }
    .best-time-tool input:focus{ border-color:#00f2ea; box-shadow:0 0 8px rgba(0,242,234,.2); outline:none; }
    .best-time-tool button{
      width:100%; background:#00f2ea; color:#000; padding:10px;
      border:none; border-radius:6px; font-weight:bold; cursor:pointer;
      font-family:Orbitron; font-size:11px; transition:all .3s ease;
    }
    .best-time-tool button:hover:not(:disabled){ background:#fff; box-shadow:0 0 15px rgba(0,242,234,.4); transform:translateY(-1px); }
    .best-time-tool button:disabled{ opacity:.5; cursor:not-allowed; }
    .best-time-results{
      background:#0a0a0a; border:1px solid #333; border-radius:6px;
      padding:12px; margin-top:12px; font-size:12px; max-height:220px; overflow-y:auto;
    }
    .best-time-spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(0,242,234,.3); border-radius:50%;
      border-top-color:#00f2ea; animation:bt-spin 1s linear infinite;
      margin-right:6px; vertical-align:middle;
    }
    @keyframes bt-spin{ to{ transform:rotate(360deg) } }

    /* PLAYER sizing (grand) */
    .player-shell{ min-height:72vh; }
    #video-container{ min-height:62vh; }

    /* ====== ONGLETS SOUS LE LIVE (ind√©pendants) ====== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }

    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* ====== TWITFLIX MODAL (Netflix-like) ====== */
    .tf-modal-overlay{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,.92);
      backdrop-filter: blur(6px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .tf-modal-overlay.active{ display:flex; animation: tfFade .25s ease; }
    @keyframes tfFade{ from{opacity:0} to{opacity:1} }

    .tf-modal-content{
      width: 92%;
      max-width: 1300px;
      height: 88vh;
      background: #060606;
      border: 1px solid #222;
      border-radius: 16px;
      overflow: hidden;
      display:flex;
      flex-direction:column;
      box-shadow: 0 0 60px rgba(0,0,0,.6);
      position:relative;
    }

    .tf-topbar{
      position:sticky;
      top:0;
      z-index:5;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      background: linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.72), rgba(0,0,0,0));
    }

    .tf-brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .tf-brand .logo{
      font-family: Orbitron, sans-serif;
      letter-spacing: 2px;
      font-weight: 900;
      font-size: 22px;
      color: #ff1b3d; /* netflix-ish red */
      text-shadow: 0 0 10px rgba(255,27,61,.15);
    }
    .tf-brand .sub{
      font-size: 11px;
      color:#777;
      border:1px solid #222;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }

    .tf-search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      max-width: 640px;
      margin: 0 10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      background: rgba(10,10,10,.65);
      transition: .2s;
    }
    .tf-search:focus-within{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 18px rgba(255,255,255,.06);
      background: rgba(10,10,10,.82);
    }
    .tf-search i{ color:#9a9a9a; font-size: 13px; }
    .tf-search input{
      width:100%;
      background: transparent;
      outline:none;
      border:none;
      color:#fff;
      font-size: 13px;
    }

    .tf-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tf-btn{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color:#ddd;
      font-size: 12px;
      padding: 9px 12px;
      border-radius: 10px;
      cursor:pointer;
      transition: .18s;
    }
    .tf-btn:hover{
      background: rgba(255,255,255,.10);
      color:#fff;
      transform: translateY(-1px);
    }
    .tf-close{
      width: 38px; height: 38px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#bbb;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition:.18s;
    }
    .tf-close:hover{ color:#fff; transform: rotate(90deg); }

    .tf-body{
      flex:1;
      overflow-y:auto;
      padding: 0 18px 18px 18px;
    }

    .tf-hero{
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
      background: radial-gradient(1200px 400px at 20% 20%, rgba(255,27,61,.10), transparent),
                  radial-gradient(900px 400px at 70% 30%, rgba(0,242,234,.08), transparent),
                  linear-gradient(to bottom, rgba(255,255,255,.03), rgba(0,0,0,.0));
      padding: 16px;
      margin: 6px 0 16px 0;
    }
    .tf-hero h3{
      font-family: Orbitron, sans-serif;
      letter-spacing:1px;
      font-size: 14px;
      color:#fff;
      margin-bottom: 6px;
    }
    .tf-hero p{
      font-size: 12px;
      color:#aaa;
      line-height: 1.4;
    }

    .tf-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      align-content:start;
    }

    /* Netflix-like card */
    .nf-card{
      position:relative;
      aspect-ratio: 2/3;
      border-radius: 10px;
      overflow:hidden;
      cursor:pointer;
      background: #0a0a0a;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nf-card:hover{
      transform: scale(1.06);
      z-index: 10;
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
    }

    .nf-poster, .nf-preview{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .nf-poster{ filter: saturate(1.05) contrast(1.05); }
    .nf-preview{
      display:none;
      background:#000;
    }

    .nf-gradient{
      position:absolute;
      inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.90) 0%, rgba(0,0,0,.25) 45%, rgba(0,0,0,.0) 70%);
      pointer-events:none;
      opacity:.95;
      transition: opacity .18s ease;
    }
    .nf-card:hover .nf-gradient{ opacity: 1; }

    .nf-meta{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: 10px 10px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .nf-title{
      font-size: 12px;
      font-weight: 800;
      color:#fff;
      line-height: 1.2;
      text-shadow: 0 2px 10px rgba(0,0,0,.5);
      max-height: 2.4em;
      overflow:hidden;
    }
    .nf-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .nf-play{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background: rgba(255,255,255,.92);
      color:#000;
      font-weight: 800;
      font-size: 11px;
      padding: 7px 10px;
      border-radius: 9px;
      transition: .15s;
    }
    .nf-play i{ font-size: 10px; }
    .nf-play:hover{ background:#fff; transform: translateY(-1px); }

    .nf-badge{
      margin-left:auto;
      font-size: 10px;
      color:#bbb;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .tf-empty{
      border:1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 18px;
      color:#aaa;
      text-align:center;
      background: rgba(255,255,255,.02);
    }

    .tf-loading{
      text-align:center;
      color:#aaa;
      padding: 18px 0;
      font-size: 12px;
    }
    .tf-loading i{ margin-right:8px; }

    @media (max-width: 640px){
      .tf-search{ display:none; }
      .tf-grid{ grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
  </style>
</head>

<body class="h-screen flex flex-col p-4">

  <header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-orbitron italic tracking-widest">
        <span class="text-[#00f2ea]">STREAMER</span> HUB
        <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">PRO</span>
      </h1>
      <div id="socket-status" class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">
        HUB DISCONNECTED
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="openTwitFlix()" class="bg-[#111] hover:bg-[#222] text-[#ff0099] px-4 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#333] hover:border-[#ff0099] shadow-[0_0_10px_rgba(255,0,153,0.1)]">
        <i class="fas fa-play-circle"></i> TWITFLIX
      </button>

      <div class="h-6 w-[1px] bg-[#333]"></div>

      <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
        <i class="fab fa-twitch"></i> CONNEXION
      </button>

      <div id="user-area" class="hidden flex items-center gap-3">
        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-[#00f2ea]">
        <span id="user-name" class="font-bold text-white text-sm"></span>
        <button onclick="logout()" class="text-gray-500 hover:text-white">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="mb-4 relative group">
    <div id="carousel" class="carousel-track">
      <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
        <i class="fas fa-satellite-dish mb-2"></i><br>
        Connectez-vous pour voir vos cha√Ænes.
      </div>
    </div>
    <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
  </div>

  <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">

    <div class="lg:col-span-8 flex flex-col gap-4 min-h-0">

      <div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl player-shell">
        <div class="bg-[#080808] p-3 flex justify-between items-center border-b border-[#222]">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
            <span id="current-channel-display" class="font-orbitron text-[#00f2ea] text-sm tracking-wider truncate">OFFLINE</span>
            <span id="player-mode-badge" class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400 flex-shrink-0">AUTO</span>
            <span id="viewer-count" class="text-[10px] text-[#ff0099] font-bold flex-shrink-0">0 viewers</span>
          </div>

          <div class="flex gap-2 flex-shrink-0">
            <button onclick="cycle('prev')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button onclick="cycle('next')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div id="video-container" class="flex-grow bg-black relative w-full h-full overflow-hidden"></div>
      </div>

      <div class="glass-panel rounded-lg overflow-hidden min-h-[360px]">
        <div class="u-nav" id="under-tabs-nav">
          <button class="u-tab-btn active" data-ut="overview"><i class="fas fa-bolt mr-1"></i> OVERVIEW</button>
          <button class="u-tab-btn" data-ut="analytics"><i class="fas fa-chart-line mr-1"></i> ANALYTICS PRO</button>
          <button class="u-tab-btn" data-ut="niche"><i class="fas fa-compass mr-1"></i> NICHE</button>
        </div>

        <div id="under-overview" class="u-tab-panel active p-4 bg-[#0b0b0d]">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Growth Score</div>
              <div id="kpi-growth-score" class="text-2xl font-orbitron text-[#00f2ea]">--</div>
              <div id="kpi-growth-label" class="text-[10px] text-gray-400 mt-1">--</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Moy. viewers (30j)</div>
              <div id="kpi-avg" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">donn√©es Firestore</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Pic viewers</div>
              <div id="kpi-peak" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">sur p√©riode</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Croissance</div>
              <div id="kpi-growth" class="text-2xl font-orbitron text-[#ff0099]">--</div>
              <div class="text-[10px] text-gray-500 mt-1">d√©but ‚Üí fin</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-bell mr-1"></i> Alertes automatiques
              </h4>
              <div id="alerts-box" class="text-xs text-gray-400">‚Äî</div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-wave-square mr-1"></i> Courbe daily
              </h4>
              <div class="h-44"><canvas id="chartChannelDaily"></canvas></div>
            </div>

            <div class="bg-[#111] p-3 rounded border border-[#222] lg:col-span-2">
              <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
                <i class="fas fa-magic mr-1"></i> IA ‚Äì plan d‚Äôaction
              </h4>
              <button id="btn-ai-reco" onclick="loadAIReco()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
                ‚ö° G√©n√©rer des recommandations
              </button>
              <div id="ai-reco-box" class="mt-3 text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto bg-[#0a0a0a] border border-[#222] rounded p-2 hidden"></div>
            </div>
          </div>
        </div>

        <div id="under-analytics" class="u-tab-panel p-4 bg-[#0b0b0d]">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Volatilit√©</div>
              <div id="kpi-volatility" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">plus bas = plus stable</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">Heures / semaine (estim.)</div>
              <div id="kpi-hours" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">bas√© sur snapshots</div>
            </div>
            <div class="bg-[#111] p-3 rounded border border-[#222]">
              <div class="text-[10px] text-gray-500 uppercase">√âchantillons</div>
              <div id="kpi-samples" class="text-2xl font-orbitron text-white">--</div>
              <div class="text-[10px] text-gray-500 mt-1">jours couverts</div>
            </div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-flask mr-1"></i> Simulation</h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
              <input id="sim-hours" type="number" min="1" max="80" value="12" class="cyber-input" placeholder="Heures / semaine">
              <button onclick="runSimulation()" class="bg-[#ff0099] text-white px-4 rounded font-bold hover:bg-white hover:text-black transition font-orbitron text-xs">
                SIMULER
              </button>
              <div id="sim-result" class="text-xs text-gray-300 flex items-center bg-[#0a0a0a] border border-[#222] rounded px-3">--</div>
            </div>
          </div>
        </div>

        <div id="under-niche" class="u-tab-panel p-4 bg-[#0b0b0d]">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-crosshairs mr-1"></i> Cha√Æne vs Jeu</h4>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Saturation</div>
                <div id="niche-sat" class="text-xl font-orbitron text-[#00f2ea]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">D√©couvrabilit√©</div>
                <div id="niche-discover" class="text-xl font-orbitron text-[#ff0099]">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Position</div>
                <div id="niche-position" class="text-xl font-orbitron text-white">--</div>
              </div>
              <div>
                <div class="text-[10px] text-gray-500 uppercase">Verdict</div>
                <div id="niche-verdict" class="text-xl font-orbitron text-white">--</div>
              </div>
            </div>

            <div class="mt-3 text-xs text-gray-300" id="niche-details">‚Äî</div>
          </div>

          <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-fire mr-1"></i> Heatmap meilleures heures (jeu)</h4>
            <div class="h-44"><canvas id="chartGameHours"></canvas></div>
            <div class="text-[10px] text-gray-500 mt-2">Plus haut = plus d‚Äôopportunit√© (viewers / concurrence).</div>
          </div>
        </div>
      </div>
    </div>

    <div class="lg:col-span-4 flex flex-col glass-panel rounded-lg overflow-hidden h-full min-h-0">
      <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab(event,'chat')"><i class="fas fa-comments mr-1"></i> CHAT</button>
        <button class="tab-btn" onclick="openTab(event,'stats')"><i class="fas fa-chart-pie mr-1"></i> STATS</button>
        <button class="tab-btn" onclick="openTab(event,'tools')"><i class="fas fa-toolbox mr-1"></i> OUTILS</button>
      </div>

      <div id="tab-chat" class="tab-content active bg-[#0e0e10]">
        <div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222]">
          <button onclick="toggleChatMode('twitch')" id="btn-mode-twitch" class="flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded">TWITCH</button>
          <button onclick="toggleChatMode('hub')" id="btn-mode-hub" class="flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white">HUB SECURE</button>
        </div>

        <div id="chat-container-twitch" class="flex-grow relative bg-black overflow-hidden">
          <iframe id="twitch-chat-frame" src="" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no"></iframe>
        </div>

        <div id="chat-container-hub" class="flex-grow hidden flex-col relative bg-[#0b0b0d]">
          <div id="hub-messages" class="flex-grow overflow-y-auto p-2 scrollbar-thin">
            <div class="text-center text-gray-600 text-xs mt-4">
              Bienvenue sur le Hub S√©curis√© ‚Äî Connect√© en tant que : <span id="hub-user-display" class="text-[#00f2ea] font-bold">Anonyme</span>
            </div>
          </div>
          <form onsubmit="sendHubMessage(event)" class="p-2 border-t border-[#222] flex gap-2 bg-[#080808]">
            <input id="hub-input" type="text" placeholder="Message..." class="bg-[#1a1a1a] text-white text-xs p-2 rounded flex-grow outline-none border border-[#333] focus:border-[#00f2ea]">
            <button type="submit" class="text-[#00f2ea] px-2"><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>

      <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] scrollbar-thin">
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
            <div class="text-[10px] text-gray-500 uppercase">Viewers Totaux</div>
            <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
          </div>
          <div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
            <div class="text-[10px] text-gray-500 uppercase">Cha√Ænes FR</div>
            <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-chart-line mr-1"></i> Tendance</h4>
            <div class="h-40"><canvas id="chartViewers"></canvas></div>
          </div>
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
            <div class="h-48"><canvas id="chartGames"></canvas></div>
          </div>
          <div class="bg-[#111] p-3 rounded border border-[#222]">
            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
            <div class="h-40"><canvas id="chartLangs"></canvas></div>
          </div>
        </div>
      </div>

      <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] space-y-6 scrollbar-thin">

        <div class="best-time-tool">
          <h4>üéØ BEST TIME TO STREAM</h4>
          <input id="best-time-game" type="text" placeholder="Jeu ex: League of Legends...">
          <button id="analyze-schedule-btn" onclick="analyzeBestTime()"><i class="fas fa-clock"></i> ANALYSER</button>
          <div id="best-time-loading" style="display:none; text-align:center; margin-top:10px; color:#00f2ea;">
            <span class="best-time-spinner"></span>Analyse en cours...
          </div>
          <div id="best-time-results" class="best-time-results" style="display:none;"></div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">SCANNER IA</h3>
          <div class="flex gap-2 mb-3">
            <input id="scan-query" type="text" placeholder="Pseudo ex: ZeratoR" class="cyber-input">
            <button onclick="runScan()" class="bg-[#00f2ea] text-black px-4 rounded font-bold hover:bg-white">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div id="scan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
            <div class="flex gap-3 items-center mb-3">
              <img id="scan-img" src="" class="w-12 h-12 rounded-full border border-[#00f2ea]">
              <div>
                <div id="scan-name" class="font-bold text-white">--</div>
                <div id="scan-game" class="text-xs text-gray-500">--</div>
              </div>
            </div>
            <div id="scan-ai" class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto"></div>
          </div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">RAID FINDER</h3>
          <div class="flex gap-2 mb-3">
            <input id="raid-game" type="text" placeholder="Jeu ex: League" class="cyber-input">
            <input id="raid-viewers" type="number" placeholder="Max viewers" class="cyber-input" value="100">
          </div>
          <button onclick="runRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white mb-3">üîç CHERCHER</button>

          <div id="raid-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
            <img id="raid-img" src="" class="w-full h-40 rounded mb-3 object-cover">
            <div id="raid-info" class="text-xs text-gray-300"></div>
            <button id="raid-btn" onclick="goToRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold mt-2 hover:bg-white">üéÆ ALLER AU RAID</button>
          </div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">CO-STREAM MATCH</h3>
          <div class="text-xs text-gray-400 mb-2">Trouve un co-streamer compatible (jeu/langue/taille).</div>
          <button id="costream-btn" onclick="loadCoStreamer()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
            ü§ù TROUVER
          </button>
          <div id="costream-out" class="mt-3 bg-[#151515] p-3 rounded border border-[#222]" style="display:none;"></div>
        </div>

        <div>
          <h3 class="text-[#ff0099] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">BOOST</h3>
          <input id="boost-query" type="text" placeholder="Cha√Æne..." class="cyber-input mb-2">
          <button onclick="runBoost()" class="w-full bg-[#ff0099] text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition">ACTIVER</button>
          <div id="boost-msg" class="text-center text-xs mt-2 text-green-400"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- ===== TWITFLIX MODAL (Netflix-like) ===== -->
  <div id="twitflix-modal" class="tf-modal-overlay" role="dialog" aria-modal="true">
    <div class="tf-modal-content">
      <div class="tf-topbar">
        <div class="tf-brand">
          <div class="logo">TWITFLIX</div>
          <div class="sub">catalog</div>
        </div>

        <div class="tf-search">
          <i class="fas fa-search"></i>
          <input id="tf-search-input" type="text" placeholder="Rechercher un titre (cat√©gorie Twitch)..." autocomplete="off" />
        </div>

        <div class="tf-actions">
          <button class="tf-btn" id="tf-clear-btn" title="Effacer la recherche">
            <i class="fas fa-eraser mr-2"></i>Clear
          </button>
          <div class="tf-close" onclick="closeTwitFlix()" title="Fermer (Esc)">
            <i class="fas fa-times"></i>
          </div>
        </div>
      </div>

      <div class="tf-body" id="tf-body">
        <div class="tf-hero">
          <h3>üé¨ Survole un ‚Äúposter‚Äù pour lancer la bande-annonce</h3>
          <p>
            Chaque survol d√©clenche un stream al√©atoire (‚â§ 100 viewers) dans la cat√©gorie.
            Clique sur <strong>Lecture</strong> pour lancer le live dans le player principal.
          </p>
        </div>

        <div id="tf-empty" class="tf-empty" style="display:none;">
          Aucun r√©sultat. Essaie une autre recherche.
        </div>

        <div id="twitflix-grid" class="tf-grid">
          <div class="tf-loading w-full" style="grid-column:1/-1;">
            <i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...
          </div>
        </div>

        <div id="tf-loading-more" class="tf-loading" style="display:none;">
          <i class="fas fa-spinner fa-spin"></i> Chargement‚Ä¶
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const TWITCH_PARENT = window.location.hostname; // IMPORTANT pour embed Twitch

    // --- SFX placeholders (garde tes logs) ---
    const sfxOpen = new Audio("data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");
    const sfxClick = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");

    function playSound(type) {
      console.log("üîä Audio:", type);
    }

    let socket;
    let currentChannel = 'twitch';
    let currentUser = null;
    let charts = {};
    let raidTarget = null;

    let currentChannelId = null;
    let currentGameId = null;
    let currentGameName = null;

    // TwitFlix
    let tfCursor = null;
    let tfIsLoading = false;
    let tfAllCategories = []; // cache local
    let tfSearchTerm = '';
    const tfPreviewTimers = new Map(); // gameId -> timer
    const tfPreviewCache = new Map();  // gameId -> { channel, game_name, ts }

    // INIT
    window.addEventListener('load', async () => {
      initUnderTabs();
      await checkAuth();
      initPlayer();
      loadStatsDashboard();
      initCarouselScroll();
      initSocket();
      initFirebaseStatus();
      setInterval(loadStatsDashboard, 5 * 60 * 1000);

      // Twitflix infinite scroll
      const tfGrid = document.getElementById('twitflix-grid');
      const tfBody = document.getElementById('tf-body');
      if (tfBody) {
        tfBody.addEventListener('scroll', () => {
          // scroll container = tf-body (pas la page)
          if (tfBody.scrollTop + tfBody.clientHeight >= tfBody.scrollHeight - 350) {
            loadMoreCategories();
          }
        });
      }

      // Search
      const input = document.getElementById('tf-search-input');
      if(input){
        input.addEventListener('input', () => {
          tfSearchTerm = String(input.value || '').trim().toLowerCase();
          renderTwitflixGrid();
        });
      }
      const clearBtn = document.getElementById('tf-clear-btn');
      if(clearBtn){
        clearBtn.addEventListener('click', () => {
          const input = document.getElementById('tf-search-input');
          if (input) input.value = '';
          tfSearchTerm = '';
          renderTwitflixGrid();
        });
      }

      // Close on ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeTwitFlix();
      });

      // Close when clicking backdrop
      const overlay = document.getElementById('twitflix-modal');
      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeTwitFlix();
        });
      }
    });

    function initUnderTabs(){
      const nav = document.getElementById('under-tabs-nav');
      if (!nav) return;
      nav.querySelectorAll('.u-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ut');
          nav.querySelectorAll('.u-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#under-overview,#under-analytics,#under-niche').forEach(p=>p.classList.remove('active'));
          const panel = document.getElementById(`under-${id}`);
          if (panel) panel.classList.add('active');
        });
      });
    }

    // FIREBASE STATUS
    async function initFirebaseStatus() {
      async function checkStatus() {
        try {
          const response = await fetch(`${API_BASE}/firebase_status`);
          const data = await response.json();
          const statusEl = document.getElementById('socket-status');
          if (data.connected) {
            statusEl.innerText = 'HUB SECURE';
            statusEl.className = 'text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded connected';
          } else {
            statusEl.innerText = 'HUB DISCONNECTED';
            statusEl.className = 'text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded';
          }
        } catch (error) {
          console.error('Firebase status error:', error);
        }
      }
      checkStatus();
      setInterval(checkStatus, 5000);
    }

    // AUTH
    async function checkAuth() {
      const res = await fetch(`${API_BASE}/twitch_user_status`);
      const data = await res.json();
      if (data.is_connected) {
        currentUser = data.display_name;
        const hubUser = document.getElementById('hub-user-display');
        if (hubUser) hubUser.innerText = data.display_name;

        document.getElementById('btn-auth').classList.add('hidden');
        document.getElementById('user-area').classList.remove('hidden');

        document.getElementById('user-name').innerText = data.display_name;
        if (data.profile_image_url) document.getElementById('user-avatar').src = data.profile_image_url;

        await loadFollowed();
      }
    }

    function startAuth() {
      window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=700');
      const check = setInterval(async () => {
        const res = await fetch(`${API_BASE}/twitch_user_status`);
        const data = await res.json();
        if (data.is_connected) {
          clearInterval(check);
          location.reload();
        }
      }, 1200);
    }

    async function logout() {
      try {
        await fetch(`${API_BASE}/twitch_logout`, { method:'POST', headers:{'Content-Type':'application/json'} });
        location.reload();
      } catch (e) {}
    }

    // UI tabs (droite)
    function openTab(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      evt.currentTarget.classList.add('active');
    }

    // Chat mode
    function toggleChatMode(mode){
      currentChannel = mode;
      const btnT = document.getElementById('btn-mode-twitch');
      const btnH = document.getElementById('btn-mode-hub');
      const ct = document.getElementById('chat-container-twitch');
      const ch = document.getElementById('chat-container-hub');
      if(mode==='twitch'){
        btnT.className = 'flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded';
        btnH.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
        ct.classList.remove('hidden');
        ch.classList.add('hidden');
      }else{
        btnH.className = 'flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded';
        btnT.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
        ct.classList.add('hidden');
        ch.classList.remove('hidden');
      }
    }

    // SOCKET (Hub secure)
    function initSocket(){
      try{
        socket = io(API_BASE, { transports:['websocket','polling'] });
        socket.on('connect', ()=>{});
        socket.on('hub_message', (msg)=>{
          appendHubMessage(msg?.user || 'Anon', msg?.text || '');
        });
      }catch(e){}
    }

    function appendHubMessage(user, text){
      const box = document.getElementById('hub-messages');
      if(!box) return;
      const div = document.createElement('div');
      div.className = 'hub-msg';
      const safeUser = escapeHtml(String(user||'Anon'));
      const safeText = escapeHtml(String(text||''));
      div.innerHTML = `<strong class="text-[#00f2ea]">${safeUser}</strong><div class="text-gray-300">${safeText}</div>`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function sendHubMessage(e){
      e.preventDefault();
      const input = document.getElementById('hub-input');
      if(!input) return;
      const t = String(input.value||'').trim();
      if(!t) return;
      input.value = '';
      try{
        socket.emit('hub_message', { user: currentUser || 'Anonyme', text: t });
      }catch(err){}
    }

    // PLAYER
    async function initPlayer(){
      // charge un stream par d√©faut
      try{
        const res = await fetch(`${API_BASE}/get_default_stream`);
        const data = await res.json();
        if(data.success){
          loadChannel(data.channel, data.mode || 'AUTO', data.viewers || 0);
        }else{
          loadChannel('twitch', 'FALLBACK', 0);
        }
      }catch(e){
        loadChannel('twitch', 'FALLBACK', 0);
      }
    }

    function buildTwitchPlayerIframe(channel){
      const src = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${encodeURIComponent(TWITCH_PARENT)}&muted=false&autoplay=true`;
      const iframe = document.createElement('iframe');
      iframe.setAttribute('src', src);
      iframe.setAttribute('height', '100%');
      iframe.setAttribute('width', '100%');
      iframe.setAttribute('allowfullscreen', 'true');
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('allow', 'autoplay; fullscreen');
      return iframe;
    }

    function buildTwitchChatIframe(channel){
      const src = `https://www.twitch.tv/embed/${encodeURIComponent(channel)}/chat?parent=${encodeURIComponent(TWITCH_PARENT)}`;
      const iframe = document.getElementById('twitch-chat-frame');
      if(iframe) iframe.src = src;
    }

    function loadChannel(channel, mode='AUTO', viewers=0){
      const display = document.getElementById('current-channel-display');
      const badge = document.getElementById('player-mode-badge');
      const vc = document.getElementById('viewer-count');
      const container = document.getElementById('video-container');

      if(display) display.innerText = channel.toUpperCase();
      if(badge) badge.innerText = mode;
      if(vc) vc.innerText = `${Number(viewers||0)} viewers`;

      if(container){
        container.innerHTML = '';
        container.appendChild(buildTwitchPlayerIframe(channel));
      }
      buildTwitchChatIframe(channel);
      playSound('open');
    }

    async function cycle(direction){
      try{
        const res = await fetch(`${API_BASE}/cycle_stream`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ direction })
        });
        const data = await res.json();
        if(data.success){
          loadChannel(data.channel, 'AUTO', 0);
        }else{
          // boost actif -> ignore
        }
      }catch(e){}
    }

    // CAROUSEL
    function initCarouselScroll(){
      const el = document.getElementById('carousel');
      if(!el) return;
      let isDown=false, startX=0, scrollLeft=0;
      el.addEventListener('mousedown',(e)=>{isDown=true; startX=e.pageX-el.offsetLeft; scrollLeft=el.scrollLeft;});
      el.addEventListener('mouseleave',()=>{isDown=false;});
      el.addEventListener('mouseup',()=>{isDown=false;});
      el.addEventListener('mousemove',(e)=>{
        if(!isDown) return;
        e.preventDefault();
        const x=e.pageX-el.offsetLeft;
        const walk=(x-startX)*1.2;
        el.scrollLeft = scrollLeft - walk;
      });
    }

    // FOLLOWED STREAMS
    async function loadFollowed(){
      try{
        const res = await fetch(`${API_BASE}/followed_streams`);
        const data = await res.json();
        if(!data.success) return;
        const car = document.getElementById('carousel');
        car.innerHTML = '';
        (data.streams || []).slice(0, 20).forEach(s=>{
          const card = document.createElement('div');
          card.className = 'stream-card';
          const thumb = (s.thumbnail_url || '').replace('{width}','320').replace('{height}','180');
          card.innerHTML = `
            <img class="card-img" src="${thumb}" alt="">
            <div class="absolute inset-0 flex flex-col justify-end p-3 bg-gradient-to-t from-black/90 via-black/20 to-transparent">
              <div class="text-white font-bold text-sm truncate">${escapeHtml(s.user_name || s.user_login)}</div>
              <div class="text-[10px] text-gray-300 truncate">${escapeHtml(s.game_name || '‚Äî')}</div>
              <div class="text-[10px] text-[#ff0099] font-bold">${Number(s.viewer_count||0)} viewers</div>
            </div>
          `;
          card.addEventListener('click', ()=>{
            loadChannel(s.user_login, 'FOLLOW', s.viewer_count || 0);
          });
          car.appendChild(card);
        });
      }catch(e){}
    }

    // STATS DASHBOARD (garde la logique existante)
    async function loadStatsDashboard(){
      try{
        const res = await fetch(`${API_BASE}/api/stats/global`);
        const data = await res.json();
        if(!data.success) return;

        const viewersEl = document.getElementById('kpi-viewers');
        const chEl = document.getElementById('kpi-channels');
        if(viewersEl) viewersEl.innerText = formatNumber(data.total_viewers || 0);
        if(chEl) chEl.innerText = String(data.total_channels || '--');

        // charts trend
        if(data.history && data.history.live){
          renderLineChart('chartViewers', data.history.live.labels, data.history.live.values);
        }

        // top games
        const gRes = await fetch(`${API_BASE}/api/stats/top_games`);
        const gData = await gRes.json();
        const gLabels = (gData.games || []).map(x=>x.name);
        const gValues = (gData.games || []).map((_,i)=> (10-i)*3 );
        renderBarChart('chartGames', gLabels, gValues);

        // languages
        const lRes = await fetch(`${API_BASE}/api/stats/languages`);
        const lData = await lRes.json();
        const lLabels = (lData.languages || []).map(x=>x.name);
        const lValues = (lData.languages || []).map(x=>x.percent);
        renderPieChart('chartLangs', lLabels, lValues);
      }catch(e){}
    }

    // Charts helpers (simples)
    function destroyChart(id){
      if(charts[id]){ charts[id].destroy(); charts[id]=null; }
    }
    function renderLineChart(canvasId, labels, values){
      const c = document.getElementById(canvasId);
      if(!c) return;
      destroyChart(canvasId);
      charts[canvasId] = new Chart(c, {
        type:'line',
        data:{ labels, datasets:[{ label:'Viewers', data: values, tension:.35 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#777' } }, y:{ ticks:{ color:'#777' } } } }
      });
    }
    function renderBarChart(canvasId, labels, values){
      const c = document.getElementById(canvasId);
      if(!c) return;
      destroyChart(canvasId);
      charts[canvasId] = new Chart(c, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Score', data: values }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#777' } }, y:{ ticks:{ color:'#777' } } } }
      });
    }
    function renderPieChart(canvasId, labels, values){
      const c = document.getElementById(canvasId);
      if(!c) return;
      destroyChart(canvasId);
      charts[canvasId] = new Chart(c, {
        type:'doughnut',
        data:{ labels, datasets:[{ data: values }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
      });
    }

    // ========= TOOLS (stubs si routes existent c√¥t√© backend) =========
    async function runScan(){
      const q = document.getElementById('scan-query')?.value || '';
      const query = String(q).trim();
      if(!query) return;
      try{
        const res = await fetch(`${API_BASE}/scan_target`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query })
        });
        const data = await res.json();
        const box = document.getElementById('scan-res');
        if(!data.success){ if(box) box.classList.add('hidden'); return; }

        box.classList.remove('hidden');
        if(data.type === 'user'){
          document.getElementById('scan-img').src = data.user_data.profile_image_url || '';
          document.getElementById('scan-name').innerText = data.user_data.display_name || data.user_data.login;
          document.getElementById('scan-game').innerText = data.user_data.game_name || '‚Äî';
          document.getElementById('scan-ai').innerHTML = `
            <div class="text-gray-400">${escapeHtml(data.user_data.description || '')}</div>
            <div class="mt-2 text-[10px] text-gray-500">Cr√©√©: ${escapeHtml(data.user_data.created_at || '')} ‚Ä¢ View count: ${formatNumber(data.user_data.view_count||0)}</div>
          `;
        }else{
          document.getElementById('scan-img').src = data.game_data.box_art_url || '';
          document.getElementById('scan-name').innerText = data.game_data.name || '‚Äî';
          document.getElementById('scan-game').innerText = `${formatNumber(data.game_data.total_viewers||0)} viewers`;
          document.getElementById('scan-ai').innerHTML = `<div class="text-gray-400">Niche score: ${escapeHtml(String(data.game_data.ai_calculated_niche_score || '‚Äî'))}</div>`;
        }
      }catch(e){}
    }

    async function runRaid(){
      const game = String(document.getElementById('raid-game')?.value || '').trim();
      const max_viewers = parseInt(document.getElementById('raid-viewers')?.value || '100', 10);
      if(!game) return;

      try{
        const res = await fetch(`${API_BASE}/start_raid`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game, max_viewers })
        });
        const data = await res.json();
        const box = document.getElementById('raid-res');
        if(!data.success){ if(box) box.classList.add('hidden'); return; }

        raidTarget = data.target;
        box.classList.remove('hidden');
        document.getElementById('raid-img').src = raidTarget.thumbnail_url || '';
        document.getElementById('raid-info').innerHTML = `
          <div><strong class="text-white">${escapeHtml(raidTarget.name)}</strong> (<span class="text-gray-400">${escapeHtml(raidTarget.login)}</span>)</div>
          <div class="text-gray-400 mt-1">${escapeHtml(raidTarget.game || '')}</div>
          <div class="text-[#ff0099] font-bold mt-1">${Number(raidTarget.viewers||0)} viewers</div>
        `;
      }catch(e){}
    }

    function goToRaid(){
      if(!raidTarget) return;
      loadChannel(raidTarget.login, 'RAID', raidTarget.viewers||0);
    }

    async function loadCoStreamer(){
      const out = document.getElementById('costream-out');
      const btn = document.getElementById('costream-btn');
      if(btn) btn.disabled = true;
      if(out){ out.style.display='block'; out.innerHTML = `<div class="text-gray-400 text-xs"><i class="fas fa-spinner fa-spin mr-2"></i>Recherche...</div>`; }
      try{
        const res = await fetch(`${API_BASE}/co_stream_match`);
        const data = await res.json();
        if(!data.success){
          out.innerHTML = `<div class="text-gray-400 text-xs">Aucun r√©sultat.</div>`;
        }else{
          out.innerHTML = `
            <div class="text-white font-bold">${escapeHtml(data.channel || '‚Äî')}</div>
            <div class="text-gray-400 text-xs mt-1">${escapeHtml(data.game || '')}</div>
            <button class="mt-2 w-full bg-[#ff0099] text-white py-2 rounded font-bold text-xs font-orbitron hover:bg-white hover:text-black transition"
              onclick="loadChannel('${escapeJs(data.channel||'twitch')}', 'COSTREAM', 0)">
              LANCER
            </button>
          `;
        }
      }catch(e){
        if(out) out.innerHTML = `<div class="text-gray-400 text-xs">Erreur.</div>`;
      }finally{
        if(btn) btn.disabled = false;
      }
    }

    async function runBoost(){
      const ch = String(document.getElementById('boost-query')?.value || '').trim().toLowerCase();
      if(!ch) return;
      const msg = document.getElementById('boost-msg');
      if(msg) msg.innerText = '...';
      try{
        const res = await fetch(`${API_BASE}/stream_boost`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ channel: ch })
        });
        const data = await res.json();
        if(msg) msg.innerHTML = data.html_response || 'OK';
      }catch(e){
        if(msg) msg.innerText = 'Erreur';
      }
    }

    async function loadAIReco(){
      // si ton backend a une route d√©di√©e tu peux brancher, sinon laisse comme √ßa
      const box = document.getElementById('ai-reco-box');
      if(!box) return;
      box.classList.remove('hidden');
      box.innerHTML = `<div class="text-gray-400 text-xs"><i class="fas fa-spinner fa-spin mr-2"></i>G√©n√©ration...</div>`;
      try{
        const ch = document.getElementById('current-channel-display')?.innerText || '';
        const query = String(ch).trim().toLowerCase();
        const res = await fetch(`${API_BASE}/critique_ia`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'clips', query })
        });
        const data = await res.json();
        box.innerHTML = data.html_response || '<p class="text-gray-400">‚Äî</p>';
      }catch(e){
        box.innerHTML = `<p class="text-gray-400">Erreur IA.</p>`;
      }
    }

    async function runSimulation(){
      const hours = parseFloat(document.getElementById('sim-hours')?.value || '12');
      const out = document.getElementById('sim-result');
      if(out) out.innerText = `+${Math.round(hours*2)}% (estim.)`;
    }

    async function analyzeBestTime(){
      const input = document.getElementById('best-time-game');
      const game = String(input?.value || '').trim();
      if(!game) return;

      const btn = document.getElementById('analyze-schedule-btn');
      const loading = document.getElementById('best-time-loading');
      const results = document.getElementById('best-time-results');

      if(btn) btn.disabled = true;
      if(loading) loading.style.display = 'block';
      if(results){ results.style.display = 'none'; results.innerHTML=''; }

      try{
        const res = await fetch(`${API_BASE}/analyze_schedule`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game })
        });
        const data = await res.json();
        if(results){
          results.style.display = 'block';
          results.innerHTML = data.html_response || `<p class="text-gray-400">Aucun r√©sultat.</p>`;
        }
      }catch(e){
        if(results){
          results.style.display = 'block';
          results.innerHTML = `<p class="text-gray-400">Erreur.</p>`;
        }
      }finally{
        if(loading) loading.style.display = 'none';
        if(btn) btn.disabled = false;
      }
    }

    // ========= TWITFLIX (Netflix-like) =========
    function openTwitFlix(){
      const modal = document.getElementById('twitflix-modal');
      if(!modal) return;
      modal.classList.add('active');
      playSound('open');

      // focus search (desktop)
      setTimeout(() => {
        const input = document.getElementById('tf-search-input');
        if (input) input.focus();
      }, 120);

      // reset + load
      resetTwitflix();
      loadMoreCategories(true);
    }

    function closeTwitFlix(){
      const modal = document.getElementById('twitflix-modal');
      if(!modal) return;
      modal.classList.remove('active');
      stopAllPreviews();
    }

    function resetTwitflix(){
      tfCursor = null;
      tfIsLoading = false;
      tfAllCategories = [];
      tfSearchTerm = '';
      const input = document.getElementById('tf-search-input');
      if(input) input.value = '';
      const grid = document.getElementById('twitflix-grid');
      if(grid) grid.innerHTML = '';
      const empty = document.getElementById('tf-empty');
      if(empty) empty.style.display = 'none';
    }

    async function loadMoreCategories(initial=false){
      if(tfIsLoading) return;
      // si recherche active, on autorise quand m√™me le chargement (pour trouver + de r√©sultats)
      tfIsLoading = true;

      const more = document.getElementById('tf-loading-more');
      if(more) more.style.display = 'block';

      try{
        let url = `${API_BASE}/api/categories/top`;
        if(tfCursor) url += `?cursor=${encodeURIComponent(tfCursor)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(!data.success){
          tfIsLoading = false;
          if(more) more.style.display = 'none';
          return;
        }

        const cats = data.categories || [];
        tfCursor = data.cursor || null;

        // merge unique
        const seen = new Set(tfAllCategories.map(c=>String(c.id)));
        cats.forEach(c=>{
          if(!seen.has(String(c.id))){
            tfAllCategories.push(c);
            seen.add(String(c.id));
          }
        });

        renderTwitflixGrid(initial);
      }catch(e){
        console.error(e);
      }finally{
        tfIsLoading = false;
        if(more) more.style.display = 'none';
      }
    }

    function renderTwitflixGrid(initial=false){
      const grid = document.getElementById('twitflix-grid');
      const empty = document.getElementById('tf-empty');
      if(!grid) return;

      // stop previews (sinon iframes restent)
      stopAllPreviews();

      // filter
      const filtered = tfSearchTerm
        ? tfAllCategories.filter(c => String(c.name||'').toLowerCase().includes(tfSearchTerm))
        : tfAllCategories.slice();

      // render
      grid.innerHTML = '';

      if(filtered.length === 0){
        if(empty) empty.style.display = 'block';
        grid.innerHTML = '';
        return;
      }else{
        if(empty) empty.style.display = 'none';
      }

      // Hint top row while loading
      if(initial && tfAllCategories.length === 0){
        grid.innerHTML = `<div class="tf-loading w-full" style="grid-column:1/-1;"><i class="fas fa-spinner fa-spin"></i> Chargement‚Ä¶</div>`;
        return;
      }

      filtered.forEach(cat => {
        const card = document.createElement('div');
        card.className = 'nf-card';
        card.dataset.gameId = String(cat.id);
        card.dataset.gameName = String(cat.name || '');
        const posterUrl = String(cat.box_art_url || '');

        card.innerHTML = `
          <img class="nf-poster" src="${escapeAttr(posterUrl)}" alt="${escapeAttr(cat.name||'')}" loading="lazy">
          <div class="nf-preview"></div>
          <div class="nf-gradient"></div>
          <div class="nf-meta">
            <div class="nf-title">${escapeHtml(cat.name || '')}</div>
            <div class="nf-actions">
              <div class="nf-play" data-play="1"><i class="fas fa-play"></i>Lecture</div>
              <div class="nf-badge">hover preview</div>
            </div>
          </div>
        `;

        // click play => pick a stream then load in main player
        card.addEventListener('click', async (e) => {
          const isPlay = e.target && (e.target.closest && e.target.closest('[data-play="1"]'));
          if(!isPlay) return;
          e.stopPropagation();
          playSound('click');
          const gameId = String(cat.id);
          const pick = await pickStreamForGame(gameId);
          if(pick && pick.channel){
            closeTwitFlix();
            loadChannel(pick.channel, 'TWITFLIX', 0);
          }
        });

        // Hover preview (Netflix-like)
        card.addEventListener('mouseenter', () => schedulePreview(card));
        card.addEventListener('mouseleave', () => stopPreview(card));

        grid.appendChild(card);
      });
    }

    function schedulePreview(card){
      const gameId = String(card.dataset.gameId || '');
      if(!gameId) return;

      // debounce
      clearTimeout(tfPreviewTimers.get(gameId));
      const t = setTimeout(async () => {
        await startPreview(card);
      }, 420);
      tfPreviewTimers.set(gameId, t);
    }

    async function startPreview(card){
      const gameId = String(card.dataset.gameId || '');
      if(!gameId) return;

      // si d√©j√† preview affich√©e, rien
      const previewBox = card.querySelector('.nf-preview');
      if(previewBox && previewBox.dataset.active === '1') return;

      // pick stream (cache 60s)
      const pick = await pickStreamForGame(gameId);
      if(!pick || !pick.channel) return;

      // build iframe muted autoplay
      const iframe = document.createElement('iframe');
      iframe.className = 'w-full h-full';
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('allowfullscreen', 'false');
      iframe.setAttribute('allow', 'autoplay');
      iframe.style.width = '100%';
      iframe.style.height = '100%';

      // controls=false, muted=true, autoplay=true
      const src = `https://player.twitch.tv/?channel=${encodeURIComponent(pick.channel)}&parent=${encodeURIComponent(TWITCH_PARENT)}&muted=true&autoplay=true&controls=false`;
      iframe.src = src;

      const poster = card.querySelector('.nf-poster');
      if(poster) poster.style.display = 'none';

      if(previewBox){
        previewBox.innerHTML = '';
        previewBox.style.display = 'block';
        previewBox.dataset.active = '1';
        previewBox.appendChild(iframe);
      }
    }

    function stopPreview(card){
      const gameId = String(card.dataset.gameId || '');
      clearTimeout(tfPreviewTimers.get(gameId));

      const previewBox = card.querySelector('.nf-preview');
      const poster = card.querySelector('.nf-poster');

      if(previewBox){
        previewBox.dataset.active = '0';
        previewBox.innerHTML = '';
        previewBox.style.display = 'none';
      }
      if(poster) poster.style.display = 'block';
    }

    function stopAllPreviews(){
      // stop timers
      for (const [,t] of tfPreviewTimers) clearTimeout(t);
      tfPreviewTimers.clear();

      // remove iframes
      document.querySelectorAll('.nf-preview').forEach(p=>{
        p.dataset.active = '0';
        p.innerHTML = '';
        p.style.display = 'none';
      });
      document.querySelectorAll('.nf-poster').forEach(img=>{
        img.style.display = 'block';
      });
    }

    async function pickStreamForGame(gameId){
      // cache 60s par gameId (√©vite spam API au survol)
      const cached = tfPreviewCache.get(gameId);
      const now = Date.now();
      if(cached && (now - cached.ts) < 60000) return cached;

      try{
        const res = await fetch(`${API_BASE}/api/stream/by_category`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game_id: gameId })
        });
        const data = await res.json();
        if(!data.success) return null;

        const pick = { channel: data.channel, game_name: data.game_name || '', ts: now };
        tfPreviewCache.set(gameId, pick);
        return pick;
      }catch(e){
        return null;
      }
    }

    // ========= HELPERS =========
    function escapeHtml(str){
      return String(str||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return escapeHtml(str).replaceAll('`','&#096;');
    }
    function escapeJs(str){
      return String(str||'').replaceAll('\\','\\\\').replaceAll("'","\\'");
    }
    function formatNumber(n){
      const x = Number(n||0);
      return x.toLocaleString('fr-FR');
    }
  </script>
</body>
</html>
