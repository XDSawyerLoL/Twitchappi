<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Streamer Hub – Pro Analytics &amp; TwitFlix</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&amp;family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:auto;
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background:#000; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--secondary); }

    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }

    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    .hub-msg{ padding:8px; border-bottom:1px solid #1a1a1a; font-size:13px; line-height:1.4; }
    .hub-msg strong{ font-family:Orbitron; font-size:11px; }
    .scrollbar-thin::-webkit-scrollbar{ width:4px; }

    /* badge statut */
    #socket-status{ transition:all .3s ease; }
    #socket-status.connected{
      color:#00f2ea; border-color:#00f2ea;
      box-shadow:0 0 8px rgba(0,242,234,.6);
      animation:hub-pulse 2s infinite;
    }
    @keyframes hub-pulse{ 0%,100%{opacity:1} 50%{opacity:.6} }

    /* BEST TIME TOOL */
    .best-time-tool{
      background:#151515; border:1px solid #00f2ea; border-radius:10px;
      padding:16px; margin-bottom:16px; box-shadow:inset 0 0 10px rgba(0,242,234,.1);
    }
    .best-time-tool h4{
      color:#00f2ea; font-family:Orbitron; font-size:12px;
      margin-bottom:10px; border-bottom:1px solid #00f2ea; padding-bottom:8px;
    }
    .best-time-tool input{
      width:100%; padding:10px; background:#0a0a0a; border:1px solid #333;
      color:#fff; border-radius:6px; font-size:12px; margin-bottom:8px;
    }
    .best-time-tool input:focus{ border-color:#00f2ea; box-shadow:0 0 8px rgba(0,242,234,.2); outline:none; }
    .best-time-tool button{
      width:100%; background:#00f2ea; color:#000; padding:10px;
      border:none; border-radius:6px; font-weight:bold; cursor:pointer;
      font-family:Orbitron; font-size:11px; transition:all .3s ease;
    }
    .best-time-tool button:hover:not(:disabled){ background:#fff; box-shadow:0 0 15px rgba(0,242,234,.4); transform:translateY(-1px); }
    .best-time-tool button:disabled{ opacity:.5; cursor:not-allowed; }
    .best-time-results{
      background:#0a0a0a; border:1px solid #333; border-radius:6px;
      padding:12px; margin-top:12px; font-size:12px; max-height:220px; overflow-y:auto;
    }
    .best-time-spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(0,242,234,.3); border-radius:50%;
      border-top-color:#00f2ea; animation:bt-spin 1s linear infinite;
      margin-right:6px; vertical-align:middle;
    }
    @keyframes bt-spin{ to{ transform:rotate(360deg) } }

    /* PLAYER sizing (grand) */
    .player-shell{ min-height:72vh; }
    #video-container{ min-height:62vh; }

    /* ====== ONGLETS SOUS LE LIVE (indépendants) ====== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }

    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* ====== TWITFLIX MODAL ====== */
    .tf-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px);
      z-index: 9999; display: none; align-items: center; justify-content: center;
    }
    .tf-modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .tf-modal-content {
      width: 90%; max-width: 1200px; height: 85vh;
      background: #0b0b0d; border: 1px solid #333; border-radius: 12px;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 242, 234, 0.1);
    }
    .tf-header {
      padding: 20px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
      background: #080808;
    }
    .tf-title { font-family: 'Orbitron'; color: #ff0099; font-size: 24px; letter-spacing: 2px; }
    .tf-title span { color: #00f2ea; }
    .tf-close { color: #666; cursor: pointer; font-size: 24px; transition: .3s; }
    .tf-close:hover { color: #fff; transform: rotate(90deg); }

    .tf-grid {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; align-content: start;
    }
    .tf-card {
      position: relative; aspect-ratio: 3/4; border-radius: 6px; overflow: hidden;
      cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border: 2px solid transparent;
    }
    .tf-card:hover {
      transform: scale(1.05); border-color: #00f2ea; z-index: 10;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.3);
    }
    .tf-poster { width: 100%; height: 100%; object-fit: cover; }
    .tf-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, black, transparent);
      padding: 10px; opacity: 0; transition: 0.3s;
    }
    .tf-card:hover .tf-overlay { opacity: 1; }
    .tf-name { font-size: 12px; font-weight: bold; color: white; text-align: center; }
  
    /* ====== TWITFLIX — Netflix rows (catalogue only, sans toucher le reste) ====== */
    .tf-controls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding: 0 16px 12px 16px;
      border-bottom:1px solid #1f1f23;
      background: rgba(11,11,13,.92);
    }
    .tf-view-toggle{
      display:flex; gap:6px; padding:4px; border-radius:12px;
      border:1px solid #2b2b31; background:#0a0a0a;
    }
    .tf-toggle-btn{
      border:0; background:transparent; color:#a7a7b2;
      font-family:Orbitron; font-size:10px; font-weight:900;
      letter-spacing:.10em;
      padding:8px 10px; border-radius:10px; cursor:pointer; transition:.2s;
    }
    .tf-toggle-btn:hover{ color:#fff; background:#151515; }
    .tf-toggle-btn.active{ color:#000; background:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.18); }

    .tf-grid{ padding: 14px 16px 18px 16px; }
    .tf-section{ margin-top: 18px; }
    .tf-section-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #eaeaf0;
      margin: 8px 0 10px 2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .tf-section-title .hint{ color:#7f7f8a; font-size:10px; letter-spacing:.06em; text-transform:none; font-family:Inter; font-weight:700; }

    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    /* Card sizing for rows (lisible) */
    .tf-card{ flex: 0 0 170px; aspect-ratio: 2/3; }
    .tf-card:hover{ transform: scale(1.06); } /* moins agressif pour éviter le clipping */
    .tf-name{ font-size: 11px; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* A–Z bar */
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.74));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 8px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }


    /* ====== TWITFLIX — performance + Netflix rows ====== */
    .tf-rows{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: block;
    }
    .tf-row{ margin-bottom: 22px; }
    .tf-row-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color:#eaeaf0;
      margin: 8px 0 10px 2px;
    }
    .tf-row-title span{ color:#00f2ea; }
    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    .tf-az{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display:block;
    }
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.78));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 10px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }

    .tf-sentinel{
      padding: 18px 0 4px 0;
      display:flex;
      justify-content:center;
    }
    .tf-sentinel-inner{
      font-size: 12px;
      color:#9b9ba3;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .tf-sentinel-inner.done{
      color:#00f2ea;
      border-color:#00f2ea;
      background: rgba(0,242,234,.06);
    }
    .tf-retry{
      background:#151515;
      border:1px solid #2b2b31;
      color:#fff;
      padding:10px 14px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:.2s;
    }
    .tf-retry:hover{
      border-color:#00f2ea;
      box-shadow:0 0 18px rgba(0,242,234,.18);
      transform: translateY(-1px);
    }


    /* TwitFlix search (Netflix style) */
    .tf-search-wrap{ position:relative; width:min(520px, 100%); }
    .tf-search{
      width:100%;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      color:#fff;
      border-radius:10px;
      padding:10px 12px 10px 36px;
      font-size:13px;
      outline:none;
      transition:.2s;
    }
    .tf-search:focus{
      border-color:#00f2ea;
      box-shadow:0 0 0 3px rgba(0,242,234,.12);
    }
    .tf-search-ico{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:#777;
      font-size:13px;
      pointer-events:none;
    }


/* === TwitFlix UX Overhaul (Netflix-like) — overrides only (does not touch rest of app) === */
#twitflix-modal .tf-modal-content{ max-width: 1400px; }

#twitflix-modal .tf-topbar{ position: sticky; top:0; z-index: 60; }
#twitflix-modal .tf-actions{ gap: 12px; }
#twitflix-modal .tf-search{ font-size: 14px; padding: 12px 14px 12px 38px; }

#twitflix-modal .tf-grid{
  display:flex;
  flex-direction: column;
  gap: 18px;
  padding: 14px 18px 24px 18px;
}

#twitflix-modal .tf-hero{
  position: relative;
  height: 220px;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid #1f1f23;
  background: #0a0a0a;
}
#twitflix-modal .tf-hero::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 20%, rgba(0,242,234,.18), transparent 60%),
              radial-gradient(circle at 80% 30%, rgba(255,0,153,.14), transparent 55%),
              linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.20));
  z-index:2;
}
#twitflix-modal .tf-hero-bg{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
  filter: saturate(1.05) contrast(1.05);
  opacity:.55;
}
#twitflix-modal .tf-hero-content{
  position:absolute; inset:0;
  z-index:3;
  display:flex;
  align-items:flex-end;
  padding: 18px;
}
#twitflix-modal .tf-hero-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .08em;
  font-size: 18px;
  font-weight: 900;
  color:#fff;
  text-shadow: 0 6px 24px rgba(0,0,0,.8);
}
#twitflix-modal .tf-hero-sub{
  margin-top: 6px;
  font-size: 12px;
  color:#cfcfda;
  max-width: 70ch;
  line-height: 1.35;
}

#twitflix-modal .tf-row{ display:flex; flex-direction:column; gap: 10px; }
#twitflix-modal .tf-row-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: 12px;
  color:#eaeaf0;
  display:flex; align-items:center; justify-content:space-between;
}
#twitflix-modal .tf-row-title span{ color:#00f2ea; }
#twitflix-modal .tf-row-track{
  display:flex;
  gap: 16px;
  overflow-x:auto;
  padding-bottom: 10px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}
#twitflix-modal .tf-row-track::-webkit-scrollbar{ height: 6px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

#twitflix-modal .tf-card{
  flex: 0 0 170px;
  border-radius: 12px;
  overflow:hidden;
  background:#101013;
  border:1px solid #1d1d22;
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}
#twitflix-modal .tf-card:hover{
  transform: scale(1.06);
  z-index: 40;
  border-color:#00f2ea;
  box-shadow: 0 18px 45px rgba(0,0,0,.55), 0 0 18px rgba(0,242,234,.18);
}
#twitflix-modal .tf-poster{
  width:100%; height:100%;
  object-fit: cover;
  transform: scale(1.02);
  opacity:.95;
}
#twitflix-modal .tf-card:hover .tf-poster{ opacity:.35; }

#twitflix-modal .tf-overlay{
  padding: 10px 10px 12px 10px;
}
#twitflix-modal .tf-name{
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
#twitflix-modal .tf-meta{ display:none; } /* cache le texte “Survol…” */
#twitflix-modal .tf-actions-row{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-top: 10px;
}
#twitflix-modal .tf-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 10px;
  font-weight: 900;
  color:#000;
  background:#00f2ea;
}
#twitflix-modal .tf-pill.ghost{
  background: rgba(255,255,255,.08);
  color:#e8e8ee;
  border:1px solid rgba(255,255,255,.14);
}

#twitflix-modal .tf-search-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  padding-top: 10px;
}

#twitflix-modal .tf-azbar{
  position: sticky;
  top: 66px; /* sous la topbar */
  z-index: 55;
  display:flex;
  flex-wrap:wrap;
  gap: 6px;
  padding: 10px 0 8px 0;
  background: linear-gradient(180deg, rgba(11,11,13,.96), rgba(11,11,13,.72));
  border-bottom: 1px solid #1f1f23;
}
#twitflix-modal .tf-azlink{
  font-family: Orbitron, sans-serif;
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .12em;
  color:#a7a7b2;
  text-decoration:none;
  padding: 6px 8px;
  border-radius: 10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.12);
  transition:.2s;
}
#twitflix-modal .tf-azlink:hover{ color:#000; background:#00f2ea; border-color:#00f2ea; }

#twitflix-modal .tf-end{
  text-align:center;
  color:#9b9ba3;
  padding: 18px 0 6px 0;
}
#twitflix-modal .tf-retry{
  margin-top: 10px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #2b2b31;
  background:#151515;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
#twitflix-modal .tf-retry:hover{ border-color:#00f2ea; box-shadow:0 0 18px rgba(0,242,234,.18); transform: translateY(-1px); }


    /* HUB extras (emotes, gifs, réactions) */
    .hub-emo{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8ee;
      padding:6px 10px;
      border-radius: 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .hub-emo:hover{ border-color:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.15); }
    .hub-msg{
      padding:8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hub-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      margin-left:6px;
    }
    .hub-gif{
      margin-top:6px;
      border-radius: 12px;
      max-width: 260px;
      border:1px solid rgba(255,255,255,.10);
    }
    .hub-reactions{
      display:flex;
      gap:6px;
      margin-top:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hub-react-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-react-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:#e8e8ee;
      font-size:12px;
    }



/* === EXTRAORDINAIRES (SAFE) === */
.hub-msg .hub-react-row{ opacity:0; max-height:0; overflow:hidden; transition: .18s ease; }
.hub-msg:hover .hub-react-row{ opacity:1; max-height:40px; }
.hub-msg.is-tapped .hub-react-row{ opacity:1; max-height:40px; }

.hub-gif{ max-width: 240px; border-radius: 10px; margin-top: 8px; border:1px solid rgba(255,255,255,.10); display:block; }

#ambilight{
  position:absolute; inset:-14px;
  filter: blur(26px);
  opacity:.55;
  z-index:0;
  pointer-events:none;
  transition: background .25s ease;
}
#player-wrap{ position:relative; }
#player-wrap > *{ position:relative; z-index:1; }

.mosaic-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 8px;
  width: 100%;
  height: 100%;
}
.mosaic-grid iframe{ width:100%; height:100%; border:0; border-radius:14px; }

.vibe-chill{ border:1px solid rgba(34,197,94,.55)!important; box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset; }
.vibe-hype{ border:1px solid rgba(0,242,234,.70)!important; box-shadow: 0 0 0 1px rgba(0,242,234,.25) inset; }
.vibe-toxic{ border:1px solid rgba(239,68,68,.60)!important; box-shadow: 0 0 0 1px rgba(239,68,68,.22) inset; }


    /* ==== HUB Chat UX fixes ==== */
    #chat-container-hub { min-height: 520px; }
    #hub-messages { scroll-behavior: smooth; padding-bottom: 90px; }
    /* Keep input always visible */
    #chat-container-hub form { position: sticky; bottom: 0; z-index: 20; }

    /* Messenger-like reactions: hidden until hover/tap */
    .hub-react-row{ 
      opacity: 0; 
      max-height: 0; 
      overflow: hidden;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity .15s ease, max-height .15s ease, transform .15s ease;
    }
    .hub-msg:hover .hub-react-row, .hub-msg.show-reactions .hub-react-row{
      opacity: 1;
      max-height: 44px;
      pointer-events: auto;
      transform: translateY(0);
    }
    .hub-react-btn{
      width: 34px; height: 34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-reactions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .hub-reaction-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    /* Ensure modules below player aren't clipped inside iframe */
    body { overflow-y: auto; }
    .page-wrap { padding-bottom: 40px; }


/* === Tools overlay (safe) === */

#player-tools{
  position:absolute;
  top:10px;
  right:10px;
  z-index:99999 !important;
  display:flex;
  gap:8px;
  pointer-events:auto;
}
#player-tools .toolbtn{ pointer-events:auto; }
#video-container iframe{ position:relative; z-index:1 !important; }
#video-container .player-wrap, #video-container #player{ position:relative; z-index:1 !important; }

#video-container{ position:relative; overflow: visible !important; }
.toolbtn{
  width:38px;height:34px;border-radius:12px;
  background:rgba(16,16,18,.86);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;font-weight:900;cursor:pointer;
}
.toolbtn:hover{ border-color:#00f2ea; transform: translateY(-1px); }
.toolbtn.active{ border-color:#00f2ea; box-shadow:0 0 0 2px rgba(0,242,234,.22) inset; }

#ambilight{
  position:absolute; inset:-90px; z-index:0;
  filter: blur(60px);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s ease;
}
#ambilight.on{ opacity:.78; }

#video-container iframe, #video-container .player-wrap, #video-container #player{ position:relative; z-index:2; }

/* Vibe borders */
.vibe-chill{ box-shadow: 0 0 0 2px rgba(0,242,234,.35) inset, 0 0 18px rgba(0,242,234,.18); }
.vibe-hype{ box-shadow: 0 0 0 2px rgba(255,0,153,.35) inset, 0 0 18px rgba(255,0,153,.18); }
.vibe-toxic{ box-shadow: 0 0 0 2px rgba(255,214,0,.35) inset, 0 0 18px rgba(255,214,0,.18); }

/* Modals (reuse if not already) */
.modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.75);
  display:none; align-items:center; justify-content:center;
  z-index:99999;
}
.modal-overlay.active{ display:flex; }
.modal-card{
  width:min(1100px,94vw);
  max-height:92vh;
  overflow:auto;
  background:#0b0b0d;
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: 0 0 40px rgba(0,0,0,.6);
  padding:14px;
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px; }
.modal-title{ font-family:Orbitron, sans-serif; letter-spacing:.12em; font-weight:900; font-size:12px; color:#eaeaf0; text-transform:uppercase; }
.modal-close{
  background:#151515; border:1px solid #2b2b31; color:#fff;
  width:36px; height:36px; border-radius:12px; cursor:pointer;
}
.modal-close:hover{ border-color:#00f2ea; }

.mosaic-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
.mosaic-tile{ background:#000; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; position:relative; aspect-ratio:16/9; }
.mosaic-tile button{
  position:absolute; top:10px; right:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.18);
  color:#fff; border-radius:12px;
  padding:6px 10px; font-weight:900; cursor:pointer;
}
.mosaic-tile button:hover{ border-color:#00f2ea; }


/* === FORCE PLAYER + SIDE PANEL ALWAYS SIDE-BY-SIDE (embed-safe) === */
#main-layout{ 
      /* HARD FIX: force 2-column layout even if Tailwind is blocked by CSP */
      display: grid !important;
      grid-template-columns: minmax(0, 1fr) 420px;
      gap: 18px;
      align-items: stretch;
      min-height: 0;
    }
    /* Left column (player + top modules) */
    #main-layout > .col-span-8{ grid-column: 1 / 2; min-width: 0; }
    /* Right column (Chat/Stats/Tools) */
    #side-panel{ grid-column: 2 / 3; min-width: 320px; width: 100%; }
    /* Responsive: stack on small screens */
    @media (max-width: 1100px){
      #main-layout{ grid-template-columns: 1fr; }
      #main-layout > .col-span-8{ grid-column: 1 / -1; }
      #side-panel{ grid-column: 1 / -1; min-width: 0; }
    }
#main-layout > .col-span-8{ min-width: 640px; }
#side-panel{ min-width: 360px; max-width: 520px; }


/* === FIX: Sidebar chat should NOT deform Twitch player === */
#main-layout{ align-items: start !important; }
.player-shell{
  flex: 0 0 auto !important;
  height: clamp(520px, 72vh, 860px) !important;
  min-height: unset !important;
}
#video-container{
  flex: 1 1 auto !important;
  min-height: unset !important;
  height: 100% !important;
}


/* === FIX: side-panel height locked to player (Hub Secure can't stretch layout) === */
#side-panel{
  height: clamp(520px, 72vh, 860px) !important;
  min-height: 0 !important;
}
#tab-chat{
  min-height: 0 !important;
}
#chat-container-twitch,
#chat-container-hub{
  flex: 1 1 auto !important;
  min-height: 0 !important;
}
#hub-messages{
  min-height: 0 !important;
}

/* Ensure chat iframe can't force extra height */
#twitch-chat-frame{ display:block; width:100%; height:100%; }

/* === FIX: Messenger-like reactions (attached to message) without layout shift === */
.hub-msg{ position: relative !important; padding-bottom: 34px !important; }

/* Pills (existing reactions) stick to the bottom-right of the message */
.hub-reactions{
  position: absolute !important;
  right: 10px !important;
  bottom: 8px !important;
  margin: 0 !important;
  display: inline-flex !important;
  gap: 6px !important;
  flex-wrap: wrap !important;
  justify-content: flex-end !important;
  pointer-events: none !important;
}
/* Hide empty reactions container */
.hub-reactions:empty{ display:none !important; }

/* Reaction picker appears just above the pills, like Messenger */
.hub-react-row{
  position: absolute !important;
  right: 10px !important;
  bottom: 36px !important;
  opacity: 0 !important;
  pointer-events: none !important;
  transform: translateY(6px) !important;
  transition: opacity .15s ease, transform .15s ease !important;
  z-index: 5 !important;
}
.hub-msg:hover .hub-react-row,
.hub-msg.show-reactions .hub-react-row{
  opacity: 1 !important;
  pointer-events: auto !important;
  transform: translateY(0) !important;
}


/* HARD LAYOUT FIX: keep player left + side panel right even if Tailwind CDN/CSP fails */
#main-layout{
  display:grid !important;
  grid-template-columns:minmax(0,1fr) 420px !important;
  gap:16px !important;
  align-items:stretch !important;
  min-height:0 !important;
}
#main-layout > .col-span-8{ grid-column:1 !important; min-width:0 !important; }
#side-panel{ grid-column:2 !important; min-width:0 !important; height:100% !important; }
@media (max-width: 1100px){
  #main-layout{ grid-template-columns:1fr !important; }
  #side-panel{ grid-column:1 !important; }
}
/* Centered Market modal like TwitFlix */
#market-overlay .market-modal{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(1200px,96vw);
  height:min(88vh,900px);
  border-radius:18px;
  overflow:hidden;
}


/* ======= HARD FIXES (no-tailwind fallback + layout locks) ======= */
.hidden{display:none !important;}
/* force main layout: player left, side-panel right */
#main-layout{display:grid !important; grid-template-columns:minmax(0,1fr) 420px; gap:16px; align-items:stretch;}
#side-panel{grid-column:2 / 3 !important; min-width:320px;}
#left-col{grid-column:1 / 2 !important; min-width:0;}
/* player/side-panel height lock via CSS var */
:root{ --playerH: 520px; --sideHeaderH: 44px; }
#side-panel{height:var(--playerH) !important;}
#side-panel .tab-content{min-height:0;}
#tab-chat, #tab-stats, #tab-tools{height:calc(var(--playerH) - var(--sideHeaderH)) !important; overflow:hidden;}
#tab-chat{display:flex; flex-direction:column;}
#tab-chat .chat-mode-bar{height:40px;}
#chat-container-twitch, #chat-container-hub{min-height:0; height:calc(100% - 40px) !important;}
#chat-container-hub{display:flex; flex-direction:column;}
#hub-messages{min-height:0;}
/* tools internal scroll (so you can reach bottom) */
#tab-tools{display:flex; flex-direction:column;}
#tab-tools .tools-scroll{flex:1; min-height:0; overflow:auto;}
/* market overlay always centered like TwitFlix */
#market-overlay{position:fixed !important; inset:0 !important; display:flex; align-items:center; justify-content:center;}
#market-overlay.hidden{display:none !important;}
#market-overlay .market-modal{width:min(1100px, calc(100vw - 32px)); height:min(78vh, 720px); max-height:calc(100vh - 32px);}
@media (max-width: 980px){
  #main-layout{grid-template-columns:1fr; }
  #side-panel{grid-column:1 / 2 !important; height:auto !important;}
  #tab-chat, #tab-stats, #tab-tools{height:auto !important;}
}

/* Phase2: never overlay player tools above modals */
body.modal-open #player-tools{display:none !important;}


/* === BINANCE MARKET UI === */

    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:auto;
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background:#000; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--secondary); }

    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }

    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    .hub-msg{ padding:8px; border-bottom:1px solid #1a1a1a; font-size:13px; line-height:1.4; }
    .hub-msg strong{ font-family:Orbitron; font-size:11px; }
    .scrollbar-thin::-webkit-scrollbar{ width:4px; }

    /* badge statut */
    #socket-status{ transition:all .3s ease; }
    #socket-status.connected{
      color:#00f2ea; border-color:#00f2ea;
      box-shadow:0 0 8px rgba(0,242,234,.6);
      animation:hub-pulse 2s infinite;
    }
    @keyframes hub-pulse{ 0%,100%{opacity:1} 50%{opacity:.6} }

    /* BEST TIME TOOL */
    .best-time-tool{
      background:#151515; border:1px solid #00f2ea; border-radius:10px;
      padding:16px; margin-bottom:16px; box-shadow:inset 0 0 10px rgba(0,242,234,.1);
    }
    .best-time-tool h4{
      color:#00f2ea; font-family:Orbitron; font-size:12px;
      margin-bottom:10px; border-bottom:1px solid #00f2ea; padding-bottom:8px;
    }
    .best-time-tool input{
      width:100%; padding:10px; background:#0a0a0a; border:1px solid #333;
      color:#fff; border-radius:6px; font-size:12px; margin-bottom:8px;
    }
    .best-time-tool input:focus{ border-color:#00f2ea; box-shadow:0 0 8px rgba(0,242,234,.2); outline:none; }
    .best-time-tool button{
      width:100%; background:#00f2ea; color:#000; padding:10px;
      border:none; border-radius:6px; font-weight:bold; cursor:pointer;
      font-family:Orbitron; font-size:11px; transition:all .3s ease;
    }
    .best-time-tool button:hover:not(:disabled){ background:#fff; box-shadow:0 0 15px rgba(0,242,234,.4); transform:translateY(-1px); }
    .best-time-tool button:disabled{ opacity:.5; cursor:not-allowed; }
    .best-time-results{
      background:#0a0a0a; border:1px solid #333; border-radius:6px;
      padding:12px; margin-top:12px; font-size:12px; max-height:220px; overflow-y:auto;
    }
    .best-time-spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(0,242,234,.3); border-radius:50%;
      border-top-color:#00f2ea; animation:bt-spin 1s linear infinite;
      margin-right:6px; vertical-align:middle;
    }
    @keyframes bt-spin{ to{ transform:rotate(360deg) } }

    /* PLAYER sizing (grand) */
    .player-shell{ min-height:72vh; }
    #video-container{ min-height:62vh; }

    /* ====== ONGLETS SOUS LE LIVE (indépendants) ====== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }

    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* ====== TWITFLIX MODAL ====== */
    .tf-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px);
      z-index: 9999; display: none; align-items: center; justify-content: center;
    }
    .tf-modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .tf-modal-content {
      width: 90%; max-width: 1200px; height: 85vh;
      background: #0b0b0d; border: 1px solid #333; border-radius: 12px;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 242, 234, 0.1);
    }
    .tf-header {
      padding: 20px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
      background: #080808;
    }
    .tf-title { font-family: 'Orbitron'; color: #ff0099; font-size: 24px; letter-spacing: 2px; }
    .tf-title span { color: #00f2ea; }
    .tf-close { color: #666; cursor: pointer; font-size: 24px; transition: .3s; }
    .tf-close:hover { color: #fff; transform: rotate(90deg); }

    .tf-grid {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; align-content: start;
    }
    .tf-card {
      position: relative; aspect-ratio: 3/4; border-radius: 6px; overflow: hidden;
      cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border: 2px solid transparent;
    }
    .tf-card:hover {
      transform: scale(1.05); border-color: #00f2ea; z-index: 10;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.3);
    }
    .tf-poster { width: 100%; height: 100%; object-fit: cover; }
    .tf-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, black, transparent);
      padding: 10px; opacity: 0; transition: 0.3s;
    }
    .tf-card:hover .tf-overlay { opacity: 1; }
    .tf-name { font-size: 12px; font-weight: bold; color: white; text-align: center; }
  
    /* ====== TWITFLIX — Netflix rows (catalogue only, sans toucher le reste) ====== */
    .tf-controls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding: 0 16px 12px 16px;
      border-bottom:1px solid #1f1f23;
      background: rgba(11,11,13,.92);
    }
    .tf-view-toggle{
      display:flex; gap:6px; padding:4px; border-radius:12px;
      border:1px solid #2b2b31; background:#0a0a0a;
    }
    .tf-toggle-btn{
      border:0; background:transparent; color:#a7a7b2;
      font-family:Orbitron; font-size:10px; font-weight:900;
      letter-spacing:.10em;
      padding:8px 10px; border-radius:10px; cursor:pointer; transition:.2s;
    }
    .tf-toggle-btn:hover{ color:#fff; background:#151515; }
    .tf-toggle-btn.active{ color:#000; background:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.18); }

    .tf-grid{ padding: 14px 16px 18px 16px; }
    .tf-section{ margin-top: 18px; }
    .tf-section-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #eaeaf0;
      margin: 8px 0 10px 2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .tf-section-title .hint{ color:#7f7f8a; font-size:10px; letter-spacing:.06em; text-transform:none; font-family:Inter; font-weight:700; }

    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    /* Card sizing for rows (lisible) */
    .tf-card{ flex: 0 0 170px; aspect-ratio: 2/3; }
    .tf-card:hover{ transform: scale(1.06); } /* moins agressif pour éviter le clipping */
    .tf-name{ font-size: 11px; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* A–Z bar */
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.74));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 8px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }


    /* ====== TWITFLIX — performance + Netflix rows ====== */
    .tf-rows{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: block;
    }
    .tf-row{ margin-bottom: 22px; }
    .tf-row-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color:#eaeaf0;
      margin: 8px 0 10px 2px;
    }
    .tf-row-title span{ color:#00f2ea; }
    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
    .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
    .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

    .tf-az{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display:block;
    }
    .tf-azbar{
      position: sticky;
      top: 0;
      z-index: 30;
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.78));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 10px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }

    .tf-sentinel{
      padding: 18px 0 4px 0;
      display:flex;
      justify-content:center;
    }
    .tf-sentinel-inner{
      font-size: 12px;
      color:#9b9ba3;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .tf-sentinel-inner.done{
      color:#00f2ea;
      border-color:#00f2ea;
      background: rgba(0,242,234,.06);
    }
    .tf-retry{
      background:#151515;
      border:1px solid #2b2b31;
      color:#fff;
      padding:10px 14px;
      border-radius: 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:.2s;
    }
    .tf-retry:hover{
      border-color:#00f2ea;
      box-shadow:0 0 18px rgba(0,242,234,.18);
      transform: translateY(-1px);
    }


    /* TwitFlix search (Netflix style) */
    .tf-search-wrap{ position:relative; width:min(520px, 100%); }
    .tf-search{
      width:100%;
      background:#0a0a0a;
      border:1px solid #2b2b31;
      color:#fff;
      border-radius:10px;
      padding:10px 12px 10px 36px;
      font-size:13px;
      outline:none;
      transition:.2s;
    }
    .tf-search:focus{
      border-color:#00f2ea;
      box-shadow:0 0 0 3px rgba(0,242,234,.12);
    }
    .tf-search-ico{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:#777;
      font-size:13px;
      pointer-events:none;
    }


/* === TwitFlix UX Overhaul (Netflix-like) — overrides only (does not touch rest of app) === */
#twitflix-modal .tf-modal-content{ max-width: 1400px; }

#twitflix-modal .tf-topbar{ position: sticky; top:0; z-index: 60; }
#twitflix-modal .tf-actions{ gap: 12px; }
#twitflix-modal .tf-search{ font-size: 14px; padding: 12px 14px 12px 38px; }

#twitflix-modal .tf-grid{
  display:flex;
  flex-direction: column;
  gap: 18px;
  padding: 14px 18px 24px 18px;
}

#twitflix-modal .tf-hero{
  position: relative;
  height: 220px;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid #1f1f23;
  background: #0a0a0a;
}
#twitflix-modal .tf-hero::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 20%, rgba(0,242,234,.18), transparent 60%),
              radial-gradient(circle at 80% 30%, rgba(255,0,153,.14), transparent 55%),
              linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.20));
  z-index:2;
}
#twitflix-modal .tf-hero-bg{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
  filter: saturate(1.05) contrast(1.05);
  opacity:.55;
}
#twitflix-modal .tf-hero-content{
  position:absolute; inset:0;
  z-index:3;
  display:flex;
  align-items:flex-end;
  padding: 18px;
}
#twitflix-modal .tf-hero-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .08em;
  font-size: 18px;
  font-weight: 900;
  color:#fff;
  text-shadow: 0 6px 24px rgba(0,0,0,.8);
}
#twitflix-modal .tf-hero-sub{
  margin-top: 6px;
  font-size: 12px;
  color:#cfcfda;
  max-width: 70ch;
  line-height: 1.35;
}

#twitflix-modal .tf-row{ display:flex; flex-direction:column; gap: 10px; }
#twitflix-modal .tf-row-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: 12px;
  color:#eaeaf0;
  display:flex; align-items:center; justify-content:space-between;
}
#twitflix-modal .tf-row-title span{ color:#00f2ea; }
#twitflix-modal .tf-row-track{
  display:flex;
  gap: 16px;
  overflow-x:auto;
  padding-bottom: 10px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}
#twitflix-modal .tf-row-track::-webkit-scrollbar{ height: 6px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

#twitflix-modal .tf-card{
  flex: 0 0 170px;
  border-radius: 12px;
  overflow:hidden;
  background:#101013;
  border:1px solid #1d1d22;
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}
#twitflix-modal .tf-card:hover{
  transform: scale(1.06);
  z-index: 40;
  border-color:#00f2ea;
  box-shadow: 0 18px 45px rgba(0,0,0,.55), 0 0 18px rgba(0,242,234,.18);
}
#twitflix-modal .tf-poster{
  width:100%; height:100%;
  object-fit: cover;
  transform: scale(1.02);
  opacity:.95;
}
#twitflix-modal .tf-card:hover .tf-poster{ opacity:.35; }

#twitflix-modal .tf-overlay{
  padding: 10px 10px 12px 10px;
}
#twitflix-modal .tf-name{
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
#twitflix-modal .tf-meta{ display:none; } /* cache le texte “Survol…” */
#twitflix-modal .tf-actions-row{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-top: 10px;
}
#twitflix-modal .tf-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 10px;
  font-weight: 900;
  color:#000;
  background:#00f2ea;
}
#twitflix-modal .tf-pill.ghost{
  background: rgba(255,255,255,.08);
  color:#e8e8ee;
  border:1px solid rgba(255,255,255,.14);
}

#twitflix-modal .tf-search-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  padding-top: 10px;
}

#twitflix-modal .tf-azbar{
  position: sticky;
  top: 66px; /* sous la topbar */
  z-index: 55;
  display:flex;
  flex-wrap:wrap;
  gap: 6px;
  padding: 10px 0 8px 0;
  background: linear-gradient(180deg, rgba(11,11,13,.96), rgba(11,11,13,.72));
  border-bottom: 1px solid #1f1f23;
}
#twitflix-modal .tf-azlink{
  font-family: Orbitron, sans-serif;
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .12em;
  color:#a7a7b2;
  text-decoration:none;
  padding: 6px 8px;
  border-radius: 10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.12);
  transition:.2s;
}
#twitflix-modal .tf-azlink:hover{ color:#000; background:#00f2ea; border-color:#00f2ea; }

#twitflix-modal .tf-end{
  text-align:center;
  color:#9b9ba3;
  padding: 18px 0 6px 0;
}
#twitflix-modal .tf-retry{
  margin-top: 10px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #2b2b31;
  background:#151515;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
#twitflix-modal .tf-retry:hover{ border-color:#00f2ea; box-shadow:0 0 18px rgba(0,242,234,.18); transform: translateY(-1px); }


    /* HUB extras (emotes, gifs, réactions) */
    .hub-emo{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8ee;
      padding:6px 10px;
      border-radius: 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .hub-emo:hover{ border-color:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.15); }
    .hub-msg{
      padding:8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hub-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      margin-left:6px;
    }
    .hub-gif{
      margin-top:6px;
      border-radius: 12px;
      max-width: 260px;
      border:1px solid rgba(255,255,255,.10);
    }
    .hub-reactions{
      display:flex;
      gap:6px;
      margin-top:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hub-react-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-react-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:#e8e8ee;
      font-size:12px;
    }



/* === EXTRAORDINAIRES (SAFE) === */
.hub-msg .hub-react-row{ opacity:0; max-height:0; overflow:hidden; transition: .18s ease; }
.hub-msg:hover .hub-react-row{ opacity:1; max-height:40px; }
.hub-msg.is-tapped .hub-react-row{ opacity:1; max-height:40px; }

.hub-gif{ max-width: 240px; border-radius: 10px; margin-top: 8px; border:1px solid rgba(255,255,255,.10); display:block; }

#ambilight{
  position:absolute; inset:-14px;
  filter: blur(26px);
  opacity:.55;
  z-index:0;
  pointer-events:none;
  transition: background .25s ease;
}
#player-wrap{ position:relative; }
#player-wrap > *{ position:relative; z-index:1; }

.mosaic-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 8px;
  width: 100%;
  height: 100%;
}
.mosaic-grid iframe{ width:100%; height:100%; border:0; border-radius:14px; }

.vibe-chill{ border:1px solid rgba(34,197,94,.55)!important; box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset; }
.vibe-hype{ border:1px solid rgba(0,242,234,.70)!important; box-shadow: 0 0 0 1px rgba(0,242,234,.25) inset; }
.vibe-toxic{ border:1px solid rgba(239,68,68,.60)!important; box-shadow: 0 0 0 1px rgba(239,68,68,.22) inset; }


    /* ==== HUB Chat UX fixes ==== */
    #chat-container-hub { min-height: 520px; }
    #hub-messages { scroll-behavior: smooth; padding-bottom: 90px; }
    /* Keep input always visible */
    #chat-container-hub form { position: sticky; bottom: 0; z-index: 20; }

    /* Messenger-like reactions: hidden until hover/tap */
    .hub-react-row{ 
      opacity: 0; 
      max-height: 0; 
      overflow: hidden;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity .15s ease, max-height .15s ease, transform .15s ease;
    }
    .hub-msg:hover .hub-react-row, .hub-msg.show-reactions .hub-react-row{
      opacity: 1;
      max-height: 44px;
      pointer-events: auto;
      transform: translateY(0);
    }
    .hub-react-btn{
      width: 34px; height: 34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .hub-react-btn:hover{ border-color:#00f2ea; }
    .hub-reactions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .hub-reaction-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    /* Ensure modules below player aren't clipped inside iframe */
    body { overflow-y: auto; }
    .page-wrap { padding-bottom: 40px; }


/* === Tools overlay (safe) === */

#player-tools{
  position:absolute;
  top:10px;
  right:10px;
  z-index:99999 !important;
  display:flex;
  gap:8px;
  pointer-events:auto;
}
#player-tools .toolbtn{ pointer-events:auto; }
#video-container iframe{ position:relative; z-index:1 !important; }
#video-container .player-wrap, #video-container #player{ position:relative; z-index:1 !important; }

#video-container{ position:relative; overflow: visible !important; }
.toolbtn{
  width:38px;height:34px;border-radius:12px;
  background:rgba(16,16,18,.86);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;font-weight:900;cursor:pointer;
}
.toolbtn:hover{ border-color:#00f2ea; transform: translateY(-1px); }
.toolbtn.active{ border-color:#00f2ea; box-shadow:0 0 0 2px rgba(0,242,234,.22) inset; }

#ambilight{
  position:absolute; inset:-90px; z-index:0;
  filter: blur(60px);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s ease;
}
#ambilight.on{ opacity:.78; }

#video-container iframe, #video-container .player-wrap, #video-container #player{ position:relative; z-index:2; }

/* Vibe borders */
.vibe-chill{ box-shadow: 0 0 0 2px rgba(0,242,234,.35) inset, 0 0 18px rgba(0,242,234,.18); }
.vibe-hype{ box-shadow: 0 0 0 2px rgba(255,0,153,.35) inset, 0 0 18px rgba(255,0,153,.18); }
.vibe-toxic{ box-shadow: 0 0 0 2px rgba(255,214,0,.35) inset, 0 0 18px rgba(255,214,0,.18); }

/* Modals (reuse if not already) */
.modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.75);
  display:none; align-items:center; justify-content:center;
  z-index:99999;
}
.modal-overlay.active{ display:flex; }
.modal-card{
  width:min(1100px,94vw);
  max-height:92vh;
  overflow:auto;
  background:#0b0b0d;
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: 0 0 40px rgba(0,0,0,.6);
  padding:14px;
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px; }
.modal-title{ font-family:Orbitron, sans-serif; letter-spacing:.12em; font-weight:900; font-size:12px; color:#eaeaf0; text-transform:uppercase; }
.modal-close{
  background:#151515; border:1px solid #2b2b31; color:#fff;
  width:36px; height:36px; border-radius:12px; cursor:pointer;
}
.modal-close:hover{ border-color:#00f2ea; }

.mosaic-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
.mosaic-tile{ background:#000; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; position:relative; aspect-ratio:16/9; }
.mosaic-tile button{
  position:absolute; top:10px; right:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.18);
  color:#fff; border-radius:12px;
  padding:6px 10px; font-weight:900; cursor:pointer;
}
.mosaic-tile button:hover{ border-color:#00f2ea; }


/* === FORCE PLAYER + SIDE PANEL ALWAYS SIDE-BY-SIDE (embed-safe) === */
#main-layout{ 
      /* HARD FIX: force 2-column layout even if Tailwind is blocked by CSP */
      display: grid !important;
      grid-template-columns: minmax(0, 1fr) 420px;
      gap: 18px;
      align-items: stretch;
      min-height: 0;
    }
    /* Left column (player + top modules) */
    #main-layout > .col-span-8{ grid-column: 1 / 2; min-width: 0; }
    /* Right column (Chat/Stats/Tools) */
    #side-panel{ grid-column: 2 / 3; min-width: 320px; width: 100%; }
    /* Responsive: stack on small screens */
    @media (max-width: 1100px){
      #main-layout{ grid-template-columns: 1fr; }
      #main-layout > .col-span-8{ grid-column: 1 / -1; }
      #side-panel{ grid-column: 1 / -1; min-width: 0; }
    }
#main-layout > .col-span-8{ min-width: 640px; }
#side-panel{ min-width: 360px; max-width: 520px; }


/* === FIX: Sidebar chat should NOT deform Twitch player === */
#main-layout{ align-items: start !important; }
.player-shell{
  flex: 0 0 auto !important;
  height: clamp(520px, 72vh, 860px) !important;
  min-height: unset !important;
}
#video-container{
  flex: 1 1 auto !important;
  min-height: unset !important;
  height: 100% !important;
}


/* === FIX: side-panel height locked to player (Hub Secure can't stretch layout) === */
#side-panel{
  height: clamp(520px, 72vh, 860px) !important;
  min-height: 0 !important;
}
#tab-chat{
  min-height: 0 !important;
}
#chat-container-twitch,
#chat-container-hub{
  flex: 1 1 auto !important;
  min-height: 0 !important;
}
#hub-messages{
  min-height: 0 !important;
}

/* Ensure chat iframe can't force extra height */
#twitch-chat-frame{ display:block; width:100%; height:100%; }

/* === FIX: Messenger-like reactions (attached to message) without layout shift === */
.hub-msg{ position: relative !important; padding-bottom: 34px !important; }

/* Pills (existing reactions) stick to the bottom-right of the message */
.hub-reactions{
  position: absolute !important;
  right: 10px !important;
  bottom: 8px !important;
  margin: 0 !important;
  display: inline-flex !important;
  gap: 6px !important;
  flex-wrap: wrap !important;
  justify-content: flex-end !important;
  pointer-events: none !important;
}
/* Hide empty reactions container */
.hub-reactions:empty{ display:none !important; }

/* Reaction picker appears just above the pills, like Messenger */
.hub-react-row{
  position: absolute !important;
  right: 10px !important;
  bottom: 36px !important;
  opacity: 0 !important;
  pointer-events: none !important;
  transform: translateY(6px) !important;
  transition: opacity .15s ease, transform .15s ease !important;
  z-index: 5 !important;
}
.hub-msg:hover .hub-react-row,
.hub-msg.show-reactions .hub-react-row{
  opacity: 1 !important;
  pointer-events: auto !important;
  transform: translateY(0) !important;
}


/* HARD LAYOUT FIX: keep player left + side panel right even if Tailwind CDN/CSP fails */
#main-layout{
  display:grid !important;
  grid-template-columns:minmax(0,1fr) 420px !important;
  gap:16px !important;
  align-items:stretch !important;
  min-height:0 !important;
}
#main-layout > .col-span-8{ grid-column:1 !important; min-width:0 !important; }
#side-panel{ grid-column:2 !important; min-width:0 !important; height:100% !important; }
@media (max-width: 1100px){
  #main-layout{ grid-template-columns:1fr !important; }
  #side-panel{ grid-column:1 !important; }
}
/* Centered Market modal like TwitFlix */
#market-overlay .market-modal{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(1200px,96vw);
  height:min(88vh,900px);
  border-radius:18px;
  overflow:hidden;
}



    /* ====== HELP TOOLTIPS (❓) ====== */
    .help{
      cursor:pointer;
      margin-left:6px;
      color: rgba(180,200,255,.95);
      font-size: 13px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(180,200,255,.35);
      background: rgba(255,255,255,.04);
      position:relative;
      user-select:none;
    }
    .help:hover{
      background: rgba(180,200,255,.14);
      border-color: rgba(180,200,255,.55);
    }
    .help:hover::after{
      content: attr(data-help);
      position:absolute;
      left:0;
      top:26px;
      background: rgba(10,10,14,.96);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:12px;
      width: 260px;
      z-index: 99999;
      box-shadow: 0 10px 24px rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      white-space: normal;
    }
    .help:hover::before{
      content:'';
      position:absolute;
      left:10px;
      top:20px;
      border:7px solid transparent;
      border-bottom-color: rgba(10,10,14,.96);
      z-index: 99999;
    }

    /* ====== TWITFLIX HEADER CAROUSELS ====== */
    .tf-header-block{
      margin-top: 10px;
    }
    .tf-strip-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 8px 0 10px 2px;
    }
    .tf-strip-title h4{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color:#eaeaf0;
      margin:0;
    }
    .tf-carousel{
      display:flex;
      gap:14px;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-behavior:smooth;
      padding-bottom: 6px;
      min-height: 154px;
    }
    .tf-carousel::-webkit-scrollbar{ height: 8px; }
    .tf-carousel::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius:999px; }
    .tf-live-card{
      width: 250px;
      flex: 0 0 auto;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      position:relative;
    }
    .tf-live-thumb{
      width: 100%;
      height: 140px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .tf-live-thumb .tf-preview{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.2);
    }
    .tf-live-meta{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .tf-live-meta .t1{ font-weight: 800; font-size: 13px; color:#fff; }
    .tf-live-meta .t2{ font-size: 12px; color: rgba(255,255,255,.72); }
    .tf-live-badge{
      position:absolute;
      top:10px;
      left:10px;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
    }

    .tf-trailer-card{
      width: 320px;
      height: 180px;
      flex: 0 0 auto;
      border-radius: 14px;
      overflow:hidden;
      background:#000;
      border: 1px solid rgba(255,255,255,.10);
    }
    .tf-trailer-card iframe{ width:100%; height:100%; border:0; display:block; }
    .tf-trailer-fallback{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.75);
      font-size: 12px;
      padding: 18px;
      text-align:center;
    }
    

#tf-live-carousel{min-height: 154px;}
</style>

<style id="tabs-exclusive-patch">
  /* --- Tabs exclusive patch (anti empilement) --- */
  #side-panel{ display:flex !important; flex-direction:column !important; min-height:0 !important; }
  #side-panel .tab-nav{ flex:0 0 auto !important; }
  #tabs-viewport{ flex:1 1 auto !important; position:relative !important; min-height:0 !important; background:#0b0b0d; }
  #tabs-viewport .tab-content{
    position:absolute !important; inset:0 !important;
    display:none !important;
    flex-direction:column !important;
    height:100% !important;
    min-height:0 !important;
  }
  #tabs-viewport .tab-content.active{ display:flex !important; }
  /* assure un scroll interne */
  #tabs-viewport .tools-scroll,
  #tabs-viewport .stats-scroll,
  #tabs-viewport #chat-container-twitch,
  #tabs-viewport #chat-container-hub{
    flex:1 1 auto !important;
    min-height:0 !important;
    overflow:auto !important;
  }
  /* si un wrapper chat existe, on le force à prendre la place */
  #tabs-viewport #tab-chat{ min-height:0 !important; }
</style>

</head>
<body class="min-h-screen flex flex-col p-4">
<!-- Spacer (embed-safe): évite que le haut soit coupé dans certains iframes -->
<div style="height:18px;"></div>
<header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
<div class="flex items-center gap-4">
<h1 class="text-2xl font-orbitron italic tracking-widest">
<span class="text-[#00f2ea]">STREAMER</span> HUB
        <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">PRO</span>
</h1>
<div class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded" id="socket-status">
        HUB DISCONNECTED
      </div>
</div>
<div class="flex items-center gap-3">
<button class="bg-[#111] hover:bg-[#222] text-[#ff0099] px-4 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#333] hover:border-[#ff0099] shadow-[0_0_10px_rgba(255,0,153,0.1)]" onclick="openTwitFlix()">
<i class="fas fa-play-circle"></i> TWITFLIX
      </button>
<button class="bg-[#111] hover:bg-[#161616] border border-[#00f2ea33] text-[#00f2ea] px-4 py-2 rounded font-bold transition flex items-center gap-2" onclick="openMarketOverlay()">
<i class="fas fa-chart-line"></i> MARCHÉ
      </button>
<div class="h-6 w-[1px] bg-[#333]"></div>
<button class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]" id="btn-auth" onclick="startAuth()">
<i class="fab fa-twitch"></i> CONNEXION
      </button>
<div class="hidden flex items-center gap-3" id="user-area">
<img class="w-8 h-8 rounded-full border border-[#00f2ea]" id="user-avatar" src=""/>
<span class="font-bold text-white text-sm" id="user-name"></span>
<button class="text-gray-500 hover:text-white" onclick="logout()">
<i class="fas fa-sign-out-alt"></i>
</button>
</div>
</div>
</header>
<div class="mb-4 relative group">
<div class="carousel-track" id="carousel">
<div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
<i class="fas fa-satellite-dish mb-2"></i><br/>
        Connectez-vous pour voir vos chaînes.
      </div>
</div>
<div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
</div>
<div class="flex-grow grid grid-cols-12 gap-6 min-h-0 overflow-x-auto" id="main-layout">
<div class="col-span-8 flex flex-col gap-4 min-h-0" id="left-col">
<div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl player-shell">
<div class="bg-[#080808] p-3 flex justify-between items-center border-b border-[#222]">
<div class="flex items-center gap-3 flex-1 min-w-0">
<div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
<span class="font-orbitron text-[#00f2ea] text-sm tracking-wider truncate" id="current-channel-display">OFFLINE</span>
<span class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400 flex-shrink-0" id="player-mode-badge">AUTO</span>
<span class="text-[10px] text-[#ff0099] font-bold flex-shrink-0" id="viewer-count">0 viewers</span>
</div>
<div class="flex gap-2 flex-shrink-0">
<button class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center" onclick="cycle('prev')">
<i class="fas fa-chevron-left"></i>
</button>
<button class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center" onclick="cycle('next')">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>
<div class="flex-grow bg-black relative w-full h-full overflow-hidden" id="video-container">
<div id="player-tools" style="position:absolute;top:10px;right:10px;z-index:20;display:flex;gap:8px;">
<button class="toolbtn" id="tool-mosaic" onclick="openMosaic()">📺</button>
<button class="toolbtn" id="tool-fantasy" onclick="openFantasy()">🏆</button>
<button class="toolbtn" id="tool-ambilight" onclick="toggleAmbilight()">💡</button>
<button class="toolbtn" id="tool-vibe" onclick="toggleVibe()">🧠</button>
</div>
<div aria-hidden="true" id="ambilight"></div>
</div>
</div>
<div class="glass-panel rounded-lg overflow-hidden min-h-[360px]">
<div class="u-nav" id="under-tabs-nav">
<button class="u-tab-btn active" data-ut="overview"><i class="fas fa-bolt mr-1"></i> OVERVIEW</button>
<button class="u-tab-btn" data-ut="analytics"><i class="fas fa-chart-line mr-1"></i> ANALYTICS PRO</button>
<button class="u-tab-btn" data-ut="niche"><i class="fas fa-compass mr-1"></i> NICHE</button>
</div>
<div class="u-tab-panel active p-4 bg-[#0b0b0d]" id="under-overview">
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Growth Score</div>
<div class="text-2xl font-orbitron text-[#00f2ea]" id="kpi-growth-score">--</div>
<div class="text-[10px] text-gray-400 mt-1" id="kpi-growth-label">--</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Moy. viewers (30j)</div>
<div class="text-2xl font-orbitron text-white" id="kpi-avg">--</div>
<div class="text-[10px] text-gray-500 mt-1">données Firestore</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Pic viewers</div>
<div class="text-2xl font-orbitron text-white" id="kpi-peak">--</div>
<div class="text-[10px] text-gray-500 mt-1">sur période</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Croissance</div>
<div class="text-2xl font-orbitron text-[#ff0099]" id="kpi-growth">--</div>
<div class="text-[10px] text-gray-500 mt-1">début → fin</div>
</div>
</div>
<div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
<i class="fas fa-bell mr-1"></i> Alertes automatiques
              </h4>
<div class="text-xs text-gray-400" id="alerts-box">—</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
<i class="fas fa-wave-square mr-1"></i> Courbe daily
              </h4>
<div class="h-44"><canvas id="chartChannelDaily"></canvas></div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222] lg:col-span-2">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">
<i class="fas fa-magic mr-1"></i> IA – plan d’action
              </h4>
<button class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron" id="btn-ai-reco" onclick="loadAIReco()">
                ⚡ Générer des recommandations
              </button>
<div class="mt-3 text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto bg-[#0a0a0a] border border-[#222] rounded p-2 hidden" id="ai-reco-box"></div>
</div>
</div>
</div>
<div class="u-tab-panel p-4 bg-[#0b0b0d]" id="under-analytics">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Volatilité</div>
<div class="text-2xl font-orbitron text-white" id="kpi-volatility">--</div>
<div class="text-[10px] text-gray-500 mt-1">plus bas = plus stable</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Heures / semaine (estim.)</div>
<div class="text-2xl font-orbitron text-white" id="kpi-hours">--</div>
<div class="text-[10px] text-gray-500 mt-1">basé sur snapshots</div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<div class="text-[10px] text-gray-500 uppercase">Échantillons</div>
<div class="text-2xl font-orbitron text-white" id="kpi-samples">--</div>
<div class="text-[10px] text-gray-500 mt-1">jours couverts</div>
</div>
</div>
<div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-flask mr-1"></i> Simulation</h4>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
<input class="cyber-input" id="sim-hours" max="80" min="1" placeholder="Heures / semaine" type="number" value="12"/>
<button class="bg-[#ff0099] text-white px-4 rounded font-bold hover:bg-white hover:text-black transition font-orbitron text-xs" onclick="runSimulation()">
                SIMULER
              </button>
<div class="text-xs text-gray-300 flex items-center bg-[#0a0a0a] border border-[#222] rounded px-3" id="sim-result">--</div>
</div>
</div>
</div>
<div class="u-tab-panel p-4 bg-[#0b0b0d]" id="under-niche">
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-crosshairs mr-1"></i> Chaîne vs Jeu</h4>
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
<div>
<div class="text-[10px] text-gray-500 uppercase">Saturation</div>
<div class="text-xl font-orbitron text-[#00f2ea]" id="niche-sat">--</div>
</div>
<div>
<div class="text-[10px] text-gray-500 uppercase">Découvrabilité</div>
<div class="text-xl font-orbitron text-[#ff0099]" id="niche-discover">--</div>
</div>
<div>
<div class="text-[10px] text-gray-500 uppercase">Position</div>
<div class="text-xl font-orbitron text-white" id="niche-position">--</div>
</div>
<div>
<div class="text-[10px] text-gray-500 uppercase">Verdict</div>
<div class="text-xl font-orbitron text-white" id="niche-verdict">--</div>
</div>
</div>
<div class="mt-3 text-xs text-gray-300" id="niche-details">—</div>
</div>
<div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-fire mr-1"></i> Heatmap meilleures heures (jeu)</h4>
<div class="h-44"><canvas id="chartGameHours"></canvas></div>
<div class="text-[10px] text-gray-500 mt-2">Plus haut = plus d’opportunité (viewers / concurrence).</div>
</div>
</div>
<div class="col-span-4 flex flex-col glass-panel rounded-lg overflow-hidden h-full min-h-0" id="side-panel">
<div class="tab-nav">
<button class="tab-btn active" onclick="openTab(event,'chat')"><i class="fas fa-comments mr-1"></i> CHAT</button>
<button class="tab-btn" onclick="openTab(event,'stats')"><i class="fas fa-chart-pie mr-1"></i> STATS</button>
<button class="tab-btn" onclick="openTab(event,'tools')"><i class="fas fa-toolbox mr-1"></i> OUTILS</button>
</div>
<div class="tab-content active bg-[#0e0e10]" id="tab-chat">
<div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222] chat-mode-bar">
<button class="flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded" id="btn-mode-twitch" onclick="toggleChatMode('twitch')">TWITCH</button>
<button class="flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white" id="btn-mode-hub" onclick="toggleChatMode('hub')">HUB SECURE</button>
</div>
<div class="flex-grow relative bg-black overflow-hidden" id="chat-container-twitch">
<iframe allow="autoplay" frameborder="0" height="100%" id="twitch-chat-frame" scrolling="yes" src="" width="100%"></iframe>
</div>
<div class="flex-grow hidden flex-col relative bg-[#0b0b0d]" id="chat-container-hub">
<div class="flex-grow overflow-y-auto p-2 scrollbar-thin" id="hub-messages">
<div class="text-center text-gray-600 text-xs mt-4">
              Bienvenue sur le Hub Sécurisé — Connecté en tant que : <span class="text-[#00f2ea] font-bold" id="hub-user-display">Anonyme</span>
</div>
</div>
<form class="p-2 border-t border-[#222] flex gap-2 bg-[#080808] items-center" onsubmit="sendHubMessage(event)">
<button class="px-2 py-2 rounded-lg border border-[#333] text-gray-200 hover:border-[#00f2ea]" id="hub-emoji-btn" title="Emotes" type="button">🙂</button>
<button class="px-2 py-2 rounded-lg border border-[#333] text-gray-200 hover:border-[#00f2ea]" id="hub-gif-btn" title="GIF" type="button">🎁</button>
<input class="bg-[#0b0b0d] text-white px-3 py-2 rounded-lg flex-grow outline-none border border-[#333] focus:border-[#00f2ea]" id="hub-input" placeholder="Message / /gif / stickers..." type="text"/>
<button class="text-[#0b0b0d] bg-[#00f2ea] px-4 py-2 rounded-lg font-black hover:opacity-90" type="submit">Envoyer</button>
</form>
<div class="hidden absolute bottom-14 left-2 z-50 bg-[#0b0b0d] border border-[#222] rounded-xl p-2 shadow-2xl" id="hub-emoji-panel">
<div class="flex flex-wrap gap-2 text-sm">
<button class="hub-emo" type="button">:kappa:</button>
<button class="hub-emo" type="button">:pog:</button>
<button class="hub-emo" type="button">:gg:</button>
<button class="hub-emo" type="button">:love:</button>
<button class="hub-emo" type="button">:hype:</button>
<button class="hub-emo" type="button">:rip:</button>
<button class="hub-emo" type="button">:clap:</button>
<button class="hub-emo" type="button">:fire:</button>
</div>
<div class="text-[10px] text-gray-500 mt-2">Clique pour insérer dans ton message.</div>
</div>
<div class="hidden fixed inset-0 z-[9999] bg-black/70" id="hub-gif-modal">
<div class="max-w-3xl w-[92%] mx-auto mt-10 bg-[#0b0b0d] border border-[#222] rounded-2xl overflow-hidden shadow-2xl">
<div class="p-3 flex items-center gap-2 border-b border-[#222]">
<div class="font-black text-white tracking-widest">GIF</div>
<input class="flex-grow bg-[#070708] text-white px-3 py-2 rounded-lg border border-[#222] focus:border-[#00f2ea] outline-none" id="hub-gif-search" placeholder="Rechercher un GIF..."/>
<button class="px-3 py-2 rounded-lg border border-[#222] text-white hover:border-[#00f2ea]" id="hub-gif-close">Fermer</button>
</div>
<div class="p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-[70vh] overflow-y-auto" id="hub-gif-grid"></div>
</div>
</div>
</div>
</div>
<div class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] scrollbar-thin" id="tab-stats">
<div class="grid grid-cols-2 gap-3 mb-6">
<div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
<div class="text-[10px] text-gray-500 uppercase">Viewers Totaux</div>
<div class="text-2xl font-orbitron text-white" id="kpi-viewers">--</div>
</div>
<div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
<div class="text-[10px] text-gray-500 uppercase">Chaînes FR</div>
<div class="text-2xl font-orbitron text-white" id="kpi-channels">--</div>
</div>
</div>
<div class="space-y-6">
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-chart-line mr-1"></i> Tendance</h4>
<div class="h-40"><canvas id="chartViewers"></canvas></div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
<div class="h-48"><canvas id="chartGames"></canvas></div>
</div>
<div class="bg-[#111] p-3 rounded border border-[#222]">
<h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
<div class="h-40"><canvas id="chartLangs"></canvas></div>
</div>
</div>
</div>
<div class="tab-content bg-[#0b0b0d]" id="tab-tools"><div class="tools-scroll p-4 space-y-6 scrollbar-thin">
<div class="best-time-tool">
<h4>🎯 BEST TIME TO STREAM</h4>
<input id="best-time-game" placeholder="Jeu ex: League of Legends..." type="text"/>
<button id="analyze-schedule-btn" onclick="analyzeBestTime()"><i class="fas fa-clock"></i> ANALYSER</button>
<div id="best-time-loading" style="display:none; text-align:center; margin-top:10px; color:#00f2ea;">
<span class="best-time-spinner"></span>Analyse en cours...
          </div>
<div class="best-time-results" id="best-time-results" style="display:none;"></div>
</div>
<div>
<div class="bg-[#101012] border border-[#222] rounded-xl p-4">
<div class="flex items-start justify-between gap-3">
<div>
<h4 class="text-sm font-black tracking-widest text-white"><i class="fas fa-chart-line mr-2 text-[#00f2ea]"></i>MARCHÉ — ouvrir la fenêtre</h4>
<p class="text-xs text-gray-400 mt-1">
                Le Marché s’ouvre en <strong>overlay</strong> (comme TwitFlix) pour ne jamais écraser le lecteur et garder une UX propre.
              </p>
</div>
<button class="px-3 py-2 rounded-lg bg-[#0b0b0d] border border-[#333] text-white hover:border-[#00f2ea]" onclick="openMarketOverlay()">📈 Ouvrir</button>
</div>
</div>
<h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">SCANNER IA</h3>
<div class="flex gap-2 mb-3">
<input class="cyber-input" id="scan-query" placeholder="Pseudo ex: ZeratoR" type="text"/>
<button class="bg-[#00f2ea] text-black px-4 rounded font-bold hover:bg-white" onclick="runScan()">
<i class="fas fa-search"></i>
</button>
</div>
<div class="hidden bg-[#151515] p-3 rounded border border-[#222]" id="scan-res">
<div class="flex gap-3 items-center mb-3">
<img class="w-12 h-12 rounded-full border border-[#00f2ea]" id="scan-img" src=""/>
<div>
<div class="font-bold text-white" id="scan-name">--</div>
<div class="text-xs text-gray-500" id="scan-game">--</div>
</div>
</div>
<div class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto" id="scan-ai"></div>
</div>
</div>
<div>
<h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">RAID FINDER</h3>
<div class="flex gap-2 mb-3">
<input class="cyber-input" id="raid-game" placeholder="Jeu ex: League" type="text"/>
<input class="cyber-input" id="raid-viewers" placeholder="Max viewers" type="number" value="100"/>
</div>
<button class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white mb-3" onclick="runRaid()">🔍 CHERCHER</button>
<div class="hidden bg-[#151515] p-3 rounded border border-[#222]" id="raid-res">
<img class="w-full h-40 rounded mb-3 object-cover" id="raid-img" src=""/>
<div class="text-xs text-gray-300" id="raid-info"></div>
<button class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold mt-2 hover:bg-white" id="raid-btn" onclick="goToRaid()">🎮 ALLER AU RAID</button>
</div>
</div>
<div>
<h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">CO-STREAM MATCH</h3>
<div class="text-xs text-gray-400 mb-2">Trouve un co-streamer compatible (jeu/langue/taille).</div>
<button class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron" id="costream-btn" onclick="loadCoStreamer()">
            🤝 TROUVER
          </button>
<div class="mt-3 bg-[#151515] p-3 rounded border border-[#222]" id="costream-out" style="display:none;"></div>
</div>
<div>
<h3 class="text-[#ff0099] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">BOOST</h3>
<input class="cyber-input mb-2" id="boost-query" placeholder="Chaîne..." type="text"/>
<button class="w-full bg-[#ff0099] text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition" onclick="runBoost()">ACTIVER</button>
<div class="text-center text-xs mt-2 text-green-400" id="boost-msg"></div>
</div>
</div></div>
</div>
</div>
<div class="tf-modal-overlay" id="twitflix-modal">
<div class="tf-modal-content">
<div class="tf-topbar">
<div class="tf-brand"><span class="dot"></span><span><span style="color:#00f2ea;">TWIT</span>FLIX</span></div>
<div class="tf-actions">
<div class="tf-search-wrap">
<i class="fas fa-search tf-search-ico"></i>
<input autocomplete="off" class="tf-search" id="twitflix-search" placeholder="Rechercher un jeu (ex: Minecraft, Valorant...)" type="text"/>
</div>
<div class="tf-view-toggle">
<button class="tf-toggle-btn active" id="tf-btn-rows" onclick="setTwitFlixView('rows')" type="button">LIGNES</button>
<button class="tf-toggle-btn" id="tf-btn-az" onclick="setTwitFlixView('az')" type="button">A–Z</button>
</div>
<i class="fas fa-times tf-close" onclick="closeTwitFlix()"></i>
</div>
</div>
<div class="tf-sub" style="display:none;"></div>
<div class="tf-hero"><img alt="" class="tf-hero-bg" id="tf-hero-bg" src=""/><div class="tf-hero-content"><div><div class="tf-hero-title" id="tf-hero-title">TWITFLIX</div><div class="tf-hero-sub" id="tf-hero-sub">Découvre des jeux, survole pour une preview, clique pour lancer un stream.</div></div></div></div>


<div class="tf-hero" id="tf-hero">
  <div class="tf-hero-title">
    <h4>Twiflix — Lives en cours <span class="help" data-help="Défile à la souris (comme Twitch). Survole une carte pour une preview. Clique pour lancer le live + voir les VOD.">?</span></h4>
  </div>

  <div class="tf-hero-track" id="tf-hero-track" aria-label="Diaporama de lives"></div>

  <div class="tf-hero-title" style="margin-top:14px">
    <h4>VOD du streamer sélectionné <span class="help" data-help="Vidéos récentes (archives) du streamer du live choisi. Clique pour ouvrir la VOD dans un onglet.">?</span></h4>
  </div>
  <div class="tf-carousel" id="tf-vod-carousel" aria-label="VOD"></div>
</div>


<div class="tf-grid" id="twitflix-grid">
<div class="text-center w-full text-gray-500 py-20" id="tf-loading">
<i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...
        </div>
</div>
</div>
</div></div>
<script>
    const API_BASE = window.location.origin;
    const __urlParams = new URLSearchParams(window.location.search);
    const TWITCH_PARENT = __urlParams.get('parent') || window.location.hostname;
    const PARENT_DOMAINS = ['localhost','127.0.0.1',window.location.hostname,'justplayer.fr','www.justplayer.fr'];

    // --- SFX (Base64 short sounds) ---
    // Son "Open/Whoosh" court
    const sfxOpen = new Audio("data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 
    // (J'ai mis un placeholder vide pour la taille du code, en vrai je vais générer un son synthétique simple via WebAudio ou un vrai Base64 si tu veux, mais pour l'instant simulons par log ou un beep simple)
    // Pour que ça marche vraiment sans fichier externe, voici des sons très courts encodés:
    
    // Son "Futuristic Click"
    const sfxClick = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 

    // Fonction de lecture sécurisée
    function playSound(type) {
        // En prod, remplacez les src ci-dessus par de vrais fichiers mp3/wav
        // ou des base64 valides. Ici c'est pour l'exemple structurel.
        // ex: if(type==='open') sfxOpen.play().catch(()=>{});
        // ex: if(type==='click') sfxClick.play().catch(()=>{});
        console.log("🔊 Audio:", type);
    }

    let socket;
    let currentChannel = 'twitch';
    let currentUser = null;
    let charts = {};
    let raidTarget = null;

    let currentChannelId = null;
    let currentGameId = null;
    let currentGameName = null;

    // TwitFlix infinite scroll
    let currentCursor = null;
    let isLoadingGames = false;

    // INIT
    window.addEventListener('load', async () => {
      initUnderTabs();
      await checkAuth();
      initPlayer();
      loadStatsDashboard();
      initCarouselScroll();
      initSocket();
      initFirebaseStatus();
      setInterval(loadStatsDashboard, 5 * 60 * 1000);
      
      // Infinite scroll listener
      const tfGrid = document.getElementById('twitflix-grid');
      if(tfGrid){
        tfGrid.addEventListener('scroll', () => {
             if (tfGrid.scrollTop + tfGrid.clientHeight >= tfGrid.scrollHeight - 200) {
                 loadMoreCategories();
             }
        });
      }
    });

    function initUnderTabs(){
      const nav = document.getElementById('under-tabs-nav');
      if (!nav) return;
      nav.querySelectorAll('.u-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ut');
                    if(id === 'bourse'){ setTimeout(()=>{ try{ refreshBoursePanel(); }catch(e){} }, 50); }
nav.querySelectorAll('.u-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#under-overview,#under-analytics,#under-niche').forEach(p=>p.classList.remove('active'));
          const panel = document.getElementById(`under-${id}`);
          if (panel) panel.classList.add('active');
        });
      });
    }

    // FIREBASE STATUS
    async function initFirebaseStatus() {
      async function checkStatus() {
        try {
          const response = await fetch(`${API_BASE}/firebase_status`);
          const data = await response.json();
          const statusEl = document.getElementById('socket-status');
          if (data.connected) {
            statusEl.innerText = 'HUB SECURE';
            statusEl.className = 'text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded connected';
          } else {
            statusEl.innerText = 'HUB DISCONNECTED';
            statusEl.className = 'text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded';
          }
        } catch (error) {
          console.error('Firebase status error:', error);
        }
      }
      checkStatus();
      setInterval(checkStatus, 5000);
    }

    // AUTH
    async function checkAuth() {
      const res = await fetch(`${API_BASE}/twitch_user_status`);
      const data = await res.json();
      if (data.is_connected) {
        currentUser = data.display_name;
        document.getElementById('hub-user-display').innerText = data.display_name;

        document.getElementById('btn-auth').classList.add('hidden');
        document.getElementById('user-area').classList.remove('hidden');

        document.getElementById('user-name').innerText = data.display_name;
        if (data.profile_image_url) document.getElementById('user-avatar').src = data.profile_image_url;

        await loadFollowed();
      }
    }

    function startAuth() {
      window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=700');
      const check = setInterval(async () => {
        const res = await fetch(`${API_BASE}/twitch_user_status`);
        const data = await res.json();
        if (data.is_connected) { clearInterval(check); location.reload(); }
      }, 1000);
    }

    function logout() { fetch(`${API_BASE}/twitch_logout`, { method:'POST' }).then(()=>location.reload()); }

    // PLAYER
    async function initPlayer() {
      const res = await fetch(`${API_BASE}/get_default_stream`);
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('player-mode-badge').innerText = data.mode || 'AUTO';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    function loadPlayerEmbed(channel) {
      const container = document.getElementById('video-container');
      const parentParam = PARENT_DOMAINS.join('&parent=');
      const iframeUrl = `https://player.twitch.tv/?channel=${channel}&parent=${parentParam}&theme=dark`;
      container.innerHTML = `<iframe src="${iframeUrl}" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no" style="border:none;width:100%;height:100%;"></iframe>`;
      loadStreamInfo(channel);
    }

    function loadStreamInfo(channel) {
      fetch(`${API_BASE}/stream_info`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ channel })
      })
      .then(r=>r.json())
      .then(data=>{
        if (data.success && data.stream) {
          const title = data.stream.title || 'Sans titre';
          const viewers = data.stream.viewer_count || 0;

          const display = document.getElementById('current-channel-display');
          const titleText = title.length > 40 ? title.substring(0,40) + '...' : title;
          display.innerText = `${channel.toUpperCase()} • ${titleText}`;
          display.title = title;

          document.getElementById('viewer-count').innerText = `${viewers.toLocaleString()} viewers`;

          currentGameId = data.stream.game_id || null;
          currentGameName = data.stream.game_name || null;

          // 🔥 Pro data sous le live
          loadChannelProData(channel);
        } else {
          document.getElementById('viewer-count').innerText = `0 viewers`;
        }
      })
      .catch(e=>console.error('Stream info error:', e));
    }

    function updateTwitchChatFrame(channel){
      const parentParam = PARENT_DOMAINS.join('&parent=');
      // FORCE DARK THEME
      const url = `https://www.twitch.tv/embed/${channel}/chat?parent=${parentParam}&theme=dark&darkpopout`;
      const frame = document.getElementById('twitch-chat-frame');
      if (frame) frame.src = url;
    }

    async function cycle(dir){
      const res = await fetch(`${API_BASE}/cycle_stream`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ direction: dir })
      });
      const data = await res.json();
      if (data.success) {
        currentChannel = data.channel;
        document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
        document.getElementById('viewer-count').innerText = '-- viewers';
        loadPlayerEmbed(currentChannel);
        updateTwitchChatFrame(currentChannel);
      }
    }

    // CAROUSEL
    function initCarouselScroll(){
      const el = document.getElementById('carousel');
      if (!el) return;
      el.addEventListener('wheel',(evt)=>{ evt.preventDefault(); el.scrollLeft += evt.deltaY; }, { passive:false });
    }

    async function loadFollowed(){
      const el = document.getElementById('carousel');
      el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-[#00f2ea]"></i></div>';
      try{
        const res = await fetch(`${API_BASE}/followed_streams`);
        const data = await res.json();
        if (data.success && data.streams.length > 0){
          el.innerHTML = '';
          data.streams.forEach(s=>{
            const thumb = (s.thumbnail_url||'').replace('{width}','400').replace('{height}','225');
            el.innerHTML += `
              <div class="stream-card flex-shrink-0" onclick="changeChannel('${s.user_login}')">
                <img src="${thumb}" class="card-img" onerror="this.src='https://via.placeholder.com/400x225'">
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">
                  <div class="font-bold text-white text-sm truncate">${s.user_name}</div>
                </div>
                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div>
              </div>`;
          });
        } else {
          el.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Aucune chaîne suivie en live.</div>';
        }
      }catch(e){
        console.error('Carousel error:', e);
        el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur</div>';
      }
    }

    function changeChannel(channel){
      currentChannel = channel;
      document.getElementById('current-channel-display').innerText = channel.toUpperCase();
      document.getElementById('viewer-count').innerText = '-- viewers';
      loadPlayerEmbed(channel);
      updateTwitchChatFrame(channel);
    }

    // RIGHT TABS
    function openTab(e, id){
      document.querySelectorAll('#tab-chat,#tab-stats,#tab-tools').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab-nav .tab-btn').forEach(el=>el.classList.remove('active'));
      document.getElementById(`tab-${id}`).classList.add('active');
      if (e?.currentTarget) e.currentTarget.classList.add('active');
    }

    function toggleChatMode(mode){
      const twitch = document.getElementById('chat-container-twitch');
      const hub = document.getElementById('chat-container-hub');
      const btnTw = document.getElementById('btn-mode-twitch');
      const btnHb = document.getElementById('btn-mode-hub');

      if (mode === 'hub'){
        twitch.classList.add('hidden');
        hub.classList.remove('hidden'); hub.classList.add('flex');
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded';
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      } else {
        hub.classList.add('hidden'); hub.classList.remove('flex');
        twitch.classList.remove('hidden');
        const frame = document.getElementById('twitch-chat-frame');
        if(frame && (!frame.src || frame.src === '')){ try{ updateTwitchChatFrame(currentChannel || 'twitch'); }catch(_){} }
        btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded';
        btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
      }
    }

    // SOCKET.IO
    function initSocket(){
      if (window.__hubSocketInited) return;
      window.__hubSocketInited = true;

      try{
        socket = io(undefined, { transports: ['websocket','polling'] });

        const status = document.getElementById('socket-status');
        const setStatus = (ok) => {
          if (!status) return;
          status.textContent = ok ? 'HUB CONNECTÉ' : 'HUB DÉCONNECTÉ';
          status.className = ok
            ? 'text-xs font-bold px-2 py-1 rounded bg-[#00f2ea] text-black'
            : 'text-xs font-bold px-2 py-1 rounded bg-red-600 text-white';
        };

        setStatus(false);
        socket.on('connect', () => setStatus(true));
        socket.on('disconnect', () => setStatus(false));
        socket.on('connect_error', () => setStatus(false));

        // Anti-doublon (évite le double affichage quand le serveur renvoie la même chose via 2 events)
        const seen = new Set();

        // Helpers: émettre "nouvelle" ET "ancienne" API (compat)
        window.emitHubMessage = (payload) => {
          if (!socket) return;
          socket.emit('chat message', payload);
          socket.emit('hub:message', payload); // compat si backend ancien
        };
        window.emitHubReact = (payload) => {
          if (!socket) return;
          socket.emit('chat react', payload);
          socket.emit('hub:react', payload); // compat si backend ancien
        };

        const box = document.getElementById('hub-messages');

        const replaceAllMessages = (msgs) => {
          if (!box) return;
          box.innerHTML = '';
          (msgs || []).forEach(m => {
            if (m && m.id) seen.add(m.id);
            renderHubMessage(m);
          });
          box.scrollTop = box.scrollHeight;
        };

        // === API actuelle (app.js): historique + messages + updates réactions
        socket.on('chat history', (msgs) => {
          try { replaceAllMessages(msgs); } catch(_){}
        });

        socket.on('chat message', (msg) => {
          try{
            if (!msg || !msg.id) return;
            if (seen.has(msg.id)) return;
            seen.add(msg.id);
            if (seen.size > 1200) {
              const arr = Array.from(seen);
              for (let i=0;i<400;i++) seen.delete(arr[i]);
            }
            renderHubMessage(msg);
          }catch(_){}
        });

        socket.on('chat update', ({ id, reactions }) => {
          try{
            const el = document.querySelector(`[data-msg-id="${cssEscape(id)}"] .hub-reactions`);
            if (!el) return;
            el.innerHTML = renderReactionsHtml(reactions || {});
          }catch(_){}
        });

        // === API legacy (si jamais): hub:init / hub:message / hub:react
        socket.on('hub:init', (data) => {
          try{
            const msgs = (data && data.messages) ? data.messages : [];
            replaceAllMessages(msgs);

            if (data && data.profile){
              window.__hubProfile = data.profile;
              renderHubProfile();
            }
          }catch(_){}
        });

        socket.on('hub:message', (msg) => {
          try{
            if (!msg || !msg.id) return;
            if (seen.has(msg.id)) return;
            seen.add(msg.id);
            renderHubMessage(msg);
          }catch(_){}
        });

        socket.on('hub:react', ({ messageId, reactions }) => {
          try{
            const el = document.querySelector(`[data-msg-id="${cssEscape(messageId)}"] .hub-reactions`);
            if (!el) return;
            el.innerHTML = renderReactionsHtml(reactions || {});
          }catch(_){}
        });

      }catch(e){
        console.error('Socket init error', e);
      }
    }

    function sendHubMessage(e){
      e.preventDefault();
      const input = document.getElementById('hub-input');
      const raw = (input?.value || '').trim();
      if (!raw) return;

      // /gif <url>
      let gif = '';
      let text = raw;
      const m = raw.match(/^\/gif\s+(https?:\/\/\S+)/i);
      if (m){
        gif = m[1];
        text = '';
      }

      if (window.emitHubMessage) window.emitHubMessage({ user: currentUser || 'Anon', text, gif });
      input.value = '';
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }
    // ================== HUB UI (persistant + emotes + gifs + réactions) ==================
    const EMOTE_MAP = {
      ':kappa:':'😏', ':pog:':'🤯', ':gg:':'🏆', ':love:':'💖',
      ':hype:':'🚀', ':rip:':'🪦', ':clap:':'👏', ':fire:':'🔥'
    };

    function parseEmotes(text){
      let out = String(text||'');
      Object.keys(EMOTE_MAP).forEach(k => {
        out = out.split(k).join(EMOTE_MAP[k]);
      });
      return out;
    }

    function cssEscape(s){
      return String(s||'').replace(/[^a-zA-Z0-9_-]/g, '_');
    }

    function renderHubProfile(){
      // Optionnel : affiche grade / XP dans le header si tu as des éléments dédiés
      // On garde simple pour ne pas casser ton layout
    }

    function renderReactionsHtml(reactions){
      const entries = Object.entries(reactions||{}).sort((a,b)=>b[1]-a[1]);
      return entries.map(([emo,count]) => `<span class="hub-react-pill">${escapeHtml(emo)} <span class="text-gray-400">${count}</span></span>`).join('');
    }

    function renderHubMessage(msg){
      const box = document.getElementById('hub-messages');
      if (!box) return;

      const id = msg.id || (Date.now()+'-'+Math.random().toString(36).slice(2));
      const user = escapeHtml(msg.user || 'Anon');
      const grade = msg.grade?.label || msg.grade?.key || '';
      const badgeColor = msg.grade?.color || '#9ca3af';
      const text = msg.text ? escapeHtml(parseEmotes(msg.text)) : '';
      const gif = msg.gif ? String(msg.gif) : '';
      const ts = msg.ts ? new Date(msg.ts) : new Date();

      const el = document.createElement('div');
      el.className = 'hub-msg';
      el.setAttribute('data-msg-id', id);

      el.innerHTML = `
        <div class="flex items-center gap-2">
          <strong class="text-[#00f2ea]">${user}</strong>
          ${grade ? `<span class="hub-badge" style="border-color:${badgeColor}; color:${badgeColor};">${escapeHtml(grade)}</span>` : ``}
          <span class="text-[10px] text-gray-600 ml-auto">${ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
        ${text ? `<div class="text-gray-200 mt-1">${text}</div>` : ``}
        ${gif ? `<img src="${escapeHtml(gif)}" class="hub-gif" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">` : ``}
        <div class="hub-reactions">${renderReactionsHtml(msg.reactions || {})}</div>
        <div class="hub-react-row flex gap-2 mt-2">
          <button type="button" class="hub-react-btn" data-react="🔥" data-msg="${id}">🔥</button>
          <button type="button" class="hub-react-btn" data-react="😂" data-msg="${id}">😂</button>
          <button type="button" class="hub-react-btn" data-react="💖" data-msg="${id}">💖</button>
          <button type="button" class="hub-react-btn" data-react="👍" data-msg="${id}">👍</button>
        </div>
      `;

      const nearBottom = (box.scrollHeight - box.scrollTop - box.clientHeight) < 120;
      box.appendChild(el);
      if (nearBottom) box.scrollTop = box.scrollHeight;
    }

    function reactToMsg(messageId, emoji){
      // Envoie réaction (id exact du message)
      if (window.emitHubReact) window.emitHubReact({ messageId, emoji });
    }


    function insertAtCursor(input, text){
      const start = input.selectionStart || 0;
      const end = input.selectionEnd || 0;
      const val = input.value || '';
      input.value = val.slice(0,start) + text + val.slice(end);
      input.focus();
      const pos = start + text.length;
      input.setSelectionRange(pos,pos);
    }

    async function openGifModal(){
      const modal = document.getElementById('hub-gif-modal');
      const grid = document.getElementById('hub-gif-grid');
      const search = document.getElementById('hub-gif-search');
      if (!modal || !grid || !search) return;

      modal.classList.remove('hidden');
      grid.innerHTML = `<div class="col-span-full text-gray-400 text-sm">Chargement...</div>`;

      async function loadTrending(){
        const r = await fetch(`${API_BASE}/api/gifs/trending?limit=28`);
        const j = await r.json();
        if (!j.success) {
          grid.innerHTML = `<div class="col-span-full text-red-400 text-sm">GIF indisponibles (ajoute GIPHY_API_KEY côté serveur).</div>`;
          return;
        }
        renderGifGrid(j.gifs || []);
      }

      function renderGifGrid(items){
        grid.innerHTML = '';
        items.forEach(g => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'rounded-xl overflow-hidden border border-[#222] hover:border-[#00f2ea] bg-black';
          b.innerHTML = `<img src="${escapeHtml(g.url)}" class="w-full h-auto block" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">`;
          b.onclick = () => {
            if (socket) if (window.emitHubMessage) window.emitHubMessage({ user: currentUser || 'Anon', text:'', gif: g.url });
            modal.classList.add('hidden');
          };
          grid.appendChild(b);
        });
      }

      let t = null;
      search.oninput = () => {
        clearTimeout(t);
        const q = (search.value || '').trim();
        t = setTimeout(async () => {
          if (!q) return loadTrending();
          grid.innerHTML = `<div class="col-span-full text-gray-400 text-sm">Recherche...</div>`;
          const r = await fetch(`${API_BASE}/api/gifs/search?q=${encodeURIComponent(q)}&limit=28`);
          const j = await r.json();
          if (!j.success) {
            grid.innerHTML = `<div class="col-span-full text-red-400 text-sm">GIF indisponibles.</div>`;
            return;
          }
          renderGifGrid(j.gifs || []);
        }, 220);
      };

      await loadTrending();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const emojiBtn = document.getElementById('hub-emoji-btn');
      const emojiPanel = document.getElementById('hub-emoji-panel');
      const gifBtn = document.getElementById('hub-gif-btn');
      const gifClose = document.getElementById('hub-gif-close');
      const gifModal = document.getElementById('hub-gif-modal');
      const input = document.getElementById('hub-input');

      if (emojiBtn && emojiPanel){
        emojiBtn.onclick = () => emojiPanel.classList.toggle('hidden');
        emojiPanel.querySelectorAll('.hub-emo').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!input) return;
            insertAtCursor(input, btn.textContent + ' ');
            emojiPanel.classList.add('hidden');
          });
        });
        document.addEventListener('click', (e) => {
          if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) emojiPanel.classList.add('hidden');
        });
      }

      if (gifBtn){
        gifBtn.onclick = openGifModal;
      }
      if (gifClose && gifModal){
        gifClose.onclick = () => gifModal.classList.add('hidden');
      }
      if (gifModal){
        gifModal.addEventListener('click', (e) => {
          if (e.target === gifModal) gifModal.classList.add('hidden');
        });
      }
    });


    // TWITFLIX — Netflix-like catalogue (only). Does NOT touch the rest of the app.
    // Requires:
    //  - GET  /api/categories/top?cursor=...
    //  - (optional) GET /api/categories/search?q=...
    //  - POST /api/stream/by_category { game_id } -> { channel }

    let tfModalOpen = false;
    let tfViewMode = 'rows'; // rows | az
    let tfAllCategories = [];

    // ====== TWITFLIX HERO (Twitch-like) + VOD ======
    async function tfFetchTopStreams(){
      try{
        const res = await fetch(`${API_BASE}/api/streams/top?first=18&language=fr`, { credentials: 'include' });
        const data = await res.json();
        if (data && data.success && Array.isArray(data.streams)) return data.streams;
      }catch(e){}
      return [];
    }

    function tfThumb(url, w=640, h=360){
      if (!url) return '';
      return String(url).replace('{width}', String(w)).replace('{height}', String(h));
    }

    function tfMakeEmbed(channel){
      const parent = location.hostname;
      return `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&muted=true&parent=${encodeURIComponent(parent)}`;
    }

    function tfBindHeroWheel(el){
      if (!el || el.__wheelBound) return;
      el.__wheelBound = true;
      el.addEventListener('wheel', (e) => {
        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
          el.scrollLeft += e.deltaY;
          e.preventDefault();
        }
      }, { passive:false });
    }

    function tfAttachPreview(container, channel){
      if (!container || container.__hasPreview) return;
      container.__hasPreview = true;
      const prev = container.querySelector('.preview');
      if (!prev) return;

      container.addEventListener('mouseenter', () => {
        if (container.__previewing) return;
        container.__previewing = true;
        container.classList.add('is-previewing');
        prev.innerHTML = `<iframe src="${tfMakeEmbed(channel)}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
      });

      container.addEventListener('mouseleave', () => {
        container.__previewing = false;
        container.classList.remove('is-previewing');
        prev.innerHTML = '';
      });
    }

    function tfPlayLiveFromTwiflix(stream){
      try{ closeTwitFlix(); }catch(_){}
      if (!stream || !stream.user_login) return;
      try { changeChannel(stream.user_login); } catch(_){}
      tfLoadVods(stream.user_login, stream.user_name);
    }

    async function tfLoadVods(login, displayName){
      const wrap = document.getElementById('tf-vod-carousel');
      if (!wrap) return;
      tfBindHorizontalWheel(wrap);

      wrap.innerHTML = `<div class="tf-empty" style="padding:12px 2px;opacity:.75">Chargement des VOD de ${displayName || login}…</div>`;
      try{
        const res = await fetch(`${API_BASE}/api/videos/by_user?login=${encodeURIComponent(login)}&first=10`, { credentials:'include' });
        const data = await res.json();
        const vids = (data && data.success && Array.isArray(data.videos)) ? data.videos : [];
        wrap.innerHTML = '';
        if (!vids.length){
          wrap.innerHTML = `<div class="tf-empty" style="padding:12px 2px;opacity:.75">Aucune VOD publique trouvée.</div>`;
          return;
        }
        vids.forEach(v => {
          const card = document.createElement('div');
          card.className = 'tf-vod-card';
          const thumb = (v.thumbnail_url || '').replace('%{width}', '640').replace('%{height}', '360');
          card.innerHTML = `
            <div class="thumb" style="background-image:url('${thumb}')"></div>
            <div class="meta">
              <div class="m1">${(v.title||'VOD').replace(/</g,'&lt;')}</div>
              <div class="m2">${(v.created_at||'').slice(0,10)} · ${v.view_count||0} vues</div>
            </div>
          `;
          card.addEventListener('click', () => {
            if (v.url) window.open(v.url, '_blank', 'noopener');
          });
          wrap.appendChild(card);
        });
      }catch(e){
        wrap.innerHTML = `<div class="tf-empty" style="padding:12px 2px;opacity:.75">Erreur chargement VOD.</div>`;
      }
    }

    async function tfRenderHeroSlides(){
      const track = document.getElementById('tf-hero-track');
      if (!track) return;

      tfBindHeroWheel(track);

      track.innerHTML = `<div class="tf-empty" style="padding:12px 2px;opacity:.75">Chargement des lives en cours…</div>`;
      const streams = await tfFetchTopStreams();
      track.innerHTML = '';

      if (!streams.length){
        track.innerHTML = `<div class="tf-empty" style="padding:12px 2px;opacity:.75">Aucun live trouvé.</div>`;
        return;
      }

      // Create slides: 1 main + 2 side per slide (like Twitch)
      const perSlide = 3;
      for (let i=0;i<streams.length;i+=perSlide){
        const s1 = streams[i];
        const s2 = streams[i+1];
        const s3 = streams[i+2];

        const slide = document.createElement('div');
        slide.className = 'tf-hero-slide';

        // main
        const main = document.createElement('div');
        main.className = 'tf-hero-main';
        main.innerHTML = `
          <div class="thumb" style="background-image:url('${tfThumb(s1.thumbnail_url, 1280, 720)}')"></div>
          <div class="preview"></div>
          <div class="overlay"></div>
          <div class="meta">
            <div class="top">
              <div class="badge">LIVE · ${s1.viewer_count || 0} viewers</div>
              <div class="badge" style="opacity:.85">${(s1.game_name||'').slice(0,24)}</div>
            </div>
            <div class="title">${(s1.user_name||s1.user_login||'').replace(/</g,'&lt;')}</div>
            <div class="sub">${(s1.title||'').replace(/</g,'&lt;')}</div>
          </div>
        `;
        tfAttachPreview(main, s1.user_login);
        main.addEventListener('click', () => tfPlayLiveFromTwiflix(s1));

        const side = document.createElement('div');
        side.className = 'tf-hero-side';

        function makeSideCard(s){
          const c = document.createElement('div');
          c.className = 'tf-side-card';
          c.innerHTML = `
            <div class="thumb" style="background-image:url('${tfThumb(s.thumbnail_url, 640, 360)}')"></div>
            <div class="overlay"></div>
            <div class="meta">
              <div class="t1">${(s.user_name||s.user_login||'').replace(/</g,'&lt;')} · ${s.viewer_count||0}</div>
              <div class="t2">${(s.title||'').replace(/</g,'&lt;')}</div>
            </div>
          `;
          c.addEventListener('click', () => tfPlayLiveFromTwiflix(s));
          return c;
        }

        if (s2) side.appendChild(makeSideCard(s2));
        if (s3) side.appendChild(makeSideCard(s3));

        slide.appendChild(main);
        slide.appendChild(side);
        track.appendChild(slide);
      }

      // Load VOD for first live by default
      tfLoadVods(streams[0].user_login, streams[0].user_name);
    }


    
    let tfCursor = null;
    let tfLoading = false;
    let tfHasMore = true;
    let tfLastLoadAt = 0;

    let tfSearchQuery = '';
    let tfSearchResults = [];
    let tfSearchTimer = null;

    let tfObserver = null;

    // Preview cache
    const tfPreviewCache = new Map(); // gameId -> {channel, t}
    const tfPreviewInflight = new Map();
    const TF_PREVIEW_TTL = 10 * 60 * 1000;

    function tfNormalizeBoxArt(url){
      // request higher res to avoid blur, then we downscale in CSS
      const u = String(url || '');
      if (!u) return '';
      return u.replace('{width}','600').replace('{height}','800');
    }

    function setTwitFlixView(mode){
      tfViewMode = (mode === 'az') ? 'az' : 'rows';
      const bRows = document.getElementById('tf-btn-rows');
      const bAz = document.getElementById('tf-btn-az');
      if (bRows && bAz){
        bRows.classList.toggle('active', tfViewMode === 'rows');
        bAz.classList.toggle('active', tfViewMode === 'az');
      }
      renderTwitFlix();
    }

    async function openTwitFlix(){
  document.body.classList.add('modal-open');
const modal = document.getElementById('twitflix-modal');
      const host = document.getElementById('twitflix-grid');
      const search = document.getElementById('twitflix-search');

      tfModalOpen = true;
      modal.classList.add('active');

      // reset
      tfViewMode = 'rows';
      tfAllCategories = [];
      tfCursor = null;
      tfLoading = false;
      tfHasMore = true;
      tfSearchQuery = '';
      tfSearchResults = [];
      if (search) search.value = '';

      // hero default
      tfSetHero({ title: 'TWITFLIX', sub: 'Découvre des jeux, survole pour une preview, clique pour lancer un stream.' });

      // empty ui
      if (host){
        host.innerHTML = '<div id="tf-loading" class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...</div>';
      }

      setTwitFlixView('rows');

      // search handler (server if possible, fallback local)
      if (search){
        search.oninput = (e) => {
          const v = String(e.target.value || '').trim();
          tfSearchQuery = v;

          if (tfSearchTimer) clearTimeout(tfSearchTimer);
          tfSearchTimer = setTimeout(async () => {
            await tfRunSearch(v);
          }, 180);
        };
      }

      // sentinel observer for infinite loading
      tfSetupObserver();

      // warm load (2 pages)
      await tfLoadMore(true);
      await tfLoadMore(true);
      tfRenderLiveCarousel();
            tfRenderHeroSlides();
      renderTwitFlix();
    }

    function closeTwitFlix(){
  document.body.classList.remove('modal-open');
tfModalOpen = false;
      document.querySelectorAll('.tf-card.previewing').forEach(tfStopPreview);
      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
        tfObserver = null;
      }
      const modal = document.getElementById('twitflix-modal');
      modal.classList.remove('active');
    }

    function tfSetupObserver(){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      let sentinel = document.getElementById('tf-sentinel');
      if (!sentinel){
        sentinel = document.createElement('div');
        sentinel.id = 'tf-sentinel';
        sentinel.style.height = '1px';
        host.appendChild(sentinel);
      }

      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
      }

      tfObserver = new IntersectionObserver(async (entries) => {
        if (!tfModalOpen) return;
        if (tfSearchQuery) return; // no infinite scroll while searching
        if (!tfHasMore) return;
        const entry = entries && entries[0];
        if (entry && entry.isIntersecting){
          await tfLoadMore(false);
          renderTwitFlix();
        }
      }, { root: host, threshold: 0.1 });

      tfObserver.observe(sentinel);
    }

    async function tfRunSearch(query){
      const q = String(query || '').trim();
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      if (!q){
        tfSearchResults = [];
        renderTwitFlix();
        return;
      }

      // Try server search (best)
      try{
        const r = await fetch(`${API_BASE}/api/categories/search?q=${encodeURIComponent(q)}`);
        if (r.ok){
          const d = await r.json();
          if (d && d.success && Array.isArray(d.categories)){
            tfSearchResults = d.categories.map(c => ({
              id: c.id,
              name: c.name,
              box_art_url: tfNormalizeBoxArt(c.box_art_url || c.boxArtUrl || '')
            }));
            renderTwitFlix();
            return;
          }
        }
      }catch(_){}

      // Fallback: local filter on already loaded catalogue
      const low = q.toLowerCase();
      tfSearchResults = tfAllCategories
        .filter(c => (c.name||'').toLowerCase().includes(low))
        .slice(0, 120);
      renderTwitFlix();
    }

    async function tfLoadMore(force){
      if (!tfModalOpen) return;
      if (tfLoading) return;
      if (!tfHasMore) return;

      const now = Date.now();
      if (!force && (now - tfLastLoadAt) < 650) return; // throttle
      tfLastLoadAt = now;

      tfLoading = true;

      try{
        let url = `${API_BASE}/api/categories/top`;
        if (tfCursor) url += `?cursor=${encodeURIComponent(tfCursor)}`;

        const res = await fetch(url);
        const data = await res.json();

        const loader = document.getElementById('tf-loading');
        if (loader) loader.remove();

        if (data && data.success && Array.isArray(data.categories)){
          tfCursor = data.cursor || null;

          // If no cursor returned => end
          if (!tfCursor) tfHasMore = false;

          for (const cat of data.categories){
            if (!cat || !cat.id) continue;
            // prevent duplicates
            if (tfAllCategories.find(x => x.id === cat.id)) continue;
            tfAllCategories.push({
              id: cat.id,
              name: cat.name,
              box_art_url: tfNormalizeBoxArt(cat.box_art_url || '')
            });
          }
        } else {
          // stop to avoid looping “in the void”
          tfHasMore = false;
          tfRenderError('Erreur chargement du catalogue.');
        }
      } catch (e){
        tfHasMore = false;
        tfRenderError('Erreur réseau TwitFlix.');
      } finally {
        tfLoading = false;
      }
    }

    function tfRenderError(msg){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;
      host.innerHTML = `
        <div class="tf-empty" style="color:#ff8080;">
          ${escapeHtml(msg || 'Erreur')}
          <div><button class="tf-retry" type="button" onclick="tfRetryLoad()">Réessayer</button></div>
        </div>
      `;
    }

    async function tfRetryLoad(){
      tfHasMore = true;
      await tfLoadMore(true);
      await tfLoadMore(true);
      tfRenderLiveCarousel();
                    renderTwitFlix();
      tfSetupObserver();
    }

    function renderTwitFlix(){
      const host = document.getElementById('twitflix-grid');
      if (!host) return;

      // Keep sentinel at bottom
      const sentinel = document.getElementById('tf-sentinel');

      // SEARCH MODE
      if (tfSearchQuery && tfSearchQuery.trim()){
        host.innerHTML = '';
        const q = tfSearchQuery.trim();
        tfSetHero({ title: q, sub: 'Résultats de recherche' });

        if (!tfSearchResults.length){
          host.innerHTML = `<div class="tf-empty">Aucun résultat pour <span style="color:#00f2ea;font-weight:900;">${escapeHtml(q)}</span>.</div>`;
          if (sentinel) host.appendChild(sentinel);
          return;
        }

        const grid = document.createElement('div');
        grid.className = 'tf-search-grid';
        tfSearchResults.forEach(cat => grid.appendChild(tfBuildCard(cat)));
        host.appendChild(grid);
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      // CATALOG MODE
      host.innerHTML = '';
      tfSetHero({ title: 'TWITFLIX', sub: 'Survole un jeu pour la preview, clique pour lancer un stream.' });

      const list = tfAllCategories.slice(0);
      if (!list.length){
        host.innerHTML = '<div class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      if (tfViewMode === 'az'){
        tfRenderAZ(host, list);
      } else {
        tfRenderRows(host, list);
      }

      if (!tfHasMore){
        const end = document.createElement('div');
        end.className = 'tf-end';
        end.innerHTML = 'Fin du catalogue.';
        host.appendChild(end);
      } else if (tfLoading){
        const loading = document.createElement('div');
        loading.className = 'tf-empty';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
        host.appendChild(loading);
      }

      if (sentinel) host.appendChild(sentinel);
    }

    function tfRenderRows(host, list){
      const picks1 = list.slice(0, 28);
      const picks2 = list.slice(28, 56);
      const picks3 = tfShuffle(list).slice(0, 28);
      const picks4 = tfShuffle(list).slice(28, 56);

      host.appendChild(tfBuildRow('Top du moment <span>(Twitch)</span>', picks1));
      host.appendChild(tfBuildRow('Tendances <span>FR</span>', picks2));
      host.appendChild(tfBuildRow('Découverte <span>(aléatoire)</span>', picks3));
      host.appendChild(tfBuildRow('À essayer <span>ce soir</span>', picks4));
    }

    function tfRenderAZ(host, list){
      // group
      const groups = {};
      for (const c of list){
        const n = (c.name || '').trim();
        if (!n) continue;
        const first = n[0].toUpperCase();
        const key = /[A-Z]/.test(first) ? first : (/[0-9]/.test(first) ? '0-9' : '#');
        (groups[key] ||= []).push(c);
      }
      const keys = Object.keys(groups).sort((a,b)=>{
        if (a==='0-9') return -1;
        if (b==='0-9') return 1;
        if (a==='#') return 1;
        if (b==='#') return -1;
        return a.localeCompare(b);
      });

      const bar = document.createElement('div');
      bar.className = 'tf-azbar';
      bar.innerHTML = keys.map(k => `<a class="tf-azlink" href="#tf-${k.replace(/[^a-z0-9]/ig,'_')}">${k}</a>`).join('');
      host.appendChild(bar);

      keys.forEach(k => {
        groups[k].sort((x,y)=> (x.name||'').localeCompare(y.name||''));
        const row = tfBuildRow(`<span>${k}</span>`, groups[k], `tf-${k.replace(/[^a-z0-9]/ig,'_')}`);
        host.appendChild(row);
      });
    }

    function tfBuildRow(titleHtml, items, id){
      const row = document.createElement('div');
      row.className = 'tf-row';
      if (id) row.id = id;

      const title = document.createElement('div');
      title.className = 'tf-row-title';
      title.innerHTML = titleHtml;

      const track = document.createElement('div');
      track.className = 'tf-row-track';

      (items || []).forEach(cat => track.appendChild(tfBuildCard(cat)));

      row.appendChild(title);
      row.appendChild(track);
      return row;
    }

    function tfBuildCard(cat){
      const div = document.createElement('div');
      div.className = 'tf-card';
      div.dataset.gameId = cat.id;
      div.dataset.gameName = cat.name;

      const poster = tfNormalizeBoxArt(cat.box_art_url || '');

      div.innerHTML = `
        <img class="tf-poster" src="${poster}" loading="lazy" alt="">
        <div class="tf-preview" aria-hidden="true"></div>
        <div class="tf-overlay">
          <div class="tf-name" title="${escapeHtml(cat.name)}">${escapeHtml(cat.name)}</div>
          <div class="tf-actions-row">
            <span class="tf-pill"><i class="fas fa-play"></i> Lire</span>
            <span class="tf-pill ghost"><i class="fas fa-volume-mute"></i> Preview</span>
          </div>
        </div>
      `;

      // hero update on hover/focus
      div.addEventListener('mouseenter', () => tfSetHero({ title: cat.name, poster }));
      div.addEventListener('focus', () => tfSetHero({ title: cat.name, poster }));

      // click play
      div.onclick = () => playTwitFlixCategory(cat.id, cat.name);

      // Hover preview (Netflix-like delay)
      let t = null;
      div.addEventListener('mouseenter', () => { t = setTimeout(() => tfStartPreview(div), 420); });
      div.addEventListener('mouseleave', () => { if (t) clearTimeout(t); tfStopPreview(div); });

      return div;
    }

    function tfSetHero({ title, sub, poster }){
      const bg = document.getElementById('tf-hero-bg');
      const t = document.getElementById('tf-hero-title');
      const s = document.getElementById('tf-hero-sub');
      if (t) t.textContent = String(title || 'TWITFLIX');
      if (s) s.textContent = String(sub || '');
      if (bg){
        if (poster) { bg.src = poster; bg.style.opacity = '.55'; }
        else { bg.removeAttribute('src'); bg.style.opacity = '.15'; }
      }
    }

    async function tfStartPreview(cardEl){
      try{
        if (!cardEl || cardEl.classList.contains('previewing')) return;
        const gameId = String(cardEl.dataset.gameId || '');
        if (!gameId) return;

        const host = cardEl.querySelector('.tf-preview');
        if (!host) return;

        const channel = await tfGetPreviewChannel(gameId);
        if (!channel) return;

        const parent = encodeURIComponent(TWITCH_PARENT || window.location.hostname);
        const src = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=true&autoplay=true`;

        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.allow = 'autoplay; fullscreen';
        iframe.frameBorder = '0';

        host.innerHTML = '';
        host.appendChild(iframe);
        cardEl.classList.add('previewing');
      }catch(_){}
    }

    function tfStopPreview(cardEl){
      try{
        if (!cardEl) return;
        const host = cardEl.querySelector('.tf-preview');
        if (host) host.innerHTML = '';
        cardEl.classList.remove('previewing');
      }catch(_){}
    }

    async function tfGetPreviewChannel(gameId){
      const now = Date.now();
      const cached = tfPreviewCache.get(gameId);
      if (cached && (now - cached.t) < TF_PREVIEW_TTL) return cached.channel;

      if (tfPreviewInflight.has(gameId)) return tfPreviewInflight.get(gameId);

      const p = (async () => {
        try{
          const res = await fetch(`${API_BASE}/api/stream/by_category`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ game_id: gameId })
          });
          const data = await res.json();
          const channel = data && data.success ? data.channel : null;
          if (channel) tfPreviewCache.set(gameId,{ channel, t: Date.now() });
          return channel;
        }catch(_){
          return null;
        }finally{
          tfPreviewInflight.delete(gameId);
        }
      })();

      tfPreviewInflight.set(gameId, p);
      return p;
    }

    async function playTwitFlixCategory(gameId, gameName){
      closeTwitFlix();
      document.getElementById('current-channel-display').innerText = "TWITFLIX…";

      try{
        const res = await fetch(`${API_BASE}/api/stream/by_category`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game_id: gameId })
        });
        const data = await res.json();

        if (data && data.success && data.channel){
          changeChannel(data.channel);
          const badge = document.getElementById('player-mode-badge');
          if (badge) badge.innerText = "TWITFLIX";
        } else {
          alert("Aucun stream trouvé pour ce jeu.");
          document.getElementById('current-channel-display').innerText = "OFFLINE";
        }
      }catch(_){
        alert("Erreur lors de la recherche TwitFlix.");
      }
    }

    function tfShuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
// BEST TIME

    async function analyzeBestTime(){
      const gameInput = document.getElementById('best-time-game').value.trim();
      if (!gameInput) return alert('Veuillez entrer un nom de jeu');

      const btn = document.getElementById('analyze-schedule-btn');
      const loading = document.getElementById('best-time-loading');
      const results = document.getElementById('best-time-results');

      btn.disabled = true;
      loading.style.display = 'block';
      results.style.display = 'none';
      results.innerHTML = '';

      try{
        const response = await fetch(`${API_BASE}/analyze_schedule`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game: gameInput })
        });
        const data = await response.json();
        results.innerHTML = data.html_response || '<p style="color:#ff6666;">❌ Erreur</p>';
        results.style.display = 'block';
      }catch(e){
        results.innerHTML = '<p style="color:#ff6666;">❌ Erreur réseau</p>';
        results.style.display = 'block';
      }finally{
        btn.disabled = false;
        loading.style.display = 'none';
      }
    }

    // STATS DASH
    async function loadStatsDashboard(){
      try{
        const res = await fetch(`${API_BASE}/api/stats/global`);
        const data = await res.json();
        if (data.success){
          document.getElementById('kpi-viewers').innerText = Number(data.total_viewers||0).toLocaleString();
          document.getElementById('kpi-channels').innerText = data.total_channels;
          renderChart('chartViewers','line',data.history.live.labels,data.history.live.values,'Viewers');
        }

        const resGames = await fetch(`${API_BASE}/api/stats/top_games`);
        const dGames = await resGames.json();
        const labels = (dGames.games||[]).map(g=>g.name);
        const values = (dGames.games||[]).map((g,i)=>(i+1)*20);
        renderChart('chartGames','bar',labels.slice(0,5),values.slice(0,5),'Popularité');

        const resLang = await fetch(`${API_BASE}/api/stats/languages`);
        const dLang = await resLang.json();
        const lLabels = (dLang.languages||[]).map(l=>l.name);
        const lValues = (dLang.languages||[]).map(l=>l.percent);
        renderChart('chartLangs','doughnut',lLabels,lValues,'Part');
      }catch(e){ console.error('Stats error:', e); }
    }

    function renderChart(id,type,labels,data,label){
      const el = document.getElementById(id);
      if (!el) return;
      if (charts[id]) charts[id].destroy();

      charts[id] = new Chart(el.getContext('2d'),{
        type,
        data:{ labels, datasets:[{ label, data, borderWidth:1, fill:(type==='line'), tension:.35 }]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:(type==='doughnut'), position:'right', labels:{ color:'white', boxWidth:10 } } },
          scales:{
            x:{ display:(type!=='doughnut'), ticks:{ color:'#666' } },
            y:{ display:(type!=='doughnut'), grid:{ color:'#222' }, ticks:{ color:'#666' } }
          }
        }
      });
    }

    // ===== Sous le live (données backend) =====
    async function loadChannelProData(login){
      if (!login || login === 'twitch') return;

      try{
        const res = await fetch(`${API_BASE}/api/analytics/channel_by_login/${encodeURIComponent(login)}?days=30`);
        const data = await res.json();

        if (!data.success){
          document.getElementById('kpi-growth-label').innerText =
            data.message || data.error || "Pas assez de données (laisse tourner le cron).";
          return;
        }

        currentChannelId = data.channel_id || null;

        const k = data.kpis || {};
        const fmt = v => (v==null ? '--' : Number(v).toLocaleString());

        document.getElementById('kpi-avg').innerText = fmt(k.avg_viewers);
        document.getElementById('kpi-peak').innerText = fmt(k.peak_viewers);
        document.getElementById('kpi-growth').innerText = (k.growth_percent!=null ? `${k.growth_percent}%` : '--');
        document.getElementById('kpi-volatility').innerText = fmt(k.volatility);
        document.getElementById('kpi-hours').innerText = (k.hours_per_week_est!=null ? `${k.hours_per_week_est}h` : '--');
        document.getElementById('kpi-samples').innerText = fmt(k.days);

        const gs = k.growth_score;
        document.getElementById('kpi-growth-score').innerText = (gs!=null ? `${gs}/100` : '--');
        document.getElementById('kpi-growth-label').innerText =
          gs==null ? '--' :
          gs>=80 ? '🔥 En forte accélération' :
          gs>=60 ? '✅ Bonne dynamique' :
          gs>=40 ? '🟡 Stable (optimisable)' :
          '🔴 À relancer';

        if (data.series?.labels?.length){
          renderChart('chartChannelDaily','line',data.series.labels,data.series.values,'Viewers moyens/jour');
        }

        await loadAlerts(login);

        if (currentGameId){
          await loadGameHours(currentGameId);
        }
      }catch(e){
        console.error('loadChannelProData error:', e);
      }
    }

    async function loadAlerts(login){
      const box = document.getElementById('alerts-box');
      if (!box) return;
      box.innerHTML = '<div class="text-gray-500 text-xs"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';

      try{
        let r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
        let data = await r.json();

        if (!data.success || !data.items || data.items.length === 0){
          await fetch(`${API_BASE}/api/alerts/generate`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ login, days:30 })
          }).catch(()=>{});

          r = await fetch(`${API_BASE}/api/alerts/channel_by_login/${encodeURIComponent(login)}?limit=8`);
          data = await r.json();
        }

        if (!data.success || !data.items){
          box.innerHTML = '<div class="text-gray-500 text-xs">Aucune alerte.</div>';
          return;
        }

        box.innerHTML = '';
        data.items.forEach(a=>{
          box.innerHTML += `
            <div class="bg-[#0a0a0a] border border-[#222] rounded p-2 mb-2">
              <div class="flex items-center justify-between gap-2">
                <div class="text-xs font-bold text-white">${escapeHtml(a.title || 'Alerte')}</div>
                <div class="text-[10px] text-gray-500">${escapeHtml(a.day || '')}</div>
              </div>
              <div class="text-[11px] text-gray-300 mt-1 leading-snug">${escapeHtml(a.message || '')}</div>
            </div>`;
        });

      }catch(e){
        console.error('loadAlerts', e);
        box.innerHTML = '<div class="text-gray-500 text-xs">Erreur alertes.</div>';
      }
    }

    async function loadGameHours(gameId){
      try{
        const r = await fetch(`${API_BASE}/api/games/hours?game_id=${encodeURIComponent(gameId)}&days=7`);
        const data = await r.json();
        if (!data.success || !data.hours) return;

        const labels = data.hours.map(x => `${String(x.hour).padStart(2,'0')}h`);
        const values = data.hours.map(x => (x.discoverability_score || 0));
        renderChart('chartGameHours','line',labels,values,'Opportunité');

        const best = data.best || data.hours.slice().sort((a,b)=>(b.discoverability_score||0)-(a.discoverability_score||0))[0];
        document.getElementById('niche-sat').innerText = best?.saturation_score!=null ? `${best.saturation_score}/100` : '--';
        document.getElementById('niche-discover').innerText = best?.discoverability_score!=null ? `${best.discoverability_score}/100` : '--';
        document.getElementById('niche-position').innerText = best ? `${String(best.hour).padStart(2,'0')}h UTC` : '--';
        document.getElementById('niche-verdict').innerText = best?.discoverability_score>=70 ? '🔥 Très bon' : best?.discoverability_score>=45 ? '✅ OK' : '🟡 Risqué';
        document.getElementById('niche-details').innerText =
          best ? `Meilleure fenêtre détectée: ${String(best.hour).padStart(2,'0')}h UTC • viewers totaux observés: ${best.total_viewers || 0}` : '—';
      }catch(e){
        console.error('loadGameHours', e);
      }
    }

    async function loadAIReco(){
      if (!currentChannel || currentChannel === 'twitch') return;
      const box = document.getElementById('ai-reco-box');
      const btn = document.getElementById('btn-ai-reco');

      box.classList.add('hidden');
      box.innerHTML = '';
      btn.disabled = true;
      btn.innerHTML = '<span class="best-time-spinner"></span> Génération...';

      try{
        const res = await fetch(`${API_BASE}/api/ai/reco?login=${encodeURIComponent(currentChannel)}&days=30`);
        const data = await res.json();
        box.innerHTML = data.html_response || "<p style='color:#ff6666;'>❌ Pas de recommandation</p>";
        box.classList.remove('hidden');
      }catch(e){
        box.innerHTML = "<p style='color:#ff6666;'>❌ Erreur IA</p>";
        box.classList.remove('hidden');
      }finally{
        btn.disabled = false;
        btn.innerHTML = '⚡ Générer des recommandations';
      }
    }

    async function runSimulation(){
      const hours = parseInt(document.getElementById('sim-hours').value || '0',10);
      const out = document.getElementById('sim-result');
      if (!currentChannelId || !hours){ out.innerText = '—'; return; }

      out.innerText = '...';
      try{
        const res = await fetch(`${API_BASE}/api/simulate/growth?channel_id=${encodeURIComponent(currentChannelId)}&hours_per_week=${encodeURIComponent(hours)}&days=30`);
        const data = await res.json();
        if (!data.success){ out.innerText = data.message || 'Pas assez de data'; return; }
        const delta = data.target?.expected_change_percent ?? null;
        const expected = data.target?.expected_avg_viewers ?? null;
        out.innerText = (delta==null || expected==null)
          ? 'OK'
          : `${delta >= 0 ? '+' : ''}${delta}% • ~${expected} avg viewers`;
      }catch(e){
        out.innerText = 'Erreur';
      }
    }

    async function loadCoStreamer(){
      const out = document.getElementById('costream-out');
      const btn = document.getElementById('costream-btn');
      if (!out || !btn) return;

      btn.disabled = true;
      out.style.display = 'block';
      out.innerHTML = '<div class="text-gray-500 text-xs"><i class="fas fa-spinner fa-spin"></i> Analyse...</div>';

      try{
        const r = await fetch(`${API_BASE}/api/costream/best?login=${encodeURIComponent(currentChannel)}&days=14`);
        const data = await r.json();

        if (!data.success){
          out.innerHTML = `<p style="color:#ff6666;">❌ ${escapeHtml(data.message || 'Impossible')}</p>`;
          return;
        }

        const best = data.best;
        const list = data.candidates || [];

        out.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
            <img src="${best?.profile_image_url || ''}" onerror="this.style.display='none'" class="w-10 h-10 rounded-full border border-[#00f2ea]">
            <div class="min-w-0">
              <div class="text-white font-bold text-sm">${escapeHtml(best?.display_name || '—')} <span class="text-gray-500">@${escapeHtml(best?.login || '')}</span></div>
              <div class="text-[11px] text-gray-400">Score: <span class="text-[#00f2ea] font-bold">${best?.score ?? '--'}</span></div>
            </div>
            <a class="ml-auto text-[11px] bg-[#00f2ea] text-black px-2 py-1 rounded font-bold" target="_blank" href="https://twitch.tv/${best?.login || ''}">Voir</a>
          </div>
          <div class="text-[11px] text-gray-300">${escapeHtml(best?.why || '')}</div>
          ${list.length ? `
            <div class="mt-3 text-[11px] text-gray-400 font-bold uppercase">Autres options</div>
            <ul class="mt-1 text-[11px] text-gray-300 list-disc pl-5">
              ${list.slice(0,5).map(x=>`<li>${escapeHtml(x.display_name)} — score ${x.score}</li>`).join('')}
            </ul>` : '' }
        `;
      }catch(e){
        out.innerHTML = '<p style="color:#ff6666;">❌ Erreur réseau</p>';
      }finally{
        btn.disabled = false;
      }
    }

    // ====== SCAN / RAID / BOOST (réparés) ======
    async function runScan(){
      const q = document.getElementById('scan-query').value.trim();
      if (!q) return;

      const box = document.getElementById('scan-res');
      box.classList.remove('hidden');
      document.getElementById('scan-ai').innerHTML = `<span class="best-time-spinner"></span> Scan...`;

      try{
        const r = await fetch(`${API_BASE}/scan_target`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ query:q })
        });
        const data = await r.json();
        if (!data.success){
          document.getElementById('scan-ai').innerHTML = `<p style="color:#ff6666;">❌ Introuvable</p>`;
          return;
        }

        if (data.type === 'user'){
          const u = data.user_data;
          document.getElementById('scan-img').src = u.profile_image_url || '';
          document.getElementById('scan-name').innerText = `${u.display_name} (@${u.login})`;
          document.getElementById('scan-game').innerText = `${u.game_name || '—'} • ${u.is_live ? (u.viewer_count+' viewers') : 'offline'}`;

          // mini critique IA (optionnel)
          const ai = await fetch(`${API_BASE}/critique_ia`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ type:'niche', query: u.game_name || q })
          }).then(x=>x.json()).catch(()=>null);

          document.getElementById('scan-ai').innerHTML =
            `<p><strong>Titre:</strong> ${escapeHtml(u.title||'—')}</p>
             <p><strong>Tags:</strong> ${escapeHtml(u.tags||'—')}</p>
             <p><strong>Lang:</strong> ${escapeHtml(u.language||'—')}</p>
             <hr style="border-color:#222;margin:8px 0;">
             ${ai?.html_response || '<p class="text-gray-400">IA indisponible.</p>'}`;
        } else {
          const g = data.game_data;
          document.getElementById('scan-img').src = g.box_art_url || '';
          document.getElementById('scan-name').innerText = `${g.name}`;
          document.getElementById('scan-game').innerText = `Total viewers (snapshot): ${g.total_viewers||0}`;
          document.getElementById('scan-ai').innerHTML = `<p>Score niche estimé: <strong>${g.ai_calculated_niche_score}</strong></p>`;
        }
      }catch(e){
        document.getElementById('scan-ai').innerHTML = `<p style="color:#ff6666;">❌ Erreur</p>`;
      }
    }

    async function runRaid(){
      const game = document.getElementById('raid-game').value.trim();
      const max_viewers = parseInt(document.getElementById('raid-viewers').value||'100',10);
      if (!game) return;

      const box = document.getElementById('raid-res');
      box.classList.remove('hidden');
      document.getElementById('raid-info').innerHTML = `<span class="best-time-spinner"></span> Recherche...`;

      try{
        const r = await fetch(`${API_BASE}/start_raid`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ game, max_viewers })
        });
        const data = await r.json();
        if (!data.success || !data.target){
          document.getElementById('raid-info').innerHTML = `<p style="color:#ff6666;">❌ Aucun raid trouvé</p>`;
          return;
        }
        raidTarget = data.target;
        document.getElementById('raid-img').src = raidTarget.thumbnail_url || '';
        document.getElementById('raid-info').innerHTML =
          `<p><strong>${escapeHtml(raidTarget.name)}</strong> (@${escapeHtml(raidTarget.login)})</p>
           <p>${escapeHtml(raidTarget.game)} • ${raidTarget.viewers} viewers</p>`;
      }catch(e){
        document.getElementById('raid-info').innerHTML = `<p style="color:#ff6666;">❌ Erreur</p>`;
      }
    }

    function goToRaid(){
      if (raidTarget) window.open(`https://twitch.tv/${raidTarget.login}`, '_blank');
    }

    async function runBoost(){
      const channel = document.getElementById('boost-query').value.trim();
      const msg = document.getElementById('boost-msg');
      msg.innerText = '';
      if (!channel) return;

      msg.innerText = '...';
      try{
        const r = await fetch(`${API_BASE}/stream_boost`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ channel })
        });
        const data = await r.json();
        msg.innerText = data.success ? '✅ Boost activé (15 min)' : '❌ Boost refusé';
      }catch(e){
        msg.innerText = '❌ Erreur';
      }
      setTimeout(()=>{ msg.innerText=''; }, 4000);
    }
  
    // Messenger-style reactions: tap message to reveal on mobile
    document.addEventListener('click', (e) => {
      const msgEl = e.target.closest('.hub-msg');
      if(!msgEl) return;
      // if clicked on button, keep
      if(e.target.closest('.hub-react-btn')) return;
      msgEl.classList.toggle('is-tapped');
    });

</script>
<script>
(function(){
  // ===== Ambilight =====
  const ambi = document.createElement('div');
  ambi.id = 'ambilight';
  const wrap = document.getElementById('player-wrap') || document.getElementById('player-container') || document.querySelector('.player-wrap') || document.body;
  if(wrap && !document.getElementById('ambilight')){
    wrap.prepend(ambi);
  }
  function avgColorFromImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.referrerPolicy = 'no-referrer';
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const w = c.width = 64, h = c.height = 36;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0,0,w,h);
        const d = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0,n=0;
        for(let i=0;i<d.length;i+=16){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; }
        r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
        resolve(`rgb(${r},${g},${b})`);
      };
      img.onerror = ()=>resolve('rgba(0,242,234,.18)');
      img.src = url + (url.includes('?')?'&':'?') + 'rand=' + Date.now();
    });
  }
  async function updateAmbilight(channel){
    if(!channel) return;
    const color = await avgColorFromImage(`https://static-cdn.jtvnw.net/previews-ttv/live_user_${encodeURIComponent(channel)}-440x248.jpg`);
    const el = document.getElementById('ambilight');
    if(el) el.style.background = `radial-gradient(circle at 30% 25%, ${color}, rgba(0,0,0,0) 55%), radial-gradient(circle at 70% 70%, rgba(0,242,234,.18), rgba(0,0,0,0) 60%)`;
  }
  // Hook into existing channel change if present
  const _set = window.setChannel || window.setTwitchChannel || null;
  if(_set){
    const fnName = _set.name;
    const original = _set;
    window[fnName] = function(ch){
      const r = original.apply(this, arguments);
      updateAmbilight(ch);
      return r;
    };
  } else {
    // fallback: observe current channel variable if exists
    setInterval(()=>{ 
      const ch = window.currentChannel || window.selectedChannel; 
      if(ch && window.__lastAmbiCh !== ch){ window.__lastAmbiCh = ch; updateAmbilight(ch); }
    }, 1500);
  }

  // ===== Vibe Check (deterministic) =====
  function vibeFor(name){
    const s = String(name||'');
    let h=0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) >>> 0; }
    const r = h % 3;
    return r===0 ? 'vibe-chill' : r===1 ? 'vibe-hype' : 'vibe-toxic';
  }
  // apply vibe to any TwitFlix card that has data-game or title
  function applyVibes(){
    document.querySelectorAll('[data-tf-card]').forEach(card=>{
      if(card.dataset.vibeApplied) return;
      const name = card.getAttribute('data-name') || card.querySelector('.tf-name')?.textContent || '';
      card.classList.add(vibeFor(name));
      card.dataset.vibeApplied = '1';
    });
  }
  setInterval(applyVibes, 1200);

  // ===== Mosaic Mode (Squad) =====
  function ensureMosaicBtn(){
    if(document.getElementById('mosaic-btn')) return;
    const host = document.querySelector('#player-controls') || document.querySelector('.player-controls') || document.querySelector('#player-wrap') || null;
    if(!host) return;
    const btn = document.createElement('button');
    btn.id = 'mosaic-btn';
    btn.type = 'button';
    btn.textContent = '📺 Mosaic';
    btn.style.cssText = 'margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff; font-weight:900; font-size:12px; cursor:pointer;';
    host.appendChild(btn);

    btn.addEventListener('click', ()=>{
      const playerHost = document.getElementById('twitch-player') || document.getElementById('player') || document.querySelector('iframe[src*="player.twitch.tv"]')?.parentElement;
      if(!playerHost) return;
      const isOn = playerHost.dataset.mosaic === '1';
      if(isOn){
        // restore single
        const single = playerHost.dataset.singleHtml;
        if(single){ playerHost.innerHTML = single; }
        playerHost.dataset.mosaic = '0';
        return;
      }
      playerHost.dataset.singleHtml = playerHost.innerHTML;
      playerHost.dataset.mosaic = '1';
      const parent = new URLSearchParams(location.search).get('parent_host') || new URLSearchParams(location.search).get('parent') || location.hostname;
      const ch = window.currentChannel || window.selectedChannel || 'twitch';
      const tpl = (c)=>`https://player.twitch.tv/?channel=${encodeURIComponent(c)}&parent=${encodeURIComponent(parent)}&muted=true`;
      playerHost.innerHTML = `
        <div class="mosaic-grid">
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
          <iframe src="${tpl(ch)}" allowfullscreen></iframe>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <input id="mosaic-channels" placeholder="channels (ex: ninja,shroud,...)"
            style="flex:1; min-width:220px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
          <button id="mosaic-apply" style="padding:8px 10px; border-radius:10px; border:1px solid rgba(0,242,234,.35); background:#00f2ea; color:#000; font-weight:900; cursor:pointer;">Appliquer</button>
        </div>`;
      const applyBtn = playerHost.querySelector('#mosaic-apply');
      applyBtn?.addEventListener('click', ()=>{
        const raw = playerHost.querySelector('#mosaic-channels')?.value || '';
        const list = raw.split(',').map(x=>x.trim()).filter(Boolean).slice(0,4);
        while(list.length<4) list.push(ch);
        const ifr = playerHost.querySelectorAll('iframe');
        ifr.forEach((f,i)=> f.src = tpl(list[i]));
      });
    });
  }
  setInterval(ensureMosaicBtn, 1200);

  // ===== Fantasy League UI (simple modal) =====
  function ensureFantasy(){
    if(document.getElementById('fantasy-open')) return;
    const nav = document.querySelector('#left-menu') || document.querySelector('.left-menu') || document.querySelector('#sidebar') || null;
    if(!nav) return;
    const b = document.createElement('button');
    b.id = 'fantasy-open';
    b.textContent = '🏆 Fantasy';
    b.style.cssText = 'width:100%; margin-top:8px; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:#fff; font-weight:900; cursor:pointer;';
    nav.appendChild(b);

    const modal = document.createElement('div');
    modal.id = 'fantasy-modal';
    modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:9999;';
    modal.innerHTML = `
      <div style="width:min(920px,92vw); max-height:86vh; overflow:auto; background:#0b0b0d; border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:1000; letter-spacing:.12em; font-size:14px;">FANTASY LEAGUE</div>
          <div style="margin-left:auto;"></div>
          <button id="fantasy-close" style="padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#fff; cursor:pointer;">Fermer</button>
        </div>
        <div style="margin-top:10px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;">
          <div style="border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px;">
            <div style="font-weight:900; margin-bottom:8px;">Portefeuille</div>
            <div id="fantasy-summary" style="color:#cbd5e1; font-size:12px;">Chargement…</div>
            <div id="fantasy-holdings" style="margin-top:10px;"></div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <input id="fantasy-streamer" placeholder="streamer login (ex: ninja)" style="flex:1; min-width:220px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
              <input id="fantasy-amount" placeholder="montant (ex: 500)" type="number" style="width:160px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#fff;">
              <button id="fantasy-buy" style="padding:8px 10px; border-radius:12px; border:1px solid rgba(0,242,234,.35); background:#00f2ea; color:#000; font-weight:900; cursor:pointer;">Investir</button>
            </div>
            <div id="fantasy-msg" style="margin-top:8px; font-size:12px; color:#94a3b8;"></div>
          </div>
          <div style="border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px;">
            <div style="font-weight:900; margin-bottom:8px;">Top Hub</div>
            <div id="fantasy-leaderboard" style="font-size:12px; color:#cbd5e1;">Chargement…</div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);

    function getUser(){
      return (window.currentUser && window.currentUser.name) || localStorage.getItem('hubUser') || 'Anon';
    }
    async function loadProfile(){
      const user = getUser();
      const r = await fetch(`/api/fantasy/profile?user=${encodeURIComponent(user)}`);
      const j = await r.json();
      if(!j.success) throw new Error(j.error||'Erreur');
      const sum = document.getElementById('fantasy-summary');
      sum.textContent = `Utilisateur: ${j.user} • Cash: ${Math.round(j.cash)} • Net Worth: ${Math.round(j.netWorth)}`;
      const hold = document.getElementById('fantasy-holdings');
      if(!j.holdings.length){ hold.innerHTML = '<div style="color:#64748b;">Aucune position.</div>'; return; }
      hold.innerHTML = j.holdings.map(h=>`
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);">
          <div><strong>${h.login}</strong> <span style="color:#64748b;">(${h.shares} parts)</span></div>
          <div style="color:#a7f3d0;">${Math.round(h.value)}</div>
        </div>`).join('');
    }
    async function loadLeaderboard(){
      const r = await fetch('/api/fantasy/leaderboard?limit=15');
      const j = await r.json();
      const box = document.getElementById('fantasy-leaderboard');
      if(!j.success){ box.textContent = j.error||'Erreur'; return; }
      box.innerHTML = j.leaderboard.map((x,i)=>`
        <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06);">
          <div>${i+1}. <strong>${x.user}</strong></div>
          <div style="color:#fde68a;">${Math.round(x.netWorth)}</div>
        </div>`).join('');
    }
    async function buy(){
      const user = getUser();
      const streamer = document.getElementById('fantasy-streamer').value.trim();
      const amount = Number(document.getElementById('fantasy-amount').value||0);
      const msg = document.getElementById('fantasy-msg');
      msg.textContent = '...';
      const r = await fetch('/api/fantasy/invest',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user, streamer, amount})});
      const j = await r.json();
      msg.textContent = j.success ? `✅ Achat: ${j.shares} parts @ ${j.price} (coût ${j.cost})` : `❌ ${j.error||'Erreur'}`;
      await loadProfile(); await loadLeaderboard();
    }

    b.addEventListener('click', async ()=>{
      modal.style.display = 'flex';
      try{ await loadProfile(); await loadLeaderboard(); }catch(e){ document.getElementById('fantasy-msg').textContent = e.message; }
    });
    modal.querySelector('#fantasy-close').addEventListener('click', ()=> modal.style.display='none');
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    modal.querySelector('#fantasy-buy').addEventListener('click', buy);
  }
  setInterval(ensureFantasy, 1400);
})();

    // ==== Messenger-like reactions handlers (hover/tap) ====
    (function(){
      const hubBox = document.getElementById('hub-messages');
      if(!hubBox) return;

      // Tap/click on a message toggles reaction bar (mobile-friendly)
      hubBox.addEventListener('click', (e)=>{
        const msgEl = e.target.closest('.hub-msg');
        if(msgEl && !e.target.closest('.hub-react-btn')) {
          msgEl.classList.toggle('show-reactions');
          return;
        }
        const btn = e.target.closest('.hub-react-btn');
        if(btn){
          const emoji = btn.getAttribute('data-react');
          const idEnc = btn.getAttribute('data-msg') || '';
          const msgId = decodeURIComponent(idEnc);
          if(window.emitHubReact) window.emitHubReact({ messageId: msgId, emoji });
        }
      });
    })();



// ===== Extra tools logic (Fantasy/Mosaic/Ambilight/Vibe) =====
let __ambOn = localStorage.getItem('jp_amb_on') === '1';
let __vibeOn = localStorage.getItem('jp_vibe_on') === '1';

function getParentParam(){
  const sp = new URLSearchParams(location.search);
  return sp.get('parent_host') || sp.get('parent') || location.hostname;
}

function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border:1px solid rgba(255,255,255,.18);border-radius:14px;z-index:999999;font-weight:900;';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1400);
}

function hashColor(str){
  str = String(str||'');
  let h=0; for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))>>>0;
  const a = 120 + (h % 120);
  const b = 90 + ((h>>8)%140);
  return `radial-gradient(circle at 25% 25%, rgba(0,242,234,.90), transparent 55%), radial-gradient(circle at 75% 75%, rgba(255,0,153,.78), transparent 55%), radial-gradient(circle at 50% 10%, rgba(${a},${b},255,.55), transparent 60%)`;
}

function refreshAmbilight(){
  const amb = document.getElementById('ambilight');
  if(!amb) return;
  const ch = (window.currentChannel || document.getElementById('current-channel-display')?.innerText || '').trim();
  amb.style.background = hashColor(ch || 'twitch');
}



let __toolsSched = false;
function ensurePlayerTools(){
  const vc = document.getElementById('video-container');
  if(!vc) return;

  // Ensure ambilight layer exists (behind player)
  if(!document.getElementById('ambilight')){
    const amb = document.createElement('div');
    amb.id = 'ambilight';
    vc.prepend(amb);
  }

  // Ensure tools exist (above player)
  let tools = document.getElementById('player-tools');
  if(!tools){
    tools = document.createElement('div');
    tools.id = 'player-tools';
    tools.innerHTML = `
      <button id="tool-mosaic" class="toolbtn" onclick="openMosaic()">📺</button>
      <button id="tool-fantasy" class="toolbtn" onclick="openFantasy()">🏆</button>
      <button id="tool-ambilight" class="toolbtn" onclick="toggleAmbilight()">💡</button>
      <button id="tool-vibe" class="toolbtn" onclick="toggleVibe()">🧠</button>
    `;
    vc.appendChild(tools);
  } else if (tools.parentElement !== vc) {
    vc.appendChild(tools);
  }

  // Force player iframe below tools
  vc.querySelectorAll('iframe').forEach(f=>{
    try{
      if(f.style.zIndex !== '1') f.style.zIndex = '1';
      if(f.style.position !== 'relative') f.style.position = 'relative';
    }catch(e){}
  });
}

// Re-ensure tools if Twitch replaces the player DOM (debounced to avoid infinite loops)
(function(){
  const vc = document.getElementById('video-container');
  if(!vc) return;

  ensurePlayerTools();

  const obs = new MutationObserver(()=>{
    if(__toolsSched) return;
    __toolsSched = true;
    requestAnimationFrame(()=>{
      __toolsSched = false;
      ensurePlayerTools();
    });
  });

  obs.observe(vc, { childList: true, subtree: true });

  window.addEventListener('load', ()=>setTimeout(ensurePlayerTools, 600));
  setTimeout(ensurePlayerTools, 1200);
})();


function toggleAmbilight(){
  __ambOn = !__ambOn;
  localStorage.setItem('jp_amb_on', __ambOn ? '1' : '0');
  const btn = document.getElementById('tool-ambilight');
  const amb = document.getElementById('ambilight');
  if(btn) btn.classList.toggle('active', __ambOn);
  if(amb) amb.classList.toggle('on', __ambOn);
  refreshAmbilight();
  toast(`Ambilight ${__ambOn ? 'activé' : 'désactivé'}`);
}

function vibeClass(name){
  const s = String(name||'');
  let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0;
  const v = h % 3;
  return v===0 ? 'vibe-chill' : (v===1 ? 'vibe-hype' : 'vibe-toxic');
}
function applyVibe(){
  document.querySelectorAll('.tf-card').forEach(card=>{
    card.classList.remove('vibe-chill','vibe-hype','vibe-toxic');
    if(!__vibeOn) return;
    const name = card.dataset.gameName || card.getAttribute('data-game-name') || card.querySelector('.tf-title')?.textContent || '';
    card.classList.add(vibeClass(name));
  });
}
function toggleVibe(){
  __vibeOn = !__vibeOn;
  localStorage.setItem('jp_vibe_on', __vibeOn ? '1' : '0');
  const btn = document.getElementById('tool-vibe');
  if(btn) btn.classList.toggle('active', __vibeOn);
  applyVibe();
  toast(`Vibe Check ${__vibeOn ? 'activé' : 'désactivé'}`);
}

// reapply vibe on mutations
new MutationObserver(()=>{ if(__vibeOn) applyVibe(); }).observe(document.body, {childList:true, subtree:true});

// Mosaic
function openMosaic(){
  const m = document.getElementById('mosaicModal');
  const grid = document.getElementById('mosaicGrid');
  if(!m||!grid) return;
  const parent = getParentParam();
  const current = (window.currentChannel || document.getElementById('current-channel-display')?.innerText || '').trim();
  const list = [];
  if(current) list.push(current);
  if(Array.isArray(window.recentChannels)) list.push(...window.recentChannels);
  while(list.length < 4) list.push(current || 'twitch');
  const channels = list.filter(Boolean).slice(0,4);

  grid.innerHTML = '';
  channels.forEach(ch=>{
    const tile = document.createElement('div');
    tile.className='mosaic-tile';
    const src = `https://player.twitch.tv/?channel=${encodeURIComponent(ch)}&parent=${encodeURIComponent(parent)}&muted=true&autoplay=true`;
    tile.innerHTML = `<iframe src="${src}" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen"></iframe>
      <button onclick="focusChannel('${encodeURIComponent(ch)}')">Focus</button>`;
    grid.appendChild(tile);
  });
  m.classList.add('active');
}
function closeMosaic(e){ if(e) e.preventDefault(); document.getElementById('mosaicModal')?.classList.remove('active'); }
function focusChannel(enc){
  const ch = decodeURIComponent(enc);
  if(typeof changeChannel === 'function') changeChannel(ch);
  refreshAmbilight();
  closeMosaic(new Event('click'));
}

// Fantasy API + chart
function openFantasy(){ document.getElementById('fantasyModal')?.classList.add('active'); refreshFantasy(); }
function closeFantasy(e){ if(e) e.preventDefault(); document.getElementById('fantasyModal')?.classList.remove('active'); }

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

async function refreshFantasy(){
  const user = (window.currentUser || 'Anon');
  const prof = await fetch(`/api/fantasy/profile?user=${encodeURIComponent(user)}`).then(r=>r.json()).catch(()=>null);
  if(prof && prof.success){
    document.getElementById('fantasyCash').textContent = `${Number(prof.cash||0).toLocaleString('fr-FR')} crédits`;
    const h = document.getElementById('fantasyHoldings');
    if(h){
      h.innerHTML = (prof.holdings||[]).map(x=>`
        <div style="display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.15);cursor:pointer;"
             onclick="loadMarket('${escapeHtml(x.login)}')">
          <div style="font-weight:900;color:#fff;">${escapeHtml(x.login)} <span style="color:#a7a7b2;font-weight:700;">(${x.shares} sh)</span></div>
          <div style="font-weight:900;color:#00f2ea;">${Math.round(x.value).toLocaleString('fr-FR')}</div>
        </div>`).join('') || `<div style="color:#a7a7b2;">Aucun streamer en portefeuille.</div>`;
    }
  }

  const lb = await fetch(`/api/fantasy/leaderboard`).then(r=>r.json()).catch(()=>null);
  if(lb && lb.success){
    const el = document.getElementById('fantasyLeaderboard');
    if(el){
      el.innerHTML = (lb.items||[]).slice(0,10).map((u,i)=>`
        <div style="display:flex;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.15);">
          <div style="font-weight:900;color:#fff;">#${i+1} ${escapeHtml(u.user||'')}</div>
          <div style="font-weight:900;color:#ffd600;">${Math.round(u.netWorth||0).toLocaleString('fr-FR')}</div>
        </div>`).join('') || `<div style="color:#a7a7b2;">Aucun classement.</div>`;
    }
  }
}

async function loadMarket(login){
  if(!login) return;
  const d = await fetch(`/api/fantasy/market?streamer=${encodeURIComponent(login)}`).then(r=>r.json()).catch(()=>null);
  if(!d || !d.success) return toast('Marché indisponible');
  const m = d.market;
  const info = document.getElementById('marketInfo');
  if(info){
    info.innerHTML = `
      <div>Base: <b style="color:#fff">${m.basePrice}</b></div>
      <div>Impact: <b style="color:#fff">x${Number(m.mult).toFixed(2)}</b></div>
      <div>Shares: <b style="color:#fff">${Math.round(m.sharesOutstanding)}</b></div>
      <div>Prix: <b style="color:#00f2ea">${m.price}</b></div>
    `;
  }
  drawChart(d.history || [], m.price);
  document.getElementById('fantasyStreamer').value = login;
}

function drawChart(history, last){
  const c = document.getElementById('marketChart');
  if(!c) return;
  const ctx = c.getContext('2d');
  const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0b0b0d';
  ctx.fillRect(0,0,W,H);
  const pts = (history||[]).map(x=>Number(x.price||0)).filter(x=>x>0);
  if(pts.length < 2){
    ctx.fillStyle = '#a7a7b2';
    ctx.font = '14px system-ui';
    ctx.fillText('Historique insuffisant (2+ points requis)', 16, 30);
    return;
  }
  const minP=Math.min(...pts), maxP=Math.max(...pts);
  const pad=18;
  const sx=(W-pad*2)/(pts.length-1);
  const sy=(H-pad*2)/(maxP-minP||1);
  ctx.strokeStyle='rgba(0,242,234,.85)';
  ctx.lineWidth=3;
  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x=pad+i*sx;
    const y=H-pad-(p-minP)*sy;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle='#00f2ea';
  ctx.font='bold 16px system-ui';
  ctx.fillText(String(last||pts[pts.length-1]), W-70, 26);
}

async function fantasyBuy(){
  const user = (window.currentUser || 'Anon');
  const login = document.getElementById('fantasyStreamer')?.value?.trim();
  const amount = Number(document.getElementById('fantasyAmount')?.value || 0);
  if(!login || !amount) return alert('Streamer + montant requis.');
  const r = await fetch('/api/fantasy/invest', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ user, streamer: login, amount })}).then(r=>r.json()).catch(()=>null);
  if(!r || !r.success) return alert(r?.error || 'Erreur invest.');
  toast('Investissement effectué');
  await refreshFantasy();
  await loadMarket(login);
}
async function fantasySell(){
  const user = (window.currentUser || 'Anon');
  const login = document.getElementById('fantasyStreamer')?.value?.trim();
  const amount = Number(document.getElementById('fantasyAmount')?.value || 0);
  if(!login || !amount) return alert('Streamer + montant requis.');
  const r = await fetch('/api/fantasy/sell', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ user, streamer: login, amount })}).then(r=>r.json()).catch(()=>null);
  if(!r || !r.success) return alert(r?.error || 'Erreur sell.');
  toast('Vente effectuée');
  await refreshFantasy();
  await loadMarket(login);
}

// initialize buttons state
document.getElementById('tool-ambilight')?.classList.toggle('active', __ambOn);
document.getElementById('ambilight')?.classList.toggle('on', __ambOn);
document.getElementById('tool-vibe')?.classList.toggle('active', __vibeOn);
setTimeout(()=>{ if(__ambOn) refreshAmbilight(); if(__vibeOn) applyVibe(); }, 700);





// (BOURSE PANEL removed — replaced by Market overlay)

function openMarketOverlay(){
  document.body.classList.add('modal-open');
const ov = document.getElementById('market-overlay');
      if(!ov) return;
      ov.classList.remove('hidden');
      // ensure overlay starts at top
      try { ov.querySelector('.overflow-y-auto')?.scrollTo({ top:0, behavior:'smooth' }); } catch(_){}
      // refresh when opened (soft)
      try { refreshMarketAll(); } catch(_){}
    }
    function closeMarketOverlay(){
  document.body.classList.remove('modal-open');
const ov = document.getElementById('market-overlay');
      if(!ov) return;
      ov.classList.add('hidden');
    }

</script>
<div class="modal-overlay" id="mosaicModal" onclick="closeMosaic(event)">
<div class="modal-card" onclick="event.stopPropagation()">
<div class="modal-head">
<div class="modal-title">Mosaic Mode</div>
<button class="modal-close" onclick="closeMosaic(event)">✕</button>
</div>
<div class="mosaic-grid" id="mosaicGrid"></div>
</div>
</div>
<div class="modal-overlay" id="fantasyModal" onclick="closeFantasy(event)">
<div class="modal-card" onclick="event.stopPropagation()">
<div class="modal-head">
<div class="modal-title">Fantasy League</div>
<button class="modal-close" onclick="closeFantasy(event)">✕</button>
</div>
<div style="display:flex;gap:12px;flex-wrap:wrap;">
<div style="flex:1;min-width:290px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
<div style="font-weight:900;color:#00f2ea;margin-bottom:6px;">Portefeuille (max 10 streamers)</div>
<div id="fantasyCash" style="font-size:22px;font-weight:900;color:#fff;">—</div>
<div id="fantasyHoldings" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
</div>
<div style="flex:2;min-width:320px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
<input id="fantasyStreamer" placeholder="Streamer (login)" style="flex:1;min-width:220px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;"/>
<input id="fantasyAmount" min="1" placeholder="Montant" style="width:140px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;" type="number"/>
<button onclick="fantasyBuy()" style="background:#00f2ea;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Investir</button>
<button onclick="fantasySell()" style="background:#ff0099;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Vendre</button>
</div>
<div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
<div style="flex:1;min-width:260px;">
<div style="font-weight:900;color:#eaeaf0;margin-bottom:6px;">Cours</div>
<div id="marketInfo" style="display:flex;gap:10px;flex-wrap:wrap;color:#a7a7b2;font-size:12px;"></div>
<canvas height="220" id="marketChart" style="width:100%;background:#0b0b0d;border:1px solid rgba(255,255,255,.10);border-radius:14px;" width="640"></canvas>
</div>
<div style="flex:1;min-width:260px;">
<div style="font-weight:900;color:#ffd600;margin-bottom:6px;">Leaderboard</div>
<div id="fantasyLeaderboard" style="display:flex;flex-direction:column;gap:8px;"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- MARKET OVERLAY (center modal, Binance-like) -->
<div id="market-overlay" class="fixed inset-0 z-[9999] hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/70" onclick="closeMarketOverlay()"></div>

  <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(1240px,96vw)] h-[min(90vh,920px)] rounded-2xl border border-white/10 bg-[#050607] shadow-[0_0_80px_rgba(0,229,255,0.08)] flex flex-col overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-white/5">
          <span class="inline-block w-2 h-2 rounded-full bg-[#00ff88] shadow-[0_0_12px_rgba(0,255,136,0.65)] animate-pulse"></span>
          <span class="text-xs font-bold tracking-wide">LIVE</span>
        </div>
        <div>
          <div class="text-lg font-extrabold tracking-tight">Marché des Streamers</div>
          <div class="text-xs text-white/60">Cours réels = viewers live (base) × impact (offre/demande). Aucune donnée inventée.</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="mkt-refresh" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Rafraîchir</button>
        <button id="mkt-auto" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Auto: ON</button>
        <button class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" onclick="closeMarketOverlay()">✕</button>
      </div>
    </div>

    <div class="flex items-center gap-2 px-4 py-2 border-b border-white/10">
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/10 text-sm font-bold" data-tab="overview">Overview</button>
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" data-tab="markets">Markets</button>
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" data-tab="chart">Chart Pro</button>
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" data-tab="portfolio">Portfolio</button>
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" data-tab="leaderboard">Classement</button>
      <button class="mkt-tab px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm" data-tab="learn">Comprendre</button>

      <div class="ml-auto flex items-center gap-2">
        <input id="mkt-search" placeholder="Rechercher un login Twitch (ex: zerator)" class="w-[min(420px,50vw)] px-3 py-2 rounded-lg bg-white/5 border border-white/10 outline-none text-sm" />
        <button id="mkt-add" class="px-3 py-2 rounded-lg bg-[#00e5ff] text-black font-bold text-sm">⭐ Ajouter</button>
      </div>
    </div>

    <div class="flex-1 overflow-hidden">
      <div class="h-full overflow-y-auto p-4" id="mkt-view">

        <!-- OVERVIEW -->
        <section id="mkt-tab-overview" class="mkt-view">
          <div class="grid grid-cols-12 gap-3">
            <div class="col-span-12 md:col-span-8 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs text-white/60">Ticker sélectionné</div>
                  <div class="text-2xl font-extrabold tracking-tight" id="mkt-selected">—</div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-white/60">Prix</div>
                  <div class="text-3xl font-extrabold tracking-tight" id="mkt-price">—</div>
                  <div class="text-xs" id="mkt-chg">—</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Base (viewers)</div>
                  <div class="text-lg font-bold" id="mkt-base">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Impact (mult)</div>
                  <div class="text-lg font-bold" id="mkt-mult">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Shares</div>
                  <div class="text-lg font-bold" id="mkt-shares">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Market Cap</div>
                  <div class="text-lg font-bold" id="mkt-mcap">—</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Perf 1h</div>
                  <div class="text-lg font-bold" id="mkt-p1h">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Perf 6h</div>
                  <div class="text-lg font-bold" id="mkt-p6h">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Perf 7j</div>
                  <div class="text-lg font-bold" id="mkt-p7d">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Trend Score</div>
                  <div class="text-lg font-bold" id="mkt-trend">—</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">Volatilité</div>
                  <div class="text-lg font-bold" id="mkt-vol">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">High / Low (période)</div>
                  <div class="text-lg font-bold" id="mkt-hilo">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">SMA20 / SMA50</div>
                  <div class="text-lg font-bold" id="mkt-sma">—</div>
                </div>
                <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                  <div class="text-xs text-white/60">EMA20 / EMA50</div>
                  <div class="text-lg font-bold" id="mkt-ema">—</div>
                </div>
              </div>

              <div class="mt-4 flex flex-wrap items-center gap-2">
                <input id="mkt-amount" type="number" min="1" value="100" class="w-32 px-3 py-2 rounded-lg bg-white/5 border border-white/10 outline-none text-sm" />
                <button id="mkt-buy" class="px-4 py-2 rounded-lg bg-[#00ff88] text-black font-extrabold">Acheter</button>
                <button id="mkt-sell" class="px-4 py-2 rounded-lg bg-[#ff4d6d] text-black font-extrabold">Vendre</button>
                <div class="ml-auto text-xs text-white/60" id="mkt-updated">—</div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">Heatmap Watchlist</div>
                <button id="mkt-edit" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Éditer</button>
              </div>
              <div class="text-xs text-white/60 mt-1">Basé sur Perf 1h (ou horizon sélectionné).</div>

              <div class="mt-3 flex items-center gap-2">
                <select id="mkt-horizon" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm outline-none">
                  <option value="3600">1h</option>
                  <option value="21600">6h</option>
                  <option value="604800">7j</option>
                </select>
                <span class="text-xs text-white/60">Horizon</span>
              </div>

              <div class="mt-3 grid grid-cols-2 gap-2" id="mkt-heat"></div>

              <div class="mt-4 border-t border-white/10 pt-3">
                <div class="font-extrabold">Top Gainers / Losers</div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                    <div class="text-xs text-white/60">Gainers</div>
                    <div id="mkt-gainers" class="text-sm mt-1"></div>
                  </div>
                  <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                    <div class="text-xs text-white/60">Losers</div>
                    <div id="mkt-losers" class="text-sm mt-1"></div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- MARKETS -->
        <section id="mkt-tab-markets" class="mkt-view hidden">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-extrabold text-lg">Markets (Watchlist)</div>
              <div class="flex items-center gap-2">
                <select id="mkt-sort" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm outline-none">
                  <option value="trend">Trier: Trend</option>
                  <option value="p1h">Trier: Perf 1h</option>
                  <option value="p6h">Trier: Perf 6h</option>
                  <option value="p7d">Trier: Perf 7j</option>
                  <option value="mcap">Trier: Market Cap</option>
                  <option value="vol">Trier: Volatilité</option>
                </select>
                <button id="mkt-reload-watch" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Recharger</button>
              </div>
            </div>

            <div class="mt-3 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-white/60">
                  <tr>
                    <th class="text-left py-2">#</th>
                    <th class="text-left py-2">Streamer</th>
                    <th class="text-right py-2">Prix</th>
                    <th class="text-right py-2">1h</th>
                    <th class="text-right py-2">6h</th>
                    <th class="text-right py-2">7j</th>
                    <th class="text-right py-2">Vol</th>
                    <th class="text-right py-2">MCap</th>
                    <th class="text-right py-2">Trend</th>
                    <th class="text-right py-2">Spark</th>
                  </tr>
                </thead>
                <tbody id="mkt-table"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CHART -->
        <section id="mkt-tab-chart" class="mkt-view hidden">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div class="font-extrabold text-lg">Chart Pro</div>
                <div class="text-xs text-white/60">Sparklines + SMA/EMA (calculés sur l'historique renvoyé par /api/fantasy/market).</div>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs text-white/60 flex items-center gap-2"><input id="mkt-toggle-sma" type="checkbox" checked> SMA</label>
                <label class="text-xs text-white/60 flex items-center gap-2"><input id="mkt-toggle-ema" type="checkbox" checked> EMA</label>
              </div>
            </div>

            <div class="mt-3 rounded-xl border border-white/10 bg-black/30 p-3">
              <svg id="mkt-chart" viewBox="0 0 1000 360" preserveAspectRatio="none" class="w-full h-[360px]"></svg>
              <div class="text-xs text-white/60 mt-2" id="mkt-chart-meta">—</div>
            </div>
          </div>
        </section>

        <!-- PORTFOLIO -->
        <section id="mkt-tab-portfolio" class="mkt-view hidden">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-extrabold text-lg">Portfolio</div>
              <div class="flex items-center gap-2">
                <input id="mkt-user" value="Anon" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm outline-none" />
                <button id="mkt-load-portfolio" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Charger</button>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                <div class="text-xs text-white/60">Cash</div>
                <div class="text-lg font-bold" id="pf-cash">—</div>
              </div>
              <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                <div class="text-xs text-white/60">Valeur positions</div>
                <div class="text-lg font-bold" id="pf-hold">—</div>
              </div>
              <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                <div class="text-xs text-white/60">Net Worth</div>
                <div class="text-lg font-bold" id="pf-net">—</div>
              </div>
              <div class="rounded-xl border border-white/10 bg-black/20 p-3">
                <div class="text-xs text-white/60">Positions</div>
                <div class="text-lg font-bold" id="pf-n">—</div>
              </div>
            </div>

            <div class="mt-3 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-white/60">
                  <tr>
                    <th class="text-left py-2">Streamer</th>
                    <th class="text-right py-2">Shares</th>
                    <th class="text-right py-2">Prix</th>
                    <th class="text-right py-2">Valeur</th>
                  </tr>
                </thead>
                <tbody id="pf-table"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- LEADERBOARD -->
        <section id="mkt-tab-leaderboard" class="mkt-view hidden">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-lg">Classement</div>
              <button id="mkt-load-leader" class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Charger</button>
            </div>
            <div class="mt-3" id="lb-list"></div>
          </div>
        </section>

        <!-- LEARN -->
        <section id="mkt-tab-learn" class="mkt-view hidden">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4 prose prose-invert max-w-none">
            <h3>Comment le prix est calculé (réel)</h3>
            <ul>
              <li><strong>BasePrice</strong> : dérivé des viewers live du streamer (si offline, base minimale).</li>
              <li><strong>SharesOutstanding</strong> : nombre total de “parts” en circulation (achats/ventes).</li>
              <li><strong>Impact</strong> : multiplicateur qui augmente avec la demande (logarithmique).</li>
              <li><strong>Prix final</strong> = BasePrice × Impact.</li>
            </ul>
            <p>Les performances (1h/6h/7j), SMA/EMA, volatilité et trend score sont calculés uniquement à partir de l’historique de prix renvoyé par l’API (<code>/api/fantasy/market</code>), donc sans données inventées.</p>
            <p><strong>Watchlist “Firebase” :</strong> au premier lancement, l’app construit une watchlist réelle à partir des holdings des meilleurs portefeuilles (endpoint leaderboard + profile). Les utilisateurs peuvent ensuite en ajouter.</p>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- Edit Watchlist Modal -->
  <div id="mkt-edit-modal" class="fixed inset-0 z-[10000] hidden">
    <div class="absolute inset-0 bg-black/70" onclick="document.getElementById('mkt-edit-modal').classList.add('hidden')"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(760px,94vw)] rounded-2xl border border-white/10 bg-[#050607] p-4">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-lg">Watchlist</div>
        <button class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10" onclick="document.getElementById('mkt-edit-modal').classList.add('hidden')">✕</button>
      </div>
      <div class="text-xs text-white/60 mt-1">Sépare par des virgules. Exemple : <code>zerator, gotaga, kamet0</code></div>
      <textarea id="mkt-watchlist" class="mt-3 w-full h-32 px-3 py-2 rounded-lg bg-white/5 border border-white/10 outline-none text-sm"></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button class="px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10" onclick="document.getElementById('mkt-edit-modal').classList.add('hidden')">Annuler</button>
        <button id="mkt-save-watchlist" class="px-3 py-2 rounded-lg bg-[#00e5ff] text-black font-extrabold">Enregistrer</button>
      </div>
    </div>
  </div>
</div>


<script>
/* HARD FIX DOM: ensure side-panel is a direct child of #main-layout (prevents it from dropping under the player) */
(function(){
  function ensureSidePanel(){
    var layout = document.getElementById('main-layout');
    var side = document.getElementById('side-panel');
    if(!layout || !side) return;
    if(side.parentElement !== layout){
      layout.appendChild(side);
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureSidePanel);
  } else {
    ensureSidePanel();
  }
  window.addEventListener('resize', function(){ setTimeout(ensureSidePanel, 50); });
})();
</script>


<script>
/* ==========================
   MARKET APP (Binance-like)
   - watchlist bootstrapped from Firestore via backend:
     leaderboard -> profile holdings -> unique tickers
   - all metrics derived from /api/fantasy/market (real)
   ========================== */

(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // --- Modal helpers ---
  const overlay = $('#market-overlay');
  const tabs = $$('.mkt-tab', overlay);
  const views = $$('.mkt-view', overlay);

  function setBodyModal(on){
    document.body.classList.toggle('modal-open', !!on);
  }

  // Ensure floating emoji buttons (📺🏆💡🧠) don't overlay modals
  function setAuxUiHidden(on){
    // best-effort: hide known floating toolbars
    $$('#floating-tools, #floatingTools, .floating-tools, .quick-tools, .dock-tools').forEach(el=>{
      el.style.display = on ? 'none' : '';
    });
  }

  // --- Data store ---
  let watchlist = [];
  let selected = null;
  let autoOn = true;
  let autoTimer = null;
  let cache = new Map(); // login -> last market response

  const LS_KEY = 'mkt_watchlist_v1';
  const LS_SEL = 'mkt_selected_v1';

  function format(n){
    if(n === null || n === undefined || Number.isNaN(n)) return '—';
    const x = Number(n);
    if(Math.abs(x) >= 1_000_000) return (x/1_000_000).toFixed(2)+'M';
    if(Math.abs(x) >= 1_000) return (x/1_000).toFixed(2)+'K';
    return (Math.round(x*100)/100).toString();
  }
  function pct(n){
    if(n === null || n === undefined || Number.isNaN(n)) return '—';
    const x = Number(n);
    const sign = x > 0 ? '+' : '';
    return sign + x.toFixed(2) + '%';
  }
  function colorClass(p){
    if(p === null || p === undefined || Number.isNaN(p)) return 'text-white/70';
    if(p > 0) return 'text-[#00ff88]';
    if(p < 0) return 'text-[#ff4d6d]';
    return 'text-white/70';
  }

  function sparklineSvg(points){
    if(!points || points.length < 2) return '<svg viewBox="0 0 100 24" class="w-[100px] h-6"></svg>';
    const min = Math.min(...points);
    const max = Math.max(...points);
    const span = (max-min) || 1;
    const coords = points.map((v,i)=>{
      const x = (i/(points.length-1))*100;
      const y = 24 - ((v-min)/span)*24;
      return x.toFixed(2)+','+y.toFixed(2);
    }).join(' ');
    const up = points[points.length-1] >= points[0];
    const stroke = up ? '#00ff88' : '#ff4d6d';
    return `
      <svg viewBox="0 0 100 24" class="w-[100px] h-6">
        <polyline fill="none" stroke="${stroke}" stroke-width="2" points="${coords}" />
      </svg>`;
  }

  function findPointAtOrBefore(history, targetTs){
    // history: [{ts,price}], sorted asc
    if(!history || history.length === 0) return null;
    // binary search
    let lo=0, hi=history.length-1, ans=null;
    while(lo<=hi){
      const mid=(lo+hi)>>1;
      const ts=Number(history[mid].ts||0);
      if(ts<=targetTs){ ans=history[mid]; lo=mid+1; }
      else hi=mid-1;
    }
    return ans;
  }

  function computePerf(history, seconds){
    if(!history || history.length < 2) return null;
    const now = Number(history[history.length-1].ts || Date.now());
    const cur = Number(history[history.length-1].price || 0);
    const pastPoint = findPointAtOrBefore(history, now - seconds*1000) || history[0];
    const past = Number(pastPoint?.price || 0);
    if(!past) return null;
    return ((cur - past) / past) * 100;
  }

  function computeReturns(history){
    if(!history || history.length < 3) return [];
    const out=[];
    for(let i=1;i<history.length;i++){
      const a=Number(history[i-1].price||0);
      const b=Number(history[i].price||0);
      if(a>0 && b>0) out.push(Math.log(b/a));
    }
    return out;
  }
  function std(arr){
    if(!arr || arr.length<2) return null;
    const mean = arr.reduce((s,x)=>s+x,0)/arr.length;
    const v = arr.reduce((s,x)=>s+(x-mean)**2,0)/(arr.length-1);
    return Math.sqrt(v);
  }
  function sma(arr, n){
    if(!arr || arr.length < n) return null;
    const slice = arr.slice(-n);
    return slice.reduce((s,x)=>s+x,0)/n;
  }
  function ema(arr, n){
    if(!arr || arr.length < n) return null;
    const k = 2/(n+1);
    let e = arr[0];
    for(let i=1;i<arr.length;i++) e = arr[i]*k + e*(1-k);
    return e;
  }

  function trendScore(p1h, p6h, p7d, vol){
    // normalize and combine (no fake data; just derived score)
    const a = (p1h ?? 0) * 0.45 + (p6h ?? 0) * 0.35 + (p7d ?? 0) * 0.20;
    const penalty = (vol ?? 0) * 120; // log-return std ~ small; scale to 0..?
    const raw = a - penalty;
    // map to 0..100
    const s = Math.max(0, Math.min(100, 50 + raw));
    return Math.round(s);
  }

  async function fetchMarket(login){
    const key = String(login||'').trim().toLowerCase();
    if(!key) return null;
    const r = await fetch(`/api/fantasy/market?streamer=${encodeURIComponent(key)}`);
    const j = await r.json();
    if(!j?.success) return null;
    cache.set(key, j);
    return j;
  }

  async function fetchLeaderboard(){
    const r = await fetch('/api/fantasy/leaderboard');
    const j = await r.json();
    if(!j?.success) return [];
    return j.items || [];
  }

  async function fetchProfile(user){
    const r = await fetch(`/api/fantasy/profile?user=${encodeURIComponent(user)}`);
    const j = await r.json();
    if(!j?.success) return null;
    return j;
  }

  async function bootstrapWatchlistFromFirebase(){
    // If localStorage already has list, keep it.
    const ls = localStorage.getItem(LS_KEY);
    if(ls){
      try{
        const arr = JSON.parse(ls);
        if(Array.isArray(arr) && arr.length){
          watchlist = arr.map(x=>String(x).toLowerCase().trim()).filter(Boolean).slice(0, 40);
          return;
        }
      }catch(_){}
    }

    // Build from top leaderboard users holdings (real Firestore via backend)
    const lb = await fetchLeaderboard();
    const topUsers = lb.slice(0, 12).map(x=>x.user).filter(Boolean);

    const set = new Set();
    for(const u of topUsers){
      const prof = await fetchProfile(u);
      const holds = prof?.holdings || [];
      holds.forEach(h=>{ if(h?.login) set.add(String(h.login).toLowerCase().trim()); });
      if(set.size >= 25) break;
    }

    watchlist = Array.from(set).slice(0, 25);
    if(!watchlist.length){
      watchlist = ['twitch']; // fallback
    }

    localStorage.setItem(LS_KEY, JSON.stringify(watchlist));
  }

  function setSelected(login){
    selected = String(login||'').toLowerCase().trim();
    if(selected) localStorage.setItem(LS_SEL, selected);
    $('#mkt-selected').textContent = selected ? selected.toUpperCase() : '—';
  }

  function updateOverview(mkt){
    if(!mkt) return;
    const login = selected;
    const market = mkt.market || {};
    const hist = (mkt.history || []).map(x=>({ts:Number(x.ts||0), price:Number(x.price||0)})).filter(x=>x.ts && x.price);

    const price = Number(market.price ?? NaN);
    const base = Number(market.basePrice ?? NaN);
    const mult = Number(market.mult ?? NaN);
    const shares = Number(market.sharesOutstanding ?? NaN);
    const mcap = (Number.isFinite(price) && Number.isFinite(shares)) ? price * shares : null;

    // performance windows
    const p1h = computePerf(hist, 3600);
    const p6h = computePerf(hist, 21600);
    const p7d = computePerf(hist, 604800);

    // vol from log returns
    const rets = computeReturns(hist);
    const vol = std(rets);

    // hilo
    const prices = hist.map(x=>x.price);
    const hi = prices.length ? Math.max(...prices) : null;
    const lo = prices.length ? Math.min(...prices) : null;

    // SMA/EMA
    const sma20 = sma(prices, 20);
    const sma50 = sma(prices, 50);
    const ema20 = ema(prices, 20);
    const ema50 = ema(prices, 50);

    const tscore = trendScore(p1h, p6h, p7d, vol);

    // delta from last point vs prev
    let chgText = '—';
    if(prices.length >= 2){
      const prev = prices[prices.length-2];
      const cur = prices[prices.length-1];
      const d = ((cur-prev)/prev)*100;
      chgText = `Δ dernier point: ${pct(d)}`;
    }

    $('#mkt-price').textContent = Number.isFinite(price) ? format(price) : '—';
    $('#mkt-chg').textContent = chgText;
    $('#mkt-chg').className = 'text-xs ' + (prices.length>=2 ? colorClass(((prices[prices.length-1]-prices[prices.length-2])/prices[prices.length-2])*100) : 'text-white/60');

    $('#mkt-base').textContent = Number.isFinite(base) ? format(base) : '—';
    $('#mkt-mult').textContent = Number.isFinite(mult) ? (Math.round(mult*100)/100).toString() : '—';
    $('#mkt-shares').textContent = Number.isFinite(shares) ? format(shares) : '—';
    $('#mkt-mcap').textContent = mcap !== null ? format(mcap) : '—';

    $('#mkt-p1h').textContent = p1h===null? '—' : pct(p1h);
    $('#mkt-p1h').className = 'text-lg font-bold ' + colorClass(p1h);
    $('#mkt-p6h').textContent = p6h===null? '—' : pct(p6h);
    $('#mkt-p6h').className = 'text-lg font-bold ' + colorClass(p6h);
    $('#mkt-p7d').textContent = p7d===null? '—' : pct(p7d);
    $('#mkt-p7d').className = 'text-lg font-bold ' + colorClass(p7d);

    $('#mkt-trend').textContent = Number.isFinite(tscore) ? (tscore + '/100') : '—';

    $('#mkt-vol').textContent = vol===null ? '—' : (Math.round(vol*10000)/100).toString(); // scaled
    $('#mkt-hilo').textContent = (hi===null||lo===null) ? '—' : `${format(hi)} / ${format(lo)}`;

    $('#mkt-sma').textContent = `${sma20?format(sma20):'—'} / ${sma50?format(sma50):'—'}`;
    $('#mkt-ema').textContent = `${ema20?format(ema20):'—'} / ${ema50?format(ema50):'—'}`;

    const lastTs = hist.length ? hist[hist.length-1].ts : null;
    $('#mkt-updated').textContent = lastTs ? ('Dernière maj: ' + new Date(lastTs).toLocaleString()) : '—';

    // chart
    renderChart(hist, { sma20, sma50, ema20, ema50 });

    // actions enable
    $('#mkt-buy').disabled = !login;
    $('#mkt-sell').disabled = !login;
  }

  function renderChart(hist, ind){
    const svg = $('#mkt-chart');
    const meta = $('#mkt-chart-meta');
    if(!svg) return;
    svg.innerHTML = '';
    if(!hist || hist.length < 2){
      meta.textContent = 'Pas assez de points historiques.';
      return;
    }
    const prices = hist.map(x=>x.price);
    const min = Math.min(...prices);
    const max = Math.max(...prices);
    const span = (max-min)||1;

    const pts = hist.map((p,i)=>{
      const x = (i/(hist.length-1))*1000;
      const y = 360 - ((p.price-min)/span)*360;
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');

    const up = prices[prices.length-1] >= prices[0];
    const stroke = up ? '#00ff88' : '#ff4d6d';
    svg.innerHTML += `<polyline fill="none" stroke="${stroke}" stroke-width="3" points="${pts}" />`;

    const showSMA = $('#mkt-toggle-sma')?.checked;
    const showEMA = $('#mkt-toggle-ema')?.checked;

    function lineForValue(val, color){
      if(!val) return;
      const y = 360 - ((val-min)/span)*360;
      svg.innerHTML += `<line x1="0" y1="${y.toFixed(1)}" x2="1000" y2="${y.toFixed(1)}" stroke="${color}" stroke-width="2" stroke-dasharray="6 6" opacity="0.8"/>`;
    }
    if(showSMA){
      lineForValue(ind.sma20, '#00e5ff');
      lineForValue(ind.sma50, '#7d5bbe');
    }
    if(showEMA){
      lineForValue(ind.ema20, '#ffd166');
      lineForValue(ind.ema50, '#ef476f');
    }

    meta.textContent = `Points: ${hist.length} · Min: ${format(min)} · Max: ${format(max)}`;
  }

  async function trade(side){
    const login = selected;
    if(!login) return;
    const amount = Number($('#mkt-amount').value || 0);
    if(!amount || amount<=0) return;

    const path = side === 'buy' ? '/api/fantasy/invest' : '/api/fantasy/sell';
    await fetch(path, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user: ($('#mkt-user')?.value || 'Anon'), streamer: login, amount })
    }).catch(()=>{});

    // refresh selected and watchlist
    await refreshSelected();
    await refreshWatchlist();
  }

  function setTab(name){
    tabs.forEach(b=>{
      const on = b.dataset.tab === name;
      b.classList.toggle('bg-white/10', on);
      b.classList.toggle('bg-white/5', !on);
      b.classList.toggle('font-bold', on);
    });
    views.forEach(v=>{
      v.classList.add('hidden');
    });
    const el = $('#mkt-tab-' + name);
    if(el) el.classList.remove('hidden');
  }

  function renderHeatmap(items, horizonSec){
    const wrap = $('#mkt-heat');
    if(!wrap) return;
    wrap.innerHTML = '';
    items.slice(0, 12).forEach(it=>{
      const p = it['p'+horizonSec] ?? it.pct;
      const cls = p>0 ? 'bg-[#00ff881f] border-[#00ff8833]' : (p<0 ? 'bg-[#ff4d6d1f] border-[#ff4d6d33]' : 'bg-white/5 border-white/10');
      const tcls = p>0 ? 'text-[#00ff88]' : (p<0 ? 'text-[#ff4d6d]' : 'text-white/70');
      const div = document.createElement('button');
      div.className = `text-left rounded-xl border ${cls} p-3 hover:bg-white/10 transition`;
      div.innerHTML = `<div class="text-xs text-white/60">${it.login.toUpperCase()}</div>
                       <div class="text-lg font-extrabold ${tcls}">${pct(p)}</div>`;
      div.onclick = ()=>{ setSelected(it.login); refreshSelected(); };
      wrap.appendChild(div);
    });
  }

  function renderGainersLosers(rows){
    const gain = $('#mkt-gainers');
    const lose = $('#mkt-losers');
    if(!gain || !lose) return;
    const g = [...rows].sort((a,b)=>(b.pct??-1e9)-(a.pct??-1e9)).slice(0,5);
    const l = [...rows].sort((a,b)=>(a.pct??1e9)-(b.pct??1e9)).slice(0,5);

    gain.innerHTML = g.map(x=>`<div class="${colorClass(x.pct)} font-bold">${x.login.toUpperCase()} <span class="text-white/60 font-normal">${pct(x.pct)}</span></div>`).join('') || '<div class="text-white/60">—</div>';
    lose.innerHTML = l.map(x=>`<div class="${colorClass(x.pct)} font-bold">${x.login.toUpperCase()} <span class="text-white/60 font-normal">${pct(x.pct)}</span></div>`).join('') || '<div class="text-white/60">—</div>';
  }

  async function refreshSelected(){
    const login = selected || watchlist[0];
    if(!login) return;

    setSelected(login);
    const mkt = await fetchMarket(login);
    updateOverview(mkt);
  }

  async function refreshWatchlist(){
    // fetch all tickers (limited concurrency)
    const list = watchlist.slice(0, 30);
    const results = [];
    const horizon = Number($('#mkt-horizon')?.value || 3600);
    const workers = 4;
    let idx=0;

    async function worker(){
      while(idx < list.length){
        const i = idx++;
        const login = list[i];
        const mkt = await fetchMarket(login);
        if(!mkt) continue;

        const hist = (mkt.history || []).map(x=>({ts:Number(x.ts||0), price:Number(x.price||0)})).filter(x=>x.ts && x.price);
        const market = mkt.market || {};
        const price = Number(market.price ?? NaN);
        const shares = Number(market.sharesOutstanding ?? NaN);
        const mcap = (Number.isFinite(price) && Number.isFinite(shares)) ? price*shares : null;

        const p1h = computePerf(hist, 3600);
        const p6h = computePerf(hist, 21600);
        const p7d = computePerf(hist, 604800);

        const rets = computeReturns(hist);
        const vol = std(rets);
        const tscore = trendScore(p1h, p6h, p7d, vol);

        const prices = hist.map(x=>x.price);
        const spark = prices.slice(-24);

        const pctH = computePerf(hist, horizon);
        results.push({
          login,
          price: Number.isFinite(price)?price:null,
          p1h, p6h, p7d,
          vol,
          mcap,
          trend: tscore,
          pct: pctH,
          spark
        });
      }
    }

    await Promise.allSettled(Array.from({length:workers}, worker));

    // heatmap + gainers/losers (based on selected horizon)
    renderHeatmap(results.map(x=>({login:x.login, pct:x.pct, ['p'+horizon]:x.pct})), horizon);
    renderGainersLosers(results);

    // table
    renderMarketsTable(results);
  }

  function renderMarketsTable(rows){
    const sort = $('#mkt-sort')?.value || 'trend';
    const list = [...rows];

    const keyMap = {
      trend: x=>x.trend ?? -1e9,
      p1h: x=>x.p1h ?? -1e9,
      p6h: x=>x.p6h ?? -1e9,
      p7d: x=>x.p7d ?? -1e9,
      mcap: x=>x.mcap ?? -1e9,
      vol: x=>x.vol ?? -1e9
    };
    const keyFn = keyMap[sort] || keyMap.trend;
    list.sort((a,b)=> (keyFn(b)-keyFn(a)));

    const tbody = $('#mkt-table');
    if(!tbody) return;
    tbody.innerHTML = '';
    list.forEach((r, i)=>{
      const tr = document.createElement('tr');
      tr.className = 'border-t border-white/10 hover:bg-white/5 cursor-pointer';
      tr.innerHTML = `
        <td class="py-2 text-white/60">${i+1}</td>
        <td class="py-2 font-bold">${r.login.toUpperCase()}</td>
        <td class="py-2 text-right font-bold">${r.price===null?'—':format(r.price)}</td>
        <td class="py-2 text-right ${colorClass(r.p1h)} font-bold">${r.p1h===null?'—':pct(r.p1h)}</td>
        <td class="py-2 text-right ${colorClass(r.p6h)} font-bold">${r.p6h===null?'—':pct(r.p6h)}</td>
        <td class="py-2 text-right ${colorClass(r.p7d)} font-bold">${r.p7d===null?'—':pct(r.p7d)}</td>
        <td class="py-2 text-right text-white/80">${r.vol===null?'—':(Math.round(r.vol*10000)/100)}</td>
        <td class="py-2 text-right text-white/80">${r.mcap===null?'—':format(r.mcap)}</td>
        <td class="py-2 text-right font-bold">${r.trend??'—'}</td>
        <td class="py-2 text-right">${sparklineSvg(r.spark || [])}</td>
      `;
      tr.onclick = ()=>{ setSelected(r.login); setTab('overview'); refreshSelected(); };
      tbody.appendChild(tr);
    });
  }

  async function refreshPortfolio(){
    const user = ($('#mkt-user')?.value || 'Anon').trim() || 'Anon';
    const prof = await fetchProfile(user);
    if(!prof){
      $('#pf-cash').textContent = '—';
      return;
    }
    const cash = Number(prof.cash||0);
    const holds = prof.holdings || [];
    const holdValue = holds.reduce((s,h)=>s+Number(h.value||0),0);
    const net = cash + holdValue;

    $('#pf-cash').textContent = format(cash);
    $('#pf-hold').textContent = format(holdValue);
    $('#pf-net').textContent = format(net);
    $('#pf-n').textContent = String(holds.length);

    const tbody = $('#pf-table');
    tbody.innerHTML = holds.map(h=>`
      <tr class="border-t border-white/10 hover:bg-white/5 cursor-pointer" onclick="window.__mktSelect && window.__mktSelect('${String(h.login).toLowerCase()}')">
        <td class="py-2 font-bold">${String(h.login||'').toUpperCase()}</td>
        <td class="py-2 text-right">${format(h.shares||0)}</td>
        <td class="py-2 text-right">${format(h.price||0)}</td>
        <td class="py-2 text-right font-bold">${format(h.value||0)}</td>
      </tr>
    `).join('') || '<tr><td class="py-2 text-white/60" colspan="4">Aucune position</td></tr>';
  }

  async function refreshLeaderboard(){
    const lb = await fetchLeaderboard();
    const wrap = $('#lb-list');
    if(!wrap) return;
    wrap.innerHTML = (lb||[]).slice(0,20).map((x,i)=>`
      <div class="flex items-center justify-between border-b border-white/10 py-2">
        <div class="font-bold">${i+1}. ${String(x.user||'').toUpperCase()}</div>
        <div class="text-white/80">${format(x.netWorth||0)}</div>
      </div>
    `).join('') || '<div class="text-white/60">—</div>';
  }

  // --- Events ---
  function wire(){
    // Tabs
    tabs.forEach(b=>{
      b.addEventListener('click', ()=>{
        setTab(b.dataset.tab);
      });
    });

    $('#mkt-refresh').addEventListener('click', async ()=>{
      await refreshSelected();
      await refreshWatchlist();
      if($('#mkt-tab-portfolio') && !$('#mkt-tab-portfolio').classList.contains('hidden')) await refreshPortfolio();
    });

    $('#mkt-auto').addEventListener('click', ()=>{
      autoOn = !autoOn;
      $('#mkt-auto').textContent = 'Auto: ' + (autoOn?'ON':'OFF');
      if(autoOn) startAuto();
      else stopAuto();
    });

    $('#mkt-buy').addEventListener('click', ()=>trade('buy'));
    $('#mkt-sell').addEventListener('click', ()=>trade('sell'));

    $('#mkt-horizon').addEventListener('change', ()=>refreshWatchlist());
    $('#mkt-sort').addEventListener('change', ()=>refreshWatchlist());
    $('#mkt-reload-watch').addEventListener('click', ()=>refreshWatchlist());

    $('#mkt-load-portfolio').addEventListener('click', ()=>refreshPortfolio());
    $('#mkt-load-leader').addEventListener('click', ()=>refreshLeaderboard());

    $('#mkt-edit').addEventListener('click', ()=>{
      $('#mkt-edit-modal').classList.remove('hidden');
      $('#mkt-watchlist').value = watchlist.join(', ');
    });
    $('#mkt-save-watchlist').addEventListener('click', ()=>{
      const raw = $('#mkt-watchlist').value || '';
      const arr = raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
      watchlist = Array.from(new Set(arr)).slice(0, 40);
      localStorage.setItem(LS_KEY, JSON.stringify(watchlist));
      $('#mkt-edit-modal').classList.add('hidden');
      if(!watchlist.includes(selected)) setSelected(watchlist[0]);
      refreshSelected();
      refreshWatchlist();
    });

    $('#mkt-add').addEventListener('click', ()=>{
      const q = ($('#mkt-search').value || '').trim().toLowerCase();
      if(!q) return;
      if(!watchlist.includes(q)){
        watchlist.unshift(q);
        watchlist = Array.from(new Set(watchlist)).slice(0, 40);
        localStorage.setItem(LS_KEY, JSON.stringify(watchlist));
      }
      setSelected(q);
      refreshSelected();
      refreshWatchlist();
      $('#mkt-search').value = '';
    });

    $('#mkt-search').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') $('#mkt-add').click();
    });

    // chart toggles
    $('#mkt-toggle-sma').addEventListener('change', ()=>refreshSelected());
    $('#mkt-toggle-ema').addEventListener('change', ()=>refreshSelected());

    // expose select for portfolio table onclick
    window.__mktSelect = (login)=>{ setSelected(login); setTab('overview'); refreshSelected(); };
  }

  function startAuto(){
    stopAuto();
    autoTimer = setInterval(async ()=>{
      if(!overlay || overlay.classList.contains('hidden')) return;
      await refreshSelected();
      await refreshWatchlist();
    }, 12000);
  }
  function stopAuto(){
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }

  // Override the existing refreshMarketAll called by openMarketOverlay()
  window.refreshMarketAll = async function(){
    await refreshSelected();
    await refreshWatchlist();
  };

  // Improve open/close to lock scroll and hide auxiliary buttons
  const _open = window.openMarketOverlay;
  const _close = window.closeMarketOverlay;
  window.openMarketOverlay = function(){
    if(!_open) return;
    _open();
    setBodyModal(true);
    setAuxUiHidden(true);
    // select default
    if(!selected) setSelected(watchlist[0]);
    refreshSelected();
    refreshWatchlist();
  };
  window.closeMarketOverlay = function(){
    if(_close) _close();
    setBodyModal(false);
    setAuxUiHidden(false);
  };

  // --- Chat height lock to player ---
  function lockSidePanelToPlayer(){
    const player = document.getElementById('twitch-embed') || document.querySelector('#player, #playerCol, #playerCol iframe, .player-shell, .twitch-player');
    const side = document.getElementById('side-panel') || document.querySelector('#side-panel, #sidePanel, #right-panel, #sideCol');
    if(!player || !side) return;

    const getRect = (el)=>{
      const r = el.getBoundingClientRect();
      return { h: Math.max(240, Math.floor(r.height)) };
    };

    const apply = ()=>{
      const h = getRect(player).h;
      side.style.height = h + 'px';
      side.style.maxHeight = h + 'px';
      side.style.overflow = 'hidden';
      // ensure inner scroll panels scroll
      const inner = side.querySelector('.tab-content, .panel, .side-content, .right-tabs-content, [data-side-scroll]') || side;
      if(inner) inner.style.overflow = 'auto';
    };

    apply();
    try{
      const ro = new ResizeObserver(()=>apply());
      ro.observe(player);
      window.addEventListener('resize', apply);
    }catch(_){
      window.addEventListener('resize', apply);
      setInterval(apply, 1200);
    }
  }

  async function init(){
    wire();
    await bootstrapWatchlistFromFirebase();

    const savedSel = localStorage.getItem(LS_SEL);
    if(savedSel && watchlist.includes(savedSel)) selected = savedSel;
    if(!selected) selected = watchlist[0];

    setSelected(selected);

    // allow market open without errors
    lockSidePanelToPlayer();

    // If overlay already open
    if(overlay && !overlay.classList.contains('hidden')){
      setBodyModal(true);
      setAuxUiHidden(true);
      await refreshSelected();
      await refreshWatchlist();
    }

    // start auto by default
    startAuto();
  }

  init();

})();
</script>



<script id="tabs-exclusive-patch-js">
(function(){
  function ensureViewport(){
    const side = document.getElementById('side-panel');
    if(!side) return null;

    let viewport = document.getElementById('tabs-viewport');
    if(!viewport){
      viewport = document.createElement('div');
      viewport.id = 'tabs-viewport';

      // Place viewport right after the tab-nav
      const nav = side.querySelector('.tab-nav');
      if(nav && nav.nextSibling){
        side.insertBefore(viewport, nav.nextSibling);
      }else{
        side.appendChild(viewport);
      }
    }
    return viewport;
  }

  function movePanelsIntoViewport(){
    const viewport = ensureViewport();
    if(!viewport) return;

    const chat = document.getElementById('tab-chat');
    const stats = document.getElementById('tab-stats');
    const tools = document.getElementById('tab-tools');

    // Move (append) panels into viewport so they cannot stack under each other
    [chat, stats, tools].forEach(el => {
      if(el && el.parentElement !== viewport){
        viewport.appendChild(el);
      }
    });

    // Normalise classes (they might exist already)
    viewport.querySelectorAll('.tab-content').forEach(p => {
      p.classList.remove('active');
    });
    if(chat) chat.classList.add('active');
  }

  // Hard exclusive tab switch
  window.openTab = function(ev, tabName){
    const viewport = document.getElementById('tabs-viewport') || ensureViewport();
    if(!viewport) return;

    // buttons
    const buttons = document.querySelectorAll('#side-panel .tab-nav .tab-btn');
    buttons.forEach(b => b.classList.remove('active'));
    if(ev && ev.currentTarget) ev.currentTarget.classList.add('active');
    else {
      // fallback: find button by onclick arg
      const btn = Array.from(buttons).find(b => (b.getAttribute('onclick')||'').includes(`'${tabName}'`));
      if(btn) btn.classList.add('active');
    }

    // panels
    viewport.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));

    const id = tabName === 'chat' ? 'tab-chat' : (tabName === 'stats' ? 'tab-stats' : 'tab-tools');
    const panel = document.getElementById(id);
    if(panel) panel.classList.add('active');
  };

  // Keep right panel height synced to player
  function syncRightPanelHeight(){
    const side = document.getElementById('side-panel');
    const player =
      document.getElementById('player-wrapper') ||
      document.getElementById('player-container') ||
      document.getElementById('twitch-embed')?.parentElement ||
      document.querySelector('iframe[src*="twitch.tv"]')?.parentElement;

    if(!side || !player) return;
    const h = player.getBoundingClientRect().height;
    if(h && h > 50) side.style.height = Math.round(h) + 'px';
  }

  document.addEventListener('DOMContentLoaded', () => {
    movePanelsIntoViewport();
    syncRightPanelHeight();
    window.addEventListener('resize', syncRightPanelHeight);
    setInterval(syncRightPanelHeight, 500);

    // Ensure click handlers still work even if inline onclick was changed
    document.querySelectorAll('#side-panel .tab-nav .tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const oc = btn.getAttribute('onclick') || '';
        const m = oc.match(/openTab\(event,\s*'([^']+)'\)/);
        const tab = m ? m[1] : 'chat';
        window.openTab(e, tab);
      }, { passive:true });
    });
  });
})();
</script>


<script>
/* ====== AUTO HELP (❓) ON ALL MODULE HEADERS/TABS ====== */
(function(){
  const HELP_TEXT_BY_TITLE = {
    "Alertes automatiques": "Déclenche des alertes quand un signal important apparaît (tendance, score, changement de marché).",
    "Courbe daily": "Évolution quotidienne des signaux/performances. Utile pour voir la progression sur plusieurs jours.",
    "IA – plan d’action": "Génère un plan concret (actions prioritaires) à partir de tes données et du contexte du stream.",
    "Simulation": "Teste différents scénarios (horaire, jeu, niche) et compare l'impact potentiel avant de décider.",
    "Chaîne vs Jeu": "Compare ta chaîne à un jeu/niche pour repérer où tu as le plus de traction et où tu perds des viewers.",
    "Heatmap meilleures heures (jeu)": "Carte chaleur des meilleures heures pour streamer ce jeu (où l'audience est la plus favorable).",
    "Tendance": "Mesure la dynamique actuelle (en hausse/baisse) et les signaux de hype.",
    "Top Jeux": "Liste des jeux les plus porteurs selon les signaux (hype, viewers, stabilité).",
    "Langues": "Aide à choisir la langue la plus pertinente selon l'audience et la concurrence.",
    "🎯 BEST TIME TO STREAM": "Recommandations d'horaires optimisés (créneaux où tu as le meilleur ratio visibilité / concurrence).",
    "MARCHÉ — ouvrir la fenêtre": "Mini-bourse de tendances : tu 'mises' sur des niches/jeux et tu suis la performance des signaux.",
    "SCANNER IA": "Analyse automatique de niches, chaînes et tendances pour détecter des opportunités rapidement.",
    "RAID FINDER": "Trouve des chaînes compatibles pour raid (taille, jeu, langue) afin de maximiser les retours.",
    "CO-STREAM MATCH": "Propose des co-streamers compatibles (même vibe, même jeux, audience proche).",
    "BOOST": "Met en avant un live à lancer (rotation) ou une opportunité de collaboration/raid selon les signaux."
  };

  const HELP_TEXT_BY_TAB = {
    "OVERVIEW": "Vue synthèse : KPIs, raccourcis et état global du live.",
    "ANALYTICS PRO": "Analyse avancée : courbes, segments, perf, signaux et comparaisons.",
    "NICHE": "Niche & opportunités : idées de jeux/sujets, concurrence, timing et angles gagnants.",

    "CHAT": "Chat du stream : Twitch + Hub Secure. Rien d'autre n'apparaît en dessous.",
    "STATS": "Tableaux et métriques (audience, tendances, historique).",
    "OUTILS": "Tous les modules d'analyse (best time, marché, scanner, raid finder, etc.)."
  };

  function norm(s){ return String(s||"").replace(/\s+/g," ").trim(); }

  function addHelpTo(el, text){
    if (!el || el.querySelector('.help')) return;
    const span = document.createElement('span');
    span.className = 'help';
    span.setAttribute('data-help', text);
    span.textContent = '?';
    el.appendChild(document.createTextNode(' '));
    el.appendChild(span);
  }

  function apply(){
    document.querySelectorAll('h1,h2,h3,h4').forEach(h => {
      const t = norm(h.textContent);
      if (HELP_TEXT_BY_TITLE[t]) addHelpTo(h, HELP_TEXT_BY_TITLE[t]);
    });

    document.querySelectorAll('.tab-btn').forEach(b => {
      const t = norm(b.textContent);
      if (HELP_TEXT_BY_TAB[t]) addHelpTo(b, HELP_TEXT_BY_TAB[t]);
    });

    document.querySelectorAll('.u-tab-btn').forEach(b => {
      const t = norm(b.textContent).toUpperCase();
      if (HELP_TEXT_BY_TAB[t]) addHelpTo(b, HELP_TEXT_BY_TAB[t]);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply);
  } else {
    apply();
  }
})();
</script>

</body>
</html>
