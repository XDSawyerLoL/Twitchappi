<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V10.2 - Full Features</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- VARIABLES CSS (R√©tablies √† la version stable) --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-ai-action: #e34a64; 
            --color-text-dimmed: #9aa3a8;
        }

        /* Classes utilitaires */
        .neon-border {
            border: 1px solid var(--color-primary-pink);
            box-shadow: 0 0 5px var(--color-primary-pink), 0 0 10px var(--color-primary-pink);
        }
        .bg-gradient-pink-blue {
            background-image: linear-gradient(to right, var(--color-primary-pink), var(--color-secondary-blue));
        }
        .btn-primary {
            background-color: var(--color-primary-pink);
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--color-primary-pink);
        }
        .btn-primary:hover {
            background-color: #ff33b1;
            box-shadow: 0 0 10px #ff33b1;
        }
        .stream-live-indicator {
            background-color: red;
            box-shadow: 0 0 5px red;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .ai-title {
            color: var(--color-secondary-blue);
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 2px var(--color-secondary-blue);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(34, 199, 239, 0.2);
            padding-bottom: 0.25rem;
        }
        .ai-content p, .ai-content ul {
            color: var(--color-text-dimmed);
            line-height: 1.6;
        }
        .ai-content strong {
            color: #fff;
        }
        .ai-content h4 {
            color: var(--color-ai-niche);
            font-family: 'Orbitron', sans-serif;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        /* Style des boutons d'action IA */
        .ai-action-btn {
            background-color: var(--color-bg-medium);
            border: 1px solid var(--color-ai-action);
            color: var(--color-ai-action);
            transition: all 0.2s ease;
        }
        .ai-action-btn:hover:not(:disabled) {
            background-color: var(--color-ai-action);
            color: var(--color-bg-dark);
            box-shadow: 0 0 8px var(--color-ai-action);
        }
        
        /* Ajustement de la largeur pour l'harmonie */
        .grid-cols-custom {
             grid-template-columns: minmax(300px, 1fr) 350px; /* Largeur fixe de 350px pour la colonne de droite */
        }
        @media (min-width: 1024px) {
            .grid-cols-custom {
                 grid-template-columns: minmax(600px, 1fr) 350px; /* Conserve 350px */
            }
        }
        
        #followed-streams-list a {
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
        }
        #followed-streams-list a:hover {
             background-color: #2a2a2a;
        }
        .tab-btn {
             color: var(--color-text-dimmed);
             border-bottom-color: transparent !important;
        }
        .tab-btn.active-tab {
             color: white;
             border-bottom-color: var(--color-secondary-blue) !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-inter p-4 lg:p-8" onload="checkAuth()">

    <header class="mb-8">
        <h1 class="text-3xl font-bold text-center font-orbitron text-white neon-border py-3 rounded-lg bg-gray-800">
            <i class="fas fa-satellite-dish mr-3" style="color:var(--color-primary-pink);"></i> Streamer & Niche AI Hub <i class="fas fa-brain ml-3" style="color:var(--color-secondary-blue);"></i>
        </h1>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-custom gap-8">
        
        <div class="col-span-1">
            
            <div id="twitch-player-container" class="bg-gray-800 p-4 rounded-lg neon-border mb-8">
                <h2 class="text-xl font-bold mb-3 font-orbitron text-white">
                    üì∫ Lecteur <span id="current-channel-display" class="text-lg text-yellow-400">...</span>
                </h2>
                <div id="twitch-embed" class="w-full" style="height: 393px;">
                    </div>
                
                <div class="flex justify-between items-center mt-3" id="twitch-player-share">
                    <button class="bg-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-600 transition" 
                            data-platform="Twitch" data-share-url="" data-channel="">
                        <i class="fab fa-twitch mr-1"></i> Regarder
                    </button>
                    <button class="bg-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-600 transition" 
                            data-platform="VOD" data-share-url="" data-channel="">
                        <i class="fas fa-video mr-1"></i> Derni√®re VOD
                    </button>
                    <button id="raid-target-btn" class="bg-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-600 transition ai-action-btn" disabled
                            data-platform="Raid" data-share-url="" data-channel="">
                        <i class="fas fa-rocket mr-1"></i> üöÄ RAID AL√âATOIRE
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg neon-border">
                <h2 class="text-xl font-bold mb-4 font-orbitron text-white">
                    üî¨ Outils d'Analyse Niche & Croissance
                </h2>
                
                <form id="scan-form" class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" id="scan-query" placeholder="Jeu, Streamer ou Th√®me √† analyser (ex: Elden Ring, Ninja, Art)"
                           class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-var(--color-primary-pink) focus:ring focus:ring-var(--color-primary-pink) focus:ring-opacity-50" required>
                    <button type="submit" id="scan-btn" class="btn-primary p-3 rounded-lg font-semibold whitespace-nowrap">
                        <i class="fas fa-search"></i> Scanner la Cible
                    </button>
                </form>

                <div id="scan-report" class="bg-gray-700 p-4 rounded-lg border border-gray-600 mb-4" style="display:none;">
                    <h3 class="text-lg font-bold mb-2 font-orbitron text-white">
                        <i class="fas fa-chart-line mr-2" style="color:var(--color-ai-niche);"></i> Rapport et Actions (Cible: <span id="current-scan-target" class="text-yellow-400">...</span>)
                    </h3>
                    <div id="scan-metrics" class="text-sm mb-4">
                        </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <button class="ai-action-btn px-4 py-2 rounded-lg text-sm" data-action="strategie" data-type="game" data-desc="Strat√©gie de Niche & Croissance" disabled>
                            <i class="fas fa-sitemap mr-1" style="color:var(--color-ai-growth);"></i> Strat√©gie
                        </button>
                        <button class="ai-action-btn px-4 py-2 rounded-lg text-sm" data-action="repurpose" data-type="user" data-desc="Id√©es Repurpose (Clips)" disabled>
                            <i class="fas fa-cut mr-1" style="color:var(--color-ai-repurpose);"></i> Repurpose
                        </button>
                        <button class="ai-action-btn px-4 py-2 rounded-lg text-sm" data-action="boost" data-type="user" data-desc="Simuler un Boost Algorithmique" disabled>
                             <i class="fas fa-tachometer-alt mr-1" style="color:var(--color-primary-pink);"></i> Stream Boost
                        </button>
                    </div>
                </div>

                <div id="ai-result-box" class="bg-gray-700 p-4 rounded-lg border border-gray-600 min-h-[50px]">
                    <p class="text-center text-gray-500">Lancez une recherche pour afficher le rapport de l'IA.</p>
                    </div>
            </div>
            
        </div>

        <div class="col-span-1 w-full lg:w-[350px]"> 
            
            <div id="auth-status-box" class="bg-gray-800 p-4 rounded-lg neon-border mb-8">
                <h2 class="text-xl font-bold mb-3 font-orbitron text-white">
                    <i class="fas fa-key mr-2" style="color:var(--color-primary-pink);"></i> üîë MON FIL SUIVI
                </h2>
                
                <div id="auth-content">
                    <p class="text-center text-gray-500">V√©rification de l'√©tat...</p>
                </div>
            </div>

            <div id="user-tabs-container" class="bg-gray-800 p-4 rounded-lg neon-border">
                <div class="flex border-b border-gray-700 mb-3">
                    <button id="tab-followed-btn" class="tab-btn px-4 py-2 text-sm font-semibold border-b-2 transition" onclick="openTab('tab-followed')">
                        <i class="fas fa-video mr-1"></i> Streams LIVE Suivis
                    </button>
                    <button id="tab-trending-btn" class="tab-btn px-4 py-2 text-sm font-semibold border-b-2 transition" onclick="openTab('tab-trending')">
                        <i class="fas fa-fire mr-1"></i> Top Jeux
                    </button>
                </div>

                <div id="tab-followed-content" class="tab-content">
                    <div id="followed-streams-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                        <p class="text-center text-gray-500 p-4">Connectez-vous pour voir votre fil suivi.</p>
                    </div>
                </div>

                <div id="tab-trending-content" class="tab-content hidden">
                    <div id="trending-games-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                         <p class="text-center text-gray-500 p-4">Chargement des jeux en tendance...</p>
                    </div>
                </div>
            </div>
            
        </div>
        
    </main>

<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitchdev'; // Streamer par d√©faut
    let twitchPlayer;
    let currentChannel = DEFAULT_CHANNEL;
    let currentScanType = null;
    let currentScanQuery = null;
    let authChecked = false;

    // --- 1. Initialisation du Lecteur Twitch ---
    window.launchPlayer = function(channel, videoID = null) {
        currentChannel = channel;
        document.getElementById('current-channel-display').textContent = channel;
        
        // Mettre √† jour les URLs de partage
        document.querySelector('#twitch-player-share [data-platform="Twitch"]').dataset.shareUrl = `https://twitch.tv/${channel}`;
        document.querySelector('#twitch-player-share [data-platform="Twitch"]').dataset.channel = channel;
        document.querySelector('#twitch-player-share [data-platform="VOD"]').dataset.channel = channel;
        
        // Supprimer l'ancien lecteur s'il existe
        const embedDiv = document.getElementById('twitch-embed');
        embedDiv.innerHTML = '';
        
        const options = {
            width: '100%',
            height: '100%',
            channel: channel,
            parent: [window.location.hostname, 'localhost'],
            layout: 'video', 
            theme: 'dark'
        };
        
        if (videoID) {
            delete options.channel;
            options.video = videoID;
        }

        twitchPlayer = new Twitch.Player('twitch-embed', options);
        twitchPlayer.addEventListener(Twitch.Player.READY, () => {
             console.log(`Lecteur Twitch pr√™t pour ${channel}`);
        });
        
        // Charger la derni√®re VOD pour le bouton
        loadLatestVOD(channel);
        localStorage.setItem('activeChannel', channel);
    };

    // --- 2. Fonction de Partage / VOD / Raid ---
    async function loadLatestVOD(channel) {
        const vodBtn = document.querySelector('#twitch-player-share [data-platform="VOD"]');
        vodBtn.textContent = 'Chargement VOD...';
        vodBtn.disabled = true;
        
        try {
            const res = await fetch(`${API_BASE}/get_latest_vod?channel=${channel}`);
            const data = await res.json();
            
            if (data.success && data.vod) {
                vodBtn.textContent = '‚ñ∂Ô∏è Derni√®re VOD';
                vodBtn.dataset.shareUrl = data.vod.id; 
                vodBtn.onclick = () => window.launchPlayer(channel, data.vod.id);
            } else {
                 vodBtn.textContent = '‚ùå VOD Non Trouv√©e';
                 vodBtn.onclick = null;
            }
        } catch(e) {
            vodBtn.textContent = '‚ùå Erreur VOD';
        } finally {
            vodBtn.disabled = false;
        }
    }

    function shareLinkContent(platform, url, channel) {
        if (platform === 'Twitch') {
            window.open(url, '_blank');
        } else if (platform === 'Raid') {
            // Logique de Raid g√©r√©e par le bouton dans l'√©couteur du DOMContentLoaded
            // Le clic est g√©r√© par l'√©v√©nement global
        }
    }

    // --- 3. Gestion de l'Authentification ---
    async function checkAuth() {
        if (authChecked) return;
        authChecked = true;
        
        const authContent = document.getElementById('auth-content');
        const followedStreamsList = document.getElementById('followed-streams-list');

        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();
            
            if (data.is_connected) {
                authContent.innerHTML = `
                    <p class="text-lg font-semibold text-white mb-2">Connect√©(e) en tant que: <span style="color:var(--color-secondary-blue);">${data.display_name}</span></p>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-full transition">
                        <i class="fas fa-sign-out-alt mr-2"></i> D√©connexion
                    </button>
                `;
                loadFollowedStreams();
            } else {
                authContent.innerHTML = `
                    <a href="${API_BASE}/twitch_auth_start" class="btn-primary py-3 px-4 rounded-lg font-semibold block text-center transition">
                        <i class="fab fa-twitch mr-2"></i> SE CONNECTER VIA TWITCH
                    </a>
                `;
                 followedStreamsList.innerHTML = '<p class="text-center text-gray-500 p-4">Connectez-vous pour voir votre fil suivi.</p>';
            }
        } catch(e) {
             authContent.innerHTML = `<p style="color:red; text-align:center;">‚ùå Erreur serveur: Impossible de v√©rifier l'√©tat.</p>`;
        }
    }

    async function logout() {
        await fetch(`${API_BASE}/twitch_logout`, { method: 'POST' });
        authChecked = false; 
        checkAuth();
    }

    // --- 4. Chargement des Streams Suivis ---
    async function loadFollowedStreams() {
        const followedStreamsList = document.getElementById('followed-streams-list');
        followedStreamsList.innerHTML = '<p style="text-align:center; color:#555; padding:10px;">Chargement des streams LIVE...</p>';

        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();
            
            if (!res.ok || !data.success) { 
                const errorMessage = data.error || `Erreur serveur lors de la r√©cup√©ration du fil: Statut ${res.status}`;
                throw new Error(errorMessage);
            }

            if (data.streams.length === 0) {
                 followedStreamsList.innerHTML = '<p class="text-center text-yellow-400 p-4">Aucun stream suivi n\'est LIVE pour le moment.</p>';
                 return;
            }

            followedStreamsList.innerHTML = data.streams.map(stream => `
                <a href="#" onclick="window.launchPlayer('${stream.user_login}'); return false;" class="flex items-center hover:bg-gray-700 transition">
                    <span class="w-2 h-2 rounded-full stream-live-indicator mr-2"></span>
                    <img src="${stream.thumbnail_url.replace('{width}', '60').replace('{height}', '45')}" 
                         alt="Thumbnail" class="w-10 h-8 object-cover rounded mr-3">
                    <div class="flex-grow">
                        <p class="text-sm font-semibold text-white truncate">${stream.user_name}</p>
                        <p class="text-xs text-gray-400 truncate">${stream.game_name}</p>
                    </div>
                    <span class="text-xs text-var(--color-primary-pink) font-bold whitespace-nowrap">
                        ${stream.viewer_count.toLocaleString('fr-FR')} <i class="fas fa-eye ml-1"></i>
                    </span>
                </a>
            `).join('');

        } catch (error) {
            let errorMessage = error.message;
            if (errorMessage.includes("Veuillez vous reconnecter via Twitch")) {
                errorMessage += " (Token expir√©)";
                authChecked = false; 
                checkAuth();
            }
            followedStreamsList.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå Erreur de chargement du fil: ${errorMessage}</p>`;
        }
    }

    // --- 5. Chargement des Jeux en Tendance ---
    async function loadTrendingGames() {
        const trendingGamesList = document.getElementById('trending-games-list');
        trendingGamesList.innerHTML = '<p style="text-align:center; color:#555; padding:10px;">Chargement des jeux...</p>';

        try {
            const res = await fetch(`${API_BASE}/trending_games`);
            const data = await res.json();
            
            if (!data.success) {
                 throw new Error(data.error || "√âchec de la r√©cup√©ration des jeux.");
            }

            trendingGamesList.innerHTML = data.games.map(game => `
                <a href="#" onclick="document.getElementById('scan-query').value='${game.name.replace(/'/g, "\\'")}', document.getElementById('scan-btn').click(); return false;" class="flex items-center hover:bg-gray-700 transition p-2 rounded-lg">
                    <img src="${game.box_art_url.replace('{width}', '60').replace('{height}', '80')}" 
                         alt="Box Art" class="w-8 h-10 object-cover rounded mr-3">
                    <p class="text-sm font-semibold text-white">${game.name}</p>
                </a>
            `).join('');

        } catch (error) {
            trendingGamesList.innerHTML = `<p style="color:red; text-align:center; padding:10px;">‚ùå Erreur: ${error.message}</p>`;
        }
    }


    // --- 6. Gestion des Onglets ---
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('text-white'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('text-gray-400'));

        document.getElementById(`${tabName}-content`).classList.remove('hidden');
        document.getElementById(`${tabName}-btn`).classList.add('active-tab', 'text-white');
        document.getElementById(`${tabName}-btn`).classList.remove('text-gray-400');
        
        localStorage.setItem('activeTab', tabName);

        if (tabName === 'tab-trending' && document.getElementById('trending-games-list').childElementCount <= 1) {
            loadTrendingGames();
        }
    }

    // --- 7. Scan et Actions IA ---
    document.getElementById('scan-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = document.getElementById('scan-query').value.trim();
        if (!query) return;

        const scanBtn = document.getElementById('scan-btn');
        const resultBox = document.getElementById('ai-result-box');
        const reportBox = document.getElementById('scan-report');
        const metricsBox = document.getElementById('scan-metrics');
        const targetDisplay = document.getElementById('current-scan-target');
        const raidBtn = document.getElementById('raid-target-btn');
        const actionBtns = document.querySelectorAll('.ai-action-btn');

        scanBtn.disabled = true;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse en cours...';
        resultBox.innerHTML = '<p class="text-center text-gray-500 p-4"><i class="fas fa-spinner fa-spin mr-2"></i> L\'IA analyse la cible...</p>';
        reportBox.style.display = 'none';
        
        // D√©sactiver tous les boutons d'action
        actionBtns.forEach(btn => btn.disabled = true);
        raidBtn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const data = await res.json();

            if (!data.success) {
                resultBox.innerHTML = data.html_response || `<p style="color:red; text-align:center;">‚ùå ${data.message || data.error}</p>`;
                return;
            }
            
            // Mise √† jour de l'√©tat global
            currentScanType = data.type;
            currentScanQuery = data.type === 'game' ? data.game_name : data.user_login;
            
            // Affichage des r√©sultats
            targetDisplay.textContent = currentScanQuery;
            resultBox.innerHTML = data.html_response;
            reportBox.style.display = 'block';
            
            // Mise √† jour des m√©triques (simplifi√©)
            if (data.type === 'game') {
                metricsBox.innerHTML = `<p>Jeu d√©tect√©. Streams LIVE scann√©s: <strong>${data.total_streams}</strong>. Vues Totales: <strong>${data.total_viewers.toLocaleString('fr-FR')}</strong>. Ratio Vues/Streamer: <strong>${data.viewer_streamer_ratio}</strong>.</p>`;
            } else if (data.type === 'user') {
                metricsBox.innerHTML = `<p>Streamer d√©tect√©: <strong>${data.display_name}</strong>. Vues actuelles (si live): <strong>${data.simulated_metrics.average_viewers}</strong>. R√©tention Estim√©e: <strong>${data.simulated_metrics.retention_simulee}%</strong>.</p>`;
                window.launchPlayer(data.user_login);
            }
            
            // R√©activer les boutons d'action pertinents
            actionBtns.forEach(btn => {
                const requiredType = btn.dataset.type;
                if (requiredType === 'game' && data.type === 'game') {
                    btn.disabled = false;
                } else if (requiredType === 'user' && data.type === 'user') {
                    btn.disabled = false;
                }
            });
            
            // R√©activer le bouton Raid si c'est un jeu
            if (data.type === 'game') {
                raidBtn.disabled = false;
                raidBtn.innerHTML = `<i class="fas fa-rocket mr-1"></i> üöÄ RAID AL√âATOIRE (${data.game_name})`;
            }

        } catch (error) {
            const errorMessage = error.message.includes('Unexpected token') ? "Erreur de format de l'API (pas de JSON). L'API est probablement HS." : error.message;
            resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå Erreur de Scan: ${errorMessage}</p>`;
            reportBox.style.display = 'none';
        } finally {
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<i class="fas fa-search"></i> Scanner la Cible';
        }
    });

    // √âcouteur pour les boutons d'action IA (Strat√©gie, Repurpose, Boost)
    document.getElementById('scan-report').addEventListener('click', async function(e) {
        const btn = e.target.closest('.ai-action-btn');
        if (!btn || btn.id === 'raid-target-btn' || btn.disabled) return;
        
        const action = btn.dataset.action;
        const desc = btn.dataset.desc;
        
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        
        const resultBox = document.getElementById('ai-result-box');
        resultBox.innerHTML = `<p class="text-center text-gray-500 p-4"><i class="fas fa-spinner fa-spin mr-2"></i> ${desc} en cours...</p>`;

        try {
            const endpoint = action === 'boost' ? `${API_BASE}/stream_boost` : `${API_BASE}/critique_ia`;
            const payload = action === 'boost' ? { channel: currentScanQuery } : { type: action, query: currentScanQuery };
            
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.success) {
                resultBox.innerHTML = data.html_response;
            } else {
                 resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå Erreur ${desc}: ${data.error || data.message}</p>`;
            }

        } catch (error) {
             resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå Erreur r√©seau: ${error.message}</p>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // --- 8. Logique du Raid Al√©atoire ---
    async function launchRaidTarget(game_name) {
        if (!game_name) return;
        
        const raidBtn = document.getElementById('raid-target-btn');
        const resultBox = document.getElementById('ai-result-box');
        
        raidBtn.disabled = true;
        raidBtn.innerHTML = `<i class="fas fa-search fa-spin"></i> Cible en cours...`;
        resultBox.innerHTML = `<p class="text-center text-gray-500 p-4"><i class="fas fa-search fa-spin mr-2"></i> Recherche d'une cible de raid dans ${game_name}...</p>`;

        try {
            const res = await fetch(`${API_BASE}/random_raid_target?game_name=${encodeURIComponent(game_name)}`);
            const data = await res.json();

            if (data.success && data.raid_target) {
                const target = data.raid_target;
                
                resultBox.innerHTML = `
                    <div class="p-4 bg-gray-600 rounded-lg shadow-lg">
                        <h4 class="ai-title">üéâ CIBLE DE RAID AL√âATOIRE TROUV√âE !</h4>
                        <p class="text-white">
                            Streamer : <strong>${target.display_name}</strong> (dans le jeu ${game_name})<br>
                            Vues Actuelles : <strong>${target.viewer_count.toLocaleString('fr-FR')}</strong>
                        </p>
                        <a href="https://twitch.tv/${target.user_login}" target="_blank" class="mt-3 btn-primary py-2 px-4 rounded-lg font-semibold block text-center transition">
                            <i class="fas fa-paper-plane mr-2"></i> Lancer le Raid vers ${target.display_name}
                        </a>
                        <p class="text-xs text-gray-400 mt-2">N'oubliez pas d'utiliser la commande /raid sur votre propre cha√Æne Twitch.</p>
                    </div>
                `;
            } else {
                 resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå √âchec du Raid Al√©atoire: ${data.error || 'Aucun streamer trouv√© pour le raid.'}</p>`;
            }
        } catch (error) {
             resultBox.innerHTML = `<p style="color:red; text-align:center;">‚ùå Erreur r√©seau lors de la recherche de raid: ${error.message}</p>`;
        } finally {
            // Remet le bouton dans son √©tat post-scan
            raidBtn.disabled = false;
            raidBtn.innerHTML = `<i class="fas fa-rocket mr-1"></i> üöÄ RAID AL√âATOIRE (${currentScanQuery})`;
        }
    }


    // --- 9. Initialisation et √âcouteur des Boutons ---
    document.addEventListener('DOMContentLoaded', function() {
        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        window.launchPlayer(lastChannel); 

        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        
        checkAuth();
        
        // √âcouteur pour les boutons du Player (Regarder, VOD, RAID)
        document.getElementById('twitch-player-share').addEventListener('click', function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const platform = btn.dataset.platform;
            const url = btn.dataset.shareUrl;
            const channel = btn.dataset.channel;

            if (platform === 'Twitch' || platform === 'VOD') {
                // Utiliser la fonction de base pour les liens Twitch
                shareLinkContent(platform, url, channel);
            } else if (platform === 'Raid') {
                // Lancer la fonction de recherche de raid si le bouton est activ√©
                if (!btn.disabled && currentScanType === 'game' && currentScanQuery) {
                    launchRaidTarget(currentScanQuery);
                } else if (!currentScanQuery) {
                     alert("Veuillez scanner un jeu valide (via la barre de recherche) pour activer le Raid Al√©atoire.");
                }
            }
        });
    });
</script>
</body>
</html>
