<script>
    // Variables globales
    const BACKEND_URL = ''; // Laisse vide pour utiliser le m√™me h√¥te
    const DEFAULT_CHANNEL = 'twitch'; // Cha√Æne par d√©faut si non connect√©

    let playerInstance = null; // Instance du lecteur Twitch
    let currentVODTitle = ''; // Pour passer le titre VOD au repurposing

    // =========================================================
    // 1. GESTION DES ONGLETS & AFFICHAGE
    // =========================================================
    
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-b-2', 'border-white', 'text-white');
            btn.classList.add('text-gray-400', 'hover:text-white');
        });
        const activeBtn = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
        if (activeBtn) {
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('border-b-2', 'border-white', 'text-white');
        }
        localStorage.setItem('activeTab', tabName);
        
        if (tabName === 'tab-followed') loadFollowedStreams();
    }
    
    // =========================================================
    // 2. AUTHENTIFICATION TWITCH
    // =========================================================

    async function checkAuth() {
        const authElement = document.getElementById('auth-status');
        try {
            const response = await fetch(BACKEND_URL + '/twitch_user_status');
            const data = await response.json();

            if (data.is_connected) {
                authElement.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <img src="${data.profile_image_url}" class="w-8 h-8 rounded-full shadow-neon-blue">
                        <span class="text-sm font-semibold text-white">${data.display_name}</span>
                        <button onclick="logout()" class="ml-4 text-xs text-red-500 hover:text-red-400">D√©connexion</button>
                    </div>
                `;
                document.getElementById('profile-info-display').classList.remove('hidden');
                document.getElementById('login-prompt').classList.add('hidden');
                document.getElementById('profile-channel-name').value = data.username;
                loadProfileStats(data.username);
            } else {
                authElement.innerHTML = `
                    <button onclick="window.location.href='/twitch_auth_start'" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-purple-900/50 transition">
                        <i class="fab fa-twitch mr-2"></i> Connexion Twitch
                    </button>
                `;
                document.getElementById('profile-info-display').classList.add('hidden');
                document.getElementById('login-prompt').classList.remove('hidden');
            }
        } catch (e) {
            authElement.innerHTML = `<span class="text-red-500">Erreur r√©seau</span>`;
        }
    }

    async function logout() {
        await fetch(BACKEND_URL + '/twitch_logout', { method: 'POST' });
        checkAuth();
    }

    // =========================================================
    // 3. AFFICHAGE DES R√âSULTATS IA ‚úÖ MISE √Ä JOUR MAJEURE
    // =========================================================

    // Variable pour stocker le graphique pour pouvoir le d√©truire
    let nicheChartInstance = null;
    
    /**
     * G√®re l'affichage des donn√©es IA consolid√©es (Niche ou Repurpose).
     * @param {object} data - Le JSON riche renvoy√© par le serveur.
     * @param {string} type - 'niche' ou 'repurpose'.
     */
    function displayConsolidatedAnalysis(data, type) {
        const score = data.score_niche;
        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        
        // --- 1. CONFIGURATION DE BASE ET DU VERDICT ---
        document.getElementById('verdict-ia').innerHTML = `
            <p class="text-xl text-white font-semibold mb-2">${data.verdict}</p>
            <p class="text-sm text-gray-400"><strong class="text-pink-neon">Persona Viewer:</strong> ${data.viewer_persona}</p>
        `;

        // --- 2. AFFICHAGE DU SCORE (JAUGE) ---
        const color = score < 30 ? '#ff0099' : (score < 70 ? '#ffcc00' : '#59d682');
        document.getElementById('gauge-score-text').textContent = score;
        document.getElementById('gauge-score-text').style.color = color;

        // D√©truire l'ancienne instance avant d'en cr√©er une nouvelle
        if (nicheChartInstance) {
            nicheChartInstance.destroy();
        }

        const ctx = document.getElementById('nicheScoreGauge').getContext('2d');
        nicheChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [color, 'rgba(255, 255, 255, 0.1)'],
                    borderWidth: 0
                }]
            },
            options: {
                rotation: 270, circumference: 180, cutout: '80%', responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
            }
        });
        
        // --- 3. POINTS FORTS & ID√âES DE CONTENU ---
        document.getElementById('niche-strengths').innerHTML = data.points_forts.map(p => 
            `<li class="flex items-start text-sm"><span class="text-pink-neon mr-2">‚úÖ</span>${p}</li>`
        ).join('');
        
        document.getElementById('niche-ideas').innerHTML = data.content_ideas.map(i => 
            `<li class="flex items-start text-sm"><span class="text-secondary-blue mr-2">üí°</span>${i}</li>`
        ).join('');

        // --- 4. TITRE DISRUPTIF (Ajout du champ consolid√©) ---
        document.getElementById('disruptive-title-display').innerHTML = `
            <p class="text-xl font-orbitron text-white">${data.disruptive_title}</p>
            <span class="text-xs text-gray-500 mt-1">G√©n√©r√© par l'IA en une seule requ√™te.</span>
        `;
        
        // --- 5. GESTION DES CLIPS (Si type:repurpose) ---
        const repurposeSection = document.getElementById('repurpose-section-display');
        
        if (type === 'repurpose' && data.viral_clips && data.viral_clips.length > 0) {
            let clipHTML = `
                <h3 class="text-lg font-bold text-ai-repurpose mb-3 border-b border-gray-700 pb-2">Clips Viraux Sugg√©r√©s pour "${currentVODTitle}"</h3>
                <ul class="space-y-3">
            `;
            data.viral_clips.forEach(clip => {
                clipHTML += `
                    <li class="bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-sm">
                        <p class="text-base font-semibold text-white mb-1">${clip.title}</p>
                        <p class="text-sm text-gray-400"><strong><span class="text-pink-neon">Est. Temps:</span> ${clip.time_guess}</strong></p>
                        <p class="text-xs text-gray-500 mt-1">${clip.reason}</p>
                        <button onclick="copyToClipboard('${clip.time_guess}')" class="timestamp-link bg-ai-repurpose hover:bg-opacity-80 mt-2">Copier le Timestamp</button>
                    </li>
                `;
            });
            clipHTML += '</ul>';
            repurposeSection.innerHTML = clipHTML;
        } else if (type === 'repurpose') {
             repurposeSection.innerHTML = `<p class="text-gray-500">Aucune suggestion de clip n'a pu √™tre g√©n√©r√©e pour cette VOD.</p>`;
        } else {
            repurposeSection.innerHTML = ''; // Cacher si c'est une analyse de niche
        }

        reportBox.classList.remove('hidden');
        resultBox.innerHTML = '';
    }
    
    /**
     * G√®re l'affichage des r√©sultats de Tendance.
     * @param {object} data - Le JSON riche de Tendance.
     */
    function displayTrendAnalysis(data) {
        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        
        // On masque les cartes de niche/repurpose car le trend a un format diff√©rent
        reportBox.classList.add('hidden'); 
        
        resultBox.innerHTML = `
            <div class="p-6 rounded-lg bg-gray-900 border border-ai-growth shadow-neon-yellow">
                <h2 class="text-2xl font-orbitron text-ai-growth mb-4">üìà Analyse de Tendance IA</h2>
                <div class="space-y-4">
                    <p class="text-white text-lg"><strong class="text-ai-growth">Top Opportunit√©:</strong> ${data.top_opportunity}</p>
                    <p class="text-gray-400"><strong>Pourquoi :</strong> ${data.why}</p>
                    <p class="text-gray-400"><strong>Saturation:</strong> ${data.saturation_level}%</p>
                    
                    <h3 class="text-lg font-semibold text-white mt-4">Jeux Sous le Radar</h3>
                    <ul class="list-disc list-inside text-gray-300 ml-4 space-y-1">
                        ${data.under_radar_games.map(g => `<li>${g}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    // =========================================================
    // 4. LOGIQUE D'APPEL SERVEUR
    // =========================================================

    /**
     * Lance l'analyse IA (Niche, Repurpose, ou Trend)
     */
    document.getElementById('ai-analysis-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const type = document.querySelector('input[name="analysis_type"]:checked').value;
        const queryInput = document.getElementById('analysis_query');
        const query = queryInput.value.trim();
        
        const resultBox = document.getElementById('ai-report-result');
        const reportBox = document.getElementById('ai-report-display');
        const btn = document.querySelector('#ai-analysis-form button[type="submit"]');

        if (type !== 'trend' && !query) {
            resultBox.innerHTML = '<p class="text-red-500 text-center">Veuillez entrer une requ√™te.</p>';
            return;
        }
        
        // Pour Repurpose, on sauvegarde le titre VOD pour l'affichage des clips
        if (type === 'repurpose') {
            currentVODTitle = query;
            document.getElementById('repurpose-section-display').innerHTML = ''; // Nettoyer l'ancienne section clip
        }

        btn.disabled = true;
        resultBox.innerHTML = '<div class="text-center"><span class="text-lg text-ai-niche animate-pulse">Analyse IA consolid√©e en cours... üß†</span></div>';
        reportBox.classList.add('hidden'); 

        try {
            const response = await fetch(BACKEND_URL + '/critique_ia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, query })
            });

            const result = await response.json();

            if (result.success && result.data) {
                if (type === 'trend') {
                    displayTrendAnalysis(result.data);
                } else {
                    displayConsolidatedAnalysis(result.data, type);
                }
            } else {
                let errorMessage = result.error || 'Probl√®me inconnu.';
                if (response.status === 429) {
                    errorMessage = `Code 429: Trop de requ√™tes (Quota IA d√©pass√©). V√©rifiez votre console Google Cloud. D√©tail: ${result.error.message.substring(0, 100)}...`;
                } else if (response.status === 500 && errorMessage.includes("invalid character")) {
                     errorMessage = "Erreur serveur IA: L'IA a renvoy√© un format illisible (non-JSON) au lieu des donn√©es JSON.";
                } else if (errorMessage.includes("Failed to fetch")) {
                    errorMessage = "√âchec de la connexion au serveur (r√©seau coup√© ou API non d√©marr√©e).";
                }
                
                resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur serveur IA: ${errorMessage}</p>`;
                reportBox.style.display = 'none';
            }
        } catch (e) {
            resultBox.innerHTML = `<p style="color:var(--color-ai-action); font-weight:bold; text-align:center;">‚ùå Erreur r√©seau: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // =========================================================
    // 5. AUTRES FONCTIONS (Boost, Profile, etc.)
    // =========================================================

    async function runStreamBoost() {
        const status = document.getElementById('boost-status');
        status.innerHTML = '<p class="text-center text-ai-niche animate-pulse">Activation du Boost et recherche de Raid en cours...</p>';
        
        try {
            const response = await fetch(BACKEND_URL + '/stream_boost', { method: 'POST' });
            const result = await response.json();
            
            // Le serveur renvoie directement le HTML
            status.innerHTML = result.html_response;
            
            if(result.raidCandidate) {
                const c = result.raidCandidate;
                status.innerHTML += `<div class="p-3 rounded mt-3 bg-gray-800 border border-gray-700 shadow-neon-blue">
                    <p class="text-lg font-semibold text-white">Partenaire sugg√©r√© : ${c.user_name}</p>
                    <p class="text-sm text-gray-400">Viewers: ${c.viewer_count} | <a href="[https://twitch.tv/$](https://twitch.tv/$){c.user_login}" target="_blank" class="text-secondary-blue hover:text-white">Voir la cha√Æne</a></p>
                    <button onclick="copyToClipboard('/raid ${c.user_login}')" class="bg-[#ff0099] hover:bg-opacity-80 text-white p-2 rounded mt-2 text-sm">Copier Commande de Raid</button>
                </div>`;
            }
            
        } catch (e) {
            status.innerHTML = `<p class="text-red-500 text-center">Erreur Boost: ${e.message}</p>`;
        }
    }
    
    async function loadProfileStats(username) {
        const display = document.getElementById('profile-info-display');
        display.innerHTML = '<p class="text-center text-gray-500">Chargement des statistiques...</p>';

        try {
            // Note: Nous n'avons pas cr√©√© de route consolid√©e pour le profil, donc deux appels s√©par√©s
            const profileRes = await fetch(BACKEND_URL + '/my_profile_stats');
            const profileData = await profileRes.json();
            
            if (profileData.success) {
                const stats = profileData.stats;
                const playerContainer = document.getElementById('twitch-player-container');
                playerContainer.innerHTML = `<iframe src="https://player.twitch.tv/?channel=${username}&parent=${window.location.hostname}&muted=false&autoplay=true" height="100%" width="100%" allowfullscreen class="rounded-lg shadow-neon-blue"></iframe>`;
                
                // Affichage des stats (simplifi√©)
                display.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <img src="${stats.avatar}" class="w-16 h-16 rounded-full border-2 border-pink-neon shadow-neon-pink">
                        <div>
                            <h3 class="text-xl font-orbitron text-white">${stats.display_name}</h3>
                            <p class="text-sm text-gray-400">${stats.broadcaster_type || 'Streamer Standard'}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xl font-bold text-pink-neon">${stats.follower_count}</p>
                            <p class="text-xs text-gray-400">Followers</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xl font-bold text-secondary-blue">${stats.view_count}</p>
                            <p class="text-xs text-gray-400">Vues Totales</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xl font-bold text-ai-niche">${stats.sub_count}</p>
                            <p class="text-xs text-gray-400">Subs</p>
                        </div>
                    </div>
                `;
            }
        } catch (e) {
            display.innerHTML = `<p class="text-red-500 text-center">Erreur de chargement des stats: ${e.message}</p>`;
        }
    }
    
    async function loadFollowedStreams() {
        const listContainer = document.getElementById('followed-list-container');
        listContainer.innerHTML = '<p class="text-center text-gray-500">Chargement des streams suivis...</p>';
        try {
             const response = await fetch(BACKEND_URL + '/followed_streams');
             const result = await response.json();
             
             if(result.success && result.streams.length > 0) {
                 let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                 result.streams.forEach(s => {
                     html += `
                        <div class="bg-gray-800 p-3 rounded-lg flex items-center space-x-3 border border-gray-700">
                            <img src="${s.thumbnail_url.replace('{width}', '100').replace('{height}', '56')}" class="w-16 h-9 object-cover rounded">
                            <div class="flex-grow">
                                <p class="text-sm font-semibold text-white truncate">${s.user_name}</p>
                                <p class="text-xs text-gray-400 truncate">${s.title}</p>
                            </div>
                            <span class="text-xs text-red-500 font-bold flex-shrink-0"><i class="fas fa-eye mr-1"></i>${s.viewer_count}</span>
                        </div>
                     `;
                 });
                 html += '</div>';
                 listContainer.innerHTML = html;
             } else {
                 listContainer.innerHTML = '<p class="text-center text-gray-500">Aucun stream suivi en direct actuellement, ou non connect√©.</p>';
             }
        } catch (e) { listContainer.innerHTML = `<p class="text-red-500 text-center">Erreur: ${e.message}</p>`; }
    }
    
    // Utilitaires
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Copi√©: ' + text);
        }).catch(err => {
            console.error('Erreur de copie: ', err);
            alert("Erreur de copie (navigateur non pris en charge).");
        });
    }

    // --- Initialisation ---
    document.addEventListener('DOMContentLoaded', function() {
        openTab('tab-home'); // Ouvrir la page d'accueil
        checkAuth();
        
        // Attacher l'√©v√©nement au bouton Boost (pour r√©f√©rence)
        document.getElementById('boost-button').addEventListener('click', runStreamBoost);
    });

</script>
