<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V7.3 - Cat√©gories Recommand√©es</title>
    <link href="[https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap)" rel="stylesheet">
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <style>
        /* --- VARIABLES CSS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        body { 
            background-color: var(--color-bg-dark); 
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif;
            min-height: 100vh;
        }

        /* Effet N√©on pour les √©l√©ments cl√©s */
        .neon-text {
            color: var(--color-primary-pink);
            text-shadow: 0 0 5px var(--color-primary-pink), 0 0 10px var(--color-primary-pink);
            font-family: 'Orbitron', sans-serif;
        }

        /* Conteneur principal et cartes */
        .shadow-neon-pink {
            box-shadow: 0 0 5px var(--color-primary-pink);
        }
        .shadow-neon-blue {
            box-shadow: 0 0 5px var(--color-secondary-blue), 0 0 15px var(--color-secondary-blue);
        }

        /* Styles sp√©cifiques des onglets */
        .tab-button {
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            color: var(--color-secondary-blue);
            border-bottom: 3px solid var(--color-secondary-blue);
            text-shadow: 0 0 5px var(--color-secondary-blue);
        }
        .tab-content {
            border: 1px solid var(--color-border-medium);
        }
        
        /* Liste des streams suivis */
        .followed-stream-item {
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .followed-stream-item:hover {
            background-color: var(--color-border-dark);
            border-left: 3px solid var(--color-primary-pink);
        }

        /* Chat/Assistant styles */
        #assistant-msgs {
            max-height: 400px;
            overflow-y: auto;
            border-bottom: 1px solid var(--color-border-medium);
        }
        .msg {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .msg.user {
            background-color: var(--color-secondary-blue);
            color: var(--color-bg-dark);
            align-self: flex-end;
            margin-left: auto;
        }
        .msg.bot {
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-primary-pink);
            color: white;
            align-self: flex-start;
        }
        /* Style du scrollbar pour correspondre au th√®me n√©on */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-primary-pink);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-secondary-blue);
        }
    </style>
</head>
<body>

    <header class="p-4 bg-var(--color-bg-medium) border-b border-b-var(--color-border-dark)">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl neon-text">NicheOptimizer.ai</h1>
            <div id="auth-status" class="text-sm">
                <p class="text-var(--color-text-dimmed)">Statut: D√©connect√©</p>
                <button id="auth-button" class="mt-1 px-3 py-1 bg-var(--color-secondary-blue) text-var(--color-bg-dark) font-bold rounded hover:bg-opacity-80 transition-all">Connexion Twitch</button>
            </div>
        </div>
    </header>

    <main class="py-4">
        <div class="max-w-7xl mx-auto p-4">
            
            <div class="flex">
                <div id="player-column" class="w-2/3 pr-4">
                    <div id="player-container" class="aspect-video bg-var(--color-bg-medium) flex items-center justify-center border border-var(--color-border-medium) shadow-neon-blue">
                        <p class="text-lg text-var(--color-text-dimmed)">Lecteur Twitch (Lancez un Stream)</p>
                    </div>

                    <div class="mt-4 flex space-x-4">
                        <button id="boost-stream-btn" class="flex-1 px-4 py-2 bg-var(--color-primary-pink) text-white font-bold rounded shadow-neon-pink hover:opacity-90 transition-all disabled:opacity-50">
                            üöÄ Stream Boost (Cooldown 3h)
                        </button>
                        <div id="boost-result-box" class="flex-1 bg-var(--color-bg-medium) p-2 rounded text-sm flex items-center justify-center border border-var(--color-border-medium)">
                            Statut du Boost : Inactif
                        </div>
                    </div>
                </div>

                <div id="tabs-column" class="w-1/3 pl-4 flex flex-col">
                    <div class="bg-var(--color-bg-medium) rounded-lg shadow-neon-pink p-4 flex-grow flex flex-col">
                        
                        <div class="flex border-b border-b-var(--color-border-dark) mb-4">
                            <button class="tab-button px-4 py-2 text-white font-semibold active" onclick="openTab('tab-followed', this)">Streams Suivis</button>
                            <button class="tab-button px-4 py-2 text-white font-semibold" onclick="openTab('tab-scan', this)">Scan Niche/Streamer</button>
                            <button class="tab-button px-4 py-2 text-white font-semibold" onclick="openTab('tab-assistant', this)">Mini Assistant</button>
                        </div>

                        <div id="tab-content" class="flex-grow overflow-y-auto">

                            <div id="tab-followed" class="tab-pane active h-full">
                                <p id="followed-status" class="text-var(--color-text-dimmed) text-sm mb-4">Connectez-vous pour voir vos streams suivis en direct.</p>
                                <ul id="followed-list" class="space-y-2">
                                    </ul>
                            </div>

                            <div id="tab-scan" class="tab-pane h-full hidden">
                                <form id="scan-form" class="mb-4">
                                    <input type="text" id="scan-query" placeholder="Jeu (ex: 'Palworld') ou Streamer (ex: 'Squeezie')" 
                                           class="w-full p-2 rounded bg-var(--color-bg-dark) border border-var(--color-border-medium) focus:border-var(--color-secondary-blue) outline-none text-white">
                                    <button type="submit" class="mt-2 w-full px-4 py-2 bg-var(--color-secondary-blue) text-var(--color-bg-dark) font-bold rounded hover:bg-opacity-80 transition-all">
                                        Analyser
                                    </button>
                                </form>
                                <div class="flex space-x-2 mb-4">
                                    <button class="ia-critique-btn flex-1 px-3 py-2 text-xs text-white rounded bg-var(--color-ai-growth) hover:opacity-90" data-type="trend">
                                        Critique IA: Tendance Niche
                                    </button>
                                    <button class="ia-critique-btn flex-1 px-3 py-2 text-xs text-white rounded bg-var(--color-ai-niche) hover:opacity-90" data-type="niche">
                                        Critique IA: Saturation Jeu
                                    </button>
                                    <button class="ia-critique-btn flex-1 px-3 py-2 text-xs text-white rounded bg-var(--color-ai-repurpose) hover:opacity-90" data-type="repurpose">
                                        Critique IA: Repurposing
                                    </button>
                                </div>
                                <div id="scan-results" class="space-y-4 text-sm max-h-96 overflow-y-auto p-2 bg-var(--color-bg-dark) rounded border border-var(--color-border-dark)">
                                    </div>
                            </div>

                            <div id="tab-assistant" class="tab-pane h-full flex flex-col hidden">
                                <div id="assistant-msgs" class="flex flex-col flex-grow space-y-2 mb-4 p-2">
                                    <div class="msg bot">
                                        Bonjour ! Je suis Streamer Buddy. Je peux r√©pondre √† vos questions rapides sur Twitch, le marketing ou le contenu.
                                    </div>
                                </div>
                                <form id="assistant-form" class="mt-auto flex">
                                    <input type="text" id="assistant-input" placeholder="Posez votre question √† l'IA..." 
                                           class="flex-grow p-2 rounded-l bg-var(--color-bg-dark) border border-var(--color-primary-pink) focus:border-var(--color-secondary-blue) outline-none text-white">
                                    <button type="submit" class="px-4 py-2 bg-var(--color-primary-pink) text-var(--color-bg-dark) font-bold rounded-r hover:bg-opacity-80 transition-all">
                                        Envoyer
                                    </button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div> <div id="recommended-categories-section" class="mt-8">
                <h2 class="text-xl font-bold mb-4 text-white uppercase tracking-widest border-l-4 border-l-var(--color-primary-pink) pl-2">
                    üî• Cat√©gories Niche Recommand√©es (< 100 Viewers)
                </h2>
                <div id="recommended-categories-container" class="flex overflow-x-auto space-x-4 pb-4">
                    <p class="text-var(--color-secondary-blue)">Chargement des recommandations de niche...</p>
                    </div>
            </div>

        </div>
    </main>
    
    <script src="[https://embed.twitch.tv/embed/v1.js](https://embed.twitch.tv/embed/v1.js)"></script>

<script>
    const API_BASE = ''; // Laisser vide pour les appels sur le m√™me serveur

    let player;
    let currentChannel = localStorage.getItem('activeChannel') || 'twitch';
    
    // --- Initialisation du Lecteur Twitch ---
    function initializePlayer() {
        if (player) return; // √âvite la double initialisation

        player = new Twitch.Embed("player-container", {
            width: "100%",
            height: "100%",
            channel: currentChannel,
            layout: "video",
            theme: "dark"
        });
    }

    // --- Fonction de Lancement du Stream ---
    function launchPlayer(channelName) {
        if (player) {
            player.setChannel(channelName);
            localStorage.setItem('activeChannel', channelName);
            currentChannel = channelName; // Met √† jour la variable globale
            document.getElementById('player-container').classList.add('shadow-neon-blue');
        }
    }

    // --- Gestion des Onglets ---
    function openTab(tabId, element) {
        // Masquer tout le contenu des onglets
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.add('hidden');
        });
        // Rendre inactifs tous les boutons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Afficher l'onglet s√©lectionn√©
        document.getElementById(tabId).classList.remove('hidden');

        // Activer le bouton
        if (element) {
            element.classList.add('active');
        } else {
            // Si appel√© par le DOMContentLoaded, activer le bouton par d√©faut
            document.querySelector(`.tab-button[onclick*="${tabId}"]`).classList.add('active');
        }
        
        localStorage.setItem('activeTab', tabId);

        // Si l'onglet assistant est ouvert, scroller en bas
        if (tabId === 'tab-assistant') {
             const assistantMsgs = document.getElementById('assistant-msgs');
             assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
        }
    }

    // --- Gestion de l'Authentification (OAuth Twitch) ---
    function checkAuth() {
        fetch(`${API_BASE}/twitch_user_status`)
            .then(res => res.json())
            .then(data => {
                const statusElement = document.getElementById('auth-status');
                const button = document.getElementById('auth-button');

                if (data.is_connected) {
                    statusElement.innerHTML = `
                        <p class="text-var(--color-primary-pink)">Connect√© : <strong class="text-white">${data.username}</strong></p>
                        <button id="logout-button" class="mt-1 px-3 py-1 bg-gray-500 text-white font-bold rounded hover:bg-gray-400 transition-all">D√©connexion</button>
                    `;
                    document.getElementById('logout-button').addEventListener('click', handleLogout);
                    
                    // Si connect√©, charger les streams suivis
                    loadFollowedStreams();

                } else {
                    statusElement.innerHTML = `
                        <p class="text-var(--color-text-dimmed)">Statut: D√©connect√©</p>
                        <button id="auth-button-final" class="mt-1 px-3 py-1 bg-var(--color-secondary-blue) text-var(--color-bg-dark) font-bold rounded hover:bg-opacity-80 transition-all">Connexion Twitch</button>
                    `;
                    document.getElementById('auth-button-final').addEventListener('click', handleAuthStart);
                }
            })
            .catch(err => {
                console.error("Erreur de v√©rification d'authentification:", err);
            });
    }

    function handleAuthStart() {
        window.location.href = `${API_BASE}/twitch_auth_start`;
    }

    function handleLogout() {
        fetch(`${API_BASE}/twitch_logout`, { method: 'POST' })
            .then(() => {
                checkAuth();
                document.getElementById('followed-list').innerHTML = ''; // Vide la liste
                document.getElementById('followed-status').textContent = 'Connectez-vous pour voir vos streams suivis en direct.';
            })
            .catch(err => console.error("√âchec de la d√©connexion:", err));
    }

    async function loadFollowedStreams() {
        const list = document.getElementById('followed-list');
        const status = document.getElementById('followed-status');
        list.innerHTML = '';
        status.textContent = 'Chargement des streams en direct...';

        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();

            if (res.ok && data.data) {
                if (data.data.length > 0) {
                    status.textContent = `Streams en direct (${data.data.length}) :`;
                    data.data.forEach(stream => {
                        const listItem = document.createElement('li');
                        listItem.className = 'followed-stream-item p-2 rounded cursor-pointer flex justify-between items-center';
                        listItem.innerHTML = `
                            <div>
                                <strong class="text-white">${stream.user_name}</strong>
                                <span class="text-var(--color-text-dimmed) text-xs"> - ${stream.game_name}</span>
                                <p class="text-sm truncate">${stream.title}</p>
                            </div>
                            <span class="text-var(--color-primary-pink) font-bold">${stream.viewer_count} V</span>
                        `;
                        listItem.onclick = () => launchPlayer(stream.user_name);
                        list.appendChild(listItem);
                    });
                } else {
                    status.textContent = 'Aucun stream suivi n\'est actuellement en direct.';
                }
            } else {
                status.textContent = `Erreur: ${data.error || 'Session expir√©e.'}`;
            }
        } catch (err) {
            status.textContent = `Erreur de connexion au serveur.`;
        }
    }

    // --- Fonction de Lancement du Scan ---
    document.getElementById('scan-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = document.getElementById('scan-query').value.trim();
        const resultsBox = document.getElementById('scan-results');
        
        if (!query) return;

        resultsBox.innerHTML = '<p class="text-var(--color-secondary-blue) text-center">Analyse en cours...</p>';

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query })
            });
            const data = await res.json();

            if (res.ok) {
                let htmlContent = '';

                if (data.type === 'game') {
                    const game = data.game_data;
                    htmlContent = `
                        <h4 class="text-xl font-bold text-var(--color-primary-pink)">Jeu Scann√© : ${game.name}</h4>
                        <p><strong>Total Streamers (Sample):</strong> ${game.total_streamers}</p>
                        <p><strong>Total Viewers (Sample):</strong> ${game.total_viewers}</p>
                        <p><strong>Ratio V/S (Moyenne):</strong> <span class="text-lg text-var(--color-secondary-blue)">${game.avg_viewers_per_streamer}</span></p>
                        <p class="font-bold mt-3">Top Streams Actuels :</p>
                        <ul class="list-disc list-inside space-y-1 ml-2">
                            ${game.streams.map(s => 
                                `<li class="hover:text-var(--color-primary-pink) cursor-pointer" onclick="launchPlayer('${s.user_name}')">
                                    <span class="font-bold">${s.user_name}</span>: ${s.viewer_count} V
                                </li>`
                            ).join('')}
                        </ul>
                    `;
                } else if (data.type === 'user') {
                    const user = data.user_data;
                    htmlContent = `
                        <h4 class="text-xl font-bold text-var(--color-primary-pink)">Streamer Scann√© : ${user.display_name}</h4>
                        <p><strong>Statut:</strong> <span class="${user.is_live ? 'text-green-500' : 'text-red-500'} font-bold">${user.is_live ? 'EN DIRECT' : 'HORS LIGNE'}</span></p>
                        <p><strong>Description:</strong> ${user.description || 'N/A'}</p>
                        ${user.is_live ? `
                            <div class="mt-3 p-2 bg-var(--color-bg-light) rounded border border-var(--color-secondary-blue)">
                                <p class="font-bold text-var(--color-secondary-blue)">Stream Actuel:</p>
                                <p class="truncate">Titre: ${user.stream_details.title}</p>
                                <p>Jeu: ${user.stream_details.game_name}</p>
                                <p>Viewers: ${user.stream_details.viewer_count}</p>
                                <button class="mt-2 text-sm text-var(--color-primary-pink) hover:underline" onclick="launchPlayer('${user.login}')">Regarder le Stream</button>
                            </div>
                        ` : ''}
                        <button id="get-vod-btn" class="mt-4 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-channel="${user.login}">
                            Chercher la derni√®re VOD
                        </button>
                        <div id="vod-details" class="mt-2 text-xs"></div>
                    `;
                    document.getElementById('scan-results').innerHTML = htmlContent;
                    document.getElementById('get-vod-btn').addEventListener('click', fetchVodDetails);

                } else if (data.type === 'none') {
                    htmlContent = `<p class="text-var(--color-text-dimmed)">${data.message}</p>`;
                }

                resultsBox.innerHTML = htmlContent;

            } else {
                resultsBox.innerHTML = `<p class="text-red-500">Erreur API (${res.status}): ${data.error || 'Une erreur inconnue s\'est produite.'}</p>`;
            }
        } catch(e) {
            resultsBox.innerHTML = `<p class="text-red-500">Erreur de connexion au serveur: ${e.message}</p>`;
        }
    });

    // --- Fonction pour les d√©tails VOD ---
    async function fetchVodDetails(e) {
        const channel = e.target.getAttribute('data-channel');
        const vodDetailsBox = document.getElementById('vod-details');
        vodDetailsBox.innerHTML = '<p class="text-var(--color-secondary-blue)">Recherche de VOD en cours...</p>';
        e.target.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/get_vod_details`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel })
            });
            const data = await res.json();
            
            if (res.ok && data.success) {
                vodDetailsBox.innerHTML = `
                    <p class="font-bold text-white">Derni√®re VOD trouv√©e:</p>
                    <a href="${data.vod_url}" target="_blank" class="text-var(--color-primary-pink) hover:underline truncate block">${data.vod_title}</a>
                    <img src="${data.vod_thumbnail}" alt="Thumbnail VOD" class="mt-2 rounded" style="max-width: 150px;">
                    <button class="mt-2 text-sm text-var(--color-secondary-blue) hover:underline" onclick="launchPlayer('${channel}', true, '${data.vod_id}')">
                        Lire VOD
                    </button>
                `;
            } else {
                vodDetailsBox.innerHTML = `<p class="text-var(--color-text-dimmed)">${data.error || 'Aucune VOD trouv√©e.'}</p>`;
            }

        } catch (error) {
            vodDetailsBox.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
        } finally {
             e.target.disabled = false;
        }
    }


    // --- Fonction pour les Critiques IA ---
    document.querySelectorAll('.ia-critique-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const type = this.getAttribute('data-type');
            const query = document.getElementById('scan-query').value.trim();
            const resultsBox = document.getElementById('scan-results');
            
            if (type !== 'trend' && !query) {
                resultsBox.innerHTML = '<p class="text-red-500">Veuillez entrer un nom de jeu ou de streamer avant de lancer la critique IA.</p>';
                return;
            }

            resultsBox.innerHTML = `<p class="text-var(--color-secondary-blue) text-center">G√©n√©ration de la Critique IA (${type})... Cela peut prendre quelques secondes.</p>`;
            this.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/critique_ia`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, query })
                });
                const data = await res.json();
                
                if (res.ok) {
                    // Injecte le titre et le contenu HTML directement
                    resultsBox.innerHTML = `<h4 class="text-xl font-bold text-var(--color-primary-pink) mb-3">${getIATitle(type, query)}</h4>` + data.html_critique;
                } else {
                    resultsBox.innerHTML = `<p class="text-red-500">Erreur IA: ${data.error || 'Erreur inconnue'}.</p>`;
                }
            } catch(e) {
                resultsBox.innerHTML = `<p class="text-red-500">Erreur de connexion serveur: ${e.message}</p>`;
            } finally {
                this.disabled = false;
            }
        });
    });

    function getIATitle(type, query) {
        if (type === 'trend') return 'D√©tection de la Prochaine Niche';
        if (type === 'niche') return `Analyse de Niche pour le Jeu: ${query}`;
        if (type === 'repurpose') return `Analyse de Repurposing pour le Streamer: ${query}`;
        return 'Critique IA';
    }


    // --- Fonction pour le Mini Assistant ---
    document.getElementById('assistant-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('assistant-input');
        const q = input.value.trim();
        const assistantMsgs = document.getElementById('assistant-msgs');
        const currentChannel = localStorage.getItem('activeChannel') || 'Twitch'; 
        
        if (!q) return;
        assistantMsgs.innerHTML += `<div class="msg user">${q}</div>`;
        input.value = '';
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
        const loaderId = 'loader-' + Date.now();
        assistantMsgs.innerHTML += `<div id="${loaderId}" class="msg bot">...</div>`;
        
        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ q, context: currentChannel }) 
            });
            const data = await res.json();

            document.getElementById(loaderId).remove();
            
            if (res.ok) {
                 // Le serveur g√®re la r√©ponse vide et fournit un message d'erreur clair si n√©cessaire
                 assistantMsgs.innerHTML += `<div class="msg bot">${data.html_response || "D√©sol√©, probl√®me IA ou r√©ponse bloqu√©e."}</div>`;
            } else {
                 assistantMsgs.innerHTML += `<div class="msg bot" style="color:red;">Erreur du serveur IA: ${data.error || "Inconnu"}.</div>`;
            }

        } catch(err) { 
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class="msg bot" style="color:red;">Erreur connexion serveur.</div>`;
        }
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
    });

    // --- Fonction pour le Stream Boost ---
    document.getElementById('boost-stream-btn').addEventListener('click', async function() {
        const btn = this;
        const channel = currentChannel; // Utiliser le channel actif
        const resultBox = document.getElementById('boost-result-box');

        if (channel === 'twitch') {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Veuillez d'abord lancer un stream cibl√©.</p>`;
            return;
        }

        btn.disabled = true;
        resultBox.innerHTML = `<p class="text-var(--color-secondary-blue) text-center">Activation du Boost en cours...</p>`;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();

            if (res.ok) {
                // Succ√®s du Boost
                resultBox.innerHTML = data.html_response;
            } else if (res.status === 429) {
                // Cooldown actif (g√©r√© par le serveur backend)
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Cooldown actif. R√©essayez plus tard.</p>`;
            } else {
                // Autres erreurs
                resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur API (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });


    // --- NOUVELLE FONCTION: CAT√âGORIES RECOMMAND√âES ---
    async function loadRecommendedCategories() {
        const container = document.getElementById('recommended-categories-container');
        
        try {
            const res = await fetch(`${API_BASE}/recommended_categories`);
            const data = await res.json();
            
            if (res.ok && data.data && data.data.length > 0) {
                container.innerHTML = ''; // Efface le message de chargement
                
                // Grouper les streams par nom de jeu pour les cartes
                const streamsByGame = data.data.reduce((acc, stream) => {
                    if (!acc[stream.game_name]) {
                        acc[stream.game_name] = [];
                    }
                    acc[stream.game_name].push(stream);
                    return acc;
                }, {});

                let html = '';
                for (const gameName in streamsByGame) {
                    const gameStreams = streamsByGame[gameName];
                    
                    // Carte pour la cat√©gorie de jeu
                    html += `
                        <div class="flex-shrink-0 w-64 p-4 bg-var(--color-bg-medium) rounded-lg shadow-neon-pink transition-all duration-300 hover:shadow-neon-blue border border-var(--color-border-dark)">
                            <h5 class="text-sm font-bold text-var(--color-primary-pink) mb-2 uppercase border-b border-var(--color-border-dark) pb-1">${gameName}</h5>
                            <ul class="space-y-2 max-h-40 overflow-y-auto">
                                ${gameStreams.map(stream => `
                                    <li class="text-sm text-white hover:text-var(--color-secondary-blue) cursor-pointer" onclick="launchPlayer('${stream.user_name}')">
                                        <span class="font-bold">${stream.user_name}</span> - 
                                        <span class="text-var(--color-text-dimmed)">${stream.viewer_count}V</span>
                                    </li>
                                `).join('')}
                            </ul>
                            <p class="mt-2 text-xs text-var(--color-text-dimmed) italic">
                                ${gameStreams.length} streamers < 100 V
                            </p>
                        </div>
                    `;
                }
                container.innerHTML = html;

            } else if (res.ok && data.data && data.data.length === 0) {
                 container.innerHTML = '<p class="text-var(--color-text-dimmed)">Aucun stream de niche de moins de 100 viewers trouv√© pour les jeux du moment. R√©essayez plus tard.</p>';
            } else {
                 container.innerHTML = `<p class="text-red-500">Erreur lors du chargement des cat√©gories: ${data.error || 'Erreur inconnue'}</p>`;
            }
        } catch(err) {
            container.innerHTML = `<p class="text-red-500">Erreur de connexion au serveur pour les cat√©gories: ${err.message}</p>`;
        }
    }


    // --- Initialisation au chargement de la page ---\
    document.addEventListener('DOMContentLoaded', function() {
        initializePlayer();
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        checkAuth();
        loadRecommendedCategories(); // NOUVEL APPEL
    });
</script>
</body>
</html>
