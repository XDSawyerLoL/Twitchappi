<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V7.4 - Viral Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- VARIABLES CSS & STYLES GLOBALES --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-growth: #ffcc00;
            --color-title-suggest: #33ccff; /* Couleur pour le titre IA */
            --color-ai-chat: #f9429e; /* Nouvelle couleur pour l'assistant IA */
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
        }

        body {
            background-color: var(--color-bg-dark);
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #twitch-lucky-main {
            all: initial;
            display: block;
            max-width: 1200px;
            margin: 20px auto;
            padding: 10px;
            font-family: 'Inter', sans-serif;
            color: #fff; 
        }
        
        /* Conteneur pour le Drag & Drop */
        #tabs-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Augment√© l'espace entre les blocs */
        }
        
        .tab-block {
            background: var(--color-bg-medium);
            border: 1px solid var(--color-border-dark);
            border-radius: 10px;
            cursor: grab;
            user-select: none;
            transition: border-color 0.2s;
        }
        .tab-block.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary-pink);
        }
        
        /* Structure des Onglets */
        .tab-buttons {
            display: flex; /* IMPORTANT : Pour aligner les boutons horizontalement */
            border-bottom: 1px solid var(--color-border-dark);
        }
        .tab-btn {
            font-family: 'Orbitron', sans-serif;
            padding: 12px 15px;
            background: #111;
            border-right: 1px solid var(--color-border-dark);
            color: var(--color-text-dimmed);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            flex-grow: 1;
            text-align: center;
            font-size: 12px;
            white-space: nowrap;
        }
        .tab-btn:last-child {
            border-right: none;
        }
        .tab-btn.active {
            background: var(--color-bg-medium);
            color: #fff;
            border-top: 3px solid var(--color-primary-pink);
            border-left: 1px solid var(--color-bg-dark); 
            border-right: 1px solid var(--color-bg-dark); 
            font-weight: bold;
            transform: translateY(1px); /* Pour masquer la bordure inf√©rieure */
        }
        .tab-content {
            padding: 20px;
            display: none; /* Masqu√© par d√©faut */
        }

        .action-input {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-dark);
            background: var(--color-bg-dark); color: #fff; font-size: 13px; 
        }
        .btn-primary {
            background: var(--color-primary-pink); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px;
            cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 12px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            filter: brightness(1.2);
        }
        .btn-primary:disabled {
             background: #333;
             cursor: not-allowed;
             opacity: 0.6;
        }
        .ai-result-box {
            background: #0a0a0a; border: 1px solid var(--color-border-dark); border-radius: 6px; padding: 15px; margin-top: 15px;
            font-size: 14px;
        }
        .tab-heading {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
        }
        /* Styles pour l'Assistant Chat */
        #ai-chat-box {
            height: 300px;
            overflow-y: auto;
            background: #000;
            border: 1px solid var(--color-ai-chat);
        }
        .chat-message {
            padding: 8px 12px;
            border-bottom: 1px dotted #1f1f1f;
        }
        .chat-message-user {
            text-align: right;
            color: var(--color-secondary-blue);
        }
        .chat-message-ai {
            text-align: left;
            color: var(--color-ai-chat);
            font-weight: 500;
        }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1 class="text-3xl font-['Orbitron']"><span style="color:var(--color-secondary-blue);">STREAMER</span> HUB V7.4</h1>
    <p class="text-sm font-['Inter'] mb-4" style="color:var(--color-text-dimmed);">L'outil viral pour votre croissance. Visionnage r√©compens√© et IA.</p>

    <div class="player-wrapper mb-6 p-4 rounded-lg" style="background:var(--color-bg-medium); border: 1px solid var(--color-border-dark);">
        <h2 class="text-lg font-['Orbitron']" style="color:var(--color-primary-pink);">
            <span style="margin-right:6px;" id="player-icon">üé¨</span> LECTEUR & CHAT
            <button id="btn-share-stream" class="btn-primary float-right" style="background:var(--color-secondary-blue); font-size:10px;">üîó PARTAGER</button>
        </h2> 
        <form id="form-channel-player" class="flex gap-2 mt-2 mb-4">
            <input id="input-channel" type="text" placeholder="Nom de la cha√Æne Twitch (ex: gotaga)" class="action-input">
            <button type="submit" id="btn-player-launch" class="btn-primary min-w-[80px]">‚ñ∂Ô∏è LANCER</button>
        </form>
        <div id="twitch-embed"></div>
        <p id="player-channel-status" class="text-xs mt-2" style="color:var(--color-text-dimmed); text-align:center;">Cha√Æne: Twitch | Statut: Hors ligne</p>
    </div>
    <div id="tabs-container">
        
        <div id="block-core" class="tab-block" draggable="true" data-tab-id="tab-account|tab-followed">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab-id="tab-account" onclick="openInnerTab('block-core', 'tab-account')">üí∞ MON COMPTE (Streampoints)</button>
                <button class="tab-btn" data-tab-id="tab-followed" onclick="openInnerTab('block-core', 'tab-followed')">üî¥ MON FIL LIVE</button>
            </div>
            
            <div id="tab-account" class="tab-content" style="display:block;">
                <div class="login-box" style="border-color:var(--color-ai-growth); padding: 15px; border: 1px solid;">
                    <h4 class="font-bold text-sm mb-2" style="color:var(--color-secondary-blue);">Connexion Twitch</h4>
                    <p id="login-status" class="text-xs mb-4" style="color:var(--color-text-dimmed);">Statut: D√©connect√©</p>
                    <button id="btn-twitch-login" class="btn-primary" style="background:#6441a5; width:100%; padding: 12px;">
                        üîí SE CONNECTER VIA TWITCH
                    </button>
                </div>
                
                <div class="login-box" style="border-color:var(--color-ai-growth); margin-top: 20px; padding: 15px; border: 1px solid;">
                    <h4 class="font-bold text-sm mb-2" style="color:var(--color-ai-growth);">Votre Solde Streampoints</h4>
                    <p id="streampoints-status" class="text-3xl font-extrabold" style="color:var(--color-ai-growth);">
                        0
                    </p>
                    <p id="streampoints-daily-status" class="text-xs mt-2" style="color:var(--color-text-dimmed);">
                        (Chargement du statut quotidien...)
                    </p>
                    <p class="text-xs mt-2 font-bold" style="color:var(--color-primary-pink);">
                        Gagnez **+1 Point par heure** de visionnage sur le lecteur !
                    </p>
                    <p id="watchtime-tracker" class="text-xs mt-1" style="color:var(--color-secondary-blue);">
                        Suivi du visionnage: 0 minutes
                    </p>
                </div>
            </div>
            
            <div id="tab-followed" class="tab-content">
                <h3 class="tab-heading" style="color:var(--color-primary-pink);">Mon Fil Suivi</h3>
                <div id="followed-streams-list" class="space-y-3">
                    <p style="color:#555; text-align:center; padding:10px;">Veuillez vous connecter pour voir ceci.</p>
                </div>
            </div>
        </div>

        <div id="block-scan-niche" class="tab-block" draggable="true" data-tab-id="tab-scan-niche|tab-niche-ia|tab-trend-ia">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab-id="tab-scan-niche" onclick="openInnerTab('block-scan-niche', 'tab-scan-niche')">üéØ SCAN CIBLE</button>
                <button class="tab-btn" data-tab-id="tab-niche-ia" onclick="openInnerTab('block-scan-niche', 'tab-niche-ia')">‚ú® CRITIQUE NICHE IA</button>
                <button class="tab-btn" data-tab-id="tab-trend-ia" onclick="openInnerTab('block-scan-niche', 'tab-trend-ia')">üîÆ TREND V/S</button>
            </div>
            
            <div id="tab-scan-niche" class="tab-content" style="display:block;">
                <h3 class="tab-heading" style="color:var(--color-secondary-blue);">Scan de Jeu / Streamer</h3>
                <form id="form-target" class="flex gap-2 mb-2">
                    <input id="input-target" type="text" placeholder="Nom du Jeu ou Pseudo Twitch" class="action-input">
                    <button type="submit" id="btn-target" class="btn-primary min-w-[80px]" style="background:var(--color-secondary-blue);">üéØ CIBLER</button>
                </form>
                <div id="scan-result" class="ai-result-box">...</div>
            </div>

            <div id="tab-niche-ia" class="tab-content">
                <h3 class="tab-heading" style="color:var(--color-ai-niche);">Critique de Niche Sp√©cifique IA</h3>
                <form id="form-niche-analysis" class="flex gap-2 mb-2">
                    <input id="input-niche-game" type="text" placeholder="Jeu √† Analyser (ex: Starfield)" class="action-input">
                    <button type="submit" id="btn-niche-analyse" class="btn-primary min-w-[100px]" style="background:var(--color-ai-niche); color: var(--color-bg-dark);">‚ú® CRITIQUE IA</button>
                </form>
                <div id="niche-result-container" class="ai-result-box" style="border-color: var(--color-ai-niche);">...</div>
            </div>

            <div id="tab-trend-ia" class="tab-content">
                <h3 class="tab-heading" style="color:var(--color-ai-growth);">D√©tection de Trend V/S (Ratio V/S)</h3>
                <p class="text-xs mb-4" style="color:var(--color-text-dimmed);">Analyse les petits streams pour trouver les jeux ayant le meilleur ratio spectateurs/streamer (V/S).</p>
                <button id="btn-trend-detector" class="btn-primary" style="background:var(--color-ai-growth); color:var(--color-bg-dark); width:100%; padding:12px;">üîÆ D√âTECTER LA PROCHAINE NICHE CHAUDE</button>
                <div id="trend-results" class="ai-result-box" style="border-color: var(--color-ai-growth); margin-top: 15px;">...</div>
            </div>
        </div>

        <div id="block-ai-tools" class="tab-block" draggable="true" data-tab-id="tab-repurpose|tab-boost-raid">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab-id="tab-repurpose" onclick="openInnerTab('block-ai-tools', 'tab-repurpose')">üöÄ REPURPOSING IA</button>
                <button class="tab-btn" data-tab-id="tab-boost-raid" onclick="openInnerTab('block-ai-tools', 'tab-boost-raid')">‚ö° BOOST & RAID</button>
            </div>
            
            <div id="tab-repurpose" class="tab-content" style="display:block;">
                <h3 class="tab-heading" style="color:var(--color-ai-repurpose);">Repurposing Contenu IA</h3>
                <form id="form-repurpose" class="flex gap-2 mb-2">
                    <input id="input-repurpose-channel" type="text" placeholder="Pseudo du Streamer pour analyse" class="action-input">
                    <button type="submit" id="btn-repurpose-analyse" class="btn-primary min-w-[100px]" style="background:var(--color-ai-repurpose);">üöÄ ANALYSER VOD</button>
                </form>
                <p class="text-xs mb-4" style="color:var(--color-text-dimmed);">Analyse les VOD r√©centes pour trouver des moments viraux pour TikTok/YouTube Shorts.</p>
                <div id="repurpose-result-container" class="ai-result-box" style="border-color: var(--color-ai-repurpose);">...</div>

                <h3 class="tab-heading mt-8" style="color:var(--color-title-suggest);">Suggestion de Titre & Tag IA</h3>
                <form id="form-title-suggest">
                    <input id="input-title-game" type="text" placeholder="Jeu (ex: Elden Ring)" class="action-input mb-2">
                    <input id="input-title-angle" type="text" placeholder="Angle du Stream (ex: D√©fi No Death)" class="action-input mb-2">
                    <button type="submit" id="btn-title-suggest" class="btn-primary" style="background:var(--color-title-suggest); width:100%; padding: 12px;">‚ú® G√âN√âRER TITRES & TAGS SEO</button>
                </form>
                <div id="title-suggest-results" class="ai-result-box" style="border-color: var(--color-title-suggest);">...</div>
            </div>
            
            <div id="tab-boost-raid" class="tab-content">
                <h3 class="tab-heading" style="color:var(--color-primary-pink);">STREAM BOOST (10 Minutes)</h3>
                <div class="login-box mb-6" style="border-color: var(--color-primary-pink); padding: 15px; border: 1px solid;">
                    <p class="text-xs mb-4" style="color:var(--color-text-dimmed);">Activez un boost. Co√ªte <strong id="boost-cost-display">20</strong> Streampoints. Cooldown : 3 heures.</p>
                    <form id="form-boost" class="flex gap-2">
                        <input id="input-boost" type="text" placeholder="Cha√Æne √† promouvoir" class="action-input">
                        <button type="submit" id="btn-boost" class="btn-primary min-w-[100px]" style="background:var(--color-primary-pink);">üì§ BOOST</button>
                    </form>
                    <div id="boost-results" class="ai-result-box" style="border-color: var(--color-primary-pink); margin-top: 15px;">...</div>
                </div>
                
                <h3 class="tab-heading" style="color:#6441a5;">Raid Rapide (Simul√©)</h3>
                 <div class="login-box" style="border-color:#6441a5; padding: 15px; border: 1px solid;">
                    <form id="form-raid" class="flex gap-2">
                        <input id="input-raid-target" type="text" placeholder="Cha√Æne cible du Raid" class="action-input">
                        <button type="submit" id="btn-raid" class="btn-primary min-w-[100px]" style="background:#6441a5;">‚öîÔ∏è RAID</button>
                    </form>
                    <div id="raid-results" class="ai-result-box" style="border-color: #6441a5; margin-top: 15px;">...</div>
                </div>
            </div>
        </div>

        <div id="block-ai-chat" class="tab-block" draggable="true" data-tab-id="tab-ai-chat">
             <div class="tab-buttons">
                <button class="tab-btn w-full active" data-tab-id="tab-ai-chat" onclick="openInnerTab('block-ai-chat', 'tab-ai-chat')">üí¨ MINI ASSISTANT IA</button>
            </div>
            <div id="tab-ai-chat" class="tab-content" style="display:block;">
                <h3 class="tab-heading" style="color:var(--color-ai-chat);">Conseiller en Croissance IA</h3>
                
                <div id="ai-chat-box" class="ai-result-box mb-4">
                    <div class="chat-message chat-message-ai">Salut ! Je suis ton assistant IA. Comment puis-je t'aider √† optimiser ton stream aujourd'hui ?</div>
                </div>
                
                <form id="form-ai-chat" class="flex gap-2">
                    <input id="input-ai-chat" type="text" placeholder="Posez une question √† l'IA (ex: comment avoir plus de viewers?)" class="action-input">
                    <button type="submit" id="btn-ai-chat-send" class="btn-primary min-w-[80px]" style="background:var(--color-ai-chat);">ENVOYER</button>
                </form>
                <div id="ai-chat-status" class="text-xs mt-2" style="color:var(--color-text-dimmed);"></div>
            </div>
        </div>
        
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    const DEFAULT_CHANNEL = 'twitch'; 
    const STREAMPPOINTS_COST_BOOST = 20; 

    let twitchUserConnected = false; 
    let currentStreampoints = 0;
    let currentChannel = DEFAULT_CHANNEL;
    let currentChannelGame = 'Just Chatting'; 
    let watchTimeInterval = null;
    let watchTimeMinutes = 0;
    const WATCH_TIME_UPDATE_INTERVAL_MS = 60000; // 1 minute
    
    // --- Glisser-D√©poser des Blocs ---
    const TABS_ORDER_KEY = 'tabsOrder';
    const tabsContainer = document.getElementById('tabs-container');
    let draggedItem = null;

    function saveTabsOrder() {
        const order = Array.from(tabsContainer.children).map(child => child.id);
        localStorage.setItem(TABS_ORDER_KEY, JSON.stringify(order));
    }

    function loadTabsOrder() {
        const savedOrder = localStorage.getItem(TABS_ORDER_KEY);
        if (savedOrder) {
            const order = JSON.parse(savedOrder);
            const fragment = document.createDocumentFragment();

            order.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    fragment.appendChild(element);
                }
            });
            tabsContainer.appendChild(fragment);
        }
    }

    tabsContainer.addEventListener('dragstart', (e) => {
        draggedItem = e.target.closest('.tab-block');
        if (draggedItem) {
            setTimeout(() => draggedItem.classList.add('dragging'), 0);
            e.dataTransfer.setData('text/plain', draggedItem.id);
        }
    });

    tabsContainer.addEventListener('dragend', () => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
        saveTabsOrder();
    });

    tabsContainer.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        const target = e.target.closest('.tab-block');
        if (target && target !== draggedItem) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / rect.height > 0.5;
            tabsContainer.insertBefore(draggedItem, next ? target.nextSibling : target);
        }
    });
    
    // --- Gestion des Onglets Int√©rieurs (CORRIG√âE pour les blocs) ---
    function openInnerTab(blockId, tabId) {
        const block = document.getElementById(blockId);
        if (!block) return;

        // Masquer tous les contenus dans ce bloc
        block.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        // D√©sactiver tous les boutons dans ce bloc
        block.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // Afficher le contenu cibl√©
        const content = document.getElementById(tabId);
        const button = block.querySelector(`.tab-btn[data-tab-id="${tabId}"]`);
        
        if (content && button) {
            content.style.display = 'block';
            button.classList.add('active');
        }
    }

    // --- Lecteur Twitch ---
    let embed = null;
    const twitchEmbedContainer = document.getElementById('twitch-embed');
    const inputChannel = document.getElementById('input-channel');
    const btnShareStream = document.getElementById('btn-share-stream');
    const formChannelPlayer = document.getElementById('form-channel-player');
    const playerStatus = document.getElementById('player-channel-status');

    function launchPlayer(channelName, gameName = 'Just Chatting') {
        if (!channelName) return;

        currentChannel = channelName;
        currentChannelGame = gameName; 
        localStorage.setItem('activeChannel', channelName);
        inputChannel.value = channelName;

        twitchEmbedContainer.innerHTML = '';
        embed = new Twitch.Embed("twitch-embed", {
            width: "100%",
            height: 350, // Taille ajust√©e pour la V7.4
            channel: channelName,
            layout: "video-with-chat", 
            autoplay: true,
            parent: [window.location.hostname, 'localhost'] 
        });
        playerStatus.textContent = `Cha√Æne: ${channelName.toUpperCase()} | Statut: En cours`;
        startWatchTimeTracking();
    }
    
    function initializePlayer() {
        const lastChannel = localStorage.getItem('activeChannel') || DEFAULT_CHANNEL;
        launchPlayer(lastChannel);

        formChannelPlayer.addEventListener('submit', (e) => {
            e.preventDefault();
            const channel = inputChannel.value.trim();
            if (channel) {
                launchPlayer(channel);
            }
        });
    }
    
    // --- Suivi du Temps de Visionnage (Streampoints) ---
    const watchTimeTracker = document.getElementById('watchtime-tracker');

    function startWatchTimeTracking() {
        if (watchTimeInterval) {
            clearInterval(watchTimeInterval);
            watchTimeInterval = null;
        }
        watchTimeMinutes = 0; 
        
        if (twitchUserConnected) {
            watchTimeInterval = setInterval(() => {
                watchTimeMinutes++;
                watchTimeTracker.textContent = `Suivi du visionnage: ${watchTimeMinutes} minutes`;

                if (watchTimeMinutes >= 60) { 
                    sendWatchTimeUpdate();
                }
            }, WATCH_TIME_UPDATE_INTERVAL_MS); 
        }
    }

    async function sendWatchTimeUpdate() {
        if (!twitchUserConnected || watchTimeMinutes === 0) return;
        
        // NOTE: La route /earn_streampoints_watchtime n'est pas dans le app.js fourni.
        // On simule juste la r√©initialisation ici pour √©viter des erreurs console.
        
        if (watchTimeMinutes >= 60) {
            // Ici, vous enverriez normalement la requ√™te au serveur Node.js
            // fetch(`${API_BASE}/earn_streampoints_watchtime`, {...});
            
            // Simulation :
            console.log(`[SIMULATION] Normalement envoi de ${watchTimeMinutes} minutes au serveur.`);
            watchTimeMinutes = 0; 
            watchTimeTracker.textContent = `Suivi du visionnage: 0 minutes (Points √† jour)`;
            loadStreampoints(); // Recharge les points apr√®s l'envoi
        }
    }

    // --- Authentification et Streampoints (Simplifi√© car la logique points n'√©tait pas dans le app.js) ---
    const btnLogin = document.getElementById('btn-twitch-login');
    const loginStatus = document.getElementById('login-status');
    const streampointsStatus = document.getElementById('streampoints-status');
    const streampointsDailyStatus = document.getElementById('streampoints-daily-status');
    const btnBoost = document.getElementById('btn-boost');

    async function checkAuth() {
        try {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            if(res.ok) {
                const data = await res.json();
                if(data.is_connected) {
                    twitchUserConnected = true;
                    loginStatus.innerHTML = `‚úÖ Connect√© en tant que <strong style="color:var(--color-secondary-blue)">${data.username}</strong>`;
                    btnLogin.textContent = "üîí D√âCONNEXION";
                    btnLogin.style.background = "#e34a64"; 
                    loadStreampoints();
                    loadFollowedStreams(data.user_id);
                } else {
                    handleLogoutState();
                }
            } else {
                handleLogoutState();
            }
        } catch(e) {
            handleLogoutState();
        }
    }

    function handleLogoutState() {
        twitchUserConnected = false;
        loginStatus.textContent = "Statut: D√©connect√©.";
        btnLogin.textContent = "üîí SE CONNECTER VIA TWITCH";
        btnLogin.style.background = "#6441a5"; 
        currentStreampoints = 0;
        updateStreampointsDisplay();
        btnBoost.disabled = true;
        if (watchTimeInterval) {
            clearInterval(watchTimeInterval);
            watchTimeInterval = null;
        }
    }
    
    btnLogin.addEventListener('click', () => {
        if (twitchUserConnected) {
            // D√©connexion
            fetch(`${API_BASE}/twitch_logout`, { method: 'POST' }).then(() => {
                handleLogoutState();
            });
        } else {
            // Connexion
            window.location.href = `${API_BASE}/twitch_auth_start`;
        }
    });

    async function loadStreampoints() {
         if(!twitchUserConnected) return;
         // Simulation de points charg√©s
         currentStreampoints = 125; 
         updateStreampointsDisplay();
         streampointsDailyStatus.innerHTML = `<span style="color:var(--color-ai-niche); font-weight:bold;">‚úÖ Bonus quotidien r√©clam√© aujourd'hui.</span>`;
         startWatchTimeTracking();
    }

    function updateStreampointsDisplay() {
        streampointsStatus.innerHTML = `${currentStreampoints.toLocaleString('fr-FR')} <span class="text-base" style="color:var(--color-text-dimmed);">Points</span>`;
        btnBoost.disabled = currentStreampoints < STREAMPPOINTS_COST_BOOST || !twitchUserConnected;
        document.getElementById('boost-cost-display').textContent = STREAMPPOINTS_COST_BOOST;
    }
    
    // --- Chargement des Streams Suivis ---
    async function loadFollowedStreams(userId) {
        const listContainer = document.getElementById('followed-streams-list');
        listContainer.innerHTML = '<p style="color:#ffcc00; text-align:center;">Chargement de votre fil...</p>';

        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();

            if (res.ok && data.data && data.data.length > 0) {
                listContainer.innerHTML = data.data.map(stream => `
                    <div class="flex items-center space-x-3 p-2 bg-black rounded cursor-pointer hover:bg-gray-900" 
                         onclick="launchPlayer('${stream.user_login}')">
                        <span class="w-3 h-3 rounded-full bg-red-500 flex-shrink-0"></span>
                        <div class="flex-grow">
                            <p class="text-sm font-bold text-white">${stream.user_name}</p>
                            <p class="text-xs text-gray-400 truncate">${stream.title}</p>
                        </div>
                        <p class="text-xs font-mono text-gray-500 flex-shrink-0">${stream.viewer_count.toLocaleString()} vues</p>
                    </div>
                `).join('');
            } else {
                listContainer.innerHTML = `<p style="color:var(--color-text-dimmed); text-align:center;">Aucun stream en direct trouv√© ou vous ne suivez personne.</p>`;
            }
        } catch (e) {
            listContainer.innerHTML = `<p style="color:red; text-align:center;">Erreur lors du chargement des streams.</p>`;
        }
    }


    // --- Logique du Stream Boost ---
    document.getElementById('form-boost').addEventListener('submit', async (e) => {
        e.preventDefault();
        const channel = document.getElementById('input-boost').value.trim();
        const resultBox = document.getElementById('boost-results'); 
        const btn = document.getElementById('btn-boost');

        if (!channel || btn.disabled) return;
        
        resultBox.innerHTML = `<p style="color:var(--color-primary-pink); text-align:center;">üì§ Tentative de Boost...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();

            if (res.ok) {
                resultBox.innerHTML = data.html_response;
                // Simulation de la d√©duction des points si le serveur avait cette logique
                currentStreampoints -= STREAMPPOINTS_COST_BOOST;
            } else {
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå √âchec: ${data.error || "Erreur inconnue."}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Erreur de connexion au serveur.</p>`;
        } finally {
            updateStreampointsDisplay(); 
            btn.disabled = false;
        }
    });

    // --- Logique de l'Assistant Chat IA ---
    const chatBox = document.getElementById('ai-chat-box');
    const formChat = document.getElementById('form-ai-chat');
    const inputChat = document.getElementById('input-ai-chat');
    const btnChatSend = document.getElementById('btn-ai-chat-send');
    const chatStatus = document.getElementById('ai-chat-status');

    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message');
        messageDiv.classList.add(isUser ? 'chat-message-user' : 'chat-message-ai');
        
        // Utiliser un moteur de rendu Markdown simple pour l'IA (simul√©)
        let htmlContent = isUser ? text : marked.parse(text); 
        messageDiv.innerHTML = htmlContent;
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight; 
    }
    
    // Fonction marked.parse (Simulation simplifi√©e, la vraie biblioth√®que serait n√©cessaire)
    const marked = {
        parse: function(text) {
            // Remplacement des sauts de ligne pour les paragraphes
            let html = text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            // Remplacement simple des **mots gras**
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Remplacement des listes (tr√®s basique, n√©cessiterait une logique plus robuste)
            html = html.replace(/^- (.*)/gm, '<li>$1</li>');
            if (html.includes('<li>')) {
                html = '<ul>' + html + '</ul>';
            }
            return `<p>${html}</p>`;
        }
    };
    

    formChat.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = inputChat.value.trim();
        if (!query) return;

        addMessage(query, true);
        inputChat.value = '';
        btnChatSend.disabled = true;
        chatStatus.textContent = 'L\'IA est en train de r√©fl√©chir...';

        try {
            const res = await fetch(`${API_BASE}/ai_chat_query`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                addMessage(data.response, false);
            } else {
                addMessage(`[ERREUR IA] ${data.error || data.response || "Service IA indisponible."}`, false);
            }
        } catch(e) {
            addMessage(`[ERREUR CRITIQUE] Impossible de contacter le serveur IA.`, false);
            console.error(e);
        } finally {
            btnChatSend.disabled = false;
            chatStatus.textContent = '';
            inputChat.focus();
        }
    });
    
    // --- INITIALISATION ---
    document.addEventListener('DOMContentLoaded', function() {
        loadTabsOrder(); 
        initializePlayer();
        checkAuth();
        
        // S'assurer que les contenus internes sont correctement initialis√©s
        openInnerTab('block-core', 'tab-account');
        openInnerTab('block-scan-niche', 'tab-scan-niche');
        openInnerTab('block-ai-tools', 'tab-repurpose');
        // Le chat est un bloc unique, son contenu est d√©j√† visible par d√©faut.

        document.getElementById('boost-cost-display').textContent = STREAMPPOINTS_COST_BOOST;
    });

</script>
</body>
</html>
