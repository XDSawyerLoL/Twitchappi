<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V43 - FIREBASE REALTIME</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>

    <style>
        :root {
            --bg-dark: #09090b;
            --glass-bg: rgba(20, 20, 25, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --neon-pink: #ff0055; --neon-blue: #00f3ff; --neon-green: #00ff9d;
        }

        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #twitch-lucky-main { max-width: 1450px; margin: 20px auto; padding: 10px; }
        
        /* TYPO */
        h1 { font-family: 'Orbitron', sans-serif; font-size: 32px; letter-spacing: 2px; text-align: center; margin-bottom: 5px; background: linear-gradient(to right, #fff, var(--neon-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle-center { color: #666; font-size: 11px; text-align: center; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; }

        /* TABS */
        .flex-tabs { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .tab-btn { font-family: 'Orbitron', sans-serif; padding: 14px 24px; background: rgba(255,255,255,0.03); border: var(--glass-border); color: #888; cursor: pointer; border-radius: 12px; transition: 0.3s; flex: 1; text-align: center; font-size: 12px; font-weight: 700; }
        .tab-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .tab-btn.active { background: rgba(255,255,255,0.08); color: #fff; border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }

        /* SPLIT PLAYER */
        .player-wrapper { background: var(--glass-bg); border: var(--glass-border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 30px; }
        .player-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: #111; border-bottom: 1px solid #333; }
        .player-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--neon-blue); display: flex; align-items: center; gap: 15px; }

        .split-container { display: flex; height: 650px; background: #000; }
        .video-side { flex-grow: 1; position: relative; border-right: 1px solid #333; }
        #twitch-embed-video { width: 100%; height: 100%; }
        
        .chat-side { width: 380px; min-width: 380px; background: #0e0e10; display: flex; flex-direction: column; position: relative; }
        .chat-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
        .chat-layer.active-layer { display: flex; }
        iframe.chat-frame { width: 100%; height: 100%; border: none; }

        /* FIREBASE CHAT UI */
        #socket-ui { display: flex; flex-direction: column; height: 100%; width: 100%; background: #111; }
        .socket-header-internal { padding: 15px; background: #18181b; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; align-items: center; }
        .user-badge-area { display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: bold; color: #fff; }
        .user-avatar-small { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--neon-green); object-fit: cover; }

        #firebase-messages-area { 
            flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; 
            scrollbar-width: thin; scrollbar-color: #333 #111;
            /* Inverser le flex pour que les nouveaux messages soient en bas sans scroll forc√© */
            flex-direction: column; 
        }
        
        .socket-msg { 
            font-size: 13px; line-height: 1.5; color: #ddd; 
            background: rgba(255,255,255,0.03); padding: 10px 14px; border-radius: 8px; 
            border-left: 3px solid transparent; word-wrap: break-word; position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .socket-msg.admin-msg { border-left-color: var(--neon-pink); background: linear-gradient(90deg, rgba(255,0,85,0.05), transparent); }
        .socket-msg.me-msg { border-left-color: var(--neon-green); align-self: flex-end; text-align: right; background: rgba(0, 255, 157, 0.05); }
        
        /* Bouton suppression (Mod√©ration) */
        .delete-btn { 
            position: absolute; top: 5px; right: 5px; color: #555; cursor: pointer; font-size: 10px; display: none; 
        }
        .socket-msg:hover .delete-btn { display: block; }
        .delete-btn:hover { color: var(--neon-pink); }

        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 11px; color: #777; }
        .me-msg .msg-header { justify-content: flex-end; }
        .msg-avatar { width: 20px; height: 20px; border-radius: 50%; }

        .socket-input-area { padding: 15px; background: #18181b; border-top: 1px solid #2a2a2a; position: relative; }
        
        /* EMOTE PICKER */
        .emote-picker {
            position: absolute; bottom: 70px; right: 15px; width: 250px; height: 200px;
            background: #222; border: 1px solid #444; border-radius: 8px;
            display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 10px; overflow-y: auto; z-index: 50;
        }
        .emote-picker.active { display: grid; }
        .emote-btn { font-size: 20px; cursor: pointer; padding: 5px; text-align: center; }
        .emote-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.2); }

        /* UI ELEMENTS */
        .chat-toggle-group { display: flex; background: rgba(0,0,0,0.5); border-radius: 8px; padding: 4px; margin-left: 20px; }
        .chat-toggle-btn { padding: 8px 16px; font-size: 11px; cursor: pointer; border-radius: 6px; border: none; background: transparent; color: #888; font-weight: 800; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .chat-toggle-btn:hover { color: #fff; }
        .chat-toggle-btn.active-twitch { background: #9146FF; color: white; }
        .chat-toggle-btn.active-hub { background: var(--neon-blue); color: #000; }

        .player-quick-input { background: #000; border: 1px solid #333; color: white; padding: 8px 12px; border-radius: 4px; font-size: 13px; width: 220px; transition: 0.3s; }
        .player-quick-input:focus { border-color: var(--neon-blue); outline: none; }
        .btn-primary { background: var(--neon-pink); color: #fff; border: 0; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 12px; transition: 0.3s; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,0,85,0.4); }
        .chat-emote { vertical-align: middle; height: 24px; margin: 0 2px; }

        /* DASHBOARD */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border-left: 4px solid #333; }
        .kpi-value { font-size: 28px; font-weight: 900; font-family: 'Orbitron'; }
        .kpi-label { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 5px; }
        .dashboard-box { background: rgba(255,255,255,0.02); border: 1px solid #333; border-radius: 12px; padding: 20px; }

        @media (max-width: 1024px) { 
            .split-container { flex-direction: column; height: auto; }
            .video-side { height: 56.25vw; width: 100%; }
            .chat-side { width: 100%; height: 450px; border-left: none; border-top: 1px solid #333; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="twitch-lucky-main">
    <h1>STREAMER <span class="h1-blue-accent">HUB</span> V43</h1>
    <div class="subtitle-center">Cockpit Unifi√© ‚Ä¢ Firebase Connected ‚Ä¢ Engagement Max</div>

    <div class="tabs-nav-container">
        <div class="flex-tabs">
            <button class="tab-btn active" onclick="openTab('tab-followed')"><i class="fas fa-satellite mr-2"></i> MONITORING</button> 
            <button class="tab-btn" onclick="openTab('tab-dashboard')"><i class="fas fa-chart-pie mr-2"></i> ANALYTICS</button>
            <button class="tab-btn" onclick="openTab('tab-boost')"><i class="fas fa-rocket mr-2"></i> BOOST</button>
        </div>
    </div>

    <div class="player-wrapper">
        <div class="player-header">
            <div class="player-title">
                <i class="fab fa-twitch text-purple-500 text-2xl"></i>
                <div class="chat-toggle-group">
                    <button class="chat-toggle-btn active-twitch" id="btn-chat-twitch" onclick="toggleChat('twitch')">TWITCH</button>
                    <button class="chat-toggle-btn" id="btn-chat-hub" onclick="toggleChat('hub')"><i class="fas fa-fire"></i> HUB CHAT</button>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <span id="player-channel-status" class="text-xs text-gray-400 font-mono hidden md:block">PR√äT</span>
                <form id="mini-player-form" class="flex gap-2" onsubmit="event.preventDefault(); launchPlayer(document.getElementById('input-channel').value)">
                    <input id="input-channel" type="text" placeholder="Cha√Æne..." class="player-quick-input text-center">
                    <button type="submit" class="btn-primary" style="padding: 8px 15px; margin:0;"><i class="fas fa-play"></i></button>
                </form>
            </div>
        </div>

        <div class="split-container">
            <div class="video-side"><div id="twitch-embed-video"></div></div>
            <div class="chat-side">
                <div id="chat-layer-twitch" class="chat-layer active-layer"><div id="twitch-chat-embed-container" style="width:100%; height:100%;"></div></div>
                
                <div id="chat-layer-hub" class="chat-layer">
                    <div id="socket-ui">
                        <div class="socket-header-internal">
                            <div class="user-badge-area">
                                <img id="my-avatar" src="https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-70x70.png" class="user-avatar-small">
                                <span id="my-username">Invit√©</span>
                                <span id="my-badge" class="text-xs bg-gray-700 px-1 rounded">Viewer</span>
                            </div>
                            <span id="firebase-status" class="text-xs font-mono text-gray-500">Connexion...</span>
                        </div>
                        
                        <div id="firebase-messages-area">
                            </div>

                        <div id="emote-picker" class="emote-picker">
                            <div class="emote-btn" onclick="addEmote('Pepega')">ü§™</div>
                            <div class="emote-btn" onclick="addEmote('PogChamp')">üò≤</div>
                            <div class="emote-btn" onclick="addEmote('Kappa')">üòè</div>
                            <div class="emote-btn" onclick="addEmote('LUL')">üòÇ</div>
                            <div class="emote-btn" onclick="addEmote('Fire')">üî•</div>
                            <div class="emote-btn" onclick="addEmote('Heart')">üíú</div>
                        </div>

                        <div class="socket-input-area">
                            <form id="firebase-form" class="flex gap-2 items-center">
                                <button type="button" class="text-gray-400 hover:text-white" onclick="toggleEmotes()"><i class="fas fa-smile text-xl"></i></button>
                                <input id="chat-input" type="text" placeholder="Envoyer..." class="player-quick-input" style="width:100%; border-radius:20px; padding-left:15px;">
                                <button type="submit" class="btn-primary" style="padding: 8px 12px; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="content-area">
        <div id="tab-followed" class="tab-content active">
            <h3 class="text-pink font-bold text-lg mb-4" style="color:var(--neon-pink);">MONITORING LIVE</h3>
            <div id="followed-streams-list" class="text-center py-10 text-gray-500">Connectez-vous pour voir vos favoris.</div>
        </div>
        <div id="tab-dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="kpi-card" style="border-color: var(--neon-blue);"><div class="kpi-value">1.2M</div><div class="kpi-label">Audience</div></div>
                <div class="kpi-card" style="border-color: var(--neon-purple);"><div class="kpi-value">84</div><div class="kpi-label">Actifs</div></div>
                <div class="kpi-card" style="border-color: var(--neon-green);"><div class="kpi-value">LOL</div><div class="kpi-label">Top Jeu</div></div>
                <div class="kpi-card" style="border-color: var(--neon-pink);"><div class="kpi-value text-green-400">ON</div><div class="kpi-label">Statut</div></div>
            </div>
        </div>
        <div id="tab-boost" class="tab-content">
            <h3 class="text-lg font-bold mb-4">BOOST STATION</h3>
            <p class="text-gray-400">Le syst√®me de boost est pr√™t.</p>
        </div>
    </div>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // 1. CONFIGURATION FIREBASE (REMPLACEZ PAR VOS CL√âS !!!)
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "VOTRE_API_KEY_ICI",
        authDomain: "VOTRE_PROJET.firebaseapp.com",
        projectId: "VOTRE_PROJET_ID",
        storageBucket: "VOTRE_PROJET.appspot.com",
        messagingSenderId: "XXX",
        appId: "XXX"
    };

    // Initialisation
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        document.getElementById('firebase-status').innerText = "ONLINE";
        document.getElementById('firebase-status').className = "text-xs font-mono text-green-400 animate-pulse";
        console.log("Firebase connect√©");
        
        // Lancer l'√©coute
        listenToChat();
    } catch (e) {
        console.error("Erreur Config Firebase:", e);
        document.getElementById('firebase-status').innerText = "CONFIG ERROR";
    }

    // ------------------------------------------------------------------
    // 2. LOGIQUE CHAT (ENVOI & R√âCEPTION)
    // ------------------------------------------------------------------
    const messagesContainer = document.getElementById('firebase-messages-area');
    const chatForm = document.getElementById('firebase-form');
    const chatInput = document.getElementById('chat-input');

    // √âCOUTE TEMPS R√âEL (READ)
    function listenToChat() {
        // On √©coute la collection "messages", tri√©s par date, les 50 derniers
        const q = query(collection(db, "hub_chat"), orderBy("createdAt", "asc"), limit(50));
        
        onSnapshot(q, (snapshot) => {
            messagesContainer.innerHTML = ''; // On nettoie pour √©viter les doublons (m√©thode simple)
            
            snapshot.forEach((docSnap) => {
                const msg = docSnap.data();
                renderMessage(msg, docSnap.id);
            });
            
            // Scroll auto en bas
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }

    // ENVOI MESSAGE (WRITE)
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = chatInput.value;
        if (!text.trim()) return;

        // On r√©cup√®re l'identit√© actuelle (d√©finie globalement via Auth Twitch)
        const user = window.currentUser || { name: 'Anonyme', avatar: '', badge: 'Viewer' };

        try {
            await addDoc(collection(db, "hub_chat"), {
                text: parseEmotes(text), // On traite les emotes avant envoi
                user: user.name,
                avatar: user.avatar,
                badge: user.badge,
                createdAt: serverTimestamp() // Heure serveur fiable
            });
            chatInput.value = '';
        } catch (e) {
            console.error("Erreur envoi:", e);
        }
    });

    // RENDU VISUEL D'UN MESSAGE
    function renderMessage(msg, docId) {
        const isMe = msg.user === (window.currentUser?.name || 'Anonyme');
        const div = document.createElement('div');
        
        // Classes conditionnelles
        div.className = `socket-msg ${isMe ? 'me-msg' : (msg.badge === 'Admin' ? 'admin-msg' : '')}`;
        
        // HTML du message
        div.innerHTML = `
            <div class="msg-header">
                ${!isMe ? `<img src="${msg.avatar}" class="msg-avatar">` : ''}
                <span class="font-bold text-white">${msg.user}</span>
                ${msg.badge ? `<span class="text-[10px] bg-gray-700 px-1 rounded">${msg.badge}</span>` : ''}
                
                ${window.currentUser?.badge === 'Admin' ? `<i class="fas fa-trash delete-btn" onclick="window.deleteMessage('${docId}')"></i>` : ''}
            </div>
            <div class="text-sm text-gray-300">${msg.text}</div>
        `;
        
        messagesContainer.appendChild(div);
    }

    // MOD√âRATION (SUPPRESSION)
    // On attache la fonction √† window pour qu'elle soit accessible depuis le HTML g√©n√©r√©
    window.deleteMessage = async (docId) => {
        if(confirm("Supprimer ce message ?")) {
            await deleteDoc(doc.collection(db, "hub_chat"), docId);
        }
    }

    // ------------------------------------------------------------------
    // 3. UTILITAIRES (EMOTES)
    // ------------------------------------------------------------------
    const emotes = {
        'Pepega': 'https://cdn.betterttv.net/emote/5aca62163e290877a25481ad/1x',
        'PogChamp': 'https://static-cdn.jtvnw.net/emoticons/v2/84608/default/dark/1.0',
        'Kappa': 'https://static-cdn.jtvnw.net/emoticons/v2/25/default/dark/1.0',
        'LUL': 'https://static-cdn.jtvnw.net/emoticons/v2/425618/default/dark/1.0',
        'Fire': 'üî•', 'Heart': 'üíú'
    };

    function parseEmotes(text) {
        if(!text) return "";
        return text.replace(/:(\w+):/g, (match, code) => {
            const url = emotes[code];
            if (!url) return match;
            if (url.startsWith('http')) return `<img src="${url}" class="chat-emote">`;
            return url; // Emoji natif
        });
    }
</script>

<script>
    // --- GLOBAL VARS ---
    const PARENT_DOMAINS = ["justplayer.fr", "www.justplayer.fr", "localhost", "127.0.0.1", window.location.hostname];
    let videoEmbed = null;
    
    // User State Global (accessible par le module Firebase)
    window.currentUser = {
        name: 'Anonyme',
        avatar: 'https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-70x70.png',
        badge: 'Viewer'
    };

    // --- NAVIGATION ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // --- PLAYER LOGIC ---
    window.launchPlayer = function(channelName) {
        document.getElementById('input-channel').value = channelName;
        document.getElementById('player-channel-status').innerText = "LIVE : " + channelName.toUpperCase();
        
        // Video
        document.getElementById('twitch-embed-video').innerHTML = '';
        const config = { width: "100%", height: "100%", layout: "video", parent: PARENT_DOMAINS };
        videoEmbed = new Twitch.Embed("twitch-embed-video", { ...config, channel: channelName });

        // Tchat
        updateTwitchChatIframe(channelName);
    }

    function updateTwitchChatIframe(channel) {
        const uniqueParents = [...new Set(PARENT_DOMAINS.filter(Boolean))];
        const parentParams = uniqueParents.map(p => `parent=${p}`).join('&');
        const src = `https://www.twitch.tv/embed/${channel}/chat?${parentParams}&darkpopout`;
        document.getElementById('twitch-chat-embed-container').innerHTML = `<iframe class="chat-frame" src="${src}" frameborder="0"></iframe>`;
    }

    // --- UI HELPERS ---
    function toggleChat(mode) {
        const tBtn = document.getElementById('btn-chat-twitch');
        const hBtn = document.getElementById('btn-chat-hub');
        const tLayer = document.getElementById('chat-layer-twitch');
        const hLayer = document.getElementById('chat-layer-hub');
        
        if (mode === 'hub') {
            hBtn.classList.add('active-hub'); tBtn.classList.remove('active-twitch');
            tLayer.classList.remove('active-layer'); hLayer.classList.add('active-layer');
        } else {
            tBtn.classList.add('active-twitch'); hBtn.classList.remove('active-hub');
            hLayer.classList.remove('active-layer'); tLayer.classList.add('active-layer');
        }
    }

    function toggleEmotes() {
        document.getElementById('emote-picker').classList.toggle('active');
    }
    
    // Fonction globale pour ajouter l'emote dans l'input
    window.addEmote = function(code) {
        const input = document.getElementById('chat-input');
        input.value += ` :${code}: `;
        input.focus();
        toggleEmotes();
    }

    // --- AUTH MOCKUP ---
    async function checkAuthStatus() {
        // Simulation d'une connexion r√©ussie pour la d√©mo
        // Dans le vrai code, faites un fetch('/api/user')
        /*
        window.currentUser = {
            name: 'StreamerPro',
            avatar: 'https://i.pravatar.cc/150?img=11',
            badge: 'Admin' 
        };
        document.getElementById('my-avatar').src = window.currentUser.avatar;
        document.getElementById('my-username').innerText = window.currentUser.name;
        document.getElementById('my-badge').innerText = window.currentUser.badge;
        */
    }

    // INIT
    window.onload = () => {
        launchPlayer('twitch');
        openTab('tab-followed');
        checkAuthStatus();
    };
</script>
</body>
</html>
