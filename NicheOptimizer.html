<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V22 - WALL STREET EDITION (Full)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* =========================================
           THÃˆME GRAPHIQUE "WALL STREET DARK"
           ========================================= */
        :root {
            --bg-dark: #0b0c10;
            --bg-card: #1f2833;
            --neon-cyan: #66fcf1;
            --neon-green: #45a29e;
            --alert-red: #ff4d4d;
            --gold-star: #ffd700;
            --text-gray: #c5c6c7;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-gray); 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; 
        }

        #app-container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* HEADER & NAVIGATION */
        h1 { 
            font-family: 'Orbitron', sans-serif; 
            color: var(--neon-cyan); 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(102, 252, 241, 0.4); 
        }

        .version-tag {
            font-size: 12px; 
            background: var(--neon-green); 
            color: black; 
            padding: 4px 8px; 
            border-radius: 4px; 
            vertical-align: middle;
            margin-left: 10px;
        }

        .tabs-container {
            display: flex; 
            gap: 5px; 
            margin-bottom: 20px;
        }

        .tab-btn { 
            background: var(--bg-card); 
            color: #888; 
            padding: 15px; 
            border-radius: 8px 8px 0 0; 
            flex: 1; 
            text-align: center; 
            cursor: pointer; 
            font-family: 'Orbitron', sans-serif; 
            font-size: 14px; 
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            background: #2b3642;
            color: white;
        }

        .tab-btn.active { 
            background: #2b3642; 
            color: var(--neon-cyan); 
            border-bottom: 3px solid var(--neon-cyan); 
            font-weight: bold; 
        }

        /* LECTEUR & TIMER */
        .progress-bar-container { 
            width: 100%; 
            height: 6px; 
            background: #333; 
            margin-top: 10px; 
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar { 
            height: 100%; 
            width: 0%; 
            background: var(--neon-cyan); 
            transition: width 1s linear; 
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .player-frame { 
            border: 1px solid #333; 
            border-radius: 0 0 12px 12px; 
            overflow: hidden; 
            height: 550px; 
            background: black; 
            position: relative;
        }

        /* DASHBOARD BOURSIER */
        .stock-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-top: 30px; 
        }

        .stock-card { 
            background: var(--bg-card); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid #333; 
            text-align: center; 
            transition: transform 0.2s;
        }

        .stock-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-cyan);
        }
        
        .stock-value { 
            font-size: 36px; 
            font-weight: bold; 
            color: white; 
            margin: 10px 0; 
            font-family: 'Orbitron', sans-serif; 
        }
        
        .stock-label { 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            color: #888; 
            font-weight: 600;
        }
        
        /* Indicateurs de Tendance */
        .trend-pill { 
            display: inline-flex; 
            align-items: center; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: bold; 
            margin-top: 10px; 
        }
        .trend-up { background: rgba(0, 255, 127, 0.15); color: #00ff7f; border: 1px solid #00ff7f; }
        .trend-down { background: rgba(255, 77, 77, 0.15); color: #ff4d4d; border: 1px solid #ff4d4d; }
        .trend-flat { background: rgba(255, 255, 255, 0.1); color: #ccc; border: 1px solid #666; }

        /* Ã‰toiles de Notation */
        .star-rating { color: #444; font-size: 24px; margin: 15px 0; }
        .star-rating .filled { color: var(--gold-star); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        /* BOITE DU COACH IA */
        .coach-box { 
            text-align: left; 
            background: #181b21; 
            padding: 20px; 
            border-left: 4px solid var(--neon-cyan); 
            border-radius: 0 12px 12px 0;
            margin-top: 20px;
        }
        .coach-box h4 { color: var(--neon-cyan); font-family: 'Orbitron'; margin-bottom: 10px; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .coach-box ul { list-style: none; padding: 0; }
        .coach-box li { margin-bottom: 8px; font-size: 14px; color: #e0e0e0; padding-left: 15px; border-left: 2px solid #555; }

        /* CARTE DE RAID */
        .raid-card { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            background: #111; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--neon-cyan); 
            box-shadow: 0 0 15px rgba(102, 252, 241, 0.1);
        }
        .raid-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--neon-cyan); object-fit: cover; }
        .raid-thumb { width: 160px; height: 90px; border-radius: 6px; object-fit: cover; border: 1px solid #333; }
        .raid-info { flex: 1; text-align: left; }
        .raid-name { font-weight: bold; font-size: 18px; color: white; }
        .raid-game { color: #888; font-size: 14px; }
        .raid-viewers { color: var(--neon-green); font-weight: bold; font-size: 14px; margin-top: 5px; }

        /* BOUTONS ET INPUTS */
        .btn-action { 
            width: 100%; padding: 12px; background: var(--neon-cyan); color: #0b0c10; 
            font-weight: bold; border-radius: 6px; margin-top: 15px; cursor: pointer; transition: 0.2s; 
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-action:hover { background: #fff; transform: scale(1.02); }
        
        .input-std { 
            width: 100%; padding: 12px; background: #111; border: 1px solid #444; 
            color: white; text-align: center; border-radius: 6px; font-size: 14px; 
        }
        .input-std:focus { outline: none; border-color: var(--neon-cyan); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app-container">
    <h1>STREAMER HUB <span class="version-tag">V22 WALL STREET</span></h1>
    
    <div class="tabs-container">
        <div class="tab-btn active" onclick="switchTab('dashboard')">ðŸ“Š DASHBOARD & COACH</div>
        <div class="tab-btn" onclick="switchTab('boost')">âš¡ BOOST VISIBILITÃ‰</div>
        <div class="tab-btn" onclick="switchTab('raid')">ðŸ’¥ RAID FINDER</div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:5px;">
        <div id="player-status" class="text-xs text-gray-400">Chargement du flux...</div>
        <div style="text-align:right; font-size:11px; color:#666;" id="timer-text">Prochain changement: 3:00</div>
    </div>
    
    <div class="progress-bar-container">
        <div id="cycle-bar" class="progress-bar"></div>
    </div>
    
    <div class="player-frame">
        <div id="twitch-embed"></div>
    </div>
    
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button onclick="cycleStream('prev')" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded text-xs font-bold transition">
            <i class="fas fa-arrow-left"></i> PRÃ‰CÃ‰DENT
        </button>
        <button onclick="cycleStream('next')" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded text-xs font-bold transition">
            SUIVANT <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <div id="tab-dashboard" class="mt-8">
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-white mb-2">ANALYSE BOURSIÃˆRE & COACHING</h2>
            <p class="text-gray-500 text-sm mb-4">Entrez un pseudo pour obtenir son audit complet, sa notation et ses conseils.</p>
            
            <form onsubmit="runScan(event)" class="max-w-md mx-auto flex gap-2">
                <input id="scan-query" type="text" class="input-std" placeholder="Nom du Streamer (ex: JLTomy)...">
                <button type="submit" class="bg-white text-black font-bold px-6 rounded hover:bg-gray-300 transition">SCAN</button>
            </form>
        </div>

        <div id="scan-results" class="hidden">
            <div class="text-center mb-6">
                <img id="res-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-gray-700 shadow-lg">
                <div id="res-name" class="text-3xl font-bold text-white mt-3 font-orbitron">Name</div>
                
                <div id="res-stars" class="star-rating">
                    </div>
            </div>

            <div class="stock-grid">
                <div class="stock-card">
                    <div class="stock-label">TOTAL FOLLOWERS</div>
                    <div id="res-followers" class="stock-value">-</div>
                    <div id="trend-follow" class="trend-pill trend-flat">Analyse...</div>
                </div>
                
                <div class="stock-card">
                    <div class="stock-label">VUES TOTALES</div>
                    <div id="res-views" class="stock-value">-</div>
                    <div class="text-xs text-gray-500 mt-2">Cumul historique</div>
                </div>
                
                <div class="stock-card">
                    <div class="stock-label">SCORE PERFORMANCE</div>
                    <div id="res-score" class="stock-value" style="color:var(--neon-green)">-</div>
                    <div class="text-xs text-gray-500 mt-2">CalculÃ© par l'IA</div>
                </div>
            </div>

            <div class="coach-box">
                <div style="font-size:11px; color:#888; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">
                    <i class="fas fa-user-tie"></i> Le Verdict du Coach
                </div>
                <div id="ai-content" class="ai-output-enhanced">
                    <p class="text-gray-500 italic">Analyse du profil en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-boost" class="hidden mt-8 text-center">
        <div class="max-w-lg mx-auto bg-gray-900 p-8 rounded-xl border border-gray-800">
            <h2 class="text-3xl font-bold text-pink-500 mb-4">BOOST VISIBILITÃ‰</h2>
            <p class="mb-6 text-gray-400">
                Prenez le contrÃ´le exclusif du lecteur vidÃ©o de tous les utilisateurs connectÃ©s pendant 15 minutes.
            </p>
            <input id="boost-channel" type="text" class="input-std mb-4" placeholder="Entrez votre chaÃ®ne Twitch ici">
            <button onclick="activateBoost()" class="btn-action" style="background:var(--alert-red); color:white;">
                <i class="fas fa-rocket"></i> ACTIVER LE BOOST
            </button>
            <div id="boost-msg" class="mt-4 text-sm font-bold"></div>
        </div>
    </div>

    <div id="tab-raid" class="hidden mt-8">
        <div class="text-center mb-6">
            <h2 class="text-xl font-bold text-cyan-400 mb-2">RAID FINDER OPTIMISÃ‰</h2>
            <p class="text-gray-500 text-sm">Trouvez la cible idÃ©ale pour envoyer vos spectateurs.</p>
        </div>
        
        <form onsubmit="runRaid(event)" class="flex gap-2 max-w-lg mx-auto mb-8">
            <input id="raid-game" type="text" class="input-std" placeholder="Jeu (ex: Minecraft)" style="flex:2;">
            <select id="raid-max" class="input-std" style="flex:1;">
                <option value="10">Micro (10)</option>
                <option value="50" selected>Petit (50)</option>
                <option value="100">Moyen (100)</option>
                <option value="500">Gros (500)</option>
            </select>
            <button type="submit" class="bg-cyan-500 text-black px-6 font-bold rounded hover:bg-cyan-400 transition">GO</button>
        </form>
        
        <div id="raid-res" class="max-w-2xl mx-auto">
            </div>
    </div>

</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = window.location.origin;
    const CYCLE_TIME = 180; // 3 Minutes
    
    let timerVal = CYCLE_TIME;
    let timerInterval = null;
    let embed = null;

    // --- 1. GESTION DU LECTEUR VIDÃ‰O ---
    function initPlayer(channel) {
        // Anti-clignotement : si c'est dÃ©jÃ  la bonne chaÃ®ne, on ne fait rien
        if(embed && embed.getChannel && embed.getChannel() === channel) return;
        
        document.getElementById('twitch-embed').innerHTML = '';
        
        const options = {
            width: "100%", height: "100%", 
            channel: channel, 
            layout: "video-and-chat", 
            autoplay: true, 
            muted: true, // CRITIQUE : Autoplay nÃ©cessite Muted sur Chrome/Firefox
            // Liste exhaustive des parents pour Ã©viter l'Ã©cran noir
            parent: ["localhost", "127.0.0.1", "justplayerstreamhubpro.onrender.com", "justplayer.fr", "www.justplayer.fr", window.location.hostname]
        };
        
        embed = new Twitch.Embed("twitch-embed", options);
        document.getElementById('player-status').innerText = "Lecture en cours : " + channel;
    }

    // --- 2. GESTION DU TIMER (Barre de Progression) ---
    function startTimer() {
        clearInterval(timerInterval);
        timerVal = CYCLE_TIME;
        updateBar();
        
        timerInterval = setInterval(() => {
            timerVal--;
            updateBar();
            if(timerVal <= 0) {
                cycleStream('next');
            }
        }, 1000);
    }
    
    function updateBar() {
        const pct = (timerVal / CYCLE_TIME) * 100;
        document.getElementById('cycle-bar').style.width = pct + "%";
        
        const m = Math.floor(timerVal / 60);
        const s = timerVal % 60;
        document.getElementById('timer-text').innerText = `Prochain changement : ${m}:${s < 10 ? '0'+s : s}`;
    }

    // --- 3. ROTATION & BOOST ---
    async function cycleStream(dir) {
        // Reset visuel immÃ©diat pour donner un feedback utilisateur
        timerVal = CYCLE_TIME; 
        updateBar(); 
        
        try {
            const r = await fetch(`${API_BASE}/cycle_stream`, {
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({direction:dir})
            });
            const d = await r.json();
            if(d.success) initPlayer(d.channel);
        } catch(e) { console.error("Erreur cycle:", e); }
    }

    async function checkStatus() {
        // VÃ©rifie au dÃ©marrage si un Boost est actif ou si on lance la rotation
        try {
            const r = await fetch(`${API_BASE}/get_default_stream`);
            const d = await r.json();
            
            if(d.viewers === 'BOOST') {
                // Mode Boost : Barre rouge, pas de timer
                clearInterval(timerInterval);
                document.getElementById('cycle-bar').style.background = "#ff4d4d";
                document.getElementById('cycle-bar').style.width = "100%";
                document.getElementById('timer-text').innerText = "âš ï¸ BOOST ACTIF - ROTATION PAUSE";
                initPlayer(d.channel);
            } else {
                // Mode Normal : Barre cyan, timer actif
                document.getElementById('cycle-bar').style.background = "#66fcf1";
                startTimer();
                initPlayer(d.channel);
            }
        } catch(e) { 
            // Fallback en cas d'erreur serveur
            initPlayer('twitch'); 
        }
    }

    // --- 4. SCAN, DATA & NOTATION ---
    async function runScan(e) {
        e.preventDefault();
        const q = document.getElementById('scan-query').value;
        const resDiv = document.getElementById('scan-results');
        const aiDiv = document.getElementById('ai-content');
        
        if(!q) return;

        resDiv.classList.remove('hidden');
        aiDiv.innerHTML = "<p class='text-center'><i class='fas fa-sync fa-spin'></i> Analyse BoursiÃ¨re & IA en cours...</p>";
        
        try {
            const res = await fetch(`${API_BASE}/scan_target`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({query:q}) 
            });
            const d = await res.json();
            
            if(d.type === 'user') {
                const u = d.user_data;
                const h = d.history;
                
                // Remplissage des donnÃ©es de base
                document.getElementById('res-img').src = u.profile_image_url;
                document.getElementById('res-name').innerText = u.display_name;
                document.getElementById('res-followers').innerText = Number(u.total_followers).toLocaleString();
                document.getElementById('res-views').innerText = Number(u.total_views).toLocaleString();
                document.getElementById('res-score').innerText = d.stars + "/5";

                // GESTION ETOILES (Rendu visuel)
                let starsHTML = "";
                for(let i=1; i<=5; i++) {
                    starsHTML += i <= d.stars ? '<i class="fas fa-star filled"></i>' : '<i class="far fa-star"></i>';
                }
                document.getElementById('res-stars').innerHTML = starsHTML;

                // GESTION TENDANCE (La pilule colorÃ©e)
                const trendEl = document.getElementById('trend-follow');
                if(h.trend === 'up') {
                    trendEl.className = "trend-pill trend-up";
                    trendEl.innerHTML = `<i class="fas fa-arrow-up"></i> +${h.diff}`;
                } else if(h.trend === 'down') {
                    trendEl.className = "trend-pill trend-down";
                    trendEl.innerHTML = `<i class="fas fa-arrow-down"></i> ${h.diff}`;
                } else {
                    trendEl.className = "trend-pill trend-flat";
                    trendEl.innerText = "Stable";
                }

                // APPEL IA COACH
                const aiRes = await fetch(`${API_BASE}/critique_ia`, {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({
                        type:'niche', 
                        query: u.display_name, 
                        history_data: h, 
                        stars: d.stars
                    })
                });
                const aiData = await aiRes.json();
                aiDiv.innerHTML = aiData.html_response;
                
                // Lancer la chaÃ®ne analysÃ©e dans le lecteur
                initPlayer(u.login); 
            }
        } catch(e) { 
            aiDiv.innerText = "Erreur lors de l'analyse. VÃ©rifiez le pseudo."; 
        }
    }

    // --- 5. RAID FINDER (Correctif Images) ---
    async function runRaid(e) {
        e.preventDefault();
        const game = document.getElementById('raid-game').value;
        const max = document.getElementById('raid-max').value;
        const box = document.getElementById('raid-res');
        
        box.innerHTML = "<p class='text-center text-gray-500'>Recherche de la meilleure cible...</p>";
        
        try {
            const r = await fetch(`${API_BASE}/start_raid`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({game, max_viewers:max}) 
            });
            const d = await r.json();
            
            if(d.success) {
                const t = d.target;
                // Affichage propre avec Avatar rond + Miniature
                box.innerHTML = `
                    <div class="raid-card">
                        <img src="${t.avatar_url}" class="raid-avatar" alt="Avatar">
                        <img src="${t.thumbnail_url}" class="raid-thumb" alt="Stream">
                        <div class="raid-info">
                            <div class="raid-name">${t.name}</div>
                            <div class="raid-game">${t.login}</div>
                            <div class="raid-viewers">ðŸŸ¢ ${t.viewers} spectateurs</div>
                        </div>
                        <button onclick="launchPlayer('${t.login}')" class="bg-cyan-500 text-black font-bold px-4 py-2 rounded hover:bg-white transition">
                            RAID
                        </button>
                    </div>
                `;
            } else { 
                box.innerHTML = `<p style="color:var(--alert-red); text-align:center;">${d.error}</p>`; 
            }
        } catch(e) { 
            box.innerText = "Erreur de connexion au serveur."; 
        }
    }

    // --- 6. BOOST ---
    async function activateBoost() {
        const c = document.getElementById('boost-channel').value;
        const msg = document.getElementById('boost-msg');
        if(!c) return;
        
        msg.innerText = "Demande d'activation...";
        try {
            const r = await fetch(`${API_BASE}/stream_boost`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({channel:c}) 
            });
            const d = await r.json();
            msg.innerHTML = d.html_response || d.error;
            
            if(d.success) {
                // RafraÃ®chir la page aprÃ¨s 1.5s pour voir le boost
                setTimeout(() => location.reload(), 1500);
            }
        } catch(e){ 
            msg.innerText = "Erreur technique."; 
        }
    }

    // --- NAVIGATION ---
    function switchTab(id) {
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-boost').classList.add('hidden');
        document.getElementById('tab-raid').classList.add('hidden');
        document.getElementById('tab-'+id).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Initialisation au chargement
    window.onload = checkStatus;
</script>
</body>
</html>
