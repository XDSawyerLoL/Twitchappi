<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V53 - POLISHED DIAMOND</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0b0b0d;
            --primary: #ff0099;
            --secondary: #00f2ea;
            --text-main: #e0e0e0;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary); }

        /* CAROUSEL */
        .carousel-track { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; scroll-behavior: smooth; }
        .stream-card { 
            flex: 0 0 300px; height: 170px;
            background: #111; border: 1px solid #222; border-radius: 12px; 
            overflow: hidden; position: relative; cursor: pointer; transition: 0.2s;
        }
        .stream-card:hover { border-color: var(--secondary); transform: translateY(-4px); box-shadow: 0 5px 20px rgba(0, 242, 234, 0.15); }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.3s; }
        .stream-card:hover .card-img { opacity: 1; }

        /* UI ELEMENTS */
        .glass-panel { background: var(--bg-panel); border: 1px solid #1f1f23; }
        .tab-btn { flex: 1; padding: 14px; text-align: center; color: #666; font-family: 'Orbitron'; font-size: 11px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: #151515; }
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* CHAT HUB */
        .hub-msg { padding: 6px 10px; margin-bottom: 4px; border-radius: 4px; background: rgba(255,255,255,0.03); font-size: 13px; line-height: 1.4; animation: fadeIn 0.2s ease; }
        .emoji-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; position: absolute; bottom: 50px; right: 10px; z-index: 50; width: 220px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .emoji-btn { cursor: pointer; font-size: 18px; text-align: center; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .emoji-btn:hover { background: #333; transform: scale(1.2); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col p-4">

    <header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-orbitron italic tracking-widest"><span class="text-[#00f2ea]">STREAMER</span> HUB <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">V53</span></h1>
            <div id="socket-status" class="hidden md:block text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">HUB OFF</div>
        </div>
        <div>
             <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
                <i class="fab fa-twitch"></i> CONNEXION
            </button>
            <div id="user-area" class="hidden flex items-center gap-3">
                <img id="user-avatar" src="https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-70x70.png" class="w-8 h-8 rounded-full border border-[#00f2ea] object-cover">
                <span id="user-name" class="font-bold text-white text-sm"></span>
                <button onclick="logout()" class="text-gray-500 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>

    <div class="mb-4 relative group">
        <div id="carousel" class="carousel-track" onwheel="this.scrollLeft += event.deltaY; event.preventDefault();">
            <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500 text-sm">
                <i class="fas fa-satellite-dish mb-2 text-[#ff0099]"></i><br>Connectez-vous pour voir vos cha√Ænes.
            </div>
        </div>
        <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
    </div>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
        
        <div class="lg:col-span-8 flex flex-col gap-4 h-full">
            <div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl">
                <div class="bg-[#080808] p-3 flex justify-between items-center border-b border-[#222]">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
                        <span id="current-channel-display" class="font-orbitron text-[#00f2ea] text-sm tracking-wider">OFFLINE</span>
                        <span id="player-mode-badge" class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400">AUTO</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cycle('prev')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="cycle('next')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="video-container" class="flex-grow bg-black relative w-full h-full"></div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col glass-panel rounded-lg overflow-hidden h-full max-h-[calc(100vh-280px)] lg:max-h-full">
            
            <div class="tab-nav">
                <button class="tab-btn active" onclick="openTab('chat')"><i class="fas fa-comments mr-1"></i> TCHAT</button>
                <button class="tab-btn" onclick="openTab('stats')"><i class="fas fa-chart-pie mr-1"></i> STATS</button>
                <button class="tab-btn" onclick="openTab('tools')"><i class="fas fa-toolbox mr-1"></i> OUTILS</button>
            </div>

            <div id="tab-chat" class="tab-content active bg-[#0e0e10] relative">
                <div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222]">
                    <button onclick="toggleChatMode('twitch')" id="btn-mode-twitch" class="flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded transition">TWITCH</button>
                    <button onclick="toggleChatMode('hub')" id="btn-mode-hub" class="flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white transition">HUB SECURE</button>
                </div>
                
                <div id="chat-container-twitch" class="flex-grow relative h-full">
                    <iframe id="twitch-chat-frame" src="" width="100%" height="100%" frameborder="0"></iframe>
                </div>

                <div id="chat-container-hub" class="flex-grow hidden flex-col relative bg-[#0b0b0d] h-full">
                    <div id="hub-messages" class="flex-grow overflow-y-auto p-3 scrollbar-thin">
                        <div class="text-center text-gray-600 text-xs mt-4">Bienvenue sur le Hub S√©curis√©.</div>
                    </div>
                    
                    <div id="emoji-picker" class="emoji-picker hidden">
                        </div>

                    <form onsubmit="sendHubMessage(event)" class="p-2 border-t border-[#222] flex gap-2 bg-[#080808] relative">
                        <button type="button" onclick="document.getElementById('emoji-picker').classList.toggle('hidden')" class="text-gray-400 hover:text-yellow-400 px-1"><i class="far fa-smile"></i></button>
                        <input id="hub-input" type="text" placeholder="Message..." class="bg-[#1a1a1a] text-white text-xs p-2 rounded flex-grow outline-none border border-[#333] focus:border-[#00f2ea]">
                        <button class="text-[#00f2ea] px-2 hover:text-white"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>

            <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] scrollbar-thin">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
                        <div class="text-[10px] text-gray-500 uppercase">Viewers Totaux</div>
                        <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
                    </div>
                    <div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
                        <div class="text-[10px] text-gray-500 uppercase">Cha√Ænes</div>
                        <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">Tendance</h4>
                        <div class="h-40"><canvas id="chartViewers"></canvas></div>
                    </div>
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase">Top Jeux</h4>
                        <div class="h-48"><canvas id="chartGames"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] space-y-6">
                <div>
                    <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">SCANNER IA</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="scan-query" type="text" placeholder="Pseudo..." class="flex-grow bg-[#151515] border border-[#333] text-white p-2 rounded text-xs outline-none focus:border-[#00f2ea]">
                        <button onclick="runScan()" class="bg-[#00f2ea] text-black px-3 rounded font-bold hover:bg-white"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="scan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
                        <div class="flex gap-3 items-center mb-3">
                            <img id="scan-img" src="" class="w-12 h-12 rounded-full border border-[#00f2ea]">
                            <div>
                                <div id="scan-name" class="font-bold text-white">--</div>
                                <div id="scan-game" class="text-xs text-gray-500">--</div>
                            </div>
                        </div>
                        <div id="scan-ai" class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION DYNAMIQUE (LE FIX CRITIQUE) ---
        const API_BASE = window.location.origin;
        
        // AUTO-DETECTION DU DOMAINE pour Twitch
        const hostname = window.location.hostname;
        const PARENTS = ["justplayer.fr", "www.justplayer.fr", "localhost", "127.0.0.1"];
        if (!PARENTS.includes(hostname)) PARENTS.push(hostname);

        let player;
        let socket;
        let currentChannel = "twitch";
        let charts = {};

        // --- 2. INIT ---
        window.onload = () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                location.replace(`https:${location.href.substring(location.protocol.length)}`);
            }
            
            initEmojis();
            checkAuth();
            initSocket();
            initPlayer();
            loadStatsDashboard();

            window.addEventListener("message", (e) => {
                if(e.data === "auth_success") window.location.reload();
            });
        };

        // --- 3. FIX AVATAR & AUTH ---
        async function checkAuth() {
            try {
                const res = await fetch('/twitch_user_status');
                const data = await res.json();
                if(data.is_connected) {
                    document.getElementById('btn-auth').classList.add('hidden');
                    document.getElementById('user-area').classList.remove('hidden');
                    document.getElementById('user-name').innerText = data.display_name;
                    
                    // Astuce pour l'image : on utilise le scanner interne pour r√©cup√©rer l'avatar
                    fetchScanAvatar(data.display_name);
                    
                    loadFollowed();
                }
            } catch(e) {}
        }

        async function fetchScanAvatar(username) {
            try {
                const res = await fetch('/scan_target', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:username})});
                const d = await res.json();
                if(d.success && d.user_data.profile_image_url) {
                    document.getElementById('user-avatar').src = d.user_data.profile_image_url;
                }
            } catch(e) {}
        }

        // --- 4. FIX HUB CHAT & EMOJIS ---
        function initSocket() {
            try {
                socket = io(); // Auto-connect
                socket.on('connect', () => {
                    const el = document.getElementById('socket-status');
                    el.innerText = "HUB ONLINE";
                    el.className = "text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded shadow-[0_0_5px_#00f2ea]";
                });
                socket.on('chat message', (msg) => {
                    const box = document.getElementById('hub-messages');
                    const user = msg.user || 'Anon';
                    const text = msg.text || msg;
                    box.innerHTML += `<div class="hub-msg"><strong class="text-[#00f2ea]">${user}:</strong> <span class="text-gray-300">${text}</span></div>`;
                    box.scrollTop = box.scrollHeight;
                });
            } catch(e) {}
        }

        function initEmojis() {
            const emojis = ['üòÇ','üò≠','üî•','‚ù§Ô∏è','üëç','üëÄ','üéâ','üíÄ','üí©','ü§°','üöÄ','ü§¨','üëã','ü§î','üòé','üíú','‚ú®','üíØ'];
            const picker = document.getElementById('emoji-picker');
            emojis.forEach(e => {
                const btn = document.createElement('div');
                btn.className = 'emoji-btn';
                btn.innerText = e;
                btn.onclick = () => {
                    document.getElementById('hub-input').value += e;
                    picker.classList.add('hidden');
                    document.getElementById('hub-input').focus();
                };
                picker.appendChild(btn);
            });
        }

        function sendHubMessage(e) {
            e.preventDefault();
            const input = document.getElementById('hub-input');
            if(input.value && socket) {
                socket.emit('chat message', input.value);
                // Feedback instantan√©
                const box = document.getElementById('hub-messages');
                box.innerHTML += `<div class="hub-msg border-l-2 border-[#ff0099]"><strong class="text-[#ff0099]">Moi:</strong> <span class="text-gray-300">${input.value}</span></div>`;
                box.scrollTop = box.scrollHeight;
                input.value = "";
            }
        }

        // --- 5. PLAYER & TWITCH CHAT FIX ---
        async function initPlayer() {
            try {
                const res = await fetch('/get_default_stream');
                const data = await res.json();
                if(data.success) {
                    currentChannel = data.channel;
                    document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
                    document.getElementById('player-mode-badge').innerText = data.mode;
                    
                    document.getElementById('video-container').innerHTML = "";
                    const opts = { width: "100%", height: "100%", channel: currentChannel, layout: "video", parent: PARENTS };
                    player = new Twitch.Embed("video-container", opts);
                    
                    updateTwitchChatFrame(currentChannel);
                }
            } catch(e) {}
        }

        function updateTwitchChatFrame(channel) {
            // Construit l'URL avec TOUS les parents possibles pour √©viter le blocage
            const parentParams = PARENTS.map(d => `parent=${d}`).join('&');
            const url = `https://www.twitch.tv/embed/${channel}/chat?${parentParams}&darkpopout`;
            document.getElementById('twitch-chat-frame').src = url;
        }

        function toggleChatMode(mode) {
            const tw = document.getElementById('chat-container-twitch');
            const hb = document.getElementById('chat-container-hub');
            const btnTw = document.getElementById('btn-mode-twitch');
            const btnHb = document.getElementById('btn-mode-hub');

            if(mode === 'hub') {
                tw.classList.add('hidden');
                hb.classList.remove('hidden'); hb.classList.add('flex');
                btnHb.className = "flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded transition";
                btnTw.className = "flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white transition";
            } else {
                hb.classList.add('hidden'); hb.classList.remove('flex');
                tw.classList.remove('hidden');
                btnTw.className = "flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded transition";
                btnHb.className = "flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white transition";
            }
        }

        async function cycle(dir) {
            const res = await fetch('/cycle_stream', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({direction:dir}) });
            const data = await res.json();
            if(data.success) {
                currentChannel = data.channel;
                player.setChannel(currentChannel);
                document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
                updateTwitchChatFrame(currentChannel);
            }
        }

        // --- 6. STATS & CAROUSEL ---
        async function loadFollowed() {
            const el = document.getElementById('carousel');
            el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-[#00f2ea]"></i></div>';
            try {
                const res = await fetch('/followed_streams');
                const data = await res.json();
                if(data.success && data.streams.length > 0) {
                    el.innerHTML = "";
                    data.streams.forEach(s => {
                        const thumb = s.thumbnail_url.replace('{width}', '400').replace('{height}', '225');
                        el.innerHTML += `
                            <div class="stream-card flex-shrink-0" onclick="changeChannel('${s.user_login}')">
                                <img src="${thumb}" class="card-img">
                                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">
                                    <div class="font-bold text-white text-sm truncate">${s.user_name}</div>
                                    <div class="text-[#00f2ea] text-xs truncate">${s.game_name}</div>
                                </div>
                                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div>
                            </div>`;
                    });
                } else { el.innerHTML = '<div class="w-full text-center py-10 text-gray-500">Aucun live.</div>'; }
            } catch(e) { el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur.</div>'; }
        }

        function changeChannel(c) {
            currentChannel = c;
            player.setChannel(c);
            document.getElementById('current-channel-display').innerText = c.toUpperCase();
            updateTwitchChatFrame(c);
        }

        async function loadStatsDashboard() {
            try {
                const res = await fetch('/api/stats/global');
                const d = await res.json();
                if(d.success) {
                    document.getElementById('kpi-viewers').innerText = Number(d.total_viewers).toLocaleString();
                    document.getElementById('kpi-channels').innerText = d.total_channels;
                    renderChart('chartViewers', 'line', d.history.live.labels, d.history.live.values, 'Viewers', '#00f2ea');
                    renderChart('chartGames', 'bar', ['Just Chatting', 'LoL', 'GTA V', 'CS2'], [120, 90, 80, 50], 'Popularit√©', '#ff0099');
                }
            } catch(e) {}
        }

        function renderChart(id, type, labels, data, label, color) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: type==='line'?'rgba(0,242,234,0.1)':color, borderColor: color, fill: type==='line', tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }
        
        // --- 7. UTILS ---
        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            // Logic to highlight correct button
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => { if(b.innerText.toLowerCase().includes(id) || (id === 'tools' && b.innerText.includes('OUTILS'))) b.classList.add('active'); });
        }
        function startAuth() { window.open('/twitch_auth_start', 'login', 'width=500,height=700'); }
        function logout() { fetch('/twitch_logout', {method:'POST'}).then(()=>location.reload()); }
        async function runScan() {
            const q = document.getElementById('scan-query').value;
            const box = document.getElementById('scan-res');
            box.classList.remove('hidden');
            document.getElementById('scan-ai').innerHTML = '<i class="fas fa-spinner fa-spin"></i>...';
            const res = await fetch('/scan_target', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})});
            const d = await res.json();
            if(d.success) {
                document.getElementById('scan-name').innerText = d.user_data.display_name;
                document.getElementById('scan-game').innerText = d.user_data.game_name;
                document.getElementById('scan-img').src = d.user_data.profile_image_url;
                const ai = await fetch('/critique_ia', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'niche', query:d.user_data.display_name})});
                const aiD = await ai.json();
                document.getElementById('scan-ai').innerHTML = aiD.html_response;
            }
        }
    </script>
</body>
</html>
