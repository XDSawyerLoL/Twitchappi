<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streamer Hub ‚Äì Pro Analytics</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }

    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:hidden;
    }

    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }

    .glass-panel{
      background:var(--bg-panel);
      border:1px solid var(--border-color);
    }

    /* ===== NETFLIX GAME CATALOG ===== */
    .game-catalog{
      display:flex;
      gap:16px;
      overflow-x:auto;
      padding:12px 6px;
      scroll-behavior:smooth;
    }

    .game-card{
      flex:0 0 220px;
      height:320px;
      border-radius:14px;
      overflow:hidden;
      background:#111;
      border:1px solid #222;
      cursor:pointer;
      transition:.25s;
      position:relative;
    }

    .game-card:hover{
      transform:scale(1.05);
      border-color:var(--secondary);
      box-shadow:0 10px 30px rgba(0,242,234,.25);
      z-index:5;
    }

    .game-card img{
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:.85;
      transition:.25s;
    }

    .game-card:hover img{ opacity:1; }

    .game-overlay{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      padding:12px;
      background:linear-gradient(to top, rgba(0,0,0,.85), transparent);
    }

    .game-title{
      font-weight:800;
      font-size:14px;
      color:white;
    }

    .game-sub{
      font-size:11px;
      color:#aaa;
    }

    /* tooltip simple */
    .tip{
      cursor:help;
      color:#888;
      margin-left:4px;
    }
  </style>
</head>
<body class="h-screen flex flex-col p-4">

<header class="mb-4">
  <h1 class="font-orbitron text-2xl tracking-widest">
    <span class="text-[#00f2ea]">STREAMER</span> HUB
    <span class="text-[#ff0099]">PRO</span>
  </h1>
  <p class="text-xs text-gray-400">
    D√©couvre des petits streamers, comprends tes stats, trouve ta niche
  </p>
</header>

<!-- üé¨ CATALOGUE JEUX NETFLIX -->
<section class="mb-6">
  <h2 class="font-orbitron text-[#00f2ea] text-sm mb-2">
    üéÆ Explorer par jeu
    <span class="tip" title="Clique sur un jeu pour lancer automatiquement un streamer entre 0 et 100 viewers dans cette cat√©gorie.">
      ‚ùì
    </span>
  </h2>

  <div id="gameCatalog" class="game-catalog">
    <div class="text-gray-500 text-xs p-6">Chargement du catalogue‚Ä¶</div>
  </div>
</section>

<!-- PLAYER -->
<section class="glass-panel rounded-lg overflow-hidden flex-grow mb-4">
  <div class="bg-black text-xs p-2 flex justify-between items-center">
    <div>
      <span id="currentChannel" class="text-[#00f2ea] font-orbitron">OFFLINE</span>
      <span id="viewerCount" class="text-[#ff0099] ml-2">0 viewers</span>
    </div>
    <div class="text-gray-400 text-[10px]">
      petits streamers only (‚â§100)
    </div>
  </div>
  <div id="video-container" class="w-full h-[65vh] bg-black"></div>
</section>

<!-- JS -->
<script>
const API = window.location.origin;
const PARENTS = ['localhost','127.0.0.1',location.hostname].join('&parent=');

let currentChannel = null;

/* ===== PLAYER ===== */
function loadPlayer(channel){
  currentChannel = channel;
  document.getElementById('currentChannel').innerText = channel.toUpperCase();
  const iframe = `
    <iframe
      src="https://player.twitch.tv/?channel=${channel}&parent=${PARENTS}&theme=dark"
      width="100%" height="100%"
      allowfullscreen
      frameborder="0">
    </iframe>`;
  document.getElementById('video-container').innerHTML = iframe;

  fetch(API + '/stream_info',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ channel })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.stream){
      document.getElementById('viewerCount').innerText =
        d.stream.viewer_count + ' viewers';
    }
  });
}

/* ===== NETFLIX GAME CATALOG ===== */
async function loadGameCatalog(){
  const box = document.getElementById('gameCatalog');
  const res = await fetch(API + '/api/stats/top_games');
  const data = await res.json();
  box.innerHTML = '';

  data.games.forEach(g=>{
    const img = g.box_art_url.replace('52','285').replace('72','380');
    box.innerHTML += `
      <div class="game-card" onclick="playRandomStreamer('${g.name}')">
        <img src="${img}">
        <div class="game-overlay">
          <div class="game-title">${g.name}</div>
          <div class="game-sub">Voir un petit streamer</div>
        </div>
      </div>
    `;
  });
}

/* ===== RANDOM SMALL STREAMER ===== */
async function playRandomStreamer(game){
  const res = await fetch(API + '/start_raid',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      game,
      max_viewers:100
    })
  });
  const data = await res.json();
  if(data.success && data.target){
    loadPlayer(data.target.login);
  }else{
    alert('Aucun petit streamer trouv√© pour ce jeu.');
  }
}

/* ===== INIT ===== */
window.addEventListener('load', async ()=>{
  loadGameCatalog();

  // stream par d√©faut
  const r = await fetch(API + '/get_default_stream');
  const d = await r.json();
  if(d.success){
    loadPlayer(d.channel);
  }
});
</script>

</body>
</html>
