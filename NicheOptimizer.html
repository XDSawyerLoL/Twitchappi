<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V52 - ULTIMATE PERFORMANCE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0b0b0d;
            --primary: #ff0099;
            --secondary: #00f2ea;
            --text-main: #e0e0e0;
            --border-color: #1f1f23;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .carousel-track {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 5px;
            scroll-behavior: smooth;
            cursor: grab;
        }

        .carousel-track.active {
            cursor: grabbing;
        }

        .stream-card {
            flex: 0 0 300px;
            height: 170px;
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }

        .stream-card:hover {
            border-color: var(--secondary);
            transform: translateY(-4px);
            box-shadow: 0 5px 20px rgba(0, 242, 234, 0.15);
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: 0.3s;
        }

        .stream-card:hover .card-img {
            opacity: 1;
        }

        .glass-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
        }

        .tab-nav {
            display: flex;
            background: #080808;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            color: #666;
            font-family: 'Orbitron';
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }

        .tab-btn:hover {
            color: white;
            background: #111;
        }

        .tab-btn.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
            background: #151515;
        }

        .tab-content {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        .cyber-input {
            background: #151515;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Inter';
            font-size: 13px;
            outline: none;
            transition: 0.3s;
            width: 100%;
        }

        .cyber-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 10px rgba(0, 242, 234, 0.2);
        }

        .hub-msg {
            padding: 8px;
            border-bottom: 1px solid #1a1a1a;
            font-size: 13px;
            line-height: 1.4;
        }

        .hub-msg strong {
            font-family: 'Orbitron';
            font-size: 11px;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }

        /* ===== FIREBASE HUB STATUS ===== */
        #socket-status {
            text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded;
            transition: all 0.3s ease;
            animation: none;
        }

        #socket-status.connected {
            color: #00f2ea;
            border-color: #00f2ea;
            box-shadow: 0 0 8px rgba(0, 242, 234, 0.6);
            animation: hub-pulse 2s infinite;
        }

        @keyframes hub-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ===== BEST TIME TOOL STYLES ===== */
        .best-time-tool {
            background: #151515;
            border: 1px solid #00f2ea;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: inset 0 0 10px rgba(0, 242, 234, 0.1);
        }

        .best-time-tool h4 {
            color: #00f2ea;
            font-family: 'Orbitron';
            font-size: 12px;
            margin-bottom: 10px;
            border-bottom: 1px solid #00f2ea;
            padding-bottom: 8px;
        }

        .best-time-tool .form-group {
            margin-bottom: 10px;
        }

        .best-time-tool input {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .best-time-tool input:focus {
            border-color: #00f2ea;
            box-shadow: 0 0 8px rgba(0, 242, 234, 0.2);
            outline: none;
        }

        .best-time-tool button {
            width: 100%;
            background: #00f2ea;
            color: black;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Orbitron';
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .best-time-tool button:hover:not(:disabled) {
            background: white;
            box-shadow: 0 0 15px rgba(0, 242, 234, 0.4);
            transform: translateY(-1px);
        }

        .best-time-tool button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .best-time-results {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .best-time-results h5 {
            color: #00f2ea;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .best-time-results ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .best-time-results li {
            margin-bottom: 6px;
            color: #e0e0e0;
            line-height: 1.3;
        }

        .best-time-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 242, 234, 0.3);
            border-radius: 50%;
            border-top-color: #00f2ea;
            animation: bt-spin 1s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes bt-spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen flex flex-col p-4">
    <!-- HEADER -->
    <header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-orbitron italic tracking-widest">
                <span class="text-[#00f2ea]">STREAMER</span> HUB 
                <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">V52+</span>
            </h1>
            <div id="socket-status" class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">
                HUB DISCONNECTED
            </div>
        </div>
        <div>
            <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
                <i class="fab fa-twitch"></i> CONNEXION
            </button>
            <div id="user-area" class="hidden flex items-center gap-3">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-[#00f2ea]">
                <span id="user-name" class="font-bold text-white text-sm"></span>
                <button onclick="logout()" class="text-gray-500 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- CAROUSEL -->
    <div class="mb-4 relative group">
        <div id="carousel" class="carousel-track">
            <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
                <i class="fas fa-satellite-dish mb-2"></i><br>
                Connectez-vous pour voir vos cha√Ænes.
            </div>
        </div>
        <div class="absolute top-0 right-0 h-full w-20 bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
    </div>

    <!-- MAIN GRID -->
    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
        <!-- VIDEO PLAYER -->
        <div class="lg:col-span-9 flex flex-col gap-4 h-full">
            <!-- PLAYER -->
            <div class="glass-panel flex-grow relative overflow-hidden flex flex-col rounded-lg shadow-2xl">
                <div class="bg-[#080808] p-3 flex justify-between items-center border-b border-[#222]">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_10px_red]"></div>
                        <span id="current-channel-display" class="font-orbitron text-[#00f2ea] text-sm tracking-wider truncate">
                            OFFLINE
                        </span>
                        <span id="player-mode-badge" class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400 flex-shrink-0">
                            AUTO
                        </span>
                        <span id="viewer-count" class="text-[10px] text-[#ff0099] font-bold flex-shrink-0">
                            0 viewers
                        </span>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="cycle('prev')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="cycle('next')" class="bg-[#1a1a1a] hover:bg-[#333] text-white w-8 h-8 rounded flex items-center justify-center">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="video-container" class="flex-grow bg-black relative w-full h-full overflow-hidden min-h-[62vh] lg:min-h-[70vh]"></div>
            </div>

            <!-- PLAYER INSIGHTS (tabs sous le lecteur) -->
            <div class="glass-panel rounded-lg overflow-hidden">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="openPlayerTab(event,'overview')">
                        <i class="fas fa-bolt mr-1"></i> OVERVIEW
                    </button>
                    <button class="tab-btn" onclick="openPlayerTab(event,'analytics')">
                        <i class="fas fa-chart-line mr-1"></i> ANALYTICS
                    </button>
                    <button class="tab-btn" onclick="openPlayerTab(event,'growth')">
                        <i class="fas fa-wand-magic-sparkles mr-1"></i> GROWTH IA
                    </button>
                </div>

                <div id="player-tab-overview" class="tab-content active p-4 bg-[#0b0b0d]">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="bg-[#151515] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Moyenne 30j</div>
                            <div id="pl-avg" class="text-xl font-orbitron text-white">--</div>
                        </div>
                        <div class="bg-[#151515] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Pic 30j</div>
                            <div id="pl-peak" class="text-xl font-orbitron text-white">--</div>
                        </div>
                        <div class="bg-[#151515] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Croissance</div>
                            <div id="pl-growth" class="text-xl font-orbitron text-white">--</div>
                        </div>
                        <div class="bg-[#151515] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Volatilit√©</div>
                            <div id="pl-vol" class="text-xl font-orbitron text-white">--</div>
                        </div>
                    </div>
                    <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-wave-square mr-1"></i> S√©rie (derni√®res heures)</h4>
                        <div class="h-36"><canvas id="chartChannelSeries"></canvas></div>
                    </div>
                </div>

                <div id="player-tab-analytics" class="tab-content p-4 bg-[#0b0b0d]">
                    <div class="text-xs text-gray-300 leading-relaxed" id="pl-analytics-text">
                        S√©lectionne une cha√Æne (carousel) ou utilise la rotation : les analytics se chargent automatiquement.
                    </div>
                </div>

                <div id="player-tab-growth" class="tab-content p-4 bg-[#0b0b0d]">
                    <div class="flex gap-2">
                        <button id="pl-growth-btn" onclick="runGrowthAI()" class="bg-[#00f2ea] text-black px-4 py-2 rounded font-bold hover:bg-white w-full">
                            <i class="fas fa-robot mr-1"></i> G√©n√©rer un plan de croissance
                        </button>
                    </div>
                    <div id="pl-growth-out" class="mt-3 text-xs text-gray-300 bg-[#111] border border-[#222] rounded p-3" style="display:none;"></div>
                </div>
            </div>

            <!-- PRO ANALYTICS PANEL (UNDER PLAYER) -->
            <div class="glass-panel rounded-lg overflow-hidden border border-[#222]">
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="openUnderTab('overview')"><i class="fas fa-bolt mr-1"></i> OVERVIEW</button>
                    <button class="tab-btn" onclick="openUnderTab('analytics')"><i class="fas fa-chart-line mr-1"></i> ANALYTICS PRO</button>
                    <button class="tab-btn" onclick="openUnderTab('niche')"><i class="fas fa-compass mr-1"></i> NICHE</button>
                    <button class="tab-btn" onclick="openUnderTab('costream')"><i class="fas fa-users mr-1"></i> CO-STREAM</button>
                </div>

                <!-- OVERVIEW -->
                <div id="under-overview" class="tab-content active p-4 bg-[#0b0b0d]">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Growth Score</div>
                            <div id="kpi-growth-score" class="text-2xl font-orbitron text-[#00f2ea]">--</div>
                            <div id="kpi-growth-label" class="text-[10px] text-gray-400 mt-1">--</div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Moy. viewers (30j)</div>
                            <div id="kpi-avg" class="text-2xl font-orbitron text-white">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">Donn√©es historiques</div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Pic viewers</div>
                            <div id="kpi-peak" class="text-2xl font-orbitron text-white">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">Peak sur p√©riode</div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Croissance</div>
                            <div id="kpi-growth" class="text-2xl font-orbitron text-[#ff0099]">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">D√©but ‚Üí fin</div>
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-wave-square mr-1"></i> Courbe (daily)</h4>
                            <div class="h-44"><canvas id="chartChannelDaily"></canvas></div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-magic mr-1"></i> IA ‚Äì plan d'action</h4>
                            <button id="btn-ai-reco" onclick="loadAIReco()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
                                ‚ö° G√©n√©rer des recommandations
                            </button>
                            <div id="ai-reco-box" class="mt-3 text-xs text-gray-300 leading-relaxed max-h-44 overflow-y-auto bg-[#0a0a0a] border border-[#222] rounded p-2 hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- ANALYTICS -->
                <div id="under-analytics" class="tab-content p-4 bg-[#0b0b0d]">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Volatilit√©</div>
                            <div id="kpi-volatility" class="text-2xl font-orbitron text-white">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">Plus c'est bas, plus c'est stable</div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">Heures / semaine (estim.)</div>
                            <div id="kpi-hours" class="text-2xl font-orbitron text-white">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">Bas√© sur snapshots</div>
                        </div>
                        <div class="bg-[#111] p-3 rounded border border-[#222]">
                            <div class="text-[10px] text-gray-500 uppercase">√âchantillons</div>
                            <div id="kpi-samples" class="text-2xl font-orbitron text-white">--</div>
                            <div class="text-[10px] text-gray-500 mt-1">Nombre de jours</div>
                        </div>
                    </div>

                    <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-flask mr-1"></i> Simulation de croissance</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
                            <input id="sim-hours" type="number" min="1" max="80" value="12" class="cyber-input" placeholder="Heures / semaine" />
                            <button onclick="runSimulation()" class="bg-[#ff0099] text-white px-4 rounded font-bold hover:bg-white hover:text-black transition font-orbitron text-xs">
                                SIMULER
                            </button>
                            <div id="sim-result" class="text-xs text-gray-300 flex items-center bg-[#0a0a0a] border border-[#222] rounded px-3">
                                --
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NICHE -->
                <div id="under-niche" class="tab-content p-4 bg-[#0b0b0d]">
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-crosshairs mr-1"></i> Cha√Æne vs Jeu (concurrence)</h4>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">Saturation</div>
                                <div id="niche-sat" class="text-xl font-orbitron text-[#00f2ea]">--</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">D√©couvrabilit√©</div>
                                <div id="niche-discover" class="text-xl font-orbitron text-[#ff0099]">--</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">Position</div>
                                <div id="niche-position" class="text-xl font-orbitron text-white">--</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase">Verdict</div>
                                <div id="niche-verdict" class="text-xl font-orbitron text-white">--</div>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-300" id="niche-details">--</div>
                    </div>

                    <div class="mt-4 bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-fire mr-1"></i> Heatmap ‚Äúmeilleures heures‚Äù (jeu)</h4>
                        <div class="h-44"><canvas id="chartGameHours"></canvas></div>
                        <div class="text-[10px] text-gray-500 mt-2">Plus haut = plus d‚Äôopportunit√© (viewers / concurrence).</div>
                    </div>
                </div>

                <!-- CO-STREAM -->
                <div id="under-costream" class="tab-content p-4 bg-[#0b0b0d]">
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-handshake mr-1"></i> Meilleur co-streamer</h4>
                        <div class="text-xs text-gray-300 mb-3">
                            On cherche des streamers FR proches de ton audience, sur le m√™me jeu, avec un potentiel de synergie.
                        </div>
                        <button onclick="loadCoStreamer()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
                            ü§ù Trouver un co-streamer
                        </button>
                        <div id="costream-result" class="mt-3 hidden bg-[#0a0a0a] border border-[#222] rounded p-3 text-xs text-gray-200"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT PANEL -->
        <div class="lg:col-span-3 flex flex-col glass-panel rounded-lg overflow-hidden h-full max-h-[calc(100vh-280px)] lg:max-h-full">
            <!-- TAB NAV -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="openTab(event,'chat')">
                    <i class="fas fa-comments mr-1"></i> CHAT
                </button>
                <button class="tab-btn" onclick="openTab(event,'stats')">
                    <i class="fas fa-chart-pie mr-1"></i> STATS
                </button>
                <button class="tab-btn" onclick="openTab(event,'tools')">
                    <i class="fas fa-toolbox mr-1"></i> OUTILS
                </button>
            </div>

            <!-- TAB: CHAT -->
            <div id="tab-chat" class="tab-content active bg-[#0e0e10]">
                <div class="flex p-2 gap-2 bg-[#080808] border-b border-[#222]">
                    <button onclick="toggleChatMode('twitch')" id="btn-mode-twitch" class="flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded">
                        TWITCH
                    </button>
                    <button onclick="toggleChatMode('hub')" id="btn-mode-hub" class="flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white">
                        HUB SECURE
                    </button>
                </div>
                <div id="chat-container-twitch" class="flex-grow relative bg-[#0a0a0a] overflow-hidden">
                    <iframe id="twitch-chat-frame" src="" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no"></iframe>
                </div>
                <div id="chat-container-hub" class="flex-grow hidden flex-col relative bg-[#0b0b0d]">
                    <div id="hub-messages" class="flex-grow overflow-y-auto p-2 scrollbar-thin">
                        <div class="text-center text-gray-600 text-xs mt-4">
                            Bienvenue sur le Hub S√©curis√© - Connect√© en tant que : <span id="hub-user-display" class="text-[#00f2ea] font-bold">Anonyme</span>
                        </div>
                    </div>
                    <form onsubmit="sendHubMessage(event)" class="p-2 border-t border-[#222] flex gap-2 bg-[#080808]">
                        <input id="hub-input" type="text" placeholder="Message crypt√©..." class="bg-[#1a1a1a] text-white text-xs p-2 rounded flex-grow outline-none border border-[#333] focus:border-[#00f2ea]">
                        <button type="submit" class="text-[#00f2ea] px-2">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- TAB: STATS -->
            <div id="tab-stats" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] scrollbar-thin">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-[#151515] p-3 rounded border-l-2 border-[#00f2ea]">
                        <div class="text-[10px] text-gray-500 uppercase">Viewers Totaux</div>
                        <div id="kpi-viewers" class="text-2xl font-orbitron text-white">--</div>
                    </div>
                    <div class="bg-[#151515] p-3 rounded border-l-2 border-[#ff0099]">
                        <div class="text-[10px] text-gray-500 uppercase">Cha√Ænes FR</div>
                        <div id="kpi-channels" class="text-2xl font-orbitron text-white">--</div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-chart-line mr-1"></i> Tendance 12h</h4>
                        <div class="h-40"><canvas id="chartViewers"></canvas></div>
                    </div>
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-gamepad mr-1"></i> Top Jeux</h4>
                        <div class="h-48"><canvas id="chartGames"></canvas></div>
                    </div>
                    <div class="bg-[#111] p-3 rounded border border-[#222]">
                        <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase"><i class="fas fa-globe mr-1"></i> Langues</h4>
                        <div class="h-40"><canvas id="chartLangs"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- TAB: TOOLS -->
            <div id="tab-tools" class="tab-content overflow-y-auto p-4 bg-[#0b0b0d] space-y-6">
                <!-- BEST TIME TOOL (NEW) -->
                <div class="best-time-tool">
                    <h4>üéØ BEST TIME TO STREAM</h4>
                    <div class="form-group">
                        <input id="best-time-game" type="text" placeholder="Jeu ex: League of Legends..." />
                    </div>
                    <button id="analyze-schedule-btn" onclick="analyzeBestTime()">
                        <i class="fas fa-clock"></i> ANALYSER
                    </button>
                    <div id="best-time-loading" style="display: none; text-align: center; margin-top: 10px; color: #00f2ea;">
                        <span class="best-time-spinner"></span>Analyse en cours...
                    </div>
                    <div id="best-time-results" class="best-time-results" style="display: none;"></div>
                </div>

                <!-- SCANNER -->
                <div>
                    <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">SCANNER IA</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="scan-query" type="text" placeholder="Pseudo ex: ZeratoR" class="cyber-input">
                        <button onclick="runScan()" class="bg-[#00f2ea] text-black px-4 rounded font-bold hover:bg-white">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="scan-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
                        <div class="flex gap-3 items-center mb-3">
                            <img id="scan-img" src="" class="w-12 h-12 rounded-full border border-[#00f2ea]">
                            <div>
                                <div id="scan-name" class="font-bold text-white">--</div>
                                <div id="scan-game" class="text-xs text-gray-500">--</div>
                            </div>
                        </div>
                        <div id="scan-ai" class="text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- RAID -->
                <div>
                    <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">RAID FINDER</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="raid-game" type="text" placeholder="Jeu ex: League" class="cyber-input">
                        <input id="raid-viewers" type="number" placeholder="Max viewers" class="cyber-input" value="100">
                    </div>
                    <button onclick="runRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white mb-3">
                        üîç CHERCHER
                    </button>
                    <div id="raid-res" class="hidden bg-[#151515] p-3 rounded border border-[#222]">
                        <img id="raid-img" src="" class="w-full h-40 rounded mb-3 object-cover">
                        <div id="raid-info" class="text-xs text-gray-300"></div>
                        <button id="raid-btn" onclick="goToRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold mt-2 hover:bg-white">
                            üéÆ ALLER AU RAID
                        </button>
                    </div>
                </div>

                <!-- BOOST -->
                <div>
                    <h3 class="text-[#ff0099] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">BOOST</h3>
                    <input id="boost-query" type="text" placeholder="Cha√Æne..." class="cyber-input mb-2">
                    <button onclick="runBoost()" class="w-full bg-[#ff0099] text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition">
                        ACTIVER
                    </button>
                    <div id="boost-msg" class="text-center text-xs mt-2 text-green-400"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const PARENT_DOMAINS = ['localhost', '127.0.0.1', window.location.hostname, 'justplayer.fr', 'www.justplayer.fr'];
        let player;
        let socket;
        let currentChannel = 'twitch';
        let currentUser = null;
        let charts = {};
        let raidTarget = null;

        // ==================== INIT ====================
        window.addEventListener('load', async () => {
            await checkAuth();
            initPlayer();
            loadStatsDashboard();
            initCarouselScroll();
            initSocket();
            initFirebaseStatus();
            setInterval(loadStatsDashboard, 5 * 60 * 1000);
        });

        // ==================== FIREBASE STATUS ====================
        async function initFirebaseStatus() {
            async function checkStatus() {
                try {
                    const response = await fetch(`${API_BASE}/firebase_status`);
                    const data = await response.json();
                    const statusEl = document.getElementById('socket-status');
                    
                    if (data.connected) {
                        statusEl.innerText = 'HUB SECURE';
                        statusEl.className = 'text-[10px] font-bold text-[#00f2ea] border border-[#00f2ea] px-2 rounded connected';
                    } else {
                        statusEl.innerText = 'HUB DISCONNECTED';
                        statusEl.className = 'text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded';
                    }
                } catch (error) {
                    console.error('Firebase status error:', error);
                }
            }
            
            checkStatus();
            setInterval(checkStatus, 5000);
        }

        // ==================== AUTH ====================
        async function checkAuth() {
            const res = await fetch(`${API_BASE}/twitch_user_status`);
            const data = await res.json();
            if (data.is_connected) {
                currentUser = data.display_name;
                document.getElementById('hub-user-display').innerText = data.display_name;
                document.getElementById('btn-auth').classList.add('hidden');
                document.getElementById('user-area').classList.remove('hidden');
                document.getElementById('user-name').innerText = data.display_name;
                document.getElementById('user-avatar').src = data.profile_image_url;
                await loadFollowed();
            }
        }

        function startAuth() {
            window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=700');
            const check = setInterval(async () => {
                const res = await fetch(`${API_BASE}/twitch_user_status`);
                const data = await res.json();
                if (data.is_connected) {
                    clearInterval(check);
                    location.reload();
                }
            }, 1000);
        }

        function logout() {
            fetch(`${API_BASE}/twitch_logout`, { method: 'POST' }).then(() => location.reload());
        }

        // ==================== PLAYER ====================
        async function initPlayer() {
            const res = await fetch(`${API_BASE}/get_default_stream`);
            const data = await res.json();
            if (data.success) {
                currentChannel = data.channel;
                document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
                document.getElementById('player-mode-badge').innerText = data.mode;
                
                loadPlayerEmbed(currentChannel);
                updateTwitchChatFrame(currentChannel);
                loadPlayerInsights(currentChannel);
            }
        }

        function loadPlayerEmbed(channel) {
            const container = document.getElementById('video-container');
            const parentParam = PARENT_DOMAINS.join('&parent=');
            const iframeUrl = `https://player.twitch.tv/?channel=${channel}&parent=${parentParam}&theme=dark`;
            
            container.innerHTML = `<iframe src="${iframeUrl}" width="100%" height="100%" frameborder="0" allow="autoplay" scrolling="no" style="border:none; width:100%; height:100%;"></iframe>`;
            
            loadStreamInfo(channel);
        }

        function loadStreamInfo(channel) {
            fetch(`${API_BASE}/stream_info`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel: channel })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.stream) {
                    const title = data.stream.title || 'Sans titre';
                    const viewers = data.stream.viewer_count || 0;
                    
                    const display = document.getElementById('current-channel-display');
                    const titleText = title.length > 40 ? title.substring(0, 40) + '...' : title;
                    display.innerText = `${channel.toUpperCase()} ‚Ä¢ ${titleText}`;
                    display.title = title;
                    
                    document.getElementById('viewer-count').innerText = `${viewers.toLocaleString()} viewers`;

                    // keep current game context for niche tools
                    currentGameId = data.stream.game_id || null;
                    currentGameName = data.stream.game_name || null;

                    // refresh under-player analytics
                    loadChannelProData(channel);
                }
            })
            .catch(e => console.error('Stream info error:', e));
        }

        function updateTwitchChatFrame(channel) {
            const parentParam = PARENT_DOMAINS.join('&parent=');
            const url = `https://www.twitch.tv/embed/${channel}/chat?parent=${parentParam}&theme=dark`;
            const frame = document.getElementById('twitch-chat-frame');
            if (frame) {
                frame.src = url;
            }
        }

        async function cycle(dir) {
            const res = await fetch(`${API_BASE}/cycle_stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: dir })
            });
            const data = await res.json();
            if (data.success) {
                currentChannel = data.channel;
                document.getElementById('current-channel-display').innerText = currentChannel.toUpperCase();
                document.getElementById('viewer-count').innerText = '-- viewers';
                
                loadPlayerEmbed(currentChannel);
                updateTwitchChatFrame(currentChannel);
                loadPlayerInsights(currentChannel);
            }
        }

        // ==================== CAROUSEL ====================
        function initCarouselScroll() {
            const el = document.getElementById('carousel');
            el.addEventListener('wheel', (evt) => {
                evt.preventDefault();
                el.scrollLeft += evt.deltaY;
            });
        }

        async function loadFollowed() {
            const el = document.getElementById('carousel');
            el.innerHTML = '<div class="w-full text-center py-10"><i class="fas fa-spinner fa-spin text-[#00f2ea]"></i></div>';
            try {
                const res = await fetch(`${API_BASE}/followed_streams`);
                const data = await res.json();
                if (data.success && data.streams.length > 0) {
                    el.innerHTML = '';
                    data.streams.forEach(s => {
                        const thumb = (s.thumbnail_url || '').replace('{width}', '400').replace('{height}', '225');
                        el.innerHTML += `
                            <div class="stream-card flex-shrink-0" onclick="changeChannel('${s.user_login}')">
                                <img src="${thumb}" class="card-img" onerror="this.src='https://via.placeholder.com/400x225'">
                                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black to-transparent p-3">
                                    <div class="font-bold text-white text-sm truncate">${s.user_name}</div>
                                </div>
                                <div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-1 rounded">LIVE</div>
                            </div>
                        `;
                    });
                }
            } catch (e) {
                console.error('Carousel error:', e);
                el.innerHTML = '<div class="w-full text-center py-10 text-red-500">Erreur</div>';
            }
        }

        function changeChannel(channel) {
            currentChannel = channel;
            document.getElementById('current-channel-display').innerText = channel.toUpperCase();
            document.getElementById('viewer-count').innerText = '-- viewers';
            
            loadPlayerEmbed(channel);
            updateTwitchChatFrame(channel);
            loadPlayerInsights(channel);
        }

        // ==================== TABS ====================
        function openTab(e, id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            const btn = (e && (e.currentTarget || e.target)) || null;
            if (btn) btn.classList.add('active');
        }

        // ==================== PLAYER SUB-TABS ====================
        function openPlayerTab(e, id) {
            // On cible uniquement les tab-content du player (ceux qui commencent par player-tab-)
            document.querySelectorAll('[id^="player-tab-"]').forEach(el => el.classList.remove('active'));
            // Active button
            const nav = (e && (e.currentTarget?.parentElement || null)) || null;
            if (nav) nav.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = (e && (e.currentTarget || e.target)) || null;
            if (btn) btn.classList.add('active');

            const panel = document.getElementById(`player-tab-${id}`);
            if (panel) panel.classList.add('active');
        }

        function toggleChatMode(mode) {
            const twitch = document.getElementById('chat-container-twitch');
            const hub = document.getElementById('chat-container-hub');
            const btnTw = document.getElementById('btn-mode-twitch');
            const btnHb = document.getElementById('btn-mode-hub');

            if (mode === 'hub') {
                twitch.classList.add('hidden');
                hub.classList.remove('hidden');
                hub.classList.add('flex');
                btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#00f2ea] text-black rounded';
                btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
            } else {
                hub.classList.add('hidden');
                hub.classList.remove('flex');
                twitch.classList.remove('hidden');
                btnTw.className = 'flex-1 py-1 text-xs font-bold bg-[#6441a5] text-white rounded';
                btnHb.className = 'flex-1 py-1 text-xs font-bold bg-[#1a1a1a] text-gray-400 rounded hover:text-white';
            }
        }

        // ==================== SOCKET.IO ====================
        function initSocket() {
            try {
                socket = io();
                socket.on('connect', () => {
                    console.log('Socket connected');
                });
                socket.on('disconnect', () => {
                    console.log('Socket disconnected');
                });
                socket.on('chat message', (msg) => {
                    const box = document.getElementById('hub-messages');
                    const user = msg.user || 'Anon';
                    const text = msg.text || msg;
                    box.innerHTML += `<div class="hub-msg"><strong class="text-[#00f2ea]">${user}</strong> <span class="text-gray-300">${text}</span></div>`;
                    box.scrollTop = box.scrollHeight;
                });
            } catch (e) {
                console.error('Socket error:', e);
            }
        }

        function sendHubMessage(e) {
            e.preventDefault();
            const input = document.getElementById('hub-input');
            if (input.value) {
                if (socket) socket.emit('chat message', { user: currentUser || 'Anon', text: input.value });
                const box = document.getElementById('hub-messages');
                box.innerHTML += `<div class="hub-msg"><strong class="text-[#ff0099]">${currentUser || 'Anon'}</strong> <span class="text-gray-300">${input.value}</span></div>`;
                box.scrollTop = box.scrollHeight;
                input.value = '';
            }
        }

        // ==================== BEST TIME TOOL ====================
        async function analyzeBestTime() {
            const gameInput = document.getElementById('best-time-game').value.trim();
            
            if (!gameInput) {
                alert('Veuillez entrer un nom de jeu');
                return;
            }
            
            const btn = document.getElementById('analyze-schedule-btn');
            const loading = document.getElementById('best-time-loading');
            const results = document.getElementById('best-time-results');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            results.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/analyze_schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game: gameInput })
                });
                
                const data = await response.json();
                
                if (data.html_response) {
                    results.innerHTML = data.html_response;
                    results.style.display = 'block';
                } else {
                    results.innerHTML = '<p style="color: #ff6666;">‚ùå Erreur lors de l\'analyse</p>';
                    results.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = '<p style="color: #ff6666;">‚ùå Erreur r√©seau</p>';
                results.style.display = 'block';
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // ==================== STATS ====================
        async function loadStatsDashboard() {
            try {
                const res = await fetch(`${API_BASE}/api/stats/global`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('kpi-viewers').innerText = data.total_viewers.toLocaleString();
                    document.getElementById('kpi-channels').innerText = data.total_channels;
                    renderChart('chartViewers', 'line', data.history.live.labels, data.history.live.values, 'Viewers', '#00f2ea');
                }

                const resGames = await fetch(`${API_BASE}/api/stats/top_games`);
                const dGames = await resGames.json();
                const labels = dGames.games.map(g => g.name);
                const values = dGames.games.map((g, i) => (i + 1) * 20);
                renderChart('chartGames', 'bar', labels.slice(0, 5), values.slice(0, 5), 'Popularit√©', '#ff0099');

                const resLang = await fetch(`${API_BASE}/api/stats/languages`);
                const dLang = await resLang.json();
                const lLabels = dLang.languages.map(l => l.name);
                const lValues = dLang.languages.map(l => l.percent);
                renderChart('chartLangs', 'doughnut', lLabels, lValues, 'Part', ['#00f2ea', '#ff0099', '#ffd700', '#fff', '#666']);
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        function renderChart(id, type, labels, data, label, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            
            if (charts[id]) charts[id].destroy();

            const bgColors = Array.isArray(color) ? color : (type === 'line' ? 'rgba(0, 242, 234, 0.1)' : color);
            const borderColors = Array.isArray(color) ? color : color;

            charts[id] = new Chart(ctx.getContext('2d'), {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        fill: type === 'line',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: type === 'doughnut',
                            position: 'right',
                            labels: { color: 'white', boxWidth: 10 }
                        }
                    },
                    scales: {
                        x: {
                            display: type !== 'doughnut',
                            ticks: { color: '#666' }
                        },
                        y: {
                            display: type !== 'doughnut',
                            grid: { color: '#222' },
                            ticks: { color: '#666' }
                        }
                    }
                }
            });
        }

        // ==================== PLAYER INSIGHTS (connect√© au backend) ====================
        async function loadPlayerInsights(login) {
            // login = user_login Twitch (ex: zerator)
            const avgEl = document.getElementById('pl-avg');
            const peakEl = document.getElementById('pl-peak');
            const growthEl = document.getElementById('pl-growth');
            const volEl = document.getElementById('pl-vol');
            const txtEl = document.getElementById('pl-analytics-text');

            if (!login) return;
            if (avgEl) avgEl.innerText = '...';
            if (peakEl) peakEl.innerText = '...';
            if (growthEl) growthEl.innerText = '...';
            if (volEl) volEl.innerText = '...';

            try {
                const r = await fetch(`${API_BASE}/api/analytics/channel_by_login/${encodeURIComponent(login)}`);
                const d = await r.json();

                if (!d.success) {
                    if (txtEl) {
                        txtEl.innerHTML = `<p style="color:#ff6666;">‚ùå Pas assez de donn√©es pour <strong>${login}</strong> (laisse tourner le cron quelques minutes/heures).</p>`;
                    }
                    // chart vide
                    renderChart('chartChannelSeries', 'line', ['--'], [0], 'Viewers', '#00f2ea');
                    return;
                }

                if (avgEl) avgEl.innerText = (d.avg_viewers ?? '--').toLocaleString();
                if (peakEl) peakEl.innerText = (d.peak_viewers ?? '--').toLocaleString();
                if (growthEl) growthEl.innerText = `${d.growth_percent ?? 0}%`;
                if (volEl) volEl.innerText = (d.volatility ?? '--').toLocaleString();

                // S√©rie
                const labels = (d.series || []).map(p => {
                    const dt = new Date(p.t);
                    const hh = dt.getHours().toString().padStart(2,'0');
                    const mm = dt.getMinutes().toString().padStart(2,'0');
                    return `${hh}h${mm}`;
                });
                const values = (d.series || []).map(p => p.v);
                if (labels.length > 1) {
                    renderChart('chartChannelSeries', 'line', labels, values, 'Viewers', '#00f2ea');
                } else {
                    renderChart('chartChannelSeries', 'line', ['--'], [0], 'Viewers', '#00f2ea');
                }

                // Texte ‚ÄúAnalytics‚Äù
                if (txtEl) {
                    txtEl.innerHTML = `
                        <p><strong>${d.display_name || login}</strong> ‚Äî √©chantillons: <strong>${d.samples}</strong></p>
                        <ul>
                            <li>Moyenne (30j): <strong>${(d.avg_viewers ?? 0).toLocaleString()}</strong></li>
                            <li>Pic (30j): <strong>${(d.peak_viewers ?? 0).toLocaleString()}</strong></li>
                            <li>Croissance: <strong>${d.growth_percent ?? 0}%</strong></li>
                            <li>Volatilit√©: <strong>${d.volatility ?? 0}</strong></li>
                        </ul>
                        <p class="text-gray-500">(Donn√©es Firestore via cron ‚Äî pas une promesse, juste des mesures.)</p>
                    `;
                }
            } catch (e) {
                console.error('Player insights error:', e);
                if (txtEl) txtEl.innerHTML = `<p style="color:#ff6666;">‚ùå Erreur analytics</p>`;
            }
        }

        async function runGrowthAI() {
            const out = document.getElementById('pl-growth-out');
            const btn = document.getElementById('pl-growth-btn');
            if (btn) btn.disabled = true;
            if (out) {
                out.style.display = 'block';
                out.innerHTML = '<span class="best-time-spinner"></span> G√©n√©ration du plan IA...';
            }

            try {
                // 1) resolve id
                const rr = await fetch(`${API_BASE}/api/resolve_channel_id?login=${encodeURIComponent(currentChannel)}`);
                const rd = await rr.json();
                if (!rd.success) {
                    if (out) out.innerHTML = `<p style="color:#ff6666;">‚ùå Impossible de r√©soudre la cha√Æne: ${currentChannel}</p>`;
                    return;
                }

                // 2) IA reco (n√©cessite daily_stats ‚Äî laisse tourner le cron si vide)
                const r = await fetch(`${API_BASE}/api/ai/reco?channel_id=${encodeURIComponent(rd.id)}&days=30`);
                const d = await r.json();
                if (d.html_response) {
                    if (out) out.innerHTML = d.html_response;
                } else {
                    if (out) out.innerHTML = `<p style="color:#ff6666;">‚ùå Pas de r√©ponse IA (daily_stats peut √™tre vide au d√©but)</p>`;
                }
            } catch (e) {
                console.error('Growth AI error:', e);
                if (out) out.innerHTML = `<p style="color:#ff6666;">‚ùå Erreur IA</p>`;
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // ==================== TOOLS ====================
        async function runScan() {
            const q = document.getElementById('scan-query').value;
            if (!q) return;
            const box = document.getElementById('scan-res');
            box.classList.remove('hidden');
            document.getElementById('scan-ai').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse Twitch + IA...';

            try {
                const res = await fetch(`${API_BASE}/scan_target`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: q })
                });
                const data = await res.json();
                if (data.success && data.user_data) {
                    const u = data.user_data;
                    document.getElementById('scan-name').innerText = u.display_name;
                    document.getElementById('scan-game').innerText = u.game_name;
                    document.getElementById('scan-img').src = u.profile_image_url;

                    const ai = await fetch(`${API_BASE}/critique_ia`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'niche', query: u.display_name })
                    });
                    const aiD = await ai.json();
                    document.getElementById('scan-ai').innerHTML = aiD.html_response || 'Pas de critique disponible';
                }
            } catch (e) {
                console.error('Scan error:', e);
            }
        }

        async function runRaid() {
            const game = document.getElementById('raid-game').value;
            const maxViewers = document.getElementById('raid-viewers').value;
            if (!game) return;

            document.getElementById('raid-res').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/start_raid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game, max_viewers: maxViewers })
                });
                const data = await res.json();
                if (data.success && data.target) {
                    raidTarget = data.target;
                    const box = document.getElementById('raid-res');
                    box.classList.remove('hidden');
                    document.getElementById('raid-img').src = data.target.thumbnail_url;
                    document.getElementById('raid-info').innerHTML = `
                        <p class="font-bold text-white">${data.target.name}</p>
                        <p>Viewers: ${data.target.viewers}</p>
                        <p>Jeu: ${data.target.game}</p>
                    `;
                }
            } catch (e) {
                console.error('Raid error:', e);
            }
        }

        function goToRaid() {
            if (raidTarget) {
                window.open(`https://twitch.tv/${raidTarget.login}`, '_blank');
            }
        }

        async function runBoost() {
            const c = document.getElementById('boost-query').value;
            if (!c) return;
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel: c })
            });
            const d = await res.json();
            if (d.success) {
                document.getElementById('boost-msg').innerText = '‚úÖ Boost Activ√© !';
                setTimeout(() => location.reload(), 2000);
            }
        }

        window.addEventListener('message', (e) => {
            if (e.data === 'auth_success') {
                location.reload();
            }
        });


        // ==================== UNDER PLAYER TABS ====================
        function openUnderTab(id) {
            document.querySelectorAll('#under-overview, #under-analytics, #under-niche, #under-costream')
                .forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.glass-panel .tab-nav .tab-btn')
                .forEach(el => el.classList.remove('active'));

            document.getElementById(`under-${id}`).classList.add('active');

            // active button
            const btns = Array.from(document.querySelectorAll('.glass-panel .tab-nav .tab-btn'));
            const idx = { overview:0, analytics:1, niche:2, costream:3 }[id] ?? 0;
            if (btns[idx]) btns[idx].classList.add('active');
        }

        let currentChannelId = null;
        let currentGameId = null;
        let currentGameName = null;

        async function loadChannelProData(login) {
            if (!login || login === 'twitch') return;

            try {
                // Analytics by login (backend resolves id + daily rollups)
                const res = await fetch(`${API_BASE}/api/analytics/channel_by_login/${encodeURIComponent(login)}?days=30`);
                const data = await res.json();
                if (!data.success) return;

                currentChannelId = data.channel_id || null;

                // KPI
                const k = data.kpis || {};
                document.getElementById('kpi-avg').innerText = (k.avg_viewers ?? '--').toLocaleString?.() || k.avg_viewers || '--';
                document.getElementById('kpi-peak').innerText = (k.peak_viewers ?? '--').toLocaleString?.() || k.peak_viewers || '--';
                document.getElementById('kpi-growth').innerText = (k.growth_percent != null ? `${k.growth_percent}%` : '--');
                document.getElementById('kpi-volatility').innerText = (k.volatility ?? '--');
                document.getElementById('kpi-hours').innerText = (k.hours_per_week_est != null ? `${k.hours_per_week_est}h` : '--');
                document.getElementById('kpi-samples').innerText = (data.series?.labels?.length ?? '--');

                // Growth Score
                const gs = k.growth_score;
                document.getElementById('kpi-growth-score').innerText = (gs != null ? `${gs}/100` : '--');
                document.getElementById('kpi-growth-label').innerText =
                    gs == null ? '--' :
                    gs >= 80 ? 'üî• En forte acc√©l√©ration' :
                    gs >= 60 ? '‚úÖ Bonne dynamique' :
                    gs >= 40 ? 'üü° Stable (optimisable)' :
                    'üî¥ √Ä relancer';

                // Chart daily
                if (data.series?.labels && data.series?.values) {
                    renderChart('chartChannelDaily', 'line', data.series.labels, data.series.values, 'Viewers moyens/jour', '#00f2ea');
                }

                // Try compare channel vs game if we have a game id (from stream_info)
                if (currentGameId) {
                    await loadNicheCompare(currentChannelId, currentGameId, currentGameName);
                    await loadGameHours(currentGameId);
                }
            } catch (e) {
                console.error('loadChannelProData error:', e);
            }
        }

        async function loadNicheCompare(channelId, gameId, gameName) {
            try {
                const url = `${API_BASE}/api/compare/channel_vs_game?channel_id=${encodeURIComponent(channelId)}&game_id=${encodeURIComponent(gameId)}&days=30`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.success) return;

                document.getElementById('niche-sat').innerText = `${data.saturation_score}/10`;
                document.getElementById('niche-discover').innerText = `${data.discoverability_score}/10`;
                document.getElementById('niche-position').innerText = data.position_label || '--';
                document.getElementById('niche-verdict').innerText = data.verdict || '--';
                document.getElementById('niche-details').innerText = `${gameName || 'Jeu'} ‚Ä¢ ${data.details || ''}`;
            } catch (e) {
                console.error('loadNicheCompare error:', e);
            }
        }

        async function loadGameHours(gameId) {
            try {
                const res = await fetch(`${API_BASE}/api/analytics/game/${encodeURIComponent(gameId)}?days=14`);
                const data = await res.json();
                if (!data.success) return;

                // Expect labels like ["Lun 08h", ...] and values opportunity
                if (data.hours?.labels && data.hours?.values) {
                    renderChart('chartGameHours', 'bar', data.hours.labels, data.hours.values, 'Opportunit√©', '#ff0099');
                }
            } catch (e) {
                console.error('loadGameHours error:', e);
            }
        }

        async function loadAIReco() {
            if (!currentChannel || currentChannel === 'twitch') return;
            const box = document.getElementById('ai-reco-box');
            box.classList.add('hidden');
            box.innerHTML = '';

            const btn = document.getElementById('btn-ai-reco');
            btn.disabled = true;
            btn.innerHTML = '<span class="best-time-spinner"></span> G√©n√©ration...';

            try {
                const res = await fetch(`${API_BASE}/api/ai/reco?login=${encodeURIComponent(currentChannel)}&days=30`);
                const data = await res.json();
                box.innerHTML = data.html_response || "<p style='color:#ff6666;'>‚ùå Pas de recommandation</p>";
                box.classList.remove('hidden');
            } catch (e) {
                box.innerHTML = "<p style='color:#ff6666;'>‚ùå Erreur IA</p>";
                box.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ö° G√©n√©rer des recommandations';
            }
        }

        async function runSimulation() {
            const hours = parseInt(document.getElementById('sim-hours').value || '0', 10);
            const out = document.getElementById('sim-result');
            if (!currentChannelId || !hours) { out.innerText = '‚Äî'; return; }

            out.innerText = '...';
            try {
                const res = await fetch(`${API_BASE}/api/simulate/growth?channel_id=${encodeURIComponent(currentChannelId)}&hours_per_week=${encodeURIComponent(hours)}&days=30`);
                const data = await res.json();
                if (!data.success) { out.innerText = 'Pas assez de data'; return; }
                out.innerText = `+${data.delta_viewers_est} viewers (est.) ‚Ä¢ ${data.confidence_label}`;
            } catch (e) {
                out.innerText = 'Erreur';
            }
        }

        async function loadCoStreamer() {
            const box = document.getElementById('costream-result');
            box.classList.add('hidden');
            box.innerHTML = '...';

            try {
                const res = await fetch(`${API_BASE}/api/costream/best?login=${encodeURIComponent(currentChannel)}&days=14`);
                const data = await res.json();
                if (!data.success) {
                    box.innerHTML = `<div class="text-red-400">‚ùå ${data.message || 'Pas de r√©sultat'}</div>`;
                    box.classList.remove('hidden');
                    return;
                }
                box.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${data.profile_image_url || ''}" class="w-12 h-12 rounded-full border border-[#00f2ea]" onerror="this.style.display='none'">
                        <div class="min-w-0">
                            <div class="font-bold text-white">${data.display_name} <span class="text-gray-500">@${data.login}</span></div>
                            <div class="text-[11px] text-gray-400">${data.reason}</div>
                        </div>
                        <a class="ml-auto bg-[#00f2ea] text-black px-3 py-1 rounded font-bold text-xs" target="_blank" href="https://twitch.tv/${data.login}">Voir</a>
                    </div>
                `;
                box.classList.remove('hidden');
            } catch (e) {
                box.innerHTML = `<div class="text-red-400">‚ùå Erreur</div>`;
                box.classList.remove('hidden');
            }
        }

    </script>
</body>
</html>
