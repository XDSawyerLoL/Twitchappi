<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub V51 - FIXED & CHAT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://embed.twitch.tv/embed/v1.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-time-gold: #ffd700;
            --color-ai-niche: #59d682;
            --color-ai-repurpose: #9933ff;
            --color-ai-action: #e34a64; 
            --color-border-dark: #2e2e2e;
        }

        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter', Arial, sans-serif; overflow-x: hidden; margin: 0; }
        
        /* BANDEAU TICKER */
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #000; border-bottom: 1px solid var(--color-secondary-blue); height: 30px; line-height: 30px; white-space: nowrap; }
        .ticker { display: inline-block; white-space: nowrap; padding-right: 100%; animation: ticker 40s linear infinite; }
        .ticker__item { display: inline-block; padding: 0 2rem; font-size: 11px; color: #ccc; font-family: 'Orbitron'; }
        .ticker__value { color: var(--color-secondary-blue); font-weight: bold; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* HEADER & TABS */
        #twitch-lucky-main { max-width: 1400px; margin: 0 auto; padding: 10px; }
        h1 { font-family: 'Orbitron'; font-size: 24px; color: var(--color-primary-pink); text-align: center; margin: 10px 0; }
        .tab-btn { flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #888; font-family: 'Orbitron'; font-size: 11px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: #1a1a1a; color: white; border-top: 3px solid var(--color-primary-pink); font-weight: bold; }

        /* SPLIT PLAYER (VIDEO GAUCHE / CHAT DROITE) */
        .player-wrapper { display: flex; flex-direction: column; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 0 20px rgba(34, 199, 239, 0.1); }
        .player-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        .player-split-container { display: flex; height: 600px; background: #000; }
        .video-column { flex: 1; height: 100%; position: relative; border-right: 1px solid #333; }
        .chat-column { width: 340px; height: 100%; display: flex; flex-direction: column; background: #111; flex-shrink: 0; }
        
        @media (max-width: 1024px) { 
            .player-split-container { flex-direction: column; height: auto; }
            .video-column { height: 300px; width: 100%; }
            .chat-column { width: 100%; height: 450px; border-left: none; border-top: 1px solid #333; }
        }

        /* CHAT TABS */
        .chat-tabs-header { display: flex; height: 35px; border-bottom: 1px solid #333; }
        .chat-tab-btn { flex: 1; background: #080808; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; }
        .chat-tab-btn.active { background: #1a1a1a; color: white; border-bottom: 2px solid var(--color-secondary-blue); }
        .chat-view { display: none; width: 100%; height: 100%; }
        .chat-view.active { display: block; }

        /* HUB CHAT STYLES */
        #hub-chat-interface { display: flex; flex-direction: column; height: 100%; }
        #hub-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .hub-msg { padding: 6px 10px; background: #222; border-radius: 4px; border-left: 2px solid #444; word-wrap: break-word; }
        .hub-msg.user-me { background: #2a1a2a; border-left-color: var(--color-primary-pink); }
        .hub-msg .meta { font-size: 9px; color: #777; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .hub-msg .author { font-weight: bold; color: #ccc; }
        
        .hub-input-area { padding: 8px; background: #080808; border-top: 1px solid #333; display: flex; gap: 5px; }

        /* UTILS & INPUTS */
        .action-input { width: 100%; padding: 8px; background: #000; border: 1px solid #333; color: white; border-radius: 4px; }
        .btn-primary { background: var(--color-primary-pink); color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; font-size: 11px; cursor: pointer; border: none; }
        .hidden { display: none !important; }
        
        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .dashboard-box { background: #0a0a0a; border: 1px solid #333; padding: 15px; border-radius: 6px; min-height: 250px; }
        
        /* FOLLOWED STREAMS GRID */
        #followed-streams-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .stream-card { background: #151515; border: 1px solid #333; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .stream-card:hover { border-color: var(--color-secondary-blue); transform: translateY(-3px); }
        .stream-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .stream-info { padding: 8px; }
    </style>
</head>
<body>

<div class="ticker-wrap">
    <div class="ticker" id="stats-ticker">
        <div class="ticker__item">üöÄ STREAMER HUB V51 ONLINE</div>
        <div class="ticker__item">üí° Connectez-vous pour utiliser le Tchat Hub</div>
        <div class="ticker__item">üì° Donn√©es temps r√©el actives</div>
    </div>
</div>

<div id="twitch-lucky-main">
    <h1><span style="color:var(--color-secondary-blue)">STREAMER</span> HUB V51</h1>

    <div style="display:flex; gap:2px; margin-bottom:15px;">
        <button class="tab-btn active" onclick="openTab('tab-followed', this)">üé• MON FIL</button>
        <button class="tab-btn" onclick="openTab('tab-dashboard', this)">üìä DASHBOARD</button>
        <button class="tab-btn" onclick="openTab('tab-time', this)">‚è≥ SCHEDULE</button>
        <button class="tab-btn" onclick="openTab('tab-boost', this)">‚ö° BOOST</button>
        <button class="tab-btn" onclick="openTab('tab-raid', this)">üì¢ RAID</button>
    </div>

    <div class="player-wrapper">
        <div class="player-header">
            <div style="font-family:'Orbitron'; color:var(--color-secondary-blue);">
                <i class="fab fa-twitch"></i> COCKPIT
                <span id="channel-status" style="font-size:11px; color:#666; margin-left:10px;">En attente...</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="cycleStream('prev')" class="btn-primary" style="background:#222;">‚¨Ö</button>
                <button onclick="cycleStream('next')" class="btn-primary" style="background:#222;">‚û°</button>
                <form onsubmit="event.preventDefault(); launchPlayer(document.getElementById('inp-chan').value)" style="display:flex; gap:5px;">
                    <input id="inp-chan" class="action-input" style="width:120px;" placeholder="Cha√Æne...">
                    <button type="submit" class="btn-primary">GO</button>
                </form>
            </div>
        </div>

        <div class="player-split-container">
            <div class="video-column">
                <div id="twitch-embed" style="width:100%; height:100%;"></div>
            </div>

            <div class="chat-column">
                <div class="chat-tabs-header">
                    <button class="chat-tab-btn active" onclick="switchChat('twitch', this)">TWITCH</button>
                    <button class="chat-tab-btn" onclick="switchChat('hub', this)">HUB CHAT</button>
                </div>

                <div id="view-twitch" class="chat-view active">
                    <iframe id="chat-frame" src="" style="width:100%; height:100%; border:none;"></iframe>
                </div>

                <div id="view-hub" class="chat-view">
                    <div id="hub-chat-interface">
                        <div style="padding:5px 10px; background:#000; font-size:10px; color:gold; display:flex; justify-content:space-between;">
                            <span id="user-display">Invit√©</span>
                            <span id="user-points">0 XP</span>
                        </div>
                        <div id="hub-messages">
                            <div class="hub-msg system">Connectez-vous pour parler.</div>
                        </div>
                        <form class="hub-input-area" onsubmit="sendHubMsg(event)">
                            <input id="hub-input" class="action-input" placeholder="Message..." autocomplete="off">
                            <button type="submit" class="btn-primary">></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="content-area">
        
        <div id="tab-followed" class="tab-content">
            <div style="text-align:right; margin-bottom:10px;">
                <button id="btn-login" class="btn-primary" style="background:#6441a5;" onclick="startAuth()">CONNEXION TWITCH</button>
            </div>
            <div id="followed-streams-list">
                <p style="grid-column:1/-1; text-align:center; color:#555;">Chargez vos cha√Ænes...</p>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content hidden">
            <div class="dashboard-grid">
                <div class="dashboard-box" style="border-top:3px solid var(--color-secondary-blue);">
                    <h3>TOTAL VIEWERS</h3>
                    <div id="stat-viewers" style="font-size:30px; font-weight:bold;">...</div>
                    <canvas id="chart-live" style="margin-top:20px; height:150px;"></canvas>
                </div>
                <div class="dashboard-box" style="border-top:3px solid var(--color-ai-niche);">
                    <h3>SCANNER & AUDIT</h3>
                    <form onsubmit="event.preventDefault(); runScan()" style="margin-top:10px; display:flex; gap:5px;">
                        <input id="scan-query" class="action-input" placeholder="Streamer...">
                        <button class="btn-primary">SCAN</button>
                    </form>
                    <div id="scan-res" style="margin-top:15px; font-size:12px; color:#ccc;"></div>
                </div>
                <div class="dashboard-box" style="border-top:3px solid var(--color-ai-repurpose);">
                    <h3>DERNI√àRE VOD</h3>
                    <div id="vod-res" style="text-align:center; padding-top:20px; color:#555;">Aucune donn√©e</div>
                </div>
            </div>
        </div>

        <div id="tab-time" class="tab-content hidden">
            <h3>OPTIMISATION HORAIRE</h3>
            <input id="sched-game" class="action-input" style="width:200px;" placeholder="Jeu...">
            <button class="btn-primary" onclick="runSchedule()">ANALYSER</button>
            <div id="sched-res" style="margin-top:20px; color:#ccc;"></div>
        </div>

        <div id="tab-boost" class="tab-content hidden">
            <h3>BOOST DE CHA√éNE (500 XP)</h3>
            <input id="boost-chan" class="action-input" style="width:200px;" placeholder="Cha√Æne...">
            <button class="btn-primary" onclick="runBoost()">BOOSTER</button>
            <div id="boost-res" style="margin-top:20px;"></div>
        </div>

        <div id="tab-raid" class="tab-content hidden">
            <h3>RAID FINDER</h3>
            <input id="raid-game" class="action-input" style="width:200px;" placeholder="Jeu...">
            <button class="btn-primary" onclick="runRaid()">CHERCHER</button>
            <div id="raid-res" style="margin-top:20px;"></div>
        </div>

    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_BASE = window.location.origin;
    let embed = null;
    let db = null;
    let user = { login: 'guest', name: 'Invit√©' };

    // !!! IMPORTANT : REMETS TES CL√âS FIREBASE ICI !!!
    const firebaseConfig = {
        apiKey: "TA_CLE_API_ICI",
        authDomain: "TON_PROJET.firebaseapp.com",
        projectId: "TON_PROJET_ID",
        storageBucket: "TON_PROJET.appspot.com",
        messagingSenderId: "TON_ID",
        appId: "TON_APP_ID"
    };

    // --- INIT ---
    window.onload = () => {
        // Init Firebase
        if(firebaseConfig.apiKey !== "TA_CLE_API_ICI") {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                listenMessages();
                console.log("Firebase OK");
            } catch(e) { console.error("Err Firebase", e); }
        } else {
            document.getElementById('hub-messages').innerHTML = "<div class='hub-msg system' style='color:red'>Configurez les cl√©s Firebase dans le code HTML.</div>";
        }

        checkAuth();
        checkGlobalStream();
        updateStats();
        
        // Initialiser Charts vide
        const ctx = document.getElementById('chart-live').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#22c7ef', fill: false }] },
            options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
        });
    };

    // --- TABS & UI ---
    function openTab(id, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function switchChat(type, btn) {
        document.querySelectorAll('.chat-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.chat-view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + type).classList.add('active');
    }

    // --- PLAYER & TWITCH ---
    window.launchPlayer = function(channel) {
        if(!channel) return;
        
        // 1. VIDEO (API TWITCH)
        if(embed) {
            embed.setChannel(channel);
        } else {
            document.getElementById('twitch-embed').innerHTML = '';
            // FIX PARENTS : On inclut justplayer.fr
            const parents = ["localhost", "127.0.0.1", "justplayer.fr", "justplayerstreamhubpro.onrender.com", window.location.hostname];
            // On force le layout VIDEO car le chat est g√©r√© √† c√¥t√©
            embed = new Twitch.Embed("twitch-embed", { width: "100%", height: "100%", channel: channel, layout: "video", parent: parents });
        }

        // 2. CHAT (IFRAME)
        // C'est ici qu'on fixe le probl√®me du chat Twitch
        const parentParam = window.location.hostname || "justplayer.fr";
        const url = `https://www.twitch.tv/embed/${channel}/chat?parent=${parentParam}&darkpopout`;
        document.getElementById('chat-frame').src = url;
        
        document.getElementById('inp-chan').value = channel;
    }

    async function checkGlobalStream() {
        try {
            const r = await fetch(`${API_BASE}/get_default_stream`);
            const d = await r.json();
            if(d.success) {
                launchPlayer(d.channel);
                document.getElementById('channel-status').innerText = d.message;
            } else { launchPlayer('twitch'); }
        } catch(e) { launchPlayer('twitch'); }
    }

    async function cycleStream(dir) {
        await fetch(`${API_BASE}/cycle_stream`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({direction:dir}) });
        checkGlobalStream();
    }

    // --- CHAT HUB (LOGIC V39) ---
    function listenMessages() {
        if(!db) return;
        const q = db.collection('hub_messages').orderBy('timestamp', 'desc').limit(30);
        q.onSnapshot(snap => {
            const div = document.getElementById('hub-messages');
            div.innerHTML = '';
            const msgs = [];
            snap.forEach(doc => msgs.push(doc.data()));
            msgs.reverse().forEach(m => {
                // Filtre 6h JS
                if(Date.now() - (m.timestamp?.toMillis() || 0) < 21600000) {
                    const isMe = m.login === user.login;
                    div.innerHTML += `
                        <div class="hub-msg ${isMe?'user-me':''}">
                            <div class="meta"><span class="author">${m.user}</span><span>${new Date(m.timestamp?.toMillis()).toLocaleTimeString().slice(0,5)}</span></div>
                            ${m.text}
                        </div>`;
                }
            });
            div.scrollTop = div.scrollHeight;
        });
    }

    async function sendHubMsg(e) {
        e.preventDefault();
        const inp = document.getElementById('hub-input');
        const txt = inp.value.trim();
        if(!txt || !db) return;
        
        await db.collection('hub_messages').add({
            text: txt, user: user.name, login: user.login, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        inp.value = '';
    }

    // --- DASHBOARD & TOOLS ---
    async function updateStats() {
        try {
            const r = await fetch(`${API_BASE}/api/stats/global`);
            const d = await r.json();
            if(d.success) {
                document.getElementById('stat-viewers').innerText = d.total_viewers;
                // Update ticker
                document.getElementById('stats-ticker').innerHTML = `
                    <div class="ticker__item">üëÅ VIEWERS: ${d.total_viewers}</div>
                    <div class="ticker__item">üéÆ TOP JEU: ${d.top_game_name}</div>
                    <div class="ticker__item">üì∫ CHA√éNES: ${d.total_channels}</div>
                `;
            }
        } catch(e) {}
    }

    async function runScan() {
        const q = document.getElementById('scan-query').value;
        const r = await fetch(`${API_BASE}/scan_target`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q}) });
        const d = await r.json();
        const box = document.getElementById('scan-res');
        if(d.success && d.user_data) {
            box.innerHTML = `<b>${d.user_data.display_name}</b><br>Score IA: ${d.user_data.ai_calculated_niche_score}<br>${d.user_data.is_live ? 'üî¥ LIVE' : '‚ö´ OFF'}`;
        } else { box.innerText = "Non trouv√©."; }
    }

    // --- AUTH ---
    function startAuth() { window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=600'); }
    window.addEventListener('message', e => { if(e.data==='auth_success') window.location.reload(); });
    
    async function checkAuth() {
        const r = await fetch(`${API_BASE}/twitch_user_status`);
        const d = await r.json();
        if(d.is_connected) {
            user = { login: 'user_log', name: d.display_name }; // Simplifi√©, id√©alement ID twitch
            document.getElementById('btn-login').innerText = d.display_name;
            document.getElementById('btn-login').onclick = async () => { await fetch(`${API_BASE}/twitch_logout`, {method:'POST'}); location.reload(); };
            document.getElementById('user-display').innerText = d.display_name;
            loadFollowed();
        }
    }

    async function loadFollowed() {
        const box = document.getElementById('followed-streams-list');
        const r = await fetch(`${API_BASE}/followed_streams`);
        const d = await r.json();
        if(d.success && d.streams.length) {
            box.innerHTML = d.streams.map(s => `
                <div class="stream-card" onclick="launchPlayer('${s.user_login}')">
                    <div style="position:relative;">
                        <img src="${s.thumbnail_url.replace('{width}','320').replace('{height}','180')}">
                        <div style="position:absolute; top:5px; left:5px; background:red; color:white; font-size:9px; padding:2px;">LIVE</div>
                    </div>
                    <div class="stream-info">
                        <div style="font-weight:bold; font-size:12px;">${s.user_name}</div>
                        <div style="font-size:10px; color:#888;">${s.viewer_count} viewers</div>
                    </div>
                </div>
            `).join('');
        } else { box.innerHTML = "Personne en ligne."; }
    }
</script>
</body>
</html>
