<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Streamer & Niche AI Hub - COCKPIT MODE (V15 - Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- VOTRE CSS ORIGINAL (STRICTEMENT INTACT) --- */
        :root {
            --color-bg-dark: #0d0d0d; --color-bg-medium: #1a1a1a;
            --color-primary-pink: #ff0099; --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; --color-ai-action: #e34a64;
        }
        body { background-color: var(--color-bg-dark); color: #fff; font-family: 'Inter'; }
        
        /* HOVER ROSE SUR MINIATURES (RESTAURÃ‰) */
        .followed-stream-item {
            border: 2px solid transparent; transition: 0.3s; cursor: pointer; border-radius: 8px; overflow: hidden;
        }
        .followed-stream-item:hover {
            border-color: var(--color-primary-pink);
            box-shadow: 0 0 15px rgba(255, 0, 153, 0.5);
            transform: scale(1.02);
        }

        .tab-btn { font-family: 'Orbitron'; padding: 15px; background: #111; flex: 1; border-radius: 10px 10px 0 0; color: #666; transition: 0.3s; }
        .tab-btn.active { background: var(--color-bg-medium); color: white; border-top: 3px solid var(--color-primary-pink); }
        .dashboard-box { background: #050505; border: 1px solid #333; padding: 20px; border-radius: 8px; height: 100%; }
        .btn-boost { background: linear-gradient(90deg, var(--color-primary-pink), #ff55bb); font-weight: bold; padding: 12px 30px; border-radius: 50px; }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center border-b-2 border-blue-500 pb-4 mb-6">
        <div>
            <h1 class="text-2xl font-['Orbitron'] font-bold">JUSTPLAYER HUB <span class="text-blue-400">V15</span></h1>
            <div id="golden-hour-ui" class="text-[10px] text-yellow-500 font-bold uppercase mt-1">
                <i class="fas fa-clock"></i> Golden Hour: <span id="golden-val">--%</span>
            </div>
        </div>
        <button id="auth-btn" onclick="window.open('/twitch_auth_start','_blank','width=500,height=600')" class="bg-purple-600 px-6 py-2 rounded-full text-xs font-bold">CONNEXION TWITCH</button>
    </div>

    <div class="bg-black rounded-xl p-2 border border-gray-800 mb-8">
        <div id="twitch-embed" style="height: 500px; width: 100%;"></div>
    </div>

    <div class="flex gap-1">
        <button onclick="switchTab('tab-fav')" id="btn-tab-fav" class="tab-btn active">ðŸ”‘ FIL DE SUIVI</button>
        <button onclick="switchTab('tab-dash')" id="btn-tab-dash" class="tab-btn">ðŸ“Š DASHBOARD 360Â°</button>
        <button onclick="switchTab('tab-boost')" id="btn-tab-boost" class="tab-btn">âš¡ BOOST SYSTEM</button>
    </div>

    <div id="tab-fav" class="bg-gray-900 p-6 rounded-b-xl border border-gray-800 block">
        <div id="fav-list" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>

    <div id="tab-dash" class="bg-gray-900 p-6 rounded-b-xl border border-gray-800 hidden">
        <div class="flex gap-4 mb-6">
            <input id="scan-target" type="text" placeholder="Entrez un pseudo..." class="flex-1 bg-black border border-gray-700 p-3 rounded">
            <button onclick="runScan360()" class="bg-blue-600 px-8 rounded font-bold">AUDIT COMPLET</button>
            <button onclick="window.open('/export_csv')" class="bg-yellow-600 px-4 rounded font-bold"><i class="fas fa-file-csv"></i></button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="dashboard-box" id="dash-info">Info Canal...</div>
            <div class="dashboard-box" id="dash-ai">Analyse IA...</div>
            <div class="dashboard-box" id="dash-vod">Dernier Live...</div>
        </div>
    </div>

    <div id="tab-boost" class="bg-gray-900 p-10 rounded-b-xl border border-gray-800 hidden text-center">
        <h2 class="text-3xl font-['Orbitron'] text-pink-500 mb-6">BOOST ENGINE V15</h2>
        <input id="boost-channel" type="text" placeholder="Pseudo Ã  booster" class="bg-black border border-gray-700 p-4 w-72 mb-6 rounded text-center">
        <button onclick="activateBoost()" class="block mx-auto btn-boost shadow-lg">ACTIVER LE BOOST PRIORITAIRE</button>
        <p class="mt-4 text-xs text-gray-500 italic">Le boost force l'affichage de votre chaÃ®ne pour tous les nouveaux visiteurs.</p>
    </div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    let player = null;

    function launchPlayer(channel) {
        document.getElementById('twitch-embed').innerHTML = '';
        player = new Twitch.Embed("twitch-embed", {
            width: "100%", height: "100%", channel: channel,
            parent: ["localhost", window.location.hostname, "justplayer.fr"]
        });
    }

    async function loadFollowed() {
        const res = await fetch('/followed_streams');
        const data = await res.json();
        const container = document.getElementById('fav-list');
        container.innerHTML = data.streams.map(s => `
            <div class="followed-stream-item" onclick="launchPlayer('${s.user_login}')">
                <img src="${s.thumbnail_url.replace('{width}','400').replace('{height}','225')}" class="w-full">
                <div class="p-2 bg-black/80">
                    <p class="font-bold truncate text-pink-500 text-sm">${s.user_name}</p>
                    <p class="text-[10px] text-gray-400">${s.viewer_count} viewers</p>
                </div>
            </div>
        `).join('');
    }

    async function runScan360() {
        const query = document.getElementById('scan-target').value;
        const res = await fetch('/scan_target', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query}) });
        const { data } = await res.json();
        if(data) {
            document.getElementById('dash-info').innerHTML = `<img src="${data.profile_image_url}" class="w-20 mx-auto rounded-full border-2 border-blue-400 mb-2"> <h3 class="text-center font-bold">${data.display_name}</h3> <p class="text-center text-xs">${data.followers.toLocaleString()} follows</p>`;
            
            // Appel IA
            document.getElementById('dash-ai').innerHTML = "IA en rÃ©flexion...";
            const ai = await fetch('/auto_action', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action_type:'Audit Niche', target_name: query}) });
            const aiData = await ai.json();
            document.getElementById('dash-ai').innerHTML = aiData.html_response;
            
            if(data.last_vod) document.getElementById('dash-vod').innerHTML = `<img src="${data.last_vod.thumbnail_url.replace('%{width}','320').replace('%{height}','180')}" class="rounded">`;
        }
    }

    async function activateBoost() {
        const channel = document.getElementById('boost-channel').value;
        await fetch('/stream_boost', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({channel}) });
        alert("BOOST ACTIVÃ‰ !");
        launchPlayer(channel);
    }

    async function updateGoldenHour() {
        const res = await fetch('/get_golden_hour_stats');
        const data = await res.json();
        document.getElementById('golden-val').innerText = data.score + "%";
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content, [id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + id).classList.add('active');
        if(id === 'tab-fav') loadFollowed();
    }

    window.onload = async () => {
        const b = await fetch('/check_boost');
        const bData = await b.json();
        launchPlayer(bData.boosted || 'twitch');
        loadFollowed();
        updateGoldenHour();
    }
</script>
</body>
</html>
