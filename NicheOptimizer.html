<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Streamer Hub ‚Äì Pro Analytics & Twiflix</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --bg-dark:#050505;
      --bg-panel:#0b0b0d;
      --primary:#ff0099;
      --secondary:#00f2ea;
      --text-main:#e0e0e0;
      --border-color:#1f1f23;
    }
    body{
      background:var(--bg-dark);
      color:var(--text-main);
      font-family:Inter, sans-serif;
      overflow-x:hidden;
    }
    .font-orbitron{ font-family:Orbitron, sans-serif; }

    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background:#000; }
    ::-webkit-scrollbar-thumb{ background:#333; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:var(--secondary); }

    .glass-panel{ background:var(--bg-panel); border:1px solid var(--border-color); }

    .carousel-track{
      display:flex; gap:15px; overflow-x:auto; padding:10px 5px;
      scroll-behavior:smooth; cursor:grab;
    }
    .stream-card{
      flex:0 0 300px; height:170px; background:#111;
      border:1px solid #222; border-radius:12px; overflow:hidden;
      position:relative; cursor:pointer; transition:.2s;
    }
    .stream-card:hover{
      border-color:var(--secondary);
      transform:translateY(-4px);
      box-shadow:0 5px 20px rgba(0,242,234,.15);
    }
    .card-img{ width:100%; height:100%; object-fit:cover; opacity:.7; transition:.3s; }
    .stream-card:hover .card-img{ opacity:1; }

    /* onglets DROITE */
    .tab-nav{ display:flex; background:#080808; border-bottom:1px solid var(--border-color); }
    .tab-btn{
      flex:1; padding:14px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.3s;
    }
    .tab-btn:hover{ color:#fff; background:#111; }
    .tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }
    .tab-content{ display:none; height:100%; flex-direction:column; }
    .tab-content.active{ display:flex; }

    .cyber-input{
      background:#151515; border:1px solid #333; color:#fff;
      padding:12px; border-radius:6px; font-size:13px; outline:none; transition:.3s; width:100%;
    }
    .cyber-input:focus{ border-color:var(--secondary); box-shadow:0 0 10px rgba(0,242,234,.2); }

    .hub-msg{ padding:8px; border-bottom:1px solid #1a1a1a; font-size:13px; line-height:1.4; }
    .hub-msg strong{ font-family:Orbitron; font-size:11px; }
    .scrollbar-thin::-webkit-scrollbar{ width:4px; }

    /* badge statut */
    #socket-status{ transition:all .3s ease; }
    #socket-status.connected{
      color:#00f2ea; border-color:#00f2ea;
      box-shadow:0 0 8px rgba(0,242,234,.6);
      animation:hub-pulse 2s infinite;
    }
    @keyframes hub-pulse{ 0%,100%{opacity:1} 50%{opacity:.6} }

    /* BEST TIME TOOL */
    .best-time-tool{
      background:#151515; border:1px solid #00f2ea; border-radius:10px;
      padding:16px; margin-bottom:16px; box-shadow:inset 0 0 10px rgba(0,242,234,.1);
    }
    .best-time-tool h4{
      color:#00f2ea; font-family:Orbitron; font-size:12px;
      margin-bottom:10px; border-bottom:1px solid #00f2ea; padding-bottom:8px;
    }
    .best-time-tool input{
      width:100%; padding:10px; background:#0a0a0a; border:1px solid #333;
      color:#fff; border-radius:6px; font-size:12px; margin-bottom:8px;
    }
    .best-time-tool input:focus{ border-color:#00f2ea; box-shadow:0 0 8px rgba(0,242,234,.2); outline:none; }
    .best-time-tool button{
      width:100%; background:#00f2ea; color:#000; padding:10px;
      border:none; border-radius:6px; font-weight:bold; cursor:pointer;
      font-family:Orbitron; font-size:11px; transition:all .3s ease;
    }
    .best-time-tool button:hover:not(:disabled){ background:#fff; box-shadow:0 0 15px rgba(0,242,234,.4); transform:translateY(-1px); }
    .best-time-tool button:disabled{ opacity:.5; cursor:not-allowed; }
    .best-time-results{
      background:#0a0a0a; border:1px solid #333; border-radius:6px;
      padding:12px; margin-top:12px; font-size:12px; max-height:220px; overflow-y:auto;
    }
.best-time-spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(0,242,234,.3); border-radius:50%;
      border-top-color:#00f2ea; animation:bt-spin 1s linear infinite;
      margin-right:6px; vertical-align:middle;
    }
    @keyframes bt-spin{ to{ transform:rotate(360deg) } }

    /* PLAYER sizing (grand) */
    .player-shell{ min-height:72vh; }
    #video-container{ min-height:62vh; }

    /* ====== ONGLETS SOUS LE LIVE (ind√©pendants) ====== */
    .u-nav{ display:flex; background:#080808; border-bottom:1px solid #1f1f23; }
    .u-tab-btn{
      flex:1; padding:12px; text-align:center; color:#666;
      font-family:Orbitron; font-size:11px; font-weight:bold;
      cursor:pointer; border-bottom:2px solid transparent; transition:.25s;
    }
    .u-tab-btn:hover{ color:#fff; background:#111; }
    .u-tab-btn.active{ color:var(--secondary); border-bottom-color:var(--secondary); background:#151515; }

    .u-tab-panel{ display:none; }
    .u-tab-panel.active{ display:block; }

    /* ====== TWITFLIX MODAL ====== */
    /* ====== TWIFLIX MODAL ====== */
    .tf-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px);
      z-index: 9999; display: none; align-items: center; justify-content: center;
    }
    .tf-modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .tf-modal-content {
      width: 90%; max-width: 1200px; height: 85vh;
      background: #0b0b0d; border: 1px solid #333; border-radius: 12px;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 0 40px rgba(0, 242, 234, 0.1);
    }
    .tf-header {
      padding: 20px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
      background: #080808;
    }
    .tf-title { font-family: 'Orbitron'; color: #ff0099; font-size: 24px; letter-spacing: 2px; }
    .tf-title span { color: #00f2ea; }
    .tf-close { color: #666; cursor: pointer; font-size: 24px; transition: .3s; }
    .tf-close:hover { color: #fff; transform: rotate(90deg); }

    .tf-grid {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; align-content: start;
    }
    .tf-card {
      position: relative; aspect-ratio: 3/4; border-radius: 6px; overflow: hidden;
      cursor: pointer; transition: transform 0.2s, border-color 0.2s;
      border: 2px solid transparent;
    }
    .tf-card:hover {
      transform: scale(1.05); border-color: #00f2ea; z-index: 10;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.3);
    }
    .tf-poster { width: 100%; height: 100%; object-fit: cover; }
    .tf-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, black, transparent);
      padding: 10px; opacity: 0; transition: 0.3s;
    }
    .tf-card:hover .tf-overlay { opacity: 1; }
    .tf-name { font-size: 12px; font-weight: bold; color: white; text-align: center; }
  
    /* ====== TWITFLIX ‚Äî Netflix rows (catalogue only, sans toucher le reste) ====== */
    /* ====== TWIFLIX ‚Äî Netflix rows (catalogue only, sans toucher le reste) ====== */
    .tf-controls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding: 0 16px 12px 16px;
      border-bottom:1px solid #1f1f23;
      background: rgba(11,11,13,.92);
    }
    .tf-view-toggle{
      display:flex; gap:6px; padding:4px; border-radius:12px;
      border:1px solid #2b2b31; background:#0a0a0a;
    }
    .tf-toggle-btn{
      border:0; background:transparent; color:#a7a7b2;
      font-family:Orbitron; font-size:10px; font-weight:900;
      letter-spacing:.10em;
      padding:8px 10px; border-radius:10px; cursor:pointer; transition:.2s;
    }
    .tf-toggle-btn:hover{ color:#fff; background:#151515; }
    .tf-toggle-btn.active{ color:#000; background:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.18); }

    .tf-grid{ padding: 14px 16px 18px 16px; }
    .tf-section{ margin-top: 18px; }
    .tf-section-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      font-weight: 900;
@@ -243,51 +243,51 @@
      padding: 10px 0 8px 0;
      background: linear-gradient(180deg, rgba(11,11,13,.98), rgba(11,11,13,.74));
      border-bottom: 1px solid #1f1f23;
      margin-bottom: 8px;
    }
    .tf-azlink{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .12em;
      color:#a7a7b2;
      text-decoration:none;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      transition:.2s;
    }
    .tf-azlink:hover{
      color:#000;
      background:#00f2ea;
      border-color:#00f2ea;
    }


    /* ====== TWITFLIX ‚Äî performance + Netflix rows ====== */
    /* ====== TWIFLIX ‚Äî performance + Netflix rows ====== */
    .tf-rows{
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: block;
    }
    .tf-row{ margin-bottom: 22px; }
    .tf-row-title{
      font-family: Orbitron, sans-serif;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color:#eaeaf0;
      margin: 8px 0 10px 2px;
    }
    .tf-row-title span{ color:#00f2ea; }
    .tf-row-track{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      padding-bottom: 10px;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tf-row-track::-webkit-scrollbar{ height: 6px; }
@@ -374,237 +374,299 @@
      background:#0a0a0a;
      border:1px solid #2b2b31;
      color:#fff;
      border-radius:10px;
      padding:10px 12px 10px 36px;
      font-size:13px;
      outline:none;
      transition:.2s;
    }
    .tf-search:focus{
      border-color:#00f2ea;
      box-shadow:0 0 0 3px rgba(0,242,234,.12);
    }
    .tf-search-ico{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:#777;
      font-size:13px;
      pointer-events:none;
    }


/* === Twiflix UX Overhaul (Netflix-like) ‚Äî overrides only (does not touch rest of app) === */
#twitflix-modal .tf-modal-content{ max-width: 1400px; }
#twiflix-modal .tf-modal-content{
  max-width: 1400px;
  background: radial-gradient(circle at 10% 10%, rgba(0,242,234,.05), transparent 28%),
              radial-gradient(circle at 90% 0%, rgba(255,0,153,.05), transparent 22%),
              linear-gradient(145deg, rgba(7,7,9,.96), rgba(7,7,9,.88));
}

#twitflix-modal .tf-topbar{ position: sticky; top:0; z-index: 60; }
#twitflix-modal .tf-actions{ gap: 12px; }
#twitflix-modal .tf-search{ font-size: 14px; padding: 12px 14px 12px 38px; }
#twiflix-modal .tf-topbar{
  position: sticky;
  top:0;
  z-index: 60;
  background: linear-gradient(90deg, rgba(0,0,0,.5), rgba(0,0,0,.12));
  backdrop-filter: blur(12px);
  border-bottom:1px solid rgba(255,255,255,.04);
}

#twitflix-modal .tf-grid{
#twiflix-modal .tf-brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-family: Orbitron, sans-serif;
  font-weight:900;
  letter-spacing:.18em;
  color:#fff;
  text-transform:uppercase;
}
#twiflix-modal .tf-brand .dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background: radial-gradient(circle, #00f2ea 0%, #ff0099 90%);
  box-shadow:0 0 18px rgba(0,242,234,.45);
}

#twiflix-modal .tf-actions{ gap: 12px; }
#twiflix-modal .tf-search{ font-size: 14px; padding: 12px 14px 12px 38px; }

#twiflix-modal .tf-grid{
  display:flex;
  flex-direction: column;
  gap: 18px;
  padding: 14px 18px 24px 18px;
}

#twitflix-modal .tf-hero{
#twiflix-modal .tf-hero{
  position: relative;
  height: 220px;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid #1f1f23;
  background: #0a0a0a;
}
#twitflix-modal .tf-hero::before{
#twiflix-modal .tf-hero::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 20%, rgba(0,242,234,.18), transparent 60%),
              radial-gradient(circle at 80% 30%, rgba(255,0,153,.14), transparent 55%),
              linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.20));
  z-index:2;
}
#twitflix-modal .tf-hero-bg{
#twiflix-modal .tf-hero-bg{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
  filter: saturate(1.05) contrast(1.05);
  opacity:.55;
}
#twitflix-modal .tf-hero-content{
#twiflix-modal .tf-hero-content{
  position:absolute; inset:0;
  z-index:3;
  display:flex;
  align-items:flex-end;
  padding: 18px;
}
#twitflix-modal .tf-hero-title{
#twiflix-modal .tf-hero-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .08em;
  font-size: 18px;
  font-weight: 900;
  color:#fff;
  text-shadow: 0 6px 24px rgba(0,0,0,.8);
}
#twitflix-modal .tf-hero-sub{
#twiflix-modal .tf-hero-sub{
  margin-top: 6px;
  font-size: 12px;
  color:#cfcfda;
  max-width: 70ch;
  line-height: 1.35;
}

#twitflix-modal .tf-row{ display:flex; flex-direction:column; gap: 10px; }
#twitflix-modal .tf-row-title{
#twiflix-modal .tf-row{ display:flex; flex-direction:column; gap: 10px; }
#twiflix-modal .tf-row-title{
  font-family: Orbitron, sans-serif;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: 12px;
  color:#eaeaf0;
  display:flex; align-items:center; justify-content:space-between;
}
#twitflix-modal .tf-row-title span{ color:#00f2ea; }
#twitflix-modal .tf-row-track{
#twiflix-modal .tf-row-title span{ color:#00f2ea; }
#twiflix-modal .tf-row-track{
  display:flex;
  gap: 16px;
  overflow-x:auto;
  padding-bottom: 10px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}
#twitflix-modal .tf-row-track::-webkit-scrollbar{ height: 6px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
#twitflix-modal .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }
#twiflix-modal .tf-row-track::-webkit-scrollbar{ height: 6px; }
#twiflix-modal .tf-row-track::-webkit-scrollbar-thumb{ background:#2a2a2f; border-radius:999px; }
#twiflix-modal .tf-row-track::-webkit-scrollbar-thumb:hover{ background:#00f2ea; }

#twitflix-modal .tf-card{
#twiflix-modal .tf-card{
  flex: 0 0 170px;
  border-radius: 12px;
  overflow:hidden;
  background:#101013;
  border:1px solid #1d1d22;
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}
#twitflix-modal .tf-card:hover{
#twiflix-modal .tf-card:hover{
  transform: scale(1.06);
  z-index: 40;
  border-color:#00f2ea;
  box-shadow: 0 18px 45px rgba(0,0,0,.55), 0 0 18px rgba(0,242,234,.18);
}
#twitflix-modal .tf-poster{
#twiflix-modal .tf-card.previewing{
  border-color:#7af7f1;
  box-shadow: 0 0 0 1px rgba(122,247,241,.35) inset, 0 18px 45px rgba(0,0,0,.55);
}
#twiflix-modal .tf-card .tf-preview{
  position:absolute;
  inset:0;
  background: radial-gradient(circle at 30% 20%, rgba(0,242,234,.12), transparent 55%), #030304;
  border-radius: inherit;
  overflow:hidden;
}
#twiflix-modal .tf-card .tf-preview iframe{
  width:100%; height:100%; border:0; display:block;
}
#twiflix-modal .tf-card.previewing .tf-overlay{
  opacity:1;
  background: linear-gradient(180deg, transparent, rgba(0,0,0,.85));
}
#twiflix-modal .tf-card.previewing::after{
  content:'LIVE PREVIEW';
  position:absolute;
  top:10px; left:10px;
  padding:6px 10px;
  border-radius:10px;
  font-weight:900;
  font-size:10px;
  letter-spacing:.12em;
  background: rgba(0,242,234,.85);
  color:#000;
  box-shadow:0 0 12px rgba(0,242,234,.28);
}
#twiflix-modal .tf-poster{
  width:100%; height:100%;
  object-fit: cover;
  transform: scale(1.02);
  opacity:.95;
}
#twitflix-modal .tf-card:hover .tf-poster{ opacity:.35; }
#twiflix-modal .tf-card:hover .tf-poster{ opacity:.35; }

#twitflix-modal .tf-overlay{
#twiflix-modal .tf-overlay{
  padding: 10px 10px 12px 10px;
}
#twitflix-modal .tf-name{
#twiflix-modal .tf-name{
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
#twitflix-modal .tf-meta{ display:none; } /* cache le texte ‚ÄúSurvol‚Ä¶‚Äù */
#twitflix-modal .tf-actions-row{
#twiflix-modal .tf-meta{ display:none; } /* cache le texte ‚ÄúSurvol‚Ä¶‚Äù */
#twiflix-modal .tf-actions-row{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-top: 10px;
}
#twitflix-modal .tf-pill{
#twiflix-modal .tf-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 10px;
  font-weight: 900;
  color:#000;
  background:#00f2ea;
}
#twitflix-modal .tf-pill.ghost{
#twiflix-modal .tf-pill.ghost{
  background: rgba(255,255,255,.08);
  color:#e8e8ee;
  border:1px solid rgba(255,255,255,.14);
}

#twitflix-modal .tf-search-grid{
#twiflix-modal .tf-search-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  padding-top: 10px;
}

#twitflix-modal .tf-azbar{
#twiflix-modal .tf-azbar{
  position: sticky;
  top: 66px; /* sous la topbar */
  z-index: 55;
  display:flex;
  flex-wrap:wrap;
  gap: 6px;
  padding: 10px 0 8px 0;
  background: linear-gradient(180deg, rgba(11,11,13,.96), rgba(11,11,13,.72));
  border-bottom: 1px solid #1f1f23;
}
#twitflix-modal .tf-azlink{
#twiflix-modal .tf-azlink{
  font-family: Orbitron, sans-serif;
  font-size: 10px;
  font-weight: 900;
  letter-spacing: .12em;
  color:#a7a7b2;
  text-decoration:none;
  padding: 6px 8px;
  border-radius: 10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.12);
  transition:.2s;
}
#twitflix-modal .tf-azlink:hover{ color:#000; background:#00f2ea; border-color:#00f2ea; }
#twiflix-modal .tf-azlink:hover{ color:#000; background:#00f2ea; border-color:#00f2ea; }

#twitflix-modal .tf-end{
#twiflix-modal .tf-end{
  text-align:center;
  color:#9b9ba3;
  padding: 18px 0 6px 0;
}
#twitflix-modal .tf-retry{
#twiflix-modal .tf-retry{
  margin-top: 10px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #2b2b31;
  background:#151515;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
#twitflix-modal .tf-retry:hover{ border-color:#00f2ea; box-shadow:0 0 18px rgba(0,242,234,.18); transform: translateY(-1px); }
#twiflix-modal .tf-retry:hover{ border-color:#00f2ea; box-shadow:0 0 18px rgba(0,242,234,.18); transform: translateY(-1px); }


    /* HUB extras (emotes, gifs, r√©actions) */
    .hub-emo{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#e8e8ee;
      padding:6px 10px;
      border-radius: 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .hub-emo:hover{ border-color:#00f2ea; box-shadow:0 0 12px rgba(0,242,234,.15); }
    .hub-msg{
      padding:8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .hub-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      font-size:10px;
      padding:2px 8px;
@@ -803,85 +865,86 @@
.mosaic-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
.mosaic-tile{ background:#000; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; position:relative; aspect-ratio:16/9; }
.mosaic-tile button{
  position:absolute; top:10px; right:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.18);
  color:#fff; border-radius:12px;
  padding:6px 10px; font-weight:900; cursor:pointer;
}
.mosaic-tile button:hover{ border-color:#00f2ea; }


.tf-tagsbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
.tf-tags{ display:flex; flex-wrap:wrap; gap:8px; }
.tf-tag{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  color:#eaeaf0;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.tf-tag.active{ border-color:#00f2ea; box-shadow:0 0 0 2px rgba(0,242,234,.18) inset; }
.tf-tag:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.18); }
.tf-tag.active{ border-color:#00f2ea; box-shadow:0 0 0 2px rgba(0,242,234,.18) inset, 0 0 20px rgba(0,242,234,.15); background:rgba(0,242,234,.08); }
.tf-ai-toggle{
  width:44px; height:32px;
  border-radius:12px;
  background: rgba(16,16,18,.85);
  border: 1px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.tf-ai-toggle.active{ border-color:#00f2ea; }
.tf-ai-toggle.active{ border-color:#00f2ea; box-shadow:0 0 16px rgba(0,242,234,.28); background:rgba(0,242,234,.12); color:#00f2ea; }

</style>
</head>

<body class="min-h-screen flex flex-col p-4">

  <!-- Spacer (embed-safe): √©vite que le haut soit coup√© dans certains iframes -->
  <div style="height:18px;"></div>


  <header class="flex justify-between items-center mb-4 pb-2 border-b border-[#222]">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-orbitron italic tracking-widest">
        <span class="text-[#00f2ea]">STREAMER</span> HUB
        <span class="bg-[#222] text-[#ff0099] px-2 rounded text-xs ml-2 not-italic">PRO</span>
      </h1>
      <div id="socket-status" class="text-[10px] font-bold text-red-500 border border-red-500 px-2 rounded">
        HUB DISCONNECTED
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="openTwiflix()" class="bg-[#111] hover:bg-[#222] text-[#ff0099] px-4 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#333] hover:border-[#ff0099] shadow-[0_0_10px_rgba(255,0,153,0.1)]">
        <i class="fas fa-play-circle"></i> TWITFLIX
        <i class="fas fa-play-circle"></i> TWIFLIX
      </button>

      <div class="h-6 w-[1px] bg-[#333]"></div>

      <button id="btn-auth" onclick="startAuth()" class="bg-[#6441a5] hover:bg-[#7d5bbe] text-white px-5 py-2 rounded font-bold transition flex items-center gap-2 text-xs font-orbitron border border-[#7d5bbe]">
        <i class="fab fa-twitch"></i> CONNEXION
      </button>

      <div id="user-area" class="hidden flex items-center gap-3">
        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-[#00f2ea]">
        <span id="user-name" class="font-bold text-white text-sm"></span>
        <button onclick="logout()" class="text-gray-500 hover:text-white">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="mb-4 relative group">
    <div id="carousel" class="carousel-track">
      <div class="w-full text-center py-10 border border-dashed border-[#333] rounded text-gray-500">
        <i class="fas fa-satellite-dish mb-2"></i><br>
        Connectez-vous pour voir vos cha√Ænes.
      </div>
    </div>
@@ -1180,80 +1243,80 @@
            <div id="raid-info" class="text-xs text-gray-300"></div>
            <button id="raid-btn" onclick="goToRaid()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold mt-2 hover:bg-white">üéÆ ALLER AU RAID</button>
          </div>
        </div>

        <div>
          <h3 class="text-[#00f2ea] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">CO-STREAM MATCH</h3>
          <div class="text-xs text-gray-400 mb-2">Trouve un co-streamer compatible (jeu/langue/taille).</div>
          <button id="costream-btn" onclick="loadCoStreamer()" class="w-full bg-[#00f2ea] text-black py-2 rounded font-bold hover:bg-white text-xs font-orbitron">
            ü§ù TROUVER
          </button>
          <div id="costream-out" class="mt-3 bg-[#151515] p-3 rounded border border-[#222]" style="display:none;"></div>
        </div>

        <div>
          <h3 class="text-[#ff0099] font-orbitron text-sm mb-3 border-b border-[#222] pb-2">BOOST</h3>
          <input id="boost-query" type="text" placeholder="Cha√Æne..." class="cyber-input mb-2">
          <button onclick="runBoost()" class="w-full bg-[#ff0099] text-white py-2 rounded font-bold font-orbitron hover:bg-white hover:text-black transition">ACTIVER</button>
          <div id="boost-msg" class="text-center text-xs mt-2 text-green-400"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="twitflix-modal" class="tf-modal-overlay">
  <div id="twiflix-modal" class="tf-modal-overlay">
    <div class="tf-modal-content">
      <div class="tf-topbar">
        <div class="tf-brand"><span class="dot"></span><span><span style="color:#00f2ea;">TWI</span>FLIX</span></div>

        <div class="tf-actions">
          <div class="tf-search-wrap">
            <i class="fas fa-search tf-search-ico"></i>
            <input id="twitflix-search" class="tf-search" type="text" placeholder="Rechercher un jeu (ex: Minecraft, Valorant...)" autocomplete="off">
            <input id="twiflix-search" class="tf-search" type="text" placeholder="Rechercher un jeu (ex: Minecraft, Valorant...)" autocomplete="off">
          </div>

          <div class="tf-tagsbar">
            <div id="tf-tags" class="tf-tags"></div>
            <button id="tf-ai-toggle" class="tf-ai-toggle" title="Recherche IA (optionnelle)">IA</button>
          </div>

          <div class="tf-view-toggle">
            <button id="tf-btn-rows" class="tf-toggle-btn active" type="button" onclick="setTwiflixView('rows')">LIGNES</button>
            <button id="tf-btn-az" class="tf-toggle-btn" type="button" onclick="setTwiflixView('az')">A‚ÄìZ</button>
          </div>

          <i class="fas fa-times tf-close" onclick="closeTwiflix()"></i>
        </div>
      </div>

      <div class="tf-sub" style="display:none;"></div>

      <div class="tf-hero"><img id="tf-hero-bg" class="tf-hero-bg" src="" alt=""><div class="tf-hero-content"><div><div id="tf-hero-title" class="tf-hero-title">TWITFLIX</div><div id="tf-hero-sub" class="tf-hero-sub">D√©couvre des jeux, survole pour une preview, clique pour lancer un stream.</div></div></div></div>
      <div class="tf-hero"><img id="tf-hero-bg" class="tf-hero-bg" src="" alt=""><div class="tf-hero-content"><div><div id="tf-hero-title" class="tf-hero-title">TWIFLIX</div><div id="tf-hero-sub" class="tf-hero-sub">D√©couvre des jeux, utilise les tags dynamiques et survole pour pr√©visualiser les lives en temps r√©el.</div></div></div></div>

      <div id="twitflix-grid" class="tf-grid">
      <div id="twiflix-grid" class="tf-grid">
        <div id="tf-loading" class="text-center w-full text-gray-500 py-20">
          <i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...
        </div>
      </div>
    </div>
  </div></div>

  <script>
    const API_BASE = window.location.origin;
    const __urlParams = new URLSearchParams(window.location.search);
    const TWITCH_PARENT = __urlParams.get('parent') || window.location.hostname;
    const PARENT_DOMAINS = ['localhost','127.0.0.1',window.location.hostname,'justplayer.fr','www.justplayer.fr'];

    // --- SFX (Base64 short sounds) ---
    // Son "Open/Whoosh" court
    const sfxOpen = new Audio("data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 
    // (J'ai mis un placeholder vide pour la taille du code, en vrai je vais g√©n√©rer un son synth√©tique simple via WebAudio ou un vrai Base64 si tu veux, mais pour l'instant simulons par log ou un beep simple)
    // Pour que √ßa marche vraiment sans fichier externe, voici des sons tr√®s courts encod√©s:
    
    // Son "Futuristic Click"
    const sfxClick = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 

    // Fonction de lecture s√©curis√©e
    function playSound(type) {
        // En prod, remplacez les src ci-dessus par de vrais fichiers mp3/wav
@@ -1267,51 +1330,51 @@
    let currentChannel = 'twitch';
    let currentUser = null;
    let charts = {};
    let raidTarget = null;

    let currentChannelId = null;
    let currentGameId = null;
    let currentGameName = null;

    // Twiflix infinite scroll
    let currentCursor = null;
    let isLoadingGames = false;

    // INIT
    window.addEventListener('load', async () => {
      initUnderTabs();
      await checkAuth();
      initPlayer();
      loadStatsDashboard();
      initCarouselScroll();
      initSocket();
      initFirebaseStatus();
      setInterval(loadStatsDashboard, 5 * 60 * 1000);
      
      // Infinite scroll listener
      const tfGrid = document.getElementById('twitflix-grid');
      const tfGrid = document.getElementById('twiflix-grid');
      if(tfGrid){
        tfGrid.addEventListener('scroll', () => {
             if (tfGrid.scrollTop + tfGrid.clientHeight >= tfGrid.scrollHeight - 200) {
                 loadMoreCategories();
             }
        });
      }
    });

    function initUnderTabs(){
      const nav = document.getElementById('under-tabs-nav');
      if (!nav) return;
      nav.querySelectorAll('.u-tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ut');
          nav.querySelectorAll('.u-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#under-overview,#under-analytics,#under-niche').forEach(p=>p.classList.remove('active'));
          const panel = document.getElementById(`under-${id}`);
          if (panel) panel.classList.add('active');
        });
      });
    }

    // FIREBASE STATUS
@@ -1795,187 +1858,190 @@
          btn.addEventListener('click', () => {
            if (!input) return;
            insertAtCursor(input, btn.textContent + ' ');
            emojiPanel.classList.add('hidden');
          });
        });
        document.addEventListener('click', (e) => {
          if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) emojiPanel.classList.add('hidden');
        });
      }

      if (gifBtn){
        gifBtn.onclick = openGifModal;
      }
      if (gifClose && gifModal){
        gifClose.onclick = () => gifModal.classList.add('hidden');
      }
      if (gifModal){
        gifModal.addEventListener('click', (e) => {
          if (e.target === gifModal) gifModal.classList.add('hidden');
        });
      }
    });


    // TWITFLIX ‚Äî Netflix-like catalogue (only). Does NOT touch the rest of the app.
    // TWIFLIX ‚Äî Netflix-like catalogue (only). Does NOT touch the rest of the app.
    // Requires:
    //  - GET  /api/categories/top?cursor=...
    //  - (optional) GET /api/categories/search?q=...
    //  - POST /api/stream/by_category { game_id } -> { channel }

    let tfModalOpen = false;
    let tfViewMode = 'rows'; // rows | az
    let tfAllCategories = [];
    let tfCursor = null;
    let tfLoading = false;
    let tfHasMore = true;
    let tfLastLoadAt = 0;

    let tfSearchQuery = '';
    let tfSearchResults = [];
    let tfSearchTimer = null;

    let tfObserver = null;

    // Preview cache
    const tfPreviewCache = new Map(); // gameId -> {channel, t}
    const tfPreviewInflight = new Map();
    const TF_PREVIEW_TTL = 10 * 60 * 1000;

    function tfNormalizeBoxArt(url){
      // request higher res to avoid blur, then we downscale in CSS
      const u = String(url || '');
      if (!u) return '';
      return u.replace('{width}','600').replace('{height}','800');
    }

    function setTwiflixView(mode){
      tfViewMode = (mode === 'az') ? 'az' : 'rows';
      const bRows = document.getElementById('tf-btn-rows');
      const bAz = document.getElementById('tf-btn-az');
      if (bRows && bAz){
        bRows.classList.toggle('active', tfViewMode === 'rows');
        bAz.classList.toggle('active', tfViewMode === 'az');
      }
      renderTwiflix();
    }

    async function openTwiflix(){
      const modal = document.getElementById('twitflix-modal');
      const host = document.getElementById('twitflix-grid');
      const search = document.getElementById('twitflix-search');
      const modal = document.getElementById('twiflix-modal');
      const host = document.getElementById('twiflix-grid');
      const search = document.getElementById('twiflix-search');

      tfModalOpen = true;
      modal.classList.add('active');

      // reset
      tfViewMode = 'rows';
      tfAllCategories = [];
      tfCursor = null;
      tfLoading = false;
      tfHasMore = true;
      tfSearchQuery = '';
      tfSearchResults = [];
      if (search) search.value = '';

      // hero default
      tfSetHero({ title: 'TWITFLIX', sub: 'D√©couvre des jeux, survole pour une preview, clique pour lancer un stream.' });
      tfSetHero({ title: 'TWIFLIX', sub: 'D√©couvre des jeux, active les tags et survole pour une preview live instantan√©e.' });

      // rebuild tags each time to keep UX fresh
      tfBuildTagsUI();

      // empty ui
      if (host){
        host.innerHTML = '<div id="tf-loading" class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement du catalogue...</div>';
      }

      setTwiflixView('rows');

      // search handler (server if possible, fallback local)
      if (search){
        search.oninput = (e) => {
          const v = String(e.target.value || '').trim();
          tfSearchQuery = v;

          if (tfSearchTimer) clearTimeout(tfSearchTimer);
          tfSearchTimer = setTimeout(async () => {
            await tfRunSearch(v);
          }, 180);
        };
      }

      // sentinel observer for infinite loading
      tfSetupObserver();

      // warm load (2 pages)
      await tfLoadMore(true);
      await tfLoadMore(true);
      renderTwiflix();
    }

    function closeTwiflix(){
      tfModalOpen = false;
      document.querySelectorAll('.tf-card.previewing').forEach(tfStopPreview);
      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
        tfObserver = null;
      }
      const modal = document.getElementById('twitflix-modal');
      const modal = document.getElementById('twiflix-modal');
      modal.classList.remove('active');
    }

    function tfSetupObserver(){
      const host = document.getElementById('twitflix-grid');
      const host = document.getElementById('twiflix-grid');
      if (!host) return;

      let sentinel = document.getElementById('tf-sentinel');
      if (!sentinel){
        sentinel = document.createElement('div');
        sentinel.id = 'tf-sentinel';
        sentinel.style.height = '1px';
        host.appendChild(sentinel);
      }

      if (tfObserver){
        try{ tfObserver.disconnect(); }catch(_){}
      }

      tfObserver = new IntersectionObserver(async (entries) => {
        if (!tfModalOpen) return;
        if (tfSearchQuery) return; // no infinite scroll while searching
        if (!tfHasMore) return;
        const entry = entries && entries[0];
        if (entry && entry.isIntersecting){
          await tfLoadMore(false);
          renderTwiflix();
        }
      }, { root: host, threshold: 0.1 });

      tfObserver.observe(sentinel);
    }

    async function tfRunSearch(query){
      const q = String(query || '').trim();
      const host = document.getElementById('twitflix-grid');
      const host = document.getElementById('twiflix-grid');
      if (!host) return;

      if (!q){
        tfSearchResults = [];
        renderTwiflix();
        return;
      }

      // Try server search (best)
      try{
        const r = await fetch(`${API_BASE}/api/categories/search?q=${encodeURIComponent(q)}`);
        if (r.ok){
          const d = await r.json();
          if (d && d.success && Array.isArray(d.categories)){
            tfSearchResults = d.categories.map(c => ({
              id: c.id,
              name: c.name,
              box_art_url: tfNormalizeBoxArt(c.box_art_url || c.boxArtUrl || '')
            }));
            renderTwiflix();
            return;
          }
        }
      }catch(_){}

@@ -2016,98 +2082,98 @@

          for (const cat of data.categories){
            if (!cat || !cat.id) continue;
            // prevent duplicates
            if (tfAllCategories.find(x => x.id === cat.id)) continue;
            tfAllCategories.push({
              id: cat.id,
              name: cat.name,
              box_art_url: tfNormalizeBoxArt(cat.box_art_url || '')
            });
          }
        } else {
          // stop to avoid looping ‚Äúin the void‚Äù
          tfHasMore = false;
          tfRenderError('Erreur chargement du catalogue.');
        }
      } catch (e){
        tfHasMore = false;
        tfRenderError('Erreur r√©seau Twiflix.');
      } finally {
        tfLoading = false;
      }
    }

    function tfRenderError(msg){
      const host = document.getElementById('twitflix-grid');
      const host = document.getElementById('twiflix-grid');
      if (!host) return;
      host.innerHTML = `
        <div class="tf-empty" style="color:#ff8080;">
          ${escapeHtml(msg || 'Erreur')}
          <div><button class="tf-retry" type="button" onclick="tfRetryLoad()">R√©essayer</button></div>
        </div>
      `;
    }

    async function tfRetryLoad(){
      tfHasMore = true;
      await tfLoadMore(true);
      await tfLoadMore(true);
      renderTwiflix();
      tfSetupObserver();
    }

    function renderTwiflix(){
      const host = document.getElementById('twitflix-grid');
      const host = document.getElementById('twiflix-grid');
      if (!host) return;

      // Keep sentinel at bottom
      const sentinel = document.getElementById('tf-sentinel');

      // SEARCH MODE
      if (tfSearchQuery && tfSearchQuery.trim()){
        host.innerHTML = '';
        const q = tfSearchQuery.trim();
        tfSetHero({ title: q, sub: 'R√©sultats de recherche' });

        if (!tfSearchResults.length){
          host.innerHTML = `<div class="tf-empty">Aucun r√©sultat pour <span style="color:#00f2ea;font-weight:900;">${escapeHtml(q)}</span>.</div>`;
          if (sentinel) host.appendChild(sentinel);
          return;
        }

        const grid = document.createElement('div');
        grid.className = 'tf-search-grid';
        tfSearchResults.forEach(cat => grid.appendChild(tfBuildCard(cat)));
        host.appendChild(grid);
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      // CATALOG MODE
      host.innerHTML = '';
      tfSetHero({ title: 'TWITFLIX', sub: 'Survole un jeu pour la preview, clique pour lancer un stream.' });
      tfSetHero({ title: 'TWIFLIX', sub: 'Utilise les tags pour filtrer et survole un jeu pour lancer une preview live.' });

      const list = tfAllCategories.slice(0);
      if (!list.length){
        host.innerHTML = '<div class="tf-empty"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
        if (sentinel) host.appendChild(sentinel);
        return;
      }

      if (tfViewMode === 'az'){
        tfRenderAZ(host, list);
      } else {
        tfRenderRows(host, list);
      }

      if (!tfHasMore){
        const end = document.createElement('div');
        end.className = 'tf-end';
        end.innerHTML = 'Fin du catalogue.';
        host.appendChild(end);
      } else if (tfLoading){
        const loading = document.createElement('div');
        loading.className = 'tf-empty';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
        host.appendChild(loading);
      }
@@ -2193,70 +2259,73 @@
            <span class="tf-pill"><i class="fas fa-play"></i> Lire</span>
            <span class="tf-pill ghost"><i class="fas fa-volume-mute"></i> Preview</span>
          </div>
        </div>
      `;

      // hero update on hover/focus
      div.addEventListener('mouseenter', () => tfSetHero({ title: cat.name, poster }));
      div.addEventListener('focus', () => tfSetHero({ title: cat.name, poster }));

      // click play
      div.onclick = () => playTwiflixCategory(cat.id, cat.name);

      // Hover preview (Netflix-like delay)
      let t = null;
      div.addEventListener('mouseenter', () => { t = setTimeout(() => tfStartPreview(div), 420); });
      div.addEventListener('mouseleave', () => { if (t) clearTimeout(t); tfStopPreview(div); });

      return div;
    }

    function tfSetHero({ title, sub, poster }){
      const bg = document.getElementById('tf-hero-bg');
      const t = document.getElementById('tf-hero-title');
      const s = document.getElementById('tf-hero-sub');
      if (t) t.textContent = String(title || 'TWITFLIX');
      if (t) t.textContent = String(title || 'TWIFLIX');
      if (s) s.textContent = String(sub || '');
      if (bg){
        if (poster) { bg.src = poster; bg.style.opacity = '.55'; }
        else { bg.removeAttribute('src'); bg.style.opacity = '.15'; }
      }
    }

    async function tfStartPreview(cardEl){
      try{
        if (!cardEl || cardEl.classList.contains('previewing')) return;
        const gameId = String(cardEl.dataset.gameId || '');
        if (!gameId) return;

        const host = cardEl.querySelector('.tf-preview');
        if (!host) return;

        const channel = await tfGetPreviewChannel(gameId);
        if (!channel) return;

        const poster = cardEl.querySelector('.tf-poster')?.src;
        tfSetHero({ title: cardEl.dataset.gameName || 'TWIFLIX', sub: `Preview live : ${channel}`, poster });

        const parent = encodeURIComponent(TWITCH_PARENT || window.location.hostname);
        const src = `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=true&autoplay=true`;

        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.allow = 'autoplay; fullscreen';
        iframe.frameBorder = '0';

        host.innerHTML = '';
        host.appendChild(iframe);
        cardEl.classList.add('previewing');
      }catch(_){}
    }

    function tfStopPreview(cardEl){
      try{
        if (!cardEl) return;
        const host = cardEl.querySelector('.tf-preview');
        if (host) host.innerHTML = '';
        cardEl.classList.remove('previewing');
      }catch(_){}
    }

@@ -2269,64 +2338,64 @@

      const p = (async () => {
        try{
          const res = await fetch(`${API_BASE}/api/stream/by_category`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ game_id: gameId })
          });
          const data = await res.json();
          const channel = data && data.success ? data.channel : null;
          if (channel) tfPreviewCache.set(gameId,{ channel, t: Date.now() });
          return channel;
        }catch(_){
          return null;
        }finally{
          tfPreviewInflight.delete(gameId);
        }
      })();

      tfPreviewInflight.set(gameId, p);
      return p;
    }

    async function playTwiflixCategory(gameId, gameName){
      closeTwiflix();
      document.getElementById('current-channel-display').innerText = "TWITFLIX‚Ä¶";
      document.getElementById('current-channel-display').innerText = "TWIFLIX‚Ä¶";

      try{
        const res = await fetch(`${API_BASE}/api/stream/by_category`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ game_id: gameId })
        });
        const data = await res.json();

        if (data && data.success && data.channel){
          changeChannel(data.channel);
          const badge = document.getElementById('player-mode-badge');
          if (badge) badge.innerText = "TWITFLIX";
          if (badge) badge.innerText = "TWIFLIX";
        } else {
          alert("Aucun stream trouv√© pour ce jeu.");
          document.getElementById('current-channel-display').innerText = "OFFLINE";
        }
      }catch(_){
        alert("Erreur lors de la recherche Twiflix.");
      }
    }

    function tfShuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
// BEST TIME

    async function analyzeBestTime(){
      const gameInput = document.getElementById('best-time-game').value.trim();
      if (!gameInput) return alert('Veuillez entrer un nom de jeu');

      const btn = document.getElementById('analyze-schedule-btn');
      const loading = document.getElementById('best-time-loading');
@@ -3301,66 +3370,70 @@ const TF_TAGS = [
function tfInferTags(name){
  const n = String(name||'').toLowerCase();
  const tags = new Set();
  if(/valorant|cs:go|counter|call of duty|warzone|apex|fortnite|overwatch|rainbow|pubg/.test(n)) tags.add('FPS');
  if(/rpg|elden|baldur|final fantasy|diablo|path of exile|skyrim|witcher|persona/.test(n)) tags.add('RPG');
  if(/surviv|rust|dayz|ark|valheim|subnautica|dont starve/.test(n)) tags.add('Survie');
  if(/minecraft|roblox|sandbox|terraria/.test(n)) tags.add('Sandbox');
  if(/strateg|civilization|total war|starcraft|age of empires|xcom|anno/.test(n)) tags.add('Strat√©gie');
  if(/rogue|roguel|hades|dead cells|isaac/.test(n)) tags.add('Rogue');
  if(/horror|resident|silent hill|phasmophobia|outlast|amnesia/.test(n)) tags.add('Horreur');
  if(/coop|co-op|co op|left 4 dead|it takes two|overcooked/.test(n)) tags.add('Coop');
  if(/rank|competitive|esports|league of legends|dota|rocket league|tekken|street fighter/.test(n)) tags.add('Comp√©titif');
  if(/indie|ind√©/.test(n)) tags.add('Ind√©');
  if(/fifa|ea sports|nba|ufc|mlb|nhl|football manager/.test(n)) tags.add('Sport');
  if(/racing|forza|gran turismo|need for speed|mario kart|f1 /.test(n)) tags.add('Course');
  if(/mmo|world of warcraft|ffxiv|guild wars|runescape|black desert/.test(n)) tags.add('MMO');
  if(/adventure|aventure|zelda|uncharted|tomb raider/.test(n)) tags.add('Aventure');
  return Array.from(tags);
}

function tfBuildTagsUI(){
  const wrap = document.getElementById('tf-tags');
  const btn = document.getElementById('tf-ai-toggle');
  if(!wrap) return;
  wrap.innerHTML = TF_TAGS.map(t=>`<div class="tf-tag" data-tag="${t}">${t}</div>`).join('');
  wrap.addEventListener('click', (e)=>{
    const el = e.target.closest('.tf-tag');
    if(!el) return;
    const t = el.dataset.tag;
    if(tfActiveTags.has(t)) tfActiveTags.delete(t); else tfActiveTags.add(t);
    el.classList.toggle('active', tfActiveTags.has(t));
    tfRunSearch(document.getElementById('twitflix-search')?.value || '');
  }, { passive:true });

  if(btn){
  if(wrap.dataset.bound !== '1'){
    wrap.addEventListener('click', (e)=>{
      const el = e.target.closest('.tf-tag');
      if(!el) return;
      const t = el.dataset.tag;
      if(tfActiveTags.has(t)) tfActiveTags.delete(t); else tfActiveTags.add(t);
      el.classList.toggle('active', tfActiveTags.has(t));
      tfRunSearch(document.getElementById('twiflix-search')?.value || '');
    }, { passive:true });
    wrap.dataset.bound = '1';
  }

  if(btn && btn.dataset.bound !== '1'){
    btn.addEventListener('click', ()=>{
      tfAiOn = !tfAiOn;
      btn.classList.toggle('active', tfAiOn);
      toast(`Recherche IA ${tfAiOn ? 'activ√©e' : 'd√©sactiv√©e'}`);
      tfRunSearch(document.getElementById('twitflix-search')?.value || '');
      tfRunSearch(document.getElementById('twiflix-search')?.value || '');
    });
    btn.dataset.bound = '1';
  }
}

function tfMatchCategory(cat, tokens){
  const name = String(cat.name||'');
  const low = name.toLowerCase();
  const inferred = cat._tags || (cat._tags = tfInferTags(name));
  const hasTokens = tokens.every(t => low.includes(t) || inferred.map(x=>x.toLowerCase()).includes(t));
  if(!hasTokens) return false;

  if(tfActiveTags.size){
    const set = new Set(inferred);
    for(const t of tfActiveTags){
      if(!set.has(t)) return false;
    }
  }
  return true;
}

// monkey-patch tfRunSearch to include tokens/tags and optional AI rerank
const __tfRunSearch = typeof tfRunSearch === 'function' ? tfRunSearch : null;

// === Twiflix AI toggle + rerank (safe fallback) ===
let tfAiEnabled = false;
try{
@@ -3392,119 +3465,113 @@ async function tfApplyAiRanking(query, items){
    });
    const data = await res.json();
    if(!data || !data.success || !Array.isArray(data.order)) return items;

    const out = data.order.map(i=>items[i]).filter(Boolean);
    // ensure no missing
    const set = new Set(out);
    items.forEach(it=>{ if(!set.has(it)) out.push(it); });
    return out;
  }catch(e){
    console.warn('[Twiflix AI] fallback', e);
    return items;
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('tf-ai-toggle');
  if(b){
    tfSetAiUI();
    b.addEventListener('click', ()=>{
      tfAiEnabled = !tfAiEnabled;
      try{ localStorage.setItem('tf_ai', tfAiEnabled ? '1' : '0'); }catch(_){}
      tfSetAiUI();
      // re-run search immediately if query exists
      try{
        const q = document.getElementById('twitflix-search')?.value || '';
        const q = document.getElementById('twiflix-search')?.value || '';
        if(window.tfRunSearch) window.tfRunSearch(q);
      }catch(_){}
    });
  }
});

if(__tfRunSearch){
  window.tfRunSearch = async function(query){
    const q = String(query||'').trim();
    const host = document.getElementById('twitflix-grid');
    const host = document.getElementById('twiflix-grid');
    if(!host) return;

    const tokens = q.toLowerCase().split(/\s+/).filter(Boolean).slice(0,6);

    // empty query but tags active -> filter by tags only
    if(!q && !tfActiveTags.size){
      tfSearchResults = [];
      renderTwiflix();
      return;
    }

    // try server if query present
    if(q){
      try{
        const r = await fetch(`${API_BASE}/api/categories/search?q=${encodeURIComponent(q)}`);
        if(r.ok){
          const d = await r.json();
          const items = (d && (d.categories||d.items||d.results)) || [];
          const norm = items.map(x=>({ name: x.name||x.game||x.title||'', ...x }));
          const filtered = norm.filter(c=>tfMatchCategory(c, tokens)).slice(0,200);
          tfSearchResults = filtered;
          renderTwiflix();
          // optional AI rerank (best-effort, if endpoint exists)
          if(tfAiOn){
            try{
              const ar = await fetch(`${API_BASE}/api/ai/twiflix?q=${encodeURIComponent(q)}`, { method:'GET' });
              if(ar.ok){
                const ad = await ar.json();
                const order = Array.isArray(ad.order) ? ad.order : null;
                if(order){
                  const map = new Map(tfSearchResults.map(c=>[String(c.name).toLowerCase(), c]));
                  tfSearchResults = order.map(n=>map.get(String(n).toLowerCase())).filter(Boolean).concat(tfSearchResults).slice(0,200);
                  renderTwiflix();
                }
              }
            }catch(_){}
          }
          return;
        }
      }catch(_){}
    }

    // fallback local
    const base = (tfAllCategories||[]).filter(c=>tfMatchCategory(c, tokens)).slice(0,200);
    const ranked = await tfApplyAiRanking(q, base);
    tfSearchResults = ranked;
    renderTwiflix();
  }
}

// Hook when modal opens
const __openTwiflix = typeof openTwitflix === 'function' ? openTwitflix : null;
if(__openTwiflix){
  window.openTwitflix = async function(){
    await __openTwiflix();
    setTimeout(tfBuildTagsUI, 50);
  }
}
// Legacy alias to keep older triggers compatible
window.openTwitflix = openTwiflix;

</script>

<div id="mosaicModal" class="modal-overlay" onclick="closeMosaic(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-title">Mosaic Mode</div>
      <button class="modal-close" onclick="closeMosaic(event)">‚úï</button>
    </div>
    
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:0 0 10px 0;">
      <input id="mosaicCh1" placeholder="Cha√Æne 1" style="flex:1;min-width:160px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:9px;">
      <input id="mosaicCh2" placeholder="Cha√Æne 2" style="flex:1;min-width:160px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:9px;">
      <input id="mosaicCh3" placeholder="Cha√Æne 3" style="flex:1;min-width:160px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:9px;">
      <input id="mosaicCh4" placeholder="Cha√Æne 4" style="flex:1;min-width:160px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:9px;">
      <button onclick="applyMosaicSelection()" style="background:#00f2ea;color:#000;border:0;border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;">Mettre √† jour</button>
    </div>

    <div class="mosaic-grid" id="mosaicGrid"></div>
  </div>
</div>

<div id="fantasyModal" class="modal-overlay" onclick="closeFantasy(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-title">Fantasy League</div>
      <button class="modal-close" onclick="closeFantasy(event)">‚úï</button>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:290px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
        <div style="font-weight:900;color:#00f2ea;margin-bottom:6px;">Portefeuille (max 10 streamers)</div>
        <div id="fantasyCash" style="font-size:22px;font-weight:900;color:#fff;">‚Äî</div>
        <div id="fantasyHoldings" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
      </div>

      <div style="flex:2;min-width:320px;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(255,255,255,.03);">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="fantasyStreamer" placeholder="Streamer (login)" style="flex:1;min-width:220px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;">
          <input id="fantasyAmount" placeholder="Montant" type="number" min="1" style="width:140px;background:#0f0f12;border:1px solid #2b2b31;color:#fff;border-radius:12px;padding:10px;">
          <button onclick="fantasyBuy()" style="background:#00f2ea;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Investir</button>
          <button onclick="fantasySell()" style="background:#ff0099;color:#000;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Vendre</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:260px;">
            <div style="font-weight:900;color:#eaeaf0;margin-bottom:6px;">Cours</div>
            <div id="marketInfo" style="display:flex;gap:10px;flex-wrap:wrap;color:#a7a7b2;font-size:12px;"></div>
            <canvas id="marketChart" width="640" height="220" style="width:100%;background:#0b0b0d;border:1px solid rgba(255,255,255,.10);border-radius:14px;"></canvas>
          </div>
          <div style="flex:1;min-width:260px;">
            <div style="font-weight:900;color:#ffd600;margin-bottom:6px;">Leaderboard</div>
            <div id="fantasyLeaderboard" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

</body>
</html>
