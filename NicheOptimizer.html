<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer & Niche AI Hub V7.3 - Fixes</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- VARIABLES CSS POUR FACILITER LA MAINTENANCE DES COULEURS --- */
        :root {
            --color-bg-dark: #0d0d0d;
            --color-bg-medium: #1a1a1a;
            --color-bg-light: #111;
            --color-primary-pink: #ff0099;
            --color-secondary-blue: #22c7ef;
            --color-ai-niche: #59d682; /* Vert */
            --color-ai-repurpose: #9933ff; /* Violet */
            --color-ai-growth: #ffcc00; /* Jaune */
            --color-text-dimmed: #9aa3a8;
            --color-border-dark: #2e2e2e;
            --color-border-medium: #333;
        }

        /* Styles Globaux */
        html, body { 
            background-color: var(--color-bg-dark); 
            color: #fff; 
            font-family: 'Inter', Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            min-height: 100vh; /* FIX FOND BLANC : Assure la couverture totale */
            height: 100%; 
        }

        /* Utilitaire pour centrer le contenu sur la page principale */
        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 40px);
        }

        /* Style pour les liens de navigation */
        .nav-link {
            transition: color 0.3s, background-color 0.3s;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            color: #fff;
            font-weight: 600;
        }

        .nav-link:hover {
            background-color: var(--color-bg-medium);
            color: var(--color-primary-pink);
        }
        
        /* Styles de l'en-t√™te */
        header {
            background-color: var(--color-bg-medium);
            padding: 10px 0;
            border-bottom: 2px solid var(--color-primary-pink);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--color-secondary-blue);
            text-shadow: 0 0 5px rgba(34, 199, 239, 0.5);
        }
        
        /* Styles du menu des outils/onglets */
        .tab-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--color-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--color-border-medium);
        }

        .tab-button {
            background-color: var(--color-bg-light);
            color: var(--color-text-dimmed);
            border: 1px solid var(--color-border-dark);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            font-weight: 600;
        }

        .tab-button:hover {
            background-color: var(--color-bg-dark);
            color: #fff;
        }

        .tab-button.active {
            background-color: var(--color-primary-pink);
            color: #fff;
            border-color: var(--color-primary-pink);
            box-shadow: 0 0 10px rgba(255, 0, 153, 0.5);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--color-bg-medium);
            border-radius: 8px;
            border: 1px solid var(--color-border-medium);
        }

        .tab-content.active {
            display: block;
        }
        
        /* Composants G√©n√©raux */
        input[type="text"], button, select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--color-border-dark);
            font-size: 1rem;
        }

        input[type="text"], select {
            background-color: var(--color-bg-light);
            color: #fff;
            flex-grow: 1;
        }

        .btn-primary {
            background-color: var(--color-primary-pink);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #ff33b3;
        }

        .btn-secondary {
            background-color: var(--color-secondary-blue);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #00b0d8;
        }

        /* Styles sp√©cifiques aux r√©sultats */
        #scan-results, #ai-critique-results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--color-bg-light);
            border-radius: 8px;
            border: 1px solid var(--color-border-medium);
        }

        .stream-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: var(--color-bg-medium);
            border-radius: 6px;
            border-left: 3px solid var(--color-primary-pink);
        }

        .stream-item:nth-child(even) {
            border-left: 3px solid var(--color-secondary-blue);
        }
        
        .stream-item img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            object-fit: cover;
        }
        
        /* Styles sp√©cifiques VOD/Videos */
        .vod-grid {
            display: grid;
            /* Fix: Force 3 colonnes pour r√©pondre √† la demande de ne pas mettre d'espace pour changer */
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px;
            margin-top: 15px;
        }

        /* S'assure que m√™me sur petit √©cran (si on voulait plus tard) il y ait 3 colonnes ou moins */
        @media (max-width: 900px) {
            .vod-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        .vod-item {
            cursor: pointer;
            background-color: var(--color-bg-medium);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--color-border-medium);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .vod-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 0, 153, 0.3);
        }
        
        .vod-item img {
            width: 100%;
            /* Garde le ratio 16:9 pour les vid√©os, mais autorise l'auto-hauteur si n√©cessaire */
            aspect-ratio: 16 / 9; 
            display: block;
            border-bottom: 1px solid var(--color-primary-pink);
            object-fit: cover; 
        }
        
        .vod-info {
            padding: 10px;
        }
        
        .vod-info h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-secondary-blue);
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .vod-info p {
            font-size: 0.75rem;
            color: var(--color-text-dimmed);
            margin: 0;
        }
        
        .stat-box {
            background-color: var(--color-bg-light);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--color-border-dark);
        }
        
        .stat-box .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary-pink);
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Styles de l'encart de connexion Twitch */
        #auth-status-box {
            background-color: var(--color-bg-light);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--color-secondary-blue);
            margin-bottom: 20px;
            color: var(--color-text-dimmed);
        }
        
        #auth-status-box strong {
            color: #fff;
        }
        
        /* Style pour la critique IA (GARANTIE DE MISE EN FORME STABLE) */
        #ia-critique-results {
            background-color: var(--color-bg-light);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-border-medium);
        }
        /* Fix stabilit√©: style pour les titres g√©n√©r√©s */
        #ia-critique-results h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-ai-niche);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-border-medium);
        }
        
        /* Fix stabilit√©: Styles pour le contenu g√©n√©r√© */
        #ia-critique-results p, #ia-critique-results li {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        #ia-critique-results ul, #ia-critique-results ol {
            /* Fix stabilit√©: Assure l'indentation et les puces/nombres */
            list-style: disc;
            margin-left: 20px;
            padding-left: 0;
            margin-bottom: 15px;
        }

        /* Styles pour la zone de lecture de stream */
        #twitch-embed-player {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--color-secondary-blue);
        }
        
        /* Styles pour le Mini-Assistant (inchang√©, mais inclus pour la compl√©tude) */
        #mini-assistant-wrapper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .assistant-toggle-btn {
            background-color: var(--color-ai-growth);
            color: var(--color-bg-dark);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 204, 0, 0.5);
            transition: transform 0.2s;
        }
        
        .assistant-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        #assistant-chat-box {
            width: 300px;
            height: 400px;
            background-color: var(--color-bg-medium);
            border-radius: 10px;
            border: 2px solid var(--color-ai-growth);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            margin-top: 10px;
        }
        
        #assistant-chat-box.open {
            transform: translateY(0);
        }
        
        .assistant-header {
            background-color: var(--color-ai-growth);
            color: var(--color-bg-dark);
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .assistant-messages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: var(--color-bg-light);
        }
        
        .assistant-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .assistant-messages::-webkit-scrollbar-thumb {
            background-color: var(--color-ai-growth);
            border-radius: 3px;
        }
        
        .msg {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            max-width: 85%;
        }
        
        .msg.user {
            background-color: var(--color-primary-pink);
            margin-left: auto;
            color: white;
        }
        
        .msg.bot {
            background-color: var(--color-bg-medium);
            border: 1px solid var(--color-ai-growth);
            color: #fff;
            margin-right: auto;
        }
        
        .msg.bot p {
            margin: 0;
        }
        
        .msg.bot ul {
            padding-left: 20px;
            margin: 5px 0 0 0;
        }
        
        .assistant-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--color-border-medium);
        }
        
        .assistant-input-area input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--color-ai-growth);
            background-color: var(--color-bg-dark);
        }
        
        .assistant-input-area button {
            margin-left: 5px;
            background-color: var(--color-ai-growth);
            color: var(--color-bg-dark);
            padding: 0 10px;
            font-weight: bold;
        }
        
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo">Streamer AI Hub</div>
            <nav class="flex gap-4">
                <a href="/NicheOptimizer.html" class="nav-link bg-gray-700">Scan & Critique</a>
                <a href="/lucky_streamer_picker.html" class="nav-link">Streamer Chanceux</a>
                <a href="/sniper_tool.html" class="nav-link">Sniper Tool</a>
            </nav>
        </div>
    </header>

    <div class="page-wrapper">
        <h1 class="text-3xl font-bold mb-6 text-center text-white">Analyse de Niche et Croissance IA</h1>

        <div id="auth-status-box" class="flex justify-between items-center mb-6">
            <div id="status-text">
                Statut: D√©connect√©. Connectez-vous pour acc√©der √† l'onglet "Streams Suivis".
            </div>
            <div class="auth-actions">
                <a id="twitch-login-btn" href="/twitch_auth_start" class="btn-primary py-2 px-4 rounded">
                    Connecter Twitch
                </a>
                <button id="twitch-logout-btn" class="btn-secondary py-2 px-4 rounded hidden">
                    D√©connexion
                </button>
            </div>
        </div>

        <div class="tab-menu">
            <button class="tab-button active" onclick="openTab('tab-followed')" id="btn-followed">Streams Suivis</button>
            <button class="tab-button" onclick="openTab('tab-scan')" id="btn-scan">Scanner Jeu/Streamer</button>
            <button class="tab-button" onclick="openTab('tab-ia-critique')" id="btn-ia-critique">Critique IA</button>
            <button class="tab-button" onclick="openTab('tab-stream-boost')" id="btn-stream-boost">Stream Boost</button>
        </div>

        <div id="tab-followed" class="tab-content active">
            <h2 class="text-xl font-bold mb-4 text-white">Streams Actuellement Suivis (Live)</h2>
            <div id="followed-streams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p id="followed-loading-message" class="text-center text-gray-400">Chargement des streams en direct...</p>
            </div>
        </div>

        <div id="tab-scan" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-white">Scanner Niche ou Profil Streamer</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="scan-query" placeholder="Entrez un nom de jeu (ex: Valorant) ou un pseudo Twitch (ex: shroud)" />
                <button id="scan-btn" class="btn-primary">Lancer le Scan</button>
            </div>
            <div id="scan-results">
                </div>
        </div>

        <div id="tab-ia-critique" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-white">Analyse Strat√©gique par Gemini AI</h2>
            
            <div class="flex gap-4 mb-4">
                <select id="ia-critique-type" class="p-2 rounded bg-gray-700 text-white border border-gray-600 flex-shrink-0">
                    <option value="trend">1. üìà Tendance Niche (Global)</option>
                    <option value="niche">2. üîé Saturation Jeu (Sp√©cifique)</option>
                    <option value="repurpose">3. üé¨ Repurposing Contenu (Streamer)</option>
                </select>
                <input type="text" id="ia-critique-query" placeholder="Jeu ou Streamer (sauf pour Tendance Niche)" class="flex-grow" />
                <button id="ia-critique-btn" class="btn-secondary">Lancer l'Analyse IA</button>
            </div>
            
            <div id="ia-critique-results" class="text-sm">
                <h4>R√©sultats de l'Analyse</h4>
                <p class="text-gray-400">S√©lectionnez le type d'analyse et entrez la requ√™te (si n√©cessaire) pour obtenir une critique d√©taill√©e par l'Intelligence Artificielle.</p>
            </div>
        </div>

        <div id="tab-stream-boost" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-white">Stream Boost (Cooldown 3h)</h2>
            <p class="text-gray-400 mb-4">Mettez un stream en rotation prioritaire dans le "Streamer Chanceux" pour qu'il soit sugg√©r√© plus souvent √† la communaut√©.</p>
            <div class="flex gap-2 mb-4">
                <input type="text" id="boost-channel-input" placeholder="Nom de la cha√Æne √† booster (votre ou celle d'un ami)" />
                <button id="boost-stream-btn" class="btn-primary">Booster le Stream</button>
            </div>
            <div id="boost-result-box" class="text-base text-center mt-4">
                </div>
        </div>
        
        <div id="twitch-embed-player">
            </div>

    </div> <div id="mini-assistant-wrapper">
        <button class="assistant-toggle-btn" id="assistant-toggle">ü§ñ</button>
        <div id="assistant-chat-box">
            <div class="assistant-header">Mini-Assistant IA</div>
            <div class="assistant-messages" id="assistant-msgs">
                <div class="msg bot">Bonjour ! Posez-moi une question sur le streaming, le SEO Twitch ou la croissance.</div>
            </div>
            <div class="assistant-input-area">
                <input type="text" id="assistant-input" placeholder="Votre question..." />
                <button id="assistant-send-btn">Envoyer</button>
            </div>
        </div>
    </div>


<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    const API_BASE = ''; 

    // --- Gestion des Onglets ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        document.getElementById('btn-' + tabId.replace('tab-', '')).classList.add('active');
        localStorage.setItem('activeTab', tabId);

        // Masquer la zone de requ√™te pour la Tendance Niche
        const iaQueryInput = document.getElementById('ia-critique-query');
        if (tabId === 'tab-ia-critique') {
            const iaType = document.getElementById('ia-critique-type').value;
            iaQueryInput.style.display = (iaType === 'trend') ? 'none' : 'block';
        } else {
            iaQueryInput.style.display = 'block';
        }
    }

    document.getElementById('ia-critique-type').addEventListener('change', function() {
        // Fix: Permet de r√©initialiser le titre de la critique IA
        const iaQueryInput = document.getElementById('ia-critique-query');
        iaQueryInput.style.display = (this.value === 'trend') ? 'none' : 'block';
        
        const resultsBox = document.getElementById('ia-critique-results');
        resultsBox.innerHTML = '<h4>R√©sultats de l\'Analyse</h4><p class="text-gray-400">Lancez l\'analyse pour la critique IA.</p>';

        document.getElementById('ia-critique-query').placeholder = 
            (this.value === 'niche') ? 'Nom du Jeu' : 
            (this.value === 'repurpose') ? 'Nom du Streamer' : 'Non pertinent';

        if (this.value === 'trend') {
            document.getElementById('ia-critique-query').value = '';
        }
    });


    // --- Fonctions d'Authentification / Lecteur ---
    async function checkAuth() {
        const statusBox = document.getElementById('auth-status-box');
        const statusText = document.getElementById('status-text');
        const loginBtn = document.getElementById('twitch-login-btn');
        const logoutBtn = document.getElementById('twitch-logout-btn');

        const res = await fetch(`${API_BASE}/twitch_user_status`);
        const data = await res.json();

        if (data.is_connected) {
            statusText.innerHTML = `Statut: Connect√© en tant que <strong>${data.username}</strong>.`;
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            fetchFollowedStreams(data.user_id);
        } else {
            statusText.innerHTML = `Statut: D√©connect√©. Connectez-vous pour acc√©der √† l'onglet "Streams Suivis".`;
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            document.getElementById('followed-streams-list').innerHTML = `<p class="text-center text-gray-400">Veuillez vous connecter √† Twitch pour voir vos streams suivis.</p>`;
        }
    }

    document.getElementById('twitch-logout-btn').addEventListener('click', async () => {
        await fetch(`${API_BASE}/twitch_logout`, { method: 'POST' });
        checkAuth();
    });

    let twitchPlayer = null;
    function initializePlayer() {
        if (twitchPlayer) return; 
        twitchPlayer = new Twitch.Embed("twitch-embed-player", {
            width: "100%",
            height: "100%",
            channel: "Twitch", 
            layout: "video",
            autoplay: false
        });
    }

    function launchPlayer(channelOrVideoId) {
        if (!twitchPlayer) {
            initializePlayer();
        }
        
        // V√©rifie si l'ID est une VOD (nombre seul, g√©n√©ralement long, ex: 2039209707)
        // Les noms de cha√Ænes n'ont pas de 'v' devant dans la nouvelle API Embed pour les VODs
        const isVideoId = !isNaN(parseInt(channelOrVideoId)) && channelOrVideoId.length > 3;

        if (isVideoId) {
            twitchPlayer.setVideo(channelOrVideoId);
            twitchPlayer.setVolume(0.5); 
        } else {
            twitchPlayer.setChannel(channelOrVideoId);
            twitchPlayer.setVolume(0.5); 
            localStorage.setItem('activeChannel', channelOrVideoId);
        }
    }
    
    // --- Requ√™te Streams Suivis ---
    async function fetchFollowedStreams() {
        const list = document.getElementById('followed-streams-list');
        const loadingMsg = document.getElementById('followed-loading-message');
        
        if (loadingMsg) loadingMsg.innerText = "Chargement des streams en direct...";

        try {
            const res = await fetch(`${API_BASE}/followed_streams`);
            const data = await res.json();

            list.innerHTML = ''; 
            
            if (data.error) {
                list.innerHTML = `<p class="text-center text-red-400">${data.error}</p>`;
                return;
            }

            if (data.data && data.data.length > 0) {
                data.data.forEach(stream => {
                    const html = `
                        <div class="stream-item cursor-pointer" onclick="launchPlayer('${stream.user_login}')">
                            <img src="${stream.profile_image_url || 'https://static-cdn.jtvnw.net/jtv_user_pictures/twitch-profile_image-21af129c7821c9eb-70x70.png'}" alt="${stream.user_name}">
                            <div class="flex-grow">
                                <p class="font-bold text-white">${stream.user_name}</p>
                                <p class="text-sm text-gray-400 truncate">${stream.title}</p>
                            </div>
                            <div class="flex flex-col items-center text-sm">
                                <span class="number text-red-500">${stream.viewer_count.toLocaleString()}</span>
                                <span class="text-gray-400">Vues</span>
                            </div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } else {
                list.innerHTML = `<p class="text-center text-gray-400">Aucun stream suivi n'est actuellement en direct ou vous n'avez pas de followers.</p>`;
            }

        } catch (e) {
            list.innerHTML = `<p class="text-center text-red-400">Erreur de connexion au serveur: ${e.message}</p>`;
        }
    }


    // --- Scan de Niche/Streamer (Mise √† jour pour VODs et limite 3) ---
    document.getElementById('scan-btn').addEventListener('click', async function() {
        const query = document.getElementById('scan-query').value.trim();
        const resultsBox = document.getElementById('scan-results');
        const btn = this;

        if (!query) {
            resultsBox.innerHTML = '<p class="text-red-400">Veuillez entrer un nom de jeu ou un pseudo.</p>';
            return;
        }

        resultsBox.innerHTML = '<p class="text-center text-white">Analyse en cours... (Cela peut prendre quelques secondes)</p>';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/scan_target`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query })
            });
            const data = await res.json();

            if (!res.ok) {
                resultsBox.innerHTML = `<p class="text-red-400">Erreur: ${data.error || "√âchec de la requ√™te."}</p>`;
                return;
            }

            let html = '';

            if (data.type === 'game') {
                const game = data.game_data;
                
                // --- Bloc Stats et Infos Jeu ---
                html = `
                    <div class="flex items-start gap-6 mb-4 p-4 bg-gray-700 rounded-lg">
                        <img src="${game.box_art_url}" alt="${game.name}" class="w-20 h-28 object-cover rounded shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-2">${game.name} - Analyse de Niche</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="stat-box">
                                    <div class="number text-pink-500">${game.total_viewers.toLocaleString()}</div>
                                    <div class="text-xs text-gray-400">Vues Totales</div>
                                </div>
                                <div class="stat-box">
                                    <div class="number text-blue-400">${game.total_streamers}</div>
                                    <div class="text-xs text-gray-400">Streamers Actifs</div>
                                </div>
                                <div class="stat-box">
                                    <div class="number text-green-400">${game.avg_viewers_per_streamer}</div>
                                    <div class="text-xs text-gray-400">Vues/Streamer (V/S)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-white mt-4 mb-2">Top ${game.streams.length || 0} Streams Live (Max 3):</h4>
                    ${game.streams.length > 0 ? 
                        game.streams.map(s => `
                        <div class="stream-item cursor-pointer" onclick="launchPlayer('${s.user_login}')">
                            <div class="flex-grow">
                                <p class="font-bold text-white">${s.user_name}</p>
                                <p class="text-sm text-gray-400 truncate">${s.title}</p>
                            </div>
                            <div class="flex flex-col items-center text-sm">
                                <span class="number text-red-500">${s.viewer_count.toLocaleString()}</span>
                            </div>
                        </div>
                        `).join('')
                        : '<p class="text-gray-400">Aucun stream live trouv√©.</p>'
                    }
                `;
                
                // --- Bloc VODs (Vid√©os √† la Demande) ---
                if (game.videos && game.videos.length > 0) {
                    html += `<h4 class="text-lg font-semibold text-white mt-6 mb-2">VODs R√©centes (Max 3, cliquable) :</h4><div class="vod-grid">`;
                    
                    game.videos.forEach(v => {
                        html += `
                            <div class="vod-item" onclick="launchPlayer('${v.id}')">
                                <img src="${v.thumbnail_url}" alt="${v.title}">
                                <div class="vod-info">
                                    <h5>${v.title}</h5>
                                    <p>${v.user_name} &bull; ${new Date(v.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else {
                    html += '<p class="text-gray-400 mt-6">Aucune VOD r√©cente trouv√©e pour ce jeu.</p>';
                }


                // D√©marre le lecteur sur le stream le plus populaire (ou le premier VOD)
                if (game.streams.length > 0) {
                    launchPlayer(game.streams[0].user_login);
                } else if (game.videos.length > 0) {
                    launchPlayer(game.videos[0].id);
                }


            } else if (data.type === 'user') {
                const user = data.user_data;
                const streamStatus = user.is_live ? 
                    `<span class="bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full">LIVE</span>` : 
                    `<span class="bg-gray-600 text-gray-300 text-xs font-bold py-1 px-3 rounded-full">OFFLINE</span>`;
                
                let streamDetails = '';
                if (user.is_live) {
                    streamDetails = `
                        <p class="mt-2 text-white font-semibold">Titre: ${user.stream_details.title}</p>
                        <p class="text-gray-400">Jeu: ${user.stream_details.game_name}</p>
                        <p class="text-gray-400">Vues: ${user.stream_details.viewer_count.toLocaleString()}</p>
                        <button class="btn-primary mt-3 py-2 px-4" onclick="launchPlayer('${user.login}')">Regarder le Stream</button>
                    `;
                }
                
                html = `
                    <div class="flex items-start gap-6 mb-4 p-4 bg-gray-700 rounded-lg">
                        <img src="${user.profile_image_url}" alt="${user.display_name}" class="w-24 h-24 object-cover rounded-full shadow-lg border-2 border-pink-500">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-1">${user.display_name} ${streamStatus}</h3>
                            <p class="text-gray-400 mb-2">@${user.login}</p>
                            <p class="text-sm text-gray-300 italic">Description: ${user.description || 'Pas de description.'}</p>
                            ${streamDetails}
                        </div>
                    </div>
                `;
                if (user.is_live) launchPlayer(user.login);

            } else {
                html = `<p class="text-yellow-400">Aucun r√©sultat trouv√© pour la requ√™te '${query}' comme jeu ou utilisateur.</p>`;
            }

            resultsBox.innerHTML = html;

        } catch (e) {
            resultsBox.innerHTML = `<p class="text-red-400">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });

    // --- Critique IA (Gestion de la Mise en Forme et des Erreurs) ---
    document.getElementById('ia-critique-btn').addEventListener('click', async function() {
        const type = document.getElementById('ia-critique-type').value;
        const query = document.getElementById('ia-critique-query').value.trim();
        const resultsBox = document.getElementById('ia-critique-results');
        const btn = this;

        if (type !== 'trend' && !query) {
            resultsBox.innerHTML = '<h4>Erreur</h4><p class="text-red-400">Veuillez entrer une requ√™te pour ce type d\'analyse.</p>';
            return;
        }

        resultsBox.innerHTML = `<h4>Analyse en Cours (${type})</h4><p class="text-center text-white">Veuillez patienter (max. 20 secondes)...</p>`;
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/critique_ia`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, query })
            });
            const data = await res.json();

            // Titre envoy√© par le backend (pour la stabilit√© visuelle)
            const critiqueTitle = data.title || "R√©sultats de l'Analyse"; 
            

            if (res.ok) {
                // Succ√®s: affiche le titre format√© et la critique IA format√©e en HTML
                // La critique IA est inject√©e directement apr√®s le titre <h4>
                resultsBox.innerHTML = `<h4>${critiqueTitle}</h4>` + data.html_critique;
            } else {
                // Erreur: affiche l'erreur du serveur
                resultsBox.innerHTML = `<h4>Erreur Critique ${res.status}</h4><p class="text-red-400">‚ùå Erreur de l'API Critique (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
            }
        } catch (e) {
            resultsBox.innerHTML = `<h4>Erreur de Connexion</h4><p class="text-red-400">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });


    // --- Mini-Assistant IA ---
    const assistantToggleBtn = document.getElementById('assistant-toggle');
    const chatBox = document.getElementById('assistant-chat-box');
    const assistantSendBtn = document.getElementById('assistant-send-btn');
    const assistantInput = document.getElementById('assistant-input');
    const assistantMsgs = document.getElementById('assistant-msgs');

    assistantToggleBtn.addEventListener('click', () => {
        chatBox.classList.toggle('open');
    });

    assistantSendBtn.addEventListener('click', sendMessage);
    assistantInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    async function sendMessage() {
        const q = assistantInput.value.trim();
        const currentChannel = localStorage.getItem('activeChannel') || 'Twitch'; 
        
        if (!q) return;
        
        assistantMsgs.innerHTML += `<div class="msg user">${q}</div>`;
        assistantInput.value = '';
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;

        const loaderId = 'loader-' + Date.now();
        assistantMsgs.innerHTML += `<div id="${loaderId}" class="msg bot">...</div>`;
        
        try {
            const res = await fetch(`${API_BASE}/mini_assistant`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ q, context: currentChannel }) 
            });
            const data = await res.json();

            document.getElementById(loaderId).remove();
            
            if (res.ok) {
                 // S'assurer d'utiliser 'html_response' (fix√© dans app.js)
                 assistantMsgs.innerHTML += `<div class="msg bot">${data.html_response || "D√©sol√©, probl√®me IA ou r√©ponse bloqu√©e."}</div>`;
            } else {
                 assistantMsgs.innerHTML += `<div class="msg bot" style="color:red;">Erreur du serveur IA: ${data.error || "Inconnu"}.</div>`;
            }

        } catch(err) { 
            document.getElementById(loaderId).remove();
            assistantMsgs.innerHTML += `<div class="msg bot" style="color:red;">Erreur connexion serveur.</div>`;
        }
        assistantMsgs.scrollTop = assistantMsgs.scrollHeight;
    }

    // --- Stream Boost ---
    document.getElementById('boost-stream-btn').addEventListener('click', async function() {
        const channel = document.getElementById('boost-channel-input').value.trim();
        const resultBox = document.getElementById('boost-result-box');
        const btn = this;

        if (!channel) {
            resultBox.innerHTML = '<p class="text-red-400">Veuillez entrer le nom de la cha√Æne √† booster.</p>';
            return;
        }

        resultBox.innerHTML = '<p class="text-center text-white">Tentative de Boost en cours...</p>';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/stream_boost`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel })
            });

            const data = await res.json();

            if (res.ok) {
                resultBox.innerHTML = data.html_response;
                launchPlayer(channel); 
            } else if (res.status === 429) {
                resultBox.innerHTML = data.html_response || `<p style="color:#e34a64; font-weight:bold; text-align:center;">‚ùå Cooldown actif. R√©essayez plus tard.</p>`;
            } else {
                resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur API (${res.status}): ${data.error || "Une erreur inconnue s'est produite."}</p>`;
            }
        } catch(e) {
            resultBox.innerHTML = `<p style="color:#e34a64; font-weight:bold; text-align:center;">Erreur de connexion au serveur: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    });


    // --- Initialisation au chargement de la page ---
    document.addEventListener('DOMContentLoaded', function() {
        initializePlayer();
        const savedTab = localStorage.getItem('activeTab') || 'tab-followed';
        openTab(savedTab);
        checkAuth();
    });
</script>
</body>
</html>
