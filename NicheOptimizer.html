<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer HUB - V24 (SMART AUTOPLAY)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* --- CSS CYBERPUNK --- */
        :root {
            --bg-dark: #0d0d0d; --bg-panel: #1a1a1a; --bg-input: #0a0a0a;
            --primary-pink: #ff0099; --secondary-blue: #22c7ef; --accent-gold: #ffd700;
            --accent-green: #59d682; --accent-purple: #9933ff; --accent-red: #e34a64;
            --text-main: #ffffff; --text-dim: #9aa3a8; --border: #333;
            --glow-pink: 0 0 15px rgba(255, 0, 153, 0.3); --glow-blue: 0 0 15px rgba(34, 199, 239, 0.3);
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #main-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        h1 { font-family: 'Orbitron', sans-serif; font-size: 2rem; text-align: center; color: var(--primary-pink); text-shadow: var(--glow-pink); margin-bottom: 5px; }
        .subtitle { text-align: center; color: var(--text-dim); font-size: 0.8rem; margin-bottom: 20px; letter-spacing: 2px; }

        .tabs-container { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; background: #111; border: 1px solid var(--border); border-bottom: none; color: var(--text-dim); font-family: 'Orbitron', sans-serif; font-size: 0.8rem; cursor: pointer; transition: 0.3s; white-space: nowrap; }
        .tab-btn:hover { background: #222; color: white; }
        .tab-btn.active { background: var(--bg-panel); color: white; border-top: 3px solid var(--primary-pink); font-weight: bold; }

        .player-section { background: var(--bg-panel); padding: 15px; border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--glow-blue); margin-bottom: 25px; }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .player-status { font-size: 0.8rem; color: var(--text-dim); margin-left: 10px; }
        
        #video-container { width: 100%; height: 500px; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        #twitch-embed { width: 100%; height: 100%; }

        #timer-track { width: 100%; height: 5px; background: #333; margin-top: -5px; position: relative; z-index: 50; }
        #timer-fill { width: 100%; height: 100%; background: var(--secondary-blue); transition: width 1s linear; }

        .controls-row { display: flex; gap: 10px; align-items: center; }
        .btn-icon { background: var(--bg-input); border: 1px solid var(--secondary-blue); color: var(--secondary-blue); padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover:not(:disabled) { background: var(--secondary-blue); color: black; }
        .btn-icon:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; }
        .quick-input { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; font-size: 0.8rem; }

        .tab-content { display: none; padding: 20px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .dash-card { background: var(--bg-input); border: 1px solid var(--border); padding: 15px; border-radius: 8px; min-height: 250px; }
        .card-header { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        
        .ai-result { font-size: 0.85rem; line-height: 1.6; color: #ddd; }
        .ai-result h4 { color: var(--secondary-blue); margin-top: 10px; font-family: 'Orbitron'; }
        .ai-result ul { padding-left: 15px; border-left: 2px solid #444; margin-left: 5px; }
        .ai-result li { margin-bottom: 5px; }

        .btn-main { background: var(--primary-pink); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-main:hover { transform: scale(1.02); box-shadow: var(--glow-pink); }
        .btn-scan { width: 100%; background: linear-gradient(90deg, var(--secondary-blue), var(--accent-purple)); margin-top: 10px; }

        .stream-grid { display: flex; flex-wrap: wrap; gap: 15px; }
        .stream-card { width: calc(20% - 12px); min-width: 140px; background: #111; border: 1px solid var(--border); border-radius: 6px; padding: 8px; cursor: pointer; transition: 0.2s; }
        .stream-card:hover { border-color: var(--primary-pink); transform: translateY(-3px); }
        .stream-card img { width: 100%; border-radius: 4px; margin-bottom: 5px; }

        @media (max-width: 1024px) { .dash-grid { grid-template-columns: 1fr; } .stream-card { width: calc(50% - 10px); } }
    </style>
</head>
<body>

<div id="main-container">
    <h1>STREAMER HUB <span style="color:var(--secondary-blue); font-size:1rem;">V24</span></h1>
    <div class="subtitle">AUTOPLAY FORC√â ‚Ä¢ DEEP SEARCH ‚Ä¢ SAFE MODE</div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('tab-feed')">üîë MON FIL</button>
        <button class="tab-btn" onclick="switchTab('tab-dash')" style="border-top-color:var(--secondary-blue)">üìä DASHBOARD IA</button>
        <button class="tab-btn" onclick="switchTab('tab-time')" style="border-top-color:var(--accent-gold)">‚è∞ BEST TIME</button>
        <button class="tab-btn" onclick="switchTab('tab-boost')" style="border-top-color:var(--primary-pink)">‚ö° BOOST</button>
        <button class="tab-btn" onclick="switchTab('tab-raid')" style="border-top-color:var(--accent-red)">üí• RAID</button>
    </div>

    <div class="player-section">
        <div class="player-header">
            <div>
                <span style="font-family:'Orbitron'; color:var(--secondary-blue); font-size:1.2rem;">üé¨ LECTEUR</span>
                <span id="player-status" class="player-status">Connexion au serveur...</span>
            </div>
            <div class="controls-row">
                <button id="btn-prev" class="btn-icon" onclick="manualCycle('prev')" disabled><i class="fas fa-step-backward"></i></button>
                <button id="btn-next" class="btn-icon" onclick="manualCycle('next')" disabled><i class="fas fa-step-forward"></i></button>
                <form id="mini-player" class="flex gap-2" onsubmit="event.preventDefault(); forcePlay(document.getElementById('mini-input').value);">
                    <input id="mini-input" type="text" placeholder="Cha√Æne..." class="quick-input">
                    <button type="submit" class="btn-main" style="padding: 8px 12px;">GO</button>
                </form>
            </div>
        </div>
        <div id="video-container">
            <div id="twitch-embed"></div>
        </div>
        <div id="timer-track"><div id="timer-fill"></div></div>
    </div>

    <div id="tab-feed" class="tab-content active">
        <div class="flex justify-between items-center mb-4">
            <h3 style="color:var(--primary-pink); font-weight:bold;">üî¥ CHA√éNES SUIVIES EN LIVE</h3>
            <div class="flex gap-2">
                <button onclick="window.open('/export_csv')" class="btn-main" style="background:var(--accent-green); font-size:0.7rem;">üìÑ CSV</button>
                <button id="btn-auth" class="btn-main" style="background:#6441a5; font-size:0.7rem;">üîí CONNEXION TWITCH</button>
            </div>
        </div>
        <div id="feed-list" class="stream-grid">
            <p style="color:#666; width:100%; text-align:center; padding:30px;">Connectez-vous pour voir vos favoris.</p>
        </div>
    </div>

    <div id="tab-dash" class="tab-content">
        <div class="text-center mb-6">
            <h3 style="color:var(--secondary-blue); font-family:'Orbitron'; margin-bottom:5px;">ANALYSE PROFONDE</h3>
            <p style="font-size:0.8rem; color:#888;">Entrez un Streamer ou un Jeu pour un audit complet par l'IA.</p>
            <form id="form-scan" class="mt-4" onsubmit="event.preventDefault(); runScan();">
                <input id="scan-input" type="text" placeholder="Ex: Squeezie, Minecraft..." class="quick-input" style="width:100%; max-width:400px; padding:12px; font-size:1rem; text-align:center;">
                <br><button type="submit" class="btn-main btn-scan" style="max-width:400px;">üöÄ LANCER L'AUDIT IA</button>
            </form>
        </div>
        <div class="dash-grid">
            <div class="dash-card" style="border-top:2px solid var(--secondary-blue);">
                <div class="card-header" style="color:var(--secondary-blue)">üìä DONN√âES TEMPS R√âEL</div>
                <div id="res-data" style="text-align:center; color:#666; margin-top:50px;">En attente...</div>
            </div>
            <div class="dash-card" style="border-top:2px solid var(--accent-green);">
                <div class="card-header" style="color:var(--accent-green)">üß† STRAT√âGIE DE NICHE</div>
                <div id="res-niche" class="ai-result"><p style="text-align:center; color:#666; margin-top:50px;">Conseils IA ici.</p></div>
            </div>
            <div class="dash-card" style="border-top:2px solid var(--accent-purple);">
                <div class="card-header" style="color:var(--accent-purple)">‚úÇÔ∏è REPURPOSING</div>
                <div id="res-vod" class="ai-result"><p style="text-align:center; color:#666; margin-top:50px;">Analyse VOD.</p></div>
            </div>
        </div>
    </div>

    <div id="tab-time" class="tab-content">
        <h3 style="color:var(--accent-gold); font-family:'Orbitron';">‚è∞ OPTIMISATION HORAIRE</h3>
        <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">L'IA calcule le meilleur cr√©neau.</p>
        <form class="flex gap-2" onsubmit="event.preventDefault(); runSchedule();">
            <input id="time-input" type="text" placeholder="Jeu (ex: League of Legends)" class="quick-input" style="flex:1;">
            <button type="submit" class="btn-main" style="background:var(--accent-gold); color:black;">CALCULER</button>
        </form>
        <div id="res-time" class="dash-card" style="margin-top:20px; border-color:var(--accent-gold); display:none;"><div id="time-content" class="ai-result"></div></div>
    </div>

    <div id="tab-boost" class="tab-content">
        <h3 style="color:var(--primary-pink); font-family:'Orbitron';">‚ö° BOOST DE CHA√éNE (15 MIN)</h3>
        <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">Affichage prioritaire pour tous.</p>
        <form class="flex gap-2" onsubmit="event.preventDefault(); runBoost();">
            <input id="boost-input" type="text" placeholder="Cha√Æne Twitch" class="quick-input" style="flex:1;">
            <button type="submit" class="btn-main">ACTIVER</button>
        </form>
        <div id="res-boost" style="margin-top:15px; padding:10px; background:#111; border-radius:5px; text-align:center; color:#666;">Statut...</div>
    </div>

    <div id="tab-raid" class="tab-content">
        <h3 style="color:var(--accent-red); font-family:'Orbitron';">üí• RAID OPTIMIS√â (FR)</h3>
        <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">Trouvez une cible pour votre raid.</p>
        <form class="flex gap-2 flex-col sm:flex-row" onsubmit="event.preventDefault(); runRaid();">
            <input id="raid-game" type="text" placeholder="Jeu" class="quick-input" style="flex:1;">
            <select id="raid-max" class="quick-input" style="width:auto;">
                <option value="10">Micro (<10 vues)</option>
                <option value="50" selected>Moyen (<50 vues)</option>
                <option value="100">Gros (<100 vues)</option>
            </select>
            <button type="submit" class="btn-main" style="background:var(--accent-red);">CHERCHER</button>
        </form>
        <div id="res-raid" style="margin-top:15px;"></div>
    </div>
</div>

<script src="https://embed.twitch.tv/embed/v1.js"></script>
<script>
    // --- CONFIGURATION CRITIQUE ---
    const API_BASE = window.location.origin;
    // LISTE DES DOMAINES PARENTS AUTORISES POUR L'AUTOPLAY
    const PARENT_DOMAINS = [
        "justplayerstreamhubpro.onrender.com", 
        "justplayer.fr",
        "www.justplayer.fr",
        "localhost", 
        "127.0.0.1"
    ]; 

    let embed = null;
    let currentChannel = "";
    let isBoostActive = false;
    let timerVal = 180;
    const MAX_TIMER = 180;
    let isConnected = false;

    // Initialisation
    window.onload = () => {
        checkAuth();
        // ATTENTION : On n'appelle pas initPlayer() tout de suite.
        // On attend que syncStream() nous donne une cha√Æne valide pour √©viter le flash "Monstercat".
        syncStream(); 
        setInterval(syncStream, 10000);
        setInterval(tickTimer, 1000);
    };

    function initPlayer(startChannel) {
        if(embed) return; // D√©j√† initialis√©

        const currentHost = window.location.hostname;
        const parents = PARENT_DOMAINS.includes(currentHost) ? PARENT_DOMAINS : [...PARENT_DOMAINS, currentHost];

        const options = {
            width: "100%", height: "100%",
            channel: startChannel, // On d√©marre directement sur la bonne cha√Æne
            layout: "video-and-chat",
            autoplay: true,
            muted: true, // OBLIGATOIRE POUR CHROME/SAFARI
            parent: parents
        };
        document.getElementById('twitch-embed').innerHTML = "";
        embed = new Twitch.Embed("twitch-embed", options);

        // Force Autoplay d√®s que pr√™t
        embed.addEventListener(Twitch.Embed.VIDEO_READY, () => {
            var player = embed.getPlayer();
            player.setMuted(true);
            player.play();
        });
    }

    function forcePlay(channel) {
        if(!channel) return;
        
        // Si le lecteur n'existe pas encore, on le cr√©e
        if(!embed) {
            currentChannel = channel;
            initPlayer(channel);
            document.getElementById('mini-input').value = channel;
            return;
        }

        if(currentChannel === channel) return;
        currentChannel = channel;
        document.getElementById('mini-input').value = channel;
        embed.setChannel(channel);
        
        // Force Play apr√®s changement
        setTimeout(() => {
            try {
                const p = embed.getPlayer();
                p.setMuted(true);
                p.play();
            } catch(e){}
        }, 1500);
    }

    async function syncStream() {
        try {
            const res = await fetch(`${API_BASE}/get_default_stream`);
            const data = await res.json();
            const statusLabel = document.getElementById('player-status');
            const bar = document.getElementById('timer-fill');
            const btnP = document.getElementById('btn-prev');
            const btnN = document.getElementById('btn-next');

            if(data.success) {
                statusLabel.innerText = data.message;
                
                // Si le lecteur n'est pas encore lanc√©, on le lance avec cette cha√Æne
                if(!embed) {
                    forcePlay(data.channel);
                }

                if(data.viewers === 'BOOST') {
                    if(!isBoostActive || currentChannel !== data.channel) {
                        isBoostActive = true;
                        forcePlay(data.channel);
                        statusLabel.style.color = "#ff0099";
                        bar.style.backgroundColor = "#ff0099";
                        bar.style.width = "100%";
                        btnP.disabled = true; btnN.disabled = true;
                    }
                } else {
                    isBoostActive = false;
                    statusLabel.style.color = "#999";
                    bar.style.backgroundColor = "#22c7ef";
                    btnP.disabled = false; btnN.disabled = false;
                    if(currentChannel === "") {
                        forcePlay(data.channel);
                        timerVal = MAX_TIMER;
                    }
                }
            }
        } catch(e) {}
    }

    function tickTimer() {
        if(isBoostActive) return;
        timerVal--;
        document.getElementById('timer-fill').style.width = `${(timerVal / MAX_TIMER) * 100}%`;
        if(timerVal <= 0) manualCycle('next');
    }

    async function manualCycle(direction) {
        if(isBoostActive) return;
        timerVal = MAX_TIMER;
        document.getElementById('timer-fill').style.width = "100%";
        document.getElementById('btn-prev').disabled = true;
        document.getElementById('btn-next').disabled = true;

        try {
            const res = await fetch(`${API_BASE}/cycle_stream`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ direction }) });
            const data = await res.json();
            if(data.success) forcePlay(data.channel);
        } catch(e) {}
        
        setTimeout(() => { if(!isBoostActive) { document.getElementById('btn-prev').disabled = false; document.getElementById('btn-next').disabled = false; } }, 1000);
    }

    function checkAuth() {
        fetch(`${API_BASE}/twitch_user_status`).then(r => r.json()).then(data => {
            const btn = document.getElementById('btn-auth');
            isConnected = data.is_connected;
            if(isConnected) {
                btn.innerText = `‚úÖ ${data.display_name} (D√âCO)`;
                btn.style.backgroundColor = "#0e7e0e";
                btn.onclick = () => { if(confirm("D√©connexion ?")) fetch(`${API_BASE}/twitch_logout`, {method:'POST'}).then(()=>location.reload()); };
                loadFeed();
            } else {
                btn.innerText = "üîí CONNEXION TWITCH";
                btn.style.backgroundColor = "#6441a5";
                btn.onclick = () => window.open(`${API_BASE}/twitch_auth_start`, 'login', 'width=500,height=600');
            }
        });
    }
    window.addEventListener('message', (e) => { if(e.data === 'auth_success') location.reload(); });

    function loadFeed() {
        const box = document.getElementById('feed-list');
        box.innerHTML = "<p style='text-align:center;'>Chargement...</p>";
        fetch(`${API_BASE}/followed_streams`).then(r => r.json()).then(data => {
            if(data.success && data.streams.length > 0) {
                box.innerHTML = data.streams.map(s => `
                    <div class="stream-card" onclick="forcePlay('${s.user_login}')">
                        <img src="${s.thumbnail_url.replace('{width}','320').replace('{height}','180')}">
                        <div style="font-size:0.8rem; font-weight:bold;">${s.user_name}</div>
                        <div style="font-size:0.7rem; color:var(--primary-pink);">üî¥ ${s.viewer_count}</div>
                    </div>`).join('');
            } else box.innerHTML = "<p style='text-align:center; color:#666;'>Aucun live favori.</p>";
        });
    }

    async function runScan() {
        const q = document.getElementById('scan-input').value;
        const boxD = document.getElementById('res-data');
        const boxN = document.getElementById('res-niche');
        const boxV = document.getElementById('res-vod');
        boxD.innerHTML = "üîç Scan...";
        const res = await fetch(`${API_BASE}/scan_target`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})});
        const data = await res.json();

        if(data.type === 'user') {
            const u = data.user_data;
            boxD.innerHTML = `
                <img src="${u.profile_image_url}" style="width:60px; border-radius:50%; margin-bottom:10px;">
                <div style="font-weight:bold; font-size:1.2rem;">${u.display_name}</div>
                <div>${u.is_live ? 'üî¥ LIVE' : '‚ö´ OFF'}</div>
                <div style="margin-top:10px; font-size:0.9rem;">Followers: <b>${u.total_followers}</b><br>Score: <b style="color:var(--accent-green)">${u.ai_calculated_niche_score}</b></div>
                <button onclick="forcePlay('${u.login}')" class="btn-main" style="width:100%; margin-top:10px;">VOIR</button>`;
            callAI('niche', `${u.display_name} | ${u.game_name}`, boxN, u.ai_calculated_niche_score);
            callAI('repurpose', `${u.login} (VOD)`, boxV);
        } else if (data.type === 'game') {
            const g = data.game_data;
            boxD.innerHTML = `<img src="${g.box_art_url.replace('{width}','80').replace('{height}','110')}"><div><b>${g.name}</b><br>${g.total_viewers} viewers</div>`;
            callAI('niche', `Jeu: ${g.name}`, boxN, g.ai_calculated_niche_score);
            boxV.innerHTML = "Pas de VOD pour un jeu.";
        } else boxD.innerHTML = "Rien trouv√©.";
    }

    async function callAI(type, query, box, score=null) {
        box.innerHTML = "ü§ñ Analyse...";
        const res = await fetch(`${API_BASE}/critique_ia`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type, query, niche_score:score})});
        const data = await res.json();
        box.innerHTML = data.html_response || "Erreur IA";
    }

    async function runSchedule() {
        const g = document.getElementById('time-input').value;
        const box = document.getElementById('res-time');
        const content = document.getElementById('time-content');
        box.style.display = 'block'; content.innerHTML = "Calcul...";
        const res = await fetch(`${API_BASE}/analyze_schedule`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({game:g})});
        const data = await res.json();
        content.innerHTML = data.success ? data.html_response : "Erreur.";
    }

    async function runBoost() {
        const c = document.getElementById('boost-input').value;
        const r = document.getElementById('res-boost');
        r.innerHTML = "Activation...";
        const res = await fetch(`${API_BASE}/stream_boost`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:c})});
        const data = await res.json();
        r.innerHTML = data.html_response || data.error;
        if(data.success) syncStream();
    }

    async function runRaid() {
        const g = document.getElementById('raid-game').value;
        const m = document.getElementById('raid-max').value;
        const r = document.getElementById('res-raid');
        r.innerHTML = "Recherche...";
        const res = await fetch(`${API_BASE}/start_raid`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({game:g, max_viewers:m})});
        const data = await res.json();
        if(data.success) {
            const t = data.target;
            r.innerHTML = `<div style="background:#111; padding:10px; border:1px solid var(--accent-red); border-radius:5px; display:flex; gap:10px; align-items:center;"><img src="${t.thumbnail_url}" style="width:80px;"><div><b>${t.name}</b><br>${t.viewers} viewers</div><button onclick="forcePlay('${t.login}')" class="btn-main" style="margin-left:auto;">GO</button></div>`;
        } else r.innerHTML = "Rien trouv√©.";
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const index = ['tab-feed','tab-dash','tab-time','tab-boost','tab-raid'].indexOf(id);
        document.querySelectorAll('.tab-btn')[index].classList.add('active');
    }
</script>
</body>
</html>
