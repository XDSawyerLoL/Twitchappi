<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub - Console Cyberpunk</title>
    
    <!-- 1. CHARGEMENT DE TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS Personnalisé (Thème Sombre et Effets de Lueur) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Fond très sombre */
            color: #f0f0f0;
            min-height: 100vh;
        }
        #root {
            min-height: 100vh;
            display: flex;
            align-items: flex-start; /* Alignement en haut pour le contenu principal */
            justify-content: center;
            padding: 20px;
        }

        /* Styles pour le mode "Gamer/Néon" avec les couleurs personnalisées */
        .neon-border {
            border: 1px solid rgba(255, 0, 153, 0.4);
            box-shadow: 0 0 8px rgba(255, 0, 153, 0.6), 0 0 12px rgba(34, 199, 239, 0.3);
            transition: all 0.3s ease-in-out;
        }
        .neon-border:hover {
            border-color: rgba(34, 199, 239, 0.8);
            box-shadow: 0 0 15px rgba(34, 199, 239, 0.8), 0 0 20px rgba(255, 0, 153, 0.4);
            transform: translateY(-2px);
        }

        .neon-glow-text {
            text-shadow: 0 0 5px #22c7ef, 0 0 10px rgba(34, 199, 239, 0.7);
        }

        .input-glow:focus {
            outline: none;
            border-color: #FF0099;
            box-shadow: 0 0 0 3px rgba(255, 0, 153, 0.5);
        }
        
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Animation de rotation pour le Loader */
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root" class="w-full"></div>

    <!-- 2. CHARGEMENT DE REACT et REACT-DOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Ajout de ReactDOMServer pour le rendu statique des messages HTML -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. CHARGEMENT DES LIBRAIRIES FIREBASE (Version stable 10.12.2) -->
    <script type="module">
        // Utilisation de la version 10.12.2 pour éviter les erreurs 404
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // FIX: Ajout de orderBy et getDocs dans les imports
        import { getFirestore, doc, onSnapshot, collection, query, limit, where, addDoc, serverTimestamp, setLogLevel, setDoc, getDoc, updateDoc, deleteDoc, increment, Timestamp, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuration Firebase (Variables Globales fournies par l'environnement)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-streamer-hub-app';

        // Exposer Firebase globalement pour le script Babel
        // FIX: Ajout de orderBy et getDocs à l'objet window.firebaseModules
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, query, limit, where, addDoc, serverTimestamp, setLogLevel,
            setDoc, getDoc, updateDoc, deleteDoc, increment, Timestamp, orderBy, getDocs
        };
        
        window.firebaseParams = { firebaseConfig, initialAuthToken, appId };
        window.firebaseLoaded = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const ReactDOMServer = window.ReactDOMServer;

        // --- Définitions des icônes SVG pour éviter les erreurs d'importation de lucide-react ---
        const ZapIcon = (props) => (
            <svg
                {...props}
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            </svg>
        );

        const MessageSquareIcon = (props) => (
            <svg
                {...props}
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg>
        );

        const SendIcon = (props) => (
            <svg
                {...props}
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                <line x1="22" x2="11" y1="2" y2="13" />
                <polygon points="22 2 15.5 22 11 13 2 9.5 22 2" />
            </svg>
        );

        const TrendingUpIcon = (props) => (
            <svg
                {...props}
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                <polyline points="22 7 13.5 15.5 10.5 12.5 2 21" />
                <polyline points="16 7 22 7 22 13" />
            </svg>
        );

        const LoaderIcon = (props) => (
            <svg
                {...props}
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
            >
                <line x1="12" x2="12" y1="2" y2="6" />
                <line x1="12" x2="12" y1="18" y2="22" />
                <line x1="4.93" x2="7.76" y1="4.93" y2="7.76" />
                <line x1="16.24" x2="19.07" y1="16.24" y2="19.07" />
                <line x1="2" x2="6" y1="12" y2="12" />
                <line x1="18" x2="22" y1="12" y2="12" />
                <line x1="4.93" x2="7.76" y1="19.07" y2="16.24" />
                <line x1="16.24" x2="19.07" y1="7.76" y2="4.93" />
            </svg>
        );
        
        // --- Fin des définitions des icônes SVG ---

        // Attente du chargement des modules Firebase
        const useFirebase = () => {
            const [firebase, setFirebase] = useState(null);
            const [params, setParams] = useState(null);

            useEffect(() => {
                const checkFirebase = () => {
                    if (window.firebaseLoaded && window.firebaseModules) {
                        setFirebase(window.firebaseModules);
                        setParams(window.firebaseParams);
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            }, []);

            return { firebase, params };
        };

        // --- COMPOSANTS UI ---

        const MessageCard = ({ message }) => {
            const isUserMessage = message.role === 'user';
            const bgColor = isUserMessage ? 'bg-gray-800' : 'bg-[#1e1e1e] border-t border-[#FF0099] shadow-lg';
            const textColor = isUserMessage ? 'text-gray-200' : 'text-[#22c7ef] neon-glow-text';

            return (
                <div className={`p-4 rounded-lg mb-4 ${bgColor} transition-all duration-300 transform hover:scale-[1.01] neon-border`}>
                    <div className="flex items-start">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 font-orbitron font-bold text-sm ${isUserMessage ? 'bg-[#22c7ef] text-[#121212]' : 'bg-[#FF0099] text-[#121212]'}`}>
                            {isUserMessage ? 'USR' : 'GEM'}
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className={`font-bold ${isUserMessage ? 'text-white' : 'text-[#FF0099]'}`}>
                                {isUserMessage ? 'Vous (Streamer)' : 'Gemini AI (Optimiseur)'}
                            </p>
                            <p className={`mt-1 break-words whitespace-pre-wrap ${textColor}`}>
                                {message.text}
                            </p>
                            <small className="block text-xs text-gray-500 mt-2">
                                {message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString('fr-FR') : '...'}
                            </small>
                        </div>
                    </div>
                </div>
            );
        };

        // Hook principal pour l'application
        const useAppLogic = () => {
            const { firebase, params } = useFirebase();
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!firebase || !params) return;

                const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, setLogLevel } = firebase;
                const { firebaseConfig, initialAuthToken } = params;

                try {
                    // setLogLevel('debug'); // Uncomment for debugging
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    
                    setDb(dbInstance);
                    setAuth(authInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authInstance, initialAuthToken).catch(e => console.warn(e));
                            } else {
                                await signInAnonymously(authInstance).catch(e => console.warn(e));
                            }
                        } else {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                        }
                    });
                    return () => unsubscribe();

                } catch (e) {
                    console.error("Firebase init error", e);
                }
            }, [firebase, params]);

            return { isAuthReady, userId, db, auth, firebase, params };
        };

        const SubmissionSection = ({ context }) => {
            const { db, userId, isAuthReady, firebase, params } = context;
            const { addDoc, collection, serverTimestamp, query, limit, onSnapshot, orderBy } = firebase;
            const { appId } = params;
            
            const [prompt, setPrompt] = useState('');
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(false);

            // Real-time listener for messages
            useEffect(() => {
                if (!db || !userId) return;
                
                const chatRef = collection(db, 'artifacts', appId, 'users', userId, 'chat_history');
                const q = query(chatRef, orderBy('timestamp', 'asc'), limit(50));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(msgs);
                    // Scroll to bottom logic here if needed
                });
                return () => unsubscribe();
            }, [db, userId, appId, collection, query, orderBy, limit, onSnapshot]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!prompt.trim() || loading || !db) return;

                const userText = prompt.trim();
                setPrompt('');
                setLoading(true);
                
                const chatRef = collection(db, 'artifacts', appId, 'users', userId, 'chat_history');

                // 1. Add User message
                await addDoc(chatRef, {
                    text: userText,
                    role: 'user',
                    timestamp: serverTimestamp()
                });

                // 2. Call Gemini API
                // Note: In a real scenario, you should call your backend here. 
                // For this demo, we simulate a response or call the public endpoint directly if key is safe (it is not usually).
                // We will simulate a backend call to Gemini via the provided instructions.
                
                try {
                    const apiKey = ""; // ADD YOUR API KEY HERE IF TESTING LOCALLY, ELSE USE BACKEND
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Act as a streamer coach. User asks: " + userText }] }]
                        })
                    });
                    
                    let aiText = "Le système IA est en maintenance (Clé API manquante).";
                    if (response.ok) {
                        const data = await response.json();
                        aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Pas de réponse.";
                    }

                    // 3. Add AI message
                    await addDoc(chatRef, {
                        text: aiText,
                        role: 'model',
                        timestamp: serverTimestamp()
                    });

                } catch (err) {
                    console.error(err);
                    await addDoc(chatRef, {
                        text: "Erreur de connexion au module IA.",
                        role: 'model',
                        timestamp: serverTimestamp()
                    });
                }

                setLoading(false);
            };

            return (
                <div className="p-6 bg-[#1a1a1a] rounded-xl neon-border flex flex-col h-[500px] md:h-[600px]">
                    <h2 className="text-2xl font-orbitron font-bold mb-4 text-[#22c7ef] neon-glow-text flex items-center">
                        <MessageSquareIcon className="w-6 h-6 mr-2" /> CONSOLE DE SOUMISSION
                    </h2>
                    
                    <div className="flex-1 overflow-y-auto pr-2 mb-4 space-y-4 custom-scrollbar">
                        {messages.length === 0 ? (
                            <div className="text-center p-8 text-gray-500 font-inter">
                                <p className="mb-2">Le Nexus est prêt. Envoyez votre première requête.</p>
                            </div>
                        ) : (
                            messages.map((msg) => <MessageCard key={msg.id} message={msg} />)
                        )}
                    </div>

                    <form onSubmit={handleSubmit} className="flex space-x-3">
                        <input
                            type="text"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder={loading ? "Traitement..." : "Entrez votre requête..."}
                            disabled={loading || !isAuthReady}
                            className="flex-1 p-3 rounded-lg bg-gray-900 border border-gray-700 text-white placeholder-gray-500 input-glow transition-colors"
                        />
                        <button
                            type="submit"
                            disabled={!prompt.trim() || loading || !isAuthReady}
                            className={`p-3 rounded-lg text-[#121212] font-bold font-orbitron transition-all duration-300 ${
                                !prompt.trim() || loading || !isAuthReady
                                    ? 'bg-gray-600 cursor-not-allowed'
                                    : 'bg-[#FF0099] hover:bg-[#ff4dd9]'
                            }`}
                        >
                            {loading ? <LoaderIcon className="w-5 h-5 animate-spin-slow" /> : <SendIcon className="w-5 h-5" />}
                        </button>
                    </form>
                </div>
            );
        };

        const DiscoverySection = ({ context }) => {
            const { db, firebase, params } = context;
            const { collection, onSnapshot, query, limit, orderBy, doc, setDoc, serverTimestamp, addDoc, where, getDocs } = firebase;
            const { appId } = params;
            
            const [topics, setTopics] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                const topicsRef = collection(db, 'artifacts', appId, 'public', 'data', 'popular_topics');
                const q = query(topicsRef, orderBy('count', 'desc'), limit(10));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTopics(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [db, appId, collection, query, orderBy, limit, onSnapshot]);

            const handleTopicClick = async (topicName) => {
                if (!db) return;
                const topicsRef = collection(db, 'artifacts', appId, 'public', 'data', 'popular_topics');
                // Logic to increment or add (simplified)
                // Note: Ideally use transactions
                // For demo: assume existence check or blind write
                console.log("Vote pour:", topicName);
            };

            return (
                <div className="p-6 bg-[#1a1a1a] rounded-xl neon-border flex flex-col h-[500px] md:h-[600px]">
                    <h2 className="text-2xl font-orbitron font-bold mb-6 text-[#FF0099] neon-glow-text flex items-center">
                        <TrendingUpIcon className="w-6 h-6 mr-2" /> TENDANCES
                    </h2>
                    {loading ? (
                         <div className="flex-1 flex items-center justify-center">
                            <LoaderIcon className="w-10 h-10 text-[#FF0099] animate-spin-slow" />
                         </div>
                    ) : (
                        <div className="flex flex-wrap gap-4 overflow-y-auto pr-2 custom-scrollbar">
                            {topics.length === 0 ? (
                                <p className="text-gray-500 w-full text-center">Aucune tendance.</p>
                            ) : (
                                topics.map(topic => (
                                    <button key={topic.id} onClick={() => handleTopicClick(topic.topic)} className="px-4 py-2 bg-gray-800 rounded-full text-gray-300 hover:bg-gray-700 border border-[#22c7ef]">
                                        {topic.topic} <span className="text-[#FF0099] ml-1">{topic.count}</span>
                                    </button>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const GeminiBrandingSection = () => (
            <div className="p-6 bg-gray-900/50 rounded-xl neon-border text-center mt-4">
                <h3 className="text-xl font-orbitron font-bold text-white mb-2">
                    <span className="text-[#22c7ef]">GEMINI</span> INTELLIGENCE ACTIVE
                </h3>
            </div>
        );

        const App = () => {
            const context = useAppLogic();

            if (!context.isAuthReady) {
                return (
                    <div className="w-full h-screen flex items-center justify-center bg-[#121212]">
                        <div className="text-center">
                            <LoaderIcon className="w-12 h-12 text-[#FF0099] animate-spin-slow mx-auto" />
                            <p className="mt-4 text-gray-400 font-orbitron">Initialisation...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-7xl mx-auto py-10 lg:py-20">
                    <header className="text-center mb-10">
                        <h1 className="text-5xl md:text-6xl font-extrabold mb-2 text-[#FF0099] font-orbitron">
                            <ZapIcon className="inline w-10 h-10 mr-2" /> STREAMER HUB
                        </h1>
                        <p className="text-sm text-gray-400 mt-4">
                            ID: <span className="font-mono text-xs text-gray-300 bg-gray-700 p-1 rounded-sm">{context.userId}</span>
                        </p>
                    </header>

                    <main className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <SubmissionSection context={context} />
                        <DiscoverySection context={context} />
                        <div className="lg:col-span-2">
                            <GeminiBrandingSection />
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>