<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Hub - Console Cyberpunk</title>
    
    <!-- 1. CHARGEMENT DE TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS Personnalisé (Thème Sombre et Effets de Lueur) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Fond très sombre */
            color: #f0f0f0;
            min-height: 100vh;
        }
        #root {
            min-height: 100vh;
            display: flex;
            align-items: flex-start; /* Alignement en haut pour le contenu principal */
            justify-content: center;
            padding: 20px;
        }

        /* Styles pour le mode "Gamer/Néon" avec les couleurs personnalisées */
        .neon-border {
            border: 1px solid rgba(255, 0, 153, 0.5); /* Rose Néon */
            box-shadow: 0 0 10px rgba(255, 0, 153, 0.5), inset 0 0 5px rgba(255, 0, 153, 0.3);
            transition: all 0.3s ease-in-out;
        }
        .neon-border:hover {
            box-shadow: 0 0 15px rgba(255, 0, 153, 0.8), inset 0 0 8px rgba(255, 0, 153, 0.5);
        }

        .neon-glow {
            text-shadow: 0 0 5px rgba(34, 199, 239, 0.6), 0 0 10px rgba(34, 199, 239, 0.4); /* Cyan Néon */
        }
        
        .btn-neon {
            background-color: #22c7ef; /* Cyan */
            color: #121212;
            text-shadow: none;
            box-shadow: 0 0 8px rgba(34, 199, 239, 0.8);
            transition: all 0.2s;
        }
        .btn-neon:hover {
            background-color: #FF0099; /* Rose */
            color: white;
            box-shadow: 0 0 15px rgba(255, 0, 153, 0.9);
            transform: translateY(-1px);
        }
        
        .input-cyber {
            background-color: #1f2937;
            border-color: #374151;
            box-shadow: 0 0 3px rgba(34, 199, 239, 0.5);
        }
        
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        
        .bg-purple-twitch {
            background-color: #9146FF; /* Couleur Twitch */
        }
        .text-purple-twitch {
            color: #9146FF;
        }
        
    </style>
    
    <!-- 2. CHARGEMENT DE REACT & BABEL -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. CHARGEMENT DE FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const FIREBASE_INITIALIZED_EVENT = 'firebaseInitialized';
        
        // Composants d'icônes simples (Lucide Icons like)
        const ZapIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
        );

        const CornerRightUp = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="10 9 15 4 20 9"></polyline>
                <path d="M4 20h7a4 4 0 0 0 4-4V4"></path>
            </svg>
        );

        const ShuffleIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" x2="16" y1="20" y2="8"></line>
                <path d="M21 17l-5-5-5 5"></path>
                <path d="M12 18H3"></path>
            </svg>
        );

        const SearchIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        );

        const AlertCircleIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        // Configuration et Initialisation Firebase
        const initializeFirebase = async (setUserId, setDb, setAuth) => {
            if (typeof window.__firebase_config === 'undefined') {
                console.error("Firebase config is missing.");
                // Fallback pour le développement local si les variables sont manquantes
                setUserId("anonymous-local-dev"); 
                return;
            }

            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebase;

                const app = initializeApp(firebaseConfig);
                const authInstance = getAuth(app);
                const dbInstance = getFirestore(app);

                // Authentification
                if (typeof window.__initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(authInstance, window.__initial_auth_token);
                } else {
                    await signInAnonymously(authInstance);
                }

                // Écouteur de l'état d'authentification pour mettre à jour l'UID
                onAuthStateChanged(authInstance, (user) => {
                    setUserId(user ? user.uid : 'anonyme');
                    setDb(dbInstance);
                    setAuth(authInstance);
                    document.dispatchEvent(new Event(FIREBASE_INITIALIZED_EVENT));
                });
                
            } catch (error) {
                console.error("Erreur d'initialisation de Firebase ou d'authentification:", error);
                setUserId('ERREUR_AUTH');
            }
        };

        const waitForFirebase = (callback) => {
            if (window.firebase && window.firebase.getFirestore) {
                callback();
            } else {
                window.addEventListener(FIREBASE_INITIALIZED_EVENT, callback, { once: true });
            }
        };

        // --- NOUVEAU COMPOSANT : GoodStreamWidget ---
        // Ce composant appelle l'API de tirage aléatoire et affiche le résultat.
        const GoodStreamWidget = () => {
            const API_BASE_URL = 'https://twitchappi-goodstream1.onrender.com';
            const [result, setResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            // Fonction pour gérer les appels d'API avec backoff exponentiel
            const fetchWithExponentialBackoff = async (url, options = {}, retries = 5, delay = 1000) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                        }
                        return response;
                    } catch (error) {
                        if (i === retries - 1) throw error; 
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                    }
                }
            };

            const drawStreamer = useCallback(async () => {
                setIsLoading(true);
                setError(null);
                setResult(null);

                try {
                    const response = await fetchWithExponentialBackoff(`${API_BASE_URL}/random`);
                    const data = await response.json();

                    if (!data || !data.streamer_name) {
                        throw new Error("Réponse de l'API invalide ou vide.");
                    }
                    
                    // Construction du lien Twitch
                    const streamerHandle = data.streamer_name.toLowerCase().replace(/\s/g, '');
                    const twitchUrl = `https://twitch.tv/${streamerHandle}`;

                    setResult({
                        name: data.streamer_name || 'Streamer Inconnu',
                        game: data.game_name || 'Non Spécifié',
                        review: data.ai_review && data.ai_review.length > 10 ? data.ai_review : "Aucune critique IA détaillée pour l'instant. Allez voir !",
                        link: twitchUrl
                    });

                } catch (err) {
                    console.error("Erreur lors du tirage :", err);
                    setError("Échec de la connexion au backend GoodStream. Vérifiez l'URL de l'API.");
                } finally {
                    setIsLoading(false);
                }
            }, []);
            
            // Effectue un tirage initial au chargement
            useEffect(() => {
                drawStreamer();
            }, [drawStreamer]);


            return (
                <div className="p-6 bg-[#1f2937] rounded-lg neon-border mt-4">
                    <h3 className="text-xl font-orbitron text-[#22c7ef] mb-4 flex items-center">
                        <ShuffleIcon className="w-5 h-5 mr-2" /> 
                        Tirage IA GoodStream
                    </h3>
                    <p className="text-sm text-gray-400 mb-4">
                        Trouvez un streamer de qualité, pondéré par l'Intelligence Artificielle de Gemini.
                    </p>

                    {isLoading && (
                        <div className="flex items-center justify-center p-6 text-[#FF0099]">
                            <svg className="animate-spin h-6 w-6 mr-3 text-[#FF0099]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Chargement... Analyse des données de stream en cours.
                        </div>
                    )}

                    {error && (
                        <div className="p-4 bg-red-900/50 border border-red-500 rounded-lg text-red-300">
                            <AlertCircleIcon className="w-5 h-5 inline mr-2" />
                            {error}
                        </div>
                    )}

                    {result && (
                        <div className="mt-4 p-4 bg-gray-800 rounded-lg border-l-4 border-[#22c7ef] shadow-lg">
                            <p className="text-sm text-gray-400 mb-1">Coup de cœur IA :</p>
                            <h4 className="text-xl font-orbitron text-white mb-2">{result.name}</h4>
                            <p className="text-sm font-semibold text-[#FF0099] mb-3">Jeu: {result.game}</p>
                            
                            <p className="text-xs text-gray-300 italic mb-4 p-2 bg-gray-900 rounded">
                                <span className="font-bold text-[#22c7ef]">AI Review: </span>
                                {result.review}
                            </p>
                            
                            <a href={result.link} target="_blank" className="bg-purple-twitch hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-150 inline-flex items-center">
                                Regarder le Stream
                                <CornerRightUp className="w-4 h-4 ml-2" />
                            </a>
                        </div>
                    )}
                    
                    <button 
                        onClick={drawStreamer} 
                        disabled={isLoading}
                        className="btn-neon mt-6 py-2 px-4 rounded-lg w-full text-sm font-bold disabled:opacity-50"
                    >
                        {isLoading ? 'Tirage en cours...' : 'Tirer un autre Streamer !'}
                    </button>
                </div>
            );
        };
        // --- FIN DU NOUVEAU COMPOSANT ---

        // Composant pour la soumission (streamers)
        const SubmissionSection = () => {
            const [formState, setFormState] = useState({
                name: '',
                url: '',
                category: '',
                description: ''
            });
            const [message, setMessage] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormState(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // Ici, vous ajouteriez la logique pour envoyer les données à votre API/Firestore
                console.log("Soumission reçue:", formState);
                setMessage('Soumission traitée. L\'analyse IA commencera dans les 24h.');
                setFormState({ name: '', url: '', category: '', description: '' });
                setTimeout(() => setMessage(''), 5000);
            };

            return (
                <div className="bg-[#1f2937] p-8 rounded-lg shadow-2xl neon-border">
                    <h2 className="text-3xl font-orbitron text-[#FF0099] mb-6">
                        <CornerRightUp className="inline w-6 h-6 mr-2" />
                        SUBMISSION DE STREAM
                    </h2>
                    <p className="text-sm text-gray-400 mb-6">
                        Soumettez votre chaîne pour une évaluation par notre modèle Gemini. Les streamers jugés "Attractifs & Addictifs" seront ajoutés à la liste de tirage.
                    </p>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-300">Nom de la Chaîne Twitch</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                value={formState.name}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full input-cyber rounded-md text-white border-gray-600 focus:ring-[#22c7ef] focus:border-[#22c7ef]"
                            />
                        </div>
                        <div>
                            <label htmlFor="url" className="block text-sm font-medium text-gray-300">URL de la Chaîne (Ex: twitch.tv/votre_nom)</label>
                            <input
                                type="url"
                                id="url"
                                name="url"
                                value={formState.url}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full input-cyber rounded-md text-white border-gray-600 focus:ring-[#22c7ef] focus:border-[#22c7ef]"
                            />
                        </div>
                        <div>
                            <label htmlFor="category" className="block text-sm font-medium text-gray-300">Catégorie Principale (Ex: Just Chatting, FPS, Art)</label>
                            <input
                                type="text"
                                id="category"
                                name="category"
                                value={formState.category}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full input-cyber rounded-md text-white border-gray-600 focus:ring-[#22c7ef] focus:border-[#22c7ef]"
                            />
                        </div>
                        <div>
                            <label htmlFor="description" className="block text-sm font-medium text-gray-300">Pourquoi votre stream est-il exceptionnel? (Max 250 mots)</label>
                            <textarea
                                id="description"
                                name="description"
                                rows="3"
                                value={formState.description}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full input-cyber rounded-md text-white border-gray-600 focus:ring-[#22c7ef] focus:border-[#22c7ef]"
                            ></textarea>
                        </div>
                        
                        <button type="submit" className="btn-neon w-full py-3 mt-4 text-lg font-bold">
                            Soumettre à l'Analyse IA
                        </button>
                    </form>

                    {message && (
                        <div className="mt-4 p-3 text-center bg-green-900/50 border border-green-500 rounded-lg text-green-300 text-sm">
                            {message}
                        </div>
                    )}
                </div>
            );
        };

        // Composant pour la découverte (GoodStream Widget)
        const DiscoverySection = () => {
            // Note: Le code Firestore a été retiré de cette section car il n'est pas utilisé pour le widget GoodStream.
            return (
                <div className="bg-[#1f2937] p-8 rounded-lg shadow-2xl neon-border">
                    <h2 className="text-3xl font-orbitron text-[#22c7ef] mb-6">
                        <SearchIcon className="inline w-6 h-6 mr-2" />
                        ZONE DE DÉCOUVERTE
                    </h2>
                    <p className="text-sm text-gray-400 mb-6">
                        Découvrez de nouveaux talents recommandés par l'IA. Cette section est votre porte d'entrée vers le meilleur du streaming.
                    </p>
                    
                    {/* Intégration du Nouveau Composant GoodStreamWidget */}
                    <GoodStreamWidget />
                </div>
            );
        };

        // Composant de branding Gemini (pour l'API)
        const GeminiBrandingSection = () => {
            return (
                <div className="text-center mt-10 p-4 bg-[#1f2937] rounded-lg neon-border">
                    <p className="text-sm text-gray-500">
                        Technologie d'Analyse Streamer fournie par <span className="font-orbitron font-bold text-[#FF0099] neon-glow">Google Gemini</span>.
                    </p>
                </div>
            );
        };


        // Composant principal de l'application
        const App = () => {
            const [userId, setUserId] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            
            // 1. Initialisation de Firebase et Authentification
            useEffect(() => {
                initializeFirebase(setUserId, setDb, setAuth);
            }, []);

            return (
                <div className="w-full max-w-7xl mx-auto py-10 lg:py-20">
                    <header className="text-center mb-10">
                        <h1 className="text-5xl md:text-6xl font-extrabold mb-2 text-[#FF0099] font-orbitron">
                            <ZapIcon className="inline w-10 h-10 mr-2" /> STREAMER HUB CONSOLE
                        </h1>
                        <p className="text-xl text-[#22c7ef] font-orbitron">
                            BOOST ACTIF | Devenez Attractif & Addictif
                        </p>
                        <p className="text-sm text-gray-400 mt-4">
                            ID Utilisateur Actuel: <span className="font-mono text-xs text-gray-300 bg-gray-700 p-1 rounded-sm">{userId || 'N/A'}</span>
                        </p>
                    </header>

                    <main className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <SubmissionSection />
                        <DiscoverySection />
                        <div className="lg:col-span-2">
                            <GeminiBrandingSection />
                        </div>
                    </main>
                </div>
            );
        };

        waitForFirebase(() => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>